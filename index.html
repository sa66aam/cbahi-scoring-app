<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CBAHI Dental Center Accreditation Scoring</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <!-- Export Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600;700&family=Inter:wght@400;500;600;700&family=Cairo:wght@400;500;600;700&family=Noto+Naskh+Arabic:wght@400;500;600;700&family=Architects+Daughter&family=Amiri:wght@400;700&display=swap"
    rel="stylesheet">
  <style>
    :root {
      --primary: #1e3a5f;
      --primary-light: #2d5a8a;
      --primary-dark: #0f2744;
      --accent: #3498db;
      --accent-hover: #2980b9;
      --success: #27ae60;
      --success-light: #d4edda;
      --warning: #f39c12;
      --warning-light: #fff3cd;
      --danger: #e74c3c;
      --danger-light: #f8d7da;
      --neutral: #95a5a6;
      --bg-main: #f8fafc;
      --bg-card: #ffffff;
      --bg-hover: #f1f5f9;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --border: #e2e8f0;
      --border-focus: #3498db;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --radius-sm: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;

      /* Landing Page Theme */
      --pencil-navy: #1e3a5f;
      --pencil-bg: #ffffff;
      --pencil-gray: #f8fafc;
      /* New Professional Palette */
      --landing-bg: #f8fafc;
      --landing-text: #1e293b;
      --landing-primary: #1e3a5f;
      --landing-accent: #3498db;
      --landing-gold: #c3a15a;
      --landing-success: #27ae60;
      /* Gradients */
      --gradient-primary: linear-gradient(135deg, #1e3a5f 0%, #2d5a8a 100%);
      --gradient-gold: linear-gradient(135deg, #c3a15a 0%, #d4af37 100%);
      --gradient-subtle: linear-gradient(180deg, #f8fafc 0%, #ffffff 100%);
    }

    /* Animations */
    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes float {
      0% {
        transform: translateY(0px);
      }

      50% {
        transform: translateY(-10px);
      }

      100% {
        transform: translateY(0px);
      }
    }

    /* ========================================
       BILINGUAL LANDING PAGE STYLES
       Apple-style scroll animations + RTL
    ======================================== */

    /* Scroll Animation Keyframes */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(60px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-40px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInLeft {
      from {
        opacity: 0;
        transform: translateX(-60px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes fadeInRight {
      from {
        opacity: 0;
        transform: translateX(60px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes parallaxFloat {

      0%,
      100% {
        transform: translateY(0) rotate(0deg);
      }

      50% {
        transform: translateY(-20px) rotate(2deg);
      }
    }

    @keyframes gradientShift {
      0% {
        background-position: 0% 50%;
      }

      50% {
        background-position: 100% 50%;
      }

      100% {
        background-position: 0% 50%;
      }
    }

    @keyframes pulseGlow {

      0%,
      100% {
        box-shadow: 0 0 20px rgba(52, 152, 219, 0.3);
      }

      50% {
        box-shadow: 0 0 40px rgba(52, 152, 219, 0.6);
      }
    }

    /* Intersection Observer Animation Classes */
    .lp-animate {
      opacity: 0;
      transition: opacity 0.8s ease, transform 0.8s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .lp-animate.lp-visible {
      opacity: 1;
    }

    .lp-animate-up {
      transform: translateY(60px);
    }

    .lp-animate-up.lp-visible {
      transform: translateY(0);
    }

    .lp-animate-left {
      transform: translateX(-60px);
    }

    .lp-animate-left.lp-visible {
      transform: translateX(0);
    }

    .lp-animate-right {
      transform: translateX(60px);
    }

    .lp-animate-right.lp-visible {
      transform: translateX(0);
    }

    .lp-animate-scale {
      transform: scale(0.9);
    }

    .lp-animate-scale.lp-visible {
      transform: scale(1);
    }

    /* Staggered animation delays */
    .lp-delay-1 {
      transition-delay: 0.1s;
    }

    .lp-delay-2 {
      transition-delay: 0.2s;
    }

    .lp-delay-3 {
      transition-delay: 0.3s;
    }

    .lp-delay-4 {
      transition-delay: 0.4s;
    }

    .lp-delay-5 {
      transition-delay: 0.5s;
    }

    .lp-delay-6 {
      transition-delay: 0.6s;
    }

    /* RTL Support */
    [dir="rtl"] {
      font-family: 'Cairo', 'Lora', sans-serif;
    }

    [dir="rtl"] .lp-animate-left {
      transform: translateX(60px);
    }

    [dir="rtl"] .lp-animate-left.lp-visible {
      transform: translateX(0);
    }

    [dir="rtl"] .lp-animate-right {
      transform: translateX(-60px);
    }

    [dir="rtl"] .lp-animate-right.lp-visible {
      transform: translateX(0);
    }

    /* Landing Page Container */
    .landing-container {
      min-height: 100vh;
      overflow-x: hidden;
      scroll-behavior: smooth;
    }

    .landing-container.lp-rtl {
      direction: rtl;
      font-family: 'Cairo', sans-serif;
    }

    .landing-container.lp-ltr {
      direction: ltr;
      font-family: 'Inter', sans-serif;
    }

    /* Language Toggle */
    .lang-toggle {
      position: fixed;
      top: 24px;
      right: 24px;
      z-index: 1000;
      display: flex;
      gap: 4px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 6px;
      border-radius: 30px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.8);
    }

    [dir="rtl"] .lang-toggle {
      right: auto;
      left: 24px;
    }

    .lang-btn {
      padding: 10px 20px;
      border: none;
      background: transparent;
      border-radius: 24px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      color: var(--text-secondary);
    }

    .lang-btn.active {
      background: var(--primary);
      color: white;
    }

    .lang-btn:hover:not(.active) {
      background: var(--bg-hover);
    }

    /* Hero Section */
    .lp-hero {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #f8fafc 100%);
      background-size: 200% 200%;
      animation: gradientShift 15s ease infinite;
    }

    .lp-hero::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 80%;
      height: 150%;
      background: radial-gradient(circle, rgba(52, 152, 219, 0.08) 0%, transparent 70%);
      pointer-events: none;
    }

    [dir="rtl"] .lp-hero::before {
      right: auto;
      left: -20%;
    }

    .lp-hero::after {
      content: '';
      position: absolute;
      bottom: -30%;
      left: -10%;
      width: 60%;
      height: 100%;
      background: radial-gradient(circle, rgba(30, 58, 95, 0.05) 0%, transparent 70%);
      pointer-events: none;
    }

    .lp-hero-content {
      max-width: 1200px;
      width: 100%;
      padding: 100px 40px;
      display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 80px;
      align-items: center;
      position: relative;
      z-index: 1;
    }

    @media (max-width: 968px) {
      .lp-hero-content {
        grid-template-columns: 1fr;
        text-align: center;
        padding: 120px 24px 80px;
        gap: 60px;
      }
    }

    .lp-hero-title {
      font-size: clamp(40px, 6vw, 72px);
      font-weight: 700;
      line-height: 1.1;
      color: var(--primary);
      margin-bottom: 24px;
      font-family: 'Lora', serif;
    }

    [dir="rtl"] .lp-hero-title {
      font-family: 'Cairo', sans-serif;
    }

    .lp-hero-title span {
      background: linear-gradient(135deg, #1e3a5f 0%, #3498db 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .gradient-text-line1 {
      background: linear-gradient(135deg, #1e3a5f 0%, #2980b9 100%) !important;
      -webkit-background-clip: text !important;
      -webkit-text-fill-color: transparent !important;
      background-clip: text !important;
      color: transparent !important;
      display: block;
    }

    .gradient-text-line2 {
      background: linear-gradient(135deg, #2980b9 0%, #1abc9c 100%) !important;
      -webkit-background-clip: text !important;
      -webkit-text-fill-color: transparent !important;
      background-clip: text !important;
      color: transparent !important;
      display: block;
    }

    .gradient-text-line2-ar {
      background: linear-gradient(135deg, #2980b9 0%, #1e8a7a 40%, #1abc9c 100%) !important;
      -webkit-background-clip: text !important;
      -webkit-text-fill-color: transparent !important;
      background-clip: text !important;
      color: transparent !important;
      display: block;
    }

    .gradient-text-full {
      background: linear-gradient(135deg, #1e3a5f 0%, #3498db 50%, #1abc9c 100%) !important;
      -webkit-background-clip: text !important;
      -webkit-text-fill-color: transparent !important;
      background-clip: text !important;
      color: transparent !important;
    }

    .lp-hero-subtitle {
      font-size: clamp(18px, 2.5vw, 22px);
      color: var(--text-secondary);
      line-height: 1.7;
      margin-bottom: 48px;
      max-width: 560px;
    }

    @media (max-width: 968px) {
      .lp-hero-subtitle {
        margin-left: auto;
        margin-right: auto;
      }
    }

    .lp-cta-btn {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      padding: 18px 48px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 50px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      box-shadow: 0 10px 40px rgba(30, 58, 95, 0.3);
    }

    .lp-cta-btn:hover {
      transform: translateY(-4px) scale(1.02);
      box-shadow: 0 20px 50px rgba(30, 58, 95, 0.4);
    }

    .lp-cta-btn span {
      transition: transform 0.3s ease;
    }

    .lp-cta-btn:hover span {
      transform: translateX(4px);
    }

    [dir="rtl"] .lp-cta-btn:hover span {
      transform: translateX(-4px);
    }

    /* Hero Visual */
    .lp-hero-visual {
      position: relative;
      animation: parallaxFloat 8s ease-in-out infinite;
    }

    .lp-visual-card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(20px);
      border-radius: 32px;
      padding: 40px;
      box-shadow: 0 30px 60px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.8);
    }

    /* Feature Section */
    .lp-section {
      padding: 120px 40px;
      max-width: 1200px;
      margin: 0 auto;
    }

    @media (max-width: 768px) {
      .lp-section {
        padding: 80px 24px;
      }
    }

    .lp-section-title {
      font-size: clamp(32px, 4vw, 48px);
      font-weight: 700;
      color: var(--primary);
      text-align: center;
      margin-bottom: 20px;
      font-family: 'Lora', serif;
    }

    [dir="rtl"] .lp-section-title {
      font-family: 'Cairo', sans-serif;
    }

    .lp-section-subtitle {
      font-size: 18px;
      color: var(--text-secondary);
      text-align: center;
      max-width: 600px;
      margin: 0 auto 80px;
      line-height: 1.7;
    }

    /* Feature Grid */
    .lp-features-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 32px;
    }

    @media (max-width: 968px) {
      .lp-features-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 600px) {
      .lp-features-grid {
        grid-template-columns: 1fr;
      }
    }

    .lp-feature-card {
      background: white;
      border-radius: 24px;
      padding: 40px 32px;
      text-align: center;
      transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      border: 1px solid transparent;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);
    }

    .lp-feature-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      border-color: rgba(52, 152, 219, 0.2);
    }

    .lp-feature-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 24px;
      font-size: 36px;
    }

    .lp-feature-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 12px;
    }

    .lp-feature-desc {
      font-size: 15px;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    /* Process Section */
    .lp-process-section {
      background: linear-gradient(180deg, #f8fafc 0%, #e2e8f0 100%);
    }

    .lp-process-timeline {
      display: flex;
      flex-direction: column;
      gap: 0;
      position: relative;
    }

    .lp-process-timeline::before {
      content: '';
      position: absolute;
      left: 50%;
      top: 0;
      bottom: 0;
      width: 3px;
      background: linear-gradient(180deg, var(--primary) 0%, var(--accent) 100%);
      transform: translateX(-50%);
    }

    [dir="rtl"] .lp-process-timeline::before {
      left: 50%;
    }

    @media (max-width: 768px) {
      .lp-process-timeline::before {
        left: 20px;
        transform: none;
      }

      [dir="rtl"] .lp-process-timeline::before {
        left: auto;
        right: 20px;
      }
    }

    .lp-process-item {
      display: grid;
      grid-template-columns: 1fr 80px 1fr;
      gap: 40px;
      align-items: center;
      padding: 40px 0;
    }

    @media (max-width: 768px) {
      .lp-process-item {
        grid-template-columns: 60px 1fr;
        gap: 20px;
        padding: 30px 0;
      }
    }

    .lp-process-item:nth-child(even) .lp-process-content {
      grid-column: 3;
    }

    .lp-process-item:nth-child(even) .lp-process-spacer {
      grid-column: 1;
    }

    @media (max-width: 768px) {

      .lp-process-item:nth-child(even) .lp-process-content,
      .lp-process-item:nth-child(even) .lp-process-spacer {
        grid-column: auto;
      }
    }

    .lp-process-number {
      width: 60px;
      height: 60px;
      background: white;
      border: 4px solid var(--primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
      margin: 0 auto;
      position: relative;
      z-index: 2;
      box-shadow: 0 4px 20px rgba(30, 58, 95, 0.2);
    }

    .lp-process-content {
      background: white;
      padding: 32px;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.06);
    }

    .lp-process-title {
      font-size: 22px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 12px;
    }

    .lp-process-desc {
      font-size: 16px;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    /* CTA Section */
    .lp-cta-section {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      padding: 100px 40px;
      text-align: center;
    }

    .lp-cta-title {
      font-size: clamp(28px, 4vw, 42px);
      font-weight: 700;
      color: white;
      margin-bottom: 20px;
      font-family: 'Lora', serif;
    }

    [dir="rtl"] .lp-cta-title {
      font-family: 'Cairo', sans-serif;
    }

    .lp-cta-subtitle {
      font-size: 18px;
      color: rgba(255, 255, 255, 0.85);
      margin-bottom: 40px;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }

    .lp-cta-btn-light {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      padding: 18px 48px;
      background: white;
      color: var(--primary);
      border: none;
      border-radius: 50px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    .lp-cta-btn-light:hover {
      transform: translateY(-4px) scale(1.02);
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
    }

    /* Footer */
    .lp-footer {
      background: var(--primary-dark);
      color: rgba(255, 255, 255, 0.7);
      padding: 40px;
      text-align: center;
      font-size: 14px;
    }



    .font-pencil {
      font-family: 'Architects Daughter', cursive;
    }


    /* ========================================
       LINEAR-STYLE COMPONENT STYLES
       3D Perspective & Centered Layout
    ======================================== */

    .linear-layout {
      position: relative;
      overflow-x: hidden;
    }

    .linear-bg-image {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background-image: url('./assets/hero-bg.png');
      background-size: cover;
      background-position: center top;
      opacity: 0.15;
      z-index: 0;
      pointer-events: none;
      mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
      -webkit-mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
    }

    /* Header Updates */
    .linear-header {
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 100;
      padding: 20px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(248, 250, 252, 0.8);
      backdrop-filter: blur(12px);
      transition: all 0.3s ease;
    }

    .linear-header.scrolled {
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 1px 0 rgba(0, 0, 0, 0.05);
      padding: 16px 40px;
    }

    .linear-nav-actions {
      display: flex;
      align-items: center;
      gap: 24px;
    }

    .linear-btn-login {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      background: none;
      border: none;
      transition: color 0.2s;
    }

    .linear-btn-login:hover {
      color: var(--primary);
    }

    .linear-btn-signup {
      padding: 8px 16px;
      background: var(--primary);
      color: white;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }

    .linear-btn-signup:hover {
      background: var(--primary-light);
      transform: translateY(-1px);
    }

    /* Hero Section */
    .linear-hero {
      position: relative;
      min-height: 120vh;
      /* Extra height for the scroll effect */
      padding-top: 140px;
      text-align: center;
      z-index: 1;
      perspective: 2000px;
      /* Critical for 3D effect */
      max-width: 1400px;
      margin: 0 auto;
    }

    .linear-hero-content {
      max-width: 900px;
      margin: 0 auto 80px;
      padding: 0 24px;
      position: relative;
      z-index: 2;
    }

    .linear-title {
      font-size: clamp(48px, 6vw, 80px);
      /* Massive, Linear style */
      font-weight: 700;
      letter-spacing: -0.03em;
      line-height: 1.05;
      color: var(--primary);
      margin-bottom: 24px;
      font-family: 'Inter', sans-serif;
      /* Clean sans for title */
    }

    [dir="rtl"] .linear-title {
      font-family: 'Cairo', sans-serif;
      line-height: 1.3;
    }

    .linear-subtitle {
      font-size: clamp(18px, 2.5vw, 22px);
      color: var(--text-secondary);
      line-height: 1.6;
      max-width: 640px;
      margin: 0 auto 40px;
    }

    .linear-cta-row {
      display: flex;
      gap: 16px;
      justify-content: center;
      margin-bottom: 80px;
    }

    /* 3D Dashboard Mockup */
    .linear-mockup-wrapper {
      position: relative;
      width: 100%;
      max-width: 1100px;
      margin: 0 auto;
      transform-style: preserve-3d;
      transform: rotateX(20deg) scale(0.9);
      transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
      box-shadow:
        0 40px 80px -20px rgba(30, 58, 95, 0.3),
        0 0 0 1px rgba(30, 58, 95, 0.1);
      border-radius: 12px;
      background: white;
    }

    .linear-mockup-wrapper:hover {
      transform: rotateX(10deg) scale(0.95) translateY(-20px);
    }

    .browser-chrome {
      background: #f1f5f9;
      padding: 12px 16px;
      border-radius: 12px 12px 0 0;
      display: flex;
      gap: 8px;
      border-bottom: 1px solid #e2e8f0;
    }

    .browser-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .dot-red {
      background: #ff5f56;
    }

    .dot-yellow {
      background: #ffbd2e;
    }

    .dot-green {
      background: #27c93f;
    }

    .mockup-screen {
      background: white;
      border-radius: 0 0 12px 12px;
      overflow: hidden;
      aspect-ratio: 16/9;
      position: relative;
    }

    /* Gradient Glow behind mockup */
    .linear-glow {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 120%;
      height: 100%;
      background: radial-gradient(circle, rgba(52, 152, 219, 0.2) 0%, transparent 60%);
      pointer-events: none;
      z-index: -1;
    }


    .pencil-border::after {
      content: '';
      position: absolute;
      inset: 0;
      border: 2px solid var(--pencil-navy);
      border-radius: 2px 255px 3px 25px / 255px 5px 225px 3px;
      pointer-events: none;
    }

    .pencil-btn {
      background: transparent;
      color: var(--pencil-navy);
      padding: 12px 32px;
      font-family: 'Architects Daughter', cursive;
      font-size: 1.1rem;
      font-weight: 600;
      border: 2px solid var(--pencil-navy);
      border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .pencil-btn:hover {
      transform: scale(1.02) rotate(-1deg);
      background: rgba(30, 58, 95, 0.05);
      box-shadow: 2px 4px 12px rgba(0, 0, 0, 0.1);
    }

    .landing-hero-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4rem;
      max-width: 1200px;
      margin: 0 auto;
      padding: 4rem 2rem;
      align-items: center;
    }

    @media (max-width: 768px) {
      .landing-hero-grid {
        grid-template-columns: 1fr;
        text-align: center;
        gap: 2rem;
      }
    }

    .sketch-card {
      background: white;
      padding: 2rem;
      border: 2px solid var(--pencil-navy);
      border-radius: 2px 255px 3px 25px / 255px 5px 225px 3px;
      box-shadow: 10px 10px 0px rgba(30, 58, 95, 0.1);
      transition: transform 0.3s ease;
    }

    .sketch-card:hover {
      transform: translateY(-5px);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Lora', Georgia, 'Times New Roman', serif;
      background: var(--bg-main);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, #0a1628 0%, #1e3a5f 40%, #2d5a8a 70%, #1abc9c 100%);
      color: white;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: 50%;
      right: 80px;
      transform: translateY(-50%);
      width: 120px;
      height: 120px;
      background-image: url('assets/logo-sh.png');
      background-size: 75%;
      background-repeat: no-repeat;
      background-position: center;
      background-color: rgba(255, 255, 255, 0.97);
      border-radius: 28px;
      opacity: 0.07;
      pointer-events: none;
      z-index: 0;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    .header::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg,
        transparent 0%,
        rgba(255, 255, 255, 0.03) 30%,
        rgba(255, 255, 255, 0.05) 50%,
        rgba(255, 255, 255, 0.03) 70%,
        transparent 100%);
      pointer-events: none;
      z-index: 0;
    }

    .header-top {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 12px 24px;
      position: relative;
      z-index: 1;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
    }

    .logo-icon {
      width: 44px;
      height: 44px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 6px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .logo-icon img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .logo-text h1 {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.5px;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .logo-text span {
      font-size: 11px;
      opacity: 0.75;
      font-weight: 400;
      letter-spacing: 0.3px;
    }

    /* Navigation Tabs */
    .nav-tabs {
      display: flex;
      gap: 4px;
      padding: 0 24px;
      border-top: 1px solid rgba(255, 255, 255, 0.15);
      position: relative;
      z-index: 1;
      background: rgba(0, 0, 0, 0.1);
    }

    .nav-tab {
      padding: 12px 20px;
      color: rgba(255, 255, 255, 0.7);
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      border-bottom: 3px solid transparent;
      transition: all 0.25s ease;
      position: relative;
    }

    .nav-tab:hover {
      color: white;
      background: rgba(255, 255, 255, 0.08);
    }

    .nav-tab.active {
      color: white;
      border-bottom-color: #1abc9c;
      background: rgba(255, 255, 255, 0.12);
      font-weight: 600;
    }

    /* Auto-save indicator */
    .autosave-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 14px;
      background: rgba(39, 174, 96, 0.15);
      border-radius: var(--radius-md);
      font-size: 12px;
      color: #2ecc71;
    }

    .autosave-indicator.saving {
      background: rgba(52, 152, 219, 0.15);
      color: #3498db;
    }

    .autosave-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
    }

    .autosave-indicator.saving .autosave-dot {
      animation: pulse 1s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.3;
      }
    }

    @keyframes pulse-red {
      0% {
        box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.5);
        border-color: #dc2626;
      }
      50% {
        box-shadow: 0 0 0 8px rgba(220, 38, 38, 0);
        border-color: #ef4444;
      }
      100% {
        box-shadow: 0 0 0 0 rgba(220, 38, 38, 0);
        border-color: #dc2626;
      }
    }

    @keyframes pulse-banner {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.92;
      }
    }

    /* Controls Bar */
    .controls-bar {
      background: var(--bg-card);
      padding: 14px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .control-label {
      font-family: inherit;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
    }

    select,
    .search-input {
      padding: 12px 18px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-family: inherit;
      font-size: 15px;
      font-weight: 500;
      background: var(--bg-card);
      color: var(--text-primary);
      transition: all 0.2s ease;
      min-width: 220px;
    }

    select:focus,
    .search-input:focus {
      outline: none;
      border-color: var(--border-focus);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    select:disabled {
      background: var(--bg-hover);
      color: var(--text-muted);
      cursor: not-allowed;
    }

    .chapters-summary-btn {
      background: linear-gradient(145deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.9) 100%);
      color: #1e3a5f;
      padding: 12px 24px;
      border-radius: 14px;
      font-family: inherit;
      font-weight: 700;
      cursor: pointer;
      border: 1px solid rgba(212, 175, 55, 0.4);
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 13px;
      letter-spacing: 0.8px;
      text-transform: uppercase;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      margin-left: auto;
      box-shadow: 0 4px 16px rgba(212, 175, 55, 0.15),
                  inset 0 1px 0 rgba(255,255,255,0.9),
                  inset 0 -1px 0 rgba(212, 175, 55, 0.1);
      position: relative;
      overflow: hidden;
    }

    .chapters-summary-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 50%;
      background: linear-gradient(to bottom, rgba(255,255,255,0.6), transparent);
      border-radius: 14px 14px 0 0;
      pointer-events: none;
    }

    .chapters-summary-btn:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 8px 24px rgba(212, 175, 55, 0.25),
                  inset 0 1px 0 rgba(255,255,255,1),
                  inset 0 -1px 0 rgba(212, 175, 55, 0.15);
      border-color: rgba(212, 175, 55, 0.6);
    }

    .summary-numbers {
      background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
      color: #1e3a5f;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.5px;
      box-shadow: 0 2px 6px rgba(212, 175, 55, 0.3);
    }

    /* Sidebar Toggle */
    .sidebar-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 18px;
      color: var(--text-secondary);
    }

    .sidebar-toggle:hover {
      background: var(--bg-hover);
      color: var(--primary);
    }

    /* Main Layout */
    .main-container {
      display: flex;
      min-height: calc(100vh - 200px);
    }

    .sidebar {
      width: 260px;
      background: var(--bg-card);
      border-right: 1px solid var(--border);
      padding: 16px 0;
      position: sticky;
      top: 120px;
      height: fit-content;
      max-height: calc(100vh - 220px);
      overflow-y: auto;
      transition: all 0.3s ease;
      flex-shrink: 0;
      padding-bottom: 80px;
    }

    .sidebar.collapsed {
      width: 0;
      padding: 0;
      overflow: hidden;
      border-right: none;
    }

    .sidebar-section {
      padding: 0 12px;
      margin-bottom: 20px;
    }

    .sidebar-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      margin-bottom: 12px;
      padding: 0 8px;
    }

    .standard-nav-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 11px 14px;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 4px;
    }

    .standard-nav-item:hover {
      background: var(--bg-hover);
    }

    .standard-nav-item.active {
      background: rgba(52, 152, 219, 0.1);
      color: var(--accent);
    }

    .standard-nav-code {
      font-weight: 600;
      font-size: 14px;
    }

    .standard-nav-count {
      font-size: 12px;
      color: var(--text-muted);
      background: var(--bg-hover);
      padding: 3px 10px;
      border-radius: 12px;
    }

    .standard-nav-item.active .standard-nav-count {
      background: rgba(52, 152, 219, 0.2);
      color: var(--accent);
    }

    .standard-nav-progress {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .standard-nav-check {
      color: var(--success);
      font-size: 12px;
    }

    .content-area {
      flex: 1;
      padding: 20px 24px;
      padding-bottom: 120px;
    }

    .content-header {
      margin-bottom: 24px;
      padding-bottom: 18px;
      border-bottom: 1px solid var(--border);
    }

    .content-header h2 {
      font-size: 22px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 6px;
      line-height: 1.4;
    }

    .standard-intent {
      font-size: 15px;
      color: var(--text-secondary);
      line-height: 1.6;
      margin: 10px 0 14px 0;
      padding: 14px 18px;
      background: var(--bg-hover);
      border-radius: var(--radius-md);
      border-left: 4px solid var(--primary);
    }

    /* Mother Standard Sections (All Standards View) */
    .mother-standard-section {
      margin-bottom: 32px;
      border-radius: var(--radius-lg);
      overflow: hidden;
    }

    .mother-standard-header {
      display: flex;
      align-items: flex-start;
      gap: 18px;
      padding: 22px 24px;
      background: linear-gradient(135deg, #f0f7ff 0%, #e8f4fd 100%);
      border: 1px solid #c7dff7;
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
      margin-bottom: 0;
    }

    .mother-standard-code {
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 64px;
      height: 64px;
      background: linear-gradient(135deg, #1e6bb8 0%, #1a5a9e 100%);
      color: white;
      font-weight: 700;
      font-size: 15px;
      border-radius: var(--radius-md);
      box-shadow: 0 2px 8px rgba(30, 107, 184, 0.3);
    }

    .mother-standard-content {
      flex: 1;
      min-width: 0;
    }

    .mother-standard-title {
      font-size: 18px;
      font-weight: 600;
      color: #1a4971;
      margin: 0 0 12px 0;
      line-height: 1.45;
    }

    .mother-standard-intent {
      font-size: 15px;
      color: #3d6a8a;
      line-height: 1.6;
      margin: 0;
      padding: 14px 16px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: var(--radius-sm);
      border-left: 4px solid #3d8fd1;
    }

    .mother-standard-badge {
      font-size: 13px;
      font-weight: 600;
      color: #1e6bb8;
      background: rgba(255, 255, 255, 0.85);
      padding: 8px 14px;
      border-radius: 20px;
      white-space: nowrap;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .mother-standard-substandards {
      padding: 20px 0 0 0;
      border-left: 3px solid #e0edfa;
      margin-left: 32px;
      padding-left: 24px;
    }

    .mother-standard-substandards .substandard-card {
      margin-bottom: 14px;
    }

    .mother-standard-substandards .substandard-card:last-child {
      margin-bottom: 0;
    }

    /* Single Standard View - substandards list */
    .single-standard-substandards {
      padding-left: 0;
    }

    .single-standard-substandards .substandard-card {
      margin-bottom: 14px;
    }

    .single-standard-substandards .substandard-card:last-child {
      margin-bottom: 0;
    }

    .substandard-count {
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* Sub-standard Cards */
    .substandard-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      margin-bottom: 14px;
      overflow: hidden;
      transition: all 0.2s ease;
    }

    .substandard-card:hover {
      box-shadow: var(--shadow-md);
    }

    .substandard-card.scored-0 {
      border-left: 4px solid var(--danger);
    }

    .substandard-card.scored-1 {
      border-left: 4px solid var(--warning);
    }

    .substandard-card.scored-2 {
      border-left: 4px solid var(--success);
    }

    .substandard-card.scored-na {
      border-left: 4px solid var(--neutral);
    }

    /* Domain Separator Styles for Full Survey (Config B) */
    .domain-separator {
      position: relative;
      margin: 32px 0 24px 0;
      padding: 20px 24px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(30, 58, 95, 0.03) 0%, rgba(52, 152, 219, 0.06) 100%);
      border: 1px solid rgba(52, 152, 219, 0.15);
      overflow: hidden;
    }

    .domain-separator::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 5px;
      border-radius: 12px 0 0 12px;
    }

    .domain-separator::after {
      content: '';
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      width: 60px;
      height: 60px;
      border-radius: 50%;
      opacity: 0.08;
    }

    .domain-separator.domain-ld::before {
      background: linear-gradient(180deg, #1e3a5f 0%, #3498db 100%);
    }

    .domain-separator.domain-ld::after {
      background: #1e3a5f;
    }

    .domain-separator.domain-ld {
      border-left-color: #3498db;
    }

    .domain-separator.domain-pc::before {
      background: linear-gradient(180deg, #0d6b4e 0%, #27ae60 100%);
    }

    .domain-separator.domain-pc::after {
      background: #0d6b4e;
    }

    .domain-separator.domain-pc {
      border-left-color: #27ae60;
    }

    .domain-separator.domain-dl::before {
      background: linear-gradient(180deg, #6b4e0d 0%, #f39c12 100%);
    }

    .domain-separator.domain-dl::after {
      background: #6b4e0d;
    }

    .domain-separator.domain-dl {
      border-left-color: #f39c12;
    }

    .domain-separator.domain-ipc::before {
      background: linear-gradient(180deg, #5e1e5e 0%, #9b59b6 100%);
    }

    .domain-separator.domain-ipc::after {
      background: #5e1e5e;
    }

    .domain-separator.domain-ipc {
      border-left-color: #9b59b6;
    }

    .domain-separator.domain-moi::before {
      background: linear-gradient(180deg, #1e5e5e 0%, #16a085 100%);
    }

    .domain-separator.domain-moi::after {
      background: #1e5e5e;
    }

    .domain-separator.domain-moi {
      border-left-color: #16a085;
    }

    .domain-separator.domain-fms::before {
      background: linear-gradient(180deg, #5e1e2d 0%, #e74c3c 100%);
    }

    .domain-separator.domain-fms::after {
      background: #5e1e2d;
    }

    .domain-separator.domain-fms {
      border-left-color: #e74c3c;
    }

    .domain-separator-content {
      display: flex;
      align-items: center;
      gap: 16px;
      position: relative;
      z-index: 1;
    }

    .domain-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 16px;
      color: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .domain-icon.domain-ld {
      background: linear-gradient(135deg, #1e3a5f 0%, #2d5a8a 100%);
    }

    .domain-icon.domain-pc {
      background: linear-gradient(135deg, #0d6b4e 0%, #1a9d6c 100%);
    }

    .domain-icon.domain-dl {
      background: linear-gradient(135deg, #6b4e0d 0%, #9d7a1a 100%);
    }

    .domain-icon.domain-ipc {
      background: linear-gradient(135deg, #5e1e5e 0%, #8a3d8a 100%);
    }

    .domain-icon.domain-moi {
      background: linear-gradient(135deg, #1e5e5e 0%, #3d8a8a 100%);
    }

    .domain-icon.domain-fms {
      background: linear-gradient(135deg, #5e1e2d 0%, #8a3d4d 100%);
    }

    .domain-info {
      flex: 1;
    }

    .domain-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
      font-family: 'Inter', sans-serif;
    }

    .domain-subtitle {
      font-size: 13px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .domain-stats {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-left: auto;
    }

    .domain-stat {
      text-align: center;
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 8px;
      min-width: 70px;
    }

    .domain-stat-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--primary);
      font-family: 'Inter', sans-serif;
    }

    .domain-stat-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Full Survey sidebar navigation */
    .sidebar-domain-group {
      margin-bottom: 4px;
      border-radius: 8px;
      overflow: hidden;
      transition: all 0.2s ease;
    }

    .sidebar-domain-group:hover {
      background: rgba(52, 152, 219, 0.03);
    }

    .sidebar-domain-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 2px;
      user-select: none;
    }

    .sidebar-domain-header:hover {
      background: rgba(52, 152, 219, 0.1);
    }

    .sidebar-domain-header.active {
      background: rgba(52, 152, 219, 0.15);
      border-left: 3px solid var(--accent);
    }

    .sidebar-domain-header:active {
      transform: scale(0.98);
    }

    .sidebar-domain-toggle {
      cursor: pointer;
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-hover);
      border-radius: 4px;
      font-size: 10px;
      color: var(--text-muted);
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .sidebar-domain-toggle:hover {
      background: var(--accent);
      color: white;
    }

    .sidebar-domain-toggle.expanded {
      transform: rotate(90deg);
    }

    .sidebar-domain-badge {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 11px;
      color: white;
    }

    .sidebar-domain-badge.domain-ld {
      background: linear-gradient(135deg, #1e3a5f 0%, #3498db 100%);
    }

    .sidebar-domain-badge.domain-pc {
      background: linear-gradient(135deg, #0d6b4e 0%, #27ae60 100%);
    }

    .sidebar-domain-badge.domain-dl {
      background: linear-gradient(135deg, #6b4e0d 0%, #f39c12 100%);
    }

    .sidebar-domain-badge.domain-ipc {
      background: linear-gradient(135deg, #5e1e5e 0%, #9b59b6 100%);
    }

    .sidebar-domain-badge.domain-moi {
      background: linear-gradient(135deg, #1e5e5e 0%, #16a085 100%);
    }

    .sidebar-domain-badge.domain-fms {
      background: linear-gradient(135deg, #5e1e2d 0%, #e74c3c 100%);
    }

    .sidebar-domain-name {
      flex: 1;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .sidebar-domain-count {
      font-size: 12px;
      color: var(--text-muted);
      background: var(--bg-hover);
      padding: 2px 8px;
      border-radius: 10px;
    }

    .sidebar-domain-standards {
      margin-left: 24px;
      border-left: 2px solid var(--border);
      padding-left: 10px;
      margin-bottom: 4px;
      margin-top: 4px;
    }

    /* Full Survey View Styles */
    .full-survey-view {
      scroll-behavior: smooth;
    }

    .domain-section {
      scroll-margin-top: 20px;
      padding-top: 8px;
    }

    .domain-section:first-child .domain-separator {
      margin-top: 0;
    }

    /* Sticky domain navigation for full survey */
    .domain-quick-nav {
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--bg-main);
      padding: 12px 0;
      margin-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .substandard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 18px;
      background: var(--bg-hover);
      border-bottom: 1px solid var(--border);
    }

    .substandard-code {
      font-weight: 700;
      font-size: 16px;
      color: var(--primary);
    }

    .activity-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 12px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 600;
    }

    .activity-badge.doc {
      background: #e3f2fd;
      color: #1565c0;
    }

    .activity-badge.obs {
      background: #fff3e0;
      color: #e65100;
    }

    .activity-badge.int {
      background: #f3e5f5;
      color: #7b1fa2;
    }

    .activity-badge.per {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .activity-badge.den {
      background: #fce4ec;
      color: #c2185b;
    }

    .substandard-body {
      padding: 18px 20px;
    }

    .substandard-text {
      font-size: 15px;
      line-height: 1.7;
      color: var(--text-primary);
      margin-bottom: 18px;
    }

    .scoring-section {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: flex-start;
    }

    .score-options {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .score-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border: 2px solid var(--border);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
      font-weight: 500;
    }

    .score-option:hover {
      border-color: var(--text-muted);
    }

    .score-option.selected {
      border-color: var(--primary);
      background: rgba(30, 58, 95, 0.05);
    }

    .score-option.na.selected {
      border-color: var(--neutral);
      background: rgba(149, 165, 166, 0.1);
    }

    .score-option.not-met.selected {
      border-color: var(--danger);
      background: rgba(231, 76, 60, 0.1);
    }

    .score-option.partial.selected {
      border-color: var(--warning);
      background: rgba(243, 156, 18, 0.1);
    }

    .score-option.full.selected {
      border-color: var(--success);
      background: rgba(39, 174, 96, 0.1);
    }

    .score-indicator {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      color: white;
    }

    .score-indicator.na {
      background: var(--neutral);
    }

    .score-indicator.not-met {
      background: var(--danger);
    }

    .score-indicator.partial {
      background: var(--warning);
    }

    .score-indicator.full {
      background: var(--success);
    }

    .comment-section {
      flex: 1;
      min-width: 280px;
    }

    .comment-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      min-height: 54px;
      transition: all 0.2s ease;
    }

    .comment-input:focus {
      outline: none;
      border-color: var(--border-focus);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .location-field {
      margin-top: 10px;
    }

    .location-input {
      width: 100%;
      max-width: 300px;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 14px;
    }

    .location-input:focus {
      outline: none;
      border-color: var(--border-focus);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    /* Score Summary Panel */
    .score-summary-panel {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-card);
      border-top: 1px solid var(--border);
      padding: 14px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
      z-index: 50;
    }

    .score-display {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .score-main {
      text-align: center;
    }

    .score-percentage {
      font-size: 32px;
      font-weight: 700;
      line-height: 1;
    }

    .score-percentage.excellent {
      color: var(--success);
    }

    .score-percentage.good {
      color: #d97706;
    }

    .score-percentage.needs-improvement {
      color: var(--warning);
    }

    .score-percentage.critical {
      color: var(--danger);
    }

    .score-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .score-breakdown {
      display: flex;
      gap: 16px;
    }

    .breakdown-item {
      text-align: center;
      padding: 6px 14px;
      background: var(--bg-hover);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s ease;
      border: 2px solid transparent;
    }

    .breakdown-item:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }

    .breakdown-item.active {
      border-color: var(--primary);
      background: rgba(30, 58, 95, 0.1);
    }

    .breakdown-item.active.filter-full {
      border-color: var(--success);
      background: rgba(39, 174, 96, 0.1);
    }

    .breakdown-item.active.filter-partial {
      border-color: var(--warning);
      background: rgba(243, 156, 18, 0.1);
    }

    .breakdown-item.active.filter-not-met {
      border-color: var(--danger);
      background: rgba(231, 76, 60, 0.1);
    }

    .breakdown-item.active.filter-na {
      border-color: var(--neutral);
      background: rgba(149, 165, 166, 0.1);
    }

    .breakdown-item.not-scored-item {
      background: rgba(142, 68, 173, 0.08);
      border: 2px dashed rgba(142, 68, 173, 0.3);
    }

    .breakdown-item.not-scored-item:hover {
      background: rgba(142, 68, 173, 0.12);
      border-color: rgba(142, 68, 173, 0.5);
    }

    .breakdown-value {
      font-size: 20px;
      font-weight: 600;
    }

    .breakdown-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .progress-bar-container {
      flex: 1;
      max-width: 350px;
      margin: 0 20px;
    }

    .progress-bar {
      height: 8px;
      background: var(--bg-hover);
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      transition: width 0.3s ease;
      border-radius: 4px;
    }

    .progress-text {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 5px;
      text-align: center;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: var(--radius-md);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      text-decoration: none;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-primary:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: #219a52;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: #c0392b;
    }

    .btn-outline-dark {
      background: transparent;
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .btn-outline-dark:hover {
      background: var(--bg-hover);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
    }

    /* Modals */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 24px;
      animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .modal {
      background: var(--bg-card);
      border-radius: 16px;
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(255, 255, 255, 0.1);
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: scale(0.95) translateY(-10px);
      }

      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .modal-header {
      padding: 18px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      font-size: 18px;
      font-weight: 600;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: var(--bg-hover);
      cursor: pointer;
      font-size: 18px;
      color: var(--text-secondary);
      transition: all 0.2s ease;
    }

    .modal-close:hover {
      background: var(--border);
    }

    .modal-body {
      padding: 24px;
      overflow-y: auto;
      max-height: calc(90vh - 130px);
    }

    /* Completion Celebration Modal */
    .completion-modal {
      text-align: center;
      padding: 40px;
    }

    .completion-icon {
      font-size: 80px;
      margin-bottom: 20px;
      animation: bounce 0.6s ease infinite alternate;
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }

    @keyframes bounce {
      from {
        transform: translateY(0);
      }

      to {
        transform: translateY(-10px);
      }
    }

    .completion-title {
      font-size: 28px;
      font-weight: 700;
      color: var(--success);
      margin-bottom: 12px;
    }

    .completion-subtitle {
      font-size: 16px;
      color: var(--text-secondary);
      margin-bottom: 30px;
    }

    .completion-stats {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-bottom: 30px;
      padding: 20px;
      background: var(--bg-hover);
      border-radius: var(--radius-lg);
    }

    .completion-stat {
      text-align: center;
    }

    .completion-stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--primary);
    }

    .completion-stat-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    /* Finalize Button */
    .finalize-btn {
      background: linear-gradient(135deg, var(--success) 0%, #219a52 100%);
      color: white;
      padding: 14px 28px;
      border-radius: 25px;
      font-family: inherit;
      font-weight: 700;
      font-size: 15px;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
    }

    .finalize-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(39, 174, 96, 0.4);
    }

    .finalize-btn:disabled {
      background: var(--neutral);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .finalize-btn-small {
      padding: 10px 20px;
      font-size: 13px;
      border-radius: 20px;
    }

    /* Confirmation Dialog */
    .confirm-dialog {
      text-align: center;
      padding: 30px;
    }

    .confirm-icon {
      font-size: 60px;
      margin-bottom: 20px;
    }

    .confirm-title {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .confirm-message {
      font-size: 15px;
      color: var(--text-secondary);
      margin-bottom: 30px;
      line-height: 1.6;
    }

    .confirm-buttons {
      display: flex;
      justify-content: center;
      gap: 16px;
    }

    .confirm-btn {
      padding: 12px 30px;
      border-radius: 25px;
      font-family: inherit;
      font-weight: 600;
      font-size: 14px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .confirm-btn-cancel {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .confirm-btn-cancel:hover {
      background: var(--border);
    }

    .confirm-btn-submit {
      background: linear-gradient(135deg, var(--success) 0%, #219a52 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
    }

    .confirm-btn-submit:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(39, 174, 96, 0.4);
    }

    /* Finalized Badge */
    .finalized-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      background: linear-gradient(145deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.9) 100%);
      color: #27ae60;
      border: 1px solid rgba(39, 174, 96, 0.3);
      border-radius: 12px;
      font-size: 13px;
      font-weight: 700;
      box-shadow: 0 3px 12px rgba(39, 174, 96, 0.15),
                  inset 0 1px 0 rgba(255,255,255,0.9);
      position: relative;
      overflow: hidden;
    }

    .finalized-badge::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 50%;
      background: linear-gradient(to bottom, rgba(255,255,255,0.5), transparent);
      pointer-events: none;
    }

    .finalized-badge span {
      background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      box-shadow: 0 2px 6px rgba(39, 174, 96, 0.3);
    }

    /* Modern Toast Notification */
    .toast-container {
      position: fixed;
      top: 24px;
      right: 24px;
      z-index: 300;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .toast {
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15), 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 20px 24px;
      min-width: 360px;
      max-width: 450px;
      display: flex;
      align-items: flex-start;
      gap: 16px;
      animation: slideIn 0.3s ease;
      border-left: 4px solid var(--success);
    }

    .toast.error {
      border-left-color: var(--danger);
    }

    .toast.warning {
      border-left-color: var(--warning);
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }

      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

    .toast.closing {
      animation: slideOut 0.3s ease forwards;
    }

    .toast-icon {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      flex-shrink: 0;
    }

    .toast-icon.success {
      background: rgba(39, 174, 96, 0.1);
      color: var(--success);
    }

    .toast-icon.error {
      background: rgba(231, 76, 60, 0.1);
      color: var(--danger);
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 600;
      font-size: 16px;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .toast-message {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .toast-close {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 20px;
      padding: 4px;
      margin: -4px -4px 0 0;
      transition: color 0.2s;
    }

    .toast-close:hover {
      color: var(--text-primary);
    }

    /* Modern Confirm Modal */
    .modern-confirm {
      max-width: 440px;
    }

    .modern-confirm-body {
      text-align: center;
      padding: 40px 32px;
    }

    .modern-confirm-icon {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
      font-size: 36px;
    }

    .modern-confirm-icon.warning {
      background: rgba(243, 156, 18, 0.1);
      color: var(--warning);
    }

    .modern-confirm-icon.danger {
      background: rgba(231, 76, 60, 0.1);
      color: var(--danger);
    }

    .modern-confirm-title {
      font-size: 22px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
    }

    .modern-confirm-message {
      font-size: 15px;
      color: var(--text-secondary);
      line-height: 1.6;
      margin-bottom: 32px;
    }

    .modern-confirm-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .modern-btn {
      padding: 14px 28px;
      border-radius: 10px;
      font-family: inherit;
      font-weight: 600;
      font-size: 15px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 120px;
    }

    .modern-btn-secondary {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .modern-btn-secondary:hover {
      background: var(--border);
    }

    .modern-btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(30, 58, 95, 0.3);
    }

    .modern-btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(30, 58, 95, 0.4);
    }

    .modern-btn-danger {
      background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
    }

    .modern-btn-danger:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(231, 76, 60, 0.4);
    }

    .modern-btn-success {
      background: linear-gradient(135deg, var(--success) 0%, #219a52 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
    }

    .modern-btn-success:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(39, 174, 96, 0.4);
    }

    /* Assessment Status Badges */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }

    .status-badge.not-started {
      background: rgba(113, 128, 150, 0.1);
      color: #718096;
      border: 1px solid rgba(113, 128, 150, 0.25);
    }

    .status-badge.in-progress {
      background: rgba(49, 130, 206, 0.1);
      color: #2b6cb0;
      border: 1px solid rgba(49, 130, 206, 0.3);
      animation: progressPulse 2.5s infinite;
    }

    @keyframes progressPulse {

      0%,
      100% {
        box-shadow: 0 0 0 0 rgba(49, 130, 206, 0.3);
      }

      50% {
        box-shadow: 0 0 0 4px rgba(49, 130, 206, 0);
      }
    }

    .status-badge.completed {
      background: rgba(72, 187, 120, 0.1);
      color: #276749;
      border: 1px solid rgba(72, 187, 120, 0.3);
    }

    /* Assessment Card for History */
    .assessment-card {
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      transition: all 0.3s ease;
      border: 1px solid var(--border);
    }

    .assessment-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    .assessment-card.current {
      border: 2px solid var(--accent);
      box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.1);
    }

    .assessment-card-header {
      padding: 24px;
      background: linear-gradient(160deg, #1a2f4a 0%, #2d4a6f 50%, #1e3a5f 100%);
      color: white;
      position: relative;
      overflow: hidden;
    }

    /* Subtle corner glow effect */
    .assessment-card-header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.08) 0%, transparent 60%);
      pointer-events: none;
    }

    .assessment-card-header.in-progress {
      background: linear-gradient(160deg, #1e3a5f 0%, #2c5282 50%, #1a365d 100%);
    }

    .assessment-card-header.in-progress::before {
      background: radial-gradient(circle at top right, rgba(52, 152, 219, 0.15) 0%, transparent 50%);
    }

    .assessment-card-header.completed {
      background: linear-gradient(160deg, #1a2f4a 0%, #234e6f 50%, #1e3a5f 100%);
    }

    .assessment-card-header.completed::before {
      background: radial-gradient(circle at top right, rgba(39, 174, 96, 0.2) 0%, transparent 50%);
    }

    .assessment-card-header.not-started {
      background: linear-gradient(160deg, #2d3748 0%, #4a5568 50%, #2d3748 100%);
    }

    .assessment-card-header.not-started::before {
      background: radial-gradient(circle at top right, rgba(160, 174, 192, 0.1) 0%, transparent 50%);
    }

    .assessment-card-logo {
      width: 64px;
      height: 64px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      margin-bottom: 16px;
    }

    .assessment-card-center-name {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .assessment-card-coordinator {
      font-size: 14px;
      opacity: 0.9;
    }

    .assessment-card-body {
      padding: 24px;
    }

    .assessment-card-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }

    .assessment-stat-item {
      text-align: center;
      padding: 12px;
      background: var(--bg-hover);
      border-radius: 12px;
    }

    .assessment-stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .assessment-stat-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 4px;
    }

    .assessment-card-footer {
      padding: 16px 24px;
      background: var(--bg-hover);
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .current-badge {
      background: linear-gradient(135deg, var(--accent) 0%, #2980b9 100%);
      color: white;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      animation: currentPulse 2s infinite;
    }

    @keyframes currentPulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.7;
      }
    }

    /* Center Details Form Modal */
    .center-form-modal {
      max-width: 500px;
    }

    .center-form-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      padding: 28px 32px;
      text-align: center;
    }

    .center-form-header h3 {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .center-form-header p {
      font-size: 14px;
      opacity: 0.9;
    }

    .center-form-body {
      padding: 32px;
    }

    .form-group {
      margin-bottom: 24px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .form-label .required {
      color: var(--danger);
      margin-left: 2px;
    }

    .form-input {
      width: 100%;
      padding: 14px 18px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-family: inherit;
      font-size: 15px;
      color: var(--text-primary);
      transition: all 0.2s ease;
      background: white;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.1);
    }

    .form-input::placeholder {
      color: var(--text-muted);
    }

    .form-input.error {
      border-color: var(--danger);
    }

    .form-error {
      font-size: 13px;
      color: var(--danger);
      margin-top: 6px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .form-actions {
      display: flex;
      gap: 12px;
      margin-top: 32px;
    }

    .form-actions .modern-btn {
      flex: 1;
    }

    /* Contact Links */
    .contact-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--accent);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s;
    }

    .contact-link:hover {
      color: var(--primary);
    }

    .contact-link.whatsapp {
      color: #128C7E;
      font-weight: 600;
      background: linear-gradient(135deg, rgba(37, 211, 102, 0.12) 0%, rgba(18, 140, 126, 0.15) 100%);
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid rgba(18, 140, 126, 0.25);
      transition: all 0.2s ease;
    }

    .contact-link.whatsapp:hover {
      color: #075E54;
      background: linear-gradient(135deg, rgba(37, 211, 102, 0.2) 0%, rgba(18, 140, 126, 0.25) 100%);
      border-color: rgba(18, 140, 126, 0.4);
      transform: translateY(-1px);
    }

    .contact-link.email {
      color: #2563eb;
      font-weight: 600;
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.1) 0%, rgba(59, 130, 246, 0.12) 100%);
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid rgba(37, 99, 235, 0.2);
      transition: all 0.2s ease;
    }

    .contact-link.email:hover {
      color: #1d4ed8;
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.18) 0%, rgba(59, 130, 246, 0.2) 100%);
      border-color: rgba(37, 99, 235, 0.35);
      transform: translateY(-1px);
    }

    /* Assessment Info Bar */
    .assessment-info-bar {
      background: linear-gradient(135deg, rgba(30, 58, 95, 0.05) 0%, rgba(52, 152, 219, 0.05) 100%);
      border: 1px solid rgba(52, 152, 219, 0.2);
      border-radius: 10px;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .assessment-center-name {
      font-weight: 600;
      font-size: 16px;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .assessment-coordinator {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .coordinator-name {
      font-weight: 500;
      color: var(--text-primary);
    }

    /* Chapter Summary Modal */
    .chapter-summary-grid {
      display: grid;
      gap: 12px;
    }

    .chapter-summary-row {
      display: grid;
      grid-template-columns: 80px 1fr repeat(5, 55px);
      gap: 8px;
      align-items: center;
      padding: 14px 18px;
      background: var(--bg-hover);
      border-radius: var(--radius-md);
      font-size: 15px;
    }

    .chapter-summary-row.header {
      background: var(--primary);
      color: white;
      font-weight: 600;
      font-size: 13px;
    }

    /* Page Container */
    .page-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }

    /* Cards */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }

    .card-header {
      padding: 18px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-header h2 {
      font-size: 18px;
      font-weight: 600;
    }

    .card-body {
      padding: 24px;
    }

    /* Dashboard Stats */
    .dashboard-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 28px;
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 20px;
    }

    .stat-card-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--primary);
    }

    .stat-card-label {
      font-size: 14px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    /* Centers Grid */
    .centers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 18px;
      margin-top: 18px;
    }

    .center-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 20px;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .center-card:hover {
      box-shadow: var(--shadow-md);
      border-color: var(--accent);
    }

    .center-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--primary);
    }

    .center-location {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 3px;
    }

    .center-score-badge {
      padding: 6px 14px;
      border-radius: var(--radius-md);
      font-weight: 700;
      font-size: 16px;
    }

    .center-score-badge.excellent {
      background: var(--success-light);
      color: var(--success);
    }

    .center-score-badge.good {
      background: #fef3c7;
      color: #d97706;
    }

    .center-score-badge.needs-improvement {
      background: var(--warning-light);
      color: #b45309;
    }

    .center-score-badge.critical {
      background: var(--danger-light);
      color: var(--danger);
    }

    .center-score-badge.not-started {
      background: var(--bg-hover);
      color: var(--text-muted);
    }

    /* Form Styles */
    .form-group {
      margin-bottom: 18px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 6px;
      color: var(--text-primary);
    }

    .form-input,
    .form-select {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 14px;
      font-family: inherit;
      transition: all 0.2s ease;
    }

    .form-input:focus,
    .form-select:focus {
      outline: none;
      border-color: var(--border-focus);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 18px;
    }

    .modal-footer {
      padding: 14px 24px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    /* History Table */
    .history-table {
      width: 100%;
      border-collapse: collapse;
    }

    .history-table th,
    .history-table td {
      padding: 12px 14px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    .history-table th {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-muted);
      background: var(--bg-hover);
    }

    .history-table tr:hover td {
      background: var(--bg-hover);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 50px 24px;
      color: var(--text-secondary);
    }

    .empty-state-icon {
      font-size: 56px;
      margin-bottom: 14px;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 18px;
      margin-bottom: 6px;
      color: var(--text-primary);
    }

    /* Score Interpretation */
    .interpretation-card {
      padding: 18px;
      border-radius: var(--radius-md);
      margin-top: 18px;
    }

    .interpretation-card.excellent {
      background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
      border: 1px solid var(--success);
    }

    .interpretation-card.good {
      background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%);
      border: 1px solid #ffc107;
    }

    .interpretation-card.needs-improvement {
      background: linear-gradient(135deg, #ffe5d0 0%, #ffd8b8 100%);
      border: 1px solid var(--warning);
    }

    .interpretation-card.critical {
      background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
      border: 1px solid var(--danger);
    }

    .interpretation-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .interpretation-text {
      font-size: 13px;
      line-height: 1.5;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .sidebar {
        display: none;
      }

      .sidebar-toggle {
        display: none;
      }

      .dashboard-stats {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .header-top {
        flex-direction: column;
        gap: 10px;
      }

      .nav-tabs {
        overflow-x: auto;
      }

      .controls-bar {
        flex-direction: column;
        align-items: stretch;
      }

      .control-group {
        width: 100%;
      }

      select,
      .search-input {
        width: 100%;
        min-width: auto;
      }

      .score-summary-panel {
        flex-direction: column;
        gap: 14px;
        padding: 12px;
      }

      .score-breakdown {
        flex-wrap: wrap;
        justify-content: center;
      }

      .scoring-section {
        flex-direction: column;
      }

      .dashboard-stats {
        grid-template-columns: 1fr;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .centers-grid {
        grid-template-columns: 1fr;
      }
    }

    /* ============================================ */
    /* MOBILE WEB INTERFACE - Comprehensive Styles */
    /* ============================================ */

    /* Mobile Landing Page */
    @media (max-width: 768px) {
      .mobile-landing-header {
        padding: 12px 20px !important;
      }

      .mobile-landing-hero {
        min-height: 100vh;
        padding: 80px 20px 40px !important;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .mobile-hero-title {
        font-size: 32px !important;
        line-height: 1.3 !important;
        margin-bottom: 16px !important;
      }

      .mobile-hero-subtitle {
        font-size: 15px !important;
        margin-bottom: 32px !important;
      }

      .mobile-services-grid {
        display: grid !important;
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 12px !important;
        margin-top: 24px !important;
      }

      .mobile-service-card {
        padding: 16px 12px !important;
        text-align: center !important;
      }

      .mobile-cta-btn {
        width: 100% !important;
        padding: 16px 24px !important;
        font-size: 16px !important;
      }

      /* Hide desktop floating cards on mobile */
      .desktop-floating-cards {
        display: none !important;
      }

      /* Mobile excellence card */
      .mobile-excellence-card {
        display: block !important;
        margin: 24px auto !important;
        max-width: 320px !important;
      }
    }

    /* Mobile Main App - Hide Scoring Tab */
    @media (max-width: 768px) {
      .nav-tabs .nav-tab[data-tab="scoring"] {
        display: none !important;
      }

      .mobile-only-message {
        display: block !important;
      }
    }

    @media (min-width: 769px) {
      .mobile-only-message {
        display: none !important;
      }
    }

    /* Mobile Shared Assessment Viewer */
    @media (max-width: 768px) {
      .shared-view-header {
        padding: 12px 16px !important;
        flex-direction: column !important;
        gap: 8px !important;
      }

      .shared-view-score-hero {
        padding: 24px 20px !important;
        flex-direction: column !important;
        text-align: center !important;
      }

      .shared-view-score-number {
        font-size: 48px !important;
      }

      .shared-view-score-cards {
        flex-direction: row !important;
        flex-wrap: wrap !important;
        justify-content: center !important;
        gap: 8px !important;
      }

      .shared-view-score-card {
        padding: 12px 16px !important;
        min-width: 80px !important;
      }

      .shared-view-actions {
        flex-direction: column !important;
        gap: 12px !important;
      }

      .shared-view-btn {
        width: 100% !important;
        justify-content: center !important;
      }

      /* Hide View Full Details on mobile */
      .shared-view-btn-details {
        display: none !important;
      }

      .mobile-details-disabled-msg {
        display: block !important;
      }
    }

    @media (min-width: 769px) {
      .mobile-details-disabled-msg {
        display: none !important;
      }
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-hover);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useCallback, useRef } = React;

    // ============================================
    // LOCAL STORAGE HELPERS (Auto-save)
    // ============================================
    const STORAGE_KEYS = {
      CENTERS: 'cbahi_centers',
      SURVEYS: 'cbahi_surveys',
      CURRENT_SCORES: 'cbahi_current_scores'
    };

    // ============================================
    // ADMIN CREDENTIALS
    // ============================================
    const ADMIN_USERNAME = 'admin';
    const ADMIN_PASSWORD = 'admin123';

    const storage = {
      get: (key) => {
        try {
          const data = localStorage.getItem(key);
          return data ? JSON.parse(data) : null;
        } catch (e) {
          console.error('Storage get error:', e);
          return null;
        }
      },
      set: (key, value) => {
        try {
          localStorage.setItem(key, JSON.stringify(value));
          return true;
        } catch (e) {
          console.error('Storage set error:', e);
          return false;
        }
      },
      remove: (key) => {
        try {
          localStorage.removeItem(key);
          return true;
        } catch (e) {
          console.error('Storage remove error:', e);
          return false;
        }
      }
    };

    // ============================================
    // SVG ICONS - Professional UI Icons
    // ============================================
    const Icons = {
      building: (props = {}) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke={props.color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect>
          <path d="M9 22v-4h6v4"></path>
          <path d="M8 6h.01"></path><path d="M16 6h.01"></path><path d="M12 6h.01"></path>
          <path d="M12 10h.01"></path><path d="M12 14h.01"></path>
          <path d="M16 10h.01"></path><path d="M16 14h.01"></path>
          <path d="M8 10h.01"></path><path d="M8 14h.01"></path>
        </svg>
      ),
      edit: (props = {}) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 16} height={props.size || 16} viewBox="0 0 24 24" fill="none" stroke={props.color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
        </svg>
      ),
      clipboard: (props = {}) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke={props.color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
          <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
        </svg>
      ),
      checkCircle: (props = {}) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 16} height={props.size || 16} viewBox="0 0 24 24" fill="none" stroke={props.color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
          <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
      ),
      barChart: (props = {}) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke={props.color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <line x1="12" y1="20" x2="12" y2="10"></line>
          <line x1="18" y1="20" x2="18" y2="4"></line>
          <line x1="6" y1="20" x2="6" y2="16"></line>
        </svg>
      ),
      award: (props = {}) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 20} height={props.size || 20} viewBox="0 0 24 24" fill="none" stroke={props.color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <circle cx="12" cy="8" r="7"></circle>
          <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline>
        </svg>
      ),
      user: (props = {}) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 16} height={props.size || 16} viewBox="0 0 24 24" fill="none" stroke={props.color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
      ),
      phone: (props = {}) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 16} height={props.size || 16} viewBox="0 0 24 24" fill="none" stroke={props.color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
        </svg>
      ),
      mail: (props = {}) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 16} height={props.size || 16} viewBox="0 0 24 24" fill="none" stroke={props.color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
          <polyline points="22,6 12,13 2,6"></polyline>
        </svg>
      ),
      calendar: (props = {}) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 16} height={props.size || 16} viewBox="0 0 24 24" fill="none" stroke={props.color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
      ),
      x: (props = {}) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 16} height={props.size || 16} viewBox="0 0 24 24" fill="none" stroke={props.color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      ),
      plus: (props = {}) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 16} height={props.size || 16} viewBox="0 0 24 24" fill="none" stroke={props.color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
      ),
      whatsapp: (props = {}) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 16} height={props.size || 16} viewBox="0 0 24 24" fill={props.color || "#25D366"}>
          <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z" />
        </svg>
      ),
      trash: (props = {}) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 16} height={props.size || 16} viewBox="0 0 24 24" fill="none" stroke={props.color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <polyline points="3 6 5 6 21 6"></polyline>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          <line x1="10" y1="11" x2="10" y2="17"></line>
          <line x1="14" y1="11" x2="14" y2="17"></line>
        </svg>
      )
    };

    // ============================================
    // FIREBASE CONFIGURATION
    // ============================================
    // TODO: Replace with your Firebase project config
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // Initialize Firebase (only if config is set)
    let db = null;
    let firebaseInitialized = false;
    try {
      if (firebaseConfig.apiKey !== "YOUR_API_KEY" && typeof firebase !== 'undefined') {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        firebaseInitialized = true;
        console.log('Firebase initialized successfully');
      }
    } catch (e) {
      console.warn('Firebase initialization skipped:', e.message);
    }

    // Firebase helpers
    const firebaseHelpers = {
      // Submit finalized assessment to Firebase
      submitAssessment: async (assessmentData) => {
        if (!firebaseInitialized || !db) {
          // Fallback to localStorage if Firebase is not configured
          const submissions = storage.get('cbahi_submissions') || [];
          const submission = {
            ...assessmentData,
            id: 'LOCAL_' + Date.now(),
            submittedAt: new Date().toISOString(),
            storageType: 'local'
          };
          submissions.push(submission);
          storage.set('cbahi_submissions', submissions);
          return { success: true, id: submission.id, local: true };
        }

        try {
          const docRef = await db.collection('assessments').add({
            ...assessmentData,
            submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
            storageType: 'firebase'
          });
          return { success: true, id: docRef.id, local: false };
        } catch (e) {
          console.error('Firebase submit error:', e);
          throw e;
        }
      },

      // Get all submissions
      getSubmissions: async () => {
        const localSubmissions = storage.get('cbahi_submissions') || [];

        if (!firebaseInitialized || !db) {
          return localSubmissions;
        }

        try {
          const snapshot = await db.collection('assessments')
            .orderBy('submittedAt', 'desc')
            .get();
          const firebaseSubmissions = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data(),
            submittedAt: doc.data().submittedAt?.toDate?.()?.toISOString() || doc.data().submittedAt
          }));
          return [...firebaseSubmissions, ...localSubmissions];
        } catch (e) {
          console.error('Firebase get error:', e);
          return localSubmissions;
        }
      }
    };

    // ============================================
    // DATA: Leadership Domain - Surveyor 1
    // ============================================
    const leadershipStandards = [
      {
        id: 'LD.1', code: 'LD.1',
        title: 'The governing body defines its structure and operational responsibilities in a written document.',
        intent: 'The governing body highlights its structure, roles, and responsibilities including approval of strategic plan, budget, mission, vision, scope of services, and appointing the center\'s director.',
        substandards: [
          { id: 'LD.1.1', code: 'LD.1.1', text: "The governing body approves and periodically reviews the center's mission, vision, and values and makes it public.", activityType: 'DOC' },
          { id: 'LD.1.2', code: 'LD.1.2', text: "The governing body approves the center's strategic plan, the scope of services, and key policies and procedures.", activityType: 'DOC' },
          { id: 'LD.1.3', code: 'LD.1.3', text: "The governing body approves the center's operating and capital budgets, as well as other resources required to manage the center efficiently.", activityType: 'DOC' },
          { id: 'LD.1.4', code: 'LD.1.4', text: "The governing body defines and approves the process of authority delegation.", activityType: 'DOC' },
          { id: 'LD.1.5', code: 'LD.1.5', text: "The governing body appoints a qualified director responsible for managing the dental center.", activityType: 'PER' }
        ]
      },
      {
        id: 'LD.2', code: 'LD.2',
        title: "The governing body approves and evaluates the center's quality and patient safety program, and risk management initiatives.",
        intent: 'The governing body ensures patient and staff safety by approving quality and patient safety programs, receiving quarterly reports, and recommending documented corrective actions.',
        substandards: [
          { id: 'LD.2.1', code: 'LD.2.1', text: "The governing body annually approves the quality and patient safety program, including the risk management initiatives.", activityType: 'DOC' },
          { id: 'LD.2.2', code: 'LD.2.2', text: "The governing body receives and evaluates the quality and patient safety reports, including the risk management, corrective actions, and outcomes from the center, at least quarterly.", activityType: 'DOC' },
          { id: 'LD.2.3', code: 'LD.2.3', text: "Recommended corrective actions by the governance are documented and received by the center director for implementation.", activityType: 'DOC' }
        ]
      },
      {
        id: 'LD.3', code: 'LD.3',
        title: 'The center has a defined, current, and clear organizational chart.',
        intent: 'Effective management requires clear reporting lines. The organizational chart shows relationships between governance and staff, updated regularly and communicated to all.',
        substandards: [
          { id: 'LD.3.1', code: 'LD.3.1', text: "An approved and updated organizational chart identifies the relationships between the center's governance, leadership, and other directors with titles.", activityType: 'DOC' },
          { id: 'LD.3.2', code: 'LD.3.2', text: "The staff are aware of the organizational chart and its intent, and can demonstrate their relationship to it.", activityType: 'INT' }
        ]
      },
      {
        id: 'LD.4', code: 'LD.4',
        title: 'The dental center is effectively managed by a qualified director.',
        intent: 'The center is managed by a qualified director responsible for mission/vision, compliance with laws, adequate resources, and a safe facility environment.',
        substandards: [
          { id: 'LD.4.1', code: 'LD.4.1', text: "The center director, with other leaders, develops the mission, vision, and values statements, and communicates them to all staff.", activityType: 'INT' },
          { id: 'LD.4.2', code: 'LD.4.2', text: "The center director ensures the center's compliance with all relevant laws, regulations, and policies.", activityType: 'INT' },
          { id: 'LD.4.3', code: 'LD.4.3', text: "The center's director ensures the availability of adequate and proper resources for the planned services in accordance with the approved operating budget.", activityType: 'INT' },
          { id: 'LD.4.4', code: 'LD.4.4', text: "The center's director ensures a safe and functional facility environment for patients, families, and staff.", activityType: 'OBS' }
        ]
      },
      {
        id: 'LD.5', code: 'LD.5',
        title: "The dental center has a clear scope of services based on community needs.",
        intent: 'The center functions according to a predefined scope of services including clinical services, professional coverage levels, clinic numbers, age groups, and working hours.',
        substandards: [
          { id: 'LD.5.1', code: 'LD.5.1', text: "The scope of services includes the specialty services available, the number of clinics for each specialty, the level of professional coverage for the age group served, and working hours.", activityType: 'DOC' },
          { id: 'LD.5.2', code: 'LD.5.2', text: "The scope of service is available to the public.", activityType: 'OBS' }
        ]
      },
      {
        id: 'LD.6', code: 'LD.6',
        title: "The leaders work collaboratively to develop the center's strategic plan.",
        intent: 'Strategic planning (3-5 years) addresses clinical and non-clinical services based on SWOT/PEST analysis with clear goals and objectives to achieve the mission.',
        substandards: [
          { id: 'LD.6.1', code: 'LD.6.1', text: "The strategic plan is guided by the mission, vision, and inputs from patients/service users, their families, staff, and where possible the wider community.", activityType: 'DOC' },
          { id: 'LD.6.2', code: 'LD.6.2', text: "The strategic plan is based on a comprehensive evaluation of both internal and external environmental factors.", activityType: 'DOC' },
          { id: 'LD.6.3', code: 'LD.6.3', text: "The strategic plan addresses all clinical and non-clinical services and programs.", activityType: 'DOC' },
          { id: 'LD.6.4', code: 'LD.6.4', text: "The strategic plan spans a period of three to five years and is reviewed regularly.", activityType: 'DOC' },
          { id: 'LD.6.5', code: 'LD.6.5', text: "The strategic plan includes the goals and objectives required to fulfill the center's mission.", activityType: 'DOC' }
        ]
      },
      {
        id: 'LD.7', code: 'LD.7',
        title: 'The leaders transform the approved strategic plan into an operational plan.',
        intent: 'The strategic plan converts to operational plans with assigned staff, evidence-based services, regular leadership meetings, and annual budgets for upgrades and maintenance.',
        substandards: [
          { id: 'LD.7.1', code: 'LD.7.1', text: "Leaders translate the center's goals and objectives into operational plans with defined projects, clearly delineated responsibilities, required resources, and time frames.", activityType: 'DOC' },
          { id: 'LD.7.2', code: 'LD.7.2', text: "Leaders communicate the plans to all staff.", activityType: 'INT' },
          { id: 'LD.7.3', code: 'LD.7.3', text: "Departmental directors develop annual departmental plans in alignment with the center's strategic plan.", activityType: 'DOC' },
          { id: 'LD.7.4', code: 'LD.7.4', text: "The leaders ensure the use of evidence-based and best practice information to develop and improve the center's services.", activityType: 'INT' },
          { id: 'LD.7.5', code: 'LD.7.5', text: "The leaders plan and budget for the upgrade or maintenance of buildings, equipment, and other resources.", activityType: 'DOC' },
          { id: 'LD.7.6', code: 'LD.7.6', text: "The leaders meet regularly to review the key performance indicators of services, surveys, audits, and feedback, and use the collected data to improve the center's operations.", activityType: 'DOC' }
        ]
      },
      {
        id: 'LD.8', code: 'LD.8',
        title: "The center's leaders work collaboratively to develop and maintain a center-wide staffing plan.",
        intent: 'Leaders formulate a staffing plan based on scope of services, capacity, and working hours including number, type, qualifications, and roles of required staff.',
        substandards: [
          { id: 'LD.8.1', code: 'LD.8.1', text: "The staffing plan ensures that services meet the needs for safe patient care.", activityType: 'DOC' },
          { id: 'LD.8.2', code: 'LD.8.2', text: "The staffing plan defines the number, type, and credentials of required staff, and their roles.", activityType: 'DOC' },
          { id: 'LD.8.3', code: 'LD.8.3', text: "The center recruits and assigns appropriately qualified staff in accordance with the staffing plan and recruitment policy.", activityType: 'PER' },
          { id: 'LD.8.4', code: 'LD.8.4', text: "The staffing plan is updated annually, monitored to identify deficiencies, and actions for improvement implemented as required.", activityType: 'DOC' }
        ]
      },
      {
        id: 'LD.9', code: 'LD.9',
        title: 'All categories of staff have clearly written job descriptions.',
        intent: 'Each staff member has a job description outlining responsibilities, qualifications, skills, and experience; discussed, signed at hiring, and kept in personnel file.',
        substandards: [
          { id: 'LD.9.1', code: 'LD.9.1', text: "The job description outlines the knowledge, skills, and attitude necessary to perform the job responsibilities for the specified position.", activityType: 'PER' },
          { id: 'LD.9.2', code: 'LD.9.2', text: "The job description clearly defines the roles and responsibilities for the position.", activityType: 'PER' },
          { id: 'LD.9.3', code: 'LD.9.3', text: "Job responsibilities and clinical work assignments are based on the evaluation of staff credentials.", activityType: 'PER' },
          { id: 'LD.9.4', code: 'LD.9.4', text: "The job description is discussed with and signed by the employee upon hiring and is located in his/her personnel file.", activityType: 'PER' }
        ]
      },
      {
        id: 'LD.10', code: 'LD.10',
        title: 'There is a process in place for credentialing and re-credentialing all healthcare providers.',
        intent: 'Credentialing applies to all clinical staff; involves collecting, verifying, and evaluating credentials upon employment and every two years thereafter.',
        substandards: [
          { id: 'LD.10.1', code: 'LD.10.1', text: "The credentialing process applies to all dental staff, dental assistants, and other clinical staff licensed to provide patient care on a full-time, part-time, or visiting basis.", activityType: 'PER' },
          { id: 'LD.10.2', code: 'LD.10.2', text: "The credentialing process includes gathering, verifying, and evaluating staff credentials including licenses, educational certificates, training certification, and evidence of experience.", activityType: 'PER' },
          { id: 'LD.10.3', code: 'LD.10.3', text: "Credentials are verified from the original source directly or through a third party with documented evidence.", activityType: 'PER' },
          { id: 'LD.10.4', code: 'LD.10.4', text: "The center ensures the registration of healthcare professionals with the Saudi Commission for Health Specialties and licensing by the Ministry of Health (MOH) in accordance with the national laws and regulations.", activityType: 'PER' }
        ]
      },
      {
        id: 'LD.11', code: 'LD.11',
        title: 'All dentists have current delineated clinical privileges.',
        intent: 'Privileging allows dentists to perform procedures for which they are qualified. Privileges are reviewed every two years based on competence and available services.',
        substandards: [
          { id: 'LD.11.1', code: 'LD.11.1', text: "The center has a policy and procedure for granting privileges to its dental staff.", activityType: 'DOC' },
          { id: 'LD.11.2', code: 'LD.11.2', text: "Clinical privileges are determined based on the dentist's current competence, the center's privileging policy, and the available services.", activityType: 'DOC' },
          { id: 'LD.11.3', code: 'LD.11.3', text: "The dental staff's clinical privileges are recommended by the dental center director and approved by the governing body, either directly or by appropriate delegation.", activityType: 'PER' },
          { id: 'LD.11.4', code: 'LD.11.4', text: "The clinical privileges are reviewed and updated every two years or earlier if needed.", activityType: 'PER' }
        ]
      },
      {
        id: 'LD.12', code: 'LD.12',
        title: 'All new employees attend a mandatory orientation program.',
        intent: 'All new employees are oriented to the center\'s mission, vision, values, structure, rights, safety, infection control, and quality programs, plus departmental orientation.',
        substandards: [
          { id: 'LD.12.1', code: 'LD.12.1', text: "The general orientation program for newly hired staff includes information about the center's mission, vision, values, organizational structure, patient and family rights, safety and security, infection control, and quality, patient safety, and risk management programs.", activityType: 'PER' },
          { id: 'LD.12.2', code: 'LD.12.2', text: "Each new employee attends a departmental-specific orientation program that assists him/her in properly executing the specific job responsibilities as outlined in the job description.", activityType: 'PER' }
        ]
      },
      {
        id: 'LD.15', code: 'LD.15',
        title: 'The leaders develop an effective process to evaluate staff performance at least annually.',
        substandards: [
          { id: 'LD.15.1', code: 'LD.15.1', text: "The performance evaluation is based on objective criteria targeting staff knowledge, skills, and attitude.", activityType: 'PER' },
          { id: 'LD.15.2', code: 'LD.15.2', text: "The evaluation is conducted at the end of the initial probationary period and at least annually thereafter.", activityType: 'PER' },
          { id: 'LD.15.3', code: 'LD.15.3', text: "Evaluations include personal goals that the staff will aim to achieve over the next year.", activityType: 'PER' },
          { id: 'LD.15.4', code: 'LD.15.4', text: "Staff are involved in the evaluation of their performance by signing the evaluation and commenting on the required corrective actions.", activityType: 'PER' },
          { id: 'LD.15.5', code: 'LD.15.5', text: "Information about staff credentials, privileges, competencies, orientation, training, education, and evaluation are securely kept in an updated personnel file.", activityType: 'PER' }
        ]
      },
      {
        id: 'LD.16', code: 'LD.16',
        title: 'The center implements a comprehensive program to protect the health and safety of staff.',
        substandards: [
          { id: 'LD.16.1', code: 'LD.16.1', text: "The staff health and safety program covers all employees and is consistent with relevant laws and regulations.", activityType: 'DOC' },
          { id: 'LD.16.2', code: 'LD.16.2', text: "The staff health and safety program is based on the protection of staff from occupational health and safety hazards, and workplace violence.", activityType: 'DOC' },
          { id: 'LD.16.3', code: 'LD.16.3', text: "The patient health and safety program is coordinated with the center's quality, safety, risk management, and infection control programs, including health screening, immunizations, and post-exposure management.", activityType: 'INT' },
          { id: 'LD.16.4', code: 'LD.16.4', text: "Staff have confidential and secured medical records that reflect their health status.", activityType: 'PER' }
        ]
      },
      {
        id: 'LD.17', code: 'LD.17',
        title: "The leaders develop ethical standards to guide patients' care and employees' code of conduct.",
        substandards: [
          { id: 'LD.17.1', code: 'LD.17.1', text: "Marketing for staff and services, if performed, is carried out ethically as per the laws and regulations.", activityType: 'OBS' },
          { id: 'LD.17.2', code: 'LD.17.2', text: "The leaders develop a set of values and a professional code of conduct for all employees.", activityType: 'DOC' },
          { id: 'LD.17.3', code: 'LD.17.3', text: "The leaders ensure that patients and their families are fully informed and protected when they are involved in clinical research projects.", activityType: 'DEN' },
          { id: 'LD.17.4', code: 'LD.17.4', text: "The leaders develop a process to monitor and resolve critical shortages, patient and non-patient related, in a reasonable timeframe as determined by the center.", activityType: 'DOC' }
        ]
      }
    ];

    // ============================================
    // DATA: Leadership Domain - Surveyor 2 (LD.13, LD.14, LD.18-LD.29)
    // ============================================
    const leadershipStandards_A2 = [
      {
        id: 'LD.13', code: 'LD.13',
        title: 'There is a policy that ensures dental assistants and other healthcare staff are competent in specific procedures and operating equipment.',
        intent: 'To ensure patient safety, staff must be tested when initially hired and annually on their competency in certain procedures according to their scope of work.',
        substandards: [
          { id: 'LD.13.1', code: 'LD.13.1', text: "The policy contains a list of all procedures requiring competency assessment.", activityType: 'DOC' },
          { id: 'LD.13.2', code: 'LD.13.2', text: "All staff are tested upon hiring and annually for the required competencies.", activityType: 'PER' },
          { id: 'LD.13.3', code: 'LD.13.3', text: "The policy is in place to ensure staff are trained on the safe operation of current and newly introduced equipment and devices.", activityType: 'DOC' },
          { id: 'LD.13.4', code: 'LD.13.4', text: "Only properly trained and competent staff are allowed to use specialized equipment and medical devices.", activityType: 'INT' }
        ]
      },
      {
        id: 'LD.14', code: 'LD.14',
        title: 'There is a program for continuing education and training of all categories of staff.',
        intent: 'Staff professional development is crucial to improving services. The center should provide regularly scheduled educational programs addressing quality, patient safety, risk management, and infection control.',
        substandards: [
          { id: 'LD.14.1', code: 'LD.14.1', text: "The center has a regularly scheduled educational and training program based on the center and staff needs including quality, patient safety, risk management, and infection control practices.", activityType: 'DOC' },
          { id: 'LD.14.2', code: 'LD.14.2', text: "The leaders encourage and compensate staff to attend educational and training activities relevant to the center's scope of services and in line with the national labor law.", activityType: 'INT' },
          { id: 'LD.14.3', code: 'LD.14.3', text: "All staff members who provide direct patient care maintain a valid certificate on basic life support (BLS).", activityType: 'PER' },
          { id: 'LD.14.4', code: 'LD.14.4', text: "Information about staff credentials, privileges, competencies, orientation, training, education, and evaluation are securely kept in an updated personnel file.", activityType: 'PER' }
        ]
      },
      {
        id: 'LD.18', code: 'LD.18',
        title: "The leaders support and protect the patient and family's rights.",
        intent: 'Patient and family rights are paramount for ethical and safe care. Leaders should develop policies for patient rights, ensure staff are trained, and patients are treated with dignity.',
        substandards: [
          { id: 'LD.18.1', code: 'LD.18.1', text: "The leaders develop and maintain a patient rights and responsibilities statement and develop processes that support their implementation.", activityType: 'INT' },
          { id: 'LD.18.2', code: 'LD.18.2', text: "The leaders ensure that written documentation of patient rights and responsibilities is available to patients and families and ensure patients are informed about their rights and responsibilities in a manner they can understand.", activityType: 'OBS' },
          { id: 'LD.18.3', code: 'LD.18.3', text: "The leaders ensure that patients' dignity, privacy, and confidentiality are respected.", activityType: 'OBS' },
          { id: 'LD.18.4', code: 'LD.18.4', text: "The health team provides care and services that are respectful of the patient's values and beliefs.", activityType: 'DOC' },
          { id: 'LD.18.5', code: 'LD.18.5', text: "Vulnerable patients are identified and protected from additional risks.", activityType: 'INT' },
          { id: 'LD.18.6', code: 'LD.18.6', text: "The leaders ensure that staff are provided with training and education on patient and family rights and responsibilities.", activityType: 'INT' },
          { id: 'LD.18.7', code: 'LD.18.7', text: "The leaders ensure that patients and their families have the right to be involved in their own care and treatment, including the right to refuse treatment or request a second opinion.", activityType: 'INT' }
        ]
      },
      {
        id: 'LD.19', code: 'LD.19',
        title: "The leaders develop and implement a policy and procedure to describe the patients' right to voice their complaints, concerns, and suggestions.",
        intent: 'The center should have well-defined policy for collecting patient feedback and resolving complaints within specified timeframes, with findings incorporated into quality and safety programs.',
        substandards: [
          { id: 'LD.19.1', code: 'LD.19.1', text: "Patients' complaints are resolved within the time frame described in the policy.", activityType: 'DOC' },
          { id: 'LD.19.2', code: 'LD.19.2', text: "The center assigns a staff member to be responsible for managing complaints.", activityType: 'PER' },
          { id: 'LD.19.3', code: 'LD.19.3', text: "Patient satisfaction surveys are conducted regularly.", activityType: 'DOC' },
          { id: 'LD.19.4', code: 'LD.19.4', text: "Data collected from surveys, complaints, and suggestions are analyzed and trended, with the information collected used for improvement and integrated into the quality and safety program.", activityType: 'DOC' }
        ]
      },
      {
        id: 'LD.20', code: 'LD.20',
        title: "Patients and their families have the right to accurate billing for provided services.",
        intent: 'The center ensures dental treatments adhere to a displayed pricing list and that receipts are issued, including for insured patients.',
        substandards: [
          { id: 'LD.20.1', code: 'LD.20.1', text: "The leaders ensure the availability of a price list for services provided to patients and their sponsors.", activityType: 'OBS' },
          { id: 'LD.20.2', code: 'LD.20.2', text: "The patients and their families have the right to receive an initial estimated cost of required services.", activityType: 'INT' },
          { id: 'LD.20.3', code: 'LD.20.3', text: "The patients and their families have the right to obtain an invoice for services rendered.", activityType: 'INT' }
        ]
      },
      {
        id: 'LD.21', code: 'LD.21',
        title: "The center provides assistance to patients with special needs.",
        intent: 'The center should take into account requirements for enabling access for patients with special needs including designated parking, accessible entrances, elevators, ramps, and restrooms.',
        substandards: [
          { id: 'LD.21.1', code: 'LD.21.1', text: "Street parking and drop-off points dedicated to patients with special needs are available near the center's entrance.", activityType: 'OBS' },
          { id: 'LD.21.2', code: 'LD.21.2', text: "The center's entrance, elevators, and toilets allow wheelchair access.", activityType: 'OBS' },
          { id: 'LD.21.3', code: 'LD.21.3', text: "Staircases have handrails.", activityType: 'OBS' },
          { id: 'LD.21.4', code: 'LD.21.4', text: "Elevated areas have ramps.", activityType: 'OBS' }
        ]
      },
      {
        id: 'LD.22', code: 'LD.22',
        title: "The center has a policy and procedure for controlling the development and maintenance of key documents.",
        intent: 'Key documents should have standardized structure with unique identifiers, dates, and be reviewed and approved by authorized individuals with a system ensuring only current versions circulate.',
        substandards: [
          { id: 'LD.22.1', code: 'LD.22.1', text: "The center maintains a unique identifier for each key document, with title, number, date of issue, and date of revision.", activityType: 'DOC' },
          { id: 'LD.22.2', code: 'LD.22.2', text: "Key documents are developed, approved, revised, and terminated by authorized individuals.", activityType: 'DOC' },
          { id: 'LD.22.3', code: 'LD.22.3', text: "Key documents are communicated to relevant staff and are always accessible.", activityType: 'INT' },
          { id: 'LD.22.4', code: 'LD.22.4', text: "A process is in place to ensure that key documents are always implemented.", activityType: 'INT' }
        ]
      },
      {
        id: 'LD.23', code: 'LD.23',
        title: "The center collaboratively develops a comprehensive quality improvement and patient safety program.",
        intent: 'The center should ensure quality of services through a quality management and patient safety program utilizing key performance indicators and evidence-based improvement approaches.',
        substandards: [
          { id: 'LD.23.1', code: 'LD.23.1', text: "The quality improvement and safety program utilize key performance indicators, and patient and staff surveys to measure performance and improve clinical and managerial areas.", activityType: 'DOC' },
          { id: 'LD.23.2', code: 'LD.23.2', text: "The information generated from key performance indicators is readily accessible on a timely basis to those responsible for and/or involved in the delivery of the center's services, and is utilized for making improvements and supporting the leaders' decision-making.", activityType: 'INT' },
          { id: 'LD.23.3', code: 'LD.23.3', text: "The center implements at least one improvement project per year utilizing an evidence-based quality improvement method such as 'FOCUS PDCA'.", activityType: 'DOC' },
          { id: 'LD.23.4', code: 'LD.23.4', text: "The center leaders assess and support the patient safety culture in the center.", activityType: 'INT' }
        ]
      },
      {
        id: 'LD.24', code: 'LD.24',
        title: "The center prioritizes and selects a set of relevant indicators that focus on the structure, process, and outcome of the dental and non-dental services provided.",
        intent: 'Key performance indicators should follow an evidence-based approach covering structure, process, and outcome. Information should be presented to staff and used for benchmarking.',
        substandards: [
          { id: 'LD.24.1', code: 'LD.24.1', text: "The selection process of performance indicators is based on the center's most important processes and priorities.", activityType: 'INT' },
          { id: 'LD.24.2', code: 'LD.24.2', text: "Each indicator has an operational definition, defined numerator and denominator, data collection method and frequency, a mathematical expression such as ratio or percentage, and a desirable target.", activityType: 'DOC' },
          { id: 'LD.24.3', code: 'LD.24.3', text: "The indicators are collected, validated, and analyzed by staff with appropriate knowledge and skills.", activityType: 'PER' },
          { id: 'LD.24.4', code: 'LD.24.4', text: "The performance monitoring results are discussed with staff, utilized in their evaluation, and reported regularly to the governance together with the action plans taken for improvement.", activityType: 'DOC' },
          { id: 'LD.24.5', code: 'LD.24.5', text: "The indicators are compared internally by historical trends and externally by benchmarking to other similar centers when available.", activityType: 'DOC' }
        ]
      },
      {
        id: 'LD.25', code: 'LD.25',
        title: "The center develops and implements a comprehensive risk management program.",
        intent: 'The risk management program should cover clinical, managerial, and financial aspects with both reactive incident reporting and proactive approaches like FMEA.',
        substandards: [
          { id: 'LD.25.1', code: 'LD.25.1', text: "The risk management program addresses clinical, managerial, and financial risks.", activityType: 'DOC' },
          { id: 'LD.25.2', code: 'LD.25.2', text: "The reporting of incidents, variances, and claims constitutes the program's essential reactive arm.", activityType: 'INT' },
          { id: 'LD.25.3', code: 'LD.25.3', text: "The center develops and implements at least one proactive risk reduction approach per year.", activityType: 'DOC' },
          { id: 'LD.25.4', code: 'LD.25.4', text: "The center develops and periodically updates a risk register for all potential clinical, managerial, and financial processes in the center.", activityType: 'DOC' },
          { id: 'LD.25.5', code: 'LD.25.5', text: "The center utilizes an evidence-based process for grading risks based on severity, frequency, and likelihood of occurrence.", activityType: 'DOC' },
          { id: 'LD.25.6', code: 'LD.25.6', text: "Information from the risk management program, including incidents, analysis, and improvement projects, is communicated to staff and the governing body at least quarterly.", activityType: 'INT' }
        ]
      },
      {
        id: 'LD.26', code: 'LD.26',
        title: "The center implements an incident reporting policy.",
        intent: 'The center should develop an incident reporting policy with unified reporting mechanism for all occurrences, variances, accidents, and near misses.',
        substandards: [
          { id: 'LD.26.1', code: 'LD.26.1', text: "The incident report policy outlines the types of incidents to be reported internally and to relevant regulatory authorities, the time frame, and the mechanism for reporting.", activityType: 'DOC' },
          { id: 'LD.26.2', code: 'LD.26.2', text: "Sentinel events and major incidents are reported, investigated, and the findings are utilized to prevent their recurrence.", activityType: 'INT' },
          { id: 'LD.26.3', code: 'LD.26.3', text: "Incidences involving patients are documented in the dental record, and patients and families are informed by the physician/dentist of any investigation results.", activityType: 'DEN' },
          { id: 'LD.26.4', code: 'LD.26.4', text: "The center compiles a report on incidences according to type and severity, and an action plan to prevent its recurrence is distributed to staff and governance on a regular basis.", activityType: 'DOC' }
        ]
      },
      {
        id: 'LD.27', code: 'LD.27',
        title: "The center has a program to select and monitor clinical and operational contracts.",
        intent: 'Process owners should closely monitor contracted services implementation with agreed-upon indicators. Contract renewal should be based on monitoring findings.',
        substandards: [
          { id: 'LD.27.1', code: 'LD.27.1', text: "Contracted entities are selected based on evidence-based criteria that the relevant department develops.", activityType: 'DOC' },
          { id: 'LD.27.2', code: 'LD.27.2', text: "The center director ensures relevant leaders' recommendations and approval on contracts.", activityType: 'DOC' },
          { id: 'LD.27.3', code: 'LD.27.3', text: "The leaders ensure that the contracting entity and services provided meet applicable laws and regulations.", activityType: 'INT' },
          { id: 'LD.27.4', code: 'LD.27.4', text: "When radiology services are provided through a contract; the center is responsible to provide oversight of the contract.", activityType: 'DOC' },
          { id: 'LD.27.5', code: 'LD.27.5', text: "The leaders ensure that the services provided are integrated into the overall quality and patient safety program.", activityType: 'INT' },
          { id: 'LD.27.6', code: 'LD.27.6', text: "The leaders regularly monitor and document the compliance of contracted services with the appropriate standards and take documented corrective actions for improvement when standards are not met.", activityType: 'INT' }
        ]
      },
      {
        id: 'LD.28', code: 'LD.28',
        title: "The leaders implement policies and procedures to guide efficient procurement of equipment, either purchased or donated, medications, and medical consumables following national laws and regulations.",
        intent: 'Leaders should develop a procurement policy to ensure purchase of nationally approved medical equipment, medications, and supplies with proper SFDA compliance.',
        substandards: [
          { id: 'LD.28.1', code: 'LD.28.1', text: "The leaders ensure that contractors and suppliers of devices and consumables have a Medical Device Establishment License (MDEL).", activityType: 'DOC' },
          { id: 'LD.28.2', code: 'LD.28.2', text: "Leaders ensure that all newly purchased devices have a Medical Device Marketing Authorization (MDMA) certificate.", activityType: 'DOC' },
          { id: 'LD.28.3', code: 'LD.28.3', text: "Leaders approve newly introduced consumables based on a formal testing and feedback process from end-users.", activityType: 'INT' }
        ]
      },
      {
        id: 'LD.29', code: 'LD.29',
        title: "The center maintains an aesthetic appeal.",
        intent: 'Patients\' confidence starts from first impression. The center should maintain cleanliness with temperatures between 20-24.4C per OSHA standards.',
        substandards: [
          { id: 'LD.29.1', code: 'LD.29.1', text: "The center is clean and tidy.", activityType: 'OBS' },
          { id: 'LD.29.2', code: 'LD.29.2', text: "The center is free of broken furniture, scratched, and damaged walls and floors.", activityType: 'OBS' },
          { id: 'LD.29.3', code: 'LD.29.3', text: "The center maintains an ambient temperature between 20 - 24.4 Celsius.", activityType: 'OBS' }
        ]
      }
    ];

    // Management of Information (MOI) Standards - Surveyor 2
    const moiStandards = [
      {
        id: 'MOI.1', code: 'MOI.1',
        title: 'The center defines, in a policy, the information that may be shared among the staff internally and with other external entities, and its format.',
        intent: 'Communication facilitates a free flow of information and mandates in healthcare, identifying and organizing this flow of information. Both inside the organization and with various customers, helps to enhance communication and eliminate communication errors. All stakeholders should clearly develop a management of information plan that outlines the process of managing the patients\' information.',
        substandards: [
          { id: 'MOI.1.1', code: 'MOI.1.1', text: 'The policy highlights how patient demographics and medical/dental information are shared among dental and administrative staff including paper format, electronic, or a combination.', activityType: 'DOC' },
          { id: 'MOI.1.2', code: 'MOI.1.2', text: 'The policy identifies how the information is disseminated from leaders to staff and vice versa.', activityType: 'INT' },
          { id: 'MOI.1.3', code: 'MOI.1.3', text: 'The policy defines what information is required by the relevant external authorities, and the frequency of reporting.', activityType: 'DOC' },
          { id: 'MOI.1.4', code: 'MOI.1.4', text: 'The policy highlights the patients\' personal and dental information required to refer a patient to a higher center.', activityType: 'DOC' },
          { id: 'MOI.1.5', code: 'MOI.1.5', text: 'The policy identifies the staff security levels required to access patient information.', activityType: 'DOC' },
          { id: 'MOI.1.6', code: 'MOI.1.6', text: 'The policy identifies how each type of information is secured and safely stored.', activityType: 'DOC' },
          { id: 'MOI.1.7', code: 'MOI.1.7', text: 'The policy highlights how long the center needs to retain the various types of information in accordance with the applicable national rules and regulations.', activityType: 'DOC' }
        ]
      },
      {
        id: 'MOI.2', code: 'MOI.2',
        title: 'All patients seen in the center have unique dental record files.',
        intent: 'To ensure continuity of care, each patient cared for at the center must have his or her own dental record that has a unique dental record number. The dental record shall contain all of the elements identified in MOI.2.2 and MOI.2.3.',
        substandards: [
          { id: 'MOI.2.1', code: 'MOI.2.1', text: 'The contents of the dental record are arranged according to a standardized process.', activityType: 'OBS' },
          { id: 'MOI.2.2', code: 'MOI.2.2', text: 'Dental record files contain the required patient demographics including national identification number, contact information, emergency contacts, and insurance history.', activityType: 'DEN' },
          { id: 'MOI.2.3', code: 'MOI.2.3', text: 'Medical/dental record files contain sufficient updated medical information to safely manage the patient and promote continuity of care including history, physical examination, plan of care, investigations, consultations, observations, consents, procedure/surgery reports, medications, allergies, and prior adverse reactions.', activityType: 'DEN' }
        ]
      },
      {
        id: 'MOI.3', code: 'MOI.3',
        title: 'The center has a policy for making entries in dental record files.',
        intent: 'Uniformity of medical/dental records enhances better documentation and results implementation of written instructions. A policy should be developed and implemented based on the elements identified in MOI.3.1 through MOI.3.6. Abbreviations and symbols used may be referenced differently by different individuals throughout the policy/survey, thus inadvertently changing the intended care plans.',
        substandards: [
          { id: 'MOI.3.1', code: 'MOI.3.1', text: 'The dental file documentation policy identifies the category of staff allowed to write in the dental record.', activityType: 'DOC' },
          { id: 'MOI.3.2', code: 'MOI.3.2', text: 'All entries in the patient file are legible, dated, timed, and signed by the author.', activityType: 'DEN' },
          { id: 'MOI.3.3', code: 'MOI.3.3', text: 'There is a uniform entry of data in dental records, whereby orders are written separately from assessments, care plans, and progress notes.', activityType: 'DEN' },
          { id: 'MOI.3.4', code: 'MOI.3.4', text: 'Entries written in error are not deleted or erased. Instead, a single line is passed through the error text and dated, timed, and signed by the author, or the system allows for electronic amendment tracing.', activityType: 'DEN' },
          { id: 'MOI.3.5', code: 'MOI.3.5', text: 'Only standardized and approved abbreviations and symbols are used in dental records.', activityType: 'DEN' },
          { id: 'MOI.3.6', code: 'MOI.3.6', text: 'The center uses diagnosis codes and procedure codes including international classification of diseases (ICD) or current procedural terminology (CPT) consistent with the requirements of relevant authorities.', activityType: 'DEN' }
        ]
      },
      {
        id: 'MOI.4', code: 'MOI.4',
        title: 'The center has a process for completing the patient dental record files.',
        intent: 'At the end of a patient\'s visit, the dental record should be returned to the dental records store. This keeps the dental records safe, secure, and in good order. Upon its receipt in the store, the dental record should be checked for completeness according to a written process that includes complete demographics, clinical information, and authentication.',
        substandards: [
          { id: 'MOI.4.1', code: 'MOI.4.1', text: 'Regular checks are made on returned files to ensure completion. The check includes but is not limited to demographics, medical information, and authentication.', activityType: 'INT' },
          { id: 'MOI.4.2', code: 'MOI.4.2', text: 'Incomplete files are separated from completed ones in the records storage area and are completed in a time frame defined by the organization.', activityType: 'OBS' },
          { id: 'MOI.4.3', code: 'MOI.4.3', text: 'The center keeps a record of the percentage of incomplete records over time and uses this information to improve staff compliance with record completion.', activityType: 'INT' }
        ]
      },
      {
        id: 'MOI.5', code: 'MOI.5',
        title: 'The center develops a policy and procedure for the use of information technology.',
        intent: 'Despite advances in information resources, many centers still face databases, networks, and software disasters, waiting short periods or shutting down work for days. To maintain the confidentiality and comprehensiveness of data, an adequate data capturing process along appropriate software is critical. A standard manual system must be available for use during the downtime period and include both managerial and clinical activities.',
        substandards: [
          { id: 'MOI.5.1', code: 'MOI.5.1', text: 'The policy and procedure for the use of information technology highlight how the generated information is stored and regularly backed up.', activityType: 'DOC' },
          { id: 'MOI.5.2', code: 'MOI.5.2', text: 'The information technology policy and procedure describe the manual procedures required to execute the various activities in the event of system failure, maintenance, or repair.', activityType: 'DOC' },
          { id: 'MOI.5.3', code: 'MOI.5.3', text: 'Staff can demonstrate the manual procedure for the downtime regulation of data generated by information technology.', activityType: 'INT' }
        ]
      },
      {
        id: 'MOI.6', code: 'MOI.6',
        title: 'The center implements an effective clinical documentation improvement (CDI) program.',
        intent: 'Clinical documentation improvement (CDI) is implemented in any healthcare organization. CDI ensures accurate reporting of diagnoses and procedures in the health authorities as per final regulations. The center has a developed policy and procedure that guides proper documentation to ensure to provide for healthcare leaders to have an holistic delivery of healthcare services.',
        substandards: [
          { id: 'MOI.6.1', code: 'MOI.6.1', text: 'The center develops a policy and procedure for the clinical documentation improvement program.', activityType: 'DOC' },
          { id: 'MOI.6.2', code: 'MOI.6.2', text: 'The center has at a minimum, a dentist and a dental assistant, who are properly trained in clinical documentation improvement.', activityType: 'PER' }
        ]
      }
    ];

    // Facility Management and Safety (FMS) Standards - Surveyor 2
    const fmsStandards = [
      {
        id: 'FMS.1', code: 'FMS.1',
        title: 'The center establishes and appoints a lead for managing environmental safety programs.',
        intent: 'Environmental safety requires leadership and coordination. The center must have designated staff responsible for managing all aspects of facility safety including emergency management, utility systems, hazardous materials, fire safety, medical equipment, building safety, security, and electrical safety.',
        substandards: [
          { id: 'FMS.1.1', code: 'FMS.1.1', text: 'The safety management program includes plans for emergency management, utility systems, hazardous materials, fire safety, medical equipment, building safety, security, and electrical safety.', activityType: 'DOC' },
          { id: 'FMS.1.2', code: 'FMS.1.2', text: 'The safety management program includes plans for orientation of new hires regarding safety, participation in training programs, and knowledge assessments.', activityType: 'PER' },
          { id: 'FMS.1.3', code: 'FMS.1.3', text: 'There are staff with dedicated roles and responsibilities set out for the safety management and safety programs.', activityType: 'PER' },
          { id: 'FMS.1.4', code: 'FMS.1.4', text: 'Staff undergo fire safety awareness and are able to understand their respective roles and obligations in prevention and response protocols.', activityType: 'PER' },
          { id: 'FMS.1.5', code: 'FMS.1.5', text: 'An SOP for alerting the center, fire services, and the relevant authorities in the event of fire that complies with any related local civil defence guidelines is developed.', activityType: 'DOC' }
        ]
      },
      {
        id: 'FMS.2', code: 'FMS.2',
        title: 'Identified safety risks are documented and used for the development and implementation of corrective actions and external audit activities to improve facility management.',
        intent: 'Risk documentation enables systematic improvement of facility safety through identification, tracking, and mitigation of hazards across all areas of the facility.',
        substandards: [
          { id: 'FMS.2.1', code: 'FMS.2.1', text: 'There is a fire risk assessment across all utility and all the other essential equipment or processes, to improve a facilities safe, clean environment.', activityType: 'DOC' },
          { id: 'FMS.2.2', code: 'FMS.2.2', text: 'Fire drills and safety assessments are carried out on an annual basis.', activityType: 'DOC' }
        ]
      },
      {
        id: 'FMS.3', code: 'FMS.3',
        title: 'The center\'s security program for protection of patients and personnel protects.',
        intent: 'A comprehensive security program ensures the safety of patients, staff, and visitors through proper equipment, monitoring, and fire prevention measures.',
        substandards: [
          { id: 'FMS.3.1', code: 'FMS.3.1', text: 'The security program is defined and has a focal point for coordination.', activityType: 'INT' },
          { id: 'FMS.3.2', code: 'FMS.3.2', text: 'Fire extinguishers are located and maintained at the site of services and support areas.', activityType: 'OBS' },
          { id: 'FMS.3.3', code: 'FMS.3.3', text: 'Fire sprinklers including fire alarms and fire prevention and smoke detectors equipment are properly functional.', activityType: 'OBS' },
          { id: 'FMS.3.4', code: 'FMS.3.4', text: 'The fire alarm system is maintained and tested, and all passive smoke containment elements are functional.', activityType: 'OBS' },
          { id: 'FMS.3.5', code: 'FMS.3.5', text: 'A "No Smoke" policy is imposed in work areas.', activityType: 'OBS' },
          { id: 'FMS.3.6', code: 'FMS.3.6', text: 'The "No Smoking" signs are posted at all entrance and waiting areas.', activityType: 'OBS' },
          { id: 'FMS.3.7', code: 'FMS.3.7', text: 'Fire equipment and related systems are tested and documented according to manufacturer specifications.', activityType: 'DOC' }
        ]
      },
      {
        id: 'FMS.4', code: 'FMS.4',
        title: 'The center is secure and designed for access.',
        intent: 'Proper access control and security measures protect patients, staff, and the facility while ensuring appropriate visitor management and flow separation.',
        substandards: [
          { id: 'FMS.4.1', code: 'FMS.4.1', text: 'Staff have an adequate security protocol defined for the safety of access to their areas, taking adequate precautions.', activityType: 'INT' },
          { id: 'FMS.4.2', code: 'FMS.4.2', text: 'Security measures for the security appropriate control and access for unauthorized buildings are seen.', activityType: 'INT' },
          { id: 'FMS.4.3', code: 'FMS.4.3', text: 'The visitor admission is tracked.', activityType: 'INT' },
          { id: 'FMS.4.4', code: 'FMS.4.4', text: 'The center is maintained and clean in a reasonable manner.', activityType: 'OBS' },
          { id: 'FMS.4.5', code: 'FMS.4.5', text: 'Patients and staff flow are separated into non-healthcare areas.', activityType: 'OBS' },
          { id: 'FMS.4.6', code: 'FMS.4.6', text: 'An exit door and its clearance-way is in place.', activityType: 'OBS' }
        ]
      },
      {
        id: 'FMS.5', code: 'FMS.5',
        title: 'The center has a written plan for the proper maintenance, inspection, testing, and safe operation of medical equipment.',
        intent: 'Medical equipment must be properly maintained, inspected, and tested to ensure patient safety and optimal performance. This includes acceptance testing, inventory management, and preventive maintenance programs.',
        substandards: [
          { id: 'FMS.5.1', code: 'FMS.5.1', text: 'Medical equipment in the center, including sterilizers, radiological equipment, or any functional equipment, is subjected to acceptance testing as per documented and established guidelines and or manufacturer specifications.', activityType: 'DOC' },
          { id: 'FMS.5.2', code: 'FMS.5.2', text: 'The list of equipment and medical equipment used in the facility is well validated, documented, and periodically revised.', activityType: 'DOC' },
          { id: 'FMS.5.3', code: 'FMS.5.3', text: 'Medical/dental equipment in an active inspection/maintenance program with test prompts and the final checklist for data documented.', activityType: 'DOC' },
          { id: 'FMS.5.4', code: 'FMS.5.4', text: 'All dental medical electrical equipment is labeled and the asset tagged via local acceptance.', activityType: 'OBS' },
          { id: 'FMS.5.5', code: 'FMS.5.5', text: 'Medical equipment needed to be installed in an area while completed, or failure events indicated is available at the facility of support element.', activityType: 'OBS' }
        ]
      },
      {
        id: 'FMS.6', code: 'FMS.6',
        title: 'The center has a program to ensure the reliability and safety of utility systems.',
        intent: 'Utility systems including electrical, water, ventilation, and medical gas systems must be reliably maintained to support patient care operations and ensure safety.',
        substandards: [
          { id: 'FMS.6.1', code: 'FMS.6.1', text: 'The center identifies and maintains an inventory of all utility systems.', activityType: 'DOC' },
          { id: 'FMS.6.2', code: 'FMS.6.2', text: 'Utility systems are inspected, tested, and maintained on a regular schedule.', activityType: 'DOC' },
          { id: 'FMS.6.3', code: 'FMS.6.3', text: 'Emergency power systems are tested regularly and maintained in operational condition.', activityType: 'OBS' },
          { id: 'FMS.6.4', code: 'FMS.6.4', text: 'Water quality is monitored and maintained according to applicable standards.', activityType: 'DOC' },
          { id: 'FMS.6.5', code: 'FMS.6.5', text: 'Ventilation systems are adequate for the facility requirements and regularly maintained.', activityType: 'OBS' },
          { id: 'FMS.6.6', code: 'FMS.6.6', text: 'Electrical systems are properly grounded and maintained for safety.', activityType: 'OBS' },
          { id: 'FMS.6.7', code: 'FMS.6.7', text: 'Staff are trained in utility system emergency procedures.', activityType: 'INT' },
          { id: 'FMS.6.8', code: 'FMS.6.8', text: 'Backup systems are in place for critical utilities.', activityType: 'OBS' },
          { id: 'FMS.6.9', code: 'FMS.6.9', text: 'Utility system failures are documented and analyzed for improvement.', activityType: 'DOC' },
          { id: 'FMS.6.10', code: 'FMS.6.10', text: 'The center has contingency plans for utility system failures.', activityType: 'DOC' }
        ]
      },
      {
        id: 'FMS.7', code: 'FMS.7',
        title: 'Fire safety and smoke monitoring plan for fire emergency.',
        intent: 'A comprehensive fire safety program ensures proper signage, evacuation routes, equipment functionality, and staff preparedness to respond to fire emergencies effectively.',
        substandards: [
          { id: 'FMS.7.1', code: 'FMS.7.1', text: 'Fire door signage and the lighting of all fire service equipment.', activityType: 'OBS' },
          { id: 'FMS.7.2', code: 'FMS.7.2', text: 'Fire emergency exits and evacuation plans and safety equipment for safety compliance.', activityType: 'DOC' },
          { id: 'FMS.7.3', code: 'FMS.7.3', text: 'The clear route plan on how to coordinate various locations where it will release to any emergency of designated evacuation.', activityType: 'OBS' },
          { id: 'FMS.7.4', code: 'FMS.7.4', text: 'Fire rescue has direct access and access to evacuation emergency areas.', activityType: 'OBS' },
          { id: 'FMS.7.5', code: 'FMS.7.5', text: 'Staff are familiar with the emergency and evacuation process.', activityType: 'INT' },
          { id: 'FMS.7.6', code: 'FMS.7.6', text: 'The fire emergency plan is reviewed annually.', activityType: 'DOC' },
          { id: 'FMS.7.7', code: 'FMS.7.7', text: 'The center has a policy to guide visitors during an emergency evacuation.', activityType: 'DOC' }
        ]
      },
      {
        id: 'FMS.8', code: 'FMS.8',
        title: 'The dental center develops a hazardous material (HAZMAT) and waste disposal plan.',
        intent: 'The center must protect its occupants from the effects of hazardous materials and waste. There should be a hazardous material plan in place that includes identifying and safely controlling hazardous materials and waste throughout the facility. A hazardous material is any solid, liquid, or gas that can harm people, other living organisms, property, or the environment.',
        substandards: [
          { id: 'FMS.8.1', code: 'FMS.8.1', text: 'The center keeps an updated register of all hazardous materials in the center, along with their "Safety Data Sheets".', activityType: 'DOC' },
          { id: 'FMS.8.2', code: 'FMS.8.2', text: 'Staff are trained in properly dealing with available hazardous materials and waste disposal.', activityType: 'INT' },
          { id: 'FMS.8.3', code: 'FMS.8.3', text: 'The center controls and reduces the risk associated with the use of hazardous materials and wastes.', activityType: 'OBS' },
          { id: 'FMS.8.4', code: 'FMS.8.4', text: 'Hazardous materials are stored, handled, transported, used, and disposed of as per the "Safety Data Sheets".', activityType: 'OBS' },
          { id: 'FMS.8.5', code: 'FMS.8.5', text: 'Waste disposal is conducted safely within the facility or through an authorized contractor.', activityType: 'OBS' },
          { id: 'FMS.8.6', code: 'FMS.8.6', text: 'Fire-rated cabinets are used for flammable hazardous materials.', activityType: 'OBS' }
        ]
      },
      {
        id: 'FMS.9', code: 'FMS.9',
        title: 'The center has a policy and procedure for the safe use of various types of compressed medical gasses.',
        intent: 'Compressed gas systems are a standard feature of most healthcare facilities, and they require special monitoring and maintenance to ensure their proper operation. The hazards associated with compressed gasses include oxygen displacement, explosion, toxicity, and the physical hazards of a ruptured cylinder. The center must develop and implement a policy for handling, storing, transporting, and disposing of various types of compressed gasses.',
        substandards: [
          { id: 'FMS.9.1', code: 'FMS.9.1', text: 'The medical gasses policy highlights the use of cylinder transporters.', activityType: 'DOC' },
          { id: 'FMS.9.2', code: 'FMS.9.2', text: 'The policy emphasizes secure storage of the cylinder(s) in well-ventilated areas.', activityType: 'OBS' },
          { id: 'FMS.9.3', code: 'FMS.9.3', text: 'The policy describes how to secure the cylinders by positioning them upright against a wall and securing it by either a chain or inside special containers.', activityType: 'DOC' },
          { id: 'FMS.9.4', code: 'FMS.9.4', text: 'The policy ensures the timely replacement of empty cylinders and the availability of a backup system.', activityType: 'DOC' },
          { id: 'FMS.9.5', code: 'FMS.9.5', text: 'Centers equipped with piped gas systems follow the regulatory body\'s testing and safety requirements.', activityType: 'OBS' }
        ]
      }
    ];

    // ============================================
    // DATA: Provision of Care (PC) - Surveyor 1
    // ============================================
    const provisionOfCareStandards = [
      {
        id: 'PC.3', code: 'PC.3',
        title: 'Patients are clinically assessed through an established assessment policy and procedure.',
        intent: 'Patient assessments ensure right diagnosis and appropriate care plans. All patients should undergo comprehensive history and physical examination with screening for nutritional needs, pain, and fall risk.',
        substandards: [
          { id: 'PC.3.1', code: 'PC.3.1', text: "The assessment policy recommends a multidisciplinary care approach, highlighting the scope and content of assessment by both general and specialty dentists, and other healthcare workers participating in the patient's care process.", activityType: 'DOC' },
          { id: 'PC.3.2', code: 'PC.3.2', text: "The assessment policy highlights the minimum assessment required by the dentist before treating the patient.", activityType: 'DOC' },
          { id: 'PC.3.3', code: 'PC.3.3', text: "The assessment policy ensures the availability of a comprehensive patient assessment including essential vital signs.", activityType: 'DEN' },
          { id: 'PC.3.4', code: 'PC.3.4', text: "The assessment policy highlights the required screening for nutritional needs.", activityType: 'DEN' },
          { id: 'PC.3.5', code: 'PC.3.5', text: "The assessment policy highlights the required sensitivity for the presence or absence of pain.", activityType: 'DEN' },
          { id: 'PC.3.6', code: 'PC.3.6', text: "The assessment policy highlights the required screening for fall risk and the measures used to reduce the risk of injury resulting from falls.", activityType: 'DEN' }
        ]
      },
      {
        id: 'PC.4', code: 'PC.4',
        title: 'The center provides the dentists with the results of investigations as per an agreed time frame.',
        intent: 'For effective treatment planning, dentists should receive investigation results in acceptable timeframes. A document specifying turnaround times for routine and urgent tests should be available.',
        substandards: [
          { id: 'PC.4.1', code: 'PC.4.1', text: "An agreement with an outsourced laboratory should include requirements for routine, non-critical, and for stat (urgent/critical) tests. Written time frame for routine and stat (urgent) investigations is developed collaboratively with the laboratory, radiology, and other services, on-site or outsourced.", activityType: 'DOC' },
          { id: 'PC.4.2', code: 'PC.4.2', text: "Personnel time is available for routine and stat (urgent) radiology and laboratory tests.", activityType: 'INT' }
        ]
      },
      {
        id: 'PC.6', code: 'PC.6',
        title: "The dentist develops a treatment plan to meet the patient's needs.",
        intent: 'A documented treatment plan is vital to managing a patient\'s condition. The plan should identify measurable goals and be reviewed during every visit based on the patient\'s response.',
        substandards: [
          { id: 'PC.6.1', code: 'PC.6.1', text: "The dentist develops treatment plans in collaboration within the assessment information and the development plan. This ensures that the plan meets the treatment goals that the patient care team has defined for the patient based on all of the assessment information and the patient's own preferences.", activityType: 'DEN' },
          { id: 'PC.6.2', code: 'PC.6.2', text: "The treatment plan is designed to achieve desired outcomes in reasonable goals.", activityType: 'DEN' },
          { id: 'PC.6.3', code: 'PC.6.3', text: "The treatment plan is reviewed every visit, based on the outcome measures and other significant changes in the patient's condition.", activityType: 'DEN' }
        ]
      },
      {
        id: 'PC.7', code: 'PC.7',
        title: 'The dentist records the dental procedures performed in the dental record.',
        intent: 'Complete documentation must be maintained for all dental procedures including procedure name, location, materials used, sedation/analgesia type and dose, procedure details, outcomes, and complications.',
        substandards: [
          { id: 'PC.7.1', code: 'PC.7.1', text: "Documentation contains the name of the procedures.", activityType: 'DEN' },
          { id: 'PC.7.2', code: 'PC.7.2', text: "The dental record highlights any material used in the procedure.", activityType: 'DEN' },
          { id: 'PC.7.3', code: 'PC.7.3', text: "The dental record contains the type of sedation or analgesia offered and its dose.", activityType: 'DEN' },
          { id: 'PC.7.4', code: 'PC.7.4', text: "The dentist reports the procedure details, outcome, and any complications.", activityType: 'DEN' }
        ]
      },
      {
        id: 'PC.8', code: 'PC.8',
        title: 'The dental center develops and monitors the implementation of evidence-based clinical practice guidelines.',
        intent: 'The center must adopt updated evidence-based guidelines for managing patients with chronic medical conditions that pose risk to dental procedures. Guidelines must be reviewed every two years.',
        substandards: [
          { id: 'PC.8.1', code: 'PC.8.1', text: "The center's clinical guidelines cover the management of patients with relevant medical conditions.", activityType: 'DOC' },
          { id: 'PC.8.2', code: 'PC.8.2', text: "The clinical guidelines cover the use of prophylactic antibiotics.", activityType: 'DOC' },
          { id: 'PC.8.3', code: 'PC.8.3', text: "The clinical guidelines are updated at least every two years and their implementation is monitored.", activityType: 'INT' }
        ]
      },
      {
        id: 'PC.11', code: 'PC.11',
        title: 'Dentists assist patients, and when appropriate their families, to fully participate in making informed decisions about their care, treatment, and procedures.',
        intent: 'Patient and family education is a cornerstone of successful treatment. Staff should ensure patients clearly understand their illness, treatment options, benefits, complications, and likelihood of success.',
        substandards: [
          { id: 'PC.11.1', code: 'PC.11.1', text: "Dentists provide patients and their families with formal and accurate information, in a manner they can understand, about their illness, options for treatment, expected treatment, potential benefits, potential complications, and the likelihood of successful results.", activityType: 'INT' },
          { id: 'PC.11.2', code: 'PC.11.2', text: "Patients' and families' education is based on their healthcare needs.", activityType: 'INT' },
          { id: 'PC.11.3', code: 'PC.11.3', text: "Patients are expected to discuss their plan of care with the dentist and have all their questions answered.", activityType: 'INT' },
          { id: 'PC.11.4', code: 'PC.11.4', text: "To assist the patient and family to give informed consent when surgery or a procedure is to be performed in the center, the patient and family receive information related to surgery and sedation by the dentist.", activityType: 'INT' },
          { id: 'PC.11.5', code: 'PC.11.5', text: "Patient and family education is evaluated for effectiveness through documenting teaching or re-teaching process/outcome.", activityType: 'DEN' }
        ]
      },
      {
        id: 'PC.12', code: 'PC.12',
        title: 'Informed consent is obtained from the patient or the guardian.',
        intent: 'Patients have the right to be fully aware of benefits, risks, complications, and consequences of refusing treatments. Consent is required before surgery, sedation, photographs, and research involvement.',
        substandards: [
          { id: 'PC.12.1', code: 'PC.12.1', text: "The center develops and implements policies that call for the procedure-specific informed consent, completely registered.", activityType: 'DOC' },
          { id: 'PC.12.2', code: 'PC.12.2', text: "Informed consent is obtained before surgery, invasive procedures, and the use of sedation.", activityType: 'DEN' },
          { id: 'PC.12.3', code: 'PC.12.3', text: "Informed consent is obtained before taking photographs of the oral cavity or face.", activityType: 'DEN' },
          { id: 'PC.12.4', code: 'PC.12.4', text: "Informed consent is obtained before involving the patient in a research project.", activityType: 'DOC' }
        ]
      },
      {
        id: 'PC.13', code: 'PC.13',
        title: 'The center develops a policy and procedure on safe medication management.',
        intent: 'Safe medication prescribing ensures accurate patient identification, allergy status documentation, proper pediatric weight identification, and no use of abbreviations. Adverse events must be reported.',
        substandards: [
          { id: 'PC.13.1', code: 'PC.13.1', text: "The medication management policy addresses the safe use of high-alert medications and look-alike sound-alike medications, and details interactions of multiple medications.", activityType: 'DOC' },
          { id: 'PC.13.2', code: 'PC.13.2', text: "Adverse drug reactions are documented in the dental records and reported to relevant authorities as per local regulations.", activityType: 'DEN' }
        ]
      },
      {
        id: 'PC.14', code: 'PC.14',
        title: 'The center provides appropriate storage for medications and dental materials.',
        intent: 'Medications lose potency if not stored properly. Environmental control (temperature, light, humidity) must be maintained. Inventory should include quantities and expiration dates following the FEFO concept.',
        substandards: [
          { id: 'PC.14.1', code: 'PC.14.1', text: "Medications and dental materials are stored in a secure manner as per the manufacturer's recommendations.", activityType: 'OBS' },
          { id: 'PC.14.2', code: 'PC.14.2', text: "Storage areas are clean and tidy.", activityType: 'OBS' },
          { id: 'PC.14.3', code: 'PC.14.3', text: "Stored items have an inventory with identified locations and expiration dates.", activityType: 'DOC' },
          { id: 'PC.14.4', code: 'PC.14.4', text: "Items are stored according to the first expired, first out (FEFO) concept.", activityType: 'OBS' },
          { id: 'PC.14.5', code: 'PC.14.5', text: "Storage refrigerators are dedicated to dental materials only.", activityType: 'OBS' }
        ]
      }
    ];

    // ============================================
    // DATA: Dental Laboratory (DL) - Surveyor 1
    // ============================================
    const dentalLaboratoryStandards = [
      {
        id: 'DL.1', code: 'DL.1',
        title: 'The center develops and implements policies and procedures to guide the dental laboratory services in accordance with applicable laws and regulations.',
        intent: 'The dental laboratory should handle patients\' dental requirements as determined by the treatment plan. Policies and procedures guide identification, handling, processing, transporting, and disposing of materials.',
        substandards: [
          { id: 'DL.1.1', code: 'DL.1.1', text: "The scope of work in the dental laboratory is aligned with the center's scope of service.", activityType: 'DOC' },
          { id: 'DL.1.2', code: 'DL.1.2', text: "Dental laboratory policies and procedures guide the process of identification, handling, processing, transporting, and disposing of dental materials and products.", activityType: 'DOC' },
          { id: 'DL.1.3', code: 'DL.1.3', text: "A licensed dental technician carries out dental laboratory services.", activityType: 'PER' },
          { id: 'DL.1.4', code: 'DL.1.4', text: "The laboratory implements a standardized process to improve the effectiveness of communication between laboratory technicians, dentists, and other caregivers.", activityType: 'INT' },
          { id: 'DL.1.5', code: 'DL.1.5', text: "The laboratory maintains a process for monitoring compliance with the policies and procedures through regular inspections, tracking, and analysis of the findings. This process is used to guide improvements.", activityType: 'INT' }
        ]
      },
      {
        id: 'DL.2', code: 'DL.2',
        title: 'The center develops a process for identifying patient-related dental prosthesis, impressions, and appliances.',
        intent: 'Ensuring right care to right patient is essential. Dental prosthesis, impressions, and appliances must be identified with at least 2 patient identifiers immediately after taking them.',
        substandards: [
          { id: 'DL.2.1', code: 'DL.2.1', text: "Dental impressions and biopsies are immediately identified after taking it.", activityType: 'OBS' },
          { id: 'DL.2.2', code: 'DL.2.2', text: "Dental appliances are identified.", activityType: 'OBS' },
          { id: 'DL.2.3', code: 'DL.2.3', text: "Avulsed teeth are identified immediately after receiving from the patient.", activityType: 'INT' },
          { id: 'DL.2.4', code: 'DL.2.4', text: "Identification of patient-related dental prosthesis, impressions, and appliances performed using at least two (2) patient identifiers.", activityType: 'INT' }
        ]
      },
      {
        id: 'DL.3', code: 'DL.3',
        title: 'Dental laboratory staff minimize the risk of infection in their workplace.',
        intent: 'Dental laboratories deal with items in direct contact with saliva and mucosa. The center must exert all possible efforts to prevent the spread of infection inside the dental laboratories.',
        substandards: [
          { id: 'DL.3.1', code: 'DL.3.1', text: "The laboratory has a designated area for receiving all incoming work, separate from the production area.", activityType: 'OBS' },
          { id: 'DL.3.2', code: 'DL.3.2', text: "Staff are not allowed to eat or drink in the dental laboratory except in a designated room.", activityType: 'OBS' },
          { id: 'DL.3.3', code: 'DL.3.3', text: "Gloves are worn when dealing with contaminated items. Masks and waterproof aprons are used to prevent contamination from splashes and aerosols.", activityType: 'OBS' },
          { id: 'DL.3.4', code: 'DL.3.4', text: "Workbenches, sinks, and model trimmers are wiped down with disinfectant at the beginning and end of the working day.", activityType: 'INT' },
          { id: 'DL.3.5', code: 'DL.3.5', text: "Impressions and appliances received from the clinic are inspected for proper cleaning and disinfection and rejected if not found in compliance.", activityType: 'INT' },
          { id: 'DL.3.6', code: 'DL.3.6', text: "Appliances are disinfected before being returned to the dental clinic.", activityType: 'INT' }
        ]
      },
      {
        id: 'DL.4', code: 'DL.4',
        title: 'The structure and equipment of the dental laboratory ensure staff safety.',
        intent: 'Due to hazardous materials and procedures performed, dental laboratories are hazardous workplaces. The director ensures that structure and equipment comply with safety requirements.',
        substandards: [
          { id: 'DL.4.1', code: 'DL.4.1', text: "The flooring is made of a material that is easy to maintain, with no carpets, readily cleanable, and appropriately wear-resistant for the location. All floor joints for ducts and pipes are tightly sealed.", activityType: 'OBS' },
          { id: 'DL.4.2', code: 'DL.4.2', text: "Wall finishes are washable, moisture-resistant, and smooth. The walls do not have any grooves or cracks that can harbor dust and dirt.", activityType: 'OBS' },
          { id: 'DL.4.3', code: 'DL.4.3', text: "The unit has adequate hand wash facilities, an emergency shower, eye-flushing devices, adequate lighting, and appropriate storage for flammable liquids.", activityType: 'OBS' },
          { id: 'DL.4.4', code: 'DL.4.4', text: "There is a dedicated place to mold ceramics that is isolated from the other areas of the dental laboratory and is protected from dust.", activityType: 'OBS' },
          { id: 'DL.4.5', code: 'DL.4.5', text: "All propane and butane gas cylinders are stored safely and securely outside the lab, clearly marked, with emergency shut-off valves located inside the laboratory.", activityType: 'OBS' },
          { id: 'DL.4.6', code: 'DL.4.6', text: "Oxygen and argon gases, if used, are placed securely in a safe area away from flammable gases.", activityType: 'OBS' },
          { id: 'DL.4.7', code: 'DL.4.7', text: "Appropriate first aid kits are readily accessible and regularly maintained.", activityType: 'OBS' }
        ]
      },
      {
        id: 'DL.5', code: 'DL.5',
        title: 'The structure of the dental laboratory ensures proper ventilation and airflow.',
        intent: 'Ventilation system design is crucial for staff safety. Separate, proper, and maintained air and vacuum systems ensure safety and reduce risk in the dental laboratory.',
        substandards: [
          { id: 'DL.5.1', code: 'DL.5.1', text: "The laboratory maintains adequate ventilation.", activityType: 'OBS' },
          { id: 'DL.5.2', code: 'DL.5.2', text: "Air and vacuum systems for the dental clinic are dedicated for clinic use only and are not connected to the dental laboratory.", activityType: 'OBS' },
          { id: 'DL.5.3', code: 'DL.5.3', text: "Direct dedicated exhaust is placed over all burnout, casting, and/or boil-out areas. The exhaust is located within 18 inches of the source equipment to effectively remove heat, smoke, or odors.", activityType: 'OBS' }
        ]
      }
    ];

    // ============================================
    // DATA: Infection Prevention and Control (IPC) - Surveyor 1
    // ============================================
    const infectionControlStandards = [
      {
        id: 'IPC.1', code: 'IPC.1',
        title: 'The center implements a coordinated program to reduce the risk of infection to patients and staff.',
        intent: 'The center must establish an evidence-based infection control program. All activities should be regulated by scientifically based policies overseen by a qualified individual.',
        substandards: [
          { id: 'IPC.1.1', code: 'IPC.1.1', text: "The infection control program is developed collaboratively by the center's staff and approved by the center's leaders.", activityType: 'DOC' },
          { id: 'IPC.1.2', code: 'IPC.1.2', text: "The infection control program is based on current evidence-based guidelines and covers both patients and staff.", activityType: 'DOC' },
          { id: 'IPC.1.3', code: 'IPC.1.3', text: "Policies and procedures targeting the most important infection risk processes are developed to guide the infection prevention and control program.", activityType: 'DOC' },
          { id: 'IPC.1.4', code: 'IPC.1.4', text: "The components of the infection control program are combined in a manual that is available to all staff members.", activityType: 'DOC' },
          { id: 'IPC.1.5', code: 'IPC.1.5', text: "The center provides the staff with annual education on infection prevention and control policies and any related updates, with evidence of staff education kept in their personnel files.", activityType: 'PER' },
          { id: 'IPC.1.6', code: 'IPC.1.6', text: "The infection control program implementation is monitored by the center's leaders.", activityType: 'INT' }
        ]
      },
      {
        id: 'IPC.2', code: 'IPC.2',
        title: "The dental center's design and structure support the national infection prevention and control requirements.",
        intent: 'A properly designed center is essential for prevention and control of infection. Structural elements must meet minimum requirements for dental examination, procedure rooms, and sterilization unit.',
        substandards: [
          { id: 'IPC.2.1', code: 'IPC.2.1', text: "A dirty utility room is available for collecting medical and non-medical waste.", activityType: 'OBS' },
          { id: 'IPC.2.2', code: 'IPC.2.2', text: "A janitorial room is available for storing all cleaning equipment and material.", activityType: 'OBS' },
          { id: 'IPC.2.3', code: 'IPC.2.3', text: "All dental procedure rooms are equipped with two sinks that are easily accessible to the dentist and dental assistant.", activityType: 'OBS' },
          { id: 'IPC.2.4', code: 'IPC.2.4', text: "Work surfaces and benchtops in dental procedure rooms are sufficient, uncluttered, nonporous, impervious to water, smooth, and have sealed joints to facilitate cleaning.", activityType: 'OBS' },
          { id: 'IPC.2.5', code: 'IPC.2.5', text: "Dental procedure rooms are functionally separated into a clean zone and a contaminated zone.", activityType: 'OBS' },
          { id: 'IPC.2.6', code: 'IPC.2.6', text: "The dental sterilization unit has a dedicated contaminated zone for receiving and washing dental instruments and a dedicated clean zone for sterilization, with a unidirectional flow of instruments from dirty to clean.", activityType: 'OBS' }
        ]
      },
      {
        id: 'IPC.3', code: 'IPC.3',
        title: 'The center adopts an evidence-based and effective hand hygiene program.',
        intent: 'Hand hygiene is the most effective method of preventing infectious disease transmission. The center should provide facilities and monitor hand hygiene compliance among staff.',
        substandards: [
          { id: 'IPC.3.1', code: 'IPC.3.1', text: "Written policies and procedures on implementing and monitoring appropriate hand hygiene are available.", activityType: 'DOC' },
          { id: 'IPC.3.2', code: 'IPC.3.2', text: "The center provides hand hygiene facilities sufficient to meet its needs such as sinks, alcohol hand rubs, plain and antiseptic soap, and disposable paper towels.", activityType: 'OBS' }
        ]
      },
      {
        id: 'IPC.4', code: 'IPC.4',
        title: 'The center develops a process to prevent the spread of infection inside the dental procedure room contaminated zone.',
        intent: 'The contaminated zone is a source of infection if prevention standards are not followed before, during, and after each examination or procedure.',
        substandards: [
          { id: 'IPC.4.1', code: 'IPC.4.1', text: "Opened boxes of gloves, cotton rolls, or gauze are stored outside the contaminated zone and protected from contamination caused by splashes and aerosols.", activityType: 'OBS' },
          { id: 'IPC.4.2', code: 'IPC.4.2', text: "Equipment that is difficult to clean is covered with a protective plastic wrap that is replaced before each new patient.", activityType: 'OBS' },
          { id: 'IPC.4.3', code: 'IPC.4.3', text: "Clinical contact surfaces are disinfected in between patients. Blood stained surfaces are disinfected with an intermediate-level disinfectant.", activityType: 'OBS' },
          { id: 'IPC.4.4', code: 'IPC.4.4', text: "Cartridges of local anesthetic are kept in their individual packs and stored appropriately to prevent environmental contamination by aerosols and splashes.", activityType: 'OBS' },
          { id: 'IPC.4.5', code: 'IPC.4.5', text: "The spittoon is cleaned after each patient by wiping it with neutral detergent using disposable paper towels.", activityType: 'OBS' },
          { id: 'IPC.4.6', code: 'IPC.4.6', text: "Used instruments are transported in a closed prick-proof container to either the sterilization unit or the dirty utility, and not washed in the clinical area.", activityType: 'OBS' },
          { id: 'IPC.4.7', code: 'IPC.4.7', text: "Used instruments are sprayed or soaked with an enzymatic detergent if not immediately removed for washing and sterilization.", activityType: 'OBS' }
        ]
      },
      {
        id: 'IPC.5', code: 'IPC.5',
        title: 'Personal protective equipment is available, readily accessible, and is used correctly by staff in all patient care areas.',
        intent: 'PPE is a fundamental tool in infection prevention and control. The center identifies situations requiring masks, eye protection, gowns, or gloves and provides sufficient supply and training.',
        substandards: [
          { id: 'IPC.5.1', code: 'IPC.5.1', text: "Written policies and procedures are available on the appropriate use of gloves, gowns, facemasks, and protective eyewear.", activityType: 'DOC' },
          { id: 'IPC.5.2', code: 'IPC.5.2', text: "Gloves and surgical masks are worn by the dentist and dental assistant for all clinical procedures. Sterile gloves are worn for any oral surgical procedures.", activityType: 'OBS' },
          { id: 'IPC.5.3', code: 'IPC.5.3', text: "Dental assistants put on new gloves for cleaning the working surfaces during the changeover between patients.", activityType: 'OBS' },
          { id: 'IPC.5.4', code: 'IPC.5.4', text: "Protective eyewear or face shields are worn by the dentist, dental assistant, and the patient. In case of patient refusal, risks are explained and refusal is documented in the dental record.", activityType: 'OBS' },
          { id: 'IPC.5.5', code: 'IPC.5.5', text: "When a risk of large splashes with blood or body substances is anticipated, impermeable protective clothing or gowns are worn by the dentist and dental assistant.", activityType: 'OBS' }
        ]
      },
      {
        id: 'IPC.6', code: 'IPC.6',
        title: 'The center minimizes the risk of infection from dental impressions and dental appliances.',
        intent: 'Dental impressions and appliances are a known source of infection transmission. Every effort must be exerted to eliminate the risk of infection from these items.',
        substandards: [
          { id: 'IPC.6.1', code: 'IPC.6.1', text: "Dental impressions are decontaminated by rinsing in running water, immersing in a diluted detergent with recommended exposure time, and then rinsing to remove the detergent, and placed in a sealed bag before transportation to the dental laboratory.", activityType: 'OBS' },
          { id: 'IPC.6.2', code: 'IPC.6.2', text: "All materials, impressions, dental prostheses, intraoral and extraoral appliances are cleaned thoroughly before insertion and adjustment.", activityType: 'OBS' },
          { id: 'IPC.6.3', code: 'IPC.6.3', text: "The orally soiled prosthesis is scrubbed with a brush and anti-microbial soap and placed in an ultrasonic cleaner, and later rinsed under tap water and dried before initiating any required work.", activityType: 'OBS' }
        ]
      },
      {
        id: 'IPC.7', code: 'IPC.7',
        title: 'The dental center minimizes the risk of water contamination.',
        intent: 'Dental procedures depend on water jets running through the patient\'s oral cavity. Eliminating water contamination is essential for infection prevention and control.',
        substandards: [
          { id: 'IPC.7.1', code: 'IPC.7.1', text: "The dental center uses softened water in all water lines with a colony count of less than (500) colony forming units/ml.", activityType: 'DOC' },
          { id: 'IPC.7.2', code: 'IPC.7.2', text: "Sterile irrigants are used for aseptic procedures.", activityType: 'OBS' },
          { id: 'IPC.7.3', code: 'IPC.7.3', text: "All waterlines are equipped with a biofilm and a non-return valve.", activityType: 'OBS' },
          { id: 'IPC.7.4', code: 'IPC.7.4', text: "Waterlines are cleaned and disinfected in accordance with the manufacturer's instructions.", activityType: 'OBS' },
          { id: 'IPC.7.5', code: 'IPC.7.5', text: "Air and water lines from any device are flushed for a minimum of two (2) minutes at the start of the day and for (30) seconds between patients.", activityType: 'OBS' }
        ]
      },
      {
        id: 'IPC.8', code: 'IPC.8',
        title: 'The center minimizes the risk of infection encountered with the use of intraoral radiographs.',
        intent: 'Intraoral radiographs are a potential source of infection through the oral cavity. Strict protocols should be followed to eliminate infection risk.',
        substandards: [
          { id: 'IPC.8.1', code: 'IPC.8.1', text: "Gloves are worn when exposing radiographs and handling contaminated film packets.", activityType: 'OBS' },
          { id: 'IPC.8.2', code: 'IPC.8.2', text: "Intraoral devices are either disposable or heat tolerant.", activityType: 'OBS' },
          { id: 'IPC.8.3', code: 'IPC.8.3', text: "Exposed radiographs are dried of saliva/blood and placed in a protective container before transport to the developing room.", activityType: 'OBS' },
          { id: 'IPC.8.4', code: 'IPC.8.4', text: "Digital radiography sensors are covered with an appropriate barrier during exposure and disinfected in between patients using the manufacturer's recommendation.", activityType: 'OBS' },
          { id: 'IPC.8.5', code: 'IPC.8.5', text: "Contaminated radiography equipment, including the radiograph tube head and control panel, is cleaned after each patient use. Alternatively, barrier protection can be applied and changed after each patient use.", activityType: 'OBS' }
        ]
      },
      {
        id: 'IPC.9', code: 'IPC.9',
        title: 'Sterilization services support infection prevention and control.',
        intent: 'Infection risk is minimized through proper cleaning, disinfection, and sterilization. CSSD must set policies guiding collection, decontamination, cleaning, sterilization, and storage.',
        substandards: [
          { id: 'IPC.9.1', code: 'IPC.9.1', text: "The sterilization processes are conducted by qualified staff.", activityType: 'PER' },
          { id: 'IPC.9.2', code: 'IPC.9.2', text: "There is an adequate and dedicated space for sterilization services that supports the sterilization processes.", activityType: 'OBS' },
          { id: 'IPC.9.3', code: 'IPC.9.3', text: "The center develops a policy and procedure for the safe reprocessing of single-use items.", activityType: 'DOC' },
          { id: 'IPC.9.4', code: 'IPC.9.4', text: "Personal protective equipment is available and utilized during the decontamination process.", activityType: 'OBS' },
          { id: 'IPC.9.5', code: 'IPC.9.5', text: "Sterilizers are in proper working order and sterilizer's instructions are available.", activityType: 'OBS' },
          { id: 'IPC.9.6', code: 'IPC.9.6', text: "Proper sterilization parameters are recorded and records are retained for one year.", activityType: 'DOC' },
          { id: 'IPC.9.7', code: 'IPC.9.7', text: "Chemical indicators are used in every package and biological indicators are used at least weekly. Records of results are kept for one year.", activityType: 'DOC' }
        ]
      },
      {
        id: 'IPC.10', code: 'IPC.10',
        title: 'The center defines, in a policy, the environmental cleaning, decontamination, and disinfection processes in all patient care areas.',
        intent: 'Environmental cleaning ensures appropriate decontamination of surfaces that could transmit dangerous pathogens. Disinfectants must be selected based on scientific references.',
        substandards: [
          { id: 'IPC.10.1', code: 'IPC.10.1', text: "The center develops and regularly reviews the procedures and schedules for cleaning, decontamination, and disinfection.", activityType: 'DOC' },
          { id: 'IPC.10.2', code: 'IPC.10.2', text: "The center keeps a schedule that lists all environmental surfaces, equipment, and items to be cleaned/disinfected in care areas.", activityType: 'DOC' },
          { id: 'IPC.10.3', code: 'IPC.10.3', text: "The center keeps a list of appropriate detergents and disinfectants for dental instruments and prosthesis in accordance with the manufacturer's instructions.", activityType: 'DOC' },
          { id: 'IPC.10.4', code: 'IPC.10.4', text: "Detergents and disinfectants are available and used properly in accordance with the manufacturer's instructions.", activityType: 'OBS' },
          { id: 'IPC.10.5', code: 'IPC.10.5', text: "The center has a process to safely handle blood and body fluids spills.", activityType: 'DOC' }
        ]
      },
      {
        id: 'IPC.11', code: 'IPC.11',
        title: 'The center develops a policy and procedure for the prevention and management of sharp injuries.',
        intent: 'To prevent sharps injuries with exposure to blood-borne infections, the center should have a defined system for sharps handling, use, and disposal according to written policy.',
        substandards: [
          { id: 'IPC.11.1', code: 'IPC.11.1', text: "To prevent injuries from sharps, needles are not bent, broken, or recapped except in special and approved circumstances, the 'scoop method' is used if recapping is necessary.", activityType: 'OBS' },
          { id: 'IPC.11.2', code: 'IPC.11.2', text: "Needles and sharps are disposed of in sharp boxes or containers of appropriate size and number.", activityType: 'OBS' },
          { id: 'IPC.11.3', code: 'IPC.11.3', text: "Needle sticks or sharp injuries are timely reported and investigated.", activityType: 'DOC' },
          { id: 'IPC.11.4', code: 'IPC.11.4', text: "Data on sharp injuries are analyzed and trended over time and findings are utilized for further prevention of injuries.", activityType: 'DOC' }
        ]
      },
      {
        id: 'IPC.12', code: 'IPC.12',
        title: 'The center implements a program for the safe collection, storage, and disposal of medical waste that is consistent with laws and regulations.',
        intent: 'To protect the public and environment from infectious organisms, the center should implement a Medical Waste Management Program regulating segregation, handling, storage, and disposal.',
        substandards: [
          { id: 'IPC.12.1', code: 'IPC.12.1', text: "Medical waste is stored for final disposal in a dedicated, cleaned, and maintained waste collection room.", activityType: 'OBS' },
          { id: 'IPC.12.2', code: 'IPC.12.2', text: "Medical waste, including sharp boxes, is discarded by a registered medical waste company.", activityType: 'DOC' },
          { id: 'IPC.12.3', code: 'IPC.12.3', text: "Yellow bags are used for all non-sharp disposable materials contaminated with the patient's blood or body fluids.", activityType: 'OBS' },
          { id: 'IPC.12.4', code: 'IPC.12.4', text: "Hazardous signs are fixed on all medical waste containers.", activityType: 'OBS' }
        ]
      },
      {
        id: 'IPC.13', code: 'IPC.13',
        title: "The center develops policies and procedures that address employees' screening, immunization, and post-exposure management.",
        intent: 'Dental staff are at risk of infection from patients. The center must develop evidence-based policies governing staff vaccination and post-exposure management.',
        substandards: [
          { id: 'IPC.13.1', code: 'IPC.13.1', text: "Screening, immunization, and post-exposure management of employees are consistent with the laws and regulations, and the recommendations of professional organizations.", activityType: 'DOC' },
          { id: 'IPC.13.2', code: 'IPC.13.2', text: "All employees have baseline screening for hepatitis B, hepatitis C, HIV, and tuberculosis.", activityType: 'PER' },
          { id: 'IPC.13.3', code: 'IPC.13.3', text: "The immune status of newly hired staff against hepatitis B is determined by serological testing and appropriate vaccine(s) are administered to those who are non-immune.", activityType: 'PER' },
          { id: 'IPC.13.4', code: 'IPC.13.4', text: "The response to hepatitis B vaccination is monitored in vaccinated employees four weeks after completing the vaccine series. Non-responders to the hepatitis B vaccine are offered at least a second series of the vaccine.", activityType: 'PER' }
        ]
      }
    ];

    // Chapter definitions for Surveyor 1 (A1)
    const chapters_A1 = [
      { id: 'LD', code: 'LD', name: 'Leadership of the Organization', standards: leadershipStandards, active: true },
      { id: 'PC', code: 'PC', name: 'Provision of Care', standards: provisionOfCareStandards, active: true },
      { id: 'DL', code: 'DL', name: 'Dental Laboratory', standards: dentalLaboratoryStandards, active: true },
      { id: 'IPC', code: 'IPC', name: 'Infection Prevention and Control', standards: infectionControlStandards, active: true }
    ];

    // Provision of Care Standards for Surveyor 2
    const provisionOfCareStandards_A2 = [
      {
        id: 'PC.1', code: 'PC.1',
        title: 'Patients have access to services based on their dental needs and the available services, and are registered with the center for providing such services.',
        intent: 'The center has to demonstrate a registry where every dental service is available based on the identified service requirements and the facility\'s scope of practice. New patients are met by a patient services personnel team or receptionist who helps establish care, assign a dental record, and register them with a primary dentist.',
        substandards: [
          { id: 'PC.1.1', code: 'PC.1.1', text: 'A standardized process is in place for screening and registering patients for services using their full name and identification number.', activityType: 'INT' },
          { id: 'PC.1.2', code: 'PC.1.2', text: 'Registration creates a dental record number that is unique to every patient.', activityType: 'DEN' },
          { id: 'PC.1.3', code: 'PC.1.3', text: 'An appointment system is in place to book patients in advance.', activityType: 'INT' }
        ]
      },
      {
        id: 'PC.2', code: 'PC.2',
        title: 'The center has a process to ensure the correct identification of patients and teeth.',
        intent: 'Patient identification errors can occur in virtually all aspects of diagnosis and treatment. The intent is to reliably identify the patient as the person for whom the service or treatment is intended and to match the service or treatment to that patient.',
        substandards: [
          { id: 'PC.2.1', code: 'PC.2.1', text: 'Patients are identified by at least two (2) identifiers: the full name as in the identification document, and a unique dental record number.', activityType: 'INT' },
          { id: 'PC.2.2', code: 'PC.2.2', text: 'Patients are identified before blood withdrawal, before any investigation, before administering medications, and before any surgery or procedure.', activityType: 'INT' },
          { id: 'PC.2.3', code: 'PC.2.3', text: 'Patients are actively involved in the process of patient identification.', activityType: 'OBS' },
          { id: 'PC.2.4', code: 'PC.2.4', text: 'An approved tooth numbering system (FDI) is used to identify the tooth in each intervention.', activityType: 'DEN' }
        ]
      },
      {
        id: 'PC.3', code: 'PC.3',
        title: 'The center develops and implements a process for reporting critical test results, whether performed on-site or outsourced.',
        intent: 'Diagnostic procedures and their results help define the patient\'s condition and identify treatment options. The center determines its critical tests and critical values. The process defines who reports to whom, what is reported, and how the process is managed.',
        substandards: [
          { id: 'PC.3.1', code: 'PC.3.1', text: 'The process defines which staff is responsible to receive critical test results.', activityType: 'DOC' },
          { id: 'PC.3.2', code: 'PC.3.2', text: 'The process involves writing down the test result by the receiver and reading back the findings to the result provider.', activityType: 'INT' },
          { id: 'PC.3.3', code: 'PC.3.3', text: 'The read-back process and the dentist\'s intervention are documented in the patient dental record.', activityType: 'DEN' },
          { id: 'PC.3.4', code: 'PC.3.4', text: 'The center develops a process for contacting patients that left the center when critical test results are reported.', activityType: 'INT' }
        ]
      },
      {
        id: 'PC.5', code: 'PC.5',
        title: 'The dental center ensures all required safety measures are performed for moderate sedation.',
        intent: 'Moderate sedation is a drug-induced depression of consciousness during which patients respond purposefully to verbal commands. The center must ensure proper equipment, trained staff, recovery protocols, and documentation for patient safety.',
        substandards: [
          { id: 'PC.5.1', code: 'PC.5.1', text: 'The procedure room is equipped with an appropriate nitrous oxide/oxygen mixing device and the appropriate monitoring equipment that permits continuous recording of the patient\'s EEG and oxygen saturation, with an intermittent recording of the blood pressure.', activityType: 'OBS' },
          { id: 'PC.5.2', code: 'PC.5.2', text: 'The dentist performing the procedure is certified competent in moderate sedation and managing its possible complications.', activityType: 'PER' },
          { id: 'PC.5.3', code: 'PC.5.3', text: 'The dental assistant is certified/competent in monitoring patients under moderate sedation.', activityType: 'PER' },
          { id: 'PC.5.4', code: 'PC.5.4', text: 'The center has a recovery room, with monitoring equipment, adjacent to the procedure room or the patient is reassessed in the same procedure room.', activityType: 'OBS' },
          { id: 'PC.5.5', code: 'PC.5.5', text: 'The patient is discharged home after full recovery utilizing evidence-based recovery criteria that are documented in the patient dental record.', activityType: 'DEN' }
        ]
      },
      {
        id: 'PC.10', code: 'PC.10',
        title: 'The center has a policy and process to safely provide care to patients who require cardiopulmonary resuscitation (CPR).',
        intent: 'A policy and process are in place that outlines how the dental center will care for patients who require cardiopulmonary resuscitation (CPR). The policy documents arrangements for transferring patients to appropriate facilities when needed.',
        substandards: [
          { id: 'PC.10.1', code: 'PC.10.1', text: 'The CPR policy highlights the availability of a standardized crash cart(s) or automated external defibrillator (AED) in the patient care areas.', activityType: 'OBS' },
          { id: 'PC.10.2', code: 'PC.10.2', text: 'The policy describes the process for qualified staff to check the crash cart every shift and after each use.', activityType: 'INT' },
          { id: 'PC.10.3', code: 'PC.10.3', text: 'The role of staff involved in the CPR process is clearly defined in the CPR policy and monitored for implementation.', activityType: 'DOC' }
        ]
      },
      {
        id: 'PC.15', code: 'PC.15',
        title: 'Internal radiology services are available in dental centers and operated safely. Other radiology services are outsourced, as needed, to meet patient needs.',
        intent: 'Intraoral x-ray tests are usually in-house services. Panoramic and cephalometric x-rays are found in orthodontic centers. Cone beam CT scans are available in some dental centers and performed when clinically indicated.',
        substandards: [
          { id: 'PC.15.1', code: 'PC.15.1', text: 'The center has functional in-house intraoral and panoramic radiology services.', activityType: 'OBS' },
          { id: 'PC.15.2', code: 'PC.15.2', text: 'Intraoral radiographs, dental panorama, and cephalometric radiographs are carried out by the dental assistant or a radiology technician.', activityType: 'PER' },
          { id: 'PC.15.3', code: 'PC.15.3', text: 'Dental cone-beam CT scans are carried out by a licensed radiology technician or a trained dental assistant.', activityType: 'PER' },
          { id: 'PC.15.4', code: 'PC.15.4', text: 'Intraoral, panoramic, and cephalometric radiographs are read and reported by the ordering dentist.', activityType: 'DEN' },
          { id: 'PC.15.5', code: 'PC.15.5', text: 'Dental cone-beam CT scans are read and reported by a qualified trained dentist.', activityType: 'PER' }
        ]
      },
      {
        id: 'PC.16', code: 'PC.16',
        title: 'The center develops a radiation safety program.',
        intent: 'Radiation safety programs reduce the risk of exposure to ionizing radiation to patients, visitors, and staff. The center ensures all radiation equipment is properly maintained, staff are trained and monitored, and appropriate safety measures are in place.',
        substandards: [
          { id: 'PC.16.1', code: 'PC.16.1', text: 'The radiation safety program covers all areas where ionizing radiation is used for either intraoral or extraoral x-rays.', activityType: 'DOC' },
          { id: 'PC.16.2', code: 'PC.16.2', text: 'All areas where ionizing radiation is administered are tested and certified radiation leak-proof by the appropriate certifying local authority.', activityType: 'DOC' },
          { id: 'PC.16.3', code: 'PC.16.3', text: 'Radiology equipment is periodically inspected, calibrated, and maintained for proper functioning.', activityType: 'DOC' },
          { id: 'PC.16.4', code: 'PC.16.4', text: 'Safety warnings are posted in clear and appropriate locations on the doors.', activityType: 'OBS' },
          { id: 'PC.16.5', code: 'PC.16.5', text: 'Women of childbearing age with missed menstruation are checked for the possibility of being pregnant prior to having X-ray tests.', activityType: 'INT' },
          { id: 'PC.16.6', code: 'PC.16.6', text: 'Personnel are monitored for radiation exposure by thermoluminescence dosimeters (TLD) that are regularly checked.', activityType: 'DOC' },
          { id: 'PC.16.7', code: 'PC.16.7', text: 'Personnel shielding devices, including radiation protection aprons, are available for patients and staff, and periodically inspected and tested for integrity and safety compliance as per the documentation.', activityType: 'DOC' }
        ]
      }
    ];

    // Chapter definitions for Surveyor 2 (A2)
    const chapters_A2 = [
      { id: 'LD', code: 'LD', name: 'Leadership of the Organization', standards: leadershipStandards_A2, active: true },
      { id: 'PC', code: 'PC', name: 'Provision of Care', standards: provisionOfCareStandards_A2, active: provisionOfCareStandards_A2.length > 0, placeholder: provisionOfCareStandards_A2.length === 0 },
      { id: 'MOI', code: 'MOI', name: 'Management of Information', standards: moiStandards, active: moiStandards.length > 0, placeholder: moiStandards.length === 0 },
      { id: 'FMS', code: 'FMS', name: 'Facility Management and Safety', standards: fmsStandards, active: fmsStandards.length > 0, placeholder: fmsStandards.length === 0 }
    ];

    // ============================================
    // CONFIGURATION B: Full Survey (All Domains Merged)
    // ============================================

    // Merge Leadership Standards (A1 + A2) - sorted by standard number
    const leadershipStandards_B = [...leadershipStandards, ...leadershipStandards_A2].sort((a, b) => {
      const numA = parseFloat(a.code.replace('LD.', ''));
      const numB = parseFloat(b.code.replace('LD.', ''));
      return numA - numB;
    });

    // Merge Provision of Care Standards (A1 + A2) - sorted by standard number
    const provisionOfCareStandards_B = [...provisionOfCareStandards, ...provisionOfCareStandards_A2].sort((a, b) => {
      const numA = parseFloat(a.code.replace('PC.', ''));
      const numB = parseFloat(b.code.replace('PC.', ''));
      return numA - numB;
    });

    // Domain color scheme for Configuration B (subtle, professional)
    const domainColors = {
      LD: { primary: '#1e3a5f', light: '#e8f4fc', accent: '#3498db', gradient: 'linear-gradient(135deg, #1e3a5f 0%, #2d5a8a 100%)' },
      PC: { primary: '#0d6b4e', light: '#e6f5f0', accent: '#27ae60', gradient: 'linear-gradient(135deg, #0d6b4e 0%, #1a9d6c 100%)' },
      DL: { primary: '#6b4e0d', light: '#fdf6e6', accent: '#f39c12', gradient: 'linear-gradient(135deg, #6b4e0d 0%, #9d7a1a 100%)' },
      IPC: { primary: '#5e1e5e', light: '#f5e8f5', accent: '#9b59b6', gradient: 'linear-gradient(135deg, #5e1e5e 0%, #8a3d8a 100%)' },
      MOI: { primary: '#1e5e5e', light: '#e8f5f5', accent: '#16a085', gradient: 'linear-gradient(135deg, #1e5e5e 0%, #3d8a8a 100%)' },
      FMS: { primary: '#5e1e2d', light: '#f5e8ec', accent: '#e74c3c', gradient: 'linear-gradient(135deg, #5e1e2d 0%, #8a3d4d 100%)' }
    };

    // Chapter definitions for Full Survey (B) - All 6 Domains
    const chapters_B = [
      { id: 'LD', code: 'LD', name: 'Leadership of the Organization', standards: leadershipStandards_B, active: true, color: domainColors.LD, order: 1 },
      { id: 'PC', code: 'PC', name: 'Provision of Care', standards: provisionOfCareStandards_B, active: true, color: domainColors.PC, order: 2 },
      { id: 'DL', code: 'DL', name: 'Dental Laboratory', standards: dentalLaboratoryStandards, active: true, color: domainColors.DL, order: 3 },
      { id: 'IPC', code: 'IPC', name: 'Infection Prevention and Control', standards: infectionControlStandards, active: true, color: domainColors.IPC, order: 4 },
      { id: 'MOI', code: 'MOI', name: 'Management of Information', standards: moiStandards, active: true, color: domainColors.MOI, order: 5 },
      { id: 'FMS', code: 'FMS', name: 'Facility Management and Safety', standards: fmsStandards, active: true, color: domainColors.FMS, order: 6 }
    ];

    // Default chapters (backwards compatible)
    const chapters = chapters_A1;

    // Function to get chapters by configuration
    const getChaptersByConfig = (config) => {
      switch (config) {
        case 'A2': return chapters_A2;
        case 'B': return chapters_B;
        case 'A1':
        default: return chapters_A1;
      }
    };

    // Get domain color by chapter ID
    const getDomainColor = (chapterId) => domainColors[chapterId] || domainColors.LD;

    const getAllSubstandards = (standardsList) => {
      const subs = [];
      standardsList.forEach(std => {
        std.substandards.forEach(sub => {
          subs.push({ ...sub, standardId: std.id, standardTitle: std.title, standardIntent: std.intent, standardCode: std.code });
        });
      });
      return subs;
    };

    // Group substandards by their mother standard
    const groupSubstandardsByStandard = (substandards) => {
      const groups = [];
      let currentGroup = null;

      substandards.forEach(sub => {
        if (!currentGroup || currentGroup.standardId !== sub.standardId) {
          currentGroup = {
            standardId: sub.standardId,
            standardCode: sub.standardCode,
            standardTitle: sub.standardTitle,
            standardIntent: sub.standardIntent,
            substandards: []
          };
          groups.push(currentGroup);
        }
        currentGroup.substandards.push(sub);
      });

      return groups;
    };

    // ============================================
    // SCORE INTERPRETATION
    // ============================================
    const getScoreInterpretation = (percentage) => {
      if (percentage >= 90) {
        return {
          level: 'excellent', title: 'Excellent - Ready for Accreditation',
          description: 'The center demonstrates exceptional compliance with CBAHI standards.'
        };
      } else if (percentage >= 75) {
        return {
          level: 'good', title: 'Good - Minor Improvements Needed',
          description: 'The center shows good compliance with most standards.'
        };
      } else if (percentage >= 60) {
        return {
          level: 'needs-improvement', title: 'Needs Improvement - Significant Gaps',
          description: 'Several areas require substantial improvement before accreditation readiness.'
        };
      } else {
        return {
          level: 'critical', title: 'Critical - Major Improvements Required',
          description: 'The center has significant gaps in compliance with CBAHI standards.'
        };
      }
    };

    // ============================================
    // COMPONENTS
    // ============================================

    // Activity Badge
    const ActivityBadge = ({ type }) => {
      const typeMap = {
        DOC: { label: 'Document Review', className: 'doc' },
        OBS: { label: 'Observation', className: 'obs' },
        INT: { label: 'Interview', className: 'int' },
        PER: { label: 'Personnel File', className: 'per' },
        DEN: { label: 'Dental Record Review', className: 'den' }
      };
      const info = typeMap[type] || { label: type, className: 'doc' };
      return <span className={`activity-badge ${info.className}`}>{info.label}</span>;
    };

    // Score Option
    const ScoreOption = ({ value, label, selected, onClick, type }) => (
      <div className={`score-option ${type} ${selected ? 'selected' : ''}`} onClick={onClick}>
        <div className={`score-indicator ${type}`}>{value === 'NA' ? '' : value}</div>
        <span>{label}</span>
      </div>
    );

    // Auto-save Indicator
    const AutosaveIndicator = ({ saving }) => (
      <div className={`autosave-indicator ${saving ? 'saving' : ''}`}>
        <div className="autosave-dot"></div>
        <span>{saving ? 'Saving...' : 'All changes saved'}</span>
      </div>
    );

    // Domain Separator Component for Full Survey Mode
    const DomainSeparator = ({ chapter, stats }) => {
      const domainClass = `domain-${chapter.code.toLowerCase()}`;
      return (
        <div className={`domain-separator ${domainClass}`}>
          <div className="domain-separator-content">
            <div className={`domain-icon ${domainClass}`}>{chapter.code}</div>
            <div className="domain-info">
              <div className="domain-title">{chapter.name}</div>
              <div className="domain-subtitle">
                <span>{chapter.standards.length} Standards</span>
                <span></span>
                <span>{stats.total} Sub-standards</span>
              </div>
            </div>
            <div className="domain-stats">
              <div className="domain-stat">
                <div className="domain-stat-value" style={{ color: 'var(--success)' }}>{stats.fullyMet}</div>
                <div className="domain-stat-label">Fully Met</div>
              </div>
              <div className="domain-stat">
                <div className="domain-stat-value" style={{ color: 'var(--warning)' }}>{stats.partial}</div>
                <div className="domain-stat-label">Partial</div>
              </div>
              <div className="domain-stat">
                <div className="domain-stat-value" style={{ color: 'var(--danger)' }}>{stats.notMet}</div>
                <div className="domain-stat-label">Not Met</div>
              </div>
              <div className="domain-stat">
                <div className="domain-stat-value">{stats.pending}</div>
                <div className="domain-stat-label">Pending</div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // Sub-standard Card
    const SubstandardCard = ({ substandard, score, onScoreChange }) => {
      const scoreValue = score?.value;
      // Support both 'comment' (live scoring) and 'findings' (mock/imported data)
      const comment = score?.comment || score?.findings || '';
      const location = score?.location || '';

      const getScoreClass = () => {
        if (scoreValue === 'NA') return 'scored-na';
        if (scoreValue === 0) return 'scored-0';
        if (scoreValue === 1) return 'scored-1';
        if (scoreValue === 2) return 'scored-2';
        return '';
      };

      return (
        <div className={`substandard-card ${getScoreClass()}`}>
          <div className="substandard-header">
            <span className="substandard-code">{substandard.code}</span>
            <ActivityBadge type={substandard.activityType} />
          </div>
          <div className="substandard-body">
            <p className="substandard-text">{substandard.text}</p>
            <div className="scoring-section">
              <div className="score-options">
                <ScoreOption value="NA" label="N/A" type="na"
                  selected={scoreValue === 'NA'}
                  onClick={() => onScoreChange(substandard.id, 'NA', comment, location)} />
                <ScoreOption value={0} label="Not Met" type="not-met"
                  selected={scoreValue === 0}
                  onClick={() => onScoreChange(substandard.id, 0, comment, location)} />
                <ScoreOption value={1} label="Partially Met" type="partial"
                  selected={scoreValue === 1}
                  onClick={() => onScoreChange(substandard.id, 1, comment, location)} />
                <ScoreOption value={2} label="Fully Met" type="full"
                  selected={scoreValue === 2}
                  onClick={() => onScoreChange(substandard.id, 2, comment, location)} />
              </div>
              <div className="comment-section">
                <textarea className="comment-input"
                  placeholder="Finding / Comment..."
                  value={comment}
                  onChange={(e) => onScoreChange(substandard.id, scoreValue, e.target.value, location)} />
                {substandard.activityType === 'OBS' && (
                  <div className="location-field">
                    <input type="text" className="location-input"
                      placeholder="Location..."
                      value={location}
                      onChange={(e) => onScoreChange(substandard.id, scoreValue, comment, e.target.value)} />
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      );
    };

    // Chapters Summary Modal
    const ChaptersSummaryModal = ({ isOpen, onClose, scores, chapters, onFinalize, isFinalized, overallPending }) => {
      // Lock body scroll when modal is open
      useEffect(() => {
        if (isOpen) {
          document.body.style.overflow = 'hidden';
        } else {
          document.body.style.overflow = '';
        }
        return () => { document.body.style.overflow = ''; };
      }, [isOpen]);

      if (!isOpen) return null;

      // Calculate stats for each chapter
      const chapterStats = chapters.map(chapter => {
        const allSubs = getAllSubstandards(chapter.standards);
        let total = allSubs.length;
        let scored = 0, fullyMet = 0, partial = 0, notMet = 0, na = 0;

        allSubs.forEach(sub => {
          const score = scores[sub.id];
          if (score && score.value !== undefined && score.value !== null) {
            scored++;
            if (score.value === 'NA') na++;
            else if (score.value === 2) fullyMet++;
            else if (score.value === 1) partial++;
            else if (score.value === 0) notMet++;
          }
        });

        const applicable = scored - na;
        const points = fullyMet * 2 + partial;
        const maxPoints = applicable * 2;
        const percentage = maxPoints > 0 ? Math.round((points / maxPoints) * 100) : 0;

        return {
          ...chapter,
          total, scored, fullyMet, partial, notMet, na, applicable, points, maxPoints, percentage
        };
      });

      // Calculate grand totals
      const grandTotal = chapterStats.reduce((acc, ch) => ({
        total: acc.total + ch.total,
        scored: acc.scored + ch.scored,
        fullyMet: acc.fullyMet + ch.fullyMet,
        partial: acc.partial + ch.partial,
        notMet: acc.notMet + ch.notMet,
        na: acc.na + ch.na,
        applicable: acc.applicable + ch.applicable,
        points: acc.points + ch.points,
        maxPoints: acc.maxPoints + ch.maxPoints
      }), { total: 0, scored: 0, fullyMet: 0, partial: 0, notMet: 0, na: 0, applicable: 0, points: 0, maxPoints: 0 });

      grandTotal.percentage = grandTotal.maxPoints > 0 ? Math.round((grandTotal.points / grandTotal.maxPoints) * 100) : 0;

      const getScoreColor = (pct) => {
        if (pct >= 90) return 'var(--success)';
        if (pct >= 75) return 'var(--primary)';
        if (pct >= 60) return 'var(--warning)';
        return 'var(--danger)';
      };

      return (
        <div className="modal-overlay" onClick={onClose} style={{ overflowY: 'auto' }}>
          <div className="modal chapters-summary-modal" onClick={e => e.stopPropagation()} style={{ maxWidth: '900px' }}>
            <div className="modal-header" style={{ background: 'var(--primary)', color: 'white', borderRadius: '12px 12px 0 0' }}>
              <h3 style={{ margin: 0, fontSize: '1.4rem' }}>Chapters Summary - All Domains</h3>
              <button className="modal-close" onClick={onClose} style={{ color: 'white', background: 'rgba(255,255,255,0.2)' }}></button>
            </div>
            <div className="modal-body" style={{ padding: '0', maxHeight: '70vh', overflowY: 'auto' }}>
              {/* Overall Score Banner */}
              <div style={{
                background: 'linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%)',
                color: 'white',
                padding: '28px',
                textAlign: 'center'
              }}>
                <div style={{ fontSize: '3.5rem', fontWeight: '700', lineHeight: 1 }}>{grandTotal.percentage}%</div>
                <div style={{ fontSize: '1.1rem', opacity: 0.9, marginTop: '10px' }}>Overall Compliance Score</div>
                <div style={{ display: 'flex', justifyContent: 'center', gap: '28px', marginTop: '18px', fontSize: '1rem' }}>
                  <span><strong>{grandTotal.scored}</strong> of <strong>{grandTotal.total}</strong> scored</span>
                  <span><strong>{grandTotal.applicable}</strong> applicable</span>
                </div>
              </div>

              {/* Chapter Cards */}
              <div style={{ padding: '24px' }}>
                {chapterStats.map(ch => (
                  <div key={ch.id} style={{
                    background: 'var(--bg-card)',
                    border: '1px solid var(--border)',
                    borderRadius: '12px',
                    marginBottom: '20px',
                    overflow: 'hidden'
                  }}>
                    {/* Chapter Header */}
                    <div style={{
                      display: 'flex',
                      justifyContent: 'space-between',
                      alignItems: 'center',
                      padding: '18px 24px',
                      borderBottom: '1px solid var(--border)',
                      background: 'var(--bg-main)'
                    }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                        <span style={{
                          background: 'var(--primary)',
                          color: 'white',
                          padding: '6px 12px',
                          borderRadius: '6px',
                          fontWeight: '600',
                          fontSize: '0.95rem'
                        }}>{ch.code}</span>
                        <span style={{ fontWeight: '600', fontSize: '1.05rem', color: 'var(--text-primary)' }}>{ch.name}</span>
                        {(ch.total - ch.scored) > 0 && (
                          <span style={{
                            background: 'rgba(142, 68, 173, 0.1)',
                            color: '#8e44ad',
                            padding: '4px 10px',
                            borderRadius: '4px',
                            fontSize: '0.8rem',
                            fontWeight: '600'
                          }}>{ch.total - ch.scored} pending</span>
                        )}
                      </div>
                      <div style={{
                        fontSize: '1.75rem',
                        fontWeight: '700',
                        color: getScoreColor(ch.percentage)
                      }}>{ch.percentage}%</div>
                    </div>

                    {/* Chapter Stats */}
                    <div style={{
                      display: 'grid',
                      gridTemplateColumns: 'repeat(6, 1fr)',
                      gap: '1px',
                      background: 'var(--border)'
                    }}>
                      <div style={{ background: 'white', padding: '14px', textAlign: 'center' }}>
                        <div style={{ fontSize: '0.85rem', color: 'var(--text-muted)', marginBottom: '6px' }}>Total</div>
                        <div style={{ fontSize: '1.25rem', fontWeight: '600' }}>{ch.total}</div>
                      </div>
                      <div style={{ background: 'white', padding: '14px', textAlign: 'center' }}>
                        <div style={{ fontSize: '0.85rem', color: 'var(--text-muted)', marginBottom: '6px' }}>Scored</div>
                        <div style={{ fontSize: '1.25rem', fontWeight: '600' }}>{ch.scored}</div>
                      </div>
                      <div style={{ background: 'rgba(46, 204, 113, 0.1)', padding: '14px', textAlign: 'center' }}>
                        <div style={{ fontSize: '0.85rem', color: 'var(--success)', marginBottom: '6px' }}>Fully Met</div>
                        <div style={{ fontSize: '1.25rem', fontWeight: '600', color: 'var(--success)' }}>{ch.fullyMet}</div>
                      </div>
                      <div style={{ background: 'rgba(241, 196, 15, 0.1)', padding: '14px', textAlign: 'center' }}>
                        <div style={{ fontSize: '0.85rem', color: 'var(--warning)', marginBottom: '6px' }}>Partial</div>
                        <div style={{ fontSize: '1.25rem', fontWeight: '600', color: 'var(--warning)' }}>{ch.partial}</div>
                      </div>
                      <div style={{ background: 'rgba(231, 76, 60, 0.1)', padding: '14px', textAlign: 'center' }}>
                        <div style={{ fontSize: '0.85rem', color: 'var(--danger)', marginBottom: '6px' }}>Not Met</div>
                        <div style={{ fontSize: '1.25rem', fontWeight: '600', color: 'var(--danger)' }}>{ch.notMet}</div>
                      </div>
                      <div style={{ background: 'rgba(149, 165, 166, 0.1)', padding: '14px', textAlign: 'center' }}>
                        <div style={{ fontSize: '0.85rem', color: 'var(--neutral)', marginBottom: '6px' }}>N/A</div>
                        <div style={{ fontSize: '1.25rem', fontWeight: '600', color: 'var(--neutral)' }}>{ch.na}</div>
                      </div>
                    </div>

                    {/* Progress Bar */}
                    <div style={{ padding: '12px 20px', background: 'var(--bg-main)' }}>
                      <div style={{
                        height: '8px',
                        background: 'var(--bg-main)',
                        borderRadius: '4px',
                        overflow: 'hidden',
                        display: 'flex'
                      }}>
                        <div style={{ width: `${ch.applicable > 0 ? (ch.fullyMet / ch.applicable) * 100 : 0}%`, background: 'var(--success)' }}></div>
                        <div style={{ width: `${ch.applicable > 0 ? (ch.partial / ch.applicable) * 100 : 0}%`, background: 'var(--warning)' }}></div>
                        <div style={{ width: `${ch.applicable > 0 ? (ch.notMet / ch.applicable) * 100 : 0}%`, background: 'var(--danger)' }}></div>
                      </div>
                    </div>

                  </div>
                ))}

                {/* Grand Total Card */}
                <div style={{
                  background: 'linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%)',
                  borderRadius: '12px',
                  overflow: 'hidden',
                  color: 'white',
                  marginTop: '8px',
                  padding: '20px'
                }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                      <span style={{ fontSize: '1.1rem', fontWeight: '600' }}>Grand Total - All Chapters</span>
                      {(grandTotal.total - grandTotal.scored) > 0 && (
                        <span style={{
                          background: 'rgba(255,255,255,0.2)',
                          padding: '4px 10px',
                          borderRadius: '4px',
                          fontSize: '0.8rem',
                          fontWeight: '600'
                        }}>{grandTotal.total - grandTotal.scored} pending</span>
                      )}
                    </div>
                    <div style={{ fontSize: '1.5rem', fontWeight: '700' }}>{grandTotal.percentage}%</div>
                  </div>
                  <div style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(6, 1fr)',
                    gap: '16px',
                    textAlign: 'center'
                  }}>
                    <div>
                      <div style={{ opacity: 0.8, fontSize: '0.85rem', marginBottom: '4px' }}>Total</div>
                      <div style={{ fontSize: '1.25rem', fontWeight: '600' }}>{grandTotal.total}</div>
                    </div>
                    <div>
                      <div style={{ opacity: 0.8, fontSize: '0.85rem', marginBottom: '4px' }}>Scored</div>
                      <div style={{ fontSize: '1.25rem', fontWeight: '600' }}>{grandTotal.scored}</div>
                    </div>
                    <div>
                      <div style={{ opacity: 0.8, fontSize: '0.85rem', marginBottom: '4px' }}>Fully Met</div>
                      <div style={{ fontSize: '1.25rem', fontWeight: '600' }}>{grandTotal.fullyMet}</div>
                    </div>
                    <div>
                      <div style={{ opacity: 0.8, fontSize: '0.85rem', marginBottom: '4px' }}>Partial</div>
                      <div style={{ fontSize: '1.25rem', fontWeight: '600' }}>{grandTotal.partial}</div>
                    </div>
                    <div>
                      <div style={{ opacity: 0.8, fontSize: '0.85rem', marginBottom: '4px' }}>Not Met</div>
                      <div style={{ fontSize: '1.25rem', fontWeight: '600' }}>{grandTotal.notMet}</div>
                    </div>
                    <div>
                      <div style={{ opacity: 0.8, fontSize: '0.85rem', marginBottom: '4px' }}>N/A</div>
                      <div style={{ fontSize: '1.25rem', fontWeight: '600' }}>{grandTotal.na}</div>
                    </div>
                  </div>

                  {/* Finalize Button in Summary Modal */}
                  {isFinalized ? (
                    <div style={{
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      gap: '8px',
                      marginTop: '20px',
                      padding: '12px 24px',
                      background: 'rgba(255,255,255,0.2)',
                      borderRadius: '25px',
                      fontSize: '15px',
                      fontWeight: '600'
                    }}>
                      <span></span> Assessment Finalized
                    </div>
                  ) : overallPending === 0 && grandTotal.total > 0 ? (
                    <button
                      onClick={onFinalize}
                      style={{
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        gap: '10px',
                        marginTop: '20px',
                        padding: '14px 32px',
                        background: 'linear-gradient(135deg, #27ae60 0%, #219a52 100%)',
                        border: 'none',
                        borderRadius: '25px',
                        color: 'white',
                        fontSize: '15px',
                        fontWeight: '700',
                        fontFamily: 'inherit',
                        cursor: 'pointer',
                        boxShadow: '0 4px 12px rgba(39, 174, 96, 0.4)',
                        transition: 'all 0.2s ease',
                        width: '100%',
                        maxWidth: '300px',
                        margin: '20px auto 0'
                      }}
                      onMouseOver={e => {
                        e.currentTarget.style.transform = 'translateY(-2px)';
                        e.currentTarget.style.boxShadow = '0 6px 16px rgba(39, 174, 96, 0.5)';
                      }}
                      onMouseOut={e => {
                        e.currentTarget.style.transform = 'translateY(0)';
                        e.currentTarget.style.boxShadow = '0 4px 12px rgba(39, 174, 96, 0.4)';
                      }}
                    >
                      <span></span> Finalize & Submit Assessment
                    </button>
                  ) : overallPending > 0 ? (
                    <div style={{
                      marginTop: '16px',
                      padding: '10px 16px',
                      background: 'rgba(255,255,255,0.15)',
                      borderRadius: '8px',
                      fontSize: '14px',
                      textAlign: 'center',
                      opacity: 0.9
                    }}>
                      Complete all {overallPending} pending items to finalize
                    </div>
                  ) : null}
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // Completion Celebration Modal
    const CompletionModal = ({ isOpen, onClose, stats, onFinalize }) => {
      if (!isOpen) return null;

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={e => e.stopPropagation()} style={{ maxWidth: '500px' }}>
            <div className="modal-header" style={{ background: 'linear-gradient(135deg, var(--success) 0%, #219a52 100%)', color: 'white', borderRadius: '12px 12px 0 0' }}>
              <h3 style={{ margin: 0 }}>All Standards Scored!</h3>
              <button className="modal-close" onClick={onClose} style={{ color: 'white', background: 'rgba(255,255,255,0.2)' }}></button>
            </div>
            <div className="completion-modal">
              <div className="completion-icon">{Icons.award({ size: 64, color: '#ffd700' })}</div>
              <div className="completion-title">Congratulations!</div>
              <div className="completion-subtitle">
                You have successfully scored all sub-standards.<br />
                Ready to finalize and submit your assessment?
              </div>
              <div className="completion-stats">
                <div className="completion-stat">
                  <div className="completion-stat-value">{stats.percentage}%</div>
                  <div className="completion-stat-label">Overall Score</div>
                </div>
                <div className="completion-stat">
                  <div className="completion-stat-value" style={{ color: 'var(--success)' }}>{stats.fullyMet}</div>
                  <div className="completion-stat-label">Fully Met</div>
                </div>
                <div className="completion-stat">
                  <div className="completion-stat-value" style={{ color: 'var(--warning)' }}>{stats.partial}</div>
                  <div className="completion-stat-label">Partial</div>
                </div>
                <div className="completion-stat">
                  <div className="completion-stat-value" style={{ color: 'var(--danger)' }}>{stats.notMet}</div>
                  <div className="completion-stat-label">Not Met</div>
                </div>
              </div>
              <button className="finalize-btn" onClick={onFinalize}>
                <span></span> Finalize & Submit
              </button>
            </div>
          </div>
        </div>
      );
    };

    // Finalize Confirmation Dialog
    const FinalizeConfirmDialog = ({ isOpen, onClose, onConfirm, stats, isSubmitting }) => {
      if (!isOpen) return null;

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={e => e.stopPropagation()} style={{ maxWidth: '480px' }}>
            <div className="confirm-dialog">
              <div className="confirm-icon"></div>
              <div className="confirm-title">Finalize Assessment?</div>
              <div className="confirm-message">
                You are about to finalize and submit this assessment to Firebase for secure storage.
                <br /><br />
                <strong>Final Score: {stats.percentage}%</strong>
                <br />
                <span style={{ fontSize: '13px', color: 'var(--text-muted)' }}>
                  ({stats.fullyMet} Fully Met, {stats.partial} Partial, {stats.notMet} Not Met, {stats.na} N/A)
                </span>
                <br /><br />
                Once finalized, this assessment will be securely saved and timestamped.
              </div>
              <div className="confirm-buttons">
                <button className="confirm-btn confirm-btn-cancel" onClick={onClose} disabled={isSubmitting}>
                  Cancel
                </button>
                <button className="confirm-btn confirm-btn-submit" onClick={onConfirm} disabled={isSubmitting}>
                  {isSubmitting ? ' Submitting...' : ' Confirm & Submit'}
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // Modern Toast Notification Component
    const ToastNotification = ({ toasts, onDismiss }) => {
      if (!toasts || toasts.length === 0) return null;

      return (
        <div className="toast-container">
          {toasts.map(toast => (
            <div key={toast.id} className={`toast ${toast.type} ${toast.closing ? 'closing' : ''}`}>
              <div className={`toast-icon ${toast.type}`}>
                {toast.type === 'success' ? '' : toast.type === 'error' ? '' : ''}
              </div>
              <div className="toast-content">
                <div className="toast-title">{toast.title}</div>
                <div className="toast-message">{toast.message}</div>
              </div>
              <button className="toast-close" onClick={() => onDismiss(toast.id)}></button>
            </div>
          ))}
        </div>
      );
    };

    // Modern Confirm Dialog Component
    const ModernConfirmDialog = ({ isOpen, onClose, onConfirm, title, message, confirmText, cancelText, type }) => {
      if (!isOpen) return null;

      const iconMap = {
        warning: '',
        danger: '',
        info: ''
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal modern-confirm" onClick={e => e.stopPropagation()}>
            <div className="modern-confirm-body">
              <div className={`modern-confirm-icon ${type || 'warning'}`}>
                {iconMap[type] || iconMap.warning}
              </div>
              <div className="modern-confirm-title">{title}</div>
              <div className="modern-confirm-message">{message}</div>
              <div className="modern-confirm-buttons">
                <button className="modern-btn modern-btn-secondary" onClick={onClose}>
                  {cancelText || 'Cancel'}
                </button>
                <button
                  className={`modern-btn ${type === 'danger' ? 'modern-btn-danger' : 'modern-btn-primary'}`}
                  onClick={() => { onConfirm(); onClose(); }}
                >
                  {confirmText || 'Confirm'}
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // Assessment Setup Modal (Required before starting)
    const AssessmentSetupModal = ({ isOpen, onClose, onStart, existingData, isEditing = false }) => {
      const [formData, setFormData] = useState({
        centerName: '',
        coordinatorName: '',
        coordinatorPhone: '',
        coordinatorEmail: '',
        configuration: 'A1'
      });
      const [errors, setErrors] = useState({});

      const configOptions = [
        { value: 'A1', label: 'A - Surveyor 1', desc: 'LD, PC, DL, IPC (180 sub-standards)' },
        { value: 'A2', label: 'A - Surveyor 2', desc: 'LD, PC, MOI, FMS (169 sub-standards)' },
        { value: 'B', label: 'B - Full Survey', desc: 'All 6 Domains: LD, PC, DL, IPC, MOI, FMS (349 sub-standards)' }
      ];

      useEffect(() => {
        if (existingData) {
          setFormData({ ...existingData, configuration: existingData.configuration || 'A1' });
        } else {
          setFormData({
            centerName: '',
            coordinatorName: '',
            coordinatorPhone: '',
            coordinatorEmail: '',
            configuration: 'A1'
          });
        }
        setErrors({});
      }, [existingData, isOpen]);

      const validateForm = () => {
        const newErrors = {};
        if (!formData.centerName.trim()) newErrors.centerName = 'Center name is required';
        if (!formData.coordinatorName.trim()) newErrors.coordinatorName = 'Coordinator name is required';
        if (!formData.coordinatorPhone.trim()) {
          newErrors.coordinatorPhone = 'Phone number is required';
        } else if (!/^[\d\s+\-()]+$/.test(formData.coordinatorPhone)) {
          newErrors.coordinatorPhone = 'Invalid phone number format';
        }
        if (!formData.coordinatorEmail.trim()) {
          newErrors.coordinatorEmail = 'Email is required';
        } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.coordinatorEmail)) {
          newErrors.coordinatorEmail = 'Invalid email format';
        }
        setErrors(newErrors);
        return Object.keys(newErrors).length === 0;
      };

      const handleSubmit = (e) => {
        e.preventDefault();
        if (validateForm()) {
          onStart(formData);
        }
      };

      if (!isOpen) return null;

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal center-form-modal" onClick={e => e.stopPropagation()}>
            <div className="center-form-header" style={{ position: 'relative' }}>
              {/* Close Button */}
              <button
                onClick={onClose}
                style={{
                  position: 'absolute',
                  top: '12px',
                  right: '12px',
                  background: 'transparent',
                  border: 'none',
                  fontSize: '24px',
                  color: 'var(--text-muted)',
                  cursor: 'pointer',
                  padding: '4px 8px',
                  borderRadius: '4px',
                  lineHeight: 1
                }}
                onMouseOver={e => e.currentTarget.style.color = 'var(--danger)'}
                onMouseOut={e => e.currentTarget.style.color = 'var(--text-muted)'}
                title="Close"
              >
                
              </button>
              <h3 style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                {isEditing ? Icons.edit({ size: 20, color: 'var(--accent)' }) : Icons.building({ size: 20, color: 'var(--primary)' })}
                {isEditing ? 'Edit Assessment Details' : 'New Assessment'}
              </h3>
              <p>{isEditing ? 'Update the dental center information' : 'Enter the dental center details to begin'}</p>
            </div>
            <form onSubmit={handleSubmit}>
              <div className="center-form-body">
                <div className="form-group">
                  <label className="form-label">
                    Dental Center Name <span className="required">*</span>
                  </label>
                  <input
                    type="text"
                    className={`form-input ${errors.centerName ? 'error' : ''}`}
                    placeholder="Enter dental center name"
                    value={formData.centerName}
                    onChange={e => setFormData({ ...formData, centerName: e.target.value })}
                  />
                  {errors.centerName && <div className="form-error">{errors.centerName}</div>}
                </div>

                <div className="form-group">
                  <label className="form-label">
                    Coordinator Name <span className="required">*</span>
                  </label>
                  <input
                    type="text"
                    className={`form-input ${errors.coordinatorName ? 'error' : ''}`}
                    placeholder="Enter coordinator's full name"
                    value={formData.coordinatorName}
                    onChange={e => setFormData({ ...formData, coordinatorName: e.target.value })}
                  />
                  {errors.coordinatorName && <div className="form-error">{errors.coordinatorName}</div>}
                </div>

                <div className="form-group">
                  <label className="form-label">
                    Survey Configuration <span className="required">*</span>
                  </label>
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                    {configOptions.map(opt => (
                      <label key={opt.value} style={{
                        display: 'flex',
                        alignItems: 'center',
                        padding: '12px 16px',
                        background: formData.configuration === opt.value ? 'rgba(52, 152, 219, 0.1)' : 'var(--bg-secondary)',
                        border: formData.configuration === opt.value ? '2px solid var(--accent)' : '1px solid var(--border)',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        opacity: 1,
                        transition: 'all 0.2s ease'
                      }}>
                        <input
                          type="radio"
                          name="configuration"
                          value={opt.value}
                          checked={formData.configuration === opt.value}
                          onChange={e => setFormData({ ...formData, configuration: e.target.value })}
                          style={{ marginRight: '12px', accentColor: 'var(--accent)' }}
                        />
                        <div>
                          <div style={{ fontWeight: 600, color: formData.configuration === opt.value ? 'var(--accent)' : 'var(--text-primary)' }}>{opt.label}</div>
                          <div style={{ fontSize: '12px', color: 'var(--text-muted)' }}>{opt.desc}</div>
                        </div>
                      </label>
                    ))}
                  </div>
                </div>

                <div className="form-row">
                  <div className="form-group">
                    <label className="form-label">
                      Phone Number <span className="required">*</span>
                    </label>
                    <div style={{ display: 'flex', alignItems: 'center' }}>
                      <span style={{
                        padding: '10px 12px',
                        background: 'var(--bg-hover)',
                        border: '1px solid var(--border)',
                        borderRight: 'none',
                        borderRadius: 'var(--radius-md) 0 0 var(--radius-md)',
                        color: 'var(--text-secondary)',
                        fontSize: '14px',
                        fontWeight: 500
                      }}>+966</span>
                      <input
                        type="tel"
                        className={`form-input ${errors.coordinatorPhone ? 'error' : ''}`}
                        style={{ borderRadius: '0 var(--radius-md) var(--radius-md) 0', flex: 1 }}
                        placeholder="5XXXXXXXX"
                        value={formData.coordinatorPhone}
                        onChange={e => setFormData({ ...formData, coordinatorPhone: e.target.value.replace(/\D/g, '').slice(0, 9) })}
                      />
                    </div>
                    {errors.coordinatorPhone && <div className="form-error">{errors.coordinatorPhone}</div>}
                  </div>

                  <div className="form-group">
                    <label className="form-label">
                      Email <span className="required">*</span>
                    </label>
                    <input
                      type="email"
                      className={`form-input ${errors.coordinatorEmail ? 'error' : ''}`}
                      placeholder="email@example.com"
                      value={formData.coordinatorEmail}
                      onChange={e => setFormData({ ...formData, coordinatorEmail: e.target.value })}
                    />
                    {errors.coordinatorEmail && <div className="form-error">{errors.coordinatorEmail}</div>}
                  </div>
                </div>

                <div className="form-actions">
                  {(existingData || isEditing) && (
                    <button type="button" className="modern-btn modern-btn-secondary" onClick={onClose}>
                      Cancel
                    </button>
                  )}
                  <button type="submit" className="modern-btn modern-btn-success">
                    {isEditing ? 'Save Changes' : existingData ? 'Update & Continue' : 'Start Assessment'}
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      );
    };

    // Add Center Modal
    const CenterModal = ({ isOpen, onClose, onSave, center }) => {
      const [formData, setFormData] = useState({
        name: '', location: '', licenseNumber: '',
        contactPerson: '', phone: '', email: '', hasDentalLab: false
      });

      useEffect(() => {
        if (center) setFormData(center);
        else setFormData({
          name: '', location: '', licenseNumber: '',
          contactPerson: '', phone: '', email: '', hasDentalLab: false
        });
      }, [center, isOpen]);

      if (!isOpen) return null;

      const handleSubmit = (e) => {
        e.preventDefault();
        onSave({ ...formData, id: center?.id || Date.now().toString(), createdAt: center?.createdAt || new Date().toISOString() });
        onClose();
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h3>{center ? 'Edit Center' : 'Add New Center'}</h3>
              <button className="modal-close" onClick={onClose}></button>
            </div>
            <form onSubmit={handleSubmit}>
              <div className="modal-body">
                <div className="form-group">
                  <label className="form-label">Center Name *</label>
                  <input type="text" className="form-input" required
                    value={formData.name}
                    onChange={e => setFormData({ ...formData, name: e.target.value })} />
                </div>
                <div className="form-row">
                  <div className="form-group">
                    <label className="form-label">Location / City</label>
                    <input type="text" className="form-input"
                      value={formData.location}
                      onChange={e => setFormData({ ...formData, location: e.target.value })} />
                  </div>
                  <div className="form-group">
                    <label className="form-label">License Number</label>
                    <input type="text" className="form-input"
                      value={formData.licenseNumber}
                      onChange={e => setFormData({ ...formData, licenseNumber: e.target.value })} />
                  </div>
                </div>
                <div className="form-row">
                  <div className="form-group">
                    <label className="form-label">Contact Person</label>
                    <input type="text" className="form-input"
                      value={formData.contactPerson}
                      onChange={e => setFormData({ ...formData, contactPerson: e.target.value })} />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Phone</label>
                    <div style={{ display: 'flex', alignItems: 'center' }}>
                      <span style={{
                        padding: '10px 12px',
                        background: 'var(--bg-hover)',
                        border: '1px solid var(--border)',
                        borderRight: 'none',
                        borderRadius: 'var(--radius-md) 0 0 var(--radius-md)',
                        color: 'var(--text-secondary)',
                        fontSize: '14px',
                        fontWeight: 500
                      }}>+966</span>
                      <input type="tel" className="form-input"
                        style={{ borderRadius: '0 var(--radius-md) var(--radius-md) 0', flex: 1 }}
                        placeholder="5XXXXXXXX"
                        value={formData.phone}
                        onChange={e => setFormData({ ...formData, phone: e.target.value.replace(/\D/g, '').slice(0, 9) })} />
                    </div>
                  </div>
                </div>
                <div className="form-group">
                  <label className="form-label">Email</label>
                  <input type="email" className="form-input"
                    value={formData.email}
                    onChange={e => setFormData({ ...formData, email: e.target.value })} />
                </div>
                <div className="form-group">
                  <label style={{ display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer' }}>
                    <input type="checkbox" checked={formData.hasDentalLab}
                      onChange={e => setFormData({ ...formData, hasDentalLab: e.target.checked })} />
                    <span>Has Dental Laboratory</span>
                  </label>
                </div>
              </div>
              <div className="modal-footer">
                <button type="button" className="btn btn-outline-dark" onClick={onClose}>Cancel</button>
                <button type="submit" className="btn btn-primary">Save Center</button>
              </div>
            </form>
          </div>
        </div>
      );
    };

    // ============================================
    // PAGES
    // ============================================

    // SCORING HOME PAGE - Entry point for scoring with New/Test options
    const ScoringHomePage = ({ onNewAssessment, onTestDrive }) => {
      return (
        <div style={{
          minHeight: 'calc(100vh - 140px)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          background: 'linear-gradient(180deg, #f8fafc 0%, #e2e8f0 100%)',
          padding: '40px 20px'
        }}>
          {/* Background Watermark */}
          <div style={{
            position: 'absolute',
            top: '50%',
            left: '50%',
            transform: 'translate(-50%, -50%)',
            opacity: 0.06,
            pointerEvents: 'none',
            zIndex: 0
          }}>
            <img src="assets/logo-sh.png" alt="" style={{ width: '400px', height: 'auto' }} />
          </div>

          <div style={{ maxWidth: '900px', width: '100%', position: 'relative', zIndex: 1 }}>
            {/* Header */}
            <div style={{ textAlign: 'center', marginBottom: '48px' }}>
              <h1 style={{
                fontSize: '36px',
                fontWeight: 700,
                color: '#1e3a5f',
                marginBottom: '12px',
                fontFamily: "'Lora', serif"
              }}>Start Scoring</h1>
              <p style={{
                fontSize: '18px',
                color: '#64748b',
                fontFamily: "'Lora', serif"
              }}>Choose how you want to begin your assessment</p>
            </div>

            {/* Two Cards */}
            <div style={{
              display: 'grid',
              gridTemplateColumns: 'repeat(auto-fit, minmax(320px, 1fr))',
              gap: '32px'
            }}>
              {/* New Assessment Card */}
              <div
                onClick={onNewAssessment}
                style={{
                  background: 'linear-gradient(145deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.9) 100%)',
                  backdropFilter: 'blur(20px)',
                  borderRadius: '24px',
                  padding: '40px',
                  border: '1px solid rgba(255,255,255,0.8)',
                  boxShadow: '0 20px 60px rgba(30, 58, 95, 0.12)',
                  cursor: 'pointer',
                  transition: 'all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                  position: 'relative',
                  overflow: 'hidden'
                }}
                onMouseOver={e => {
                  e.currentTarget.style.transform = 'translateY(-8px)';
                  e.currentTarget.style.boxShadow = '0 30px 80px rgba(30, 58, 95, 0.18)';
                }}
                onMouseOut={e => {
                  e.currentTarget.style.transform = 'translateY(0)';
                  e.currentTarget.style.boxShadow = '0 20px 60px rgba(30, 58, 95, 0.12)';
                }}
              >
                {/* Icon */}
                <div style={{
                  width: '72px',
                  height: '72px',
                  background: 'linear-gradient(135deg, #1e3a5f 0%, #3498db 100%)',
                  borderRadius: '20px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  marginBottom: '24px',
                  boxShadow: '0 8px 24px rgba(52, 152, 219, 0.3)'
                }}>
                  <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="12" y1="18" x2="12" y2="12"/>
                    <line x1="9" y1="15" x2="15" y2="15"/>
                  </svg>
                </div>

                <h2 style={{
                  fontSize: '24px',
                  fontWeight: 700,
                  color: '#1e3a5f',
                  marginBottom: '12px',
                  fontFamily: "'Lora', serif"
                }}>New Assessment</h2>

                <p style={{
                  fontSize: '15px',
                  color: '#64748b',
                  lineHeight: 1.6,
                  marginBottom: '24px',
                  fontFamily: "'Lora', serif"
                }}>
                  Start a formal assessment for a dental center. Enter center details and conduct a complete evaluation with data persistence.
                </p>

                <div style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px',
                  color: '#3498db',
                  fontWeight: 600,
                  fontSize: '14px'
                }}>
                  <span>Get Started</span>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M5 12h14M12 5l7 7-7 7"/>
                  </svg>
                </div>

                {/* Badge */}
                <div style={{
                  position: 'absolute',
                  top: '20px',
                  right: '20px',
                  background: 'linear-gradient(135deg, #27ae60 0%, #2ecc71 100%)',
                  color: 'white',
                  padding: '6px 12px',
                  borderRadius: '20px',
                  fontSize: '11px',
                  fontWeight: 600,
                  textTransform: 'uppercase',
                  letterSpacing: '0.5px'
                }}>Official</div>
              </div>

              {/* Test Drive Card */}
              <div
                onClick={onTestDrive}
                style={{
                  background: 'linear-gradient(145deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.9) 100%)',
                  backdropFilter: 'blur(20px)',
                  borderRadius: '24px',
                  padding: '40px',
                  border: '1px solid rgba(255,255,255,0.8)',
                  boxShadow: '0 20px 60px rgba(30, 58, 95, 0.12)',
                  cursor: 'pointer',
                  transition: 'all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                  position: 'relative',
                  overflow: 'hidden'
                }}
                onMouseOver={e => {
                  e.currentTarget.style.transform = 'translateY(-8px)';
                  e.currentTarget.style.boxShadow = '0 30px 80px rgba(30, 58, 95, 0.18)';
                }}
                onMouseOut={e => {
                  e.currentTarget.style.transform = 'translateY(0)';
                  e.currentTarget.style.boxShadow = '0 20px 60px rgba(30, 58, 95, 0.12)';
                }}
              >
                {/* Icon */}
                <div style={{
                  width: '72px',
                  height: '72px',
                  background: 'linear-gradient(135deg, #f39c12 0%, #e67e22 100%)',
                  borderRadius: '20px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  marginBottom: '24px',
                  boxShadow: '0 8px 24px rgba(243, 156, 18, 0.3)'
                }}>
                  <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                  </svg>
                </div>

                <h2 style={{
                  fontSize: '24px',
                  fontWeight: 700,
                  color: '#1e3a5f',
                  marginBottom: '12px',
                  fontFamily: "'Lora', serif"
                }}>Test Drive</h2>

                <p style={{
                  fontSize: '15px',
                  color: '#64748b',
                  lineHeight: 1.6,
                  marginBottom: '24px',
                  fontFamily: "'Lora', serif"
                }}>
                  Explore the scoring interface without committing to an assessment. Perfect for training and familiarization. No data saved.
                </p>

                <div style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px',
                  color: '#f39c12',
                  fontWeight: 600,
                  fontSize: '14px'
                }}>
                  <span>Try Now</span>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M5 12h14M12 5l7 7-7 7"/>
                  </svg>
                </div>

                {/* Badge */}
                <div style={{
                  position: 'absolute',
                  top: '20px',
                  right: '20px',
                  background: 'linear-gradient(135deg, #f39c12 0%, #e67e22 100%)',
                  color: 'white',
                  padding: '6px 12px',
                  borderRadius: '20px',
                  fontSize: '11px',
                  fontWeight: 600,
                  textTransform: 'uppercase',
                  letterSpacing: '0.5px'
                }}>Practice</div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // SCORING PAGE - PRIMARY VIEW
    const ScoringPage = ({ scores, setScores, saving, isFinalized, finalizedData, viewingMode, setViewingMode, onFinalize, onReset, onGoHome, showToast, assessmentDetails, onEditDetails, onNavigateToHistory, onConfigChange }) => {
      // Get chapters based on current configuration
      const activeChapters = useMemo(() => {
        const config = assessmentDetails?.configuration || 'A1';
        return getChaptersByConfig(config);
      }, [assessmentDetails?.configuration]);

      const [activeChapter, setActiveChapter] = useState('LD');
      const [activeStandard, setActiveStandard] = useState(null);
      const [activityFilter, setActivityFilter] = useState('ALL');
      const [searchQuery, setSearchQuery] = useState('');
      const [showSummary, setShowSummary] = useState(false);
      const [sidebarOpen, setSidebarOpen] = useState(true);
      const [scoreFilter, setScoreFilter] = useState(null); // null, 'full', 'partial', 'not-met', 'na', 'unscored'
      const [showCompletionModal, setShowCompletionModal] = useState(false);
      const [showConfirmDialog, setShowConfirmDialog] = useState(false);
      const [isSubmitting, setIsSubmitting] = useState(false);
      // Track previous pending count to detect active completion (not page load)
      const prevPendingRef = useRef(null);
      const isInitialLoadRef = useRef(true);

      // Finalized edit protection
      const [allowFinalizedEdit, setAllowFinalizedEdit] = useState(false);
      const [showFinalizedWarning, setShowFinalizedWarning] = useState(false);
      const [pendingScoreChange, setPendingScoreChange] = useState(null);
      const [isModifiedMode, setIsModifiedMode] = useState(false); // Track if we're modifying a previously finalized assessment
      const [showRefinalizeAuth, setShowRefinalizeAuth] = useState(false); // Show authentication for re-finalizing modified assessment
      const [refinalizePassword, setRefinalizePassword] = useState('');
      const [refinalizeError, setRefinalizeError] = useState('');

      // Expanded domains state for Configuration B sidebar (all expanded by default)
      const [expandedDomains, setExpandedDomains] = useState({
        LD: true, PC: true, DL: true, IPC: true, MOI: true, FMS: true
      });

      const toggleDomainExpanded = (domainId) => {
        setExpandedDomains(prev => ({ ...prev, [domainId]: !prev[domainId] }));
      };

      const expandAllDomains = () => {
        setExpandedDomains({ LD: true, PC: true, DL: true, IPC: true, MOI: true, FMS: true });
      };

      const collapseAllDomains = () => {
        setExpandedDomains({ LD: false, PC: false, DL: false, IPC: false, MOI: false, FMS: false });
      };

      const currentChapter = activeChapters.find(c => c.id === activeChapter);
      const currentStandards = currentChapter?.standards || [];
      const allSubstandards = useMemo(() => getAllSubstandards(currentStandards), [currentStandards]);

      const filteredSubstandards = useMemo(() => {
        let filtered = allSubstandards;
        if (activeStandard) filtered = filtered.filter(s => s.standardId === activeStandard);
        if (activityFilter !== 'ALL') filtered = filtered.filter(s => s.activityType === activityFilter);
        if (searchQuery) {
          const query = searchQuery.toLowerCase();
          filtered = filtered.filter(s => s.code.toLowerCase().includes(query) || s.text.toLowerCase().includes(query));
        }
        // Score status filter
        if (scoreFilter) {
          filtered = filtered.filter(s => {
            const score = scores[s.id];
            if (scoreFilter === 'full') return score?.value === 2;
            if (scoreFilter === 'partial') return score?.value === 1;
            if (scoreFilter === 'not-met') return score?.value === 0;
            if (scoreFilter === 'na') return score?.value === 'NA';
            if (scoreFilter === 'unscored') return score?.value === undefined || score?.value === null;
            return true;
          });
        }
        return filtered;
      }, [allSubstandards, activeStandard, activityFilter, searchQuery, scoreFilter, scores]);

      // Group filtered substandards by mother standard (for "All Standards" view)
      const groupedSubstandards = useMemo(() => {
        return groupSubstandardsByStandard(filteredSubstandards);
      }, [filteredSubstandards]);

      const handleScoreChange = useCallback((substandardId, value, comment, location) => {
        // Check if assessment is finalized and user hasn't allowed editing
        if (isFinalized && !allowFinalizedEdit) {
          // Store the pending change and show warning
          setPendingScoreChange({ substandardId, value, comment, location });
          setShowFinalizedWarning(true);
          return;
        }

        setScores(prev => ({
          ...prev,
          [substandardId]: { value, comment, location, scoredAt: new Date().toISOString() }
        }));
      }, [setScores, isFinalized, allowFinalizedEdit]);

      const scoreStats = useMemo(() => {
        const total = allSubstandards.length;
        const scored = Object.keys(scores).filter(id =>
          allSubstandards.some(s => s.id === id) && scores[id]?.value !== undefined && scores[id]?.value !== null
        ).length;
        const naCount = Object.entries(scores).filter(([id, s]) =>
          allSubstandards.some(sub => sub.id === id) && s?.value === 'NA'
        ).length;
        const fullyMet = Object.entries(scores).filter(([id, s]) =>
          allSubstandards.some(sub => sub.id === id) && s?.value === 2
        ).length;
        const partialMet = Object.entries(scores).filter(([id, s]) =>
          allSubstandards.some(sub => sub.id === id) && s?.value === 1
        ).length;
        const notMet = Object.entries(scores).filter(([id, s]) =>
          allSubstandards.some(sub => sub.id === id) && s?.value === 0
        ).length;
        const applicableCount = fullyMet + partialMet + notMet;
        const maxPossible = applicableCount * 2;
        const earnedPoints = (fullyMet * 2) + (partialMet * 1);
        const percentage = maxPossible > 0 ? Math.round((earnedPoints / maxPossible) * 100 * 100) / 100 : 0;
        return { total, scored, naCount, fullyMet, partialMet, notMet, percentage, applicableCount };
      }, [scores, allSubstandards]);

      // Calculate overall pending across ALL chapters
      const overallPending = useMemo(() => {
        let totalSubs = 0;
        let scoredSubs = 0;
        activeChapters.forEach(ch => {
          if (!ch.placeholder) {
            const subs = getAllSubstandards(ch.standards);
            totalSubs += subs.length;
            subs.forEach(sub => {
              if (scores[sub.id]?.value !== undefined && scores[sub.id]?.value !== null) {
                scoredSubs++;
              }
            });
          }
        });
        return totalSubs - scoredSubs;
      }, [scores, activeChapters]);

      // Calculate overall stats across ALL chapters
      const overallStats = useMemo(() => {
        let total = 0, scored = 0, fullyMet = 0, partial = 0, notMet = 0, na = 0;
        activeChapters.forEach(ch => {
          if (!ch.placeholder) {
            const subs = getAllSubstandards(ch.standards);
            total += subs.length;
            subs.forEach(sub => {
              const score = scores[sub.id];
              if (score?.value !== undefined && score?.value !== null) {
                scored++;
                if (score.value === 'NA') na++;
                else if (score.value === 2) fullyMet++;
                else if (score.value === 1) partial++;
                else if (score.value === 0) notMet++;
              }
            });
          }
        });
        const applicable = fullyMet + partial + notMet;
        const maxPossible = applicable * 2;
        const earnedPoints = (fullyMet * 2) + (partial * 1);
        const percentage = maxPossible > 0 ? Math.round((earnedPoints / maxPossible) * 100 * 100) / 100 : 0;
        return { total, scored, fullyMet, partial, notMet, na, percentage, applicable };
      }, [scores, activeChapters]);

      // Detect completion and show celebration modal - only on ACTIVE completion, not page load
      useEffect(() => {
        // Skip showing modal on initial page load
        if (isInitialLoadRef.current) {
          isInitialLoadRef.current = false;
          prevPendingRef.current = overallPending;
          return;
        }

        // Only show modal when user actively completes the last item
        // (pending transitions from >0 to 0, not when it's already 0 on load)
        const wasIncomplete = prevPendingRef.current !== null && prevPendingRef.current > 0;
        const isNowComplete = overallPending === 0 && overallStats.total > 0;

        if (wasIncomplete && isNowComplete && !isFinalized) {
          setShowCompletionModal(true);
        }

        // Update the ref for next comparison
        prevPendingRef.current = overallPending;
      }, [overallPending, overallStats.total, isFinalized]);

      // Handle finalization
      const handleFinalizeClick = () => {
        setShowCompletionModal(false);
        setShowConfirmDialog(true);
      };

      const handleConfirmFinalize = async () => {
        setIsSubmitting(true);
        const wasModifiedMode = isModifiedMode; // Track if this was a re-finalization

        try {
          const result = await onFinalize(overallStats);
          if (result.success) {
            setShowConfirmDialog(false);

            // Reset modification states
            if (wasModifiedMode) {
              setIsModifiedMode(false);
              setAllowFinalizedEdit(false);
              showToast('success', 'Assessment Re-Finalized!', 'Your modifications have been saved successfully.');
            } else {
              showToast('success', 'Assessment Submitted!', `Your assessment has been finalized and saved securely. Submission ID: ${result.data.submissionId}`);
            }
          } else {
            showToast('error', 'Submission Failed', result.error || 'An error occurred while finalizing the assessment.');
          }
        } catch (e) {
          showToast('error', 'Error', e.message || 'An unexpected error occurred.');
        }
        setIsSubmitting(false);
      };

      // Get scored count per standard for sidebar
      const getScoredCountForStandard = (stdId) => {
        const stdsubs = allSubstandards.filter(s => s.standardId === stdId);
        return stdsubs.filter(s => scores[s.id]?.value !== undefined && scores[s.id]?.value !== null).length;
      };

      const getScoreColorClass = (p) => p >= 90 ? 'excellent' : p >= 75 ? 'good' : p >= 60 ? 'needs-improvement' : 'critical';

      // Format phone for WhatsApp (remove spaces, dashes, add country code if needed)
      const formatWhatsApp = (phone) => {
        if (!phone) return '';
        let clean = phone.replace(/[\s\-()]/g, '');
        if (!clean.startsWith('+')) {
          clean = '+966' + clean.replace(/^0/, '');
        }
        return clean;
      };

      // Show success screen if finalized (but NOT when in viewing mode - we want to see the full interface)
      if (isFinalized && finalizedData && !viewingMode) {
        return (
          <div className="page-container" style={{ maxWidth: '700px', margin: '0 auto', padding: '60px 24px', textAlign: 'center' }}>
            <div style={{
              background: 'linear-gradient(135deg, var(--success) 0%, #2ecc71 100%)',
              borderRadius: '24px',
              padding: '48px',
              color: 'white',
              marginBottom: '32px',
              boxShadow: '0 20px 40px rgba(39, 174, 96, 0.3)'
            }}>
              <div style={{ marginBottom: '20px' }}>{Icons.award({ size: 72, color: '#ffd700' })}</div>
              <h1 style={{ fontSize: '32px', fontWeight: '700', marginBottom: '12px' }}>Assessment Complete!</h1>
              <p style={{ fontSize: '18px', opacity: 0.95, marginBottom: '24px' }}>
                {assessmentDetails?.centerName || 'Your assessment'} has been finalized and securely saved.
              </p>
              <div style={{
                display: 'inline-block',
                background: 'rgba(255,255,255,0.2)',
                padding: '16px 32px',
                borderRadius: '16px',
                fontSize: '48px',
                fontWeight: '700'
              }}>
                {finalizedData.percentage || overallStats.percentage}%
              </div>
              <p style={{ fontSize: '14px', opacity: 0.8, marginTop: '12px' }}>Overall Compliance Score</p>
            </div>

            {/* Stats Summary */}
            <div style={{
              display: 'grid',
              gridTemplateColumns: 'repeat(4, 1fr)',
              gap: '16px',
              marginBottom: '32px'
            }}>
              <div style={{ background: 'white', padding: '20px', borderRadius: '16px', boxShadow: 'var(--shadow-md)' }}>
                <div style={{ fontSize: '28px', fontWeight: '700', color: 'var(--success)' }}>{finalizedData.fullyMet || overallStats.fullyMet}</div>
                <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '4px' }}>Fully Met</div>
              </div>
              <div style={{ background: 'white', padding: '20px', borderRadius: '16px', boxShadow: 'var(--shadow-md)' }}>
                <div style={{ fontSize: '28px', fontWeight: '700', color: 'var(--warning)' }}>{finalizedData.partialMet || overallStats.partial}</div>
                <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '4px' }}>Partial</div>
              </div>
              <div style={{ background: 'white', padding: '20px', borderRadius: '16px', boxShadow: 'var(--shadow-md)' }}>
                <div style={{ fontSize: '28px', fontWeight: '700', color: 'var(--danger)' }}>{finalizedData.notMet || overallStats.notMet}</div>
                <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '4px' }}>Not Met</div>
              </div>
              <div style={{ background: 'white', padding: '20px', borderRadius: '16px', boxShadow: 'var(--shadow-md)' }}>
                <div style={{ fontSize: '28px', fontWeight: '700', color: 'var(--neutral)' }}>{finalizedData.naCount || overallStats.na}</div>
                <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '4px' }}>N/A</div>
              </div>
            </div>

            {/* Submission Info */}
            <div style={{
              background: 'var(--bg-hover)',
              padding: '20px',
              borderRadius: '12px',
              marginBottom: '32px',
              fontSize: '14px',
              color: 'var(--text-secondary)'
            }}>
              <div style={{ marginBottom: '8px' }}>
                <strong>Submission ID:</strong>{' '}
                <code style={{ background: 'white', padding: '4px 8px', borderRadius: '4px' }}>{finalizedData.submissionId}</code>
              </div>
              <div>
                <strong>Submitted:</strong>{' '}
                {new Date(finalizedData.submittedAt).toLocaleString('en-US', {
                  year: 'numeric', month: 'long', day: 'numeric',
                  hour: '2-digit', minute: '2-digit'
                })}
              </div>
            </div>

            {/* Action Buttons */}
            <div style={{ display: 'flex', gap: '16px', justifyContent: 'center', flexWrap: 'wrap' }}>
              <button
                onClick={onGoHome}
                className="modern-btn"
                style={{
                  padding: '16px 32px',
                  fontSize: '16px',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px',
                  background: 'linear-gradient(135deg, #1e3a5f 0%, #2d5a8a 100%)',
                  color: 'white',
                  border: 'none',
                  borderRadius: '12px',
                  cursor: 'pointer',
                  fontWeight: 600,
                  boxShadow: '0 4px 15px rgba(30, 58, 95, 0.3)'
                }}
              >
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                  <polyline points="9,22 9,12 15,12 15,22" />
                </svg>
                Scoring Home
              </button>
              <button
                onClick={onNavigateToHistory}
                className="modern-btn modern-btn-primary"
                style={{ padding: '16px 32px', fontSize: '16px', display: 'flex', alignItems: 'center', gap: '8px' }}
              >
                {Icons.clipboard({ size: 18 })} View in History
              </button>
              <button
                onClick={onReset}
                className="modern-btn modern-btn-secondary"
                style={{ padding: '16px 32px', fontSize: '16px', display: 'flex', alignItems: 'center', gap: '8px' }}
              >
                {Icons.plus({ size: 18 })} Start New Assessment
              </button>
            </div>
          </div>
        );
      }

      return (
        <>
          {/* Finalized Edit Warning Dialog */}
          {showFinalizedWarning && (
            <div style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'rgba(0,0,0,0.5)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              zIndex: 1000,
              backdropFilter: 'blur(4px)'
            }}>
              <div style={{
                background: 'white',
                borderRadius: '20px',
                padding: '32px',
                maxWidth: '450px',
                width: '90%',
                boxShadow: '0 25px 50px rgba(0,0,0,0.25)',
                textAlign: 'center'
              }}>
                {/* Warning Icon */}
                <div style={{
                  width: '70px',
                  height: '70px',
                  background: 'linear-gradient(135deg, #f39c12 0%, #e67e22 100%)',
                  borderRadius: '50%',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  margin: '0 auto 20px',
                  boxShadow: '0 8px 20px rgba(243, 156, 18, 0.3)'
                }}>
                  <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                  </svg>
                </div>

                <h3 style={{
                  fontSize: '22px',
                  fontWeight: 700,
                  color: '#1e3a5f',
                  marginBottom: '12px'
                }}>Assessment Finalized</h3>

                <p style={{
                  color: '#64748b',
                  fontSize: '15px',
                  lineHeight: 1.6,
                  marginBottom: '28px'
                }}>
                  This assessment has already been finalized and submitted. Modifying scores will re-open the assessment for editing.
                  <br /><br />
                  <strong style={{ color: '#e67e22' }}>Do you want to override and modify?</strong>
                </p>

                <div style={{ display: 'flex', gap: '12px', justifyContent: 'center' }}>
                  <button
                    onClick={() => {
                      setShowFinalizedWarning(false);
                      setPendingScoreChange(null);
                    }}
                    style={{
                      padding: '14px 28px',
                      background: '#f1f5f9',
                      border: 'none',
                      borderRadius: '12px',
                      color: '#64748b',
                      fontSize: '15px',
                      fontWeight: 600,
                      cursor: 'pointer',
                      transition: 'all 0.2s'
                    }}
                  >
                    Cancel
                  </button>
                  <button
                    onClick={() => {
                      // Allow editing and apply the pending change
                      setAllowFinalizedEdit(true);
                      setIsModifiedMode(true); // Mark as modified mode for re-finalization
                      setShowFinalizedWarning(false);
                      if (pendingScoreChange) {
                        const { substandardId, value, comment, location } = pendingScoreChange;
                        setScores(prev => ({
                          ...prev,
                          [substandardId]: { value, comment, location, scoredAt: new Date().toISOString() }
                        }));
                        setPendingScoreChange(null);
                      }
                      showToast('warning', 'Modification Mode', 'Assessment is now in modification mode. Re-finalize when done.');
                    }}
                    style={{
                      padding: '14px 28px',
                      background: 'linear-gradient(135deg, #f39c12 0%, #e67e22 100%)',
                      border: 'none',
                      borderRadius: '12px',
                      color: 'white',
                      fontSize: '15px',
                      fontWeight: 700,
                      cursor: 'pointer',
                      boxShadow: '0 4px 15px rgba(243, 156, 18, 0.3)',
                      transition: 'all 0.2s'
                    }}
                  >
                    Override & Modify
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Edit Mode Banner (when overriding finalized assessment) */}
          {allowFinalizedEdit && isFinalized && !viewingMode && (
            <div style={{
              background: 'linear-gradient(135deg, #dc2626 0%, #b91c1c 100%)',
              color: 'white',
              padding: '12px 24px',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              boxShadow: '0 2px 8px rgba(220, 38, 38, 0.3)',
              animation: 'pulse-banner 2s ease-in-out infinite'
            }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
                <span style={{ fontWeight: 700 }}> MODIFICATION MODE</span>
                <span style={{ opacity: 0.95, fontSize: '13px' }}> Make your changes and re-finalize</span>
              </div>
              <div style={{ display: 'flex', gap: '12px' }}>
                <button
                  onClick={() => {
                    setAllowFinalizedEdit(false);
                    setIsModifiedMode(false);
                    showToast('info', 'Modifications Cancelled', 'Assessment reverted to finalized state.');
                  }}
                  style={{
                    background: 'rgba(255,255,255,0.2)',
                    border: '1px solid rgba(255,255,255,0.3)',
                    color: 'white',
                    padding: '8px 16px',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    fontWeight: 600,
                    fontSize: '13px'
                  }}
                >
                  Cancel
                </button>
                <button
                  onClick={handleFinalizeClick}
                  style={{
                    background: 'white',
                    border: 'none',
                    color: '#dc2626',
                    padding: '8px 20px',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    fontWeight: 700,
                    fontSize: '13px',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '6px'
                  }}
                >
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                  Re-Finalize
                </button>
              </div>
            </div>
          )}

          {/* Viewing Mode Banner */}
          {viewingMode && isFinalized && (
            <div style={{
              background: 'linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%)',
              color: 'white',
              padding: '12px 24px',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              boxShadow: '0 2px 8px rgba(0,0,0,0.15)'
            }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                {Icons.checkCircle({ size: 20, color: '#ffd700' })}
                <span style={{ fontWeight: 600 }}>Viewing Completed Assessment</span>
                <span style={{ opacity: 0.8, fontSize: '14px' }}>({finalizedData?.percentage || 0}% compliance score)</span>
              </div>
              <button
                onClick={() => { setViewingMode(false); setCurrentPage('centers'); }}
                style={{
                  background: 'rgba(255,255,255,0.2)',
                  border: 'none',
                  color: 'white',
                  padding: '8px 16px',
                  borderRadius: '20px',
                  cursor: 'pointer',
                  fontWeight: 600,
                  fontSize: '13px',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '6px'
                }}
              >
                 Back to History
              </button>
            </div>
          )}

          {/* Assessment Info Bar */}
          {assessmentDetails && (
            <div className="assessment-info-bar">
              <div className="assessment-center-name" style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                {Icons.building({ size: 20, color: 'var(--primary)' })} {assessmentDetails.centerName}
              </div>
              <div className="assessment-coordinator">
                <span className="coordinator-name" style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                  {Icons.user({ size: 14 })} {assessmentDetails.coordinatorName}
                </span>
                <a href={`https://wa.me/${formatWhatsApp(assessmentDetails.coordinatorPhone)}`}
                  target="_blank" rel="noopener noreferrer" className="contact-link whatsapp" style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                  {Icons.whatsapp({ size: 14 })} WhatsApp
                </a>
                <a href={`mailto:${assessmentDetails.coordinatorEmail}`} className="contact-link email" style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                  {Icons.mail({ size: 14 })} Email
                </a>
                <button onClick={onEditDetails}
                  style={{ background: 'none', border: 'none', color: 'var(--text-muted)', cursor: 'pointer', fontSize: '13px', padding: '4px 8px', display: 'flex', alignItems: 'center', gap: '4px' }}>
                  {Icons.edit({ size: 14 })} Edit
                </button>
              </div>
            </div>
          )}

          <div className="controls-bar">
            <button className="sidebar-toggle" onClick={() => setSidebarOpen(!sidebarOpen)} title={sidebarOpen ? 'Hide sidebar' : 'Show sidebar'}>
              {sidebarOpen ? '' : ''}
            </button>
            {assessmentDetails?.configuration === 'B' ? (
              /* Full Survey Mode - Clean domain selector */
              <div className="control-group" style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                <select value={activeChapter} onChange={e => { setActiveChapter(e.target.value); setActiveStandard(null); }}
                  style={{
                    padding: '10px 16px',
                    borderRadius: '10px',
                    border: '1px solid var(--border)',
                    fontSize: '14px',
                    fontWeight: 500,
                    background: 'white',
                    color: 'var(--text-primary)',
                    minWidth: '260px',
                    cursor: 'pointer'
                  }}>
                  <option value="ALL">All Domains (6)</option>
                  {activeChapters.map(ch => (
                    <option key={ch.id} value={ch.id}>{ch.code} - {ch.name}</option>
                  ))}
                </select>
              </div>
            ) : (
              /* Normal Mode - Show chapter dropdown */
              <div className="control-group">
                <label className="control-label">Chapter:</label>
                <select value={activeChapter} onChange={e => { setActiveChapter(e.target.value); setActiveStandard(null); }}>
                  {activeChapters.map(ch => (
                    <option key={ch.id} value={ch.id} disabled={ch.placeholder}>
                      {ch.name} {ch.placeholder ? '(Coming Soon)' : `(${ch.standards.length > 0 ? getAllSubstandards(ch.standards).length : 0})`}
                    </option>
                  ))}
                </select>
              </div>
            )}
            <div className="control-group">
              <label className="control-label">Activity:</label>
              <select value={activityFilter} onChange={e => setActivityFilter(e.target.value)}>
                <option value="ALL">-All Activities-</option>
                <option value="DOC">Document Review</option>
                <option value="OBS">Observation</option>
                <option value="INT">Interview</option>
                <option value="PER">Personnel File</option>
                <option value="DEN">Dental Record Review</option>
              </select>
            </div>
            <button className="chapters-summary-btn" onClick={() => setShowSummary(true)}>
              CHAPTERS SUMMARY
              <span className="summary-numbers">{overallStats.fullyMet}/{overallStats.scored}/{overallStats.notMet}</span>
            </button>
            {/* Configuration Selector - Moved from header */}
            {onConfigChange && !viewingMode && (
              <select
                value={assessmentDetails?.configuration || 'A1'}
                onChange={(e) => onConfigChange(e.target.value)}
                style={{
                  background: 'linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%)',
                  color: 'white',
                  border: 'none',
                  borderRadius: '10px',
                  padding: '10px 16px',
                  fontSize: '13px',
                  fontWeight: 600,
                  cursor: 'pointer',
                  outline: 'none',
                  minWidth: '140px',
                  boxShadow: '0 2px 8px rgba(30, 58, 95, 0.3)',
                  transition: 'all 0.2s ease'
                }}
                title="Survey Configuration"
              >
                <option value="A1" style={{ color: '#1e3a5f', background: 'white' }}>A - Surveyor 1</option>
                <option value="A2" style={{ color: '#1e3a5f', background: 'white' }}>A - Surveyor 2</option>
                <option value="B" style={{ color: '#1e3a5f', background: 'white' }}>B - Full Survey</option>
              </select>
            )}
            {/* Show config badge in viewing mode */}
            {viewingMode && assessmentDetails?.configuration && (
              <div style={{
                background: 'linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%)',
                color: '#1e3a5f',
                border: '1px solid #cbd5e1',
                borderRadius: '10px',
                padding: '10px 16px',
                fontSize: '13px',
                fontWeight: 600,
                display: 'flex',
                alignItems: 'center',
                gap: '8px'
              }}>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                </svg>
                {assessmentDetails.configuration === 'B' ? 'B - Full Survey' :
                 assessmentDetails.configuration === 'A2' ? 'A - Surveyor 2' : 'A - Surveyor 1'}
              </div>
            )}
            {isModifiedMode ? (
              <button
                onClick={() => {
                  setRefinalizePassword('');
                  setRefinalizeError('');
                  setShowRefinalizeAuth(true);
                }}
                className="modified-badge"
                style={{
                  display: 'inline-flex',
                  alignItems: 'center',
                  gap: '8px',
                  padding: '10px 18px',
                  background: 'linear-gradient(145deg, #fff5f5 0%, #fee2e2 100%)',
                  color: '#dc2626',
                  border: '2px solid #dc2626',
                  borderRadius: '12px',
                  fontSize: '13px',
                  fontWeight: 700,
                  animation: 'pulse-red 1.5s ease-in-out infinite',
                  boxShadow: '0 0 0 0 rgba(220, 38, 38, 0.4)',
                  cursor: 'pointer',
                  transition: 'all 0.2s'
                }}
                title="Click to authenticate and finalize changes"
              >
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
                Modified - Click to Finalize
              </button>
            ) : isFinalized ? (
              <div className="finalized-badge">
                <span></span> Finalized
              </div>
            ) : overallPending === 0 && overallStats.total > 0 ? (
              <button className="finalize-btn finalize-btn-small" onClick={handleFinalizeClick}>
                <span></span> Finalize & Submit
              </button>
            ) : null}
          </div>

          <div className="main-container">
            <aside className={`sidebar ${sidebarOpen ? '' : 'collapsed'}`}>
              {assessmentDetails?.configuration === 'B' ? (
                /* Full Survey Mode - Domain-grouped navigation */
                <div className="sidebar-section">
                  <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between',
                    padding: '12px 8px',
                    marginBottom: '8px',
                    borderBottom: '1px solid var(--border)'
                  }}>
                    <div style={{ display: 'flex', alignItems: 'baseline', gap: '10px' }}>
                      <span style={{
                        fontSize: '11px',
                        fontWeight: 600,
                        textTransform: 'uppercase',
                        letterSpacing: '0.5px',
                        color: 'var(--text-muted)'
                      }}>All Domains</span>
                      <span style={{
                        fontSize: '13px',
                        fontWeight: 600,
                        color: 'var(--text-secondary)'
                      }}>
                        {activeChapters.reduce((sum, ch) => sum + getAllSubstandards(ch.standards).length, 0)}
                        <span style={{ fontSize: '10px', fontWeight: 500, marginLeft: '3px', textTransform: 'uppercase' }}>total</span>
                      </span>
                    </div>
                    <div style={{ display: 'flex', gap: '2px' }}>
                      <button
                        onClick={expandAllDomains}
                        title="Expand All"
                        style={{
                          background: 'transparent',
                          border: '1px solid var(--border)',
                          borderRadius: '4px',
                          width: '26px',
                          height: '26px',
                          cursor: 'pointer',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          color: 'var(--text-muted)',
                          transition: 'all 0.15s ease'
                        }}
                        onMouseOver={(e) => { e.currentTarget.style.background = 'var(--bg-hover)'; e.currentTarget.style.borderColor = 'var(--text-muted)'; }}
                        onMouseOut={(e) => { e.currentTarget.style.background = 'transparent'; e.currentTarget.style.borderColor = 'var(--border)'; }}
                      >
                        <svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor">
                          <rect x="1" y="1" width="6" height="6" rx="1" />
                          <rect x="9" y="1" width="6" height="6" rx="1" />
                          <rect x="1" y="9" width="6" height="6" rx="1" />
                          <rect x="9" y="9" width="6" height="6" rx="1" />
                        </svg>
                      </button>
                      <button
                        onClick={collapseAllDomains}
                        title="Collapse All"
                        style={{
                          background: 'transparent',
                          border: '1px solid var(--border)',
                          borderRadius: '4px',
                          width: '26px',
                          height: '26px',
                          cursor: 'pointer',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          color: 'var(--text-muted)',
                          transition: 'all 0.15s ease'
                        }}
                        onMouseOver={(e) => { e.currentTarget.style.background = 'var(--bg-hover)'; e.currentTarget.style.borderColor = 'var(--text-muted)'; }}
                        onMouseOut={(e) => { e.currentTarget.style.background = 'transparent'; e.currentTarget.style.borderColor = 'var(--border)'; }}
                      >
                        <svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor">
                          <rect x="1" y="4" width="14" height="3" rx="1" />
                          <rect x="1" y="9" width="14" height="3" rx="1" />
                        </svg>
                      </button>
                    </div>
                  </div>
                  {activeChapters.map(chapter => {
                    const chapterSubs = getAllSubstandards(chapter.standards);
                    const chapterScoredCount = chapterSubs.filter(s => scores[s.id]?.value !== undefined && scores[s.id]?.value !== null).length;
                    const isExpanded = expandedDomains[chapter.id] !== false;
                    const domainClass = `domain-${chapter.code.toLowerCase()}`;

                    return (
                      <div key={chapter.id} className="sidebar-domain-group">
                        <div
                          className={`sidebar-domain-header ${activeChapter === chapter.id ? 'active' : ''}`}
                          onClick={() => toggleDomainExpanded(chapter.id)}
                          style={{ cursor: 'pointer' }}
                        >
                          <span style={{
                            fontSize: '10px', color: 'var(--text-muted)',
                            transition: 'transform 0.2s ease',
                            transform: isExpanded ? 'rotate(90deg)' : 'rotate(0deg)',
                            display: 'inline-block'
                          }}></span>
                          <div className={`sidebar-domain-badge ${domainClass}`}>{chapter.code}</div>
                          <div className="sidebar-domain-count" style={{ marginLeft: 'auto' }}>{chapterScoredCount}/{chapterSubs.length}</div>
                        </div>
                        {isExpanded && (
                          <div className="sidebar-domain-standards">
                            {chapter.standards.map(std => {
                              const scoredCount = getScoredCountForStandard(std.id);
                              const isComplete = scoredCount === std.substandards.length;
                              return (
                                <div key={std.id}
                                  className={`standard-nav-item ${activeStandard === std.id ? 'active' : ''}`}
                                  onClick={(e) => { e.stopPropagation(); setActiveChapter(chapter.id); setActiveStandard(std.id); }}
                                  style={{ padding: '6px 10px', fontSize: '12px' }}>
                                  <span className="standard-nav-code">{std.code}</span>
                                  <div className="standard-nav-progress">
                                    {isComplete && <span className="standard-nav-check" style={{ fontSize: '10px' }}></span>}
                                    <span className="standard-nav-count" style={{ fontSize: '11px' }}>{scoredCount}/{std.substandards.length}</span>
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                        )}
                      </div>
                    );
                  })}
                  {/* Bottom padding for score bar */}
                  <div style={{ height: '80px' }}></div>
                </div>
              ) : (
                /* Normal Mode - Standard navigation */
                <div className="sidebar-section">
                  <div className="sidebar-title">Standards Navigation</div>
                  <div className={`standard-nav-item ${!activeStandard ? 'active' : ''}`} onClick={() => setActiveStandard(null)}>
                    <span className="standard-nav-code">All Standards</span>
                    <span className="standard-nav-count">{allSubstandards.length}</span>
                  </div>
                  {currentStandards.map(std => {
                    const scoredCount = getScoredCountForStandard(std.id);
                    const isComplete = scoredCount === std.substandards.length;
                    return (
                      <div key={std.id} className={`standard-nav-item ${activeStandard === std.id ? 'active' : ''}`}
                        onClick={() => setActiveStandard(std.id)}>
                        <span className="standard-nav-code">{std.code}</span>
                        <div className="standard-nav-progress">
                          {isComplete && <span className="standard-nav-check"></span>}
                          <span className="standard-nav-count">{scoredCount}/{std.substandards.length}</span>
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </aside>

            <main className="content-area">
              {/* Header section - different for single standard vs all standards */}
              {activeStandard ? (
                /* Single standard selected - use mother standard styling */
                (() => {
                  const selectedStd = currentStandards.find(s => s.id === activeStandard);
                  return (
                    <div className="mother-standard-section" style={{ marginBottom: '24px' }}>
                      <div className="mother-standard-header">
                        <div className="mother-standard-code">{selectedStd?.code}</div>
                        <div className="mother-standard-content">
                          <h3 className="mother-standard-title">{selectedStd?.title}</h3>
                          {selectedStd?.intent && (
                            <p className="mother-standard-intent">{selectedStd.intent}</p>
                          )}
                        </div>
                        <div className="mother-standard-badge">
                          {filteredSubstandards.length} sub-standard(s)
                          {scoreFilter && <span style={{ marginLeft: '8px', padding: '2px 8px', borderRadius: '12px', fontSize: '11px', background: scoreFilter === 'full' ? 'var(--success-light)' : scoreFilter === 'partial' ? 'var(--warning-light)' : scoreFilter === 'not-met' ? 'var(--danger-light)' : 'var(--bg-hover)', color: scoreFilter === 'full' ? 'var(--success)' : scoreFilter === 'partial' ? '#b45309' : scoreFilter === 'not-met' ? 'var(--danger)' : 'var(--text-secondary)' }}>
                            {scoreFilter === 'full' ? 'Fully Met' : scoreFilter === 'partial' ? 'Partial' : scoreFilter === 'not-met' ? 'Not Met' : 'N/A'}
                            <span style={{ marginLeft: '6px', cursor: 'pointer' }} onClick={() => setScoreFilter(null)}></span>
                          </span>}
                        </div>
                      </div>
                    </div>
                  );
                })()
              ) : assessmentDetails?.configuration === 'B' && activeChapter === 'ALL' ? (
                /* Full Survey Mode - All domains header */
                <div className="content-header" style={{ background: 'linear-gradient(135deg, rgba(30, 58, 95, 0.05) 0%, rgba(52, 152, 219, 0.08) 100%)', padding: '24px', borderRadius: '12px', marginBottom: '24px' }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                    <div style={{
                      width: '56px', height: '56px', borderRadius: '14px',
                      background: 'linear-gradient(135deg, #1e3a5f 0%, #3498db 100%)',
                      display: 'flex', alignItems: 'center', justifyContent: 'center',
                      boxShadow: '0 4px 12px rgba(30, 58, 95, 0.3)'
                    }}>
                      <span style={{ color: 'white', fontSize: '24px' }}></span>
                    </div>
                    <div>
                      <h2 style={{ margin: 0, fontSize: '22px', fontWeight: 700, color: 'var(--primary)' }}>Full Survey Assessment</h2>
                      <p style={{ margin: '4px 0 0 0', color: 'var(--text-secondary)', fontSize: '14px' }}>
                        All 6 Domains  {activeChapters.reduce((sum, ch) => sum + getAllSubstandards(ch.standards).length, 0)} Sub-standards
                      </p>
                    </div>
                  </div>
                  <div style={{ display: 'flex', gap: '8px', marginTop: '16px', flexWrap: 'wrap' }}>
                    {activeChapters.map(ch => (
                      <a key={ch.id} href={`#domain-${ch.code.toLowerCase()}`}
                        style={{
                          padding: '6px 14px', borderRadius: '20px', fontSize: '12px', fontWeight: 600,
                          background: `linear-gradient(135deg, ${domainColors[ch.code]?.primary || '#1e3a5f'} 0%, ${domainColors[ch.code]?.accent || '#3498db'} 100%)`,
                          color: 'white', textDecoration: 'none', cursor: 'pointer',
                          boxShadow: '0 2px 8px rgba(0,0,0,0.15)', transition: 'transform 0.2s ease'
                        }}
                        onClick={(e) => { e.preventDefault(); document.getElementById(`domain-${ch.code.toLowerCase()}`)?.scrollIntoView({ behavior: 'smooth' }); }}
                      >
                        {ch.code}
                      </a>
                    ))}
                  </div>
                </div>
              ) : (
                /* Standard chapter header */
                <div className="content-header">
                  <h2>{currentChapter?.name}</h2>
                  <p className="substandard-count">
                    {filteredSubstandards.length} sub-standard(s)
                    {scoreFilter && <span style={{ marginLeft: '8px', padding: '2px 8px', borderRadius: '12px', fontSize: '11px', background: scoreFilter === 'full' ? 'var(--success-light)' : scoreFilter === 'partial' ? 'var(--warning-light)' : scoreFilter === 'not-met' ? 'var(--danger-light)' : 'var(--bg-hover)', color: scoreFilter === 'full' ? 'var(--success)' : scoreFilter === 'partial' ? '#b45309' : scoreFilter === 'not-met' ? 'var(--danger)' : 'var(--text-secondary)' }}>
                      {scoreFilter === 'full' ? 'Fully Met' : scoreFilter === 'partial' ? 'Partial' : scoreFilter === 'not-met' ? 'Not Met' : 'N/A'}
                      <span style={{ marginLeft: '6px', cursor: 'pointer' }} onClick={() => setScoreFilter(null)}></span>
                    </span>}
                  </p>
                </div>
              )}

              {currentChapter?.placeholder ? (
                <div className="empty-state">
                  <div className="empty-state-icon"></div>
                  <h3>{currentChapter.name}</h3>
                  <p>This chapter will be added in a future update.</p>
                </div>
              ) : activeStandard ? (
                /* Single standard selected - show substandards directly */
                <div className="single-standard-substandards">
                  {filteredSubstandards.map(sub => (
                    <SubstandardCard key={sub.id} substandard={sub} score={scores[sub.id]}
                      onScoreChange={handleScoreChange} />
                  ))}
                </div>
              ) : assessmentDetails?.configuration === 'B' && activeChapter === 'ALL' ? (
                /* Full Survey Mode - All domains with beautiful separators */
                <div className="full-survey-view">
                  {activeChapters.map((chapter, chapterIndex) => {
                    const chapterSubs = getAllSubstandards(chapter.standards);

                    // Apply filters to this chapter's substandards
                    const applyFilters = (subs) => {
                      let filtered = subs;
                      if (activityFilter !== 'ALL') filtered = filtered.filter(s => s.activityType === activityFilter);
                      if (searchQuery) {
                        const query = searchQuery.toLowerCase();
                        filtered = filtered.filter(s => s.code.toLowerCase().includes(query) || s.text.toLowerCase().includes(query));
                      }
                      if (scoreFilter) {
                        filtered = filtered.filter(s => {
                          const score = scores[s.id];
                          if (scoreFilter === 'full') return score?.value === 2;
                          if (scoreFilter === 'partial') return score?.value === 1;
                          if (scoreFilter === 'not-met') return score?.value === 0;
                          if (scoreFilter === 'na') return score?.value === 'NA';
                          if (scoreFilter === 'unscored') return score?.value === undefined || score?.value === null;
                          return true;
                        });
                      }
                      return filtered;
                    };

                    const filteredChapterSubs = applyFilters(chapterSubs);

                    // Skip this domain if no substandards match the filter
                    if (filteredChapterSubs.length === 0) return null;

                    const chapterStats = {
                      total: chapterSubs.length,
                      fullyMet: chapterSubs.filter(s => scores[s.id]?.value === 2).length,
                      partial: chapterSubs.filter(s => scores[s.id]?.value === 1).length,
                      notMet: chapterSubs.filter(s => scores[s.id]?.value === 0).length,
                      na: chapterSubs.filter(s => scores[s.id]?.value === 'NA').length,
                      pending: chapterSubs.filter(s => scores[s.id]?.value === undefined || scores[s.id]?.value === null).length
                    };

                    return (
                      <div key={chapter.id} className="domain-section" id={`domain-${chapter.code.toLowerCase()}`}>
                        <DomainSeparator chapter={chapter} stats={chapterStats} />
                        {chapter.standards.map(std => {
                          // Apply filters to this standard's substandards
                          const filteredStdSubs = applyFilters(std.substandards.map(sub => ({
                            ...sub, standardId: std.id, standardTitle: std.title, standardIntent: std.intent, standardCode: std.code
                          })));

                          // Skip this standard if no substandards match the filter
                          if (filteredStdSubs.length === 0) return null;

                          return (
                            <div key={std.id} className="mother-standard-section">
                              <div className="mother-standard-header">
                                <div className="mother-standard-code">{std.code}</div>
                                <div className="mother-standard-content">
                                  <h3 className="mother-standard-title">{std.title}</h3>
                                  {std.intent && (
                                    <p className="mother-standard-intent">{std.intent}</p>
                                  )}
                                </div>
                                <div className="mother-standard-badge">{filteredStdSubs.length} sub-standard(s)</div>
                              </div>
                              <div className="mother-standard-substandards">
                                {filteredStdSubs.map(sub => (
                                  <SubstandardCard key={sub.id}
                                    substandard={sub}
                                    score={scores[sub.id]}
                                    onScoreChange={handleScoreChange} />
                                ))}
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    );
                  })}
                </div>
              ) : (
                /* Standard view - show grouped by mother standard */
                groupedSubstandards.map(group => (
                  <div key={group.standardId} className="mother-standard-section">
                    <div className="mother-standard-header">
                      <div className="mother-standard-code">{group.standardCode}</div>
                      <div className="mother-standard-content">
                        <h3 className="mother-standard-title">{group.standardTitle}</h3>
                        {group.standardIntent && (
                          <p className="mother-standard-intent">{group.standardIntent}</p>
                        )}
                      </div>
                      <div className="mother-standard-badge">{group.substandards.length} sub-standard(s)</div>
                    </div>
                    <div className="mother-standard-substandards">
                      {group.substandards.map(sub => (
                        <SubstandardCard key={sub.id} substandard={sub} score={scores[sub.id]}
                          onScoreChange={handleScoreChange} />
                      ))}
                    </div>
                  </div>
                ))
              )}
            </main>
          </div>

          <div className="score-summary-panel">
            <div className="score-display">
              <div className="score-main">
                <div className={`score-percentage ${getScoreColorClass(overallStats.percentage)}`}>{overallStats.percentage}%</div>
                <div className="score-label">Overall Score</div>
              </div>
              <div className="score-breakdown">
                <div className={`breakdown-item ${scoreFilter === 'full' ? 'active filter-full' : ''}`}
                  onClick={() => setScoreFilter(scoreFilter === 'full' ? null : 'full')}
                  title="Click to filter Fully Met">
                  <div className="breakdown-value" style={{ color: 'var(--success)' }}>{overallStats.fullyMet}</div>
                  <div className="breakdown-label">Fully Met</div>
                </div>
                <div className={`breakdown-item ${scoreFilter === 'partial' ? 'active filter-partial' : ''}`}
                  onClick={() => setScoreFilter(scoreFilter === 'partial' ? null : 'partial')}
                  title="Click to filter Partial">
                  <div className="breakdown-value" style={{ color: 'var(--warning)' }}>{overallStats.partial}</div>
                  <div className="breakdown-label">Partial</div>
                </div>
                <div className={`breakdown-item ${scoreFilter === 'not-met' ? 'active filter-not-met' : ''}`}
                  onClick={() => setScoreFilter(scoreFilter === 'not-met' ? null : 'not-met')}
                  title="Click to filter Not Met">
                  <div className="breakdown-value" style={{ color: 'var(--danger)' }}>{overallStats.notMet}</div>
                  <div className="breakdown-label">Not Met</div>
                </div>
                <div className={`breakdown-item ${scoreFilter === 'na' ? 'active filter-na' : ''}`}
                  onClick={() => setScoreFilter(scoreFilter === 'na' ? null : 'na')}
                  title="Click to filter N/A">
                  <div className="breakdown-value" style={{ color: 'var(--neutral)' }}>{overallStats.na}</div>
                  <div className="breakdown-label">N/A</div>
                </div>
                <div className="breakdown-item not-scored-item"
                  onClick={() => setScoreFilter(scoreFilter === 'unscored' ? null : 'unscored')}
                  title="Overall pending across all chapters">
                  <div className="breakdown-value" style={{ color: '#8e44ad' }}>{overallPending}</div>
                  <div className="breakdown-label">Pending</div>
                </div>
              </div>
            </div>
            <div className="progress-bar-container">
              <div className="progress-bar">
                <div className="progress-fill" style={{
                  width: `${overallStats.total > 0 ? (overallStats.scored / overallStats.total) * 100 : 0}%`,
                  background: 'linear-gradient(90deg, var(--success) 0%, var(--accent) 100%)'
                }} />
              </div>
              <div className="progress-text">{overallStats.scored} of {overallStats.total} sub-standards scored</div>
            </div>
            <AutosaveIndicator saving={saving} />
            {/* Finalize Button / Status in Bottom Panel */}
            {isModifiedMode ? (
              <button
                onClick={() => {
                  setRefinalizePassword('');
                  setRefinalizeError('');
                  setShowRefinalizeAuth(true);
                }}
                className="modified-badge"
                style={{
                  marginLeft: '16px',
                  display: 'inline-flex',
                  alignItems: 'center',
                  gap: '6px',
                  padding: '8px 16px',
                  background: 'linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%)',
                  color: '#dc2626',
                  borderRadius: '8px',
                  fontWeight: 700,
                  fontSize: '13px',
                  border: '2px solid #dc2626',
                  animation: 'pulse-red 2s infinite',
                  cursor: 'pointer',
                  transition: 'all 0.2s'
                }}
                title="Click to authenticate and finalize"
              >
                <span></span> Modified - Click to Finalize
              </button>
            ) : isFinalized ? (
              <div className="finalized-badge" style={{ marginLeft: '16px' }}>
                <span></span> Finalized
              </div>
            ) : overallPending === 0 && overallStats.total > 0 ? (
              <button className="finalize-btn finalize-btn-small" onClick={handleFinalizeClick} style={{ marginLeft: '16px' }}>
                <span></span> Finalize
              </button>
            ) : null}
          </div>

          <ChaptersSummaryModal
            isOpen={showSummary}
            onClose={() => setShowSummary(false)}
            scores={scores}
            chapters={activeChapters}
            onFinalize={handleFinalizeClick}
            isFinalized={isFinalized}
            overallPending={overallPending}
          />

          {/* Completion Celebration Modal */}
          <CompletionModal
            isOpen={showCompletionModal}
            onClose={() => setShowCompletionModal(false)}
            stats={overallStats}
            onFinalize={handleFinalizeClick}
          />

          {/* Finalize Confirmation Dialog */}
          <FinalizeConfirmDialog
            isOpen={showConfirmDialog}
            onClose={() => setShowConfirmDialog(false)}
            onConfirm={handleConfirmFinalize}
            stats={overallStats}
            isSubmitting={isSubmitting}
          />

          {/* Re-Finalize Authentication Modal for Modified Mode */}
          {showRefinalizeAuth && (
            <div className="modal-overlay" onClick={() => setShowRefinalizeAuth(false)}>
              <div className="modal" onClick={e => e.stopPropagation()} style={{
                maxWidth: '420px',
                padding: '32px',
                borderRadius: '20px',
                textAlign: 'center'
              }}>
                {/* Lock Icon */}
                <div style={{
                  width: '70px',
                  height: '70px',
                  background: 'linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%)',
                  borderRadius: '50%',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  margin: '0 auto 20px',
                  border: '3px solid #dc2626'
                }}>
                  <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#dc2626" strokeWidth="2">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                  </svg>
                </div>

                <h3 style={{ color: '#1e3a5f', marginBottom: '8px', fontSize: '20px' }}>
                  Authenticate to Finalize
                </h3>
                <p style={{ color: '#64748b', marginBottom: '24px', fontSize: '14px' }}>
                  Enter your password to confirm and finalize the modified assessment.
                </p>

                {refinalizeError && (
                  <div style={{
                    background: '#fef2f2',
                    color: '#dc2626',
                    padding: '12px',
                    borderRadius: '10px',
                    marginBottom: '16px',
                    fontSize: '14px',
                    fontWeight: 500
                  }}>
                    {refinalizeError}
                  </div>
                )}

                <div style={{ textAlign: 'left', marginBottom: '20px' }}>
                  <label style={{ fontSize: '13px', fontWeight: 600, color: '#374151', display: 'block', marginBottom: '6px' }}>
                    Password
                  </label>
                  <input
                    type="password"
                    value={refinalizePassword}
                    onChange={e => setRefinalizePassword(e.target.value)}
                    placeholder="Enter your password"
                    style={{
                      width: '100%',
                      padding: '14px 16px',
                      borderRadius: '10px',
                      border: '2px solid #e2e8f0',
                      fontSize: '15px',
                      boxSizing: 'border-box',
                      transition: 'border-color 0.2s'
                    }}
                    onKeyPress={e => {
                      if (e.key === 'Enter') {
                        // Validate password - must match admin login password
                        if (refinalizePassword === ADMIN_PASSWORD) {
                          // Proceed with finalization
                          handleFinalizeClick();
                          setShowRefinalizeAuth(false);
                          setRefinalizePassword('');
                          setRefinalizeError('');
                        } else {
                          setRefinalizeError('Incorrect password. Please try again.');
                        }
                      }
                    }}
                    autoFocus
                  />
                </div>

                <div style={{ display: 'flex', gap: '12px' }}>
                  <button
                    onClick={() => {
                      setShowRefinalizeAuth(false);
                      setRefinalizePassword('');
                      setRefinalizeError('');
                    }}
                    style={{
                      flex: 1,
                      padding: '14px',
                      background: '#f1f5f9',
                      color: '#64748b',
                      border: 'none',
                      borderRadius: '10px',
                      fontSize: '14px',
                      fontWeight: 600,
                      cursor: 'pointer'
                    }}
                  >
                    Cancel
                  </button>
                  <button
                    onClick={() => {
                      // Validate password - must match admin login password
                      if (refinalizePassword === ADMIN_PASSWORD) {
                        // Proceed with finalization
                        handleFinalizeClick();
                        setShowRefinalizeAuth(false);
                        setRefinalizePassword('');
                        setRefinalizeError('');
                      } else {
                        setRefinalizeError('Incorrect password. Please try again.');
                      }
                    }}
                    style={{
                      flex: 1,
                      padding: '14px',
                      background: 'linear-gradient(135deg, #16a34a 0%, #15803d 100%)',
                      color: 'white',
                      border: 'none',
                      borderRadius: '10px',
                      fontSize: '14px',
                      fontWeight: 600,
                      cursor: 'pointer',
                      boxShadow: '0 4px 12px rgba(22, 163, 74, 0.3)'
                    }}
                  >
                     Authenticate & Finalize
                  </button>
                </div>
              </div>
            </div>
          )}
        </>
      );
    };

    // Dashboard Page
    const DashboardPage = ({ centers, surveys, onEditSurvey, onDeleteSurvey, onNewAssessment }) => {
      const totalCenters = centers.length;
      const totalSurveys = surveys.length;
      const completedSurveys = surveys.filter(s => s.status === 'completed').length;
      const avgScore = surveys.length > 0
        ? Math.round(surveys.reduce((acc, s) => acc + (s.stats?.percentage || 0), 0) / surveys.length)
        : 0;

      const recentSurveys = [...surveys].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 10);

      // Mobile detection
      const [isMobile, setIsMobile] = useState(window.innerWidth <= 768);
      useEffect(() => {
        const checkMobile = () => setIsMobile(window.innerWidth <= 768);
        window.addEventListener('resize', checkMobile);
        return () => window.removeEventListener('resize', checkMobile);
      }, []);

      // Format phone for WhatsApp
      const formatWhatsApp = (phone) => {
        if (!phone) return '';
        let clean = phone.replace(/[\s\-()]/g, '');
        if (!clean.startsWith('+')) {
          clean = '+966' + clean.replace(/^0/, '');
        }
        return clean;
      };

      const [expandedSurvey, setExpandedSurvey] = useState(null);

      return (
        <div className="page-container" style={{ maxWidth: '1400px' }}>
          {/* Dashboard Header - Mobile Responsive */}
          <div style={{
            marginBottom: isMobile ? '20px' : '32px',
            display: 'flex',
            flexDirection: isMobile ? 'column' : 'row',
            justifyContent: 'space-between',
            alignItems: isMobile ? 'stretch' : 'flex-start',
            gap: isMobile ? '16px' : '0'
          }}>
            <div>
              <h1 style={{ fontSize: isMobile ? '22px' : '28px', fontWeight: 700, color: 'var(--text-primary)', marginBottom: isMobile ? '4px' : '8px' }}>
                Dashboard
              </h1>
              {!isMobile && (
                <p style={{ color: 'var(--text-muted)', fontSize: '15px' }}>
                  Overview of your dental center accreditation assessments
                </p>
              )}
            </div>
            <button
              onClick={onNewAssessment}
              style={{
                padding: isMobile ? '12px 20px' : '14px 28px',
                background: 'linear-gradient(135deg, #1e3a5f 0%, #2d5a8a 50%, #1abc9c 100%)',
                border: 'none',
                borderRadius: '50px',
                color: 'white',
                fontSize: isMobile ? '14px' : '15px',
                fontWeight: 700,
                cursor: 'pointer',
                display: 'flex',
                alignItems: 'center',
                gap: '10px',
                boxShadow: '0 8px 24px rgba(30, 58, 95, 0.3), inset 0 1px 0 rgba(255,255,255,0.2)',
                transition: 'all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                position: 'relative',
                overflow: 'hidden',
                letterSpacing: '0.02em'
              }}
              onMouseOver={e => {
                e.currentTarget.style.transform = 'translateY(-2px) scale(1.02)';
                e.currentTarget.style.boxShadow = '0 12px 32px rgba(30, 58, 95, 0.4), inset 0 1px 0 rgba(255,255,255,0.3)';
              }}
              onMouseOut={e => {
                e.currentTarget.style.transform = 'translateY(0) scale(1)';
                e.currentTarget.style.boxShadow = '0 8px 24px rgba(30, 58, 95, 0.3), inset 0 1px 0 rgba(255,255,255,0.2)';
              }}
            >
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              New Assessment
            </button>
          </div>

          {/* Stats Grid - Redesigned with Mobile Responsive */}
          <div style={{
            display: 'grid',
            gridTemplateColumns: isMobile ? 'repeat(2, 1fr)' : 'repeat(4, 1fr)',
            gap: isMobile ? '12px' : '24px',
            marginBottom: isMobile ? '24px' : '40px'
          }}>
            {/* Stat Card 1 - Dental Centers */}
            <div style={{
              background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
              borderRadius: isMobile ? '12px' : '16px',
              padding: isMobile ? '14px' : '24px',
              color: 'white',
              position: 'relative',
              overflow: 'hidden',
              boxShadow: '0 10px 30px rgba(102, 126, 234, 0.3)'
            }}>
              <div style={{ position: 'absolute', right: '-10px', top: '-10px', opacity: 0.15 }}>
                {Icons.building({ size: isMobile ? 60 : 100, color: 'white' })}
              </div>
              <div style={{ position: 'relative', zIndex: 1 }}>
                <div style={{ fontSize: isMobile ? '10px' : '12px', textTransform: 'uppercase', letterSpacing: '1px', opacity: 0.9, marginBottom: isMobile ? '4px' : '8px' }}>
                  {isMobile ? 'Centers' : 'Dental Centers'}
                </div>
                <div style={{ fontSize: isMobile ? '28px' : '42px', fontWeight: 700, lineHeight: 1 }}>{totalCenters}</div>
                {!isMobile && <div style={{ fontSize: '13px', opacity: 0.8, marginTop: '8px' }}>Registered locations</div>}
              </div>
            </div>

            {/* Stat Card 2 - Total Surveys */}
            <div style={{
              background: 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)',
              borderRadius: isMobile ? '12px' : '16px',
              padding: isMobile ? '14px' : '24px',
              color: 'white',
              position: 'relative',
              overflow: 'hidden',
              boxShadow: '0 10px 30px rgba(17, 153, 142, 0.3)'
            }}>
              <div style={{ position: 'absolute', right: '-10px', top: '-10px', opacity: 0.15 }}>
                {Icons.clipboard({ size: isMobile ? 60 : 100, color: 'white' })}
              </div>
              <div style={{ position: 'relative', zIndex: 1 }}>
                <div style={{ fontSize: isMobile ? '10px' : '12px', textTransform: 'uppercase', letterSpacing: '1px', opacity: 0.9, marginBottom: isMobile ? '4px' : '8px' }}>
                  {isMobile ? 'Assessments' : 'Total Assessments'}
                </div>
                <div style={{ fontSize: isMobile ? '28px' : '42px', fontWeight: 700, lineHeight: 1 }}>{totalSurveys}</div>
                {!isMobile && <div style={{ fontSize: '13px', opacity: 0.8, marginTop: '8px' }}>All time surveys</div>}
              </div>
            </div>

            {/* Stat Card 3 - Completed */}
            <div style={{
              background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
              borderRadius: isMobile ? '12px' : '16px',
              padding: isMobile ? '14px' : '24px',
              color: 'white',
              position: 'relative',
              overflow: 'hidden',
              boxShadow: '0 10px 30px rgba(245, 87, 108, 0.3)'
            }}>
              <div style={{ position: 'absolute', right: '-10px', top: '-10px', opacity: 0.15 }}>
                {Icons.checkCircle({ size: isMobile ? 60 : 100, color: 'white' })}
              </div>
              <div style={{ position: 'relative', zIndex: 1 }}>
                <div style={{ fontSize: isMobile ? '10px' : '12px', textTransform: 'uppercase', letterSpacing: '1px', opacity: 0.9, marginBottom: isMobile ? '4px' : '8px' }}>
                  Completed
                </div>
                <div style={{ fontSize: isMobile ? '28px' : '42px', fontWeight: 700, lineHeight: 1 }}>{completedSurveys}</div>
                {!isMobile && <div style={{ fontSize: '13px', opacity: 0.8, marginTop: '8px' }}>Finalized assessments</div>}
              </div>
            </div>

            {/* Stat Card 4 - Avg Score */}
            <div style={{
              background: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
              borderRadius: isMobile ? '12px' : '16px',
              padding: isMobile ? '14px' : '24px',
              color: 'white',
              position: 'relative',
              overflow: 'hidden',
              boxShadow: '0 10px 30px rgba(250, 112, 154, 0.3)'
            }}>
              <div style={{ position: 'absolute', right: '-10px', top: '-10px', opacity: 0.15 }}>
                {Icons.award({ size: isMobile ? 60 : 100, color: 'white' })}
              </div>
              <div style={{ position: 'relative', zIndex: 1 }}>
                <div style={{ fontSize: isMobile ? '10px' : '12px', textTransform: 'uppercase', letterSpacing: '1px', opacity: 0.9, marginBottom: isMobile ? '4px' : '8px' }}>
                  {isMobile ? 'Avg Score' : 'Average Score'}
                </div>
                <div style={{ fontSize: isMobile ? '28px' : '42px', fontWeight: 700, lineHeight: 1 }}>{avgScore}%</div>
                {!isMobile && <div style={{ fontSize: '13px', opacity: 0.8, marginTop: '8px' }}>Compliance rate</div>}
              </div>
            </div>
          </div>

          {/* Recent Assessments Section */}
          <div style={{
            background: 'white',
            borderRadius: '20px',
            boxShadow: '0 4px 20px rgba(0, 0, 0, 0.08)',
            overflow: 'hidden'
          }}>
            {/* Section Header */}
            <div style={{
              padding: '24px 28px',
              borderBottom: '1px solid var(--border)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'space-between'
            }}>
              <div>
                <h2 style={{ fontSize: '20px', fontWeight: 600, color: 'var(--text-primary)', margin: 0 }}>
                  Recent Assessments
                </h2>
                <p style={{ fontSize: '14px', color: 'var(--text-muted)', margin: '4px 0 0' }}>
                  Click to expand and view details
                </p>
              </div>
              <div style={{
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                color: 'white',
                padding: '8px 16px',
                borderRadius: '25px',
                fontSize: '13px',
                fontWeight: 600,
                boxShadow: '0 4px 12px rgba(102, 126, 234, 0.3)',
                whiteSpace: 'nowrap',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                minHeight: '36px',
                lineHeight: 1
              }}>
                {recentSurveys.length} assessment{recentSurveys.length !== 1 ? 's' : ''}
              </div>
            </div>

            {/* Assessments List */}
            <div style={{ padding: '16px' }}>
              {recentSurveys.length === 0 ? (
                <div style={{ padding: '60px 24px', textAlign: 'center' }}>
                  <div style={{
                    width: '80px', height: '80px', borderRadius: '50%',
                    background: 'var(--bg-hover)', margin: '0 auto 20px',
                    display: 'flex', alignItems: 'center', justifyContent: 'center'
                  }}>
                    {Icons.barChart({ size: 36, color: 'var(--text-muted)' })}
                  </div>
                  <h3 style={{ color: 'var(--text-primary)', marginBottom: '8px' }}>No assessments yet</h3>
                  <p style={{ color: 'var(--text-muted)', maxWidth: '300px', margin: '0 auto' }}>
                    Start a new assessment on the Scoring page. Completed assessments will appear here.
                  </p>
                </div>
              ) : (
                <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                  {recentSurveys.map(survey => {
                    const details = survey.assessmentDetails;
                    const isExpanded = expandedSurvey === survey.id;
                    const scoreColor = (survey.stats?.percentage || 0) >= 75 ? 'var(--success)' :
                      (survey.stats?.percentage || 0) >= 60 ? 'var(--warning)' : 'var(--danger)';
                    return (
                      <div key={survey.id} style={{
                        background: isExpanded ? 'var(--bg-hover)' : 'var(--bg-main)',
                        border: '1px solid',
                        borderColor: isExpanded ? 'var(--primary-light)' : 'var(--border)',
                        borderRadius: '14px',
                        overflow: 'hidden',
                        transition: 'all 0.2s ease'
                      }}>
                        {/* Survey Row */}
                        <div
                          onClick={() => setExpandedSurvey(isExpanded ? null : survey.id)}
                          style={{
                            padding: '20px 24px',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '24px',
                            cursor: 'pointer'
                          }}
                        >
                          {/* Icon */}
                          <div style={{
                            width: '56px', height: '56px', borderRadius: '14px',
                            background: 'linear-gradient(135deg, var(--primary) 0%, #1a3a5c 100%)',
                            display: 'flex', alignItems: 'center', justifyContent: 'center',
                            flexShrink: 0,
                            boxShadow: '0 6px 16px rgba(52, 73, 94, 0.25)'
                          }}>
                            {Icons.building({ size: 26, color: 'white' })}
                          </div>

                          {/* Center Name & Date - Grouped */}
                          <div style={{ minWidth: '280px', borderRight: '1px solid var(--border)', paddingRight: '24px' }}>
                            <div style={{ fontWeight: 600, fontSize: '17px', color: 'var(--text-primary)', marginBottom: '6px' }}>
                              {details?.centerName || survey.centerName || 'Unknown Center'}
                            </div>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                              <div style={{ display: 'flex', alignItems: 'center', gap: '6px', color: 'var(--text-secondary)', fontSize: '14px' }}>
                                {Icons.calendar({ size: 14, color: 'var(--text-muted)' })}
                                <span style={{ fontWeight: 500 }}>{new Date(survey.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>
                              </div>
                              <div style={{ width: '4px', height: '4px', borderRadius: '50%', background: 'var(--text-muted)' }}></div>
                              <span style={{ color: 'var(--text-muted)', fontSize: '14px' }}>
                                {new Date(survey.createdAt).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}
                              </span>
                            </div>
                          </div>

                          {/* Configuration - With Label */}
                          <div style={{ minWidth: '140px', borderRight: '1px solid var(--border)', paddingRight: '24px' }}>
                            <div style={{ fontSize: '11px', color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '6px' }}>
                              Survey Type
                            </div>
                            <div style={{
                              padding: '6px 14px',
                              background: 'rgba(30, 58, 95, 0.08)',
                              border: '1px solid rgba(30, 58, 95, 0.2)',
                              color: 'var(--primary)',
                              borderRadius: '6px',
                              fontSize: '12px',
                              fontWeight: 600,
                              display: 'inline-block',
                              letterSpacing: '0.3px'
                            }}>
                              {survey.configuration || 'A - Surveyor 1'}
                            </div>
                          </div>

                          {/* Score - Prominent */}
                          <div style={{ minWidth: '100px', textAlign: 'center', borderRight: '1px solid var(--border)', paddingRight: '24px' }}>
                            <div style={{ fontSize: '11px', color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '4px' }}>
                              Score
                            </div>
                            <div style={{ fontSize: '32px', fontWeight: 700, color: scoreColor, lineHeight: 1 }}>
                              {survey.stats?.percentage || 0}%
                            </div>
                          </div>

                          {/* Status Badge */}
                          <div style={{ minWidth: '100px' }}>
                            <div style={{ fontSize: '11px', color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '4px' }}>
                              Status
                            </div>
                            <div style={{
                              background: survey.status === 'completed' ? 'rgba(39, 174, 96, 0.12)' : 'rgba(241, 196, 15, 0.12)',
                              color: survey.status === 'completed' ? 'var(--success)' : 'var(--warning)',
                              padding: '6px 12px',
                              borderRadius: '6px',
                              fontSize: '13px',
                              fontWeight: 600,
                              display: 'inline-flex',
                              alignItems: 'center',
                              gap: '5px'
                            }}>
                              {survey.status === 'completed' ? Icons.checkCircle({ size: 13, color: 'var(--success)' }) : null}
                              {survey.status === 'completed' ? 'Finalized' : 'In Progress'}
                            </div>
                          </div>

                          {/* Submission Date - Only for completed */}
                          {survey.status === 'completed' && survey.completedAt && (
                            <div style={{ minWidth: '130px', borderLeft: '1px solid var(--border)', paddingLeft: '20px' }}>
                              <div style={{ fontSize: '11px', color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '4px' }}>
                                Submitted
                              </div>
                              <div style={{ fontSize: '13px', color: 'var(--text-secondary)', fontWeight: 500 }}>
                                {new Date(survey.completedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                <span style={{ color: 'var(--text-muted)', fontWeight: 400, marginLeft: '6px' }}>
                                  {new Date(survey.completedAt).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}
                                </span>
                              </div>
                            </div>
                          )}

                          {/* Edited Date - Only if assessment was modified after initial submission */}
                          {survey.status === 'completed' && survey.lastEditedAt && (
                            <div style={{ minWidth: '130px', borderLeft: '1px solid var(--border)', paddingLeft: '20px' }}>
                              <div style={{ fontSize: '11px', color: '#f59e0b', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '4px', display: 'flex', alignItems: 'center', gap: '4px' }}>
                                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                                Edited
                              </div>
                              <div style={{ fontSize: '13px', color: '#d97706', fontWeight: 500 }}>
                                {new Date(survey.lastEditedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                <span style={{ color: '#f59e0b', fontWeight: 400, marginLeft: '6px' }}>
                                  {new Date(survey.lastEditedAt).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}
                                </span>
                              </div>
                            </div>
                          )}

                          {/* Spacer */}
                          <div style={{ flex: 1 }}></div>

                          {/* Action Buttons */}
                          <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                            {/* Edit Button */}
                            <button
                              onClick={(e) => { e.stopPropagation(); onEditSurvey && onEditSurvey(survey); }}
                              title="Edit Details"
                              style={{
                                width: '38px', height: '38px', borderRadius: '10px',
                                border: '1px solid var(--border)', background: 'white',
                                color: 'var(--text-muted)', cursor: 'pointer',
                                display: 'flex', alignItems: 'center', justifyContent: 'center',
                                transition: 'all 0.2s ease'
                              }}
                              onMouseOver={(e) => { e.currentTarget.style.background = 'var(--primary)'; e.currentTarget.style.color = 'white'; e.currentTarget.style.borderColor = 'var(--primary)'; }}
                              onMouseOut={(e) => { e.currentTarget.style.background = 'white'; e.currentTarget.style.color = 'var(--text-muted)'; e.currentTarget.style.borderColor = 'var(--border)'; }}
                            >
                              {Icons.edit({ size: 16 })}
                            </button>

                            {/* Delete Button */}
                            <button
                              onClick={(e) => { e.stopPropagation(); onDeleteSurvey && onDeleteSurvey(survey); }}
                              title="Delete Assessment"
                              style={{
                                width: '38px', height: '38px', borderRadius: '10px',
                                border: '1px solid rgba(231, 76, 60, 0.3)', background: 'rgba(231, 76, 60, 0.05)',
                                color: 'var(--danger)', cursor: 'pointer',
                                display: 'flex', alignItems: 'center', justifyContent: 'center',
                                transition: 'all 0.2s ease'
                              }}
                              onMouseOver={(e) => { e.currentTarget.style.background = 'var(--danger)'; e.currentTarget.style.color = 'white'; e.currentTarget.style.borderColor = 'var(--danger)'; }}
                              onMouseOut={(e) => { e.currentTarget.style.background = 'rgba(231, 76, 60, 0.05)'; e.currentTarget.style.color = 'var(--danger)'; e.currentTarget.style.borderColor = 'rgba(231, 76, 60, 0.3)'; }}
                            >
                              {Icons.trash({ size: 16 })}
                            </button>

                            {/* Expand Arrow */}
                            <div style={{
                              width: '38px', height: '38px', borderRadius: '10px',
                              background: isExpanded ? 'var(--primary)' : 'var(--bg-hover)',
                              display: 'flex', alignItems: 'center', justifyContent: 'center',
                              transition: 'all 0.2s ease',
                              marginLeft: '4px'
                            }}>
                              <span style={{
                                color: isExpanded ? 'white' : 'var(--text-muted)',
                                fontSize: '12px',
                                transform: isExpanded ? 'rotate(180deg)' : 'rotate(0)',
                                transition: 'transform 0.2s'
                              }}></span>
                            </div>
                          </div>
                        </div>

                        {/* Expanded Details */}
                        {isExpanded && (
                          <div style={{ borderTop: '1px solid var(--border)', padding: '24px', background: 'var(--bg-main)' }}>
                            {/* Coordinator Info */}
                            {details && (
                              <div style={{ marginBottom: '24px' }}>
                                <div style={{ fontSize: '12px', fontWeight: 600, color: 'var(--text-muted)', textTransform: 'uppercase', marginBottom: '12px' }}>
                                  Coordinator Contact
                                </div>
                                <div style={{ display: 'flex', gap: '24px', alignItems: 'center', flexWrap: 'wrap' }}>
                                  <div style={{ fontWeight: 500 }}>{details.coordinatorName}</div>
                                  {details.coordinatorPhone && (
                                    <a href={`https://wa.me/${formatWhatsApp(details.coordinatorPhone)}`}
                                      target="_blank" rel="noopener noreferrer"
                                      className="contact-link whatsapp"
                                      style={{ display: 'inline-flex', alignItems: 'center', gap: '6px' }}>
                                      {Icons.whatsapp({ size: 16 })} {details.coordinatorPhone}
                                    </a>
                                  )}
                                  {details.coordinatorEmail && (
                                    <a href={`mailto:${details.coordinatorEmail}`}
                                      className="contact-link email"
                                      style={{ display: 'inline-flex', alignItems: 'center', gap: '6px' }}>
                                      {Icons.mail({ size: 16, color: 'var(--accent)' })} {details.coordinatorEmail}
                                    </a>
                                  )}
                                </div>
                              </div>
                            )}

                            {/* Score Breakdown */}
                            <div style={{ fontSize: '12px', fontWeight: 600, color: 'var(--text-muted)', textTransform: 'uppercase', marginBottom: '12px' }}>
                              Score Breakdown
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '12px' }}>
                              <div style={{ background: 'white', padding: '14px', borderRadius: '8px', textAlign: 'center', border: '1px solid var(--border)' }}>
                                <div style={{ fontSize: '20px', fontWeight: 600, color: 'var(--text-primary)' }}>{survey.stats?.scored || 0}</div>
                                <div style={{ fontSize: '11px', color: 'var(--text-muted)', marginTop: '4px' }}>Total Scored</div>
                              </div>
                              <div style={{ background: 'rgba(46, 204, 113, 0.1)', padding: '14px', borderRadius: '8px', textAlign: 'center' }}>
                                <div style={{ fontSize: '20px', fontWeight: 600, color: 'var(--success)' }}>{survey.stats?.fullyMet || 0}</div>
                                <div style={{ fontSize: '11px', color: 'var(--success)', marginTop: '4px' }}>Fully Met</div>
                              </div>
                              <div style={{ background: 'rgba(241, 196, 15, 0.1)', padding: '14px', borderRadius: '8px', textAlign: 'center' }}>
                                <div style={{ fontSize: '20px', fontWeight: 600, color: 'var(--warning)' }}>{survey.stats?.partial || 0}</div>
                                <div style={{ fontSize: '11px', color: 'var(--warning)', marginTop: '4px' }}>Partial</div>
                              </div>
                              <div style={{ background: 'rgba(231, 76, 60, 0.1)', padding: '14px', borderRadius: '8px', textAlign: 'center' }}>
                                <div style={{ fontSize: '20px', fontWeight: 600, color: 'var(--danger)' }}>{survey.stats?.notMet || 0}</div>
                                <div style={{ fontSize: '11px', color: 'var(--danger)', marginTop: '4px' }}>Not Met</div>
                              </div>
                              <div style={{ background: 'rgba(149, 165, 166, 0.1)', padding: '14px', borderRadius: '8px', textAlign: 'center' }}>
                                <div style={{ fontSize: '20px', fontWeight: 600, color: 'var(--neutral)' }}>{survey.stats?.na || 0}</div>
                                <div style={{ fontSize: '11px', color: 'var(--neutral)', marginTop: '4px' }}>N/A</div>
                              </div>
                            </div>

                            {/* Submission ID */}
                            <div style={{ marginTop: '20px', fontSize: '12px', color: 'var(--text-muted)' }}>
                              Submission ID: <code style={{ background: 'var(--bg-hover)', padding: '2px 8px', borderRadius: '4px' }}>{survey.id}</code>
                            </div>
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    // Executive Summary Modal for Completed Assessments
    const ExecutiveSummaryModal = ({ survey, onClose, chapters, onViewFullDetails }) => {
      const [expandedChapters, setExpandedChapters] = useState({});
      const [showShareModal, setShowShareModal] = useState(false);
      const [shareCredentials, setShareCredentials] = useState(null);
      const [copied, setCopied] = useState(false);
      const [exportingExcel, setExportingExcel] = useState(false);
      const [exportingPDF, setExportingPDF] = useState(false);
      const [showMobileWarning, setShowMobileWarning] = useState(false);

      // Mobile detection for Executive Summary Modal
      const [isMobile, setIsMobile] = useState(window.innerWidth <= 768);
      useEffect(() => {
        const checkMobile = () => setIsMobile(window.innerWidth <= 768);
        window.addEventListener('resize', checkMobile);
        return () => window.removeEventListener('resize', checkMobile);
      }, []);

      if (!survey) return null;

      // Generate share credentials for this assessment - Password only (no username)
      const generateShareCredentials = () => {
        const centerName = survey.assessmentDetails?.centerName || 'Assessment';
        // Generate a simple 6-character password (easier to share)
        const password = Math.random().toString(36).slice(-6).toUpperCase();
        // Create a unique share ID
        const shareId = `share_${survey.id}_${Date.now().toString(36)}`;

        const credentials = {
          shareId,
          password,
          surveyId: survey.id,
          centerName,
          createdAt: new Date().toISOString(),
          expiresAt: null // No expiry for now
        };

        // Store the share credentials
        const existingShares = JSON.parse(localStorage.getItem('cbahi_shared_assessments') || '[]');
        // Remove any existing share for this survey
        const updatedShares = existingShares.filter(s => s.surveyId !== survey.id);
        updatedShares.push(credentials);
        localStorage.setItem('cbahi_shared_assessments', JSON.stringify(updatedShares));

        setShareCredentials(credentials);
        return credentials;
      };

      const handleShare = () => {
        const creds = generateShareCredentials();
        setShowShareModal(true);
      };

      const getShareUrl = () => {
        if (!shareCredentials) return '';
        const baseUrl = window.location.origin + window.location.pathname;
        return `${baseUrl}?view=${shareCredentials.shareId}`;
      };

      const copyToClipboard = (text) => {
        navigator.clipboard.writeText(text);
        setCopied(true);
        setTimeout(() => setCopied(false), 2000);
      };

      const details = survey.assessmentDetails || {};
      const stats = survey.stats || {};
      const scores = survey.scores || {};

      const toggleChapter = (chapterId) => {
        setExpandedChapters(prev => ({ ...prev, [chapterId]: !prev[chapterId] }));
      };

      // Calculate chapter-by-chapter breakdown
      // Activity type labels for PDF/Excel export
      const activityLabels = {
        'DOC': 'Document Review',
        'OBS': 'Observation',
        'INT': 'Interview',
        'PER': 'Personnel File',
        'DEN': 'Dental Record'
      };

      const getChapterBreakdown = () => {
        if (!chapters || !Array.isArray(chapters)) return [];
        return chapters.filter(ch => !ch.placeholder).map(chapter => {
          const substandardsList = [];
          (chapter.standards || []).forEach(std => {
            (std.substandards || []).forEach(sub => {
              const score = scores[sub.id];
              const activityCode = sub.activityType || 'DOC';
              substandardsList.push({
                id: sub.id,
                text: sub.text,
                score: score?.value !== undefined ? score.value : null,
                findings: score?.findings || '',
                recommendations: score?.recommendations || '',
                activityType: activityCode,
                activityLabel: activityLabels[activityCode] || 'Document Review'
              });
            });
          });

          const scored = substandardsList.filter(s => s.score !== null);
          const fullyMet = scored.filter(s => s.score === 2).length;
          const partial = scored.filter(s => s.score === 1).length;
          const notMet = scored.filter(s => s.score === 0).length;
          const na = scored.filter(s => s.score === -1).length;
          const totalApplicable = fullyMet + partial + notMet;
          const maxScore = totalApplicable * 2;
          const actualScore = (fullyMet * 2) + (partial * 1);
          const percentage = maxScore > 0 ? Math.round((actualScore / maxScore) * 100) : 0;

          // Get findings (Not Met and Partial items)
          const findings = substandardsList.filter(s => s.score === 0 || s.score === 1);

          return {
            id: chapter.id,
            name: chapter.name,
            fullyMet,
            partial,
            notMet,
            na,
            percentage,
            total: substandardsList.length,
            substandards: substandardsList,
            findings
          };
        });
      };

      const chapterData = getChapterBreakdown();
      const totalFindings = chapterData.reduce((sum, ch) => sum + ch.findings.length, 0);

      // Generate Action Plan with AI-suggested corrective actions
      const generateActionPlan = () => {
        const actions = [];
        chapterData.forEach(ch => {
          ch.findings.forEach(f => {
            // Generate suggested action based on the standard
            let suggestedAction = f.recommendations || '';
            if (!suggestedAction) {
              // AI-suggested default actions based on score
              if (f.score === 0) {
                suggestedAction = `Immediate action required: Develop and implement a comprehensive policy/procedure to address ${f.id}. Assign responsible person, establish monitoring mechanism.`;
              } else {
                suggestedAction = `Enhancement needed: Review current practices for ${f.id} and identify gaps. Update documentation, provide staff training, and ensure consistent implementation.`;
              }
            }

            // Smart target days based on complexity analysis
            const textLength = (f.text || '').length;
            const hasMultipleComponents = (f.text || '').includes(' and ') || (f.text || '').includes(', ');
            const isDocumentationRelated = /document|record|policy|procedure|log|form/i.test(f.text || '');
            const isTrainingRelated = /train|competen|educat|orient/i.test(f.text || '');
            const isInfrastructure = /equipment|facility|install|construct/i.test(f.text || '');

            let targetDays, targetRange;
            if (f.score === 0) {
              // Not Met - more urgent, but still depends on complexity
              if (textLength < 80 && !hasMultipleComponents && isDocumentationRelated) {
                targetDays = 10; targetRange = '7-14';  // Quick win - simple documentation
              } else if (textLength < 120 || isDocumentationRelated) {
                targetDays = 14; targetRange = '10-21'; // Medium quick
              } else if (isTrainingRelated || hasMultipleComponents) {
                targetDays = 21; targetRange = '14-28'; // Needs planning
              } else if (isInfrastructure) {
                targetDays = 30; targetRange = '21-45'; // Infrastructure needs time
              } else {
                targetDays = 21; targetRange = '14-30'; // Default urgent
              }
            } else {
              // Partial - enhancement, more flexibility
              if (textLength < 80 && isDocumentationRelated) {
                targetDays = 14; targetRange = '10-21'; // Quick enhancement
              } else if (textLength < 120) {
                targetDays = 21; targetRange = '14-28'; // Standard improvement
              } else if (isTrainingRelated) {
                targetDays = 28; targetRange = '21-35'; // Training takes time
              } else {
                targetDays = 21; targetRange = '14-30'; // Default medium
              }
            }

            actions.push({
              ...f,
              chapter: ch.name,
              priority: f.score === 0 ? 'High' : 'Medium',
              priorityColor: f.score === 0 ? 'var(--danger)' : 'var(--warning)',
              suggestedAction,
              targetDays,
              targetRange
            });
          });
        });
        return actions.sort((a, b) => a.score - b.score);
      };

      const actionPlanItems = generateActionPlan();

      const getScoreLabel = (score) => {
        switch (score) {
          case 2: return { text: 'Fully Met', color: 'var(--success)', bg: 'rgba(46, 204, 113, 0.1)' };
          case 1: return { text: 'Partial', color: 'var(--warning)', bg: 'rgba(241, 196, 15, 0.1)' };
          case 0: return { text: 'Not Met', color: 'var(--danger)', bg: 'rgba(231, 76, 60, 0.1)' };
          case -1: return { text: 'N/A', color: 'var(--text-muted)', bg: 'rgba(128, 128, 128, 0.1)' };
          default: return { text: 'Not Scored', color: 'var(--text-muted)', bg: 'var(--bg-hover)' };
        }
      };

      // Get compliance level
      const getComplianceLevel = (pct) => {
        if (pct >= 90) return { label: 'Excellent', color: '#27ae60', bg: 'rgba(39, 174, 96, 0.1)' };
        if (pct >= 75) return { label: 'Good', color: '#2ecc71', bg: 'rgba(46, 204, 113, 0.1)' };
        if (pct >= 60) return { label: 'Acceptable', color: '#f39c12', bg: 'rgba(243, 156, 18, 0.1)' };
        if (pct >= 40) return { label: 'Needs Improvement', color: '#e67e22', bg: 'rgba(230, 126, 34, 0.1)' };
        return { label: 'Critical', color: '#e74c3c', bg: 'rgba(231, 76, 60, 0.1)' };
      };

      const compliance = getComplianceLevel(stats.percentage || 0);

      // Export to Excel function - Professional formatting with ExcelJS (Enhanced Spacing)
      const exportToExcel = async () => {
        const ExcelJS = window.ExcelJS;
        if (!ExcelJS) {
          alert('Excel export library not loaded. Please refresh and try again.');
          return;
        }

        // Generate filename
        const centerName = (details.centerName || 'Assessment').replace(/[^a-zA-Z0-9]/g, '_');
        const date = new Date().toISOString().split('T')[0];
        const filename = `StandardsHub_${centerName}_${date}.xlsx`;

        // Count findings by domain
        const findingsByDomain = {};
        let highCount = 0, medCount = 0;
        chapterData.forEach(ch => {
          const findings = ch.substandards.filter(s => s.score === 0 || s.score === 1);
          if (findings.length > 0) findingsByDomain[ch.name] = findings.length;
          highCount += ch.substandards.filter(s => s.score === 0).length;
          medCount += ch.substandards.filter(s => s.score === 1).length;
        });
        const maxFindings = Math.max(...Object.values(findingsByDomain), 1);

        // Score status determination
        const scoreStatus = stats.percentage >= 90 ? { text: 'Excellent', color: '155724' } :
          stats.percentage >= 80 ? { text: 'Good', color: '155724' } :
            stats.percentage >= 70 ? { text: 'Needs Improvement', color: '856404' } :
              { text: 'Critical', color: '721C24' };

        // Create workbook with ExcelJS for professional formatting
        const workbook = new ExcelJS.Workbook();
        workbook.creator = 'StandardsHub';
        workbook.created = new Date();

        // Helper function to create colored bar cells with GRID appearance (individual squares)
        const createBarCells = (ws, row, startCol, percentage, barColor) => {
          const totalBars = 20;
          const filledBars = Math.round(percentage / 5);
          for (let i = 0; i < totalBars; i++) {
            const cell = ws.getCell(row, startCol + i);
            if (i < filledBars) {
              cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: barColor } };
            } else {
              cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE8E8E8' } };
            }
            // Add thin white borders to create grid/square appearance
            cell.border = {
              top: { style: 'thin', color: { argb: 'FFFFFFFF' } },
              bottom: { style: 'thin', color: { argb: 'FFFFFFFF' } },
              left: { style: 'thin', color: { argb: 'FFFFFFFF' } },
              right: { style: 'thin', color: { argb: 'FFFFFFFF' } }
            };
          }
          // Add percentage label after bar
          const labelCell = ws.getCell(row, startCol + totalBars);
          labelCell.value = `${percentage}%`;
          labelCell.font = { size: 10, bold: true };
          labelCell.alignment = { horizontal: 'left', vertical: 'middle' };
        };

        // ===================== SHEET 1: EXECUTIVE SUMMARY =====================
        const ws1 = workbook.addWorksheet('Executive Summary');

        // Set column widths - WIDER columns for better text containment and extended tables
        // A=Domain/Label, B=Status/Value, C=Count, D=Percentage, E onwards=Bar cells
        ws1.columns = [
          { width: 32 },  // A - Labels/Domain names (wider)
          { width: 22 },  // B - Status labels (wider for "Partially Met")
          { width: 12 },  // C - Count
          { width: 18 },  // D - Percentage/text
          { width: 2.5 }, { width: 2.5 }, { width: 2.5 }, { width: 2.5 }, { width: 2.5 },  // E-I - Bar cells
          { width: 2.5 }, { width: 2.5 }, { width: 2.5 }, { width: 2.5 }, { width: 2.5 },  // J-N - Bar cells
          { width: 2.5 }, { width: 2.5 }, { width: 2.5 }, { width: 2.5 }, { width: 2.5 },  // O-S - Bar cells
          { width: 2.5 }, { width: 2.5 }, { width: 2.5 }, { width: 2.5 }, { width: 2.5 },  // T-X - Bar cells
          { width: 8 }    // Y - Percentage label
        ];

        let currentRow = 1;

        // ===== ROW 1: Title - WIDE AND CENTERED =====
        ws1.mergeCells(`A${currentRow}:Y${currentRow}`);
        const titleCell = ws1.getCell(`A${currentRow}`);
        titleCell.value = ' StandardsHub';
        titleCell.font = { name: 'Lora', size: 26, bold: true, color: { argb: 'FF1E3A5F' } };
        titleCell.alignment = { horizontal: 'center', vertical: 'middle' };
        titleCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF8FAFC' } };
        ws1.getRow(currentRow).height = 45;
        currentRow++;

        // ===== ROW 2: Subtitle - CENTERED =====
        ws1.mergeCells(`A${currentRow}:Y${currentRow}`);
        const subtitleCell = ws1.getCell(`A${currentRow}`);
        subtitleCell.value = 'Healthcare Accreditation Assessment Report';
        subtitleCell.font = { name: 'Lora', size: 13, italic: true, color: { argb: 'FF666666' } };
        subtitleCell.alignment = { horizontal: 'center', vertical: 'middle' };
        ws1.getRow(currentRow).height = 22;
        currentRow++;

        // ===== SPACER ROWS (2 empty rows after header) =====
        currentRow += 2;

        // ===== ASSESSMENT INFORMATION SECTION =====
        ws1.mergeCells(`A${currentRow}:Y${currentRow}`);
        const infoHeader = ws1.getCell(`A${currentRow}`);
        infoHeader.value = ' Assessment Information';
        infoHeader.font = { name: 'Lora', size: 14, bold: true, color: { argb: 'FFFFFFFF' } };
        infoHeader.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1E3A5F' } };
        infoHeader.alignment = { horizontal: 'left', vertical: 'middle' };
        ws1.getRow(currentRow).height = 28;
        currentRow++;

        // Assessment info rows with proper layout and alignment
        const infoData = [
          ['Center Name', details.centerName || '-', 'Configuration', `${survey.configuration || '-'} - Full Survey`],
          ['Coordinator', details.coordinatorName || '-', 'Assessment Date', new Date(survey.completedAt || survey.createdAt).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: '2-digit' })],
          ['Phone', details.coordinatorPhone || '-', 'Email', details.coordinatorEmail || '-']
        ];

        infoData.forEach((row) => {
          ws1.getCell(currentRow, 1).value = row[0];
          ws1.getCell(currentRow, 1).font = { name: 'Lora', size: 11, bold: true, color: { argb: 'FF1E3A5F' } };
          ws1.getCell(currentRow, 1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF0F4F8' } };
          ws1.getCell(currentRow, 1).alignment = { horizontal: 'left', vertical: 'middle' };
          ws1.getCell(currentRow, 1).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
          ws1.getCell(currentRow, 2).value = row[1];
          ws1.getCell(currentRow, 2).font = { name: 'Lora', size: 11 };
          ws1.getCell(currentRow, 2).alignment = { horizontal: 'left', vertical: 'middle' };
          ws1.getCell(currentRow, 2).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
          ws1.getCell(currentRow, 3).value = row[2];
          ws1.getCell(currentRow, 3).font = { name: 'Lora', size: 11, bold: true, color: { argb: 'FF1E3A5F' } };
          ws1.getCell(currentRow, 3).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF0F4F8' } };
          ws1.getCell(currentRow, 3).alignment = { horizontal: 'left', vertical: 'middle' };
          ws1.getCell(currentRow, 3).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
          ws1.getCell(currentRow, 4).value = row[3];
          ws1.getCell(currentRow, 4).font = { name: 'Lora', size: 11 };
          ws1.getCell(currentRow, 4).alignment = { horizontal: 'left', vertical: 'middle' };
          ws1.getCell(currentRow, 4).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
          ws1.getRow(currentRow).height = 22;
          currentRow++;
        });

        // ===== SPACER (2 empty rows) =====
        currentRow += 2;

        // ===== OVERALL COMPLIANCE SCORE SECTION =====
        ws1.mergeCells(`A${currentRow}:Y${currentRow}`);
        const scoreHeader = ws1.getCell(`A${currentRow}`);
        scoreHeader.value = ' Overall Compliance Score';
        scoreHeader.font = { name: 'Lora', size: 14, bold: true, color: { argb: 'FFFFFFFF' } };
        scoreHeader.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1E3A5F' } };
        scoreHeader.alignment = { horizontal: 'left', vertical: 'middle' };
        ws1.getRow(currentRow).height = 28;
        currentRow++;

        // Score gauge display - larger and more prominent
        ws1.mergeCells(currentRow, 1, currentRow, 2);
        ws1.getCell(currentRow, 1).value = `${stats.percentage || 0}%`;
        ws1.getCell(currentRow, 1).font = { name: 'Lora', size: 42, bold: true, color: { argb: 'FF1E3A5F' } };
        ws1.getCell(currentRow, 1).alignment = { horizontal: 'center', vertical: 'middle' };
        ws1.mergeCells(currentRow, 3, currentRow, 4);
        ws1.getCell(currentRow, 3).value = scoreStatus.text;
        ws1.getCell(currentRow, 3).font = { name: 'Lora', size: 20, bold: true, color: { argb: 'FF' + scoreStatus.color } };
        ws1.getCell(currentRow, 3).alignment = { horizontal: 'left', vertical: 'middle' };
        ws1.getRow(currentRow).height = 50;
        currentRow++;

        // ===== SPACER =====
        currentRow++;

        // Score breakdown table headers
        const scoreTableHeaderRow = currentRow;
        ws1.getCell(currentRow, 2).value = 'Status';
        ws1.getCell(currentRow, 3).value = 'Count';
        ws1.getCell(currentRow, 4).value = 'Percentage';
        ws1.mergeCells(currentRow, 5, currentRow, 25);
        ws1.getCell(currentRow, 5).value = 'Visual';

        [2, 3, 4, 5].forEach(col => {
          const cell = ws1.getCell(currentRow, col);
          cell.font = { name: 'Lora', bold: true, color: { argb: 'FFFFFFFF' } };
          cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1E3A5F' } };
          cell.alignment = { horizontal: 'center', vertical: 'middle' };
          cell.border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
        });
        ws1.getRow(currentRow).height = 22;
        currentRow++;

        // Score breakdown data rows
        const fmPct = stats.scored ? Math.round((stats.fullyMet / stats.scored) * 100) : 0;
        const pmPct = stats.scored ? Math.round((stats.partial / stats.scored) * 100) : 0;
        const nmPct = stats.scored ? Math.round((stats.notMet / stats.scored) * 100) : 0;

        const scoreRowsData = [
          { status: ' Fully Met', count: stats.fullyMet || 0, pct: fmPct, color: 'FF2E7D32', bgColor: 'FFD4EDDA', barColor: 'FF2E7D32' },
          { status: ' Partially Met', count: stats.partial || 0, pct: pmPct, color: 'FFD68910', bgColor: 'FFFFF3CD', barColor: 'FFF5A623' },
          { status: ' Not Met', count: stats.notMet || 0, pct: nmPct, color: 'FFC62828', bgColor: 'FFF8D7DA', barColor: 'FFC62828' },
          { status: ' N/A', count: stats.na || 0, pct: null, color: 'FF6C757D', bgColor: 'FFE9ECEF', barColor: null }
        ];

        scoreRowsData.forEach((row) => {
          ws1.getCell(currentRow, 2).value = row.status;
          ws1.getCell(currentRow, 2).font = { name: 'Lora', size: 11, bold: true, color: { argb: row.color } };
          ws1.getCell(currentRow, 2).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: row.bgColor } };
          ws1.getCell(currentRow, 2).alignment = { horizontal: 'center', vertical: 'middle' };
          ws1.getCell(currentRow, 2).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };

          ws1.getCell(currentRow, 3).value = row.count;
          ws1.getCell(currentRow, 3).font = { name: 'Lora', size: 14, bold: true, color: { argb: row.color } };
          ws1.getCell(currentRow, 3).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: row.bgColor } };
          ws1.getCell(currentRow, 3).alignment = { horizontal: 'center', vertical: 'middle' };
          ws1.getCell(currentRow, 3).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };

          ws1.getCell(currentRow, 4).value = row.pct !== null ? `${row.pct}%` : 'Excluded';
          ws1.getCell(currentRow, 4).font = { name: 'Lora', size: 12, bold: true, color: { argb: row.color } };
          ws1.getCell(currentRow, 4).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: row.bgColor } };
          ws1.getCell(currentRow, 4).alignment = { horizontal: 'center', vertical: 'middle' };
          ws1.getCell(currentRow, 4).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };

          if (row.barColor && row.pct !== null) {
            createBarCells(ws1, currentRow, 5, row.pct, row.barColor);
          }
          ws1.getRow(currentRow).height = 24;
          currentRow++;
        });

        // Total Scored row
        ws1.getCell(currentRow, 2).value = 'TOTAL SCORED';
        ws1.getCell(currentRow, 2).font = { name: 'Lora', size: 11, bold: true, color: { argb: 'FFFFFFFF' } };
        ws1.getCell(currentRow, 2).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1E3A5F' } };
        ws1.getCell(currentRow, 2).alignment = { horizontal: 'center', vertical: 'middle' };
        ws1.getCell(currentRow, 2).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
        ws1.getCell(currentRow, 3).value = stats.scored || 0;
        ws1.getCell(currentRow, 3).font = { name: 'Lora', size: 14, bold: true, color: { argb: 'FFFFFFFF' } };
        ws1.getCell(currentRow, 3).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1E3A5F' } };
        ws1.getCell(currentRow, 3).alignment = { horizontal: 'center' };
        ws1.getCell(currentRow, 3).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
        ws1.mergeCells(currentRow, 4, currentRow, 6);
        ws1.getCell(currentRow, 4).value = `of ${stats.total || 0} sub-standards`;
        ws1.getCell(currentRow, 4).font = { color: { argb: 'FFFFFFFF' } };
        ws1.getCell(currentRow, 4).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1E3A5F' } };
        ws1.getCell(currentRow, 4).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
        ws1.getRow(currentRow).height = 22;
        currentRow++;

        // ===== SPACER (3 empty rows) =====
        currentRow += 3;

        // ===== DOMAIN PERFORMANCE ANALYSIS SECTION =====
        ws1.mergeCells(`A${currentRow}:Y${currentRow}`);
        const domainHeader = ws1.getCell(`A${currentRow}`);
        domainHeader.value = ' Domain Performance Analysis';
        domainHeader.font = { name: 'Lora', size: 14, bold: true, color: { argb: 'FFFFFFFF' } };
        domainHeader.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1E3A5F' } };
        domainHeader.alignment = { horizontal: 'left', vertical: 'middle' };
        ws1.getRow(currentRow).height = 28;
        currentRow++;

        // Domain table headers
        ws1.getCell(currentRow, 1).value = 'Domain';
        ws1.getCell(currentRow, 2).value = 'Score';
        ws1.getCell(currentRow, 3).value = 'Fully Met';
        ws1.getCell(currentRow, 4).value = 'Not Met';
        ws1.mergeCells(currentRow, 5, currentRow, 25);
        ws1.getCell(currentRow, 5).value = 'Performance Bar';

        [1, 2, 3, 4, 5].forEach(col => {
          const cell = ws1.getCell(currentRow, col);
          cell.font = { name: 'Lora', bold: true, color: { argb: 'FFFFFFFF' } };
          cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1E3A5F' } };
          cell.alignment = { horizontal: 'center', vertical: 'middle' };
          cell.border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
        });
        ws1.getRow(currentRow).height = 22;
        currentRow++;

        // Domain performance rows
        chapterData.forEach((ch, idx) => {
          const altBg = idx % 2 === 1 ? 'FFF8F9FA' : 'FFFFFFFF';
          const scoreColor = ch.percentage >= 90 ? 'FF2E7D32' : ch.percentage >= 70 ? 'FFD68910' : 'FFC62828';

          ws1.getCell(currentRow, 1).value = ch.name;
          ws1.getCell(currentRow, 1).font = { name: 'Lora', size: 11, bold: true };
          ws1.getCell(currentRow, 1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: altBg } };
          ws1.getCell(currentRow, 1).alignment = { horizontal: 'left', vertical: 'middle' };
          ws1.getCell(currentRow, 1).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };

          ws1.getCell(currentRow, 2).value = `${ch.percentage}%`;
          ws1.getCell(currentRow, 2).font = { name: 'Lora', size: 13, bold: true, color: { argb: scoreColor } };
          ws1.getCell(currentRow, 2).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: altBg } };
          ws1.getCell(currentRow, 2).alignment = { horizontal: 'center', vertical: 'middle' };
          ws1.getCell(currentRow, 2).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };

          ws1.getCell(currentRow, 3).value = ch.fullyMet;
          ws1.getCell(currentRow, 3).font = { name: 'Lora', size: 13, bold: true, color: { argb: 'FF2E7D32' } };
          ws1.getCell(currentRow, 3).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: altBg } };
          ws1.getCell(currentRow, 3).alignment = { horizontal: 'center', vertical: 'middle' };
          ws1.getCell(currentRow, 3).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };

          ws1.getCell(currentRow, 4).value = ch.notMet;
          ws1.getCell(currentRow, 4).font = { name: 'Lora', size: 13, bold: true, color: { argb: 'FFC62828' } };
          ws1.getCell(currentRow, 4).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: altBg } };
          ws1.getCell(currentRow, 4).alignment = { horizontal: 'center', vertical: 'middle' };
          ws1.getCell(currentRow, 4).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };

          createBarCells(ws1, currentRow, 5, ch.percentage, 'FF2E7D32');
          ws1.getRow(currentRow).height = 24;
          currentRow++;
        });

        // ===== SPACER (3 empty rows) =====
        currentRow += 3;

        // ===== QUICK STATISTICS SECTION (with WIDER cards using merged cells) =====
        ws1.mergeCells(`A${currentRow}:Y${currentRow}`);
        const quickHeader = ws1.getCell(`A${currentRow}`);
        quickHeader.value = ' Quick Statistics';
        quickHeader.font = { name: 'Lora', size: 14, bold: true, color: { argb: 'FFFFFFFF' } };
        quickHeader.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1E3A5F' } };
        quickHeader.alignment = { horizontal: 'left', vertical: 'middle' };
        ws1.getRow(currentRow).height = 28;
        currentRow++;

        // Stats cards - WIDER MERGED CELLS with proper spacing
        const statsHeaderRow = currentRow;
        const statsValueRow = currentRow + 1;

        // Card 1: Total Sub-Standards (Columns A-C merged for wider display)
        ws1.mergeCells(statsHeaderRow, 1, statsHeaderRow, 3);
        ws1.getCell(statsHeaderRow, 1).value = 'Total Sub-Standards';
        ws1.getCell(statsHeaderRow, 1).font = { name: 'Lora', size: 11, bold: true, color: { argb: 'FF1565C0' } };
        ws1.getCell(statsHeaderRow, 1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE3F2FD' } };
        ws1.getCell(statsHeaderRow, 1).alignment = { horizontal: 'center', vertical: 'middle' };
        ws1.getCell(statsHeaderRow, 1).border = { top: { style: 'medium', color: { argb: 'FF1565C0' } }, bottom: { style: 'thin' }, left: { style: 'medium', color: { argb: 'FF1565C0' } }, right: { style: 'medium', color: { argb: 'FF1565C0' } } };
        ws1.mergeCells(statsValueRow, 1, statsValueRow, 3);
        ws1.getCell(statsValueRow, 1).value = stats.total || 0;
        ws1.getCell(statsValueRow, 1).font = { name: 'Lora', size: 36, bold: true, color: { argb: 'FF1565C0' } };
        ws1.getCell(statsValueRow, 1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE3F2FD' } };
        ws1.getCell(statsValueRow, 1).alignment = { horizontal: 'center', vertical: 'middle' };
        ws1.getCell(statsValueRow, 1).border = { top: { style: 'thin' }, bottom: { style: 'medium', color: { argb: 'FF1565C0' } }, left: { style: 'medium', color: { argb: 'FF1565C0' } }, right: { style: 'medium', color: { argb: 'FF1565C0' } } };

        // Column 4 is EMPTY SPACER

        // Card 2: Items with Findings (Columns 5-12 merged for wider display)
        ws1.mergeCells(statsHeaderRow, 5, statsHeaderRow, 12);
        ws1.getCell(statsHeaderRow, 5).value = 'Items with Findings';
        ws1.getCell(statsHeaderRow, 5).font = { name: 'Lora', size: 11, bold: true, color: { argb: 'FFFF8F00' } };
        ws1.getCell(statsHeaderRow, 5).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFF8E1' } };
        ws1.getCell(statsHeaderRow, 5).alignment = { horizontal: 'center', vertical: 'middle' };
        ws1.getCell(statsHeaderRow, 5).border = { top: { style: 'medium', color: { argb: 'FFFF8F00' } }, bottom: { style: 'thin' }, left: { style: 'medium', color: { argb: 'FFFF8F00' } }, right: { style: 'medium', color: { argb: 'FFFF8F00' } } };
        ws1.mergeCells(statsValueRow, 5, statsValueRow, 12);
        ws1.getCell(statsValueRow, 5).value = totalFindings;
        ws1.getCell(statsValueRow, 5).font = { name: 'Lora', size: 36, bold: true, color: { argb: 'FFFF8F00' } };
        ws1.getCell(statsValueRow, 5).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFF8E1' } };
        ws1.getCell(statsValueRow, 5).alignment = { horizontal: 'center', vertical: 'middle' };
        ws1.getCell(statsValueRow, 5).border = { top: { style: 'thin' }, bottom: { style: 'medium', color: { argb: 'FFFF8F00' } }, left: { style: 'medium', color: { argb: 'FFFF8F00' } }, right: { style: 'medium', color: { argb: 'FFFF8F00' } } };

        // Column 13 is EMPTY SPACER

        // Card 3: Accreditation Status (Columns 14-24 merged for MUCH WIDER display)
        ws1.mergeCells(statsHeaderRow, 14, statsHeaderRow, 24);
        ws1.getCell(statsHeaderRow, 14).value = 'Accreditation Status';
        ws1.getCell(statsHeaderRow, 14).font = { name: 'Lora', size: 11, bold: true, color: { argb: 'FF2E7D32' } };
        ws1.getCell(statsHeaderRow, 14).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE8F5E9' } };
        ws1.getCell(statsHeaderRow, 14).alignment = { horizontal: 'center', vertical: 'middle' };
        ws1.getCell(statsHeaderRow, 14).border = { top: { style: 'medium', color: { argb: 'FF2E7D32' } }, bottom: { style: 'thin' }, left: { style: 'medium', color: { argb: 'FF2E7D32' } }, right: { style: 'medium', color: { argb: 'FF2E7D32' } } };
        ws1.mergeCells(statsValueRow, 14, statsValueRow, 24);
        ws1.getCell(statsValueRow, 14).value = stats.percentage >= 70 ? ' LIKELY TO PASS' : ' AT RISK';
        ws1.getCell(statsValueRow, 14).font = { name: 'Lora', size: 18, bold: true, color: { argb: stats.percentage >= 70 ? 'FF2E7D32' : 'FFC62828' } };
        ws1.getCell(statsValueRow, 14).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE8F5E9' } };
        ws1.getCell(statsValueRow, 14).alignment = { horizontal: 'center', vertical: 'middle' };
        ws1.getCell(statsValueRow, 14).border = { top: { style: 'thin' }, bottom: { style: 'medium', color: { argb: 'FF2E7D32' } }, left: { style: 'medium', color: { argb: 'FF2E7D32' } }, right: { style: 'medium', color: { argb: 'FF2E7D32' } } };

        ws1.getRow(statsHeaderRow).height = 25;
        ws1.getRow(statsValueRow).height = 45;

        // ===================== SHEET 2: ALL SCORED ITEMS =====================
        const ws2 = workbook.addWorksheet('All Scored Items');
        ws2.columns = [
          { width: 28 }, { width: 12 }, { width: 65 }, { width: 14 }, { width: 40 }, { width: 40 }, { width: 12 }
        ];

        // Header
        ws2.mergeCells('A1:G1');
        ws2.getCell('A1').value = `Complete Assessment - All ${stats.total || 0} Sub-Standards`;
        ws2.getCell('A1').font = { size: 16, bold: true, color: { argb: 'FF1E3A5F' } };
        ws2.getRow(1).height = 30;

        // Table headers
        const ws2Headers = ['Domain', 'ID', 'Sub-Standard Description', 'Score', 'Finding', 'Recommendation', 'Priority'];
        ws2Headers.forEach((header, idx) => {
          const cell = ws2.getCell(2, idx + 1);
          cell.value = header;
          cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
          cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1E3A5F' } };
          cell.alignment = { horizontal: 'center', vertical: 'middle' };
          cell.border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
        });
        ws2.getRow(2).height = 22;

        // All items with text wrapping
        let ws2Row = 3;
        chapterData.forEach(ch => {
          ch.substandards.forEach((sub) => {
            const altBg = (ws2Row - 3) % 2 === 1 ? 'FFF8F9FA' : 'FFFFFFFF';
            const scoreLabel = sub.score === 2 ? 'Fully Met' : sub.score === 1 ? 'Partially Met' : sub.score === 0 ? 'Not Met' : 'N/A';
            const scoreColor = sub.score === 2 ? 'FF2E7D32' : sub.score === 1 ? 'FFD68910' : sub.score === 0 ? 'FFC62828' : 'FF6C757D';

            ws2.getCell(ws2Row, 1).value = ch.name;
            ws2.getCell(ws2Row, 1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: altBg } };
            ws2.getCell(ws2Row, 1).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
            ws2.getCell(ws2Row, 1).alignment = { wrapText: true, vertical: 'top' };

            ws2.getCell(ws2Row, 2).value = sub.id;
            ws2.getCell(ws2Row, 2).font = { bold: true, color: { argb: 'FF1E3A5F' } };
            ws2.getCell(ws2Row, 2).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: altBg } };
            ws2.getCell(ws2Row, 2).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };

            ws2.getCell(ws2Row, 3).value = sub.text;
            ws2.getCell(ws2Row, 3).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: altBg } };
            ws2.getCell(ws2Row, 3).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
            ws2.getCell(ws2Row, 3).alignment = { wrapText: true, vertical: 'top' };

            ws2.getCell(ws2Row, 4).value = scoreLabel;
            ws2.getCell(ws2Row, 4).font = { bold: true, color: { argb: scoreColor } };
            ws2.getCell(ws2Row, 4).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: altBg } };
            ws2.getCell(ws2Row, 4).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
            ws2.getCell(ws2Row, 4).alignment = { horizontal: 'center' };

            ws2.getCell(ws2Row, 5).value = sub.findings || '-';
            ws2.getCell(ws2Row, 5).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: altBg } };
            ws2.getCell(ws2Row, 5).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
            ws2.getCell(ws2Row, 5).alignment = { wrapText: true, vertical: 'top' };

            ws2.getCell(ws2Row, 6).value = sub.recommendations || '-';
            ws2.getCell(ws2Row, 6).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: altBg } };
            ws2.getCell(ws2Row, 6).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
            ws2.getCell(ws2Row, 6).alignment = { wrapText: true, vertical: 'top' };

            ws2.getCell(ws2Row, 7).value = sub.score === 0 ? 'High' : sub.score === 1 ? 'Medium' : '-';
            ws2.getCell(ws2Row, 7).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: altBg } };
            ws2.getCell(ws2Row, 7).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };

            ws2Row++;
          });
        });

        // ===================== SHEET 3: ACTION PLAN =====================
        const ws3 = workbook.addWorksheet('Action Plan');
        ws3.columns = [
          { width: 6 }, { width: 28 }, { width: 12 }, { width: 55 }, { width: 14 }, { width: 35 }, { width: 40 }, { width: 10 }
        ];

        // Header
        ws3.mergeCells('A1:H1');
        ws3.getCell('A1').value = ` Corrective Action Plan - ${totalFindings} Items Requiring Attention`;
        ws3.getCell('A1').font = { size: 16, bold: true, color: { argb: 'FFFFFFFF' } };
        ws3.getCell('A1').fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE65100' } };
        ws3.getRow(1).height = 30;

        // Priority summary
        ws3.getCell('A3').value = 'Priority Summary:';
        ws3.getCell('A3').font = { bold: true };
        ws3.mergeCells('B3:D3');
        ws3.getCell('B3').value = ` High Priority (Not Met): ${highCount} items - Address within 30 days`;
        ws3.getCell('B3').font = { color: { argb: 'FFC62828' } };
        ws3.mergeCells('B4:D4');
        ws3.getCell('B4').value = ` Medium Priority (Partial): ${medCount} items - Address within 60 days`;
        ws3.getCell('B4').font = { color: { argb: 'FFD68910' } };

        // Table headers
        const ws3Headers = ['#', 'Domain', 'ID', 'Sub-Standard', 'Score', 'Finding', 'Recommended Action', 'Days'];
        ws3Headers.forEach((header, idx) => {
          const cell = ws3.getCell(6, idx + 1);
          cell.value = header;
          cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
          cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE65100' } };
          cell.alignment = { horizontal: 'center', vertical: 'middle' };
          cell.border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
        });
        ws3.getRow(6).height = 22;

        // Action items with text wrapping
        let ws3Row = 7;
        let itemNum = 0;
        chapterData.forEach(ch => {
          ch.substandards.filter(sub => sub.score === 0 || sub.score === 1).forEach(sub => {
            itemNum++;
            const isHigh = sub.score === 0;
            const rowBg = isHigh ? 'FFFDE8E8' : 'FFFEF3E2';
            const scoreColor = isHigh ? 'FFC62828' : 'FFD68910';
            const action = sub.recommendations || (isHigh ? 'Develop and implement policy/procedure. Assign responsible person.' : 'Review practices, update documentation, provide training.');

            ws3.getCell(ws3Row, 1).value = itemNum;
            ws3.getCell(ws3Row, 1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: rowBg } };
            ws3.getCell(ws3Row, 1).alignment = { horizontal: 'center' };
            ws3.getCell(ws3Row, 1).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };

            ws3.getCell(ws3Row, 2).value = ch.name;
            ws3.getCell(ws3Row, 2).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: rowBg } };
            ws3.getCell(ws3Row, 2).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
            ws3.getCell(ws3Row, 2).alignment = { wrapText: true, vertical: 'top' };

            ws3.getCell(ws3Row, 3).value = sub.id;
            ws3.getCell(ws3Row, 3).font = { bold: true, color: { argb: 'FF1E3A5F' } };
            ws3.getCell(ws3Row, 3).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: rowBg } };
            ws3.getCell(ws3Row, 3).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };

            ws3.getCell(ws3Row, 4).value = sub.text;
            ws3.getCell(ws3Row, 4).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: rowBg } };
            ws3.getCell(ws3Row, 4).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
            ws3.getCell(ws3Row, 4).alignment = { wrapText: true, vertical: 'top' };

            ws3.getCell(ws3Row, 5).value = isHigh ? 'Not Met' : 'Partially Met';
            ws3.getCell(ws3Row, 5).font = { bold: true, color: { argb: scoreColor } };
            ws3.getCell(ws3Row, 5).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: rowBg } };
            ws3.getCell(ws3Row, 5).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
            ws3.getCell(ws3Row, 5).alignment = { horizontal: 'center' };

            ws3.getCell(ws3Row, 6).value = sub.findings || '-';
            ws3.getCell(ws3Row, 6).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: rowBg } };
            ws3.getCell(ws3Row, 6).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
            ws3.getCell(ws3Row, 6).alignment = { wrapText: true, vertical: 'top' };

            ws3.getCell(ws3Row, 7).value = action;
            ws3.getCell(ws3Row, 7).font = { color: { argb: 'FF2E7D32' } };
            ws3.getCell(ws3Row, 7).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE8F5E9' } };
            ws3.getCell(ws3Row, 7).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
            ws3.getCell(ws3Row, 7).alignment = { wrapText: true, vertical: 'top' };

            ws3.getCell(ws3Row, 8).value = isHigh ? '30' : '60';
            ws3.getCell(ws3Row, 8).font = { bold: true, color: { argb: scoreColor } };
            ws3.getCell(ws3Row, 8).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: rowBg } };
            ws3.getCell(ws3Row, 8).alignment = { horizontal: 'center' };
            ws3.getCell(ws3Row, 8).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };

            ws3Row++;
          });
        });

        // Download the workbook
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      // Export to PDF function - Enhanced with domain colors, executive narrative, and Lora styling
      const exportToPDF = () => {
        const { jsPDF } = window.jspdf;
        if (!jsPDF) {
          alert('PDF export library not loaded. Please refresh and try again.');
          return;
        }

        const doc = new jsPDF('p', 'mm', 'a4');
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        let yPos = 20;

        // Domain color palette - professional, consistent tones
        const domainColors = {
          'Leadership': { primary: [40, 60, 90], light: [245, 248, 252], name: 'LD' },
          'Leadership of the Organization': { primary: [40, 60, 90], light: [245, 248, 252], name: 'LD' },
          'Provision of Care': { primary: [22, 90, 58], light: [242, 250, 246], name: 'PC' },
          'Dental Laboratory': { primary: [140, 105, 25], light: [253, 250, 242], name: 'DL' },
          'Infection Prevention': { primary: [90, 50, 100], light: [250, 245, 252], name: 'IPC' },
          'Infection Prevention and Control': { primary: [90, 50, 100], light: [250, 245, 252], name: 'IPC' },
          'Management of Information': { primary: [35, 90, 95], light: [242, 250, 252], name: 'MOI' },
          'Facility Management': { primary: [130, 55, 60], light: [252, 245, 246], name: 'FMS' },
          'Facility Management and Safety': { primary: [130, 55, 60], light: [252, 245, 246], name: 'FMS' }
        };

        const getDomainColor = (domainName) => {
          return domainColors[domainName] || { primary: [30, 58, 95], light: [240, 240, 240], name: '?' };
        };

        // Helper function to add new page if needed
        const checkNewPage = (requiredSpace = 30) => {
          if (yPos + requiredSpace > pageHeight - 20) {
            doc.addPage();
            yPos = 20;
            return true;
          }
          return false;
        };

        // Helper to wrap text
        const wrapText = (text, maxWidth) => {
          return doc.splitTextToSize(text, maxWidth);
        };

        // Generate Smart Corrective Action based on sub-standard text and score
        const generateCorrectiveAction = (item) => {
          // If user provided a recommendation, use it
          if (item.recommendations && item.recommendations.trim()) {
            return item.recommendations;
          }

          const text = item.text.toLowerCase();
          const isNotMet = item.score === 0;
          const domain = item.chapter.toLowerCase();

          // Analyze sub-standard text to generate specific actions
          let action = '';

          // Policy/Procedure related
          if (text.includes('policy') || text.includes('procedure') || text.includes('guideline')) {
            action = isNotMet
              ? 'Develop and approve written policy/procedure. Assign owner, set review date, and distribute to all relevant staff.'
              : 'Review existing policy for completeness. Update gaps, obtain approval, and ensure staff acknowledgment.';
          }
          // Documentation/Records
          else if (text.includes('document') || text.includes('record') || text.includes('log') || text.includes('register')) {
            action = isNotMet
              ? 'Create standardized documentation template. Implement tracking system and assign responsibility for maintenance.'
              : 'Audit current records for completeness. Address gaps and implement regular review schedule.';
          }
          // Training/Education
          else if (text.includes('train') || text.includes('educat') || text.includes('orient') || text.includes('competenc')) {
            action = isNotMet
              ? 'Develop training curriculum and schedule. Document attendance and competency verification for all staff.'
              : 'Enhance training program. Add practical assessments and update training materials.';
          }
          // Evaluation/Assessment/Monitoring
          else if (text.includes('evaluat') || text.includes('assess') || text.includes('monitor') || text.includes('audit')) {
            action = isNotMet
              ? 'Establish evaluation criteria and schedule. Create assessment tools and assign responsible personnel.'
              : 'Strengthen monitoring frequency. Improve documentation of findings and follow-up actions.';
          }
          // Communication/Reporting
          else if (text.includes('communicat') || text.includes('report') || text.includes('inform') || text.includes('notify')) {
            action = isNotMet
              ? 'Establish formal communication channels and reporting protocols. Document all communications.'
              : 'Improve communication timeliness and documentation. Verify receipt and understanding.';
          }
          // Safety/Infection Control
          else if (text.includes('safety') || text.includes('infect') || text.includes('steril') || text.includes('hygiene')) {
            action = isNotMet
              ? 'Implement comprehensive safety/infection control program. Train all staff and establish monitoring system.'
              : 'Review current practices against standards. Address gaps and increase compliance monitoring.';
          }
          // Equipment/Maintenance
          else if (text.includes('equipment') || text.includes('maintain') || text.includes('calibrat') || text.includes('device')) {
            action = isNotMet
              ? 'Create equipment inventory and maintenance schedule. Document all maintenance activities and calibrations.'
              : 'Update maintenance logs. Ensure scheduled maintenance is completed and documented.';
          }
          // Patient Care/Rights
          else if (text.includes('patient') || text.includes('consent') || text.includes('right') || text.includes('care plan')) {
            action = isNotMet
              ? 'Develop patient-centered protocols. Train staff on rights and documentation requirements.'
              : 'Audit patient records for compliance. Improve documentation consistency.';
          }
          // Leadership/Governance
          else if (domain.includes('leadership') || text.includes('leader') || text.includes('govern') || text.includes('committee')) {
            action = isNotMet
              ? 'Establish governance structure with clear roles. Document meeting minutes and decisions.'
              : 'Strengthen leadership oversight. Improve documentation of decisions and follow-through.';
          }
          // Quality/Performance Indicators
          else if (text.includes('quality') || text.includes('indicator') || text.includes('performance') || text.includes('benchmark')) {
            action = isNotMet
              ? 'Define quality indicators with targets. Implement data collection and analysis system.'
              : 'Review indicator definitions and targets. Improve data accuracy and reporting frequency.';
          }
          // Default action based on score
          else {
            action = isNotMet
              ? 'Develop implementation plan with clear objectives, responsible persons, and timeline. Document all activities.'
              : 'Review current practices, identify gaps, and implement improvements. Monitor compliance.';
          }

          return action;
        };

        // Generate Executive Narrative based on findings
        const generateExecutiveNarrative = () => {
          const strongDomains = chapterData.filter(ch => ch.percentage >= 90);
          const goodDomains = chapterData.filter(ch => ch.percentage >= 75 && ch.percentage < 90);
          const concernDomains = chapterData.filter(ch => ch.percentage < 75);
          const criticalFindings = actionPlanItems.filter(item => item.score === 0);
          const partialFindings = actionPlanItems.filter(item => item.score === 1);

          let narrative = '';

          // Opening - Overall assessment
          if (stats.percentage >= 90) {
            narrative += `${details.centerName || 'The center'} has demonstrated exceptional commitment to quality and patient safety, achieving an outstanding compliance score of ${stats.percentage}%. This remarkable achievement reflects the dedication of the entire team to maintaining the highest standards of healthcare delivery. `;
          } else if (stats.percentage >= 75) {
            narrative += `${details.centerName || 'The center'} has shown strong performance in this accreditation assessment, achieving a compliance score of ${stats.percentage}%. The center demonstrates solid foundations in quality management with some areas identified for further enhancement. `;
          } else if (stats.percentage >= 60) {
            narrative += `${details.centerName || 'The center'} achieved a compliance score of ${stats.percentage}% in this assessment. While the center meets fundamental requirements, several areas require focused attention to achieve full accreditation readiness. `;
          } else {
            narrative += `This assessment identified significant opportunities for improvement at ${details.centerName || 'the center'}, with a current compliance score of ${stats.percentage}%. Immediate action is recommended to address critical gaps before the next survey. `;
          }

          // Strengths section
          if (strongDomains.length > 0) {
            narrative += `\n\nAreas of Excellence: The center excels in ${strongDomains.map(d => d.name).join(', ')}, demonstrating robust policies, well-trained staff, and consistent implementation of best practices. `;
          }

          if (goodDomains.length > 0) {
            narrative += `Strong performance was also noted in ${goodDomains.map(d => d.name).join(', ')}. `;
          }

          // Areas for improvement
          if (concernDomains.length > 0) {
            narrative += `\n\nPriority Focus Areas: ${concernDomains.map(d => `${d.name} (${d.percentage}%)`).join(', ')} require immediate attention to meet accreditation standards. `;
          }

          // Critical findings summary
          if (criticalFindings.length > 0) {
            narrative += `\n\nCritical Findings: ${criticalFindings.length} standards were scored as "Not Met" and require immediate corrective action within 30 days. Key areas include `;
            const criticalAreas = [...new Set(criticalFindings.map(f => f.chapter))];
            narrative += criticalAreas.slice(0, 3).join(', ') + '. ';
          }

          // Partial findings
          if (partialFindings.length > 0) {
            narrative += `Additionally, ${partialFindings.length} standards were partially met and should be addressed within 60 days. `;
          }

          // Closing encouragement
          narrative += `\n\nWith focused effort on the identified areas, ${details.centerName || 'the center'} is well-positioned to achieve and maintain full accreditation status. The action plan provided in this report outlines specific steps and timelines for improvement.`;

          return narrative;
        };

        // ==================== PAGE 1: COVER & EXECUTIVE SUMMARY ====================

        // Helper: Draw diffused gradient (horizontal fade from color to white)
        const drawDiffusedGradient = (x, y, width, height, color, direction = 'right') => {
          const steps = 12;
          const stepWidth = width / steps;
          for (let i = 0; i < steps; i++) {
            const ratio = direction === 'right' ? i / steps : (steps - i) / steps;
            const r = Math.round(color[0] + (255 - color[0]) * ratio);
            const g = Math.round(color[1] + (255 - color[1]) * ratio);
            const b = Math.round(color[2] + (255 - color[2]) * ratio);
            doc.setFillColor(r, g, b);
            doc.rect(x + (i * stepWidth), y, stepWidth + 0.5, height, 'F');
          }
        };

        // Minimalist navy gradient header for branding
        const headerHeight = 12;
        const steps = 30;
        for (let i = 0; i < steps; i++) {
          const ratio = i / steps;
          const r = Math.round(30 + (255 - 30) * ratio * 1.2);
          const g = Math.round(58 + (255 - 58) * ratio * 1.2);
          const b = Math.round(95 + (255 - 95) * ratio * 0.8);
          doc.setFillColor(Math.min(255, r), Math.min(255, g), Math.min(255, b));
          doc.rect((i / steps) * pageWidth * 0.7, 0, (pageWidth * 0.7 / steps) + 1, headerHeight, 'F');
        }

        // Title - with proper spacing below gradient
        doc.setTextColor(30, 58, 95);
        doc.setFontSize(32);
        doc.setFont('times', 'bold');
        doc.text('StandardsHub', 20, 32);

        // Subtitle
        doc.setFontSize(12);
        doc.setFont('times', 'normal');
        doc.setTextColor(100, 105, 115);
        doc.text('Healthcare Accreditation Assessment Report', 20, 44);

        // Date
        doc.setFontSize(10);
        doc.text(new Date(survey.completedAt || survey.createdAt).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' }), 20, 54);
        doc.setDrawColor(200, 205, 210);
        doc.setLineWidth(0.3);
        doc.line(20, 58, pageWidth - 20, 58);

        yPos = 70;

        // Center name - prominent but not boxed
        doc.setTextColor(30, 58, 95);
        doc.setFontSize(22);
        doc.setFont('times', 'bold');
        doc.text(details.centerName || 'Assessment Report', 20, yPos);
        yPos += 10;

        // Coordinator info
        doc.setFontSize(10);
        doc.setFont('times', 'normal');
        doc.setTextColor(100, 105, 115);
        doc.text(`Quality Coordinator: ${details.coordinatorName || '-'}      Configuration: ${survey.configuration || '-'}`, 20, yPos);
        yPos += 20;

        // Score Display - clean, no box, just the numbers
        const scoreColor = stats.percentage >= 90 ? [22, 90, 55] : stats.percentage >= 75 ? [30, 100, 60] : stats.percentage >= 60 ? [160, 95, 10] : [150, 45, 35];

        doc.setTextColor(...scoreColor);
        doc.setFontSize(52);
        doc.setFont('times', 'bold');
        doc.text(`${stats.percentage || 0}%`, pageWidth / 2, yPos + 15, { align: 'center' });

        doc.setFontSize(11);
        doc.setFont('times', 'normal');
        doc.setTextColor(100, 105, 115);
        doc.text('Overall Compliance Score', pageWidth / 2, yPos + 26, { align: 'center' });

        doc.setTextColor(...scoreColor);
        doc.setFont('times', 'bold');
        doc.text(compliance.label, pageWidth / 2, yPos + 35, { align: 'center' });

        // Subtle underline below score
        doc.setDrawColor(...scoreColor.map(c => Math.round(c + (255 - c) * 0.7)));
        doc.setLineWidth(0.5);
        doc.line(pageWidth / 2 - 40, yPos + 40, pageWidth / 2 + 40, yPos + 40);

        yPos += 55;

        // Score breakdown - minimal cards with left accent only
        const cardGap = 8;
        const cardWidth = (pageWidth - 40 - (cardGap * 3)) / 4;
        const boxData = [
          { label: 'Fully Met', value: stats.fullyMet || 0, color: [22, 90, 55] },
          { label: 'Partial', value: stats.partial || 0, color: [160, 100, 15] },
          { label: 'Not Met', value: stats.notMet || 0, color: [150, 45, 35] },
          { label: 'N/A', value: stats.na || 0, color: [110, 115, 125] }
        ];

        boxData.forEach((box, idx) => {
          const x = 20 + (idx * (cardWidth + cardGap));

          // Thin left accent line only
          doc.setFillColor(...box.color);
          doc.rect(x, yPos, 2, 20, 'F');

          // Value
          doc.setTextColor(...box.color);
          doc.setFontSize(18);
          doc.setFont('times', 'bold');
          doc.text(String(box.value), x + 12, yPos + 10);

          // Label
          doc.setFontSize(8);
          doc.setFont('times', 'normal');
          doc.setTextColor(110, 115, 125);
          doc.text(box.label.toUpperCase(), x + 12, yPos + 17);
        });
        yPos += 32;

        // Executive Summary - title with underline, no box
        doc.setTextColor(30, 58, 95);
        doc.setFontSize(14);
        doc.setFont('times', 'bold');
        doc.text('Executive Summary', 20, yPos);
        doc.setDrawColor(30, 58, 95);
        doc.setLineWidth(0.4);
        doc.line(20, yPos + 2, 75, yPos + 2);
        yPos += 10;

        // Executive narrative text
        doc.setTextColor(60, 65, 70);
        doc.setFontSize(10);
        doc.setFont('times', 'normal');
        const narrative = generateExecutiveNarrative();
        const narrativeLines = wrapText(narrative, pageWidth - 40);
        narrativeLines.forEach(line => {
          checkNewPage(8);
          doc.text(line, 20, yPos);
          yPos += 5;
        });

        // ==================== PAGE 2: DOMAIN PERFORMANCE ====================
        doc.addPage();
        yPos = 25;

        // Section title - clean, no underline
        doc.setTextColor(30, 58, 95);
        doc.setFontSize(16);
        doc.setFont('times', 'bold');
        doc.text('Domain Performance Analysis', 20, yPos);
        yPos += 12;

        // Helper function for domain headers - clean colored text only (no underlines)
        const drawDomainHeader = (x, y, domainColor, text, percentage) => {
          // Domain text in domain color
          doc.setTextColor(...domainColor.primary);
          doc.setFontSize(11);
          doc.setFont('times', 'bold');
          doc.text(text, x, y + 5);

          // Percentage on right in same color
          doc.text(`${percentage}%`, pageWidth - 25, y + 5, { align: 'right' });
        };

        // Domain cards
        chapterData.forEach((ch, idx) => {
          checkNewPage(35);
          const domainColor = getDomainColor(ch.name);

          // Domain header
          drawDomainHeader(20, yPos, domainColor, `${domainColor.name}  ${ch.name}`, ch.percentage);
          yPos += 14;

          // Stats row - clean text, no background
          doc.setFontSize(9);
          doc.setFont('times', 'normal');
          doc.setTextColor(80, 85, 90);
          doc.text(`Total: ${ch.total}`, 28, yPos);

          doc.setTextColor(22, 90, 55);
          doc.text(`Fully Met: ${ch.fullyMet}`, 65, yPos);

          doc.setTextColor(160, 100, 15);
          doc.text(`Partial: ${ch.partial}`, 110, yPos);

          doc.setTextColor(150, 45, 35);
          doc.text(`Not Met: ${ch.notMet}`, 145, yPos);
          yPos += 6;

          // Progress bar - subtle
          const barWidth = pageWidth - 60;
          doc.setFillColor(235, 238, 242);
          doc.roundedRect(28, yPos, barWidth, 3, 1, 1, 'F');

          const fillWidth = (ch.percentage / 100) * barWidth;
          const fillColor = ch.percentage >= 90 ? [22, 90, 55] : ch.percentage >= 75 ? [30, 100, 60] : ch.percentage >= 60 ? [160, 100, 15] : [150, 45, 35];
          doc.setFillColor(...fillColor);
          doc.roundedRect(28, yPos, fillWidth, 3, 1, 1, 'F');

          yPos += 15;
        });

        // ==================== PAGE 3+: ACTION PLAN ====================
        if (actionPlanItems.length > 0) {
          doc.addPage();
          yPos = 25;

          // Section title
          doc.setTextColor(140, 70, 20);
          doc.setFontSize(16);
          doc.setFont('times', 'bold');
          doc.text(`Corrective Action Plan`, 20, yPos);
          doc.setFontSize(11);
          doc.setFont('times', 'normal');
          doc.setTextColor(100, 105, 115);
          doc.text(`${actionPlanItems.length} items requiring attention`, 115, yPos);
          yPos += 10;

          // Timeline guide - weeks format
          doc.setFontSize(9);
          doc.setFont('times', 'italic');
          doc.setTextColor(100, 105, 115);
          doc.text('Timeline:  ', 20, yPos);
          doc.setFont('times', 'normal');
          doc.setTextColor(150, 45, 35);
          doc.text('HIGH = 1-4 weeks', 45, yPos);
          doc.setTextColor(160, 100, 15);
          doc.text('MEDIUM = 2-5 weeks', 95, yPos);
          yPos += 12;

          // Group action items by domain
          const findingsByDomainPDF = {};
          actionPlanItems.forEach(item => {
            if (!findingsByDomainPDF[item.chapter]) {
              findingsByDomainPDF[item.chapter] = [];
            }
            findingsByDomainPDF[item.chapter].push(item);
          });

          // Render each domain's findings with full text and proper spacing
          Object.entries(findingsByDomainPDF).forEach(([domainName, findings]) => {
            checkNewPage(50);
            const domainColor = getDomainColor(domainName);

            // Domain header - clean colored text only (no underlines)
            doc.setTextColor(...domainColor.primary);
            doc.setFontSize(11);
            doc.setFont('times', 'bold');
            doc.text(`${domainColor.name}  ${domainName} (${findings.length} findings)`, 20, yPos);
            yPos += 10;

            // Findings list - full text with proper hierarchy and spacing
            findings.forEach((item, idx) => {
              checkNewPage(35);

              // ---- ITEM HEADER ROW with subtle gray background ----
              const isHigh = item.score === 0;

              // Subtle gray background for header row (table-like, no frames)
              doc.setFillColor(245, 247, 250);
              doc.rect(20, yPos - 4, pageWidth - 40, 10, 'F');

              // Item number and ID
              doc.setFontSize(10);
              doc.setFont('times', 'bold');
              doc.setTextColor(30, 58, 95);
              doc.text(`${idx + 1}. ${item.id}`, 25, yPos + 2);

              // Priority - clean text
              doc.setFontSize(9);
              doc.setTextColor(isHigh ? 180 : 160, isHigh ? 50 : 100, isHigh ? 40 : 20);
              doc.text(isHigh ? 'HIGH' : 'MEDIUM', 65, yPos + 2);

              // Survey Activity tag (color-coded)
              const activityColors = {
                'DOC': [52, 73, 94],    // Dark blue-gray for Document Review
                'OBS': [39, 174, 96],   // Green for Observation
                'INT': [142, 68, 173],  // Purple for Interview
                'PER': [230, 126, 34],  // Orange for Personnel File
                'DEN': [41, 128, 185]   // Blue for Dental Record
              };
              const actColor = activityColors[item.activityType] || [100, 100, 100];
              doc.setTextColor(...actColor);
              doc.setFont('times', 'italic');
              doc.text(`[${item.activityLabel || 'Document Review'}]`, 90, yPos + 2);

              // Timeframe in weeks on right
              const days = item.targetDays || (isHigh ? 21 : 45);
              const weeks = Math.ceil(days / 7);
              doc.setFont('times', 'normal');
              doc.setTextColor(100, 105, 115);
              doc.text(`${weeks} week${weeks > 1 ? 's' : ''}`, pageWidth - 25, yPos + 2, { align: 'right' });

              yPos += 10;

              // ---- STANDARD TEXT (with orphan prevention) ----
              doc.setFont('times', 'normal');
              doc.setTextColor(50, 55, 60);
              doc.setFontSize(9);
              const wrappedText = wrapText(item.text, pageWidth - 50);
              // Calculate total height needed for this text block
              const textBlockHeight = wrappedText.length * 4.5;
              // If text block won't fit but we'd leave orphan, move entire block to next page
              if (yPos + textBlockHeight > pageHeight - 25 && yPos + 15 < pageHeight - 25) {
                doc.addPage();
                yPos = 25;
              }
              wrappedText.forEach((line) => {
                checkNewPage(5);
                doc.text(line, 30, yPos);
                yPos += 4.5;
              });

              yPos += 4;

              // ---- FINDING (if available, with orphan prevention) ----
              if (item.findings && item.findings.trim()) {
                const findingText = wrapText(item.findings, pageWidth - 55);
                const findingHeight = 4 + (findingText.length * 4);
                // Prevent orphan - if only 1-2 lines would fit, move entire finding to next page
                if (yPos + findingHeight > pageHeight - 25 && yPos + 10 < pageHeight - 25) {
                  doc.addPage();
                  yPos = 25;
                }
                doc.setFont('times', 'bold');
                doc.setFontSize(8);
                doc.setTextColor(140, 90, 30);
                doc.text('Finding:', 30, yPos);
                yPos += 4;
                doc.setFont('times', 'italic');
                doc.setTextColor(120, 80, 40);
                findingText.forEach((line) => {
                  checkNewPage(5);
                  doc.text(line, 35, yPos);
                  yPos += 4;
                });
                yPos += 3;
              }

              // ---- CORRECTIVE ACTION (always shown, with orphan prevention) ----
              const correctiveAction = generateCorrectiveAction(item);
              const actionText = wrapText(correctiveAction, pageWidth - 55);
              const actionHeight = 4 + (actionText.length * 4);
              // Prevent orphan
              if (yPos + actionHeight > pageHeight - 25 && yPos + 10 < pageHeight - 25) {
                doc.addPage();
                yPos = 25;
              }
              doc.setFont('times', 'bold');
              doc.setFontSize(8);
              doc.setTextColor(25, 100, 50);
              doc.text('Corrective Action:', 30, yPos);
              yPos += 4;
              doc.setFont('times', 'normal');
              doc.setTextColor(35, 90, 55);
              actionText.forEach((line) => {
                checkNewPage(5);
                doc.text(line, 35, yPos);
                yPos += 4;
              });

              yPos += 8;
            });

            yPos += 10;
          });
        }

        // ==================== COMPLIANCE SUMMARY - SEPARATE PAGE ====================
        doc.addPage();
        yPos = 30;

        // Page title
        doc.setTextColor(30, 58, 95);
        doc.setFontSize(18);
        doc.setFont('times', 'bold');
        doc.text('Compliance Summary', pageWidth / 2, yPos, { align: 'center' });
        yPos += 25;

        // Calculate percentages
        const fullyMetPct = stats.scored > 0 ? (stats.fullyMet / stats.scored) * 100 : 0;
        const partialPct = stats.scored > 0 ? (stats.partial / stats.scored) * 100 : 0;
        const notMetPct = stats.scored > 0 ? (stats.notMet / stats.scored) * 100 : 0;

        // Modern color palette
        const pieColors = {
          fullyMet: [46, 125, 50],      // Deep green
          partial: [245, 166, 35],       // Warm amber
          notMet: [198, 40, 40]          // Deep red
        };

        // PIE CHART - larger and centered
        const pieRadius = 40;
        const pieCenterX = pageWidth / 2;
        const pieCenterY = yPos + pieRadius + 10;

        // Draw pie slices with improved colors
        const drawPieSlice = (cx, cy, r, startAngle, endAngle, color) => {
          doc.setFillColor(...color);
          const steps = Math.max(20, Math.ceil((endAngle - startAngle) * 40));
          for (let i = 0; i < steps; i++) {
            const a1 = startAngle + (endAngle - startAngle) * (i / steps);
            const a2 = startAngle + (endAngle - startAngle) * ((i + 1) / steps);
            doc.triangle(cx, cy,
              cx + r * Math.cos(a1), cy + r * Math.sin(a1),
              cx + r * Math.cos(a2), cy + r * Math.sin(a2), 'F');
          }
        };

        // Draw slices (start from top: -90 degrees)
        let startAngle = -Math.PI / 2;

        // Fully Met (green)
        if (fullyMetPct > 0) {
          const endAngle = startAngle + (fullyMetPct / 100) * 2 * Math.PI;
          drawPieSlice(pieCenterX, pieCenterY, pieRadius, startAngle, endAngle, pieColors.fullyMet);
          startAngle = endAngle;
        }

        // Partially Met (amber)
        if (partialPct > 0) {
          const endAngle = startAngle + (partialPct / 100) * 2 * Math.PI;
          drawPieSlice(pieCenterX, pieCenterY, pieRadius, startAngle, endAngle, pieColors.partial);
          startAngle = endAngle;
        }

        // Not Met (red)
        if (notMetPct > 0) {
          const endAngle = startAngle + (notMetPct / 100) * 2 * Math.PI;
          drawPieSlice(pieCenterX, pieCenterY, pieRadius, startAngle, endAngle, pieColors.notMet);
        }

        // Center score display in pie
        doc.setFillColor(255, 255, 255);
        doc.circle(pieCenterX, pieCenterY, 22, 'F');
        doc.setTextColor(30, 58, 95);
        doc.setFontSize(20);
        doc.setFont('times', 'bold');
        doc.text(`${stats.percentage}%`, pieCenterX, pieCenterY + 3, { align: 'center' });
        doc.setFontSize(7);
        doc.setFont('times', 'normal');
        doc.setTextColor(100, 105, 115);
        doc.text('Compliance', pieCenterX, pieCenterY + 10, { align: 'center' });

        yPos = pieCenterY + pieRadius + 25;

        // Legend - horizontal layout centered below pie
        const legendStartX = pageWidth / 2 - 70;
        let legendX = legendStartX;

        // Fully Met legend
        doc.setFillColor(...pieColors.fullyMet);
        doc.roundedRect(legendX, yPos - 3, 8, 8, 1, 1, 'F');
        doc.setTextColor(50, 55, 60);
        doc.setFontSize(9);
        doc.setFont('times', 'normal');
        doc.text(`Fully Met`, legendX + 12, yPos + 3);
        doc.setFont('times', 'bold');
        doc.text(`${stats.fullyMet}`, legendX + 12, yPos + 10);
        doc.setFont('times', 'normal');
        doc.setTextColor(100, 105, 115);
        doc.text(`(${Math.round(fullyMetPct)}%)`, legendX + 22, yPos + 10);

        legendX += 50;

        // Partially Met legend
        doc.setFillColor(...pieColors.partial);
        doc.roundedRect(legendX, yPos - 3, 8, 8, 1, 1, 'F');
        doc.setTextColor(50, 55, 60);
        doc.setFont('times', 'normal');
        doc.text(`Partial`, legendX + 12, yPos + 3);
        doc.setFont('times', 'bold');
        doc.text(`${stats.partial}`, legendX + 12, yPos + 10);
        doc.setFont('times', 'normal');
        doc.setTextColor(100, 105, 115);
        doc.text(`(${Math.round(partialPct)}%)`, legendX + 20, yPos + 10);

        legendX += 45;

        // Not Met legend
        doc.setFillColor(...pieColors.notMet);
        doc.roundedRect(legendX, yPos - 3, 8, 8, 1, 1, 'F');
        doc.setTextColor(50, 55, 60);
        doc.setFont('times', 'normal');
        doc.text(`Not Met`, legendX + 12, yPos + 3);
        doc.setFont('times', 'bold');
        doc.text(`${stats.notMet}`, legendX + 12, yPos + 10);
        doc.setFont('times', 'normal');
        doc.setTextColor(100, 105, 115);
        doc.text(`(${Math.round(notMetPct)}%)`, legendX + 20, yPos + 10);

        yPos += 30;

        // Summary statistics in clean layout
        doc.setFillColor(248, 250, 252);
        doc.roundedRect(30, yPos, pageWidth - 60, 35, 3, 3, 'F');

        doc.setTextColor(30, 58, 95);
        doc.setFontSize(10);
        doc.setFont('times', 'bold');
        doc.text('Assessment Overview', pageWidth / 2, yPos + 10, { align: 'center' });

        doc.setFont('times', 'normal');
        doc.setFontSize(9);
        doc.setTextColor(60, 65, 70);
        doc.text(`Total Sub-Standards: ${stats.total}`, 50, yPos + 22);
        doc.text(`Scored: ${stats.scored}`, pageWidth / 2 - 20, yPos + 22);
        doc.text(`N/A: ${stats.na}`, pageWidth - 70, yPos + 22);

        doc.setTextColor(100, 50, 30);
        doc.setFont('times', 'bold');
        doc.text(`Deficiency Rate: ${Math.round(partialPct + notMetPct)}%`, pageWidth / 2, yPos + 30, { align: 'center' });

        // ==================== FOOTER ON ALL PAGES ====================
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
          doc.setPage(i);

          // Footer line
          doc.setDrawColor(200, 200, 200);
          doc.line(15, pageHeight - 15, pageWidth - 15, pageHeight - 15);

          // Footer text
          doc.setFontSize(8);
          doc.setFont('times', 'italic');
          doc.setTextColor(150, 150, 150);
          doc.text(`Generated by StandardsHub`, 15, pageHeight - 10);
          doc.text(`Page ${i} of ${pageCount}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
          doc.text(`ID: ${survey.id.substring(0, 15)}...`, pageWidth - 15, pageHeight - 10, { align: 'right' });
        }

        // Generate filename and download
        const centerNameClean = (details.centerName || 'Assessment').replace(/[^a-zA-Z0-9]/g, '_');
        const date = new Date().toISOString().split('T')[0];
        doc.save(`StandardsHub_${centerNameClean}_${date}.pdf`);
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={e => e.stopPropagation()} style={{
            maxWidth: isMobile ? '95vw' : '900px',
            width: isMobile ? '95vw' : 'auto',
            maxHeight: '90vh',
            overflow: 'hidden',
            display: 'flex',
            flexDirection: 'column',
            margin: isMobile ? '0 auto' : undefined
          }}>
            {/* Header */}
            <div className="modal-header" style={{
              background: 'linear-gradient(135deg, var(--primary) 0%, #1a252f 100%)',
              color: 'white',
              padding: isMobile ? '16px' : '24px',
              flexShrink: 0
            }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: isMobile ? '10px' : '16px' }}>
                {Icons.award({ size: isMobile ? 24 : 32, color: '#ffd700' })}
                <div>
                  <h3 style={{ margin: 0, fontSize: isMobile ? '16px' : '20px' }}>Executive Summary</h3>
                  <p style={{ margin: '4px 0 0', opacity: 0.8, fontSize: isMobile ? '12px' : '14px' }}>
                    {details.centerName || 'Assessment Report'}
                  </p>
                </div>
              </div>
              <button className="modal-close" onClick={onClose} style={{
                background: 'rgba(255,255,255,0.2)',
                color: 'white',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center'
              }}>{Icons.x({ size: 18, color: 'white' })}</button>
            </div>

            {/* Scrollable Content */}
            <div style={{ flex: 1, overflow: 'auto', padding: isMobile ? '16px' : '24px' }}>
              {/* Overall Score Card */}
              <div style={{
                background: compliance.bg,
                borderRadius: isMobile ? '12px' : '16px',
                padding: isMobile ? '16px' : '24px',
                marginBottom: isMobile ? '16px' : '24px',
                border: `2px solid ${compliance.color}`,
                display: isMobile ? 'flex' : 'grid',
                flexDirection: isMobile ? 'column' : undefined,
                gridTemplateColumns: isMobile ? undefined : '1fr auto',
                gap: isMobile ? '16px' : '24px',
                alignItems: 'center'
              }}>
                <div style={{ textAlign: isMobile ? 'center' : 'left' }}>
                  <div style={{ fontSize: isMobile ? '12px' : '14px', color: 'var(--text-secondary)', marginBottom: isMobile ? '4px' : '8px', textTransform: 'uppercase', letterSpacing: '1px' }}>
                    Overall Compliance Score
                  </div>
                  <div style={{ fontSize: isMobile ? '36px' : '48px', fontWeight: 700, color: compliance.color, lineHeight: 1 }}>
                    {stats.percentage || 0}%
                  </div>
                  <div style={{
                    display: 'inline-block',
                    marginTop: isMobile ? '8px' : '12px',
                    padding: isMobile ? '4px 12px' : '6px 16px',
                    background: compliance.color,
                    color: 'white',
                    borderRadius: '20px',
                    fontSize: isMobile ? '11px' : '13px',
                    fontWeight: 600
                  }}>
                    {compliance.label}
                  </div>
                </div>
                <div style={{ textAlign: isMobile ? 'center' : 'right', width: isMobile ? '100%' : 'auto' }}>
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: isMobile ? '8px' : '16px' }}>
                    <div style={{ textAlign: 'center', padding: isMobile ? '8px 6px' : '12px 20px', background: 'white', borderRadius: isMobile ? '8px' : '12px' }}>
                      <div style={{ fontSize: isMobile ? '18px' : '24px', fontWeight: 700, color: 'var(--success)' }}>{stats.fullyMet || 0}</div>
                      <div style={{ fontSize: isMobile ? '9px' : '11px', color: 'var(--text-muted)', textTransform: 'uppercase' }}>Fully Met</div>
                    </div>
                    <div style={{ textAlign: 'center', padding: isMobile ? '8px 6px' : '12px 20px', background: 'white', borderRadius: isMobile ? '8px' : '12px' }}>
                      <div style={{ fontSize: isMobile ? '18px' : '24px', fontWeight: 700, color: 'var(--warning)' }}>{stats.partial || 0}</div>
                      <div style={{ fontSize: isMobile ? '9px' : '11px', color: 'var(--text-muted)', textTransform: 'uppercase' }}>Partial</div>
                    </div>
                    <div style={{ textAlign: 'center', padding: isMobile ? '8px 6px' : '12px 20px', background: 'white', borderRadius: isMobile ? '8px' : '12px' }}>
                      <div style={{ fontSize: isMobile ? '18px' : '24px', fontWeight: 700, color: 'var(--danger)' }}>{stats.notMet || 0}</div>
                      <div style={{ fontSize: isMobile ? '9px' : '11px', color: 'var(--text-muted)', textTransform: 'uppercase' }}>Not Met</div>
                    </div>
                    <div style={{ textAlign: 'center', padding: isMobile ? '8px 6px' : '12px 20px', background: 'white', borderRadius: isMobile ? '8px' : '12px' }}>
                      <div style={{ fontSize: isMobile ? '18px' : '24px', fontWeight: 700, color: 'var(--text-muted)' }}>{stats.na || 0}</div>
                      <div style={{ fontSize: isMobile ? '9px' : '11px', color: 'var(--text-muted)', textTransform: 'uppercase' }}>N/A</div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Assessment Details */}
              <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                gap: '16px',
                marginBottom: '24px'
              }}>
                <div style={{ padding: '16px', background: 'var(--bg-secondary)', borderRadius: '12px' }}>
                  <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginBottom: '4px' }}>Configuration</div>
                  <div style={{ fontWeight: 600, color: 'var(--primary)' }}>{survey.configuration || 'A - Surveyor 1'}</div>
                </div>
                <div style={{ padding: '16px', background: 'var(--bg-secondary)', borderRadius: '12px' }}>
                  <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginBottom: '4px' }}>Coordinator</div>
                  <div style={{ fontWeight: 600 }}>{details.coordinatorName || 'N/A'}</div>
                </div>
                <div style={{ padding: '16px', background: 'var(--bg-secondary)', borderRadius: '12px' }}>
                  <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginBottom: '4px' }}>Completed Date</div>
                  <div style={{ fontWeight: 600 }}>{survey.completedAt ? new Date(survey.completedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : 'N/A'}</div>
                </div>
                <div style={{ padding: '16px', background: 'var(--bg-secondary)', borderRadius: '12px' }}>
                  <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginBottom: '4px' }}>Total Findings</div>
                  <div style={{ fontWeight: 600, color: totalFindings > 0 ? 'var(--warning)' : 'var(--success)' }}>{totalFindings} items need attention</div>
                </div>
              </div>

              {/* Chapter Performance Summary */}
              <div>
                <h4 style={{ marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                  {Icons.barChart({ size: 20 })} Chapter Performance
                </h4>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                  {chapterData.map(chapter => (
                    <div key={chapter.id} style={{
                      background: 'var(--bg-secondary)',
                      borderRadius: '12px',
                      padding: '16px',
                      border: '1px solid var(--border)'
                    }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                        <div style={{ fontWeight: 600 }}>{chapter.name}</div>
                        <div style={{
                          fontSize: '18px',
                          fontWeight: 700,
                          color: chapter.percentage >= 75 ? 'var(--success)' :
                            chapter.percentage >= 60 ? 'var(--warning)' : 'var(--danger)'
                        }}>
                          {chapter.percentage}%
                        </div>
                      </div>
                      <div style={{
                        height: '8px',
                        background: 'var(--bg-hover)',
                        borderRadius: '4px',
                        overflow: 'hidden',
                        marginBottom: '12px'
                      }}>
                        <div style={{
                          height: '100%',
                          width: `${chapter.percentage}%`,
                          background: chapter.percentage >= 75 ? 'var(--success)' :
                            chapter.percentage >= 60 ? 'var(--warning)' : 'var(--danger)',
                          borderRadius: '4px',
                          transition: 'width 0.5s ease'
                        }} />
                      </div>
                      <div style={{ display: 'flex', gap: '16px', fontSize: '12px' }}>
                        <span style={{ color: 'var(--success)' }}> {chapter.fullyMet} Fully Met</span>
                        <span style={{ color: 'var(--warning)' }}> {chapter.partial} Partial</span>
                        <span style={{ color: 'var(--danger)' }}> {chapter.notMet} Not Met</span>
                        {chapter.na > 0 && <span style={{ color: 'var(--text-muted)' }}> {chapter.na} N/A</span>}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
              {/* Expandable Chapter Details */}
              <div style={{ marginBottom: '24px' }}>
                <h4 style={{ marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                  {Icons.clipboard({ size: 20 })} Detailed Scoring
                </h4>
                <p style={{ color: 'var(--text-secondary)', marginBottom: '16px', fontSize: '14px' }}>
                  Click on any chapter to expand and view all substandards with scores and findings.
                </p>
                {chapterData.map(chapter => (
                  <div key={chapter.id} style={{
                    marginBottom: '16px',
                    border: '1px solid var(--border)',
                    borderRadius: '12px',
                    overflow: 'hidden'
                  }}>
                    {/* Chapter Header - Clickable */}
                    <div
                      onClick={() => toggleChapter(chapter.id)}
                      style={{
                        padding: '16px 20px',
                        background: expandedChapters[chapter.id] ? 'var(--primary)' : 'var(--bg-secondary)',
                        color: expandedChapters[chapter.id] ? 'white' : 'var(--text-primary)',
                        cursor: 'pointer',
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        transition: 'all 0.2s ease'
                      }}
                    >
                      <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                        <span style={{
                          transform: expandedChapters[chapter.id] ? 'rotate(90deg)' : 'rotate(0deg)',
                          transition: 'transform 0.2s ease',
                          fontSize: '12px'
                        }}></span>
                        <span style={{ fontWeight: 600 }}>{chapter.name}</span>
                        <span style={{
                          fontSize: '12px',
                          opacity: 0.7
                        }}>({chapter.substandards.length} items)</span>
                      </div>
                      <div style={{
                        fontSize: '18px',
                        fontWeight: 700,
                        color: expandedChapters[chapter.id] ? 'white' :
                          (chapter.percentage >= 75 ? 'var(--success)' :
                            chapter.percentage >= 60 ? 'var(--warning)' : 'var(--danger)')
                      }}>
                        {chapter.percentage}%
                      </div>
                    </div>

                    {/* Expanded Substandards */}
                    {expandedChapters[chapter.id] && (
                      <div style={{ padding: '16px', background: 'white' }}>
                        {chapter.substandards.map((sub, idx) => {
                          const scoreInfo = getScoreLabel(sub.score);
                          return (
                            <div key={sub.id} style={{
                              padding: '12px 16px',
                              background: scoreInfo.bg,
                              borderRadius: '8px',
                              marginBottom: idx < chapter.substandards.length - 1 ? '8px' : 0,
                              borderLeft: `4px solid ${scoreInfo.color}`
                            }}>
                              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '6px' }}>
                                <div style={{ fontWeight: 600, fontSize: '13px', color: 'var(--text-primary)' }}>{sub.id}</div>
                                <span style={{
                                  fontSize: '11px',
                                  padding: '3px 10px',
                                  borderRadius: '12px',
                                  background: scoreInfo.color,
                                  color: 'white',
                                  fontWeight: 600
                                }}>
                                  {scoreInfo.text}
                                </span>
                              </div>
                              <div style={{ fontSize: '13px', color: 'var(--text-secondary)', marginBottom: sub.findings || sub.recommendations ? '10px' : 0 }}>
                                {sub.text}
                              </div>
                              {sub.findings && (
                                <div style={{
                                  fontSize: '12px',
                                  padding: '10px 12px',
                                  background: 'rgba(231, 76, 60, 0.08)',
                                  borderRadius: '6px',
                                  marginBottom: sub.recommendations ? '8px' : 0,
                                  border: '1px solid rgba(231, 76, 60, 0.2)'
                                }}>
                                  <strong style={{ color: 'var(--danger)' }}>Finding:</strong> {sub.findings}
                                </div>
                              )}
                              {sub.recommendations && (
                                <div style={{
                                  fontSize: '12px',
                                  padding: '10px 12px',
                                  background: 'rgba(52, 152, 219, 0.08)',
                                  borderRadius: '6px',
                                  border: '1px solid rgba(52, 152, 219, 0.2)'
                                }}>
                                  <strong style={{ color: 'var(--primary)' }}>Recommendation:</strong> {sub.recommendations}
                                </div>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    )}
                  </div>
                ))}
              </div>

              {/* ACTION PLAN SECTION - Only shows when there are findings */}
              {totalFindings > 0 && (
                <div style={{ marginTop: '32px' }}>
                  <div style={{
                    background: 'linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)',
                    borderRadius: '12px',
                    padding: '20px',
                    marginBottom: '24px',
                    border: '1px solid #ffcc80'
                  }}>
                    <h4 style={{ margin: '0 0 8px', color: '#e65100', display: 'flex', alignItems: 'center', gap: '8px' }}>
                      {Icons.checkCircle({ size: 20, color: '#e65100' })} Corrective Action Plan
                    </h4>
                    <p style={{ margin: 0, fontSize: '14px', color: '#bf360c' }}>
                      This action plan outlines {totalFindings} items requiring attention. Address all "Not Met" (High Priority) items first, followed by "Partial" (Medium Priority) items.
                    </p>
                  </div>

                  {/* Priority Legend */}
                  <div style={{ display: 'flex', gap: '24px', marginBottom: '20px' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                      <span style={{ width: '12px', height: '12px', borderRadius: '50%', background: 'var(--danger)' }}></span>
                      <span style={{ fontSize: '13px', fontWeight: 600 }}>High Priority (Not Met)</span>
                    </div>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                      <span style={{ width: '12px', height: '12px', borderRadius: '50%', background: 'var(--warning)' }}></span>
                      <span style={{ fontSize: '13px', fontWeight: 600 }}>Medium Priority (Partial)</span>
                    </div>
                  </div>

                  {/* Action Items */}
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                    {actionPlanItems.map((item, idx) => (
                      <div key={item.id} style={{
                        background: 'white',
                        borderRadius: '12px',
                        border: `2px solid ${item.priorityColor}`,
                        overflow: 'hidden'
                      }}>
                        {/* Item Header */}
                        <div style={{
                          padding: '16px 20px',
                          background: item.score === 0 ? 'rgba(231, 76, 60, 0.08)' : 'rgba(241, 196, 15, 0.08)',
                          borderBottom: '1px solid var(--border)',
                          display: 'flex',
                          justifyContent: 'space-between',
                          alignItems: 'center'
                        }}>
                          <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                            <span style={{
                              width: '28px',
                              height: '28px',
                              borderRadius: '50%',
                              background: item.priorityColor,
                              color: 'white',
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center',
                              fontSize: '12px',
                              fontWeight: 700
                            }}>{idx + 1}</span>
                            <div>
                              <div style={{ fontWeight: 600, fontSize: '14px' }}>{item.id}</div>
                              <div style={{ fontSize: '12px', color: 'var(--text-muted)' }}>{item.chapter}</div>
                            </div>
                          </div>
                          <span style={{
                            padding: '4px 12px',
                            borderRadius: '20px',
                            fontSize: '11px',
                            fontWeight: 700,
                            background: item.priorityColor,
                            color: 'white'
                          }}>
                            {item.priority} Priority
                          </span>
                        </div>

                        {/* Item Content */}
                        <div style={{ padding: '16px 20px' }}>
                          <div style={{ fontSize: '14px', color: 'var(--text-primary)', marginBottom: '16px', lineHeight: 1.5 }}>
                            {item.text}
                          </div>

                          {item.findings && (
                            <div style={{
                              padding: '12px 16px',
                              background: 'rgba(231, 76, 60, 0.05)',
                              borderRadius: '8px',
                              marginBottom: '12px',
                              borderLeft: '4px solid var(--danger)'
                            }}>
                              <div style={{ fontSize: '11px', fontWeight: 700, color: 'var(--danger)', marginBottom: '4px', textTransform: 'uppercase' }}>
                                Current Finding
                              </div>
                              <div style={{ fontSize: '13px', color: 'var(--text-primary)' }}>{item.findings}</div>
                            </div>
                          )}

                          <div style={{
                            padding: '12px 16px',
                            background: 'rgba(46, 204, 113, 0.05)',
                            borderRadius: '8px',
                            borderLeft: '4px solid var(--success)'
                          }}>
                            <div style={{ fontSize: '11px', fontWeight: 700, color: 'var(--success)', marginBottom: '4px', textTransform: 'uppercase' }}>
                              Suggested Corrective Action (Target: {item.targetRange || item.targetDays} days)
                            </div>
                            <div style={{ fontSize: '13px', color: 'var(--text-primary)' }}>
                              {item.suggestedAction}
                            </div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>

            {/* Footer - Significantly Improved Design */}
            <div style={{
              padding: isMobile ? '12px 16px' : '20px 28px',
              borderTop: '2px solid var(--border)',
              background: 'linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%)',
              flexShrink: 0
            }}>
              {/* Assessment ID Badge - Hide on mobile to save space */}
              {!isMobile && (
                <div style={{
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'flex-start',
                  marginBottom: '16px'
                }}>
                  <div style={{
                    display: 'inline-flex',
                    alignItems: 'center',
                    gap: '8px',
                    padding: '6px 14px',
                    background: 'white',
                    borderRadius: '20px',
                    border: '1px solid var(--border)',
                    fontSize: '11px',
                    color: 'var(--text-muted)',
                    fontWeight: 500
                  }}>
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                      <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                    ID: {survey.id}
                  </div>
                  <div style={{
                    fontSize: '11px',
                    color: 'var(--text-muted)',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '6px'
                  }}>
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <circle cx="12" cy="12" r="10"></circle>
                      <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    {survey.completedAt ? new Date(survey.completedAt).toLocaleString('en-US', {
                      month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit'
                    }) : 'N/A'}
                  </div>
                </div>
              )}

              {/* Action Buttons Container - Mobile Optimized */}
              <div style={{
                display: 'flex',
                flexDirection: isMobile ? 'column' : 'row',
                gap: isMobile ? '12px' : '16px',
                alignItems: isMobile ? 'stretch' : 'stretch',
                flexWrap: 'wrap'
              }}>

                {/* Mobile: Export + Actions Row */}
                {isMobile ? (
                  <div style={{ display: 'flex', gap: '8px' }}>
                    {/* Excel Button - Compact */}
                    <button
                      onClick={() => {
                        setExportingExcel(true);
                        setTimeout(() => {
                          exportToExcel();
                          setExportingExcel(false);
                        }, 300);
                      }}
                      disabled={exportingExcel}
                      style={{
                        flex: 1,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        gap: '6px',
                        padding: '10px 12px',
                        background: exportingExcel
                          ? 'linear-gradient(135deg, #1d6b3f 0%, #185c36 100%)'
                          : 'linear-gradient(135deg, #217346 0%, #1d6b3f 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '10px',
                        cursor: exportingExcel ? 'wait' : 'pointer',
                        fontFamily: 'inherit',
                        fontWeight: 600,
                        fontSize: '12px',
                        boxShadow: '0 2px 8px rgba(33, 115, 70, 0.3)'
                      }}
                    >
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                        <path d="M8 13h2l2 3 2-6 2 3h2" />
                      </svg>
                      {exportingExcel ? '...' : 'Excel'}
                    </button>
                    {/* PDF Button - Compact */}
                    <button
                      onClick={() => {
                        setExportingPDF(true);
                        setTimeout(() => {
                          exportToPDF();
                          setExportingPDF(false);
                        }, 300);
                      }}
                      disabled={exportingPDF}
                      style={{
                        flex: 1,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        gap: '6px',
                        padding: '10px 12px',
                        background: exportingPDF
                          ? 'linear-gradient(135deg, #a93226 0%, #922b21 100%)'
                          : 'linear-gradient(135deg, #c0392b 0%, #a93226 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '10px',
                        cursor: exportingPDF ? 'wait' : 'pointer',
                        fontFamily: 'inherit',
                        fontWeight: 600,
                        fontSize: '12px',
                        boxShadow: '0 2px 8px rgba(192, 57, 43, 0.3)'
                      }}
                    >
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                        <path d="M9 15h6M12 12v6" />
                      </svg>
                      {exportingPDF ? '...' : 'PDF'}
                    </button>
                    {/* Share Button - Compact */}
                    <button
                      onClick={handleShare}
                      style={{
                        flex: 1,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        gap: '6px',
                        padding: '10px 12px',
                        background: 'linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '10px',
                        cursor: 'pointer',
                        fontFamily: 'inherit',
                        fontWeight: 600,
                        fontSize: '12px',
                        boxShadow: '0 2px 8px rgba(155, 89, 182, 0.3)'
                      }}
                    >
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <circle cx="18" cy="5" r="3"></circle>
                        <circle cx="6" cy="12" r="3"></circle>
                        <circle cx="18" cy="19" r="3"></circle>
                        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                      </svg>
                      Share
                    </button>
                  </div>
                ) : (
                  <>
                    {/* Desktop: Export Section - Grouped */}
                    <div style={{
                      display: 'flex',
                      flexDirection: 'column',
                      gap: '8px'
                    }}>
                      <div style={{
                        fontSize: '10px',
                        fontWeight: 700,
                        textTransform: 'uppercase',
                        letterSpacing: '0.8px',
                        color: 'var(--text-muted)',
                        paddingLeft: '4px'
                      }}>
                        Export Report
                      </div>
                      <div style={{ display: 'flex', gap: '8px' }}>
                        {/* Excel Button */}
                        <button
                          onClick={() => {
                            setExportingExcel(true);
                            setTimeout(() => {
                              exportToExcel();
                              setExportingExcel(false);
                            }, 300);
                          }}
                          disabled={exportingExcel}
                          style={{
                            display: 'flex',
                            flexDirection: 'column',
                            alignItems: 'center',
                            justifyContent: 'center',
                            gap: '6px',
                            padding: '14px 20px',
                            minWidth: '90px',
                            background: exportingExcel
                              ? 'linear-gradient(135deg, #1d6b3f 0%, #185c36 100%)'
                              : 'linear-gradient(135deg, #217346 0%, #1d6b3f 100%)',
                            color: 'white',
                            border: 'none',
                            borderRadius: '14px',
                            cursor: exportingExcel ? 'wait' : 'pointer',
                            fontFamily: 'inherit',
                        fontWeight: 600,
                        fontSize: '12px',
                        boxShadow: '0 4px 14px rgba(33, 115, 70, 0.35)',
                        transition: 'all 0.25s cubic-bezier(0.4, 0, 0.2, 1)',
                        transform: exportingExcel ? 'scale(0.97)' : 'scale(1)'
                      }}
                      onMouseEnter={e => {
                        if (!exportingExcel) {
                          e.currentTarget.style.transform = 'translateY(-3px) scale(1.02)';
                          e.currentTarget.style.boxShadow = '0 8px 20px rgba(33, 115, 70, 0.45)';
                        }
                      }}
                      onMouseLeave={e => {
                        e.currentTarget.style.transform = 'scale(1)';
                        e.currentTarget.style.boxShadow = '0 4px 14px rgba(33, 115, 70, 0.35)';
                      }}
                      title="Download Excel Report"
                    >
                      {exportingExcel ? (
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{ animation: 'spin 1s linear infinite' }}>
                          <circle cx="12" cy="12" r="10" strokeDasharray="60" strokeDashoffset="20" />
                        </svg>
                      ) : (
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                          <polyline points="14,2 14,8 20,8" />
                          <path d="M8 13h2l2 3 2-6 2 3h2" />
                        </svg>
                      )}
                      <span>{exportingExcel ? 'Working...' : 'Excel'}</span>
                    </button>

                    {/* PDF Button */}
                    <button
                      onClick={() => {
                        setExportingPDF(true);
                        setTimeout(() => {
                          exportToPDF();
                          setExportingPDF(false);
                        }, 300);
                      }}
                      disabled={exportingPDF}
                      style={{
                        display: 'flex',
                        flexDirection: 'column',
                        alignItems: 'center',
                        justifyContent: 'center',
                        gap: '6px',
                        padding: '14px 20px',
                        minWidth: '90px',
                        background: exportingPDF
                          ? 'linear-gradient(135deg, #a93226 0%, #922b21 100%)'
                          : 'linear-gradient(135deg, #c0392b 0%, #a93226 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '14px',
                        cursor: exportingPDF ? 'wait' : 'pointer',
                        fontFamily: 'inherit',
                        fontWeight: 600,
                        fontSize: '12px',
                        boxShadow: '0 4px 14px rgba(192, 57, 43, 0.35)',
                        transition: 'all 0.25s cubic-bezier(0.4, 0, 0.2, 1)',
                        transform: exportingPDF ? 'scale(0.97)' : 'scale(1)'
                      }}
                      onMouseEnter={e => {
                        if (!exportingPDF) {
                          e.currentTarget.style.transform = 'translateY(-3px) scale(1.02)';
                          e.currentTarget.style.boxShadow = '0 8px 20px rgba(192, 57, 43, 0.45)';
                        }
                      }}
                      onMouseLeave={e => {
                        e.currentTarget.style.transform = 'scale(1)';
                        e.currentTarget.style.boxShadow = '0 4px 14px rgba(192, 57, 43, 0.35)';
                      }}
                      title="Download PDF Report"
                    >
                      {exportingPDF ? (
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" style={{ animation: 'spin 1s linear infinite' }}>
                          <circle cx="12" cy="12" r="10" strokeDasharray="60" strokeDashoffset="20" />
                        </svg>
                      ) : (
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                          <polyline points="14,2 14,8 20,8" />
                          <path d="M9 15h6M12 12v6" />
                        </svg>
                      )}
                      <span>{exportingPDF ? 'Working...' : 'PDF'}</span>
                    </button>
                  </div>
                </div>

                {/* Divider */}
                <div style={{
                  width: '1px',
                  background: 'linear-gradient(180deg, transparent 0%, var(--border) 20%, var(--border) 80%, transparent 100%)',
                  margin: '8px 4px'
                }} />

                {/* Primary Action - View Full Details */}
                <div style={{
                  display: 'flex',
                  flexDirection: 'column',
                  gap: '8px',
                  flex: 1
                }}>
                  <div style={{
                    fontSize: '10px',
                    fontWeight: 700,
                    textTransform: 'uppercase',
                    letterSpacing: '0.8px',
                    color: 'var(--text-muted)',
                    paddingLeft: '4px'
                  }}>
                    Primary Action
                  </div>
                  <button
                    onClick={() => onViewFullDetails && onViewFullDetails(survey)}
                    style={{
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      gap: '12px',
                      padding: '16px 32px',
                      background: 'linear-gradient(135deg, #1e3a5f 0%, #2c5282 100%)',
                      color: 'white',
                      border: 'none',
                      borderRadius: '14px',
                      cursor: 'pointer',
                      fontFamily: 'inherit',
                      fontWeight: 700,
                      fontSize: '15px',
                      boxShadow: '0 6px 20px rgba(30, 58, 95, 0.4)',
                      transition: 'all 0.25s cubic-bezier(0.4, 0, 0.2, 1)',
                      flex: 1,
                      minHeight: '58px'
                    }}
                    onMouseEnter={e => {
                      e.currentTarget.style.transform = 'translateY(-3px)';
                      e.currentTarget.style.boxShadow = '0 10px 28px rgba(30, 58, 95, 0.5)';
                      e.currentTarget.style.background = 'linear-gradient(135deg, #2c5282 0%, #3d6ba8 100%)';
                    }}
                    onMouseLeave={e => {
                      e.currentTarget.style.transform = 'translateY(0)';
                      e.currentTarget.style.boxShadow = '0 6px 20px rgba(30, 58, 95, 0.4)';
                      e.currentTarget.style.background = 'linear-gradient(135deg, #1e3a5f 0%, #2c5282 100%)';
                    }}
                  >
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                      <line x1="3" y1="9" x2="21" y2="9"></line>
                      <line x1="9" y1="21" x2="9" y2="9"></line>
                    </svg>
                    View Full Details
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                      <polyline points="12 5 19 12 12 19"></polyline>
                    </svg>
                  </button>
                </div>

                {/* Divider */}
                <div style={{
                  width: '1px',
                  background: 'linear-gradient(180deg, transparent 0%, var(--border) 20%, var(--border) 80%, transparent 100%)',
                  margin: '8px 4px'
                }} />

                {/* Share & Close Section */}
                <div style={{
                  display: 'flex',
                  flexDirection: 'column',
                  gap: '8px'
                }}>
                  <div style={{
                    fontSize: '10px',
                    fontWeight: 700,
                    textTransform: 'uppercase',
                    letterSpacing: '0.8px',
                    color: 'var(--text-muted)',
                    paddingLeft: '4px'
                  }}>
                    Actions
                  </div>
                  <div style={{ display: 'flex', gap: '8px' }}>
                    {/* Share Button */}
                    <button
                      onClick={handleShare}
                      style={{
                        display: 'flex',
                        flexDirection: 'column',
                        alignItems: 'center',
                        justifyContent: 'center',
                        gap: '6px',
                        padding: '14px 20px',
                        minWidth: '90px',
                        background: 'linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '14px',
                        cursor: 'pointer',
                        fontFamily: 'inherit',
                        fontWeight: 600,
                        fontSize: '12px',
                        boxShadow: '0 4px 14px rgba(155, 89, 182, 0.35)',
                        transition: 'all 0.25s cubic-bezier(0.4, 0, 0.2, 1)'
                      }}
                      onMouseEnter={e => {
                        e.currentTarget.style.transform = 'translateY(-3px) scale(1.02)';
                        e.currentTarget.style.boxShadow = '0 8px 20px rgba(155, 89, 182, 0.45)';
                      }}
                      onMouseLeave={e => {
                        e.currentTarget.style.transform = 'scale(1)';
                        e.currentTarget.style.boxShadow = '0 4px 14px rgba(155, 89, 182, 0.35)';
                      }}
                      title="Share Assessment with Center"
                    >
                      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <circle cx="18" cy="5" r="3"></circle>
                        <circle cx="6" cy="12" r="3"></circle>
                        <circle cx="18" cy="19" r="3"></circle>
                        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                      </svg>
                      <span>Share</span>
                    </button>

                    {/* Close Button */}
                    <button
                      onClick={onClose}
                      style={{
                        display: 'flex',
                        flexDirection: 'column',
                        alignItems: 'center',
                        justifyContent: 'center',
                        gap: '6px',
                        padding: '14px 20px',
                        minWidth: '90px',
                        background: 'linear-gradient(135deg, #64748b 0%, #475569 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '14px',
                        cursor: 'pointer',
                        fontFamily: 'inherit',
                        fontWeight: 600,
                        fontSize: '12px',
                        boxShadow: '0 4px 14px rgba(100, 116, 139, 0.3)',
                        transition: 'all 0.25s cubic-bezier(0.4, 0, 0.2, 1)'
                      }}
                      onMouseEnter={e => {
                        e.currentTarget.style.transform = 'translateY(-3px) scale(1.02)';
                        e.currentTarget.style.boxShadow = '0 8px 20px rgba(100, 116, 139, 0.4)';
                      }}
                      onMouseLeave={e => {
                        e.currentTarget.style.transform = 'scale(1)';
                        e.currentTarget.style.boxShadow = '0 4px 14px rgba(100, 116, 139, 0.3)';
                      }}
                      title="Close Summary"
                    >
                      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                      </svg>
                      <span>Close</span>
                    </button>
                  </div>
                </div>
                  </>
                )}

                {/* Mobile: View Full Details Button */}
                {isMobile && (
                  <button
                    onClick={() => setShowMobileWarning(true)}
                    style={{
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      gap: '8px',
                      padding: '14px 20px',
                      background: 'linear-gradient(135deg, #1e3a5f 0%, #2c5282 100%)',
                      color: 'white',
                      border: 'none',
                      borderRadius: '10px',
                      cursor: 'pointer',
                      fontFamily: 'inherit',
                      fontWeight: 600,
                      fontSize: '14px',
                      boxShadow: '0 4px 12px rgba(30, 58, 95, 0.35)',
                      width: '100%'
                    }}
                  >
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                      <line x1="3" y1="9" x2="21" y2="9"></line>
                      <line x1="9" y1="21" x2="9" y2="9"></line>
                    </svg>
                    View Full Details
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                      <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                  </button>
                )}

                {/* Mobile Warning Modal */}
                {showMobileWarning && (
                  <div style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(0,0,0,0.6)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 1200,
                    backdropFilter: 'blur(4px)',
                    padding: '20px'
                  }} onClick={() => setShowMobileWarning(false)}>
                    <div style={{
                      background: 'white',
                      borderRadius: '24px',
                      padding: '28px 24px',
                      maxWidth: '340px',
                      width: '100%',
                      boxShadow: '0 25px 60px rgba(0,0,0,0.3)',
                      textAlign: 'center',
                      animation: 'slideUp 0.3s ease'
                    }} onClick={e => e.stopPropagation()}>
                      {/* Desktop Icon */}
                      <div style={{
                        width: '72px',
                        height: '72px',
                        background: 'linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%)',
                        borderRadius: '50%',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        margin: '0 auto 20px',
                        boxShadow: '0 8px 24px rgba(56, 189, 248, 0.25)'
                      }}>
                        <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#0284c7" strokeWidth="1.5">
                          <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                          <line x1="8" y1="21" x2="16" y2="21"></line>
                          <line x1="12" y1="17" x2="12" y2="21"></line>
                        </svg>
                      </div>

                      {/* Title */}
                      <h3 style={{
                        fontSize: '20px',
                        fontWeight: 700,
                        color: '#1e3a5f',
                        margin: '0 0 12px',
                        fontFamily: "'Lora', serif"
                      }}>
                        Better on Desktop
                      </h3>

                      {/* Message */}
                      <p style={{
                        color: '#64748b',
                        fontSize: '14px',
                        lineHeight: 1.6,
                        marginBottom: '24px'
                      }}>
                        For the best experience viewing and editing the full assessment details, we recommend using a desktop or laptop computer.
                      </p>

                      {/* Buttons */}
                      <div style={{ display: 'flex', gap: '12px' }}>
                        <button
                          onClick={() => setShowMobileWarning(false)}
                          style={{
                            flex: 1,
                            padding: '12px 16px',
                            background: '#f1f5f9',
                            color: '#64748b',
                            border: 'none',
                            borderRadius: '12px',
                            cursor: 'pointer',
                            fontFamily: 'inherit',
                            fontWeight: 600,
                            fontSize: '14px',
                            transition: 'all 0.2s'
                          }}
                        >
                          Go Back
                        </button>
                        <button
                          onClick={() => {
                            setShowMobileWarning(false);
                            onViewFullDetails && onViewFullDetails(survey);
                          }}
                          style={{
                            flex: 1,
                            padding: '12px 16px',
                            background: 'linear-gradient(135deg, #1e3a5f 0%, #2c5282 100%)',
                            color: 'white',
                            border: 'none',
                            borderRadius: '12px',
                            cursor: 'pointer',
                            fontFamily: 'inherit',
                            fontWeight: 600,
                            fontSize: '14px',
                            boxShadow: '0 4px 12px rgba(30, 58, 95, 0.3)',
                            transition: 'all 0.2s'
                          }}
                        >
                          Continue Anyway
                        </button>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>

          {/* Share Modal - Full Card Preview (same as recipient sees) */}
          {showShareModal && shareCredentials && (
            <div style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              background: 'rgba(0,0,0,0.8)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              zIndex: 1100,
              backdropFilter: 'blur(6px)',
              padding: '20px',
              overflowY: 'auto'
            }} onClick={() => setShowShareModal(false)}>
              <div style={{
                maxWidth: '420px',
                width: '100%'
              }} onClick={e => e.stopPropagation()}>

                {/* Card - Same experience as recipient */}
                <div style={{
                  background: 'linear-gradient(135deg, #1e3a5f 0%, #2c5282 100%)',
                  borderRadius: '24px',
                  padding: isMobile ? '24px' : '32px',
                  color: 'white',
                  position: 'relative',
                  overflow: 'hidden',
                  boxShadow: '0 25px 60px rgba(30, 58, 95, 0.5)'
                }}>
                  {/* Decorative circles */}
                  <div style={{ position: 'absolute', top: '-30px', right: '-30px', width: '120px', height: '120px', background: 'rgba(255,255,255,0.05)', borderRadius: '50%' }}></div>
                  <div style={{ position: 'absolute', bottom: '-20px', left: '-20px', width: '80px', height: '80px', background: 'rgba(255,255,255,0.03)', borderRadius: '50%' }}></div>

                  {/* Header */}
                  <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '20px', position: 'relative' }}>
                    <div style={{
                      width: '44px',
                      height: '44px',
                      background: 'rgba(255,255,255,0.15)',
                      borderRadius: '12px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center'
                    }}>
                      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                        <path d="M9 12l2 2 4-4"></path>
                        <circle cx="12" cy="12" r="10"></circle>
                      </svg>
                    </div>
                    <div>
                      <div style={{ fontWeight: 700, fontSize: '16px' }}>Assessment Ready</div>
                      <div style={{ fontSize: '12px', opacity: 0.7 }}>StandardsHub  CBAHI</div>
                    </div>
                  </div>

                  {/* Center Name */}
                  <div style={{
                    fontSize: '20px',
                    fontWeight: 700,
                    marginBottom: '20px',
                    lineHeight: 1.3
                  }}>
                    {shareCredentials.centerName}
                  </div>

                  {/* Password Box */}
                  <div style={{
                    background: 'rgba(255,255,255,0.12)',
                    borderRadius: '14px',
                    padding: '16px',
                    marginBottom: '16px'
                  }}>
                    <div style={{
                      fontSize: '10px',
                      textTransform: 'uppercase',
                      letterSpacing: '1.5px',
                      opacity: 0.6,
                      marginBottom: '8px',
                      textAlign: 'center'
                    }}>
                      Access Password
                    </div>
                    <div style={{
                      fontSize: '28px',
                      fontWeight: 800,
                      fontFamily: 'monospace',
                      letterSpacing: '5px',
                      textAlign: 'center'
                    }}>
                      {shareCredentials.password}
                    </div>
                  </div>

                  {/* Action Buttons */}
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                    {/* Open Assessment Button - Functional */}
                    <button
                      onClick={() => {
                        window.location.href = window.location.pathname + '?view=' + shareCredentials.shareId;
                      }}
                      style={{
                        width: '100%',
                        padding: '14px 20px',
                        background: 'white',
                        color: '#1e3a5f',
                        border: 'none',
                        borderRadius: '12px',
                        fontWeight: 700,
                        fontSize: '15px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        gap: '8px',
                        cursor: 'pointer',
                        transition: 'all 0.2s'
                      }}
                    >
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                        <polyline points="15 3 21 3 21 9"></polyline>
                        <line x1="10" y1="14" x2="21" y2="3"></line>
                      </svg>
                      Open Assessment
                    </button>

                    {/* Copy Password Button - Functional */}
                    <button
                      onClick={() => copyToClipboard(shareCredentials.password)}
                      style={{
                        width: '100%',
                        padding: '12px 20px',
                        background: copied ? 'rgba(39, 174, 96, 0.25)' : 'rgba(255,255,255,0.1)',
                        color: 'white',
                        border: '1px solid rgba(255,255,255,0.2)',
                        borderRadius: '12px',
                        cursor: 'pointer',
                        fontWeight: 600,
                        fontSize: '14px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        gap: '8px',
                        transition: 'all 0.2s'
                      }}
                    >
                      {copied ? (
                        <>
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                            <polyline points="20 6 9 17 4 12"></polyline>
                          </svg>
                          Password Copied!
                        </>
                      ) : (
                        <>
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                          </svg>
                          Copy Password
                        </>
                      )}
                    </button>
                  </div>
                </div>

                {/* Copy Share Link Button - Below Card */}
                <div style={{ marginTop: '16px' }}>
                  <button
                    onClick={() => {
                      const cardUrl = window.location.origin + window.location.pathname + '?card=' + shareCredentials.shareId;
                      navigator.clipboard.writeText(cardUrl);
                      setCopied(true);
                      setTimeout(() => setCopied(false), 2000);
                    }}
                    style={{
                      width: '100%',
                      padding: '16px 24px',
                      background: 'white',
                      color: '#1e3a5f',
                      border: 'none',
                      borderRadius: '14px',
                      cursor: 'pointer',
                      fontWeight: 700,
                      fontSize: '16px',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      gap: '10px',
                      boxShadow: '0 4px 14px rgba(0,0,0,0.15)',
                      transition: 'all 0.2s'
                    }}
                  >
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                    </svg>
                    Copy Share Link
                  </button>
                </div>

                {/* Close hint */}
                <div style={{ textAlign: 'center', marginTop: '16px' }}>
                  <button
                    onClick={() => setShowShareModal(false)}
                    style={{
                      background: 'transparent',
                      border: 'none',
                      color: 'rgba(255,255,255,0.6)',
                      fontSize: '13px',
                      cursor: 'pointer',
                      padding: '8px 16px'
                    }}
                  >
                    Close
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // Centers Page
    const CentersPage = ({ surveys, currentAssessmentId, onEditSurvey, onDeleteSurvey, onResumeAssessment, onViewSummary }) => {
      // Format phone for WhatsApp
      const formatWhatsApp = (phone) => {
        if (!phone) return '';
        let clean = phone.replace(/[\s\-()]/g, '');
        if (!clean.startsWith('+')) {
          clean = '+966' + clean.replace(/^0/, '');
        }
        return clean;
      };

      // Sort surveys by date (newest first)
      const sortedSurveys = [...surveys].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

      const getStatusLabel = (status) => {
        switch (status) {
          case 'completed': return { text: ' Completed', class: 'completed' };
          case 'in_progress': return { text: ' In Progress', class: 'in-progress' };
          default: return { text: ' Not Started', class: 'not-started' };
        }
      };

      const getProgressPercent = (survey) => {
        const total = survey.totalSubstandards || 180;
        const scored = survey.scoredCount || 0;
        return Math.round((scored / total) * 100);
      };

      return (
        <div className="page-container">
          <div style={{ marginBottom: '32px' }}>
            <h2 style={{ marginBottom: '8px' }}>Assessment History</h2>
            <p style={{ color: 'var(--text-secondary)', fontSize: '15px' }}>
              Track all dental center assessments and their completion status
            </p>
          </div>

          {sortedSurveys.length === 0 ? (
            <div className="card">
              <div className="card-body">
                <div className="empty-state">
                  <div className="empty-state-icon" style={{ color: 'var(--text-muted)' }}>
                    {Icons.clipboard({ size: 48, color: 'var(--text-muted)' })}
                  </div>
                  <h3>No assessments yet</h3>
                  <p>Start a new assessment from the Scoring page. All assessments will appear here with their status.</p>
                </div>
              </div>
            </div>
          ) : (
            <div style={{ display: 'grid', gap: '24px', gridTemplateColumns: 'repeat(auto-fill, minmax(380px, 1fr))' }}>
              {sortedSurveys.map(survey => {
                const details = survey.assessmentDetails || {};
                const statusInfo = getStatusLabel(survey.status);
                const isCurrent = survey.id === currentAssessmentId;
                const progress = getProgressPercent(survey);

                // Handle card click based on status
                const handleCardClick = () => {
                  if (survey.status === 'completed') {
                    onViewSummary && onViewSummary(survey);
                  } else if (survey.status === 'in_progress' || survey.status === 'not_started') {
                    onResumeAssessment && onResumeAssessment(survey);
                  }
                };

                return (
                  <div
                    key={survey.id}
                    className={`assessment-card ${isCurrent ? 'current' : ''}`}
                    onClick={handleCardClick}
                    style={{ cursor: 'pointer' }}
                    title={survey.status === 'completed' ? 'Click to view Executive Summary' : 'Click to resume assessment'}
                  >
                    {/* Card Header with Status Color */}
                    <div className={`assessment-card-header ${statusInfo.class}`}>
                      <div style={{ position: 'absolute', top: '12px', right: '12px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                        {isCurrent && (
                          <div className="current-badge">
                             Active Now
                          </div>
                        )}
                        <button
                          onClick={(e) => { e.stopPropagation(); onEditSurvey && onEditSurvey(survey); }}
                          title="Edit Details"
                          style={{
                            width: '32px', height: '32px', borderRadius: '50%',
                            border: 'none', background: 'rgba(255,255,255,0.2)',
                            color: 'white', cursor: 'pointer',
                            display: 'flex', alignItems: 'center', justifyContent: 'center',
                            transition: 'all 0.2s ease', fontSize: '14px'
                          }}
                          onMouseOver={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.3)'}
                          onMouseOut={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.2)'}
                        >
                          {Icons.edit({ size: 14, color: 'white' })}
                        </button>
                        <button
                          onClick={(e) => { e.stopPropagation(); onDeleteSurvey && onDeleteSurvey(survey); }}
                          title="Delete Assessment"
                          style={{
                            width: '32px', height: '32px', borderRadius: '50%',
                            border: 'none', background: 'rgba(231, 76, 60, 0.3)',
                            color: 'white', cursor: 'pointer',
                            display: 'flex', alignItems: 'center', justifyContent: 'center',
                            transition: 'all 0.2s ease', fontSize: '14px'
                          }}
                          onMouseOver={(e) => e.currentTarget.style.background = 'rgba(231, 76, 60, 0.5)'}
                          onMouseOut={(e) => e.currentTarget.style.background = 'rgba(231, 76, 60, 0.3)'}
                        >
                          {Icons.trash({ size: 14, color: 'white' })}
                        </button>
                      </div>
                      <div className="assessment-card-logo">{Icons.building({ size: 28, color: 'white' })}</div>
                      <div className="assessment-card-center-name">
                        {details.centerName || survey.centerName || 'Unknown Center'}
                      </div>
                      <div className="assessment-card-coordinator">
                        {Icons.user({ size: 14, color: 'rgba(255,255,255,0.8)' })} {details.coordinatorName || 'No coordinator assigned'}
                      </div>
                      <div style={{
                        marginTop: '10px',
                        padding: '5px 12px',
                        background: 'rgba(255,255,255,0.08)',
                        border: '1px solid rgba(255,255,255,0.25)',
                        borderRadius: '6px',
                        fontSize: '11px',
                        fontWeight: 500,
                        letterSpacing: '0.3px',
                        display: 'inline-block',
                        backdropFilter: 'blur(4px)'
                      }}>
                        {survey.configuration || 'A - Surveyor 1'}
                      </div>
                    </div>

                    {/* Card Body */}
                    <div className="assessment-card-body">
                      {/* Status Badge */}
                      <div style={{ marginBottom: '20px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <div className={`status-badge ${statusInfo.class}`}>
                          {statusInfo.text}
                        </div>
                        {survey.status === 'completed' && survey.stats && (
                          <div style={{
                            fontSize: '28px',
                            fontWeight: 700,
                            color: survey.stats.percentage >= 75 ? 'var(--success)' :
                              survey.stats.percentage >= 60 ? 'var(--warning)' : 'var(--danger)'
                          }}>
                            {survey.stats.percentage}%
                          </div>
                        )}
                      </div>

                      {/* Progress Bar for In Progress */}
                      {survey.status !== 'completed' && (
                        <div style={{ marginBottom: '20px' }}>
                          <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px', fontSize: '13px' }}>
                            <span style={{ color: 'var(--text-secondary)' }}>Scoring Progress</span>
                            <span style={{ fontWeight: 600, color: 'var(--text-primary)' }}>{progress}%</span>
                          </div>
                          <div style={{
                            height: '8px',
                            background: 'var(--bg-hover)',
                            borderRadius: '4px',
                            overflow: 'hidden'
                          }}>
                            <div style={{
                              height: '100%',
                              width: `${progress}%`,
                              background: survey.status === 'in_progress'
                                ? 'linear-gradient(90deg, var(--accent) 0%, #2980b9 100%)'
                                : 'var(--neutral)',
                              borderRadius: '4px',
                              transition: 'width 0.3s ease'
                            }} />
                          </div>
                          <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginTop: '6px' }}>
                            {survey.scoredCount || 0} of {survey.totalSubstandards || 180} items scored
                          </div>
                        </div>
                      )}

                      {/* Stats for Completed */}
                      {survey.status === 'completed' && survey.stats && (
                        <div className="assessment-card-stats">
                          <div className="assessment-stat-item" style={{ background: 'rgba(46, 204, 113, 0.1)' }}>
                            <div className="assessment-stat-value" style={{ color: 'var(--success)' }}>{survey.stats.fullyMet}</div>
                            <div className="assessment-stat-label">Fully Met</div>
                          </div>
                          <div className="assessment-stat-item" style={{ background: 'rgba(241, 196, 15, 0.1)' }}>
                            <div className="assessment-stat-value" style={{ color: 'var(--warning)' }}>{survey.stats.partial}</div>
                            <div className="assessment-stat-label">Partial</div>
                          </div>
                          <div className="assessment-stat-item" style={{ background: 'rgba(231, 76, 60, 0.1)' }}>
                            <div className="assessment-stat-value" style={{ color: 'var(--danger)' }}>{survey.stats.notMet}</div>
                            <div className="assessment-stat-label">Not Met</div>
                          </div>
                        </div>
                      )}

                      {/* Contact Info */}
                      {(details.coordinatorPhone || details.coordinatorEmail) && (
                        <div style={{
                          display: 'flex',
                          gap: '16px',
                          padding: '12px 0',
                          borderTop: '1px solid var(--border)',
                          marginTop: '16px'
                        }}>
                          {details.coordinatorPhone && (
                            <a href={`https://wa.me/${formatWhatsApp(details.coordinatorPhone)}`}
                              target="_blank" rel="noopener noreferrer"
                              className="contact-link whatsapp" style={{ fontSize: '13px', display: 'inline-flex', alignItems: 'center', gap: '6px' }}>
                              {Icons.whatsapp({ size: 14 })} WhatsApp
                            </a>
                          )}
                          {details.coordinatorEmail && (
                            <a href={`mailto:${details.coordinatorEmail}`}
                              className="contact-link email" style={{ fontSize: '13px', display: 'inline-flex', alignItems: 'center', gap: '6px' }}>
                              {Icons.mail({ size: 14 })} Email
                            </a>
                          )}
                        </div>
                      )}
                    </div>

                    {/* Card Footer */}
                    <div className="assessment-card-footer" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                      <div>
                        <div style={{ fontSize: '12px', color: 'var(--text-muted)' }}>
                          Started: {new Date(survey.createdAt).toLocaleDateString('en-US', {
                            month: 'short', day: 'numeric', year: 'numeric'
                          })}  {new Date(survey.createdAt).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}
                        </div>
                        {survey.completedAt && (
                          <div style={{ fontSize: '12px', color: 'var(--success)', marginTop: '2px' }}>
                            Submitted: {new Date(survey.completedAt).toLocaleDateString('en-US', {
                              month: 'short', day: 'numeric', year: 'numeric'
                            })}  {new Date(survey.completedAt).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}
                          </div>
                        )}
                        {survey.lastEditedAt && (
                          <div style={{ fontSize: '12px', color: '#d97706', marginTop: '2px', display: 'flex', alignItems: 'center', gap: '4px' }}>
                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                            Edited: {new Date(survey.lastEditedAt).toLocaleDateString('en-US', {
                              month: 'short', day: 'numeric', year: 'numeric'
                            })}  {new Date(survey.lastEditedAt).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}
                          </div>
                        )}
                      </div>
                      <div style={{
                        padding: '10px 18px',
                        borderRadius: '8px',
                        fontSize: '13px',
                        fontWeight: 600,
                        background: survey.status === 'completed'
                          ? 'linear-gradient(135deg, #1e3a5f 0%, #2d5a8a 100%)'
                          : 'linear-gradient(135deg, #2c5282 0%, #3182ce 100%)',
                        color: 'white',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '6px',
                        boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
                      }}>
                        {survey.status === 'completed' ? (
                          <>{Icons.barChart({ size: 14, color: 'white' })} View Summary</>
                        ) : (
                          <>{Icons.clipboard({ size: 14, color: 'white' })} {survey.status === 'in_progress' ? 'Resume' : 'Start'}</>
                        )}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      );
    };

    // ============================================
    // MAIN APP
    // ============================================
    const LandingPage = ({ onGetStarted, onLogin }) => {
      const [lang, setLang] = useState('en');
      const [scrolled, setScrolled] = useState(false);
      const [showContactModal, setShowContactModal] = useState(false);
      const [showLoginModal, setShowLoginModal] = useState(false);
      const [loginError, setLoginError] = useState('');
      const [username, setUsername] = useState('');
      const [password, setPassword] = useState('');
      const [isMobile, setIsMobile] = useState(window.innerWidth <= 768);

      // Hero carousel state - 3 slides rotating vertically
      const [heroSlide, setHeroSlide] = useState(0);
      const [heroPaused, setHeroPaused] = useState(false);
      const totalHeroSlides = 3;

      // Auto-rotate hero carousel every 5 seconds
      useEffect(() => {
        if (heroPaused || isMobile) return;
        const timer = setInterval(() => {
          setHeroSlide(prev => (prev + 1) % totalHeroSlides);
        }, 5000);
        return () => clearInterval(timer);
      }, [heroPaused, isMobile]);
      const isRtl = lang === 'ar';

      // Mobile detection
      useEffect(() => {
        const checkMobile = () => setIsMobile(window.innerWidth <= 768);
        window.addEventListener('resize', checkMobile);
        return () => window.removeEventListener('resize', checkMobile);
      }, []);

      // Login handler
      const handleLogin = (e) => {
        e.preventDefault();
        if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
          setShowLoginModal(false);
          setLoginError('');
          if (onLogin) onLogin();
        } else {
          setLoginError(lang === 'en' ? 'Invalid credentials' : '   ');
        }
      };


      useEffect(() => {
        const handleScroll = () => setScrolled(window.scrollY > 20);
        window.addEventListener('scroll', handleScroll);
        return () => window.removeEventListener('scroll', handleScroll);
      }, []);

      // Professional SVG Icons
      const icons = {
        excellence: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>',
        team: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
        quality: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
        safety: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>',
        whatsapp: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>',
        email: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>'
      };

      const t = {
        nav: {
          brand: lang === 'en' ? 'Standards Hub' : ' '
        },
        hero: {
          title: lang === 'en' ? 'Successful Accreditation Visit' : '  ',
          subtitleLine1: lang === 'en' ? 'Confidence born from readiness.' : '   ',
          subtitleLine2: lang === 'en' ? 'Comfort created by excellent preparation.' : '  ',
          cta: lang === 'en' ? 'Order Consultation' : ' '
        },
        features: {
          title: lang === 'en' ? 'Why Choose Us?' : ' ',
          subtitle: lang === 'en' ? 'Four pillars that define our approach to accreditation success' : '      ',
          items: [
            { icon: 'excellence', title: lang === 'en' ? 'Excellence First' : ' ', desc: lang === 'en' ? 'Commitment to highest quality standards in every assessment.' : '      .', color: '#1e3a5f' },
            { icon: 'team', title: lang === 'en' ? 'Staff Empowerment' : ' ', desc: lang === 'en' ? 'Training and support for a confident, prepared team.' : '    .', color: '#0d6b4e' },
            { icon: 'quality', title: lang === 'en' ? 'Quality Journey' : ' ', desc: lang === 'en' ? 'Continuous improvement beyond basic compliance.' : '    .', color: '#3498db' },
            { icon: 'safety', title: lang === 'en' ? 'Patient Safety' : ' ', desc: lang === 'en' ? 'Every process prioritizes patient wellbeing.' : '     .', color: '#9b59b6' }
          ]
        },
        process: {
          title: lang === 'en' ? 'Your Preparation Journey' : ' ',
          subtitle: lang === 'en' ? 'A structured approach to accreditation readiness' : '   ',
          steps: [
            { title: lang === 'en' ? 'Gap Assessment' : ' ', desc: lang === 'en' ? 'Comprehensive evaluation against requirements.' : '   .', side: 'left' },
            { title: lang === 'en' ? 'Action Planning' : ' ', desc: lang === 'en' ? 'Prioritized roadmap with realistic timelines.' : '    .', side: 'right' },
            { title: lang === 'en' ? 'Team Preparation' : ' ', desc: lang === 'en' ? 'Staff training and mock surveys.' : '   .', side: 'left' },
            { title: lang === 'en' ? 'Survey Success' : ' ', desc: lang === 'en' ? 'Final preparation for an excellent experience.' : '   .', side: 'right' }
          ]
        },
        contact: {
          title: 'Contact Us',
          whatsapp: 'WhatsApp',
          email: 'Email',
          close: 'Close'
        },
        footer: lang === 'en' ? ' 2026 All rights reserved.' : ' 2026   .'
      };

      // Contact Modal Component - With WhatsApp (Always LTR)
      const ContactModal = () => (
        <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.6)', zIndex: 1000, display: 'flex', alignItems: 'center', justifyContent: 'center', backdropFilter: 'blur(8px)' }} onClick={() => setShowContactModal(false)}>
          <div dir="ltr" style={{ background: 'white', borderRadius: '24px', padding: '40px', maxWidth: '400px', width: '90%', textAlign: 'center', boxShadow: '0 24px 80px rgba(0,0,0,0.2)', direction: 'ltr' }} onClick={e => e.stopPropagation()}>
            <h3 style={{ fontSize: '24px', fontWeight: 700, color: '#1e3a5f', marginBottom: '8px', fontFamily: "'Lora', serif" }}>{t.contact.title}</h3>
            <p style={{ fontSize: '14px', color: '#64748b', marginBottom: '32px' }}>st-hubs.com</p>

            {/* WhatsApp Button */}
            <a href="https://wa.me/966554122111" target="_blank" rel="noopener noreferrer" style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '12px', padding: '16px 24px', background: '#25D366', color: 'white', borderRadius: '12px', textDecoration: 'none', marginBottom: '16px', fontWeight: 600, fontSize: '16px', transition: 'transform 0.2s', direction: 'ltr' }} onMouseOver={e => e.currentTarget.style.transform = 'scale(1.02)'} onMouseOut={e => e.currentTarget.style.transform = 'scale(1)'}>
              <div style={{ width: '24px', height: '24px' }} dangerouslySetInnerHTML={{ __html: icons.whatsapp }} />
              <span>{t.contact.whatsapp}</span>
              <span style={{ opacity: 0.8, fontSize: '14px' }}>+966 55 412 2111</span>
            </a>

            {/* Email Button */}
            <a href="mailto:order@st-hubs.com" style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '12px', padding: '16px 24px', background: '#1e3a5f', color: 'white', borderRadius: '12px', textDecoration: 'none', marginBottom: '24px', fontWeight: 600, fontSize: '16px', transition: 'transform 0.2s', direction: 'ltr' }} onMouseOver={e => e.currentTarget.style.transform = 'scale(1.02)'} onMouseOut={e => e.currentTarget.style.transform = 'scale(1)'}>
              <div style={{ width: '24px', height: '24px' }} dangerouslySetInnerHTML={{ __html: icons.email }} />
              <span>{t.contact.email}</span>
              <span style={{ opacity: 0.8, fontSize: '14px' }}>order@st-hubs.com</span>
            </a>

            <button onClick={() => setShowContactModal(false)} style={{ padding: '12px 32px', background: '#f1f5f9', border: 'none', borderRadius: '8px', color: '#64748b', cursor: 'pointer', fontSize: '14px', fontWeight: 500 }}>{t.contact.close}</button>
          </div>
        </div>
      );

      // CSS for animations
      const pulseKeyframes = `
        @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.4; }
        }
        @keyframes blink {
          0%, 100% { opacity: 1; }
          50% { opacity: 0; }
        }
        @keyframes float {
          0%, 100% { transform: translateY(0) rotate(-5deg); }
          50% { transform: translateY(-10px) rotate(-5deg); }
        }
        @keyframes floatReverse {
          0%, 100% { transform: translateY(0) rotate(5deg); }
          50% { transform: translateY(-10px) rotate(5deg); }
        }
        @keyframes glow {
          0%, 100% { box-shadow: 0 0 20px rgba(39, 174, 96, 0.3); }
          50% { box-shadow: 0 0 40px rgba(39, 174, 96, 0.6); }
        }
        @keyframes typing {
          0% { width: 0; }
          50% { width: 100%; }
          55% { width: 100%; }
          100% { width: 0; }
        }
        @keyframes cursorBlink {
          0%, 100% { border-right-color: #3498db; }
          50% { border-right-color: transparent; }
        }
      `;

      // Typing Text Component
      const TypingText = ({ text }) => {
        const [displayText, setDisplayText] = React.useState('');
        const [isDeleting, setIsDeleting] = React.useState(false);
        const [loopNum, setLoopNum] = React.useState(0);

        React.useEffect(() => {
          const fullText = text;
          const typingSpeed = isDeleting ? 40 : 80;
          const pauseTime = isDeleting ? 500 : 2000;

          const handleTyping = () => {
            if (!isDeleting && displayText === fullText) {
              setTimeout(() => setIsDeleting(true), pauseTime);
              return;
            }
            if (isDeleting && displayText === '') {
              setIsDeleting(false);
              setLoopNum(loopNum + 1);
              return;
            }

            const nextText = isDeleting
              ? fullText.substring(0, displayText.length - 1)
              : fullText.substring(0, displayText.length + 1);
            setDisplayText(nextText);
          };

          const timer = setTimeout(handleTyping, typingSpeed);
          return () => clearTimeout(timer);
        }, [displayText, isDeleting, text]);

        return (
          <span style={{ display: 'inline-flex', alignItems: 'center' }}>
            <span style={{ fontSize: '12px', color: '#64748b', fontFamily: "'Lora', serif", fontStyle: 'italic' }}>{displayText}</span>
            <span style={{
              display: 'inline-block',
              width: '2px',
              height: '14px',
              background: '#3498db',
              marginLeft: '2px',
              animation: 'blink 0.8s infinite'
            }} />
          </span>
        );
      };

      return (
        <div className={`linear-layout ${isRtl ? 'rtl' : 'ltr'}`} dir={isRtl ? 'rtl' : 'ltr'} style={{ fontFamily: isRtl ? "'Noto Naskh Arabic', 'Inter', sans-serif" : "'Inter', sans-serif", background: '#f8fafc' }}>
          <style>{pulseKeyframes}</style>

          {/* Contact Modal */}
          {showContactModal && <ContactModal />}

          {/* Login Modal */}
          {showLoginModal && (
            <div style={{
              position: 'fixed',
              top: 0, left: 0, right: 0, bottom: 0,
              background: 'rgba(30, 58, 95, 0.6)',
              backdropFilter: 'blur(8px)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              zIndex: 1000
            }} onClick={() => setShowLoginModal(false)}>
              <div style={{
                background: 'rgba(255, 255, 255, 0.95)',
                backdropFilter: 'blur(20px)',
                borderRadius: '24px',
                padding: '48px',
                width: '400px',
                maxWidth: '90%',
                boxShadow: '0 25px 80px rgba(31, 38, 135, 0.25)',
                border: '1px solid rgba(255, 255, 255, 0.8)',
                position: 'relative'
              }} onClick={e => e.stopPropagation()}>
                {/* Close Button */}
                <button onClick={() => setShowLoginModal(false)} style={{
                  position: 'absolute', top: '20px', right: '20px',
                  background: 'none', border: 'none', cursor: 'pointer',
                  fontSize: '24px', color: '#64748b', lineHeight: 1
                }}></button>

                {/* Fingerprint Icon */}
                <div style={{
                  width: '80px', height: '80px',
                  background: 'linear-gradient(135deg, #1e3a5f 0%, #3498db 100%)',
                  borderRadius: '50%',
                  display: 'flex', alignItems: 'center', justifyContent: 'center',
                  margin: '0 auto 24px auto',
                  boxShadow: '0 8px 32px rgba(52, 152, 219, 0.3)'
                }}>
                  <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                    <path d="M2 12C2 6.5 6.5 2 12 2a10 10 0 0 1 8 4" />
                    <path d="M5 19.5C5.5 18 6 15 6 12c0-2.5.5-5 3-5" />
                    <path d="M22 12c0 4-1 6-3 9" />
                    <path d="M12 12c0 4-.5 6-3 9" />
                    <path d="M18 12c0 2-.5 4-2 7" />
                    <path d="M9 12c0 2 .5 4 2 7" />
                    <path d="M12 7c2.5 0 3.5 1.5 3.5 5" />
                  </svg>
                </div>

                <h2 style={{
                  textAlign: 'center',
                  fontSize: '24px',
                  fontWeight: 700,
                  color: '#1e3a5f',
                  marginBottom: '8px',
                  fontFamily: isRtl ? "'Noto Naskh Arabic', serif" : "'Lora', serif"
                }}>{lang === 'en' ? 'Welcome Back' : ' '}</h2>
                <p style={{
                  textAlign: 'center',
                  color: '#64748b',
                  marginBottom: '32px',
                  fontFamily: isRtl ? "'Noto Naskh Arabic', serif" : "'Lora', serif"
                }}>{lang === 'en' ? 'Sign in to continue' : '  '}</p>

                <form onSubmit={handleLogin}>
                  {/* Username */}
                  <div style={{ marginBottom: '20px' }}>
                    <label style={{
                      display: 'block',
                      marginBottom: '8px',
                      fontSize: '14px',
                      fontWeight: 600,
                      color: '#475569',
                      fontFamily: isRtl ? "'Noto Naskh Arabic', serif" : "'Lora', serif"
                    }}>{lang === 'en' ? 'Username' : ' '}</label>
                    <input
                      type="text"
                      value={username}
                      onChange={e => setUsername(e.target.value)}
                      placeholder={lang === 'en' ? 'Enter username' : '  '}
                      style={{
                        width: '100%',
                        padding: '14px 18px',
                        border: '2px solid #e2e8f0',
                        borderRadius: '12px',
                        fontSize: '16px',
                        outline: 'none',
                        transition: 'border-color 0.2s',
                        fontFamily: isRtl ? "'Noto Naskh Arabic', serif" : "'Lora', serif",
                        direction: isRtl ? 'rtl' : 'ltr',
                        boxSizing: 'border-box'
                      }}
                      onFocus={e => e.target.style.borderColor = '#3498db'}
                      onBlur={e => e.target.style.borderColor = '#e2e8f0'}
                    />
                  </div>

                  {/* Password */}
                  <div style={{ marginBottom: '24px' }}>
                    <label style={{
                      display: 'block',
                      marginBottom: '8px',
                      fontSize: '14px',
                      fontWeight: 600,
                      color: '#475569',
                      fontFamily: isRtl ? "'Noto Naskh Arabic', serif" : "'Lora', serif"
                    }}>{lang === 'en' ? 'Password' : ' '}</label>
                    <input
                      type="password"
                      value={password}
                      onChange={e => setPassword(e.target.value)}
                      placeholder={lang === 'en' ? 'Enter password' : '  '}
                      style={{
                        width: '100%',
                        padding: '14px 18px',
                        border: '2px solid #e2e8f0',
                        borderRadius: '12px',
                        fontSize: '16px',
                        outline: 'none',
                        transition: 'border-color 0.2s',
                        fontFamily: isRtl ? "'Noto Naskh Arabic', serif" : "'Lora', serif",
                        direction: isRtl ? 'rtl' : 'ltr',
                        boxSizing: 'border-box'
                      }}
                      onFocus={e => e.target.style.borderColor = '#3498db'}
                      onBlur={e => e.target.style.borderColor = '#e2e8f0'}
                    />
                  </div>

                  {/* Error Message */}
                  {loginError && (
                    <div style={{
                      background: '#fee2e2',
                      color: '#dc2626',
                      padding: '12px',
                      borderRadius: '8px',
                      marginBottom: '20px',
                      fontSize: '14px',
                      textAlign: 'center',
                      fontFamily: isRtl ? "'Noto Naskh Arabic', serif" : "'Lora', serif"
                    }}>{loginError}</div>
                  )}

                  {/* Submit Button */}
                  <button type="submit" style={{
                    width: '100%',
                    padding: '16px',
                    background: 'linear-gradient(135deg, #1e3a5f 0%, #3498db 100%)',
                    color: 'white',
                    border: 'none',
                    borderRadius: '12px',
                    fontSize: '16px',
                    fontWeight: 700,
                    cursor: 'pointer',
                    transition: 'transform 0.2s, box-shadow 0.2s',
                    fontFamily: isRtl ? "'Noto Naskh Arabic', serif" : "'Lora', serif",
                    boxShadow: '0 4px 20px rgba(52, 152, 219, 0.3)'
                  }}
                  onMouseOver={e => {
                    e.target.style.transform = 'translateY(-2px)';
                    e.target.style.boxShadow = '0 8px 30px rgba(52, 152, 219, 0.4)';
                  }}
                  onMouseOut={e => {
                    e.target.style.transform = 'translateY(0)';
                    e.target.style.boxShadow = '0 4px 20px rgba(52, 152, 219, 0.3)';
                  }}>
                    {lang === 'en' ? 'Sign In' : ' '}
                  </button>
                </form>
              </div>
            </div>
          )}

          {/* Header - Responsive with Centered Logo */}
          <header style={{
            padding: isMobile ? '10px 12px' : '16px 60px',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            position: 'absolute',
            top: 0,
            left: 0,
            right: 0,
            zIndex: 100,
            background: 'rgba(248, 250, 252, 0.92)',
            backdropFilter: 'blur(12px)',
            borderBottom: '1px solid rgba(30, 58, 95, 0.08)',
            boxShadow: '0 1px 3px rgba(0, 0, 0, 0.02)',
            direction: 'ltr'
          }}>
            {/* Left - Language Toggle */}
            <div style={{ flex: isMobile ? 'none' : 1, display: 'flex', justifyContent: 'flex-start', minWidth: isMobile ? '44px' : 'auto' }}>
              <button
                onClick={() => setLang(lang === 'en' ? 'ar' : 'en')}
                style={{
                  fontSize: isMobile ? '12px' : '15px',
                  fontWeight: 600,
                  color: '#1e3a5f',
                  background: 'rgba(255, 255, 255, 0.6)',
                  border: '1px solid rgba(30, 58, 95, 0.1)',
                  borderRadius: isMobile ? '50%' : '8px',
                  cursor: 'pointer',
                  padding: isMobile ? '8px' : '8px 16px',
                  fontFamily: lang === 'en' ? "'Noto Naskh Arabic', serif" : "'Lora', serif",
                  width: isMobile ? '36px' : 'auto',
                  height: isMobile ? '36px' : 'auto',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center'
                }}
              >
                {lang === 'en' ? (isMobile ? '' : '') : 'EN'}
              </button>
            </div>

            {/* Center - Logo with Rounded Container */}
            <div style={{
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              gap: isMobile ? '6px' : '12px',
              cursor: 'pointer',
              background: 'rgba(255, 255, 255, 0.95)',
              padding: isMobile ? '5px 12px' : '8px 20px',
              borderRadius: '50px',
              border: '1px solid rgba(30, 58, 95, 0.08)',
              boxShadow: '0 2px 8px rgba(30, 58, 95, 0.06)',
              flex: isMobile ? 1 : 'none',
              maxWidth: isMobile ? '200px' : 'none',
              margin: isMobile ? '0 8px' : 0
            }}>
              <img src="assets/logo-sh.png" alt="SH" style={{
                height: isMobile ? '24px' : '36px',
                width: 'auto',
                borderRadius: '4px'
              }} />
              <span style={{
                fontWeight: 700,
                fontSize: lang === 'en' ? (isMobile ? '12px' : '18px') : (isMobile ? '18px' : '26px'),
                color: lang === 'en' ? '#1e3a5f' : '#0a1f33',
                fontFamily: lang === 'en' ? "'Lora', serif" : "'Amiri', serif",
                whiteSpace: 'nowrap'
              }}>{lang === 'en' ? 'StandardsHub' : ' '}</span>
            </div>

            {/* Right - Login Button (Icon only on mobile) */}
            <div style={{ flex: isMobile ? 'none' : 1, display: 'flex', justifyContent: 'flex-end', minWidth: isMobile ? '44px' : 'auto' }}>
              <button
                onClick={() => setShowLoginModal(true)}
                style={{
                  padding: isMobile ? '8px' : '10px 24px',
                  background: 'rgba(255, 255, 255, 0.6)',
                  backdropFilter: 'blur(12px)',
                  color: '#1e3a5f',
                  border: '1px solid rgba(30, 58, 95, 0.1)',
                  borderRadius: '50px',
                  fontWeight: 600,
                  fontSize: '15px',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  gap: isMobile ? 0 : '8px',
                  boxShadow: '0 4px 12px rgba(30,58,95,0.08)',
                  fontFamily: "'Lora', serif",
                  transition: 'all 0.2s',
                  width: isMobile ? '36px' : 'auto',
                  height: isMobile ? '36px' : 'auto'
                }}
                onMouseOver={e => {
                  e.currentTarget.style.transform = 'translateY(-2px)';
                  e.currentTarget.style.background = 'rgba(255, 255, 255, 0.85)';
                  e.currentTarget.style.boxShadow = '0 6px 16px rgba(30,58,95,0.12)';
                }}
                onMouseOut={e => {
                  e.currentTarget.style.transform = 'translateY(0)';
                  e.currentTarget.style.background = 'rgba(255, 255, 255, 0.6)';
                  e.currentTarget.style.boxShadow = '0 4px 12px rgba(30,58,95,0.08)';
                }}
              >
                {/* Fingerprint Icon - Professional Biometric */}
                <svg width={isMobile ? "18" : "18"} height={isMobile ? "18" : "18"} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" style={{ color: '#1e3a5f' }}>
                  <path d="M2 12C2 6.5 6.5 2 12 2a10 10 0 0 1 8 4" />
                  <path d="M5 19.5C5.5 18 6 15 6 12c0-2.5.5-5 3-5" />
                  <path d="M22 12c0 4-1 6-3 9" />
                  <path d="M12 12c0 4-.5 6-3 9" />
                  <path d="M18 12c0 2-.5 4-2 7" />
                  <path d="M9 12c0 2 .5 4 2 7" />
                  <path d="M12 7c2.5 0 3.5 1.5 3.5 5" />
                </svg>
                {!isMobile && (lang === 'en' ? 'Login' : '')}
              </button>
            </div>
          </header>

          {/* Hero - Split Layout with Centered Watermark Logo */}
          <section style={{
            minHeight: '100vh',
            display: 'flex',
            alignItems: 'center',
            padding: isMobile ? '80px 20px 40px' : '120px 60px 80px',
            background: '#f8fafc',
            position: 'relative',
            overflow: 'hidden'
          }}>

            {/* Centered Watermark Logo - Single Logo Only */}
            <div style={{
              position: 'absolute',
              top: '50%',
              left: '50%',
              transform: 'translate(-50%, -50%)',
              zIndex: 0,
              pointerEvents: 'none',
              opacity: isMobile ? 0.08 : 0.12
            }}>
              <div style={{
                background: 'rgba(255, 255, 255, 0.97)',
                borderRadius: isMobile ? '32px' : '56px',
                padding: isMobile ? '24px' : '48px',
                boxShadow: '0 8px 32px rgba(0, 0, 0, 0.06)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center'
              }}>
                <img src="assets/logo-sh.png" alt="" style={{ width: isMobile ? '140px' : '320px', height: 'auto' }} />
              </div>
            </div>

            {/* MOBILE LAYOUT */}
            {isMobile ? (
              <div style={{ width: '100%', position: 'relative', zIndex: 1, textAlign: 'center' }}>
                {/* Mobile Title - Large & Centered */}
                <div style={{ marginBottom: '16px' }}>
                  {lang === 'en' ? (
                    <>
                      <div className="gradient-text-line1" style={{
                        fontSize: '40px',
                        fontWeight: 800,
                        lineHeight: 1.1,
                        fontFamily: "'Lora', serif",
                        marginBottom: '6px'
                      }}>Excellence in</div>
                      <div className="gradient-text-line2" style={{
                        fontSize: '32px',
                        fontWeight: 800,
                        lineHeight: 1.2,
                        fontFamily: "'Lora', serif"
                      }}>Accreditation Preparation</div>
                    </>
                  ) : (
                    <>
                      <div className="gradient-text-line1" style={{
                        fontSize: '42px',
                        fontWeight: 800,
                        lineHeight: 1.2,
                        fontFamily: "'Noto Naskh Arabic', serif",
                        marginBottom: '8px'
                      }}></div>
                      <div className="gradient-text-line2-ar" style={{
                        fontSize: '32px',
                        fontWeight: 800,
                        lineHeight: 1.2,
                        fontFamily: "'Noto Naskh Arabic', serif"
                      }}>  </div>
                    </>
                  )}
                </div>

                {/* Mobile Subtitle */}
                <p style={{
                  fontSize: '14px',
                  color: '#64748b',
                  marginBottom: '32px',
                  fontFamily: isRtl ? "'Noto Naskh Arabic', serif" : "'Lora', serif",
                  lineHeight: 1.6
                }}>
                  {t.hero.subtitleLine1}
                </p>

                {/* Stacked Cards - Centered, 70% width */}
                <div style={{
                  position: 'relative',
                  width: '70%',
                  height: '80px',
                  margin: '0 auto',
                  marginBottom: '32px'
                }}>
                  {/* Card 5 - Far Back - Not Met */}
                  <div style={{
                    position: 'absolute',
                    top: '28px',
                    left: '50%',
                    transform: 'translateX(-50%) rotate(4deg)',
                    width: '92%',
                    background: 'rgba(255, 255, 255, 0.5)',
                    backdropFilter: 'blur(4px)',
                    borderRadius: '8px',
                    padding: '6px 10px',
                    boxShadow: '0 1px 3px rgba(30,58,95,0.05)',
                    border: '1px solid rgba(255, 255, 255, 0.4)',
                    zIndex: 1
                  }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                      <div style={{ width: '4px', height: '4px', borderRadius: '50%', background: '#e74c3c' }} />
                      <span style={{ fontWeight: 600, color: '#94a3b8', fontSize: '7px', fontFamily: "'Lora', serif" }}>QM.3.1</span>
                      <span style={{ fontSize: '5px', color: '#e74c3c', fontWeight: 600, background: '#fee2e2', padding: '1px 3px', borderRadius: '2px', marginLeft: 'auto' }}>{lang === 'en' ? 'Not Met' : ' '}</span>
                    </div>
                  </div>

                  {/* Card 4 - Back - Fully Met */}
                  <div style={{
                    position: 'absolute',
                    top: '21px',
                    left: '50%',
                    transform: 'translateX(-50%) rotate(-3deg)',
                    width: '92%',
                    background: 'rgba(255, 255, 255, 0.6)',
                    backdropFilter: 'blur(6px)',
                    borderRadius: '8px',
                    padding: '6px 10px',
                    boxShadow: '0 1px 4px rgba(30,58,95,0.06)',
                    border: '1px solid rgba(255, 255, 255, 0.5)',
                    zIndex: 2
                  }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                      <div style={{ width: '4px', height: '4px', borderRadius: '50%', background: '#27ae60' }} />
                      <span style={{ fontWeight: 600, color: '#64748b', fontSize: '7px', fontFamily: "'Lora', serif" }}>LD.5.2</span>
                      <span style={{ fontSize: '5px', color: '#27ae60', fontWeight: 600, background: '#dcfce7', padding: '1px 3px', borderRadius: '2px', marginLeft: 'auto' }}>{lang === 'en' ? 'Met' : ''}</span>
                    </div>
                  </div>

                  {/* Card 3 - Middle - In Progress */}
                  <div style={{
                    position: 'absolute',
                    top: '14px',
                    left: '50%',
                    transform: 'translateX(-50%) rotate(2deg)',
                    width: '92%',
                    background: 'rgba(255, 255, 255, 0.72)',
                    backdropFilter: 'blur(8px)',
                    borderRadius: '8px',
                    padding: '6px 10px',
                    boxShadow: '0 2px 6px rgba(30,58,95,0.08)',
                    border: '1px solid rgba(255, 255, 255, 0.6)',
                    zIndex: 3
                  }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                      <div style={{ width: '4px', height: '4px', borderRadius: '50%', background: '#3498db' }} />
                      <span style={{ fontWeight: 600, color: '#475569', fontSize: '7px', fontFamily: "'Lora', serif" }}>FMS.2.1</span>
                      <span style={{ fontSize: '5px', color: '#3498db', fontWeight: 600, background: '#e0f2fe', padding: '1px 3px', borderRadius: '2px', marginLeft: 'auto' }}>{lang === 'en' ? 'Progress' : ' '}</span>
                    </div>
                  </div>

                  {/* Card 2 - Second Front - Met */}
                  <div style={{
                    position: 'absolute',
                    top: '7px',
                    left: '50%',
                    transform: 'translateX(-50%) rotate(-1deg)',
                    width: '92%',
                    background: 'rgba(255, 255, 255, 0.85)',
                    backdropFilter: 'blur(10px)',
                    borderRadius: '8px',
                    padding: '6px 10px',
                    boxShadow: '0 2px 8px rgba(30,58,95,0.1)',
                    border: '1px solid rgba(255, 255, 255, 0.7)',
                    zIndex: 4
                  }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                      <div style={{ width: '4px', height: '4px', borderRadius: '50%', background: '#27ae60' }} />
                      <span style={{ fontWeight: 600, color: '#334155', fontSize: '7px', fontFamily: "'Lora', serif" }}>ACC.4.2</span>
                      <span style={{ fontSize: '5px', color: '#27ae60', fontWeight: 600, background: '#dcfce7', padding: '1px 3px', borderRadius: '2px', marginLeft: 'auto' }}>{lang === 'en' ? 'Met' : ''}</span>
                    </div>
                  </div>

                  {/* Card 1 - Front with Typing Cursor */}
                  <div style={{
                    position: 'absolute',
                    top: '0',
                    left: '50%',
                    transform: 'translateX(-50%)',
                    width: '92%',
                    background: 'rgba(255, 255, 255, 0.95)',
                    backdropFilter: 'blur(12px)',
                    borderRadius: '8px',
                    padding: '8px 10px',
                    boxShadow: '0 4px 14px rgba(30,58,95,0.12)',
                    border: '1px solid rgba(255, 255, 255, 0.8)',
                    zIndex: 5
                  }}>
                    <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '4px' }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                        <div style={{ width: '12px', height: '12px', background: '#fff3e0', borderRadius: '3px', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                          <div style={{ width: '4px', height: '4px', background: '#f39c12', borderRadius: '50%' }} />
                        </div>
                        <span style={{ fontWeight: 700, color: '#1e3a5f', fontSize: '8px', fontFamily: "'Lora', serif" }}>IPC.8.3</span>
                      </div>
                      <span style={{ fontSize: '5px', color: '#f39c12', fontWeight: 600, background: '#fff3e0', padding: '1px 3px', borderRadius: '2px' }}>{lang === 'en' ? 'Partial' : ''}</span>
                    </div>
                    <div style={{ background: '#f8fafc', borderRadius: '3px', padding: '3px 5px', border: '1px solid #f1f5f9' }}>
                      <TypingText text={lang === 'en' ? 'Adding recommendation...' : ' ...'} />
                    </div>
                  </div>
                </div>

                {/* CTA Button - Centered */}
                <div style={{ display: 'flex', justifyContent: 'center', marginBottom: '32px' }}>
                  <button
                    onClick={() => setShowContactModal(true)}
                    style={{
                      padding: '14px 32px',
                      fontSize: '15px',
                      fontWeight: 700,
                      background: 'linear-gradient(145deg, rgba(255,255,255,0.95) 0%, rgba(240,245,250,0.8) 100%)',
                      backdropFilter: 'blur(20px)',
                      color: '#1e3a5f',
                      border: '1px solid rgba(255, 255, 255, 0.8)',
                      borderRadius: '50px',
                      cursor: 'pointer',
                      display: 'inline-flex',
                      alignItems: 'center',
                      gap: '10px',
                      boxShadow: '0 12px 40px -10px rgba(31, 38, 135, 0.2), inset 0 2px 0 rgba(255,255,255,0.8)',
                      fontFamily: isRtl ? "'Noto Naskh Arabic', serif" : "'Lora', serif",
                      position: 'relative',
                      overflow: 'hidden',
                      letterSpacing: '0.02em'
                    }}
                  >
                    {/* Premium Noise Texture Overlay */}
                    <div style={{
                      position: 'absolute',
                      top: 0, left: 0, right: 0, bottom: 0,
                      backgroundImage: `url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.08'/%3E%3C/svg%3E")`,
                      zIndex: 0,
                      opacity: 0.4,
                      mixBlendMode: 'overlay'
                    }} />
                    {/* Inner Sheen */}
                    <div style={{
                      position: 'absolute',
                      top: 0, left: 0, right: 0, height: '50%',
                      background: 'linear-gradient(to bottom, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 100%)',
                      zIndex: 1,
                      opacity: 0.6,
                      borderRadius: '50px 50px 0 0'
                    }} />
                    {/* Text */}
                    <span style={{ position: 'relative', zIndex: 2 }}>{t.hero.cta}</span>
                    {/* Gold Star Icon - Same as Desktop */}
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={{ color: '#f39c12', zIndex: 2, filter: 'drop-shadow(0 2px 3px rgba(243, 156, 18, 0.3))' }}><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
                  </button>
                </div>

                {/* Mobile 4-Services - Minimalistic like Desktop */}
                <div style={{ display: 'flex', flexWrap: 'wrap', justifyContent: 'center', gap: '0', padding: '0 8px', direction: isRtl ? 'rtl' : 'ltr', marginTop: '8px' }}>
                  {[
                    { num: '1', title: lang === 'en' ? 'Gap Assessment' : ' ', desc: lang === 'en' ? 'Status analysis' : ' ' },
                    { num: '2', title: lang === 'en' ? 'Action Planning' : ' ', desc: lang === 'en' ? 'Clear roadmap' : ' ' },
                    { num: '3', title: lang === 'en' ? 'Team Prep' : ' ', desc: lang === 'en' ? 'Staff training' : ' ' },
                    { num: '4', title: lang === 'en' ? 'Survey Success' : ' ', desc: lang === 'en' ? 'Full support' : ' ' }
                  ].map((item, i, arr) => (
                    <div key={i} style={{
                      padding: '12px 16px',
                      textAlign: 'center',
                      borderRight: i < arr.length - 1 && i !== 1 ? '1px solid rgba(30, 58, 95, 0.1)' : 'none',
                      borderBottom: i < 2 ? '1px solid rgba(30, 58, 95, 0.1)' : 'none',
                      width: '50%',
                      boxSizing: 'border-box'
                    }}>
                      {/* Glassy Number */}
                      <div style={{
                        width: '32px',
                        height: '32px',
                        background: 'linear-gradient(135deg, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0.2) 100%)',
                        backdropFilter: 'blur(4px)',
                        borderRadius: '50%',
                        color: '#1e3a5f',
                        fontWeight: 700,
                        fontSize: '13px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        margin: '0 auto 8px auto',
                        fontFamily: "'Lora', serif",
                        border: '1px solid rgba(255,255,255,0.9)',
                        boxShadow: '0 4px 6px rgba(0,0,0,0.05)'
                      }}>
                        {item.num}
                      </div>
                      <div style={{
                        fontWeight: 700,
                        color: '#1e3a5f',
                        fontSize: '11px',
                        fontFamily: "'Lora', serif",
                        lineHeight: 1.3,
                        marginBottom: '4px'
                      }}>
                        {item.title}
                      </div>
                      <div style={{
                        fontSize: '9px',
                        color: '#64748b',
                        fontFamily: "'Lora', serif",
                        lineHeight: 1.3
                      }}>
                        {item.desc}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            ) : (
              /* DESKTOP LAYOUT */
              <div style={{ maxWidth: '1600px', margin: '0 auto', display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '160px', alignItems: 'center', width: '100%', position: 'relative', zIndex: 1 }}>

              {/* Text Content - appears on left in LTR, automatically on right in RTL */}
              <div style={{ padding: 0 }}>
                {/* Title - same dimensions for both languages */}
                <h1 style={{
                  fontSize: '62px',
                  fontWeight: 800,
                  marginBottom: '32px',
                  lineHeight: 1.2,
                  color: '#1e3a5f',
                  fontFamily: isRtl ? "'Noto Naskh Arabic', serif" : "'Lora', serif"
                }}>
                  {lang === 'en' ? (
                    <>
                      <span className="gradient-text-line1">Excellence in</span>
                      <span className="gradient-text-line2">Accreditation Preparation</span>
                    </>
                  ) : (
                    <>
                      <span className="gradient-text-line1"></span>
                      <span className="gradient-text-line2">  </span>
                    </>
                  )}
                </h1>

                {/* Subtitle - same styling for both languages */}
                <div style={{ marginBottom: '56px', lineHeight: 1.9 }}>
                  <p style={{
                    fontSize: '18px',
                    color: '#64748b',
                    margin: 0,
                    fontFamily: isRtl ? "'Noto Naskh Arabic', serif" : "'Lora', serif"
                  }}>{t.hero.subtitleLine1}</p>
                  <p style={{
                    fontSize: '18px',
                    color: '#64748b',
                    margin: 0,
                    fontFamily: isRtl ? "'Noto Naskh Arabic', serif" : "'Lora', serif"
                  }}>{t.hero.subtitleLine2}</p>
                </div>

                {/* CTA Button - Premium Texture (Noise) & Glassy */}
                <button
                  onClick={() => setShowContactModal(true)}
                  style={{
                    padding: '20px 52px',
                    fontSize: '18px',
                    fontWeight: 700,
                    // Premium Sheen/Texture Gradient
                    background: 'linear-gradient(145deg, rgba(255,255,255,0.95) 0%, rgba(240,245,250,0.8) 100%)',
                    backdropFilter: 'blur(20px)',
                    color: '#1e3a5f',
                    border: '1px solid rgba(255, 255, 255, 0.8)',
                    borderRadius: '50px',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '16px',
                    transition: 'all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)', // Springy effect
                    boxShadow: '0 12px 40px -10px rgba(31, 38, 135, 0.2), inset 0 2px 0 rgba(255,255,255,0.8)',
                    fontFamily: isRtl ? "'Noto Naskh Arabic', serif" : "'Lora', serif",
                    marginBottom: '90px',
                    position: 'relative',
                    overflow: 'hidden',
                    letterSpacing: '0.02em'
                  }}
                  onMouseOver={e => {
                    e.currentTarget.style.transform = 'translateY(-3px) scale(1.02)';
                    e.currentTarget.style.boxShadow = '0 20px 50px -10px rgba(31, 38, 135, 0.3), inset 0 2px 0 rgba(255,255,255,0.9)';
                  }}
                  onMouseOut={e => {
                    e.currentTarget.style.transform = 'translateY(0) scale(1)';
                    e.currentTarget.style.boxShadow = '0 12px 40px -10px rgba(31, 38, 135, 0.2), inset 0 2px 0 rgba(255,255,255,0.8)';
                  }}
                >
                  <span style={{ position: 'relative', zIndex: 2 }}>{t.hero.cta}</span>

                  {/* Premium Noise Texture Overlay */}
                  <div style={{
                    position: 'absolute',
                    top: 0, left: 0, right: 0, bottom: 0,
                    backgroundImage: `url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.08'/%3E%3C/svg%3E")`,
                    zIndex: 0,
                    opacity: 0.4,
                    mixBlendMode: 'overlay'
                  }} />

                  {/* Inner Sheen */}
                  <div style={{
                    position: 'absolute',
                    top: 0, left: 0, right: 0, height: '50%',
                    background: 'linear-gradient(to bottom, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 100%)',
                    zIndex: 1,
                    opacity: 0.6,
                    borderRadius: '50px 50px 0 0'
                  }} />

                  {/* Modern Sparkle Icon */}
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={{ color: '#f39c12', zIndex: 2, filter: 'drop-shadow(0 2px 3px rgba(243, 156, 18, 0.3))' }}><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
                </button>

                {/* 4 Services - Glassy & Minimal - RTL aware */}
                <div style={{ display: 'flex', alignItems: 'flex-start', direction: isRtl ? 'rtl' : 'ltr' }}>
                  {[
                    { num: '1', title: lang === 'en' ? 'Gap Assessment' : ' ', desc: isRtl ? '   ' : 'Comprehensive status analysis' },
                    { num: '2', title: lang === 'en' ? 'Action Planning' : ' ', desc: isRtl ? '   ' : 'Clear roadmap for improvement' },
                    { num: '3', title: lang === 'en' ? 'Team Preparation' : ' ', desc: isRtl ? '  ' : 'Staff training and guidance' },
                    { num: '4', title: lang === 'en' ? 'Survey Success' : ' ', desc: isRtl ? '   ' : 'Full support during survey' }
                  ].map((item, i, arr) => (
                    <div key={i} style={{ display: 'flex', alignItems: 'flex-start' }}>
                      <div style={{ padding: '0 24px', textAlign: 'center', borderRight: (i !== arr.length - 1) ? '1px solid rgba(30, 58, 95, 0.1)' : 'none' }}>
                        {/* Glassy Number */}
                        <div style={{
                          width: '40px',
                          height: '40px',
                          background: 'linear-gradient(135deg, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0.2) 100%)',
                          backdropFilter: 'blur(4px)',
                          borderRadius: '50%',
                          color: '#1e3a5f',
                          fontWeight: 700,
                          fontSize: '16px',
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          margin: '0 auto 12px auto',
                          fontFamily: "'Lora', serif",
                          border: '1px solid rgba(255,255,255,0.9)',
                          boxShadow: '0 4px 6px rgba(0,0,0,0.05)'
                        }}>
                          {item.num}
                        </div>
                        <div style={{
                          fontWeight: 700,
                          color: '#1e3a5f',
                          fontSize: '14px',
                          fontFamily: isRtl ? "'Noto Naskh Arabic', serif" : "'Lora', serif",
                          lineHeight: 1.3,
                          marginBottom: '6px'
                        }}>
                          {item.title}
                        </div>
                        <div style={{
                          fontSize: '11px',
                          color: '#64748b',
                          fontFamily: isRtl ? "'Noto Naskh Arabic', serif" : "'Lora', serif",
                          maxWidth: '120px',
                          margin: '0 auto',
                          lineHeight: 1.4
                        }}>
                          {item.desc}
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              {/* INTEGRATED HERO CAROUSEL - Floating Cards, Why Choose Us, Celebrating Success */}
              <div
                style={{
                  position: 'relative',
                  height: '600px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  overflow: 'hidden'
                }}
                onMouseEnter={() => setHeroPaused(true)}
                onMouseLeave={() => setHeroPaused(false)}
              >

                {/* SLIDE 1: Floating Assessment Cards - Balanced Size */}
                <div style={{
                  position: 'absolute',
                  width: '100%',
                  height: '100%',
                  transition: 'all 0.8s cubic-bezier(0.4, 0, 0.2, 1)',
                  transform: `translateY(${(0 - heroSlide) * 100}%)`,
                  opacity: heroSlide === 0 ? 1 : 0
                }}>
                  <div style={{ position: 'relative', width: '100%', height: '100%' }}>
                    {/* Document 1 - Top */}
                    <div style={{ position: 'absolute', top: '2%', left: isRtl ? 'auto' : '3%', right: isRtl ? '3%' : 'auto', width: '260px', background: 'rgba(255, 255, 255, 0.92)', backdropFilter: 'blur(10px)', borderRadius: '16px', padding: '20px', boxShadow: '0 10px 30px rgba(31, 38, 135, 0.12)', border: '1px solid rgba(255, 255, 255, 0.6)', transform: 'rotate(-4deg)', direction: 'ltr' }}>
                      <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '14px' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                          <div style={{ width: '12px', height: '12px', borderRadius: '50%', background: '#27ae60' }} />
                          <span style={{ fontWeight: 700, color: '#1e3a5f', fontSize: '16px', fontFamily: "'Lora', serif" }}>LD.5.2</span>
                        </div>
                        <span style={{ fontSize: '12px', color: '#27ae60', fontWeight: 600, background: '#dcfce7', padding: '5px 12px', borderRadius: '8px' }}>Fully Met</span>
                      </div>
                      <div style={{ height: '5px', background: '#e2e8f0', borderRadius: '3px', marginBottom: '8px' }} />
                      <div style={{ height: '5px', background: '#e2e8f0', borderRadius: '3px', width: '65%' }} />
                    </div>

                    {/* Document 2 - Upper Right */}
                    <div style={{ position: 'absolute', top: '18%', right: isRtl ? 'auto' : '2%', left: isRtl ? '2%' : 'auto', width: '260px', background: 'rgba(255, 255, 255, 0.92)', backdropFilter: 'blur(10px)', borderRadius: '16px', padding: '20px', boxShadow: '0 12px 36px rgba(0,0,0,0.1)', border: '1px solid rgba(226,232,240,0.7)', transform: 'rotate(5deg)', direction: 'ltr' }}>
                      <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '14px' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                          <div style={{ width: '12px', height: '12px', borderRadius: '50%', background: '#3498db' }} />
                          <span style={{ fontWeight: 700, color: '#1e3a5f', fontSize: '16px', fontFamily: "'Lora', serif" }}>FMS.2.1</span>
                        </div>
                        <span style={{ fontSize: '12px', color: '#3498db', fontWeight: 600, background: '#e0f2fe', padding: '5px 12px', borderRadius: '8px' }}>In Progress</span>
                      </div>
                      <div style={{ height: '5px', background: '#e2e8f0', borderRadius: '3px', marginBottom: '8px' }} />
                      <div style={{ height: '5px', background: '#e2e8f0', borderRadius: '3px', width: '80%' }} />
                    </div>

                    {/* Document 3 - Center Featured */}
                    <div style={{ position: 'absolute', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', width: '300px', background: 'rgba(255, 255, 255, 0.95)', backdropFilter: 'blur(14px)', borderRadius: '20px', padding: '26px', boxShadow: '0 20px 50px rgba(30,58,95,0.18)', border: '1px solid rgba(255, 255, 255, 0.8)', zIndex: 10, direction: 'ltr' }}>
                      <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '18px' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '14px' }}>
                          <div style={{ width: '48px', height: '48px', background: '#fff3e0', borderRadius: '12px', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                            <div style={{ width: '22px', height: '22px', background: '#f39c12', borderRadius: '50%' }} />
                          </div>
                          <div style={{ fontWeight: 700, color: '#1e3a5f', fontSize: '20px', fontFamily: "'Lora', serif" }}>IPC.8.3</div>
                        </div>
                        <span style={{ fontSize: '13px', color: '#f39c12', fontWeight: 600, background: '#fff3e0', padding: '6px 14px', borderRadius: '8px' }}>Partial</span>
                      </div>
                      <div style={{ background: '#f8fafc', borderRadius: '12px', padding: '16px', border: '1px solid #e2e8f0' }}>
                        <TypingText text={lang === 'en' ? 'Adding recommendation...' : ' ...'} />
                      </div>
                    </div>

                    {/* Document 4 - Lower Left */}
                    <div style={{ position: 'absolute', bottom: '18%', left: isRtl ? 'auto' : '4%', right: isRtl ? '4%' : 'auto', width: '260px', background: 'rgba(255, 255, 255, 0.92)', backdropFilter: 'blur(10px)', borderRadius: '16px', padding: '20px', boxShadow: '0 10px 30px rgba(31, 38, 135, 0.12)', border: '1px solid rgba(255, 255, 255, 0.6)', transform: 'rotate(-5deg)', direction: 'ltr' }}>
                      <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '14px' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                          <div style={{ width: '12px', height: '12px', borderRadius: '50%', background: '#e74c3c' }} />
                          <span style={{ fontWeight: 700, color: '#1e3a5f', fontSize: '16px', fontFamily: "'Lora', serif" }}>PC.11.4</span>
                        </div>
                        <span style={{ fontSize: '12px', color: '#e74c3c', fontWeight: 600, background: '#fee2e2', padding: '5px 12px', borderRadius: '8px' }}>Not Met</span>
                      </div>
                      <div style={{ height: '5px', background: '#e2e8f0', borderRadius: '3px', marginBottom: '8px' }} />
                      <div style={{ height: '5px', background: '#e2e8f0', borderRadius: '3px', width: '45%' }} />
                    </div>

                    {/* Document 5 - Bottom - More subtle floating */}
                    <div style={{ position: 'absolute', bottom: '8%', right: isRtl ? 'auto' : '5%', left: isRtl ? '5%' : 'auto', width: '220px', background: 'rgba(255, 255, 255, 0.85)', backdropFilter: 'blur(8px)', borderRadius: '14px', padding: '18px', boxShadow: '0 8px 24px rgba(31, 38, 135, 0.08)', border: 'none', transform: 'rotate(3deg)', direction: 'ltr' }}>
                      <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '12px' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                          <div style={{ width: '10px', height: '10px', borderRadius: '50%', background: '#27ae60' }} />
                          <span style={{ fontWeight: 700, color: '#1e3a5f', fontSize: '14px', fontFamily: "'Lora', serif" }}>MOI.3.2</span>
                        </div>
                        <span style={{ fontSize: '11px', color: '#27ae60', fontWeight: 600, background: '#dcfce7', padding: '4px 10px', borderRadius: '6px' }}>Fully Met</span>
                      </div>
                      <div style={{ height: '4px', background: '#e2e8f0', borderRadius: '2px', width: '90%' }} />
                    </div>
                  </div>
                </div>

                {/* SLIDE 2: Why Choose Us - Large & Full */}
                <div style={{
                  position: 'absolute',
                  width: '100%',
                  height: '100%',
                  transition: 'all 0.8s cubic-bezier(0.4, 0, 0.2, 1)',
                  transform: `translateY(${(1 - heroSlide) * 100}%)`,
                  opacity: heroSlide === 1 ? 1 : 0,
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  justifyContent: 'center',
                  padding: '10px'
                }}>
                  <div style={{ textAlign: 'center', marginBottom: '32px' }}>
                    <h3 style={{ fontSize: '36px', fontWeight: 800, color: '#1e3a5f', marginBottom: '12px', fontFamily: isRtl ? "'Noto Naskh Arabic', serif" : "'Lora', serif" }}>
                      {lang === 'en' ? 'Why Choose Us?' : ' '}
                    </h3>
                    <p style={{ fontSize: '18px', color: '#64748b', fontFamily: isRtl ? "'Noto Naskh Arabic', serif" : "'Lora', serif" }}>
                      {lang === 'en' ? 'Four pillars of accreditation excellence' : '    '}
                    </p>
                  </div>
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '20px', maxWidth: '520px', width: '100%', direction: 'ltr' }}>
                    {[
                      { title: lang === 'en' ? 'Excellence First' : ' ', color: '#6366f1', icon: <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg> },
                      { title: lang === 'en' ? 'Staff Empowerment' : ' ', color: '#ec4899', icon: <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg> },
                      { title: lang === 'en' ? 'Quality Journey' : ' ', color: '#14b8a6', icon: <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg> },
                      { title: lang === 'en' ? 'Patient Safety' : ' ', color: '#8b5cf6', icon: <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg> }
                    ].map((item, i) => (
                      <div key={i} style={{
                        background: 'rgba(255,255,255,0.97)',
                        padding: '28px 24px',
                        borderRadius: '20px',
                        boxShadow: '0 8px 28px rgba(0,0,0,0.08)',
                        textAlign: 'center',
                        border: '1px solid rgba(255,255,255,0.9)'
                      }}>
                        <div style={{ width: '72px', height: '72px', background: `${item.color}15`, borderRadius: '18px', display: 'flex', alignItems: 'center', justifyContent: 'center', color: item.color, margin: '0 auto 16px' }}>
                          {item.icon}
                        </div>
                        <div style={{ fontSize: '18px', fontWeight: 700, color: '#1e3a5f', fontFamily: isRtl ? "'Noto Naskh Arabic', serif" : "'Lora', serif" }}>{item.title}</div>
                      </div>
                    ))}
                  </div>
                </div>

                {/* SLIDE 3: Celebrating Success - Large & Full */}
                <div style={{
                  position: 'absolute',
                  width: '100%',
                  height: '100%',
                  transition: 'all 0.8s cubic-bezier(0.4, 0, 0.2, 1)',
                  transform: `translateY(${(2 - heroSlide) * 100}%)`,
                  opacity: heroSlide === 2 ? 1 : 0,
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  justifyContent: 'center',
                  padding: '10px'
                }}>
                  <div style={{ textAlign: 'center', marginBottom: '36px' }}>
                    <h3 style={{ fontSize: '36px', fontWeight: 800, color: '#1e3a5f', marginBottom: '12px', fontFamily: isRtl ? "'Noto Naskh Arabic', serif" : "'Lora', serif" }}>
                      {lang === 'en' ? 'Celebrating Success' : ' '}
                    </h3>
                    <p style={{ fontSize: '18px', color: '#64748b', fontFamily: isRtl ? "'Noto Naskh Arabic', serif" : "'Lora', serif" }}>
                      {lang === 'en' ? 'Join centers achieving accreditation excellence' : '      '}
                    </p>
                  </div>

                  {/* Stats Row */}
                  <div style={{ display: 'flex', gap: '28px', marginBottom: '32px', direction: 'ltr' }}>
                    <div style={{ background: 'rgba(255,255,255,0.97)', padding: '36px 48px', borderRadius: '24px', textAlign: 'center', boxShadow: '0 12px 36px rgba(39,174,96,0.18)', border: '1px solid rgba(39,174,96,0.15)' }}>
                      <div style={{ fontSize: '56px', fontWeight: 800, color: '#27ae60', lineHeight: 1, fontFamily: "'Lora', serif" }}>50+</div>
                      <div style={{ fontSize: '16px', color: '#64748b', marginTop: '8px', fontWeight: 500, fontFamily: isRtl ? "'Noto Naskh Arabic', serif" : "'Lora', serif" }}>{lang === 'en' ? 'Centers Served' : ''}</div>
                    </div>
                    <div style={{ background: 'rgba(255,255,255,0.97)', padding: '36px 48px', borderRadius: '24px', textAlign: 'center', boxShadow: '0 12px 36px rgba(52,152,219,0.18)', border: '1px solid rgba(52,152,219,0.15)' }}>
                      <div style={{ fontSize: '56px', fontWeight: 800, color: '#3498db', lineHeight: 1, fontFamily: "'Lora', serif" }}>97%</div>
                      <div style={{ fontSize: '16px', color: '#64748b', marginTop: '8px', fontWeight: 500, fontFamily: isRtl ? "'Noto Naskh Arabic', serif" : "'Lora', serif" }}>{lang === 'en' ? 'Success Rate' : ' '}</div>
                    </div>
                  </div>

                  {/* Trophy Card */}
                  <div style={{
                    background: 'linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)',
                    borderRadius: '24px',
                    padding: '32px 48px',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '24px',
                    boxShadow: '0 16px 48px rgba(39, 174, 96, 0.25)'
                  }}>
                    <div style={{ width: '80px', height: '80px', background: 'rgba(255,255,255,0.7)', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                      <svg width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="#27ae60" strokeWidth="1.5">
                        <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/>
                      </svg>
                    </div>
                    <div>
                      <div style={{ fontSize: '22px', fontWeight: 800, color: '#27ae60', fontFamily: isRtl ? "'Noto Naskh Arabic', serif" : "'Lora', serif" }}>{lang === 'en' ? 'Accreditation Achieved!' : '  !'}</div>
                      <div style={{ fontSize: '16px', color: '#2e7d32', marginTop: '4px', fontFamily: isRtl ? "'Noto Naskh Arabic', serif" : "'Lora', serif" }}>{lang === 'en' ? 'Your team deserves this' : '  '}</div>
                    </div>
                  </div>
                </div>

                {/* Vertical Navigation Dots */}
                <div style={{
                  position: 'absolute',
                  right: isRtl ? 'auto' : '-30px',
                  left: isRtl ? '-30px' : 'auto',
                  top: '50%',
                  transform: 'translateY(-50%)',
                  display: 'flex',
                  flexDirection: 'column',
                  gap: '10px',
                  background: 'rgba(255,255,255,0.8)',
                  backdropFilter: 'blur(8px)',
                  padding: '10px 6px',
                  borderRadius: '20px',
                  boxShadow: '0 4px 16px rgba(0,0,0,0.06)'
                }}>
                  {[0, 1, 2].map(i => (
                    <button
                      key={i}
                      onClick={() => setHeroSlide(i)}
                      style={{
                        width: '10px',
                        height: heroSlide === i ? '28px' : '10px',
                        borderRadius: heroSlide === i ? '5px' : '50%',
                        background: heroSlide === i ? 'linear-gradient(180deg, #1e3a5f 0%, #2c5282 100%)' : '#e2e8f0',
                        border: 'none',
                        cursor: 'pointer',
                        transition: 'all 0.3s ease',
                        boxShadow: heroSlide === i ? '0 4px 12px rgba(30, 58, 95, 0.3)' : 'none'
                      }}
                    />
                  ))}
                </div>

              </div>
            </div>
            )}
          </section>

          {/* Footer - Thin & Distributed */}
          <footer style={{
            padding: isMobile ? '12px 20px' : '14px 48px',
            background: '#1e3a5f',
            display: 'flex',
            flexDirection: isMobile ? 'column' : 'row',
            alignItems: 'center',
            justifyContent: 'space-between',
            gap: isMobile ? '10px' : '0'
          }}>
            {/* Left - Brand with Logo */}
            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
              <img src="assets/logo-sh.png" alt="SH" style={{ height: '24px', width: 'auto', borderRadius: '4px' }} />
              <span style={{ fontWeight: 600, fontSize: '14px', color: 'white', fontFamily: "'Lora', serif" }}>StandardsHub</span>
            </div>

            {/* Center - Website Link Capsule */}
            <a href="https://www.st-hubs.com" target="_blank" rel="noopener noreferrer" style={{
              color: 'rgba(255,255,255,0.85)',
              fontSize: '12px',
              textDecoration: 'none',
              padding: '6px 16px',
              background: 'linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.04) 100%)',
              borderRadius: '16px',
              border: '1px solid rgba(255,255,255,0.08)',
              fontWeight: 500
            }}>www.st-hubs.com</a>

            {/* Right - Copyright */}
            <span style={{ color: 'rgba(255,255,255,0.4)', fontSize: '11px' }}>{lang === 'en' ? ' 2026 All rights reserved' : ' 2026   '}</span>
          </footer>

        </div>
      );
    };

    // Shared Assessment Viewer - For external center access (Password only - no username)
    const SharedAssessmentViewer = ({ shareId, onExit }) => {
      const [isAuthenticated, setIsAuthenticated] = useState(false);
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [survey, setSurvey] = useState(null);
      const [shareData, setShareData] = useState(null);
      const [showFullDetails, setShowFullDetails] = useState(false);
      const [activityFilter, setActivityFilter] = useState('all'); // Filter by survey activity type
      const [scoreFilter, setScoreFilter] = useState('all'); // Filter by score (findings, full, etc.)
      const [isMobile, setIsMobile] = useState(window.innerWidth <= 768);
      const [centerName, setCenterName] = useState('');

      // Mobile detection
      useEffect(() => {
        const checkMobile = () => setIsMobile(window.innerWidth <= 768);
        window.addEventListener('resize', checkMobile);
        return () => window.removeEventListener('resize', checkMobile);
      }, []);

      // Load center name on mount
      useEffect(() => {
        const shares = JSON.parse(localStorage.getItem('cbahi_shared_assessments') || '[]');
        const share = shares.find(s => s.shareId === shareId);
        if (share) {
          setCenterName(share.centerName || 'Your Center');
        }
      }, [shareId]);

      // Get the active chapters based on configuration
      const getChaptersByConfig = (config) => {
        // This should match the main app's chapter configuration
        return window.CBAHI_CHAPTERS || [];
      };

      // Validate credentials - Password only
      const handleLogin = () => {
        const shares = JSON.parse(localStorage.getItem('cbahi_shared_assessments') || '[]');
        const share = shares.find(s => s.shareId === shareId);

        if (!share) {
          setError('Invalid or expired share link');
          return;
        }

        // Password only check (case-insensitive for convenience)
        if (share.password.toUpperCase() === password.toUpperCase()) {
          // Get the survey data
          const allSurveys = JSON.parse(localStorage.getItem('cbahi_surveys') || '[]');
          const surveyData = allSurveys.find(s => s.id === share.surveyId);

          if (!surveyData) {
            setError('Assessment data not found');
            return;
          }

          setShareData(share);
          setSurvey(surveyData);
          setIsAuthenticated(true);
          setError('');
        } else {
          setError('Invalid password. Please check and try again.');
        }
      };

      // Export functions - Professional PDF and Excel exports matching main app
      const [exportMessage, setExportMessage] = useState('');

      // Get compliance level helper
      const getComplianceLevelExport = (pct) => {
        if (pct >= 90) return { label: 'Excellent', color: '27ae60' };
        if (pct >= 80) return { label: 'Good', color: '3498db' };
        if (pct >= 70) return { label: 'Satisfactory', color: 'f39c12' };
        return { label: 'Needs Improvement', color: 'e74c3c' };
      };

      // Get chapter data from survey for exports
      // FIXED: Now properly looks up sub-standard text from chapter definitions
      // and uses correct field names (findings, recommendations)
      const getChapterDataForExport = () => {
        if (!survey || !survey.scores) return [];

        const scores = survey.scores;
        const config = survey.assessmentDetails?.configuration || 'B';

        // Build a lookup map of substandard ID -> text from the chapter definitions
        // This mirrors how the main app's getChapterBreakdown() works
        const substandardTextLookup = {};
        const chaptersToUse = config === 'A1' ? chapters_A1 : config === 'A2' ? chapters_A2 : chapters_B;

        // Build lookup for both text AND activityType
        const substandardActivityLookup = {};
        chaptersToUse.forEach(chapter => {
          if (chapter.standards) {
            chapter.standards.forEach(std => {
              if (std.substandards) {
                std.substandards.forEach(sub => {
                  substandardTextLookup[sub.id] = sub.text;
                  substandardActivityLookup[sub.id] = sub.activityType || 'DOC';
                });
              }
            });
          }
        });

        // Activity type labels for display
        const activityLabels = {
          'DOC': 'Document Review',
          'OBS': 'Observation',
          'INT': 'Interview',
          'PER': 'Personnel File',
          'DEN': 'Dental Record'
        };

        const result = [];

        // Chapter metadata
        const chapterNames = {
          'LD': 'Leadership',
          'PC': 'Provision of Care',
          'DL': 'Dental Laboratory',
          'IPC': 'Infection Prevention and Control',
          'MOI': 'Management of Information',
          'FMS': 'Facility Management and Safety'
        };

        // Group scores by chapter code
        const chapterGroups = {};
        Object.entries(scores).forEach(([subId, scoreData]) => {
          if (scoreData && scoreData.value !== undefined && scoreData.value !== null && scoreData.value !== 'NA' && scoreData.value !== -1) {
            const parts = subId.split('.');
            const chapterCode = parts[0];
            if (!chapterGroups[chapterCode]) {
              chapterGroups[chapterCode] = [];
            }
            const activityCode = substandardActivityLookup[subId] || 'DOC';
            chapterGroups[chapterCode].push({
              id: subId,
              score: scoreData.value,
              // FIXED: Look up text from chapter definitions, not from scoreData
              text: substandardTextLookup[subId] || subId,
              // FIXED: Use correct field names - findings and recommendations (plural)
              findings: scoreData.findings || '',
              recommendations: scoreData.recommendations || '',
              // Survey Activity type for filtering and display
              activityType: activityCode,
              activityLabel: activityLabels[activityCode] || 'Document Review'
            });
          }
        });

        // Proper domain order for consistency across all outputs
        const domainOrder = ['LD', 'PC', 'DL', 'IPC', 'MOI', 'FMS'];

        Object.entries(chapterGroups).forEach(([code, subs]) => {
          const fullyMet = subs.filter(s => s.score === 2).length;
          const partial = subs.filter(s => s.score === 1).length;
          const notMet = subs.filter(s => s.score === 0).length;
          const scored = fullyMet + partial + notMet;
          const percentage = scored > 0 ? Math.round(((fullyMet * 2 + partial) / (scored * 2)) * 100) : 0;

          result.push({
            code,
            name: chapterNames[code] || code,
            total: subs.length,
            fullyMet,
            partial,
            notMet,
            scored,
            percentage,
            substandards: subs
          });
        });

        // Sort by proper domain order: LD, PC, DL, IPC, MOI, FMS
        return result.sort((a, b) => {
          const orderA = domainOrder.indexOf(a.code);
          const orderB = domainOrder.indexOf(b.code);
          return (orderA === -1 ? 999 : orderA) - (orderB === -1 ? 999 : orderB);
        });
      };

      // Export to Excel function - Professional formatting matching main app
      const exportToExcel = async () => {
        if (!survey) return;

        const ExcelJS = window.ExcelJS;
        if (!ExcelJS) {
          alert('Excel export library not loaded. Please refresh and try again.');
          return;
        }

        setExportMessage('Generating Excel report...');

        const details = survey.assessmentDetails || {};
        const stats = survey.stats || {};
        const chapterData = getChapterDataForExport();
        const compliance = getComplianceLevelExport(stats.percentage || 0);

        // Generate filename
        const centerName = (details.centerName || 'Assessment').replace(/[^a-zA-Z0-9]/g, '_');
        const date = new Date().toISOString().split('T')[0];
        const filename = `StandardsHub_${centerName}_${date}.xlsx`;

        // Count findings
        let totalFindings = 0;
        let highCount = 0, medCount = 0;
        chapterData.forEach(ch => {
          const findings = ch.substandards.filter(s => s.score === 0 || s.score === 1);
          totalFindings += findings.length;
          highCount += ch.substandards.filter(s => s.score === 0).length;
          medCount += ch.substandards.filter(s => s.score === 1).length;
        });

        // Score status determination
        const scoreStatus = stats.percentage >= 90 ? { text: 'Excellent', color: '155724' } :
          stats.percentage >= 80 ? { text: 'Good', color: '155724' } :
            stats.percentage >= 70 ? { text: 'Needs Improvement', color: '856404' } :
              { text: 'Critical', color: '721C24' };

        // Create workbook
        const workbook = new ExcelJS.Workbook();
        workbook.creator = 'StandardsHub';
        workbook.created = new Date();

        // Helper function to create colored bar cells
        const createBarCells = (ws, row, startCol, percentage, barColor) => {
          const totalBars = 20;
          const filledBars = Math.round(percentage / 5);
          for (let i = 0; i < totalBars; i++) {
            const cell = ws.getCell(row, startCol + i);
            if (i < filledBars) {
              cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: barColor } };
            } else {
              cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE8E8E8' } };
            }
            cell.border = {
              top: { style: 'thin', color: { argb: 'FFFFFFFF' } },
              bottom: { style: 'thin', color: { argb: 'FFFFFFFF' } },
              left: { style: 'thin', color: { argb: 'FFFFFFFF' } },
              right: { style: 'thin', color: { argb: 'FFFFFFFF' } }
            };
          }
          const labelCell = ws.getCell(row, startCol + totalBars);
          labelCell.value = `${percentage}%`;
          labelCell.font = { size: 10, bold: true };
          labelCell.alignment = { horizontal: 'left', vertical: 'middle' };
        };

        // ===================== SHEET 1: EXECUTIVE SUMMARY =====================
        const ws1 = workbook.addWorksheet('Executive Summary');
        ws1.columns = [
          { width: 32 }, { width: 22 }, { width: 12 }, { width: 18 },
          { width: 2.5 }, { width: 2.5 }, { width: 2.5 }, { width: 2.5 }, { width: 2.5 },
          { width: 2.5 }, { width: 2.5 }, { width: 2.5 }, { width: 2.5 }, { width: 2.5 },
          { width: 2.5 }, { width: 2.5 }, { width: 2.5 }, { width: 2.5 }, { width: 2.5 },
          { width: 2.5 }, { width: 2.5 }, { width: 2.5 }, { width: 2.5 }, { width: 2.5 },
          { width: 8 }
        ];

        let currentRow = 1;

        // Title
        ws1.mergeCells(`A${currentRow}:Y${currentRow}`);
        const titleCell = ws1.getCell(`A${currentRow}`);
        titleCell.value = ' StandardsHub';
        titleCell.font = { name: 'Lora', size: 26, bold: true, color: { argb: 'FF1E3A5F' } };
        titleCell.alignment = { horizontal: 'center', vertical: 'middle' };
        titleCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF8FAFC' } };
        ws1.getRow(currentRow).height = 45;
        currentRow++;

        // Subtitle
        ws1.mergeCells(`A${currentRow}:Y${currentRow}`);
        const subtitleCell = ws1.getCell(`A${currentRow}`);
        subtitleCell.value = 'Healthcare Accreditation Assessment Report';
        subtitleCell.font = { name: 'Lora', size: 13, italic: true, color: { argb: 'FF666666' } };
        subtitleCell.alignment = { horizontal: 'center', vertical: 'middle' };
        ws1.getRow(currentRow).height = 22;
        currentRow += 3;

        // Assessment Information Header
        ws1.mergeCells(`A${currentRow}:Y${currentRow}`);
        const infoHeader = ws1.getCell(`A${currentRow}`);
        infoHeader.value = ' Assessment Information';
        infoHeader.font = { name: 'Lora', size: 14, bold: true, color: { argb: 'FFFFFFFF' } };
        infoHeader.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1E3A5F' } };
        infoHeader.alignment = { horizontal: 'left', vertical: 'middle' };
        ws1.getRow(currentRow).height = 28;
        currentRow++;

        // Assessment info rows
        const infoData = [
          ['Center Name', details.centerName || '-', 'Configuration', `${survey.configuration || '-'} - Full Survey`],
          ['Coordinator', details.coordinatorName || '-', 'Assessment Date', new Date(survey.completedAt || survey.createdAt).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: '2-digit' })],
          ['Phone', details.coordinatorPhone || '-', 'Email', details.coordinatorEmail || '-']
        ];

        infoData.forEach((row) => {
          ws1.getCell(currentRow, 1).value = row[0];
          ws1.getCell(currentRow, 1).font = { name: 'Lora', size: 11, bold: true, color: { argb: 'FF1E3A5F' } };
          ws1.getCell(currentRow, 1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF0F4F8' } };
          ws1.getCell(currentRow, 1).alignment = { horizontal: 'left', vertical: 'middle' };
          ws1.getCell(currentRow, 1).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
          ws1.getCell(currentRow, 2).value = row[1];
          ws1.getCell(currentRow, 2).font = { name: 'Lora', size: 11 };
          ws1.getCell(currentRow, 2).alignment = { horizontal: 'left', vertical: 'middle' };
          ws1.getCell(currentRow, 2).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
          ws1.getCell(currentRow, 3).value = row[2];
          ws1.getCell(currentRow, 3).font = { name: 'Lora', size: 11, bold: true, color: { argb: 'FF1E3A5F' } };
          ws1.getCell(currentRow, 3).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF0F4F8' } };
          ws1.getCell(currentRow, 3).alignment = { horizontal: 'left', vertical: 'middle' };
          ws1.getCell(currentRow, 3).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
          ws1.getCell(currentRow, 4).value = row[3];
          ws1.getCell(currentRow, 4).font = { name: 'Lora', size: 11 };
          ws1.getCell(currentRow, 4).alignment = { horizontal: 'left', vertical: 'middle' };
          ws1.getCell(currentRow, 4).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
          ws1.getRow(currentRow).height = 22;
          currentRow++;
        });

        currentRow += 2;

        // Overall Compliance Score Header
        ws1.mergeCells(`A${currentRow}:Y${currentRow}`);
        const scoreHeader = ws1.getCell(`A${currentRow}`);
        scoreHeader.value = ' Overall Compliance Score';
        scoreHeader.font = { name: 'Lora', size: 14, bold: true, color: { argb: 'FFFFFFFF' } };
        scoreHeader.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1E3A5F' } };
        scoreHeader.alignment = { horizontal: 'left', vertical: 'middle' };
        ws1.getRow(currentRow).height = 28;
        currentRow++;

        // Score display
        ws1.mergeCells(currentRow, 1, currentRow, 2);
        ws1.getCell(currentRow, 1).value = `${stats.percentage || 0}%`;
        ws1.getCell(currentRow, 1).font = { name: 'Lora', size: 42, bold: true, color: { argb: 'FF1E3A5F' } };
        ws1.getCell(currentRow, 1).alignment = { horizontal: 'center', vertical: 'middle' };
        ws1.mergeCells(currentRow, 3, currentRow, 4);
        ws1.getCell(currentRow, 3).value = scoreStatus.text;
        ws1.getCell(currentRow, 3).font = { name: 'Lora', size: 20, bold: true, color: { argb: 'FF' + scoreStatus.color } };
        ws1.getCell(currentRow, 3).alignment = { horizontal: 'left', vertical: 'middle' };
        ws1.getRow(currentRow).height = 50;
        currentRow += 2;

        // Score breakdown table headers
        ws1.getCell(currentRow, 2).value = 'Status';
        ws1.getCell(currentRow, 3).value = 'Count';
        ws1.getCell(currentRow, 4).value = 'Percentage';
        ws1.mergeCells(currentRow, 5, currentRow, 25);
        ws1.getCell(currentRow, 5).value = 'Visual';

        [2, 3, 4, 5].forEach(col => {
          const cell = ws1.getCell(currentRow, col);
          cell.font = { name: 'Lora', bold: true, color: { argb: 'FFFFFFFF' } };
          cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1E3A5F' } };
          cell.alignment = { horizontal: 'center', vertical: 'middle' };
          cell.border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
        });
        ws1.getRow(currentRow).height = 22;
        currentRow++;

        // Score breakdown rows
        const fmPct = stats.scored ? Math.round((stats.fullyMet / stats.scored) * 100) : 0;
        const pmPct = stats.scored ? Math.round((stats.partial / stats.scored) * 100) : 0;
        const nmPct = stats.scored ? Math.round((stats.notMet / stats.scored) * 100) : 0;

        const scoreRowsData = [
          { status: ' Fully Met', count: stats.fullyMet || 0, pct: fmPct, color: 'FF2E7D32', bgColor: 'FFD4EDDA', barColor: 'FF2E7D32' },
          { status: ' Partially Met', count: stats.partial || 0, pct: pmPct, color: 'FFD68910', bgColor: 'FFFFF3CD', barColor: 'FFF5A623' },
          { status: ' Not Met', count: stats.notMet || 0, pct: nmPct, color: 'FFC62828', bgColor: 'FFF8D7DA', barColor: 'FFC62828' },
          { status: ' N/A', count: stats.na || 0, pct: null, color: 'FF6C757D', bgColor: 'FFE9ECEF', barColor: null }
        ];

        scoreRowsData.forEach((row) => {
          ws1.getCell(currentRow, 2).value = row.status;
          ws1.getCell(currentRow, 2).font = { name: 'Lora', size: 11, bold: true, color: { argb: row.color } };
          ws1.getCell(currentRow, 2).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: row.bgColor } };
          ws1.getCell(currentRow, 2).alignment = { horizontal: 'center', vertical: 'middle' };
          ws1.getCell(currentRow, 2).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };

          ws1.getCell(currentRow, 3).value = row.count;
          ws1.getCell(currentRow, 3).font = { name: 'Lora', size: 14, bold: true, color: { argb: row.color } };
          ws1.getCell(currentRow, 3).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: row.bgColor } };
          ws1.getCell(currentRow, 3).alignment = { horizontal: 'center', vertical: 'middle' };
          ws1.getCell(currentRow, 3).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };

          ws1.getCell(currentRow, 4).value = row.pct !== null ? `${row.pct}%` : 'Excluded';
          ws1.getCell(currentRow, 4).font = { name: 'Lora', size: 12, bold: true, color: { argb: row.color } };
          ws1.getCell(currentRow, 4).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: row.bgColor } };
          ws1.getCell(currentRow, 4).alignment = { horizontal: 'center', vertical: 'middle' };
          ws1.getCell(currentRow, 4).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };

          if (row.barColor && row.pct !== null) {
            createBarCells(ws1, currentRow, 5, row.pct, row.barColor);
          }
          ws1.getRow(currentRow).height = 24;
          currentRow++;
        });

        // Total Scored row
        ws1.getCell(currentRow, 2).value = 'TOTAL SCORED';
        ws1.getCell(currentRow, 2).font = { name: 'Lora', size: 11, bold: true, color: { argb: 'FFFFFFFF' } };
        ws1.getCell(currentRow, 2).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1E3A5F' } };
        ws1.getCell(currentRow, 2).alignment = { horizontal: 'center', vertical: 'middle' };
        ws1.getCell(currentRow, 2).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
        ws1.getCell(currentRow, 3).value = stats.scored || 0;
        ws1.getCell(currentRow, 3).font = { name: 'Lora', size: 14, bold: true, color: { argb: 'FFFFFFFF' } };
        ws1.getCell(currentRow, 3).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1E3A5F' } };
        ws1.getCell(currentRow, 3).alignment = { horizontal: 'center' };
        ws1.getCell(currentRow, 3).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
        ws1.mergeCells(currentRow, 4, currentRow, 6);
        ws1.getCell(currentRow, 4).value = `of ${stats.total || 0} sub-standards`;
        ws1.getCell(currentRow, 4).font = { color: { argb: 'FFFFFFFF' } };
        ws1.getCell(currentRow, 4).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1E3A5F' } };
        ws1.getCell(currentRow, 4).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
        ws1.getRow(currentRow).height = 22;
        currentRow += 3;

        // Domain Performance Section
        ws1.mergeCells(`A${currentRow}:Y${currentRow}`);
        const domainHeader = ws1.getCell(`A${currentRow}`);
        domainHeader.value = ' Domain Performance Analysis';
        domainHeader.font = { name: 'Lora', size: 14, bold: true, color: { argb: 'FFFFFFFF' } };
        domainHeader.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1E3A5F' } };
        domainHeader.alignment = { horizontal: 'left', vertical: 'middle' };
        ws1.getRow(currentRow).height = 28;
        currentRow++;

        // Domain table headers
        ws1.getCell(currentRow, 1).value = 'Domain';
        ws1.getCell(currentRow, 2).value = 'Score';
        ws1.getCell(currentRow, 3).value = 'Fully Met';
        ws1.getCell(currentRow, 4).value = 'Not Met';
        ws1.mergeCells(currentRow, 5, currentRow, 25);
        ws1.getCell(currentRow, 5).value = 'Performance Bar';

        [1, 2, 3, 4, 5].forEach(col => {
          const cell = ws1.getCell(currentRow, col);
          cell.font = { name: 'Lora', bold: true, color: { argb: 'FFFFFFFF' } };
          cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1E3A5F' } };
          cell.alignment = { horizontal: 'center', vertical: 'middle' };
          cell.border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
        });
        ws1.getRow(currentRow).height = 22;
        currentRow++;

        // Domain rows
        chapterData.forEach((ch, idx) => {
          const altBg = idx % 2 === 1 ? 'FFF8F9FA' : 'FFFFFFFF';
          const scoreColor = ch.percentage >= 90 ? 'FF2E7D32' : ch.percentage >= 70 ? 'FFD68910' : 'FFC62828';

          ws1.getCell(currentRow, 1).value = ch.name;
          ws1.getCell(currentRow, 1).font = { name: 'Lora', size: 11, bold: true };
          ws1.getCell(currentRow, 1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: altBg } };
          ws1.getCell(currentRow, 1).alignment = { horizontal: 'left', vertical: 'middle' };
          ws1.getCell(currentRow, 1).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };

          ws1.getCell(currentRow, 2).value = `${ch.percentage}%`;
          ws1.getCell(currentRow, 2).font = { name: 'Lora', size: 13, bold: true, color: { argb: scoreColor } };
          ws1.getCell(currentRow, 2).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: altBg } };
          ws1.getCell(currentRow, 2).alignment = { horizontal: 'center', vertical: 'middle' };
          ws1.getCell(currentRow, 2).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };

          ws1.getCell(currentRow, 3).value = ch.fullyMet;
          ws1.getCell(currentRow, 3).font = { name: 'Lora', size: 13, bold: true, color: { argb: 'FF2E7D32' } };
          ws1.getCell(currentRow, 3).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: altBg } };
          ws1.getCell(currentRow, 3).alignment = { horizontal: 'center', vertical: 'middle' };
          ws1.getCell(currentRow, 3).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };

          ws1.getCell(currentRow, 4).value = ch.notMet;
          ws1.getCell(currentRow, 4).font = { name: 'Lora', size: 13, bold: true, color: { argb: 'FFC62828' } };
          ws1.getCell(currentRow, 4).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: altBg } };
          ws1.getCell(currentRow, 4).alignment = { horizontal: 'center', vertical: 'middle' };
          ws1.getCell(currentRow, 4).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };

          createBarCells(ws1, currentRow, 5, ch.percentage, 'FF2E7D32');
          ws1.getRow(currentRow).height = 24;
          currentRow++;
        });

        // ===== SPACER (3 empty rows) =====
        currentRow += 3;

        // ===== QUICK STATISTICS SECTION (with WIDER cards using merged cells - EXACT match with main app) =====
        ws1.mergeCells(`A${currentRow}:Y${currentRow}`);
        const quickHeader = ws1.getCell(`A${currentRow}`);
        quickHeader.value = ' Quick Statistics';
        quickHeader.font = { name: 'Lora', size: 14, bold: true, color: { argb: 'FFFFFFFF' } };
        quickHeader.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1E3A5F' } };
        quickHeader.alignment = { horizontal: 'left', vertical: 'middle' };
        ws1.getRow(currentRow).height = 28;
        currentRow++;

        // Stats cards - WIDER MERGED CELLS with proper spacing
        const statsHeaderRow = currentRow;
        const statsValueRow = currentRow + 1;

        // Card 1: Total Sub-Standards (Columns A-C merged for wider display)
        ws1.mergeCells(statsHeaderRow, 1, statsHeaderRow, 3);
        ws1.getCell(statsHeaderRow, 1).value = 'Total Sub-Standards';
        ws1.getCell(statsHeaderRow, 1).font = { name: 'Lora', size: 11, bold: true, color: { argb: 'FF1565C0' } };
        ws1.getCell(statsHeaderRow, 1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE3F2FD' } };
        ws1.getCell(statsHeaderRow, 1).alignment = { horizontal: 'center', vertical: 'middle' };
        ws1.getCell(statsHeaderRow, 1).border = { top: { style: 'medium', color: { argb: 'FF1565C0' } }, bottom: { style: 'thin' }, left: { style: 'medium', color: { argb: 'FF1565C0' } }, right: { style: 'medium', color: { argb: 'FF1565C0' } } };
        ws1.mergeCells(statsValueRow, 1, statsValueRow, 3);
        ws1.getCell(statsValueRow, 1).value = stats.total || 0;
        ws1.getCell(statsValueRow, 1).font = { name: 'Lora', size: 36, bold: true, color: { argb: 'FF1565C0' } };
        ws1.getCell(statsValueRow, 1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE3F2FD' } };
        ws1.getCell(statsValueRow, 1).alignment = { horizontal: 'center', vertical: 'middle' };
        ws1.getCell(statsValueRow, 1).border = { top: { style: 'thin' }, bottom: { style: 'medium', color: { argb: 'FF1565C0' } }, left: { style: 'medium', color: { argb: 'FF1565C0' } }, right: { style: 'medium', color: { argb: 'FF1565C0' } } };

        // Column 4 is EMPTY SPACER

        // Card 2: Items with Findings (Columns 5-12 merged for wider display)
        ws1.mergeCells(statsHeaderRow, 5, statsHeaderRow, 12);
        ws1.getCell(statsHeaderRow, 5).value = 'Items with Findings';
        ws1.getCell(statsHeaderRow, 5).font = { name: 'Lora', size: 11, bold: true, color: { argb: 'FFFF8F00' } };
        ws1.getCell(statsHeaderRow, 5).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFF8E1' } };
        ws1.getCell(statsHeaderRow, 5).alignment = { horizontal: 'center', vertical: 'middle' };
        ws1.getCell(statsHeaderRow, 5).border = { top: { style: 'medium', color: { argb: 'FFFF8F00' } }, bottom: { style: 'thin' }, left: { style: 'medium', color: { argb: 'FFFF8F00' } }, right: { style: 'medium', color: { argb: 'FFFF8F00' } } };
        ws1.mergeCells(statsValueRow, 5, statsValueRow, 12);
        ws1.getCell(statsValueRow, 5).value = totalFindings;
        ws1.getCell(statsValueRow, 5).font = { name: 'Lora', size: 36, bold: true, color: { argb: 'FFFF8F00' } };
        ws1.getCell(statsValueRow, 5).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFF8E1' } };
        ws1.getCell(statsValueRow, 5).alignment = { horizontal: 'center', vertical: 'middle' };
        ws1.getCell(statsValueRow, 5).border = { top: { style: 'thin' }, bottom: { style: 'medium', color: { argb: 'FFFF8F00' } }, left: { style: 'medium', color: { argb: 'FFFF8F00' } }, right: { style: 'medium', color: { argb: 'FFFF8F00' } } };

        // Column 13 is EMPTY SPACER

        // Card 3: Accreditation Status (Columns 14-24 merged for MUCH WIDER display)
        ws1.mergeCells(statsHeaderRow, 14, statsHeaderRow, 24);
        ws1.getCell(statsHeaderRow, 14).value = 'Accreditation Status';
        ws1.getCell(statsHeaderRow, 14).font = { name: 'Lora', size: 11, bold: true, color: { argb: 'FF2E7D32' } };
        ws1.getCell(statsHeaderRow, 14).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE8F5E9' } };
        ws1.getCell(statsHeaderRow, 14).alignment = { horizontal: 'center', vertical: 'middle' };
        ws1.getCell(statsHeaderRow, 14).border = { top: { style: 'medium', color: { argb: 'FF2E7D32' } }, bottom: { style: 'thin' }, left: { style: 'medium', color: { argb: 'FF2E7D32' } }, right: { style: 'medium', color: { argb: 'FF2E7D32' } } };
        ws1.mergeCells(statsValueRow, 14, statsValueRow, 24);
        ws1.getCell(statsValueRow, 14).value = stats.percentage >= 70 ? ' LIKELY TO PASS' : ' AT RISK';
        ws1.getCell(statsValueRow, 14).font = { name: 'Lora', size: 18, bold: true, color: { argb: stats.percentage >= 70 ? 'FF2E7D32' : 'FFC62828' } };
        ws1.getCell(statsValueRow, 14).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE8F5E9' } };
        ws1.getCell(statsValueRow, 14).alignment = { horizontal: 'center', vertical: 'middle' };
        ws1.getCell(statsValueRow, 14).border = { top: { style: 'thin' }, bottom: { style: 'medium', color: { argb: 'FF2E7D32' } }, left: { style: 'medium', color: { argb: 'FF2E7D32' } }, right: { style: 'medium', color: { argb: 'FF2E7D32' } } };

        ws1.getRow(statsHeaderRow).height = 25;
        ws1.getRow(statsValueRow).height = 45;

        // ===================== SHEET 2: ALL SCORED ITEMS (EXACT match with main app) =====================
        const ws2 = workbook.addWorksheet('All Scored Items');
        ws2.columns = [
          { width: 28 }, { width: 12 }, { width: 65 }, { width: 14 }, { width: 40 }, { width: 40 }, { width: 12 }
        ];

        // Header
        ws2.mergeCells('A1:G1');
        ws2.getCell('A1').value = `Complete Assessment - All ${stats.total || 0} Sub-Standards`;
        ws2.getCell('A1').font = { size: 16, bold: true, color: { argb: 'FF1E3A5F' } };
        ws2.getRow(1).height = 30;

        // Table headers (EXACT match with main app - includes Sub-Standard Description)
        const ws2Headers = ['Domain', 'ID', 'Sub-Standard Description', 'Score', 'Finding', 'Recommendation', 'Priority'];
        ws2Headers.forEach((header, idx) => {
          const cell = ws2.getCell(2, idx + 1);
          cell.value = header;
          cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
          cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF1E3A5F' } };
          cell.alignment = { horizontal: 'center', vertical: 'middle' };
          cell.border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
        });
        ws2.getRow(2).height = 22;

        // All items with text wrapping
        let ws2Row = 3;
        chapterData.forEach(ch => {
          ch.substandards.forEach((sub) => {
            const altBg = (ws2Row - 3) % 2 === 1 ? 'FFF8F9FA' : 'FFFFFFFF';
            const scoreLabel = sub.score === 2 ? 'Fully Met' : sub.score === 1 ? 'Partially Met' : sub.score === 0 ? 'Not Met' : 'N/A';
            const scoreColor = sub.score === 2 ? 'FF2E7D32' : sub.score === 1 ? 'FFD68910' : sub.score === 0 ? 'FFC62828' : 'FF6C757D';

            ws2.getCell(ws2Row, 1).value = ch.name;
            ws2.getCell(ws2Row, 1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: altBg } };
            ws2.getCell(ws2Row, 1).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
            ws2.getCell(ws2Row, 1).alignment = { wrapText: true, vertical: 'top' };

            ws2.getCell(ws2Row, 2).value = sub.id;
            ws2.getCell(ws2Row, 2).font = { bold: true, color: { argb: 'FF1E3A5F' } };
            ws2.getCell(ws2Row, 2).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: altBg } };
            ws2.getCell(ws2Row, 2).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };

            ws2.getCell(ws2Row, 3).value = sub.text;
            ws2.getCell(ws2Row, 3).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: altBg } };
            ws2.getCell(ws2Row, 3).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
            ws2.getCell(ws2Row, 3).alignment = { wrapText: true, vertical: 'top' };

            ws2.getCell(ws2Row, 4).value = scoreLabel;
            ws2.getCell(ws2Row, 4).font = { bold: true, color: { argb: scoreColor } };
            ws2.getCell(ws2Row, 4).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: altBg } };
            ws2.getCell(ws2Row, 4).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
            ws2.getCell(ws2Row, 4).alignment = { horizontal: 'center' };

            ws2.getCell(ws2Row, 5).value = sub.findings || '-';
            ws2.getCell(ws2Row, 5).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: altBg } };
            ws2.getCell(ws2Row, 5).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
            ws2.getCell(ws2Row, 5).alignment = { wrapText: true, vertical: 'top' };

            ws2.getCell(ws2Row, 6).value = sub.recommendations || '-';
            ws2.getCell(ws2Row, 6).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: altBg } };
            ws2.getCell(ws2Row, 6).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
            ws2.getCell(ws2Row, 6).alignment = { wrapText: true, vertical: 'top' };

            ws2.getCell(ws2Row, 7).value = sub.score === 0 ? 'High' : sub.score === 1 ? 'Medium' : '-';
            ws2.getCell(ws2Row, 7).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: altBg } };
            ws2.getCell(ws2Row, 7).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };

            ws2Row++;
          });
        });

        // ===================== SHEET 3: ACTION PLAN (EXACT match with main app) =====================
        const ws3 = workbook.addWorksheet('Action Plan');
        ws3.columns = [
          { width: 6 }, { width: 28 }, { width: 12 }, { width: 55 }, { width: 14 }, { width: 35 }, { width: 40 }, { width: 10 }
        ];

        ws3.mergeCells('A1:H1');
        ws3.getCell('A1').value = ` Corrective Action Plan - ${totalFindings} Items Requiring Attention`;
        ws3.getCell('A1').font = { size: 16, bold: true, color: { argb: 'FFFFFFFF' } };
        ws3.getCell('A1').fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE65100' } };
        ws3.getRow(1).height = 30;

        ws3.getCell('A3').value = 'Priority Summary:';
        ws3.getCell('A3').font = { bold: true };
        ws3.mergeCells('B3:D3');
        ws3.getCell('B3').value = ` High Priority (Not Met): ${highCount} items - Address within 30 days`;
        ws3.getCell('B3').font = { color: { argb: 'FFC62828' } };
        ws3.mergeCells('B4:D4');
        ws3.getCell('B4').value = ` Medium Priority (Partial): ${medCount} items - Address within 60 days`;
        ws3.getCell('B4').font = { color: { argb: 'FFD68910' } };

        // Table headers (EXACT match with main app - includes Sub-Standard)
        const ws3Headers = ['#', 'Domain', 'ID', 'Sub-Standard', 'Score', 'Finding', 'Recommended Action', 'Days'];
        ws3Headers.forEach((header, idx) => {
          const cell = ws3.getCell(6, idx + 1);
          cell.value = header;
          cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
          cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE65100' } };
          cell.alignment = { horizontal: 'center', vertical: 'middle' };
          cell.border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
        });
        ws3.getRow(6).height = 22;

        // Action items with text wrapping (EXACT match with main app)
        let ws3Row = 7;
        let itemNum = 0;
        chapterData.forEach(ch => {
          ch.substandards.filter(sub => sub.score === 0 || sub.score === 1).forEach(sub => {
            itemNum++;
            const isHigh = sub.score === 0;
            const rowBg = isHigh ? 'FFFDE8E8' : 'FFFEF3E2';
            const scoreColor = isHigh ? 'FFC62828' : 'FFD68910';
            const action = sub.recommendations || (isHigh ? 'Develop and implement policy/procedure. Assign responsible person.' : 'Review practices, update documentation, provide training.');

            ws3.getCell(ws3Row, 1).value = itemNum;
            ws3.getCell(ws3Row, 1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: rowBg } };
            ws3.getCell(ws3Row, 1).alignment = { horizontal: 'center' };
            ws3.getCell(ws3Row, 1).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };

            ws3.getCell(ws3Row, 2).value = ch.name;
            ws3.getCell(ws3Row, 2).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: rowBg } };
            ws3.getCell(ws3Row, 2).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
            ws3.getCell(ws3Row, 2).alignment = { wrapText: true, vertical: 'top' };

            ws3.getCell(ws3Row, 3).value = sub.id;
            ws3.getCell(ws3Row, 3).font = { bold: true, color: { argb: 'FF1E3A5F' } };
            ws3.getCell(ws3Row, 3).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: rowBg } };
            ws3.getCell(ws3Row, 3).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };

            ws3.getCell(ws3Row, 4).value = sub.text;
            ws3.getCell(ws3Row, 4).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: rowBg } };
            ws3.getCell(ws3Row, 4).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
            ws3.getCell(ws3Row, 4).alignment = { wrapText: true, vertical: 'top' };

            ws3.getCell(ws3Row, 5).value = isHigh ? 'Not Met' : 'Partially Met';
            ws3.getCell(ws3Row, 5).font = { bold: true, color: { argb: scoreColor } };
            ws3.getCell(ws3Row, 5).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: rowBg } };
            ws3.getCell(ws3Row, 5).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
            ws3.getCell(ws3Row, 5).alignment = { horizontal: 'center' };

            ws3.getCell(ws3Row, 6).value = sub.findings || '-';
            ws3.getCell(ws3Row, 6).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: rowBg } };
            ws3.getCell(ws3Row, 6).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
            ws3.getCell(ws3Row, 6).alignment = { wrapText: true, vertical: 'top' };

            ws3.getCell(ws3Row, 7).value = action;
            ws3.getCell(ws3Row, 7).font = { color: { argb: 'FF2E7D32' } };
            ws3.getCell(ws3Row, 7).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE8F5E9' } };
            ws3.getCell(ws3Row, 7).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };
            ws3.getCell(ws3Row, 7).alignment = { wrapText: true, vertical: 'top' };

            ws3.getCell(ws3Row, 8).value = isHigh ? '30' : '60';
            ws3.getCell(ws3Row, 8).font = { bold: true, color: { argb: scoreColor } };
            ws3.getCell(ws3Row, 8).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: rowBg } };
            ws3.getCell(ws3Row, 8).alignment = { horizontal: 'center' };
            ws3.getCell(ws3Row, 8).border = { top: { style: 'thin' }, bottom: { style: 'thin' }, left: { style: 'thin' }, right: { style: 'thin' } };

            ws3Row++;
          });
        });

        // Download
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        setExportMessage('Excel report downloaded successfully!');
        setTimeout(() => setExportMessage(''), 3000);
      };

      // Export to PDF function - EXACT MATCH with main app ExecutiveSummaryModal
      const exportToPDF = () => {
        if (!survey) return;

        const { jsPDF } = window.jspdf;
        if (!jsPDF) {
          alert('PDF export library not loaded. Please refresh and try again.');
          return;
        }

        setExportMessage('Generating PDF report...');

        const details = survey.assessmentDetails || {};
        const stats = survey.stats || {};
        const chapterData = getChapterDataForExport();
        const compliance = getComplianceLevelExport(stats.percentage || 0);

        const doc = new jsPDF('p', 'mm', 'a4');
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        let yPos = 20;

        // Domain color palette - professional, consistent tones (EXACT match with main app)
        const domainColors = {
          'Leadership': { primary: [40, 60, 90], light: [245, 248, 252], name: 'LD' },
          'Leadership of the Organization': { primary: [40, 60, 90], light: [245, 248, 252], name: 'LD' },
          'Provision of Care': { primary: [22, 90, 58], light: [242, 250, 246], name: 'PC' },
          'Dental Laboratory': { primary: [140, 105, 25], light: [253, 250, 242], name: 'DL' },
          'Infection Prevention': { primary: [90, 50, 100], light: [250, 245, 252], name: 'IPC' },
          'Infection Prevention and Control': { primary: [90, 50, 100], light: [250, 245, 252], name: 'IPC' },
          'Management of Information': { primary: [35, 90, 95], light: [242, 250, 252], name: 'MOI' },
          'Facility Management': { primary: [130, 55, 60], light: [252, 245, 246], name: 'FMS' },
          'Facility Management and Safety': { primary: [130, 55, 60], light: [252, 245, 246], name: 'FMS' }
        };

        const getDomainColor = (domainName) => {
          return domainColors[domainName] || { primary: [30, 58, 95], light: [240, 240, 240], name: '?' };
        };

        // Helper function to add new page if needed
        const checkNewPage = (requiredSpace = 30) => {
          if (yPos + requiredSpace > pageHeight - 20) {
            doc.addPage();
            yPos = 20;
            return true;
          }
          return false;
        };

        // Helper to wrap text
        const wrapText = (text, maxWidth) => {
          return doc.splitTextToSize(text, maxWidth);
        };

        // Generate Smart Corrective Action based on sub-standard text and score (EXACT match with main app)
        const generateCorrectiveAction = (item) => {
          // If user provided a recommendation, use it
          if (item.recommendations && item.recommendations.trim()) {
            return item.recommendations;
          }

          const text = (item.text || '').toLowerCase();
          const isNotMet = item.score === 0;
          const domain = (item.chapter || '').toLowerCase();

          // Analyze sub-standard text to generate specific actions
          let action = '';

          // Policy/Procedure related
          if (text.includes('policy') || text.includes('procedure') || text.includes('guideline')) {
            action = isNotMet
              ? 'Develop and approve written policy/procedure. Assign owner, set review date, and distribute to all relevant staff.'
              : 'Review existing policy for completeness. Update gaps, obtain approval, and ensure staff acknowledgment.';
          }
          // Documentation/Records
          else if (text.includes('document') || text.includes('record') || text.includes('log') || text.includes('register')) {
            action = isNotMet
              ? 'Create standardized documentation template. Implement tracking system and assign responsibility for maintenance.'
              : 'Audit current records for completeness. Address gaps and implement regular review schedule.';
          }
          // Training/Education
          else if (text.includes('train') || text.includes('educat') || text.includes('orient') || text.includes('competenc')) {
            action = isNotMet
              ? 'Develop training curriculum and schedule. Document attendance and competency verification for all staff.'
              : 'Enhance training program. Add practical assessments and update training materials.';
          }
          // Evaluation/Assessment/Monitoring
          else if (text.includes('evaluat') || text.includes('assess') || text.includes('monitor') || text.includes('audit')) {
            action = isNotMet
              ? 'Establish evaluation criteria and schedule. Create assessment tools and assign responsible personnel.'
              : 'Strengthen monitoring frequency. Improve documentation of findings and follow-up actions.';
          }
          // Communication/Reporting
          else if (text.includes('communicat') || text.includes('report') || text.includes('inform') || text.includes('notify')) {
            action = isNotMet
              ? 'Establish formal communication channels and reporting protocols. Document all communications.'
              : 'Improve communication timeliness and documentation. Verify receipt and understanding.';
          }
          // Safety/Infection Control
          else if (text.includes('safety') || text.includes('infect') || text.includes('steril') || text.includes('hygiene')) {
            action = isNotMet
              ? 'Implement comprehensive safety/infection control program. Train all staff and establish monitoring system.'
              : 'Review current practices against standards. Address gaps and increase compliance monitoring.';
          }
          // Equipment/Maintenance
          else if (text.includes('equipment') || text.includes('maintain') || text.includes('calibrat') || text.includes('device')) {
            action = isNotMet
              ? 'Create equipment inventory and maintenance schedule. Document all maintenance activities and calibrations.'
              : 'Update maintenance logs. Ensure scheduled maintenance is completed and documented.';
          }
          // Patient Care/Rights
          else if (text.includes('patient') || text.includes('consent') || text.includes('right') || text.includes('care plan')) {
            action = isNotMet
              ? 'Develop patient-centered protocols. Train staff on rights and documentation requirements.'
              : 'Audit patient records for compliance. Improve documentation consistency.';
          }
          // Leadership/Governance
          else if (domain.includes('leadership') || text.includes('leader') || text.includes('govern') || text.includes('committee')) {
            action = isNotMet
              ? 'Establish governance structure with clear roles. Document meeting minutes and decisions.'
              : 'Strengthen leadership oversight. Improve documentation of decisions and follow-through.';
          }
          // Quality/Performance Indicators
          else if (text.includes('quality') || text.includes('indicator') || text.includes('performance') || text.includes('benchmark')) {
            action = isNotMet
              ? 'Define quality indicators with targets. Implement data collection and analysis system.'
              : 'Review indicator definitions and targets. Improve data accuracy and reporting frequency.';
          }
          // Default action based on score
          else {
            action = isNotMet
              ? 'Develop implementation plan with clear objectives, responsible persons, and timeline. Document all activities.'
              : 'Review current practices, identify gaps, and implement improvements. Monitor compliance.';
          }

          return action;
        };

        // Collect action plan items
        const actionPlanItems = [];
        chapterData.forEach(ch => {
          ch.substandards.filter(s => s.score === 0 || s.score === 1).forEach(sub => {
            actionPlanItems.push({
              chapter: ch.name,
              ...sub
            });
          });
        });

        // Generate Executive Narrative based on findings (EXACT match with main app)
        const generateExecutiveNarrative = () => {
          const strongDomains = chapterData.filter(ch => ch.percentage >= 90);
          const goodDomains = chapterData.filter(ch => ch.percentage >= 75 && ch.percentage < 90);
          const concernDomains = chapterData.filter(ch => ch.percentage < 75);
          const criticalFindings = actionPlanItems.filter(item => item.score === 0);
          const partialFindings = actionPlanItems.filter(item => item.score === 1);

          let narrative = '';

          // Opening - Overall assessment
          if (stats.percentage >= 90) {
            narrative += `${details.centerName || 'The center'} has demonstrated exceptional commitment to quality and patient safety, achieving an outstanding compliance score of ${stats.percentage}%. This remarkable achievement reflects the dedication of the entire team to maintaining the highest standards of healthcare delivery. `;
          } else if (stats.percentage >= 75) {
            narrative += `${details.centerName || 'The center'} has shown strong performance in this accreditation assessment, achieving a compliance score of ${stats.percentage}%. The center demonstrates solid foundations in quality management with some areas identified for further enhancement. `;
          } else if (stats.percentage >= 60) {
            narrative += `${details.centerName || 'The center'} achieved a compliance score of ${stats.percentage}% in this assessment. While the center meets fundamental requirements, several areas require focused attention to achieve full accreditation readiness. `;
          } else {
            narrative += `This assessment identified significant opportunities for improvement at ${details.centerName || 'the center'}, with a current compliance score of ${stats.percentage}%. Immediate action is recommended to address critical gaps before the next survey. `;
          }

          // Strengths section
          if (strongDomains.length > 0) {
            narrative += `\n\nAreas of Excellence: The center excels in ${strongDomains.map(d => d.name).join(', ')}, demonstrating robust policies, well-trained staff, and consistent implementation of best practices. `;
          }

          if (goodDomains.length > 0) {
            narrative += `Strong performance was also noted in ${goodDomains.map(d => d.name).join(', ')}. `;
          }

          // Areas for improvement
          if (concernDomains.length > 0) {
            narrative += `\n\nPriority Focus Areas: ${concernDomains.map(d => `${d.name} (${d.percentage}%)`).join(', ')} require immediate attention to meet accreditation standards. `;
          }

          // Critical findings summary
          if (criticalFindings.length > 0) {
            narrative += `\n\nCritical Findings: ${criticalFindings.length} standards were scored as "Not Met" and require immediate corrective action within 30 days. Key areas include `;
            const criticalAreas = [...new Set(criticalFindings.map(f => f.chapter))];
            narrative += criticalAreas.slice(0, 3).join(', ') + '. ';
          }

          // Partial findings
          if (partialFindings.length > 0) {
            narrative += `Additionally, ${partialFindings.length} standards were partially met and should be addressed within 60 days. `;
          }

          // Closing encouragement
          narrative += `\n\nWith focused effort on the identified areas, ${details.centerName || 'the center'} is well-positioned to achieve and maintain full accreditation status. The action plan provided in this report outlines specific steps and timelines for improvement.`;

          return narrative;
        };

        // Count findings
        let totalFindings = actionPlanItems.length;

        // ==================== PAGE 1: COVER & EXECUTIVE SUMMARY ====================

        // Minimalist navy gradient header for branding
        const headerHeight = 12;
        const steps = 30;
        for (let i = 0; i < steps; i++) {
          const ratio = i / steps;
          const r = Math.round(30 + (255 - 30) * ratio * 1.2);
          const g = Math.round(58 + (255 - 58) * ratio * 1.2);
          const b = Math.round(95 + (255 - 95) * ratio * 0.8);
          doc.setFillColor(Math.min(255, r), Math.min(255, g), Math.min(255, b));
          doc.rect((i / steps) * pageWidth * 0.7, 0, (pageWidth * 0.7 / steps) + 1, headerHeight, 'F');
        }

        // Title - with proper spacing below gradient
        doc.setTextColor(30, 58, 95);
        doc.setFontSize(32);
        doc.setFont('times', 'bold');
        doc.text('StandardsHub', 20, 32);

        // Subtitle
        doc.setFontSize(12);
        doc.setFont('times', 'normal');
        doc.setTextColor(100, 105, 115);
        doc.text('Healthcare Accreditation Assessment Report', 20, 44);

        // Date
        doc.setFontSize(10);
        doc.text(new Date(survey.completedAt || survey.createdAt).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' }), 20, 54);
        doc.setDrawColor(200, 205, 210);
        doc.setLineWidth(0.3);
        doc.line(20, 58, pageWidth - 20, 58);

        yPos = 70;

        // Center name - prominent but not boxed
        doc.setTextColor(30, 58, 95);
        doc.setFontSize(22);
        doc.setFont('times', 'bold');
        doc.text(details.centerName || 'Assessment Report', 20, yPos);
        yPos += 10;

        // Coordinator info
        doc.setFontSize(10);
        doc.setFont('times', 'normal');
        doc.setTextColor(100, 105, 115);
        doc.text(`Quality Coordinator: ${details.coordinatorName || '-'}      Configuration: ${survey.configuration || '-'}`, 20, yPos);
        yPos += 20;

        // Score Display - clean, no box, just the numbers
        const scoreColor = stats.percentage >= 90 ? [22, 90, 55] : stats.percentage >= 75 ? [30, 100, 60] : stats.percentage >= 60 ? [160, 95, 10] : [150, 45, 35];

        doc.setTextColor(...scoreColor);
        doc.setFontSize(52);
        doc.setFont('times', 'bold');
        doc.text(`${stats.percentage || 0}%`, pageWidth / 2, yPos + 15, { align: 'center' });

        doc.setFontSize(11);
        doc.setFont('times', 'normal');
        doc.setTextColor(100, 105, 115);
        doc.text('Overall Compliance Score', pageWidth / 2, yPos + 26, { align: 'center' });

        doc.setTextColor(...scoreColor);
        doc.setFont('times', 'bold');
        doc.text(compliance.label, pageWidth / 2, yPos + 35, { align: 'center' });

        // Subtle underline below score
        doc.setDrawColor(...scoreColor.map(c => Math.round(c + (255 - c) * 0.7)));
        doc.setLineWidth(0.5);
        doc.line(pageWidth / 2 - 40, yPos + 40, pageWidth / 2 + 40, yPos + 40);

        yPos += 55;

        // Score breakdown - minimal cards with left accent only
        const cardGap = 8;
        const cardWidth = (pageWidth - 40 - (cardGap * 3)) / 4;
        const boxData = [
          { label: 'Fully Met', value: stats.fullyMet || 0, color: [22, 90, 55] },
          { label: 'Partial', value: stats.partial || 0, color: [160, 100, 15] },
          { label: 'Not Met', value: stats.notMet || 0, color: [150, 45, 35] },
          { label: 'N/A', value: stats.na || 0, color: [110, 115, 125] }
        ];

        boxData.forEach((box, idx) => {
          const x = 20 + (idx * (cardWidth + cardGap));

          // Thin left accent line only
          doc.setFillColor(...box.color);
          doc.rect(x, yPos, 2, 20, 'F');

          // Value
          doc.setTextColor(...box.color);
          doc.setFontSize(18);
          doc.setFont('times', 'bold');
          doc.text(String(box.value), x + 12, yPos + 10);

          // Label
          doc.setFontSize(8);
          doc.setFont('times', 'normal');
          doc.setTextColor(110, 115, 125);
          doc.text(box.label.toUpperCase(), x + 12, yPos + 17);
        });
        yPos += 32;

        // Executive Summary - title with underline, no box
        doc.setTextColor(30, 58, 95);
        doc.setFontSize(14);
        doc.setFont('times', 'bold');
        doc.text('Executive Summary', 20, yPos);
        doc.setDrawColor(30, 58, 95);
        doc.setLineWidth(0.4);
        doc.line(20, yPos + 2, 75, yPos + 2);
        yPos += 10;

        // Executive narrative text
        doc.setTextColor(60, 65, 70);
        doc.setFontSize(10);
        doc.setFont('times', 'normal');
        const narrative = generateExecutiveNarrative();
        const narrativeLines = wrapText(narrative, pageWidth - 40);
        narrativeLines.forEach(line => {
          checkNewPage(8);
          doc.text(line, 20, yPos);
          yPos += 5;
        });

        // ==================== PAGE 2: DOMAIN PERFORMANCE ====================
        doc.addPage();
        yPos = 25;

        // Section title - clean, no underline
        doc.setTextColor(30, 58, 95);
        doc.setFontSize(16);
        doc.setFont('times', 'bold');
        doc.text('Domain Performance Analysis', 20, yPos);
        yPos += 12;

        // Helper function for domain headers - clean colored text only (no underlines)
        const drawDomainHeader = (x, y, domainColor, text, percentage) => {
          // Domain text in domain color
          doc.setTextColor(...domainColor.primary);
          doc.setFontSize(11);
          doc.setFont('times', 'bold');
          doc.text(text, x, y + 5);

          // Percentage on right in same color
          doc.text(`${percentage}%`, pageWidth - 25, y + 5, { align: 'right' });
        };

        // Domain cards
        chapterData.forEach((ch, idx) => {
          checkNewPage(35);
          const domainColor = getDomainColor(ch.name);

          // Domain header
          drawDomainHeader(20, yPos, domainColor, `${domainColor.name}  ${ch.name}`, ch.percentage);
          yPos += 14;

          // Stats row - clean text, no background
          doc.setFontSize(9);
          doc.setFont('times', 'normal');
          doc.setTextColor(80, 85, 90);
          doc.text(`Total: ${ch.total}`, 28, yPos);

          doc.setTextColor(22, 90, 55);
          doc.text(`Fully Met: ${ch.fullyMet}`, 65, yPos);

          doc.setTextColor(160, 100, 15);
          doc.text(`Partial: ${ch.partial}`, 110, yPos);

          doc.setTextColor(150, 45, 35);
          doc.text(`Not Met: ${ch.notMet}`, 145, yPos);
          yPos += 6;

          // Progress bar - subtle
          const barWidth = pageWidth - 60;
          doc.setFillColor(235, 238, 242);
          doc.roundedRect(28, yPos, barWidth, 3, 1, 1, 'F');

          const fillWidth = (ch.percentage / 100) * barWidth;
          const fillColor = ch.percentage >= 90 ? [22, 90, 55] : ch.percentage >= 75 ? [30, 100, 60] : ch.percentage >= 60 ? [160, 100, 15] : [150, 45, 35];
          doc.setFillColor(...fillColor);
          doc.roundedRect(28, yPos, fillWidth, 3, 1, 1, 'F');

          yPos += 15;
        });

        // ==================== PAGE 3+: ACTION PLAN ====================
        if (actionPlanItems.length > 0) {
          doc.addPage();
          yPos = 25;

          // Section title
          doc.setTextColor(140, 70, 20);
          doc.setFontSize(16);
          doc.setFont('times', 'bold');
          doc.text(`Corrective Action Plan`, 20, yPos);
          doc.setFontSize(11);
          doc.setFont('times', 'normal');
          doc.setTextColor(100, 105, 115);
          doc.text(`${actionPlanItems.length} items requiring attention`, 115, yPos);
          yPos += 10;

          // Timeline guide - weeks format
          doc.setFontSize(9);
          doc.setFont('times', 'italic');
          doc.setTextColor(100, 105, 115);
          doc.text('Timeline:  ', 20, yPos);
          doc.setFont('times', 'normal');
          doc.setTextColor(150, 45, 35);
          doc.text('HIGH = 1-4 weeks', 45, yPos);
          doc.setTextColor(160, 100, 15);
          doc.text('MEDIUM = 2-5 weeks', 95, yPos);
          yPos += 12;

          // Group action items by domain
          const findingsByDomainPDF = {};
          actionPlanItems.forEach(item => {
            if (!findingsByDomainPDF[item.chapter]) {
              findingsByDomainPDF[item.chapter] = [];
            }
            findingsByDomainPDF[item.chapter].push(item);
          });

          // Render each domain's findings with full text and proper spacing
          Object.entries(findingsByDomainPDF).forEach(([domainName, findings]) => {
            checkNewPage(50);
            const domainColor = getDomainColor(domainName);

            // Domain header - clean colored text only (no underlines)
            doc.setTextColor(...domainColor.primary);
            doc.setFontSize(11);
            doc.setFont('times', 'bold');
            doc.text(`${domainColor.name}  ${domainName} (${findings.length} findings)`, 20, yPos);
            yPos += 10;

            // Findings list - full text with proper hierarchy and spacing
            findings.forEach((item, idx) => {
              checkNewPage(35);

              // ---- ITEM HEADER ROW with subtle gray background ----
              const isHigh = item.score === 0;

              // Subtle gray background for header row (table-like, no frames)
              doc.setFillColor(245, 247, 250);
              doc.rect(20, yPos - 4, pageWidth - 40, 10, 'F');

              // Item number and ID
              doc.setFontSize(10);
              doc.setFont('times', 'bold');
              doc.setTextColor(30, 58, 95);
              doc.text(`${idx + 1}. ${item.id}`, 25, yPos + 2);

              // Priority - clean text
              doc.setFontSize(9);
              doc.setTextColor(isHigh ? 180 : 160, isHigh ? 50 : 100, isHigh ? 40 : 20);
              doc.text(isHigh ? 'HIGH' : 'MEDIUM', 65, yPos + 2);

              // Survey Activity tag (color-coded)
              const activityColors = {
                'DOC': [52, 73, 94],    // Dark blue-gray for Document Review
                'OBS': [39, 174, 96],   // Green for Observation
                'INT': [142, 68, 173],  // Purple for Interview
                'PER': [230, 126, 34],  // Orange for Personnel File
                'DEN': [41, 128, 185]   // Blue for Dental Record
              };
              const actColor = activityColors[item.activityType] || [100, 100, 100];
              doc.setTextColor(...actColor);
              doc.setFont('times', 'italic');
              doc.text(`[${item.activityLabel || 'Document Review'}]`, 90, yPos + 2);

              // Timeframe in weeks on right
              const days = item.targetDays || (isHigh ? 21 : 45);
              const weeks = Math.ceil(days / 7);
              doc.setFont('times', 'normal');
              doc.setTextColor(100, 105, 115);
              doc.text(`${weeks} week${weeks > 1 ? 's' : ''}`, pageWidth - 25, yPos + 2, { align: 'right' });

              yPos += 10;

              // ---- STANDARD TEXT (with orphan prevention) ----
              if (item.text && item.text.trim()) {
                doc.setFont('times', 'normal');
                doc.setTextColor(50, 55, 60);
                doc.setFontSize(9);
                const wrappedText = wrapText(item.text, pageWidth - 50);
                // Calculate total height needed for this text block
                const textBlockHeight = wrappedText.length * 4.5;
                // If text block won't fit but we'd leave orphan, move entire block to next page
                if (yPos + textBlockHeight > pageHeight - 25 && yPos + 15 < pageHeight - 25) {
                  doc.addPage();
                  yPos = 25;
                }
                wrappedText.forEach((line) => {
                  checkNewPage(5);
                  doc.text(line, 30, yPos);
                  yPos += 4.5;
                });

                yPos += 4;
              }

              // ---- FINDING (if available, with orphan prevention) ----
              if (item.findings && item.findings.trim()) {
                const findingText = wrapText(item.findings, pageWidth - 55);
                const findingHeight = 4 + (findingText.length * 4);
                // Prevent orphan - if only 1-2 lines would fit, move entire finding to next page
                if (yPos + findingHeight > pageHeight - 25 && yPos + 10 < pageHeight - 25) {
                  doc.addPage();
                  yPos = 25;
                }
                doc.setFont('times', 'bold');
                doc.setFontSize(8);
                doc.setTextColor(140, 90, 30);
                doc.text('Finding:', 30, yPos);
                yPos += 4;
                doc.setFont('times', 'italic');
                doc.setTextColor(120, 80, 40);
                findingText.forEach((line) => {
                  checkNewPage(5);
                  doc.text(line, 35, yPos);
                  yPos += 4;
                });
                yPos += 3;
              }

              // ---- CORRECTIVE ACTION (always shown, with orphan prevention) ----
              const correctiveAction = generateCorrectiveAction(item);
              const actionText = wrapText(correctiveAction, pageWidth - 55);
              const actionHeight = 4 + (actionText.length * 4);
              // Prevent orphan
              if (yPos + actionHeight > pageHeight - 25 && yPos + 10 < pageHeight - 25) {
                doc.addPage();
                yPos = 25;
              }
              doc.setFont('times', 'bold');
              doc.setFontSize(8);
              doc.setTextColor(25, 100, 50);
              doc.text('Corrective Action:', 30, yPos);
              yPos += 4;
              doc.setFont('times', 'normal');
              doc.setTextColor(35, 90, 55);
              actionText.forEach((line) => {
                checkNewPage(5);
                doc.text(line, 35, yPos);
                yPos += 4;
              });

              yPos += 8;
            });

            yPos += 10;
          });
        }

        // ==================== COMPLIANCE SUMMARY - SEPARATE PAGE ====================
        doc.addPage();
        yPos = 30;

        // Page title
        doc.setTextColor(30, 58, 95);
        doc.setFontSize(18);
        doc.setFont('times', 'bold');
        doc.text('Compliance Summary', pageWidth / 2, yPos, { align: 'center' });
        yPos += 25;

        // Calculate percentages
        const fullyMetPct = stats.scored > 0 ? (stats.fullyMet / stats.scored) * 100 : 0;
        const partialPct = stats.scored > 0 ? (stats.partial / stats.scored) * 100 : 0;
        const notMetPct = stats.scored > 0 ? (stats.notMet / stats.scored) * 100 : 0;

        // Modern color palette
        const pieColors = {
          fullyMet: [46, 125, 50],      // Deep green
          partial: [245, 166, 35],       // Warm amber
          notMet: [198, 40, 40]          // Deep red
        };

        // PIE CHART - larger and centered
        const pieRadius = 40;
        const pieCenterX = pageWidth / 2;
        const pieCenterY = yPos + pieRadius + 10;

        // Draw pie slices with improved colors
        const drawPieSlice = (cx, cy, r, startAngle, endAngle, color) => {
          doc.setFillColor(...color);
          const pieSteps = Math.max(20, Math.ceil((endAngle - startAngle) * 40));
          for (let i = 0; i < pieSteps; i++) {
            const a1 = startAngle + (endAngle - startAngle) * (i / pieSteps);
            const a2 = startAngle + (endAngle - startAngle) * ((i + 1) / pieSteps);
            doc.triangle(cx, cy,
              cx + r * Math.cos(a1), cy + r * Math.sin(a1),
              cx + r * Math.cos(a2), cy + r * Math.sin(a2), 'F');
          }
        };

        // Draw slices (start from top: -90 degrees)
        let startAngle = -Math.PI / 2;

        // Fully Met (green)
        if (fullyMetPct > 0) {
          const endAngle = startAngle + (fullyMetPct / 100) * 2 * Math.PI;
          drawPieSlice(pieCenterX, pieCenterY, pieRadius, startAngle, endAngle, pieColors.fullyMet);
          startAngle = endAngle;
        }

        // Partially Met (amber)
        if (partialPct > 0) {
          const endAngle = startAngle + (partialPct / 100) * 2 * Math.PI;
          drawPieSlice(pieCenterX, pieCenterY, pieRadius, startAngle, endAngle, pieColors.partial);
          startAngle = endAngle;
        }

        // Not Met (red)
        if (notMetPct > 0) {
          const endAngle = startAngle + (notMetPct / 100) * 2 * Math.PI;
          drawPieSlice(pieCenterX, pieCenterY, pieRadius, startAngle, endAngle, pieColors.notMet);
        }

        // Center score display in pie
        doc.setFillColor(255, 255, 255);
        doc.circle(pieCenterX, pieCenterY, 22, 'F');
        doc.setTextColor(30, 58, 95);
        doc.setFontSize(20);
        doc.setFont('times', 'bold');
        doc.text(`${stats.percentage}%`, pieCenterX, pieCenterY + 3, { align: 'center' });
        doc.setFontSize(7);
        doc.setFont('times', 'normal');
        doc.setTextColor(100, 105, 115);
        doc.text('Compliance', pieCenterX, pieCenterY + 10, { align: 'center' });

        yPos = pieCenterY + pieRadius + 25;

        // Legend - horizontal layout centered below pie
        const legendStartX = pageWidth / 2 - 70;
        let legendX = legendStartX;

        // Fully Met legend
        doc.setFillColor(...pieColors.fullyMet);
        doc.roundedRect(legendX, yPos - 3, 8, 8, 1, 1, 'F');
        doc.setTextColor(50, 55, 60);
        doc.setFontSize(9);
        doc.setFont('times', 'normal');
        doc.text(`Fully Met`, legendX + 12, yPos + 3);
        doc.setFont('times', 'bold');
        doc.text(`${stats.fullyMet}`, legendX + 12, yPos + 10);
        doc.setFont('times', 'normal');
        doc.setTextColor(100, 105, 115);
        doc.text(`(${Math.round(fullyMetPct)}%)`, legendX + 22, yPos + 10);

        legendX += 50;

        // Partially Met legend
        doc.setFillColor(...pieColors.partial);
        doc.roundedRect(legendX, yPos - 3, 8, 8, 1, 1, 'F');
        doc.setTextColor(50, 55, 60);
        doc.setFont('times', 'normal');
        doc.text(`Partial`, legendX + 12, yPos + 3);
        doc.setFont('times', 'bold');
        doc.text(`${stats.partial}`, legendX + 12, yPos + 10);
        doc.setFont('times', 'normal');
        doc.setTextColor(100, 105, 115);
        doc.text(`(${Math.round(partialPct)}%)`, legendX + 20, yPos + 10);

        legendX += 45;

        // Not Met legend
        doc.setFillColor(...pieColors.notMet);
        doc.roundedRect(legendX, yPos - 3, 8, 8, 1, 1, 'F');
        doc.setTextColor(50, 55, 60);
        doc.setFont('times', 'normal');
        doc.text(`Not Met`, legendX + 12, yPos + 3);
        doc.setFont('times', 'bold');
        doc.text(`${stats.notMet}`, legendX + 12, yPos + 10);
        doc.setFont('times', 'normal');
        doc.setTextColor(100, 105, 115);
        doc.text(`(${Math.round(notMetPct)}%)`, legendX + 20, yPos + 10);

        yPos += 30;

        // Summary statistics in clean layout
        doc.setFillColor(248, 250, 252);
        doc.roundedRect(30, yPos, pageWidth - 60, 35, 3, 3, 'F');

        doc.setTextColor(30, 58, 95);
        doc.setFontSize(10);
        doc.setFont('times', 'bold');
        doc.text('Assessment Overview', pageWidth / 2, yPos + 10, { align: 'center' });

        doc.setFont('times', 'normal');
        doc.setFontSize(9);
        doc.setTextColor(60, 65, 70);
        doc.text(`Total Sub-Standards: ${stats.total}`, 50, yPos + 22);
        doc.text(`Scored: ${stats.scored}`, pageWidth / 2 - 20, yPos + 22);
        doc.text(`N/A: ${stats.na}`, pageWidth - 70, yPos + 22);

        doc.setTextColor(100, 50, 30);
        doc.setFont('times', 'bold');
        doc.text(`Deficiency Rate: ${Math.round(partialPct + notMetPct)}%`, pageWidth / 2, yPos + 30, { align: 'center' });

        // ==================== FOOTER ON ALL PAGES ====================
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
          doc.setPage(i);

          // Footer line
          doc.setDrawColor(200, 200, 200);
          doc.line(15, pageHeight - 15, pageWidth - 15, pageHeight - 15);

          // Footer text
          doc.setFontSize(8);
          doc.setFont('times', 'italic');
          doc.setTextColor(150, 150, 150);
          doc.text(`Generated by StandardsHub`, 15, pageHeight - 10);
          doc.text(`Page ${i} of ${pageCount}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
          doc.text(`ID: ${survey.id.substring(0, 15)}...`, pageWidth - 15, pageHeight - 10, { align: 'right' });
        }

        // Generate filename and download
        const centerNameClean = (details.centerName || 'Assessment').replace(/[^a-zA-Z0-9]/g, '_');
        const date = new Date().toISOString().split('T')[0];
        doc.save(`StandardsHub_${centerNameClean}_${date}.pdf`);

        setExportMessage('PDF report downloaded successfully!');
        setTimeout(() => setExportMessage(''), 3000);
      };

      // Login Screen
      if (!isAuthenticated) {
        return (
          <div style={{
            minHeight: '100vh',
            background: 'linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            padding: '20px'
          }}>
            <div style={{
              background: 'white',
              borderRadius: '24px',
              padding: '48px',
              maxWidth: '420px',
              width: '100%',
              boxShadow: '0 25px 50px rgba(0,0,0,0.1)',
              textAlign: 'center'
            }}>
              {/* Logo */}
              <div style={{
                width: '90px',
                height: '90px',
                background: 'white',
                borderRadius: '20px',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                margin: '0 auto 24px',
                boxShadow: '0 12px 30px rgba(30, 58, 95, 0.15)',
                padding: '12px',
                border: '1px solid #e2e8f0'
              }}>
                <img src="assets/logo-sh.png" alt="StandardsHub" style={{ width: '100%', height: '100%', objectFit: 'contain' }} />
              </div>

              <h1 style={{ fontSize: '24px', fontWeight: 700, color: '#1e3a5f', marginBottom: '8px' }}>
                Assessment Portal
              </h1>

              {/* Show center name if available */}
              {centerName && (
                <div style={{
                  background: 'linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%)',
                  padding: '12px 16px',
                  borderRadius: '10px',
                  marginBottom: '20px',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '10px'
                }}>
                  <div style={{
                    width: '36px',
                    height: '36px',
                    background: '#27ae60',
                    borderRadius: '10px',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center'
                  }}>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                      <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                      <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                  </div>
                  <div style={{ textAlign: 'left' }}>
                    <div style={{ fontSize: '11px', color: '#166534', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Welcome</div>
                    <div style={{ fontSize: '15px', fontWeight: 700, color: '#15803d' }}>{centerName}</div>
                  </div>
                </div>
              )}

              <p style={{ color: '#64748b', fontSize: '14px', marginBottom: '24px' }}>
                Enter your password to view the assessment
              </p>

              {error && (
                <div style={{
                  background: '#fef2f2',
                  color: '#dc2626',
                  padding: '12px 16px',
                  borderRadius: '10px',
                  marginBottom: '20px',
                  fontSize: '14px',
                  fontWeight: 500,
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px'
                }}>
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                  </svg>
                  {error}
                </div>
              )}

              <div style={{ textAlign: 'left', marginBottom: '24px' }}>
                <label style={{ fontSize: '13px', fontWeight: 600, color: '#374151', display: 'block', marginBottom: '8px' }}>
                  Access Password
                </label>
                <input
                  type="password"
                  value={password}
                  onChange={e => setPassword(e.target.value.toUpperCase())}
                  maxLength={6}
                  style={{
                    width: '100%',
                    padding: '16px 20px',
                    borderRadius: '12px',
                    border: '2px solid #e2e8f0',
                    fontSize: '18px',
                    fontWeight: 600,
                    letterSpacing: '4px',
                    textAlign: 'center',
                    boxSizing: 'border-box',
                    textTransform: 'uppercase',
                    transition: 'all 0.2s',
                    background: '#fafafa'
                  }}
                  onFocus={e => { e.target.style.borderColor = '#1e3a5f'; e.target.style.background = 'white'; }}
                  onBlur={e => { e.target.style.borderColor = '#e2e8f0'; e.target.style.background = '#fafafa'; }}
                  onKeyPress={e => e.key === 'Enter' && handleLogin()}
                  autoFocus
                />
              </div>

              <button
                onClick={handleLogin}
                style={{
                  width: '100%',
                  padding: '16px',
                  background: 'linear-gradient(135deg, #1e3a5f 0%, #2d5a8a 100%)',
                  color: 'white',
                  border: 'none',
                  borderRadius: '12px',
                  fontSize: '16px',
                  fontWeight: 700,
                  cursor: 'pointer',
                  boxShadow: '0 8px 20px rgba(30, 58, 95, 0.3)',
                  transition: 'all 0.2s',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  gap: '10px'
                }}
              >
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                  <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
                View Assessment
              </button>

              <p style={{ color: '#94a3b8', fontSize: '12px', marginTop: '24px' }}>
                StandardsHub  Secure Assessment Portal
              </p>
            </div>
          </div>
        );
      }

      // Authenticated View
      const details = survey.assessmentDetails || {};
      const stats = survey.stats || {};
      const scores = survey.scores || {};
      const percentage = stats.percentage || 0;

      // Compliance level
      const getComplianceLevel = (pct) => {
        if (pct >= 90) return { label: 'Excellent', color: '#27ae60', bg: '#dcfce7' };
        if (pct >= 80) return { label: 'Good', color: '#3498db', bg: '#dbeafe' };
        if (pct >= 70) return { label: 'Satisfactory', color: '#f39c12', bg: '#fef3c7' };
        return { label: 'Needs Improvement', color: '#e74c3c', bg: '#fee2e2' };
      };
      const compliance = getComplianceLevel(percentage);

      // Get all scored items grouped by chapter for detailed view (with standard text)
      const getDetailedItems = () => {
        const config = survey.assessmentDetails?.configuration || 'B';

        // Chapter code to full name mapping - in proper domain order
        const chapterOrder = ['LD', 'PC', 'DL', 'IPC', 'MOI', 'FMS'];
        const chapterNames = {
          'LD': 'Leadership',
          'PC': 'Provision of Care',
          'DL': 'Dental Laboratory',
          'IPC': 'Infection Prevention and Control',
          'MOI': 'Management of Information',
          'FMS': 'Facility Management and Safety'
        };

        // FIXED: Build lookup from chapter definitions for text and activityType
        const chaptersToUse = config === 'A1' ? chapters_A1 : config === 'A2' ? chapters_A2 : chapters_B;
        const substandardLookup = {};
        chaptersToUse.forEach(chapter => {
          if (chapter.standards) {
            chapter.standards.forEach(std => {
              if (std.substandards) {
                std.substandards.forEach(sub => {
                  substandardLookup[sub.id] = {
                    text: sub.text,
                    activityType: sub.activityType || 'DOC'
                  };
                });
              }
            });
          }
        });

        // Activity type labels
        const activityLabelsMap = {
          'DOC': 'Document Review',
          'OBS': 'Observation',
          'INT': 'Interview',
          'PER': 'Personnel File',
          'DEN': 'Dental Record'
        };

        const result = [];

        // Iterate through scores and group by chapter
        Object.entries(scores).forEach(([subId, scoreData]) => {
          if (scoreData && scoreData.value !== undefined && scoreData.value !== null && scoreData.value !== 'NA' && scoreData.value !== -1) {
            // Extract chapter code from substandard ID (e.g., "LD.1.1.1" -> "LD")
            const parts = subId.split('.');
            const chapterCode = parts[0];

            let chapter = result.find(c => c.code === chapterCode);
            if (!chapter) {
              chapter = {
                code: chapterCode,
                name: chapterNames[chapterCode] || chapterCode,
                items: []
              };
              result.push(chapter);
            }

            // FIXED: Look up text from chapter definitions, use correct field names
            const lookup = substandardLookup[subId] || {};
            chapter.items.push({
              id: subId,
              score: scoreData.value,
              text: lookup.text || subId, // FIXED: Get from lookup, not scoreData
              finding: scoreData.findings || '', // FIXED: Use 'findings' not 'comment'
              recommendation: scoreData.recommendations || '', // FIXED: Use 'recommendations' plural
              activityType: lookup.activityType || 'DOC',
              activityLabel: activityLabelsMap[lookup.activityType] || 'Document Review',
              location: scoreData.location || '',
              scoredAt: scoreData.scoredAt
            });
          }
        });

        // Sort chapters in proper domain order (LD, PC, DL, IPC, MOI, FMS)
        result.sort((a, b) => {
          const orderA = chapterOrder.indexOf(a.code);
          const orderB = chapterOrder.indexOf(b.code);
          if (orderA === -1 && orderB === -1) return a.code.localeCompare(b.code);
          if (orderA === -1) return 1;
          if (orderB === -1) return -1;
          return orderA - orderB;
        });

        // Sort items within each chapter
        result.forEach(ch => {
          ch.items.sort((a, b) => a.id.localeCompare(b.id));
        });

        return result;
      };

      const detailedChapters = getDetailedItems();

      // Score button component for read-only display
      const ScoreButtonReadOnly = ({ value, label, type, isSelected }) => {
        const colors = {
          'na': { bg: '#f1f5f9', color: '#64748b', activeBg: '#64748b' },
          'not-met': { bg: '#fef2f2', color: '#dc2626', activeBg: '#dc2626' },
          'partial': { bg: '#fffbeb', color: '#d97706', activeBg: '#d97706' },
          'full': { bg: '#f0fdf4', color: '#16a34a', activeBg: '#16a34a' }
        };
        const c = colors[type];
        return (
          <div style={{
            padding: '8px 14px',
            borderRadius: '8px',
            fontSize: '12px',
            fontWeight: 600,
            background: isSelected ? c.activeBg : c.bg,
            color: isSelected ? 'white' : c.color,
            opacity: isSelected ? 1 : 0.4,
            cursor: 'default',
            border: isSelected ? 'none' : `1px solid ${c.color}20`,
            transition: 'all 0.2s'
          }}>
            {label}
          </div>
        );
      };

      return (
        <div style={{ minHeight: '100vh', background: '#f8fafc' }}>
          {/* Header - Mobile Responsive */}
          <header style={{
            background: 'linear-gradient(135deg, #1e3a5f 0%, #2d5a8a 50%, #1abc9c 100%)',
            color: 'white',
            padding: isMobile ? '12px 16px' : '16px 40px',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center'
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: isMobile ? '10px' : '16px' }}>
              <div style={{ width: isMobile ? '36px' : '44px', height: isMobile ? '36px' : '44px', background: 'rgba(255,255,255,0.95)', borderRadius: '10px', padding: '5px' }}>
                <img src="assets/logo-sh.png" alt="StandardsHub" style={{ width: '100%', height: '100%', objectFit: 'contain' }} />
              </div>
              <div>
                <h1 style={{ fontSize: isMobile ? '15px' : '18px', fontWeight: 700, margin: 0 }}>StandardsHub</h1>
                {!isMobile && <p style={{ fontSize: '12px', opacity: 0.8, margin: 0 }}>Assessment Portal</p>}
              </div>
            </div>
            {!isMobile && (
              <div style={{ fontSize: '13px', opacity: 0.9 }}>
                <strong>{details.centerName}</strong>
              </div>
            )}
          </header>

          {/* Main Content */}
          <main style={{ maxWidth: '1100px', margin: '0 auto', padding: '32px 24px' }}>

            {/* Modern Executive Summary Card */}
            <div style={{
              background: 'white',
              borderRadius: '24px',
              overflow: 'hidden',
              boxShadow: '0 4px 24px rgba(0,0,0,0.06)',
              marginBottom: '24px'
            }}>
              {/* Top Section - Score Hero - Mobile Responsive */}
              <div style={{
                background: 'linear-gradient(135deg, #1e3a5f 0%, #2d5a8a 100%)',
                padding: isMobile ? '24px 20px' : '32px 40px',
                color: 'white',
                display: 'flex',
                flexDirection: isMobile ? 'column' : 'row',
                justifyContent: 'space-between',
                alignItems: 'center',
                textAlign: isMobile ? 'center' : 'left',
                gap: isMobile ? '20px' : '24px'
              }}>
                <div>
                  <div style={{ fontSize: isMobile ? '11px' : '13px', opacity: 0.8, marginBottom: '4px', textTransform: 'uppercase', letterSpacing: '1px' }}>
                    Overall Compliance Score
                  </div>
                  <div style={{ fontSize: isMobile ? '48px' : '56px', fontWeight: 700, lineHeight: 1 }}>
                    {percentage}%
                  </div>
                  <div style={{
                    display: 'inline-block',
                    marginTop: '12px',
                    padding: '6px 16px',
                    background: compliance.color,
                    borderRadius: '20px',
                    fontSize: '13px',
                    fontWeight: 600
                  }}>
                    {compliance.label}
                  </div>
                </div>
                <div style={{ display: 'flex', gap: isMobile ? '8px' : '12px', flexWrap: 'wrap', justifyContent: 'center' }}>
                  <div style={{ textAlign: 'center', padding: isMobile ? '12px 16px' : '16px 24px', background: 'rgba(255,255,255,0.1)', borderRadius: isMobile ? '12px' : '16px', backdropFilter: 'blur(10px)', minWidth: isMobile ? '70px' : 'auto' }}>
                    <div style={{ fontSize: isMobile ? '22px' : '28px', fontWeight: 700, color: '#86efac' }}>{stats.fullyMet || 0}</div>
                    <div style={{ fontSize: isMobile ? '10px' : '11px', opacity: 0.8, marginTop: '4px' }}>Fully Met</div>
                  </div>
                  <div style={{ textAlign: 'center', padding: isMobile ? '12px 16px' : '16px 24px', background: 'rgba(255,255,255,0.1)', borderRadius: isMobile ? '12px' : '16px', backdropFilter: 'blur(10px)', minWidth: isMobile ? '70px' : 'auto' }}>
                    <div style={{ fontSize: isMobile ? '22px' : '28px', fontWeight: 700, color: '#fde047' }}>{stats.partial || 0}</div>
                    <div style={{ fontSize: isMobile ? '10px' : '11px', opacity: 0.8, marginTop: '4px' }}>Partial</div>
                  </div>
                  <div style={{ textAlign: 'center', padding: isMobile ? '12px 16px' : '16px 24px', background: 'rgba(255,255,255,0.1)', borderRadius: isMobile ? '12px' : '16px', backdropFilter: 'blur(10px)', minWidth: isMobile ? '70px' : 'auto' }}>
                    <div style={{ fontSize: isMobile ? '22px' : '28px', fontWeight: 700, color: '#fca5a5' }}>{stats.notMet || 0}</div>
                    <div style={{ fontSize: isMobile ? '10px' : '11px', opacity: 0.8, marginTop: '4px' }}>Not Met</div>
                  </div>
                </div>
              </div>

              {/* Bottom Section - Info & Actions */}
              <div style={{
                padding: isMobile ? '16px 20px' : '24px 40px',
                display: 'flex',
                flexDirection: isMobile ? 'column' : 'row',
                justifyContent: 'space-between',
                alignItems: isMobile ? 'stretch' : 'center',
                gap: '16px'
              }}>
                <div style={{ textAlign: isMobile ? 'center' : 'left' }}>
                  <h2 style={{ fontSize: isMobile ? '16px' : '20px', fontWeight: 700, color: '#1e3a5f', margin: '0 0 4px 0' }}>{details.centerName}</h2>
                  <p style={{ color: '#64748b', margin: 0, fontSize: isMobile ? '12px' : '14px' }}>
                    Completed {new Date(survey.submittedAt || survey.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}  {stats.scored || 0} items
                  </p>
                </div>
                <div style={{ display: 'flex', gap: '12px', flexDirection: isMobile ? 'column' : 'row' }}>
                  {/* View Details - Hidden on Mobile */}
                  {!isMobile && (
                    <button onClick={() => setShowFullDetails(!showFullDetails)} style={{
                      padding: '12px 20px', background: '#1e3a5f', color: 'white', border: 'none',
                      borderRadius: '10px', fontSize: '14px', fontWeight: 600, cursor: 'pointer',
                      display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px'
                    }}>
                       {showFullDetails ? 'Hide Details' : 'View Full Details'}
                    </button>
                  )}
                  {/* Mobile message for View Details */}
                  {isMobile && (
                    <div style={{
                      padding: '10px 16px',
                      background: '#f1f5f9',
                      borderRadius: '8px',
                      fontSize: '12px',
                      color: '#64748b',
                      textAlign: 'center'
                    }}>
                       Full details available on desktop
                    </div>
                  )}
                  {/* PDF & Excel - Always Available with proper SVG icons matching main app */}
                  <div style={{ display: 'flex', gap: '12px' }}>
                    <button onClick={exportToPDF} style={{
                      padding: isMobile ? '14px 0' : '12px 20px',
                      flex: isMobile ? 1 : 'none',
                      background: 'linear-gradient(135deg, #c0392b 0%, #a93226 100%)',
                      color: 'white', border: 'none',
                      borderRadius: '10px', fontSize: '14px', fontWeight: 600, cursor: 'pointer',
                      display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px',
                      boxShadow: '0 4px 12px rgba(192, 57, 43, 0.3)'
                    }} title="Export to PDF">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                        <polyline points="14,2 14,8 20,8" />
                        <line x1="12" y1="18" x2="12" y2="12" />
                        <line x1="9" y1="15" x2="15" y2="15" />
                      </svg>
                      PDF
                    </button>
                    <button onClick={exportToExcel} style={{
                      padding: isMobile ? '14px 0' : '12px 20px',
                      flex: isMobile ? 1 : 'none',
                      background: 'linear-gradient(135deg, #217346 0%, #1d6b3f 100%)',
                      color: 'white', border: 'none',
                      borderRadius: '10px', fontSize: '14px', fontWeight: 600, cursor: 'pointer',
                      display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px',
                      boxShadow: '0 4px 12px rgba(33, 115, 70, 0.3)'
                    }} title="Export to Excel">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                        <polyline points="14,2 14,8 20,8" />
                        <line x1="8" y1="13" x2="16" y2="13" />
                        <line x1="8" y1="17" x2="16" y2="17" />
                      </svg>
                      Excel
                    </button>
                  </div>
                </div>
              </div>
            </div>

            {/* Export Message */}
            {exportMessage && (
              <div style={{ textAlign: 'center', marginBottom: '24px', padding: '12px 20px', background: '#dcfce7', color: '#166534', borderRadius: '10px', fontSize: '14px', fontWeight: 500 }}>
                {exportMessage}
              </div>
            )}

            {/* Full Assessment Details - Same structure as main app */}
            {showFullDetails && (
              <div style={{ background: 'white', borderRadius: '20px', overflow: 'hidden', boxShadow: '0 4px 24px rgba(0,0,0,0.06)' }}>
                <div style={{ padding: '24px 32px', borderBottom: '1px solid #e2e8f0' }}>
                  <h3 style={{ fontSize: '20px', fontWeight: 700, color: '#1e3a5f', margin: 0 }}>
                    Complete Assessment Details
                  </h3>
                  <p style={{ color: '#64748b', fontSize: '14px', margin: '4px 0 0' }}>
                    All {stats.scored || 0} scored items with findings and action plans
                  </p>
                </div>

                {/* Filter Bar - Finding Summary & Survey Activity */}
                <div style={{ padding: '16px 32px', background: '#f8fafc', borderBottom: '1px solid #e2e8f0' }}>
                  {/* Finding Summary */}
                  <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap', marginBottom: '16px' }}>
                    <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                      <span style={{ fontSize: '13px', color: '#64748b', fontWeight: 500 }}>Score:</span>
                      <button onClick={() => setScoreFilter('all')} style={{
                        padding: '6px 12px', borderRadius: '20px', border: 'none', cursor: 'pointer',
                        background: scoreFilter === 'all' ? '#1e3a5f' : '#e2e8f0',
                        color: scoreFilter === 'all' ? 'white' : '#64748b', fontSize: '12px', fontWeight: 600
                      }}>All</button>
                      <button onClick={() => setScoreFilter('not-met')} style={{
                        padding: '6px 12px', borderRadius: '20px', border: 'none', cursor: 'pointer',
                        background: scoreFilter === 'not-met' ? '#dc2626' : '#fee2e2',
                        color: scoreFilter === 'not-met' ? 'white' : '#dc2626', fontSize: '12px', fontWeight: 600
                      }}>Not Met ({detailedChapters.reduce((sum, ch) => sum + ch.items.filter(i => i.score === 0).length, 0)})</button>
                      <button onClick={() => setScoreFilter('partial')} style={{
                        padding: '6px 12px', borderRadius: '20px', border: 'none', cursor: 'pointer',
                        background: scoreFilter === 'partial' ? '#d97706' : '#fef3c7',
                        color: scoreFilter === 'partial' ? 'white' : '#d97706', fontSize: '12px', fontWeight: 600
                      }}>Partial ({detailedChapters.reduce((sum, ch) => sum + ch.items.filter(i => i.score === 1).length, 0)})</button>
                      <button onClick={() => setScoreFilter('full')} style={{
                        padding: '6px 12px', borderRadius: '20px', border: 'none', cursor: 'pointer',
                        background: scoreFilter === 'full' ? '#16a34a' : '#dcfce7',
                        color: scoreFilter === 'full' ? 'white' : '#16a34a', fontSize: '12px', fontWeight: 600
                      }}>Fully Met ({detailedChapters.reduce((sum, ch) => sum + ch.items.filter(i => i.score === 2).length, 0)})</button>
                    </div>
                  </div>
                  {/* Survey Activity Filter */}
                  <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap', alignItems: 'center' }}>
                    <span style={{ fontSize: '13px', color: '#64748b', fontWeight: 500 }}>Survey Activity:</span>
                    <button onClick={() => setActivityFilter('all')} style={{
                      padding: '6px 12px', borderRadius: '20px', border: 'none', cursor: 'pointer',
                      background: activityFilter === 'all' ? '#1e3a5f' : '#e2e8f0',
                      color: activityFilter === 'all' ? 'white' : '#64748b', fontSize: '12px', fontWeight: 600
                    }}>All</button>
                    <button onClick={() => setActivityFilter('DOC')} style={{
                      padding: '6px 12px', borderRadius: '20px', border: 'none', cursor: 'pointer',
                      background: activityFilter === 'DOC' ? '#475569' : '#e2e8f0',
                      color: activityFilter === 'DOC' ? 'white' : '#475569', fontSize: '12px', fontWeight: 600
                    }}> Document Review</button>
                    <button onClick={() => setActivityFilter('OBS')} style={{
                      padding: '6px 12px', borderRadius: '20px', border: 'none', cursor: 'pointer',
                      background: activityFilter === 'OBS' ? '#166534' : '#dcfce7',
                      color: activityFilter === 'OBS' ? 'white' : '#166534', fontSize: '12px', fontWeight: 600
                    }}> Observation</button>
                    <button onClick={() => setActivityFilter('INT')} style={{
                      padding: '6px 12px', borderRadius: '20px', border: 'none', cursor: 'pointer',
                      background: activityFilter === 'INT' ? '#7c3aed' : '#f3e8ff',
                      color: activityFilter === 'INT' ? 'white' : '#7c3aed', fontSize: '12px', fontWeight: 600
                    }}> Interview</button>
                    <button onClick={() => setActivityFilter('PER')} style={{
                      padding: '6px 12px', borderRadius: '20px', border: 'none', cursor: 'pointer',
                      background: activityFilter === 'PER' ? '#c2410c' : '#ffedd5',
                      color: activityFilter === 'PER' ? 'white' : '#c2410c', fontSize: '12px', fontWeight: 600
                    }}> Personnel File</button>
                    <button onClick={() => setActivityFilter('DEN')} style={{
                      padding: '6px 12px', borderRadius: '20px', border: 'none', cursor: 'pointer',
                      background: activityFilter === 'DEN' ? '#1d4ed8' : '#dbeafe',
                      color: activityFilter === 'DEN' ? 'white' : '#1d4ed8', fontSize: '12px', fontWeight: 600
                    }}> Dental Record</button>
                  </div>
                </div>

                {/* Domain-by-Domain - Matching main app structure */}
                {detailedChapters.map(chapter => {
                  // Apply filters to items
                  const filteredItems = chapter.items.filter(i => {
                    const scoreMatch = scoreFilter === 'all' ||
                      (scoreFilter === 'not-met' && i.score === 0) ||
                      (scoreFilter === 'partial' && i.score === 1) ||
                      (scoreFilter === 'full' && i.score === 2);
                    const activityMatch = activityFilter === 'all' || i.activityType === activityFilter;
                    return scoreMatch && activityMatch;
                  });

                  // Skip chapter if no items match filter
                  if (filteredItems.length === 0) return null;

                  const fullyMet = filteredItems.filter(i => i.score === 2).length;
                  const partial = filteredItems.filter(i => i.score === 1).length;
                  const notMet = filteredItems.filter(i => i.score === 0).length;
                  const chapterTotal = fullyMet + partial + notMet;
                  const chapterPct = chapterTotal > 0 ? Math.round(((fullyMet * 2 + partial) / (chapterTotal * 2)) * 100) : 0;

                  return (
                    <div key={chapter.code} style={{ borderBottom: '1px solid #e2e8f0' }}>
                      {/* Domain Header */}
                      <div style={{
                        background: 'linear-gradient(90deg, #f8fafc 0%, #f1f5f9 100%)',
                        padding: '16px 32px',
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        borderBottom: '1px solid #e2e8f0'
                      }}>
                        <div>
                          <span style={{ fontWeight: 700, color: '#1e3a5f', fontSize: '16px' }}>{chapter.code}</span>
                          <span style={{ color: '#64748b', marginLeft: '8px' }}> {chapter.name}</span>
                        </div>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                          <span style={{ fontSize: '13px', color: '#64748b' }}>
                            <span style={{ color: '#16a34a', fontWeight: 600 }}>{fullyMet}</span> /
                            <span style={{ color: '#d97706', fontWeight: 600, marginLeft: '4px' }}>{partial}</span> /
                            <span style={{ color: '#dc2626', fontWeight: 600, marginLeft: '4px' }}>{notMet}</span>
                          </span>
                          <span style={{
                            padding: '4px 12px',
                            background: chapterPct >= 90 ? '#dcfce7' : chapterPct >= 70 ? '#fef3c7' : '#fee2e2',
                            color: chapterPct >= 90 ? '#166534' : chapterPct >= 70 ? '#92400e' : '#991b1b',
                            borderRadius: '20px',
                            fontWeight: 700,
                            fontSize: '14px'
                          }}>{chapterPct}%</span>
                        </div>
                      </div>

                      {/* Standards - Filtered by Score and Survey Activity */}
                      <div style={{ padding: '16px 32px' }}>
                        {filteredItems.map(item => {
                          const hasIssue = item.score === 0 || item.score === 1;
                          const borderColor = item.score === 2 ? '#16a34a' : item.score === 1 ? '#d97706' : item.score === 0 ? '#dc2626' : '#94a3b8';

                          // Smart corrective action generator (same logic as PDF export)
                          const generateCorrectiveActionView = () => {
                            if (item.recommendation && item.recommendation.trim()) return item.recommendation;

                            const text = (item.text || '').toLowerCase();
                            const isNotMet = item.score === 0;

                            if (text.includes('policy') || text.includes('procedure') || text.includes('guideline')) {
                              return isNotMet
                                ? 'Develop and approve written policy/procedure. Assign owner, set review date, and distribute to all relevant staff.'
                                : 'Review existing policy for completeness. Update gaps, obtain approval, and ensure staff acknowledgment.';
                            }
                            if (text.includes('document') || text.includes('record') || text.includes('log') || text.includes('register')) {
                              return isNotMet
                                ? 'Create standardized documentation template. Implement tracking system and assign responsibility for maintenance.'
                                : 'Audit current records for completeness. Address gaps and implement regular review schedule.';
                            }
                            if (text.includes('train') || text.includes('educat') || text.includes('orient') || text.includes('competenc')) {
                              return isNotMet
                                ? 'Develop training curriculum and schedule. Document attendance and competency verification for all staff.'
                                : 'Enhance training program. Add practical assessments and update training materials.';
                            }
                            if (text.includes('evaluat') || text.includes('assess') || text.includes('monitor') || text.includes('audit')) {
                              return isNotMet
                                ? 'Establish evaluation criteria and schedule. Create assessment tools and assign responsible personnel.'
                                : 'Strengthen monitoring frequency. Improve documentation of findings and follow-up actions.';
                            }
                            if (text.includes('safety') || text.includes('infect') || text.includes('steril') || text.includes('hygiene')) {
                              return isNotMet
                                ? 'Implement comprehensive safety/infection control program. Train all staff and establish monitoring system.'
                                : 'Review current practices against standards. Address gaps and increase compliance monitoring.';
                            }
                            if (text.includes('equipment') || text.includes('maintain') || text.includes('calibrat') || text.includes('device')) {
                              return isNotMet
                                ? 'Create equipment inventory and maintenance schedule. Document all maintenance activities and calibrations.'
                                : 'Update maintenance logs. Ensure scheduled maintenance is completed and documented.';
                            }
                            if (text.includes('patient') || text.includes('consent') || text.includes('right') || text.includes('care plan')) {
                              return isNotMet
                                ? 'Develop patient-centered protocols. Train staff on rights and documentation requirements.'
                                : 'Audit patient records for compliance. Improve documentation consistency.';
                            }
                            if (text.includes('quality') || text.includes('indicator') || text.includes('performance') || text.includes('benchmark')) {
                              return isNotMet
                                ? 'Define quality indicators with targets. Implement data collection and analysis system.'
                                : 'Review indicator definitions and targets. Improve data accuracy and reporting frequency.';
                            }
                            return isNotMet
                              ? 'Develop implementation plan with clear objectives, responsible persons, and timeline. Document all activities.'
                              : 'Review current practices, identify gaps, and implement improvements. Monitor compliance.';
                          };

                          return (
                            <div key={item.id} style={{
                              background: '#fff',
                              border: '1px solid #e2e8f0',
                              borderLeft: `4px solid ${borderColor}`,
                              borderRadius: '12px',
                              marginBottom: '12px',
                              overflow: 'hidden'
                            }}>
                              {/* Standard Header with ID, Priority, and Survey Activity */}
                              <div style={{ padding: '14px 16px', borderBottom: '1px solid #f1f5f9', background: '#fafbfc', display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '8px' }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '12px', flexWrap: 'wrap' }}>
                                  <span style={{ fontWeight: 700, color: '#1e3a5f', fontSize: '14px' }}>{item.id}</span>
                                  {hasIssue && (
                                    <span style={{
                                      padding: '2px 8px',
                                      background: item.score === 0 ? '#fef2f2' : '#fffbeb',
                                      color: item.score === 0 ? '#dc2626' : '#d97706',
                                      fontSize: '11px',
                                      fontWeight: 600,
                                      borderRadius: '4px'
                                    }}>
                                      {item.score === 0 ? 'HIGH PRIORITY' : 'MEDIUM PRIORITY'}
                                    </span>
                                  )}
                                </div>
                                {/* Survey Activity Badge */}
                                <span style={{
                                  padding: '3px 10px',
                                  background: item.activityType === 'DOC' ? '#e2e8f0' :
                                              item.activityType === 'OBS' ? '#dcfce7' :
                                              item.activityType === 'INT' ? '#f3e8ff' :
                                              item.activityType === 'PER' ? '#ffedd5' :
                                              item.activityType === 'DEN' ? '#dbeafe' : '#f1f5f9',
                                  color: item.activityType === 'DOC' ? '#475569' :
                                         item.activityType === 'OBS' ? '#166534' :
                                         item.activityType === 'INT' ? '#7c3aed' :
                                         item.activityType === 'PER' ? '#c2410c' :
                                         item.activityType === 'DEN' ? '#1d4ed8' : '#64748b',
                                  fontSize: '10px',
                                  fontWeight: 600,
                                  borderRadius: '4px',
                                  textTransform: 'uppercase'
                                }}>
                                  {item.activityLabel || 'Document Review'}
                                </span>
                              </div>

                              {/* Standard Body Text - FULL TEXT like in PDF */}
                              {item.text && (
                                <div style={{ padding: '14px 16px', background: '#f8fafc', borderBottom: '1px solid #f1f5f9' }}>
                                  <div style={{ fontSize: '13px', color: '#374151', lineHeight: 1.6 }}>{item.text}</div>
                                </div>
                              )}

                              {/* Standard Body - Score Buttons */}
                              <div style={{ padding: '14px 16px' }}>
                                <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                                  <ScoreButtonReadOnly value="NA" label="N/A" type="na" isSelected={item.score === 'NA'} />
                                  <ScoreButtonReadOnly value={0} label="Not Met" type="not-met" isSelected={item.score === 0} />
                                  <ScoreButtonReadOnly value={1} label="Partially Met" type="partial" isSelected={item.score === 1} />
                                  <ScoreButtonReadOnly value={2} label="Fully Met" type="full" isSelected={item.score === 2} />
                                </div>

                                {/* Finding if exists */}
                                {item.finding && (
                                  <div style={{
                                    marginTop: '12px',
                                    padding: '12px',
                                    background: '#fffbeb',
                                    borderRadius: '8px',
                                    border: '1px solid #fef3c7'
                                  }}>
                                    <div style={{ fontSize: '11px', color: '#92400e', fontWeight: 600, marginBottom: '4px', textTransform: 'uppercase' }}>
                                       Finding
                                    </div>
                                    <div style={{ fontSize: '13px', color: '#374151', lineHeight: 1.5, fontStyle: 'italic' }}>{item.finding}</div>
                                  </div>
                                )}

                                {/* Action Plan for items with issues - inline like PDF with SMART corrective action */}
                                {hasIssue && (
                                  <div style={{
                                    marginTop: '12px',
                                    padding: '12px',
                                    background: '#f0fdf4',
                                    borderRadius: '8px',
                                    borderLeft: `3px solid #16a34a`
                                  }}>
                                    <div style={{ fontSize: '11px', color: '#166534', fontWeight: 600, marginBottom: '4px', textTransform: 'uppercase' }}>
                                       Corrective Action Plan
                                    </div>
                                    <div style={{ fontSize: '13px', color: '#166534', lineHeight: 1.5 }}>
                                      {generateCorrectiveActionView()}
                                    </div>
                                    <div style={{ marginTop: '8px', fontSize: '12px', color: '#64748b', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                      <span>
                                        Timeline: <span style={{ fontWeight: 600, color: item.score === 0 ? '#dc2626' : '#d97706' }}>
                                          {item.score === 0 ? '1-4 weeks' : '2-5 weeks'}
                                        </span>
                                      </span>
                                      <span style={{ fontWeight: 600, color: item.score === 0 ? '#dc2626' : '#d97706' }}>
                                        {item.score === 0 ? 'HIGH PRIORITY' : 'MEDIUM PRIORITY'}
                                      </span>
                                    </div>
                                  </div>
                                )}
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  );
                })}

                {detailedChapters.length === 0 && (
                  <div style={{ textAlign: 'center', padding: '48px', color: '#64748b' }}>
                    <p>No detailed scoring data available.</p>
                  </div>
                )}
              </div>
            )}
          </main>

          {/* Footer */}
          <footer style={{ textAlign: 'center', padding: '24px', color: '#94a3b8', fontSize: '13px' }}>
             2026 StandardsHub. Secure Assessment Portal.
          </footer>
        </div>
      );
    };

    // Share Card Page - Shows a beautiful card with password and Open Assessment button
    const ShareCardPage = ({ shareId }) => {
      const [shareData, setShareData] = useState(null);
      const [error, setError] = useState('');
      const [copied, setCopied] = useState(false);
      const [isMobile, setIsMobile] = useState(window.innerWidth <= 768);

      useEffect(() => {
        const checkMobile = () => setIsMobile(window.innerWidth <= 768);
        window.addEventListener('resize', checkMobile);
        return () => window.removeEventListener('resize', checkMobile);
      }, []);

      useEffect(() => {
        const shares = JSON.parse(localStorage.getItem('cbahi_shared_assessments') || '[]');
        const share = shares.find(s => s.shareId === shareId);
        if (share) {
          setShareData(share);
        } else {
          setError('Invalid or expired share link');
        }
      }, [shareId]);

      const copyPassword = () => {
        navigator.clipboard.writeText(shareData.password);
        setCopied(true);
        setTimeout(() => setCopied(false), 2000);
      };

      const openAssessment = () => {
        window.location.href = window.location.pathname + '?view=' + shareId;
      };

      if (error) {
        return (
          <div style={{
            minHeight: '100vh',
            background: 'linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            padding: '20px',
            fontFamily: "'Inter', -apple-system, sans-serif"
          }}>
            <div style={{
              background: 'white',
              borderRadius: '20px',
              padding: '40px',
              textAlign: 'center',
              boxShadow: '0 10px 40px rgba(0,0,0,0.1)'
            }}>
              <div style={{ fontSize: '48px', marginBottom: '16px' }}></div>
              <h2 style={{ color: '#e74c3c', marginBottom: '8px' }}>Link Invalid</h2>
              <p style={{ color: '#64748b' }}>{error}</p>
            </div>
          </div>
        );
      }

      if (!shareData) {
        return (
          <div style={{
            minHeight: '100vh',
            background: 'linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center'
          }}>
            <div style={{ color: '#64748b' }}>Loading...</div>
          </div>
        );
      }

      return (
        <div style={{
          minHeight: '100vh',
          background: 'linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          padding: '20px',
          fontFamily: "'Inter', -apple-system, sans-serif"
        }}>
          <div style={{ maxWidth: '420px', width: '100%' }}>
            {/* Card */}
            <div style={{
              background: 'linear-gradient(135deg, #1e3a5f 0%, #2c5282 100%)',
              borderRadius: '24px',
              padding: isMobile ? '28px' : '36px',
              color: 'white',
              position: 'relative',
              overflow: 'hidden',
              boxShadow: '0 25px 60px rgba(30, 58, 95, 0.4)'
            }}>
              {/* Decorative circles */}
              <div style={{ position: 'absolute', top: '-30px', right: '-30px', width: '120px', height: '120px', background: 'rgba(255,255,255,0.05)', borderRadius: '50%' }}></div>
              <div style={{ position: 'absolute', bottom: '-20px', left: '-20px', width: '80px', height: '80px', background: 'rgba(255,255,255,0.03)', borderRadius: '50%' }}></div>

              {/* Header */}
              <div style={{ display: 'flex', alignItems: 'center', gap: '14px', marginBottom: '24px', position: 'relative' }}>
                <div style={{
                  width: '48px',
                  height: '48px',
                  background: 'rgba(255,255,255,0.15)',
                  borderRadius: '14px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center'
                }}>
                  <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2">
                    <path d="M9 12l2 2 4-4"></path>
                    <circle cx="12" cy="12" r="10"></circle>
                  </svg>
                </div>
                <div>
                  <div style={{ fontWeight: 700, fontSize: '18px' }}>Assessment Ready</div>
                  <div style={{ fontSize: '13px', opacity: 0.7 }}>StandardsHub  CBAHI</div>
                </div>
              </div>

              {/* Center Name */}
              <div style={{
                fontSize: '22px',
                fontWeight: 700,
                marginBottom: '24px',
                lineHeight: 1.3
              }}>
                {shareData.centerName}
              </div>

              {/* Password Box */}
              <div style={{
                background: 'rgba(255,255,255,0.12)',
                borderRadius: '16px',
                padding: '20px',
                marginBottom: '20px'
              }}>
                <div style={{
                  fontSize: '11px',
                  textTransform: 'uppercase',
                  letterSpacing: '1.5px',
                  opacity: 0.6,
                  marginBottom: '10px',
                  textAlign: 'center'
                }}>
                  Access Password
                </div>
                <div style={{
                  fontSize: '32px',
                  fontWeight: 800,
                  fontFamily: 'monospace',
                  letterSpacing: '6px',
                  textAlign: 'center'
                }}>
                  {shareData.password}
                </div>
              </div>

              {/* Action Buttons */}
              <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                {/* Open Assessment Button */}
                <button
                  onClick={openAssessment}
                  style={{
                    width: '100%',
                    padding: '16px 24px',
                    background: 'white',
                    color: '#1e3a5f',
                    border: 'none',
                    borderRadius: '14px',
                    cursor: 'pointer',
                    fontWeight: 700,
                    fontSize: '16px',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '10px',
                    boxShadow: '0 4px 14px rgba(0,0,0,0.15)',
                    transition: 'all 0.2s'
                  }}
                >
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                    <polyline points="15 3 21 3 21 9"></polyline>
                    <line x1="10" y1="14" x2="21" y2="3"></line>
                  </svg>
                  Open Assessment
                </button>

                {/* Copy Password Button */}
                <button
                  onClick={copyPassword}
                  style={{
                    width: '100%',
                    padding: '14px 24px',
                    background: copied ? 'rgba(39, 174, 96, 0.2)' : 'rgba(255,255,255,0.1)',
                    color: 'white',
                    border: '1px solid rgba(255,255,255,0.2)',
                    borderRadius: '14px',
                    cursor: 'pointer',
                    fontWeight: 600,
                    fontSize: '14px',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '8px',
                    transition: 'all 0.2s'
                  }}
                >
                  {copied ? (
                    <>
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                        <polyline points="20 6 9 17 4 12"></polyline>
                      </svg>
                      Password Copied!
                    </>
                  ) : (
                    <>
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                      </svg>
                      Copy Password
                    </>
                  )}
                </button>
              </div>
            </div>

            {/* Footer */}
            <div style={{
              textAlign: 'center',
              marginTop: '20px',
              color: '#64748b',
              fontSize: '12px'
            }}>
              Powered by StandardsHub
            </div>
          </div>
        </div>
      );
    };

    const App = () => {
      // Check for shared view or card parameter
      const urlParams = new URLSearchParams(window.location.search);
      const sharedViewId = urlParams.get('view');
      const sharedCardId = urlParams.get('card');

      // If this is a card view, show the ShareCardPage
      if (sharedCardId) {
        return <ShareCardPage shareId={sharedCardId} />;
      }

      // If this is a shared view, show the SharedAssessmentViewer
      if (sharedViewId) {
        return <SharedAssessmentViewer shareId={sharedViewId} />;
      }

      // App State
      const [currentPage, setCurrentPage] = useState('dashboard'); // Default to dashboard, not scoring
      const [centers, setCenters] = useState([]);
      const [surveys, setSurveys] = useState([]);
      const [showLanding, setShowLanding] = useState(true); // Always show landing on fresh load
      const [isTestDrive, setIsTestDrive] = useState(false); // Test mode - no saving
      const [showScoringHome, setShowScoringHome] = useState(true); // Show Scoring Home by default when Scoring tab is clicked
      const [isMobileApp, setIsMobileApp] = useState(window.innerWidth <= 768);

      // Mobile detection for main app
      useEffect(() => {
        const checkMobile = () => {
          const mobile = window.innerWidth <= 768;
          setIsMobileApp(mobile);
          // If on mobile and trying to access scoring, redirect to dashboard
          if (mobile && currentPage === 'scoring') {
            setCurrentPage('dashboard');
          }
        };
        window.addEventListener('resize', checkMobile);
        return () => window.removeEventListener('resize', checkMobile);
      }, [currentPage]);

      const handleStartScoring = () => {
        setShowLanding(false);
        setCurrentPage('dashboard'); // Go to dashboard after login
      };

      const handleGoHome = () => {
        setShowLanding(true);
        setIsTestDrive(false);
      };

      const handleStartTestDrive = () => {
        setIsTestDrive(true);
        setShowScoringHome(false); // Go directly to scoring
        setCurrentPage('scoring');
      };

      const handleExitTestDrive = () => {
        setIsTestDrive(false);
        setShowScoringHome(true); // Return to Scoring Home
        setCurrentPage('dashboard');
      };

      const handleStartNewAssessment = () => {
        setIsTestDrive(false);
        setShowScoringHome(false);
        // This will trigger the assessment setup modal
      };

      const [scores, setScores] = useState({});
      const [saving, setSaving] = useState(false);
      const [isFinalized, setIsFinalized] = useState(false);
      const [finalizedData, setFinalizedData] = useState(null);
      const [viewingMode, setViewingMode] = useState(false); // True when viewing completed assessment's full interface
      const saveTimeoutRef = useRef(null);

      // Assessment details state
      const [assessmentDetails, setAssessmentDetails] = useState(null);
      const [currentAssessmentId, setCurrentAssessmentId] = useState(null);
      const [showSetupModal, setShowSetupModal] = useState(false);
      const [editingSurvey, setEditingSurvey] = useState(null); // For editing survey from History
      const [viewingSummary, setViewingSummary] = useState(null); // For viewing Executive Summary

      // Toast notifications state
      const [toasts, setToasts] = useState([]);

      // Confirm dialog state
      const [confirmDialog, setConfirmDialog] = useState({ open: false, title: '', message: '', onConfirm: () => { }, type: 'warning' });

      // Toast helper functions
      const showToast = (type, title, message) => {
        const id = Date.now();
        setToasts(prev => [...prev, { id, type, title, message }]);
        // Auto dismiss after 5 seconds
        setTimeout(() => {
          setToasts(prev => prev.map(t => t.id === id ? { ...t, closing: true } : t));
          setTimeout(() => {
            setToasts(prev => prev.filter(t => t.id !== id));
          }, 300);
        }, 5000);
      };

      const dismissToast = (id) => {
        setToasts(prev => prev.map(t => t.id === id ? { ...t, closing: true } : t));
        setTimeout(() => {
          setToasts(prev => prev.filter(t => t.id !== id));
        }, 300);
      };

      // ============================================
      // MOCK TRAINING DATA - For Action Plan Report Development
      // ============================================
      const generateMockTrainingAssessments = () => {
        // Helper to generate all sub-standard IDs for a configuration
        const getAllSubstandardIds = (chaptersConfig) => {
          const ids = [];
          chaptersConfig.forEach(chapter => {
            chapter.standards.forEach(std => {
              std.substandards.forEach(sub => {
                ids.push(sub.id);
              });
            });
          });
          return ids;
        };

        // Mock Assessment #1: Al-Noor Dental Care Center
        // Configuration B with 10 findings from training scenarios
        const mock1_scores = {};
        const allSubIds_B = getAllSubstandardIds(chapters_B);

        // Initialize all as Fully Met (value: 2)
        allSubIds_B.forEach(id => {
          mock1_scores[id] = { value: 2, findings: '', recommendations: '' };
        });

        // Apply the 10 specific findings:
        // 1. LD.9.3  Partially Met (value: 1)
        mock1_scores['LD.9.3'] = {
          value: 1,
          findings: 'Upon reviewing ten personnel files, one staff member was contracted as a general dentist while credentials and assigned responsibilities reflected a dental hygienist role.',
          recommendations: 'Review all personnel contracts to ensure job titles match actual credentials and assigned responsibilities. Implement a verification process during hiring.'
        };

        // 2. LD.12.1  Partially Met (value: 1)
        mock1_scores['LD.12.1'] = {
          value: 1,
          findings: 'Upon reviewing ten personnel files, general orientation was provided; however, safety and security orientation was not conducted by qualified personnel.',
          recommendations: 'Assign qualified safety officers to conduct safety and security orientation. Document trainer qualifications in personnel files.'
        };

        // 3. LD.23.1  Not Met (value: 0)
        mock1_scores['LD.23.1'] = {
          value: 0,
          findings: 'No documented analysis or trending of quality performance indicators was available.',
          recommendations: 'Establish a quality committee to analyze and trend KPIs quarterly. Implement data visualization dashboards for leadership review.'
        };

        // 4. LD.24.3  Not Met (value: 0)
        mock1_scores['LD.24.3'] = {
          value: 0,
          findings: 'Performance indicator data were collected but not analyzed or trended over time.',
          recommendations: 'Train quality staff on statistical process control methods. Create monthly trending reports with run charts for all indicators.'
        };

        // 5. IPC.2.2  Not Met (value: 0)
        mock1_scores['IPC.2.2'] = {
          value: 0,
          findings: 'During the facility tour, a designated janitorial room was not available.',
          recommendations: 'Designate and properly equip a dedicated janitorial room for storing cleaning equipment and materials, separate from clinical areas.'
        };

        // 6. PC.7.2  Partially Met (value: 1)
        mock1_scores['PC.7.2'] = {
          value: 1,
          findings: 'Upon reviewing five dental records, treatment plans were procedure-based and did not reflect comprehensive planning.',
          recommendations: 'Implement comprehensive treatment planning templates that include diagnosis, prognosis, and sequenced treatment phases.'
        };

        // 7. PC.12.4  Not Applicable
        mock1_scores['PC.12.4'] = {
          value: 'NA',
          findings: 'Clinical research activities were out of the center\'s scope of services.',
          recommendations: ''
        };

        // 8. LD.7.2  Partially Met (value: 1)
        mock1_scores['LD.7.2'] = {
          value: 1,
          findings: 'A departmental operational plan was provided in a brief form without clear linkage to center-wide objectives.',
          recommendations: 'Develop comprehensive departmental operational plans with explicit alignment to strategic objectives. Include measurable targets and timelines.'
        };

        // 9. LD.2.3  Not Met (value: 0)
        mock1_scores['LD.2.3'] = {
          value: 0,
          findings: 'Quality and patient safety reports were not provided to demonstrate periodic review by leadership.',
          recommendations: 'Establish quarterly governance meetings with documented agenda items for quality and patient safety reports. Maintain meeting minutes with corrective actions.'
        };

        // Calculate stats for Mock 1
        let fullyMet1 = 0, partial1 = 0, notMet1 = 0, na1 = 0;
        Object.values(mock1_scores).forEach(score => {
          if (score.value === 2) fullyMet1++;
          else if (score.value === 1) partial1++;
          else if (score.value === 0) notMet1++;
          else if (score.value === 'NA') na1++;
        });
        const scored1 = fullyMet1 + partial1 + notMet1;
        const percentage1 = scored1 > 0 ? Math.round((fullyMet1 / scored1) * 100) : 0;

        const mockAssessment1 = {
          id: 'MOCK_TRAINING_001',
          centerName: 'Al-Noor Dental Care Center',
          assessmentDetails: {
            centerName: 'Al-Noor Dental Care Center',
            coordinatorName: 'Dr. Fatima Al-Hassan',
            coordinatorPhone: '+966 55 123 4567',
            coordinatorEmail: 'f.alhassan@alnoor-dental.com',
            configuration: 'B'
          },
          configuration: 'B - Full Survey',
          status: 'completed',
          scoredCount: allSubIds_B.length,
          totalSubstandards: allSubIds_B.length,
          stats: {
            total: allSubIds_B.length,
            scored: allSubIds_B.length - na1,
            fullyMet: fullyMet1,
            partial: partial1,
            notMet: notMet1,
            na: na1,
            percentage: percentage1
          },
          scores: mock1_scores,
          createdAt: '2026-01-15T09:00:00Z',
          completedAt: '2026-01-15T16:30:00Z',
          lastUpdated: '2026-01-15T16:30:00Z',
          submissionId: 'MOCK_TRAINING_001',
          storageType: 'mock',
          isMockData: true
        };

        // Mock Assessment #2: Riyadh Smile Dental Clinic
        // Cross-Center Training Scenarios - Multiple category findings
        const mock2_scores = {};

        // Initialize all as Fully Met (value: 2)
        allSubIds_B.forEach(id => {
          mock2_scores[id] = { value: 2, findings: '', recommendations: '' };
        });

        // Category 1: Credentialing vs Job Assignment
        mock2_scores['LD.9.3'] = {
          value: 0,
          findings: 'Upon reviewing 12 personnel files, three dental assistants were found to hold nursing credentials. Additionally, two staff performing sterilization were trained but held credentials as dental assistants, not CSSD technicians.',
          recommendations: 'Conduct comprehensive credential audit for all staff. Ensure job assignments align with verified credentials. Implement credential verification during hiring process.'
        };

        // Category 2: Policy Describing Process Without Evidence (QM.5.1  LD.23.3, RM.3.3  LD.25.1)
        mock2_scores['LD.23.3'] = {
          value: 0,
          findings: 'Only a document describing quality and safety principles was provided; no structured quality improvement program was available.',
          recommendations: 'Develop and implement a structured QI program using evidence-based methodology like FOCUS-PDCA. Document at least one improvement project annually.'
        };
        mock2_scores['LD.25.1'] = {
          value: 0,
          findings: 'Although a risk management program was provided, it contained only general principles and lacked center-specific risks.',
          recommendations: 'Conduct center-specific risk assessment. Develop risk register with identified clinical, managerial, and financial risks specific to dental operations.'
        };

        // Category 3: Hospital Language in Dental Center Policies
        mock2_scores['FMS.9.3'] = {
          value: 1,
          findings: 'The CPR policy was center-specific but included hospital-setting terminology across multiple sections.',
          recommendations: 'Review and revise all policies to remove hospital-specific terminology. Ensure language reflects dental center context and capabilities.'
        };
        mock2_scores['FMS.1.1'] = {
          value: 0,
          findings: 'The safety management program referred to a sister facility and was not tailored to the surveyed center.',
          recommendations: 'Develop center-specific safety management program addressing unique hazards and processes of this dental facility.'
        };

        // Category 4: Partial Compliance Through Generalization (QM.1.1  LD.1.2)
        mock2_scores['LD.7.3'] = {
          value: 1,
          findings: 'Meeting minutes evidenced leadership discussions, but content was limited to audits without covering KPIs or feedback.',
          recommendations: 'Expand leadership meeting agendas to include KPI review, staff feedback, quality metrics, and action item follow-up.'
        };
        mock2_scores['LD.1.2'] = {
          value: 1,
          findings: 'The strategic plan included general goals and objectives without measurable indicators or clear alignment to center-specific services.',
          recommendations: 'Revise strategic plan with SMART objectives. Include measurable indicators and explicit linkage to scope of dental services.'
        };

        // Category 5: Not Applicable Correctly Applied
        mock2_scores['PC.14.4'] = {
          value: 'NA',
          findings: 'Laser procedures were not offered during the visit, rendering the standard out of scope.',
          recommendations: ''
        };
        mock2_scores['FMS.2.4'] = {
          value: 'NA',
          findings: 'Piped medical gases were not installed, and medical gas services were out of scope.',
          recommendations: ''
        };

        // Category 6: Interview-Based Standards (QM.6.3  LD.24.4, PC.9.1  PC.11.1)
        mock2_scores['LD.24.4'] = {
          value: 0,
          findings: 'Although KPIs were presented, interviews with five staff showed no evidence of access or utilization for decision-making.',
          recommendations: 'Implement regular KPI communication sessions with staff. Document how performance data informs operational decisions.'
        };
        mock2_scores['PC.11.1'] = {
          value: 0,
          findings: 'Staff stated informed consent was present but only provided English forms for Arabic-speaking patients, with no evidence of comprehension ensured.',
          recommendations: 'Provide bilingual consent forms. Implement teach-back method to verify patient comprehension. Document language preference in records.'
        };

        // Category 7: File Review Revealing Scope Mismatch (HR.2.1  LD.10.3)
        mock2_scores['PC.4.2'] = {
          value: 0,
          findings: 'Two general practitioners were privileged to perform procedures beyond their scope, including molar RCT and replacing missing teeth.',
          recommendations: 'Review and revise privilege delineation process. Ensure privileges align with verified credentials and competencies.'
        };
        mock2_scores['LD.10.3'] = {
          value: 0,
          findings: 'No documentation was found for periodic review of credentials or privileges in reviewed personnel files.',
          recommendations: 'Establish annual credential and privilege review process. Document reviews in personnel files with dates and outcomes.'
        };

        // Category 8: Quality Data Collected but Not Analyzed (QM.4.2  LD.24.3, QM.6.1  IPC.11.3)
        mock2_scores['LD.24.3'] = {
          value: 0,
          findings: 'Survey and complaints data were collected but not analyzed or trended; action plans were not based on actual outcomes.',
          recommendations: 'Train quality staff on data analysis methods. Create quarterly trending reports with run charts and implement data-driven action plans.'
        };
        mock2_scores['IPC.11.3'] = {
          value: 0,
          findings: 'Only one sharp injury incident was documented with no evidence of trend analysis or preventive planning.',
          recommendations: 'Implement sharps injury surveillance program. Analyze trends quarterly and develop preventive measures based on findings.'
        };

        // Category 9: Training Calendars Without Programs (HR.6.3  LD.15.3)
        mock2_scores['LD.15.3'] = {
          value: 1,
          findings: 'Only mandatory training certificates were provided; no scheduled programs were documented for quality, safety, or infection control.',
          recommendations: 'Develop annual training calendar covering all required competencies. Document attendance and effectiveness evaluation.'
        };

        // Category 10: Out-of-Scope Services Properly Identified
        mock2_scores['PC.10.1'] = {
          value: 'NA',
          findings: 'Avulsed tooth identification and management was out of scope for the center\'s dental laboratory services.',
          recommendations: ''
        };
        mock2_scores['PC.16.1'] = {
          value: 'NA',
          findings: 'Moderate sedation was not offered and confirmed as out of scope during the visit.',
          recommendations: ''
        };

        // Calculate stats for Mock 2
        let fullyMet2 = 0, partial2 = 0, notMet2 = 0, na2 = 0;
        Object.values(mock2_scores).forEach(score => {
          if (score.value === 2) fullyMet2++;
          else if (score.value === 1) partial2++;
          else if (score.value === 0) notMet2++;
          else if (score.value === 'NA') na2++;
        });
        const scored2 = fullyMet2 + partial2 + notMet2;
        const percentage2 = scored2 > 0 ? Math.round((fullyMet2 / scored2) * 100) : 0;

        const mockAssessment2 = {
          id: 'MOCK_TRAINING_002',
          centerName: 'Riyadh Smile Dental Clinic',
          assessmentDetails: {
            centerName: 'Riyadh Smile Dental Clinic',
            coordinatorName: 'Dr. Mohammed Al-Rashid',
            coordinatorPhone: '+966 50 987 6543',
            coordinatorEmail: 'm.alrashid@riyadhsmile.com',
            configuration: 'B'
          },
          configuration: 'B - Full Survey',
          status: 'completed',
          scoredCount: allSubIds_B.length,
          totalSubstandards: allSubIds_B.length,
          stats: {
            total: allSubIds_B.length,
            scored: allSubIds_B.length - na2,
            fullyMet: fullyMet2,
            partial: partial2,
            notMet: notMet2,
            na: na2,
            percentage: percentage2
          },
          scores: mock2_scores,
          createdAt: '2026-01-18T08:30:00Z',
          completedAt: '2026-01-18T17:00:00Z',
          lastUpdated: '2026-01-18T17:00:00Z',
          submissionId: 'MOCK_TRAINING_002',
          storageType: 'mock',
          isMockData: true
        };

        // Mock Assessment #3: Jeddah Premier Dental Center
        // Additional Cross-Center Training Scenarios
        const mock3_scores = {};

        // Initialize all as Fully Met (value: 2)
        allSubIds_B.forEach(id => {
          mock3_scores[id] = { value: 2, findings: '', recommendations: '' };
        });

        // 1. Inaccurate Scoring Despite Stated Non-Compliance
        mock3_scores['LD.6.5'] = {
          value: 0,
          findings: 'The finding stated the requirement was not met, yet the substandard was scored as "2" (Fully Met). This represents a scoring calibration error.',
          recommendations: 'Implement surveyor calibration sessions to ensure scoring consistency. Review all findings against assigned scores before finalization.'
        };

        // 2. Missing Documentation vs Verbal Claims (QM.7.2  LD.24.2)
        mock3_scores['LD.24.2'] = {
          value: 0,
          findings: 'Staff reported that incomplete records were monitored, but no documentation of tracking or utilization was provided.',
          recommendations: 'Establish documented tracking system for incomplete records. Maintain logs showing monitoring activities and follow-up actions.'
        };

        // 3. Environment-Related Facility Hazards (FMS.10.2  FMS.6.1)
        mock3_scores['FMS.6.1'] = {
          value: 0,
          findings: 'A water leak from the air conditioning was observed dripping onto electrical components and dental air compressors, creating a safety risk.',
          recommendations: 'Immediately address water leak and conduct facility safety inspection. Implement preventive maintenance schedule for HVAC systems.'
        };

        // 4. Missing Contact Information in Emergency Plan (FMS.7.3  FMS.4.3)
        mock3_scores['FMS.4.3'] = {
          value: 0,
          findings: 'The emergency plan did not include contact persons or relevant authorities.',
          recommendations: 'Update emergency plan with complete contact directory including internal responders, emergency services, and regulatory authorities.'
        };

        // 5. Combined Documents Without Clarity
        mock3_scores['LD.7.2'] = {
          value: 1,
          findings: 'Operational, departmental, and strategic plans were combined in one document, with vague objectives and unclear alignment.',
          recommendations: 'Separate strategic, operational, and departmental plans. Ensure each contains specific, measurable objectives with clear accountability.'
        };

        // 6. Radiograph Process Not Aligned with Digital Use
        mock3_scores['IPC.8.1'] = {
          value: 'NA',
          findings: 'Only digital radiographs were used; no handling of contaminated film packets was involved.',
          recommendations: ''
        };

        // 7. Manual Content Does Not Match Scope (IC.1.1  IPC.1.4)
        mock3_scores['IPC.1.4'] = {
          value: 1,
          findings: 'The infection control manual consisted of scattered MOH guidelines and manufacturer manuals, not a structured center-specific document.',
          recommendations: 'Develop comprehensive center-specific IPC manual integrating MOH guidelines with local protocols. Organize in logical sections with table of contents.'
        };

        // 8. Incomplete Training Documentation (HR.6.2  LD.15.2)
        mock3_scores['LD.15.2'] = {
          value: 0,
          findings: 'Training certificates were provided in personnel files but lacked signatures and evidence of attendance.',
          recommendations: 'Implement training documentation standards requiring signatures, dates, trainer credentials, and attendance verification for all certificates.'
        };

        // 9. CPR Equipment Requirements Not Fully Met (PC.15.1  PC.15.5)
        mock3_scores['PC.15.5'] = {
          value: 0,
          findings: 'Only one defibrillator was available, and no crash cart was found in the patient care areas.',
          recommendations: 'Procure and position crash cart with required emergency medications and equipment. Ensure defibrillator coverage meets patient volume needs.'
        };

        // 10. Audit Reports Presented as KPI Evidence
        mock3_scores['LD.7.3'] = {
          value: 1,
          findings: 'Leaders provided audit reports as evidence of KPI monitoring, but no documentation addressed surveys, feedback, or improvement actions.',
          recommendations: 'Develop comprehensive KPI monitoring system including patient surveys, staff feedback, and documented improvement action plans.'
        };

        // Calculate stats for Mock 3
        let fullyMet3 = 0, partial3 = 0, notMet3 = 0, na3 = 0;
        Object.values(mock3_scores).forEach(score => {
          if (score.value === 2) fullyMet3++;
          else if (score.value === 1) partial3++;
          else if (score.value === 0) notMet3++;
          else if (score.value === 'NA') na3++;
        });
        const scored3 = fullyMet3 + partial3 + notMet3;
        const percentage3 = scored3 > 0 ? Math.round((fullyMet3 / scored3) * 100) : 0;

        const mockAssessment3 = {
          id: 'MOCK_TRAINING_003',
          centerName: 'Jeddah Premier Dental Center',
          assessmentDetails: {
            centerName: 'Jeddah Premier Dental Center',
            coordinatorName: 'Dr. Amal Al-Zahrani',
            coordinatorPhone: '+966 56 234 5678',
            coordinatorEmail: 'a.alzahrani@jeddahpremier.com',
            configuration: 'B'
          },
          configuration: 'B - Full Survey',
          status: 'completed',
          scoredCount: allSubIds_B.length,
          totalSubstandards: allSubIds_B.length,
          stats: {
            total: allSubIds_B.length,
            scored: allSubIds_B.length - na3,
            fullyMet: fullyMet3,
            partial: partial3,
            notMet: notMet3,
            na: na3,
            percentage: percentage3
          },
          scores: mock3_scores,
          createdAt: '2026-01-22T09:15:00Z',
          completedAt: '2026-01-22T16:45:00Z',
          lastUpdated: '2026-01-22T16:45:00Z',
          submissionId: 'MOCK_TRAINING_003',
          storageType: 'mock',
          isMockData: true
        };

        // Mock Assessment #4: Dammam Family Dental Care
        // Advanced Field Cases - Set 4
        const mock4_scores = {};

        // Initialize all as Fully Met (value: 2)
        allSubIds_B.forEach(id => {
          mock4_scores[id] = { value: 2, findings: '', recommendations: '' };
        });

        // 1. Evidence Provided for a Different Facility (QM.1.1  LD.1.2)
        mock4_scores['LD.1.2'] = {
          value: 0,
          findings: 'The strategic plan was titled for the main hospital and included no center-specific goals, despite being submitted as the dental center\'s document.',
          recommendations: 'Develop center-specific strategic plan with goals aligned to dental services scope. Ensure all documents are properly titled for the correct facility.'
        };

        // 2. Overstated Compliance Based on Policy Title Alone
        mock4_scores['PC.11.4'] = {
          value: 0,
          findings: 'Although a policy was titled "Informed Consent," the document lacked any content related to patient understanding, language adaptation, or family involvement.',
          recommendations: 'Revise informed consent policy to include patient comprehension verification, multilingual options, and family involvement procedures.'
        };

        // 3. Irrelevant Benchmarking Statements (QM.5.4  LD.24.5)
        mock4_scores['LD.24.5'] = {
          value: 0,
          findings: 'The center stated that "benchmarking is done," but no reference data, comparison tables, or source centers were provided.',
          recommendations: 'Establish formal benchmarking program with documented comparison data from similar dental centers. Include trend analysis and improvement targets.'
        };

        // 4. Assumptions About Incomplete Training (HR.6.2  LD.15.2)
        mock4_scores['LD.15.2'] = {
          value: 0,
          findings: 'Staff had certificates for IPC training, but none were signed or dated, and no attendance log was provided to confirm completion.',
          recommendations: 'Implement training documentation standards requiring signatures, dates, and attendance logs. Verify all existing certificates meet requirements.'
        };

        // 5. Misuse of Verbal Justification in Record Review (PC.2.2  PC.12.2)
        mock4_scores['PC.12.2'] = {
          value: 0,
          findings: 'Two of five dental records lacked consent for invasive procedures; staff explained they were "scanned later," but no evidence was present in the files.',
          recommendations: 'Implement real-time consent documentation process. Ensure all consents are documented before procedures and immediately filed in patient records.'
        };

        // 6. Emergency Plans Focused on One Type Only (FMS.7.1  FMS.4.1)
        mock4_scores['FMS.4.1'] = {
          value: 0,
          findings: 'The emergency plan focused solely on fire response and did not address other emergency scenarios or roles across departments.',
          recommendations: 'Expand emergency plan to cover all hazards including medical emergencies, natural disasters, security threats, and utility failures.'
        };

        // 7. Incomplete Maintenance Logs (FMS.10.4  FMS.5.5)
        mock4_scores['FMS.5.5'] = {
          value: 0,
          findings: 'Maintenance records were available for extinguishers and smoke detectors, but none for the fire alarm system.',
          recommendations: 'Establish comprehensive maintenance schedule covering all fire safety equipment. Document all inspections, tests, and repairs.'
        };

        // 8. Certificates Without Associated Competency Validation (HR.6.3  LD.15.3)
        mock4_scores['LD.15.3'] = {
          value: 1,
          findings: 'Sterilization staff held general IPC training certificates, but no competency checklists or validation were provided for their assigned tasks.',
          recommendations: 'Develop role-specific competency checklists. Implement competency validation process with documented assessment of practical skills.'
        };

        // 9. Overgeneralization in Performance Data Use (QM.6.1  IPC.11.3)
        mock4_scores['IPC.11.3'] = {
          value: 0,
          findings: 'Staff reported that sharp injury reports were investigated, but no data analysis or trend tracking was shown over time.',
          recommendations: 'Implement sharps injury surveillance with quarterly trend analysis. Document root cause analysis and preventive actions for each incident.'
        };

        // 10. Unlocked Equipment Housing
        mock4_scores['FMS.5.1'] = {
          value: 0,
          findings: 'Dental compressors and vacuum pumps were placed outside the building in a ventilated area, but no physical security (e.g., lock or cage) was in place.',
          recommendations: 'Install secure enclosure with lock for outdoor equipment. Implement access control measures and regular security checks.'
        };

        // Calculate stats for Mock 4
        let fullyMet4 = 0, partial4 = 0, notMet4 = 0, na4 = 0;
        Object.values(mock4_scores).forEach(score => {
          if (score.value === 2) fullyMet4++;
          else if (score.value === 1) partial4++;
          else if (score.value === 0) notMet4++;
          else if (score.value === 'NA') na4++;
        });
        const scored4 = fullyMet4 + partial4 + notMet4;
        const percentage4 = scored4 > 0 ? Math.round((fullyMet4 / scored4) * 100) : 0;

        const mockAssessment4 = {
          id: 'MOCK_TRAINING_004',
          centerName: 'Dammam Family Dental Care',
          assessmentDetails: {
            centerName: 'Dammam Family Dental Care',
            coordinatorName: 'Dr. Khalid Al-Dosari',
            coordinatorPhone: '+966 54 345 6789',
            coordinatorEmail: 'k.aldosari@dammamfamily.com',
            configuration: 'B'
          },
          configuration: 'B - Full Survey',
          status: 'completed',
          scoredCount: allSubIds_B.length,
          totalSubstandards: allSubIds_B.length,
          stats: {
            total: allSubIds_B.length,
            scored: allSubIds_B.length - na4,
            fullyMet: fullyMet4,
            partial: partial4,
            notMet: notMet4,
            na: na4,
            percentage: percentage4
          },
          scores: mock4_scores,
          createdAt: '2026-01-25T08:00:00Z',
          completedAt: '2026-01-25T17:30:00Z',
          lastUpdated: '2026-01-25T17:30:00Z',
          submissionId: 'MOCK_TRAINING_004',
          storageType: 'mock',
          isMockData: true
        };

        // Mock Assessment #5: Makkah Central Dental Clinic
        // Field Variability & Misalignment - Set 5
        const mock5_scores = {};

        // Initialize all as Fully Met (value: 2)
        allSubIds_B.forEach(id => {
          mock5_scores[id] = { value: 2, findings: '', recommendations: '' };
        });

        // 1. Document Exists but Not Center-Specific (RM.1.1  LD.25.1)
        mock5_scores['LD.25.1'] = {
          value: 0,
          findings: 'A risk management policy was provided, but its content focused on the main hospital and did not reflect the dental center\'s services or risk profile.',
          recommendations: 'Develop center-specific risk management policy addressing dental-specific risks including procedural complications, infection risks, and equipment hazards.'
        };

        // 2. Confusion Between Department Plan and Operational Plan
        mock5_scores['LD.7.2'] = {
          value: 0,
          findings: 'The provided operational plan was in fact a departmental objective list, lacking defined projects, assigned responsibilities, or timeframes.',
          recommendations: 'Create proper operational plan with specific projects, responsible parties, timelines, resource allocation, and measurable outcomes.'
        };

        // 3. Lack of Patient Safety Elements in CPR Equipment (PC.15.1  PC.15.5)
        mock5_scores['PC.15.5'] = {
          value: 0,
          findings: 'A defibrillator was available, but no crash cart was located in patient care areas as required by the standard.',
          recommendations: 'Procure and position crash cart with emergency medications and equipment in accessible patient care area. Establish daily readiness checks.'
        };

        // 4. Over-reliance on Interview Comments (QM.6.2  LD.24.4)
        mock5_scores['LD.24.4'] = {
          value: 0,
          findings: 'Staff reported that risk information was shared quarterly, but no minutes, emails, or documentation were provided to confirm it.',
          recommendations: 'Document all risk communication activities including meeting minutes, email records, and staff acknowledgments. Maintain communication logs.'
        };

        // 5. Absence of Tracking for Incomplete Records (PC.3.4  MOI.4.3)
        mock5_scores['MOI.4.3'] = {
          value: 0,
          findings: 'Staff acknowledged record incompleteness, but no tracking or trending of incomplete dental records was documented.',
          recommendations: 'Implement incomplete record tracking system with monitoring dashboard. Trend data monthly and establish completion targets.'
        };

        // 6. Inappropriate Scope Expansion in Credentialing (PC.4.1  LD.10.2)
        mock5_scores['LD.10.2'] = {
          value: 0,
          findings: 'A general dentist was granted privileges to conduct pediatric full-mouth rehabilitation under GA without evidence of subspecialty or supporting recommendations.',
          recommendations: 'Review privilege delineation process. Require documented evidence of subspecialty training or competency for advanced procedures.'
        };

        // 7. Absence of Maintenance Documentation (FMS.10.1  FMS.7.1)
        mock5_scores['FMS.7.1'] = {
          value: 0,
          findings: 'No preventive or corrective maintenance records were provided for dental air compressors or medical refrigerators.',
          recommendations: 'Establish preventive maintenance schedule for all critical equipment. Document all maintenance activities with dates, findings, and corrective actions.'
        };

        // 8. Disconnected Patient Feedback Loop (QM.4.1  LD.23.1)
        mock5_scores['LD.23.1'] = {
          value: 0,
          findings: 'Surveys were collected, but results were not analyzed or linked to documented action plans for improvement.',
          recommendations: 'Implement patient feedback analysis process. Create action plans based on survey findings and track improvement outcomes.'
        };

        // 9. Shared Staff Credential Files Without Role Clarity (HR.3.2  LD.9.3)
        mock5_scores['LD.9.3'] = {
          value: 0,
          findings: 'Two sterilization staff were found to be dental assistants by credential, with no record of role-specific training or reassignment documentation.',
          recommendations: 'Ensure staff assignments match credentials. Document role-specific training and formal reassignment when duties change.'
        };

        // 10. Emergency Contact Information Missing from Plan (FMS.7.3  FMS.4.3)
        mock5_scores['FMS.4.3'] = {
          value: 0,
          findings: 'The emergency plan did not include the names or numbers of internal contact persons or external emergency authorities.',
          recommendations: 'Update emergency plan with complete contact directory including internal responders, local emergency services, and regulatory authorities.'
        };

        // Calculate stats for Mock 5
        let fullyMet5 = 0, partial5 = 0, notMet5 = 0, na5 = 0;
        Object.values(mock5_scores).forEach(score => {
          if (score.value === 2) fullyMet5++;
          else if (score.value === 1) partial5++;
          else if (score.value === 0) notMet5++;
          else if (score.value === 'NA') na5++;
        });
        const scored5 = fullyMet5 + partial5 + notMet5;
        const percentage5 = scored5 > 0 ? Math.round((fullyMet5 / scored5) * 100) : 0;

        const mockAssessment5 = {
          id: 'MOCK_TRAINING_005',
          centerName: 'Makkah Central Dental Clinic',
          assessmentDetails: {
            centerName: 'Makkah Central Dental Clinic',
            coordinatorName: 'Dr. Noura Al-Harbi',
            coordinatorPhone: '+966 57 456 7890',
            coordinatorEmail: 'n.alharbi@makkahcentral.com',
            configuration: 'B'
          },
          configuration: 'B - Full Survey',
          status: 'completed',
          scoredCount: allSubIds_B.length,
          totalSubstandards: allSubIds_B.length,
          stats: {
            total: allSubIds_B.length,
            scored: allSubIds_B.length - na5,
            fullyMet: fullyMet5,
            partial: partial5,
            notMet: notMet5,
            na: na5,
            percentage: percentage5
          },
          scores: mock5_scores,
          createdAt: '2026-01-28T09:00:00Z',
          completedAt: '2026-01-28T16:00:00Z',
          lastUpdated: '2026-01-28T16:00:00Z',
          submissionId: 'MOCK_TRAINING_005',
          storageType: 'mock',
          isMockData: true
        };

        // Mock Assessment #6: Tabuk Family Dental Center
        // Cross-Center Survey Training - Extended Case Set 6
        const mock6_scores = {};

        // Initialize all as Fully Met (value: 2)
        allSubIds_B.forEach(id => {
          mock6_scores[id] = { value: 2, findings: '', recommendations: '' };
        });

        // 1. Policies Referencing Non-Applicable Departments (IC.1.2  IPC.1.2)
        mock6_scores['IPC.1.2'] = {
          value: 0,
          findings: 'The infection control manual referenced hospital operating rooms and inpatient services not available in the center.',
          recommendations: 'Revise infection control manual to reflect center-specific services and remove references to non-applicable hospital departments.'
        };

        // 2. Overgeneralized Action Plans (QM.4.2  LD.24.2)
        mock6_scores['LD.24.2'] = {
          value: 0,
          findings: 'Action plans were written in general terms and did not reference specific survey or complaint outcomes.',
          recommendations: 'Develop specific action plans linked to identified issues with clear objectives, responsible parties, timelines, and measurable outcomes.'
        };

        // 3. Language Misalignment in Informed Consent (PC.11.4)
        mock6_scores['PC.11.4'] = {
          value: 0,
          findings: 'Upon reviewing five dental records, informed consent forms were written in English for Arabic-speaking patients with no evidence of translation or comprehension verification.',
          recommendations: 'Provide informed consent forms in Arabic or ensure documented translation services. Verify patient comprehension before obtaining consent.'
        };

        // 4. Audit Reports Mistaken as KPI Monitoring (LD.7.3)
        mock6_scores['LD.7.3'] = {
          value: 1,
          findings: 'Leadership discussions focused solely on audit reports with no documentation of KPI or feedback analysis.',
          recommendations: 'Establish separate KPI monitoring process distinct from audits. Include KPI review, feedback analysis, and quality metrics in leadership meetings.'
        };

        // 5. Undocumented Role Assignment (RM.7.1  LD.25.1)
        mock6_scores['LD.25.1'] = {
          value: 0,
          findings: 'No documentation was provided assigning a staff member responsible for managing risk or complaints.',
          recommendations: 'Formally assign and document risk management responsibilities. Include role in job description and organizational chart.'
        };

        // 6. Operational Plans without Execution Framework (LD.7.2)
        mock6_scores['LD.7.2'] = {
          value: 0,
          findings: 'The operational plan lacked defined projects, assigned roles, timeframes, or resource needs.',
          recommendations: 'Revise operational plan to include specific projects, assigned responsibilities, timelines, resource allocation, and success metrics.'
        };

        // 7. Untracked Staff Training Completion (HR.6.3  LD.15.3)
        mock6_scores['LD.15.3'] = {
          value: 0,
          findings: 'Staff had certificates of attendance, but none were signed or documented in training logs.',
          recommendations: 'Implement training tracking system with signed attendance records, competency verification, and centralized documentation in personnel files.'
        };

        // 8. CPR Process Scattered in Multiple Sections (FMS.9.3)
        mock6_scores['FMS.9.3'] = {
          value: 1,
          findings: 'CPR staff roles were defined across multiple document sections using inconsistent terminology.',
          recommendations: 'Consolidate CPR protocol into single comprehensive document with consistent terminology and clear role definitions.'
        };

        // 9. Equipment Placement Not Compliant with Safety Standards (FMS.5.2)
        mock6_scores['FMS.5.2'] = {
          value: 0,
          findings: 'Dental air compressors were placed outside in an open area without locking or signage, despite being in a ventilated location.',
          recommendations: 'Relocate equipment to secure location with appropriate locking mechanisms and safety signage. Ensure compliance with equipment placement standards.'
        };

        // 10. Staff Privileges Not Supported by Training (PC.4.2)
        mock6_scores['PC.4.2'] = {
          value: 0,
          findings: 'Two general dentists were granted privileges to perform molar RCT and prosthodontic procedures without documentation of specialty training or endorsement.',
          recommendations: 'Review privilege delineation process. Require documented evidence of training, competency assessment, or specialist endorsement for advanced procedures.'
        };

        // 11. No Clear Schedule for Safety Rounds (FMS.3.3)
        mock6_scores['FMS.3.3'] = {
          value: 0,
          findings: 'Only one facility round was documented over a one-year period, despite policy requiring quarterly inspections.',
          recommendations: 'Establish and follow quarterly safety round schedule. Document all rounds with findings, corrective actions, and follow-up verification.'
        };

        // 12. No Emergency Authority Contacts in Plan (FMS.7.3)
        mock6_scores['FMS.7.3'] = {
          value: 0,
          findings: 'The emergency preparedness plan lacked any listing of contact persons or external emergency authorities.',
          recommendations: 'Update emergency plan with complete contact directory including internal responders, local emergency services, civil defense, and regulatory authorities.'
        };

        // 13. Scoring Based on Missing Staff, Not Activity (PC.8.3)
        mock6_scores['PC.8.3'] = {
          value: 0,
          findings: 'The finding referenced staff absence, although the standard required a review of dental radiography protocols and documentation.',
          recommendations: 'Review and document dental radiography protocols, safety procedures, and quality control measures independent of staff availability.'
        };

        // 14. Misapplication of Not Applicable Scoring (PC.16.2  PC.15.2)
        mock6_scores['PC.15.2'] = {
          value: 0,
          findings: 'Moderate sedation was not implemented during the visit, but documentation and equipment were present, indicating the standard was applicable.',
          recommendations: 'Score standards based on capability and documentation, not just activity during survey. Review sedation protocols and staff competencies.'
        };

        // 15. Fire Safety Equipment Maintained Irregularly (FMS.10.2  FMS.6.2)
        mock6_scores['FMS.6.2'] = {
          value: 1,
          findings: 'Records were available for extinguisher checks but lacked documentation for fire alarm system testing.',
          recommendations: 'Implement comprehensive fire safety maintenance program covering all equipment. Document regular testing of alarms, extinguishers, and suppression systems.'
        };

        // 16. Water Leak Near Electrical Systems (FMS.5.3)
        mock6_scores['FMS.5.3'] = {
          value: 0,
          findings: 'A water leak from the ceiling was observed dripping onto dental air compressors, posing a risk to electrical safety and equipment integrity.',
          recommendations: 'Immediately address water leak and relocate equipment. Implement facility inspection protocol to identify and remediate environmental hazards.'
        };

        // 17. Staff Role in Emergencies Not Defined (FMS.7.2)
        mock6_scores['FMS.7.2'] = {
          value: 0,
          findings: 'The emergency plan did not define individual staff roles in various emergency scenarios.',
          recommendations: 'Define specific staff roles and responsibilities for each emergency scenario. Conduct drills to ensure staff understanding and competency.'
        };

        // 18. No Risk Register Maintained (RM.3.2  LD.25.2)
        mock6_scores['LD.25.2'] = {
          value: 0,
          findings: 'No risk register was provided documenting clinical, managerial, or financial risks.',
          recommendations: 'Develop comprehensive risk register identifying clinical, operational, financial, and strategic risks. Include risk assessment, mitigation strategies, and monitoring.'
        };

        // 19. Training Program Missing Despite Certificates (HR.6.1  LD.12.1)
        mock6_scores['LD.12.1'] = {
          value: 0,
          findings: 'Staff certificates were presented, but no structured annual training plan or schedule was provided.',
          recommendations: 'Develop annual training plan aligned with competency requirements. Include orientation, mandatory training, and professional development schedule.'
        };

        // 20. General Goals in Strategic Plan (LD.6.1)
        mock6_scores['LD.6.1'] = {
          value: 1,
          findings: 'Goals in the strategic plan were broad and not linked to measurable outcomes or the center\'s specific services.',
          recommendations: 'Revise strategic plan with SMART objectives linked to center services. Include measurable outcomes, timelines, and alignment with mission.'
        };

        // 21. Data Collection Without Analysis (QM.5.2  LD.24.4)
        mock6_scores['LD.24.4'] = {
          value: 0,
          findings: 'Survey and suggestion data were collected, but no evidence of analysis, trending, or integration into decision-making was found.',
          recommendations: 'Implement data analysis process for all collected feedback. Trend results, identify patterns, and integrate findings into quality improvement activities.'
        };

        // Calculate stats for Mock 6
        let fullyMet6 = 0, partial6 = 0, notMet6 = 0, na6 = 0;
        Object.values(mock6_scores).forEach(score => {
          if (score.value === 2) fullyMet6++;
          else if (score.value === 1) partial6++;
          else if (score.value === 0) notMet6++;
          else if (score.value === 'NA') na6++;
        });
        const scored6 = fullyMet6 + partial6 + notMet6;
        const percentage6 = scored6 > 0 ? Math.round((fullyMet6 / scored6) * 100) : 0;

        const mockAssessment6 = {
          id: 'MOCK_TRAINING_006',
          centerName: 'Tabuk Family Dental Center',
          assessmentDetails: {
            centerName: 'Tabuk Family Dental Center',
            coordinatorName: 'Dr. Saleh Al-Otaibi',
            coordinatorPhone: '+966 58 234 5678',
            coordinatorEmail: 's.alotaibi@tabukfamily.com',
            configuration: 'B'
          },
          configuration: 'B - Full Survey',
          status: 'completed',
          scoredCount: allSubIds_B.length,
          totalSubstandards: allSubIds_B.length,
          stats: {
            total: allSubIds_B.length,
            scored: allSubIds_B.length - na6,
            fullyMet: fullyMet6,
            partial: partial6,
            notMet: notMet6,
            na: na6,
            percentage: percentage6
          },
          scores: mock6_scores,
          createdAt: '2026-01-30T08:30:00Z',
          completedAt: '2026-01-30T17:45:00Z',
          lastUpdated: '2026-01-30T17:45:00Z',
          submissionId: 'MOCK_TRAINING_006',
          storageType: 'mock',
          isMockData: true
        };

        // Mock Assessment #7: Jizan Coastal Dental Center
        // Cross-Center Survey Training - High-Intensity Set (Set 7)
        const mock7_scores = {};

        // Initialize all as Fully Met (value: 2)
        allSubIds_B.forEach(id => {
          mock7_scores[id] = { value: 2, findings: '', recommendations: '' };
        });

        // 1. Credentials vs Assigned Role - Dental Hygienist (LD.9.3)
        mock7_scores['LD.9.3'] = {
          value: 0,
          findings: 'A dental hygienist credential file showed license for dental assistant but was assigned to perform scaling and prophylaxis procedures during survey.',
          recommendations: 'Review all staff credentials to ensure assigned roles match professional licenses. Reassign duties according to verified qualifications.'
        };

        // 2. Credentials vs Assigned Role - Dentist Privileges (PC.4.2)
        mock7_scores['PC.4.2'] = {
          value: 0,
          findings: 'Dentist credential file showed general dentistry license but was granted privileges for surgical extractions and implant placement without specialty documentation.',
          recommendations: 'Review privilege delineation process. Require documented specialty training or competency assessment before granting advanced procedure privileges.'
        };

        // 3. Credentials vs Assigned Role - Job Description Mismatch (HR.3.1  LD.13.1)
        mock7_scores['LD.13.1'] = {
          value: 0,
          findings: 'Job description listed "oral surgery assistant" but employee file contained only dental assistant certification with no surgical training documentation.',
          recommendations: 'Align job descriptions with actual credentials. Provide additional training if role requires competencies beyond current certification.'
        };

        // 4. Policies Not Tailored - Infection Control (IC.1.2  IPC.1.2)
        mock7_scores['IPC.1.2'] = {
          value: 0,
          findings: 'Infection control policy referenced hospital ICU protocols and surgical suite procedures not applicable to dental center services.',
          recommendations: 'Revise infection control policies to reflect dental center-specific services, equipment, and procedures. Remove irrelevant hospital references.'
        };

        // 5. Policies Not Tailored - Facility Safety (FMS.1.1)
        mock7_scores['FMS.1.1'] = {
          value: 0,
          findings: 'Facility management policy was copied from multi-story hospital template including elevator maintenance and helipad protocols not applicable to single-floor dental center.',
          recommendations: 'Develop facility-specific safety policies addressing actual center infrastructure, equipment, and operational needs.'
        };

        // 6. Policies Not Tailored - Quality Management (QM.1.1  LD.24.1)
        mock7_scores['LD.24.1'] = {
          value: 0,
          findings: 'Quality management framework referenced inpatient quality indicators and nursing metrics not relevant to outpatient dental services.',
          recommendations: 'Develop quality framework specific to dental services including appropriate clinical indicators, patient satisfaction measures, and outcome metrics.'
        };

        // 7. Incomplete/Non-Operational Plans - Operational Plan (LD.7.2)
        mock7_scores['LD.7.2'] = {
          value: 0,
          findings: 'Operational plan existed but lacked specific projects, timelines, assigned responsibilities, or resource allocation details.',
          recommendations: 'Revise operational plan to include SMART objectives, assigned owners, realistic timelines, required resources, and measurable outcomes.'
        };

        // 8. Incomplete/Non-Operational Plans - Training Plan (HR.6.1  LD.12.1)
        mock7_scores['LD.12.1'] = {
          value: 0,
          findings: 'Annual training plan was documented but showed no evidence of implementation - no attendance records, completion tracking, or competency assessments.',
          recommendations: 'Implement training tracking system with attendance documentation, completion verification, and competency assessment records.'
        };

        // 9. Incomplete/Non-Operational Plans - Risk Register (RM.3.2  LD.25.2)
        mock7_scores['LD.25.2'] = {
          value: 0,
          findings: 'Risk management plan mentioned risk assessment but no risk register documenting identified risks, likelihood, impact, or mitigation strategies was available.',
          recommendations: 'Develop comprehensive risk register with identified risks categorized by type, assessed for likelihood and impact, with documented mitigation strategies.'
        };

        // 10. Action Plans Without Linked Data (QM.4.2  LD.24.2)
        mock7_scores['LD.24.2'] = {
          value: 0,
          findings: 'Action plans were documented but not linked to any specific audit findings, patient complaints, or incident reports.',
          recommendations: 'Link all action plans to source data (audits, complaints, incidents). Include root cause analysis and specific corrective measures.'
        };

        // 11. Action Plans Without Linked Data - Analysis (QM.5.3  LD.24.5)
        mock7_scores['LD.24.5'] = {
          value: 0,
          findings: 'Quality improvement activities were documented but showed no evidence of data analysis or trending to identify systemic issues.',
          recommendations: 'Implement data analysis protocols to identify trends, patterns, and root causes. Use findings to drive targeted improvement initiatives.'
        };

        // 12. Emergency Preparedness - Staff Roles (FMS.7.2)
        mock7_scores['FMS.7.2'] = {
          value: 0,
          findings: 'Emergency preparedness plan existed but did not define specific staff roles, responsibilities, or chain of command during emergencies.',
          recommendations: 'Define clear roles and responsibilities for each staff member during various emergency scenarios. Conduct drills to verify understanding.'
        };

        // 13. Emergency Preparedness - Emergency Contacts (FMS.7.3)
        mock7_scores['FMS.7.3'] = {
          value: 0,
          findings: 'Emergency plan lacked contact information for local civil defense, fire department, ambulance services, or utility emergency lines.',
          recommendations: 'Update emergency plan with complete contact directory including all relevant emergency services, utilities, and regulatory authorities.'
        };

        // 14. Infection Control Gaps - Surveillance (IC.1.3  IPC.1.3)
        mock7_scores['IPC.1.3'] = {
          value: 0,
          findings: 'No infection surveillance program was documented. No tracking of HAI rates, surgical site infections, or post-procedure complications.',
          recommendations: 'Establish infection surveillance program with defined indicators, regular monitoring, data analysis, and reporting mechanisms.'
        };

        // 15. Infection Control Gaps - Hand Hygiene (IC.3.2  IPC.3.2)
        mock7_scores['IPC.3.2'] = {
          value: 1,
          findings: 'Hand hygiene compliance monitoring was documented but showed only 60% compliance rate with no improvement actions documented.',
          recommendations: 'Implement hand hygiene improvement program with staff education, visual reminders, increased monitoring, and feedback mechanisms.'
        };

        // 16. Infection Control Gaps - Sterilization (IC.5.2  IPC.5.2)
        mock7_scores['IPC.5.2'] = {
          value: 0,
          findings: 'Sterilization logs showed biological indicator testing performed monthly instead of with each sterilizer load as required by policy.',
          recommendations: 'Revise sterilization protocols to ensure biological indicator testing per load. Train staff on proper documentation requirements.'
        };

        // 17. Misalignment Between Activity and Evidence - Radiography (PC.8.3)
        mock7_scores['PC.8.3'] = {
          value: 0,
          findings: 'Finding stated "radiography services not available during survey" but dental X-ray unit was operational and patient records showed recent radiographs.',
          recommendations: 'Score based on documented protocols, equipment availability, and record evidence - not solely on activities observed during survey.'
        };

        // 18. Misalignment Between Activity and Evidence - Sedation (PC.15.4)
        mock7_scores['PC.15.4'] = {
          value: 0,
          findings: 'Moderate sedation scored as Not Met because no procedures occurred during survey, despite complete documentation, trained staff, and emergency equipment.',
          recommendations: 'Assess sedation services based on documented protocols, staff credentials, equipment readiness, and patient records - not just survey-day activity.'
        };

        // 19. Performance Monitoring - KPI Framework (QM.5.1  LD.24.3)
        mock7_scores['LD.24.3'] = {
          value: 0,
          findings: 'Performance indicators were listed but no monitoring framework, data collection methodology, or reporting schedule was documented.',
          recommendations: 'Develop KPI monitoring framework with clear definitions, data sources, collection frequency, responsible parties, and reporting mechanisms.'
        };

        // 20. Performance Monitoring - Feedback Integration (QM.6.2  LD.26.2)
        mock7_scores['LD.26.2'] = {
          value: 1,
          findings: 'Patient satisfaction surveys were collected but analysis showed no connection to quality improvement activities or leadership decisions.',
          recommendations: 'Integrate patient feedback into quality improvement process. Present findings to leadership with recommended actions and track implementation.'
        };

        // 21. Facility/Equipment Safety - Medical Equipment (FMS.5.1)
        mock7_scores['FMS.5.1'] = {
          value: 0,
          findings: 'Dental equipment maintenance records showed preventive maintenance overdue by 4-6 months for multiple units including autoclave and X-ray machine.',
          recommendations: 'Implement preventive maintenance schedule with alerts for upcoming services. Document all maintenance activities with dates and findings.'
        };

        // 22. Facility/Equipment Safety - Fire Safety (FMS.10.3  FMS.6.3)
        mock7_scores['FMS.6.3'] = {
          value: 0,
          findings: 'Fire extinguisher inspection tags showed last inspection 18 months ago. Annual fire drill documentation not available.',
          recommendations: 'Establish monthly fire extinguisher inspection schedule. Conduct and document annual fire drills with staff participation records.'
        };

        // 23. Facility/Equipment Safety - Utility Systems (FMS.5.3)
        mock7_scores['FMS.5.3'] = {
          value: 0,
          findings: 'Electrical panel in sterilization area had exposed wiring. Dental unit water lines showed discoloration indicating potential biofilm contamination.',
          recommendations: 'Immediately address electrical hazard. Implement dental unit waterline management protocol including regular testing and treatment.'
        };

        // 24. Job Descriptions/File Documentation - JD Completeness (HR.3.2  LD.13.2)
        mock7_scores['LD.13.2'] = {
          value: 0,
          findings: 'Personnel files reviewed showed job descriptions lacking required qualifications, reporting relationships, and key performance indicators.',
          recommendations: 'Update all job descriptions to include required qualifications, experience, competencies, reporting structure, and performance expectations.'
        };

        // 25. Job Descriptions/File Documentation - Credential Files (HR.4.1  LD.14.1)
        mock7_scores['LD.14.1'] = {
          value: 1,
          findings: 'Credential files were maintained but 3 of 8 files reviewed were missing license verification from primary source.',
          recommendations: 'Implement primary source verification for all professional licenses. Maintain documentation of verification process and dates.'
        };

        // 26. Improper Scoring - Fully Met with Findings (LD.5.1)
        mock7_scores['LD.5.1'] = {
          value: 2,
          findings: 'Standard scored Fully Met. Comment field contained: "Governing body meeting minutes available but some agenda items not documented in detail." This finding suggests partial compliance, not full compliance.',
          recommendations: 'Note: This was scored Fully Met but findings indicate Partially Met may be more appropriate. Review scoring criteria for consistency.'
        };

        // 27. Improper Scoring - Fully Met with Gaps (PC.11.4)
        mock7_scores['PC.11.4'] = {
          value: 2,
          findings: 'Standard scored Fully Met. Comment stated: "Informed consent obtained but not all risks documented in 2 of 5 records reviewed." Partial documentation compliance suggests PM scoring.',
          recommendations: 'Note: Findings indicate gaps in documentation that may warrant Partially Met scoring. Ensure scoring reflects actual compliance level.'
        };

        // 28. Inappropriate N/A Labeling - Pediatric Sedation (PC.16.3  PC.15.3)
        mock7_scores['PC.15.3'] = {
          value: 0,
          findings: 'Pediatric sedation marked N/A because "no pediatric patients during survey," but center treats children and has sedation equipment available.',
          recommendations: 'Score based on service capability and documentation, not survey-day activity. Review pediatric sedation protocols and staff competencies.'
        };

        // 29. Inappropriate N/A Labeling - Outbreak Management (IC.8.1  IPC.8.1)
        mock7_scores['IPC.8.1'] = {
          value: 0,
          findings: 'Outbreak management scored N/A stating "no outbreaks occurred." Outbreak preparedness plans and protocols are required regardless of occurrence.',
          recommendations: 'Develop outbreak management plan including identification criteria, response protocols, communication procedures, and reporting requirements.'
        };

        // 30. Strategic Planning - Goals and Objectives (LD.6.1)
        mock7_scores['LD.6.1'] = {
          value: 1,
          findings: 'Strategic plan contained broad vision and mission statements but lacked specific, measurable objectives linked to dental center services.',
          recommendations: 'Revise strategic plan with SMART objectives aligned to center services. Include measurable targets, timelines, and accountability assignments.'
        };

        // 31. Training Without Attendance Evidence (HR.6.2  LD.15.2)
        mock7_scores['LD.15.2'] = {
          value: 0,
          findings: 'Training certificates were provided but no signed attendance sheets, pre/post assessments, or competency verification records were available.',
          recommendations: 'Implement comprehensive training documentation including signed attendance, learning assessments, and competency verification records.'
        };

        // 32. Staff Competency Verification (HR.6.3  LD.15.3)
        mock7_scores['LD.15.3'] = {
          value: 0,
          findings: 'Mandatory training completion tracked but no evidence of competency assessment or skill verification following training completion.',
          recommendations: 'Develop competency assessment tools for mandatory training. Document skill verification and maintain records in personnel files.'
        };

        // Calculate stats for Mock 7
        let fullyMet7 = 0, partial7 = 0, notMet7 = 0, na7 = 0;
        Object.values(mock7_scores).forEach(score => {
          if (score.value === 2) fullyMet7++;
          else if (score.value === 1) partial7++;
          else if (score.value === 0) notMet7++;
          else if (score.value === 'NA') na7++;
        });
        const scored7 = fullyMet7 + partial7 + notMet7;
        const percentage7 = scored7 > 0 ? Math.round((fullyMet7 / scored7) * 100) : 0;

        const mockAssessment7 = {
          id: 'MOCK_TRAINING_007',
          centerName: 'Jizan Coastal Dental Center',
          assessmentDetails: {
            centerName: 'Jizan Coastal Dental Center',
            coordinatorName: 'Dr. Ahmed Al-Zahrani',
            coordinatorPhone: '+966 59 345 6789',
            coordinatorEmail: 'a.alzahrani@jizancoastal.com',
            configuration: 'B'
          },
          configuration: 'B - Full Survey',
          status: 'completed',
          scoredCount: allSubIds_B.length,
          totalSubstandards: allSubIds_B.length,
          stats: {
            total: allSubIds_B.length,
            scored: allSubIds_B.length - na7,
            fullyMet: fullyMet7,
            partial: partial7,
            notMet: notMet7,
            na: na7,
            percentage: percentage7
          },
          scores: mock7_scores,
          createdAt: '2026-01-31T07:45:00Z',
          completedAt: '2026-01-31T18:30:00Z',
          lastUpdated: '2026-01-31T18:30:00Z',
          submissionId: 'MOCK_TRAINING_007',
          storageType: 'mock',
          isMockData: true
        };

        return [mockAssessment1, mockAssessment2, mockAssessment3, mockAssessment4, mockAssessment5, mockAssessment6, mockAssessment7];
      };

      // Load data on mount
      useEffect(() => {
        const savedCenters = storage.get(STORAGE_KEYS.CENTERS) || [];
        let savedSurveys = storage.get(STORAGE_KEYS.SURVEYS) || [];

        // Inject mock training data - Update mock base while preserving user edits
        const mockData = generateMockTrainingAssessments();
        mockData.forEach(mock => {
          const existingIndex = savedSurveys.findIndex(s => s.id === mock.id);
          if (existingIndex >= 0) {
            const existing = savedSurveys[existingIndex];
            // Preserve user edits (lastEditedAt, modified completedAt, scores if edited)
            // Only replace mock template data, not user modifications
            const userModifications = existing.lastEditedAt ? {
              scores: existing.scores,
              stats: existing.stats,
              lastEditedAt: existing.lastEditedAt,
              completedAt: existing.completedAt,
              lastUpdated: existing.lastUpdated
            } : {};
            savedSurveys[existingIndex] = { ...mock, ...userModifications };
          } else {
            // Add new mock data
            savedSurveys = [...savedSurveys, mock];
          }
        });
        storage.set(STORAGE_KEYS.SURVEYS, savedSurveys);
        const savedScores = storage.get(STORAGE_KEYS.CURRENT_SCORES) || {};
        const savedFinalized = storage.get('cbahi_finalized') || false;
        const savedFinalizedData = storage.get('cbahi_finalized_data') || null;
        const savedAssessmentDetails = storage.get('cbahi_assessment_details') || null;
        const savedCurrentAssessmentId = storage.get('cbahi_current_assessment_id') || null;

        // MIGRATION: If there's finalized data but no survey record, create one
        if (savedFinalized && savedFinalizedData && savedFinalizedData.submissionId) {
          const existingSurvey = savedSurveys.find(s => s.submissionId === savedFinalizedData.submissionId || s.id === savedFinalizedData.submissionId);
          if (!existingSurvey) {
            // Create a survey record from the finalized data
            const migratedSurvey = {
              id: savedFinalizedData.submissionId,
              centerName: savedFinalizedData.centerName || savedAssessmentDetails?.centerName || 'Assessment',
              assessmentDetails: savedFinalizedData.assessmentDetails || savedAssessmentDetails || {
                centerName: savedFinalizedData.centerName || 'Completed Assessment',
                coordinatorName: savedFinalizedData.coordinatorName || '',
                coordinatorPhone: savedFinalizedData.coordinatorPhone || '',
                coordinatorEmail: savedFinalizedData.coordinatorEmail || ''
              },
              status: 'completed',
              scoredCount: savedFinalizedData.scoredSubstandards || 180,
              totalSubstandards: savedFinalizedData.totalSubstandards || 180,
              stats: savedFinalizedData.stats || {
                total: savedFinalizedData.totalSubstandards || 180,
                scored: savedFinalizedData.scoredSubstandards || 180,
                fullyMet: savedFinalizedData.fullyMet || 0,
                partial: savedFinalizedData.partialMet || 0,
                notMet: savedFinalizedData.notMet || 0,
                na: savedFinalizedData.naCount || 0,
                percentage: savedFinalizedData.percentage || 0
              },
              scores: savedFinalizedData.scores || savedScores,
              createdAt: savedFinalizedData.submittedAt || new Date().toISOString(),
              completedAt: savedFinalizedData.submittedAt || new Date().toISOString(),
              lastUpdated: savedFinalizedData.submittedAt || new Date().toISOString(),
              submissionId: savedFinalizedData.submissionId,
              storageType: savedFinalizedData.storageType || 'local'
            };
            savedSurveys = [...savedSurveys, migratedSurvey];
            storage.set(STORAGE_KEYS.SURVEYS, savedSurveys);
            console.log('Migrated finalized assessment to History:', migratedSurvey.id);
          }
        }

        setCenters(savedCenters);
        setSurveys(savedSurveys);
        setScores(savedScores);
        setIsFinalized(savedFinalized);
        setFinalizedData(savedFinalizedData);
        setAssessmentDetails(savedAssessmentDetails);

        // Debug: Log surveys with lastEditedAt
        console.log('Loaded surveys:', savedSurveys.map(s => ({
          id: s.id,
          centerName: s.centerName,
          status: s.status,
          completedAt: s.completedAt,
          lastEditedAt: s.lastEditedAt
        })));
        setCurrentAssessmentId(savedCurrentAssessmentId);

        // Don't auto-show modal on startup - user can navigate freely
        // Modal will show when user clicks "Start New Assessment" or goes to Scoring tab
      }, []);

      // Calculate current assessment status
      const getAssessmentStatus = useCallback(() => {
        if (isFinalized) return 'completed';
        const scoredCount = Object.keys(scores).filter(id => scores[id]?.value !== undefined && scores[id]?.value !== null).length;
        if (scoredCount === 0) return 'not_started';
        return 'in_progress';
      }, [scores, isFinalized]);

      // Update survey status when scores change
      useEffect(() => {
        if (currentAssessmentId && assessmentDetails) {
          const status = getAssessmentStatus();
          const scoredCount = Object.keys(scores).filter(id => scores[id]?.value !== undefined && scores[id]?.value !== null).length;

          setSurveys(prev => {
            const updated = prev.map(s => {
              if (s.id === currentAssessmentId) {
                return {
                  ...s,
                  status: status,
                  scoredCount: scoredCount,
                  lastUpdated: new Date().toISOString(),
                  scores: scores
                };
              }
              return s;
            });
            storage.set(STORAGE_KEYS.SURVEYS, updated);
            return updated;
          });
        }
      }, [scores, currentAssessmentId, assessmentDetails, getAssessmentStatus]);

      // Configuration labels lookup
      const getConfigLabel = (configCode) => {
        const labels = {
          'A1': 'A - Surveyor 1',
          'A2': 'A - Surveyor 2',
          'B': 'B - Full Survey'
        };
        return labels[configCode] || labels['A1'];
      };

      // Handle assessment setup
      const handleAssessmentSetup = (details) => {
        // Generate a unique ID for this assessment
        const assessmentId = 'ASSESS_' + Date.now();

        // Create assessment record
        const newAssessment = {
          id: assessmentId,
          centerName: details.centerName,
          assessmentDetails: details,
          configuration: getConfigLabel(details.configuration || 'A1'),
          status: 'not_started',
          scoredCount: 0,
          totalSubstandards: 180, // Total substandards in the system
          stats: null,
          scores: {},
          createdAt: new Date().toISOString(),
          lastUpdated: new Date().toISOString()
        };

        // Save to surveys
        const updatedSurveys = [...surveys, newAssessment];
        setSurveys(updatedSurveys);
        storage.set(STORAGE_KEYS.SURVEYS, updatedSurveys);

        // Set current assessment
        setAssessmentDetails(details);
        setCurrentAssessmentId(assessmentId);
        storage.set('cbahi_assessment_details', details);
        storage.set('cbahi_current_assessment_id', assessmentId);

        // Reset viewing mode and finalized state for new assessment
        setViewingMode(false);
        setIsFinalized(false);
        setFinalizedData(null);

        setShowSetupModal(false);
        showToast('success', 'Assessment Created', `Assessment for ${details.centerName} is now active.`);
      };

      // Handle finalization
      const handleFinalize = async (stats) => {
        const assessmentData = {
          scores: scores,
          stats: stats,
          assessmentDetails: assessmentDetails,
          centerName: assessmentDetails?.centerName || 'Unknown Center',
          coordinatorName: assessmentDetails?.coordinatorName || '',
          coordinatorPhone: assessmentDetails?.coordinatorPhone || '',
          coordinatorEmail: assessmentDetails?.coordinatorEmail || '',
          configuration: assessmentDetails?.configuration ? getConfigLabel(assessmentDetails.configuration) : 'A - Surveyor 1',
          totalSubstandards: stats.total,
          scoredSubstandards: stats.scored,
          percentage: stats.percentage,
          fullyMet: stats.fullyMet,
          partialMet: stats.partial,
          notMet: stats.notMet,
          naCount: stats.na
        };

        try {
          const result = await firebaseHelpers.submitAssessment(assessmentData);
          const finalData = {
            ...assessmentData,
            submissionId: result.id,
            submittedAt: new Date().toISOString(),
            storageType: result.local ? 'local' : 'firebase'
          };
          setIsFinalized(true);
          setFinalizedData(finalData);
          storage.set('cbahi_finalized', true);
          storage.set('cbahi_finalized_data', finalData);

          // Update the existing assessment record to completed status
          setSurveys(prev => {
            const updated = prev.map(s => {
              if (s.id === currentAssessmentId) {
                const now = new Date().toISOString();
                // If already completed (re-finalization), keep original completedAt and add lastEditedAt
                // Check both status AND existing completedAt OR submissionId (for legacy records without completedAt)
                const isReFinalization = s.status === 'completed' && (s.completedAt || s.submissionId);
                console.log('Finalization check:', {
                  surveyId: s.id,
                  status: s.status,
                  completedAt: s.completedAt,
                  submissionId: s.submissionId,
                  isReFinalization
                });
                return {
                  ...s,
                  status: 'completed',
                  stats: stats,
                  scores: scores,
                  submissionId: result.id,
                  // Keep original completedAt if re-finalizing, otherwise set new one
                  // For legacy records without completedAt, preserve existing completedAt or use lastUpdated as fallback
                  completedAt: isReFinalization ? (s.completedAt || s.lastUpdated || now) : now,
                  // Add lastEditedAt for re-finalization
                  lastEditedAt: isReFinalization ? now : null,
                  lastUpdated: now,
                  storageType: result.local ? 'local' : 'firebase'
                };
              }
              return s;
            });
            storage.set(STORAGE_KEYS.SURVEYS, updated);
            return updated;
          });

          return { success: true, data: finalData };
        } catch (e) {
          console.error('Finalization error:', e);
          return { success: false, error: e.message };
        }
      };

      // Reset assessment (start new)
      const handleResetAssessment = () => {
        setConfirmDialog({
          open: true,
          title: 'Start New Assessment?',
          message: 'This will clear all current scores and assessment details. Submitted assessments will be preserved. Are you sure you want to start fresh?',
          type: 'warning',
          onConfirm: () => {
            setScores({});
            setIsFinalized(false);
            setFinalizedData(null);
            setAssessmentDetails(null);
            setCurrentAssessmentId(null);
            storage.set(STORAGE_KEYS.CURRENT_SCORES, {});
            storage.set('cbahi_finalized', false);
            storage.set('cbahi_finalized_data', null);
            storage.set('cbahi_assessment_details', null);
            storage.set('cbahi_current_assessment_id', null);
            setShowSetupModal(true);
            showToast('success', 'Assessment Reset', 'Ready to start a new assessment.');
          }
        });
      };

      // Go back to Scoring Home page (clear current assessment view)
      const handleGoToScoringHome = () => {
        setScores({});
        setIsFinalized(false);
        setFinalizedData(null);
        setAssessmentDetails(null);
        setCurrentAssessmentId(null);
        setViewingMode(false);
        setShowScoringHome(true);
        // Clear storage for current session
        storage.set(STORAGE_KEYS.CURRENT_SCORES, {});
        storage.set('cbahi_finalized', false);
        storage.set('cbahi_finalized_data', null);
        storage.set('cbahi_assessment_details', null);
        storage.set('cbahi_current_assessment_id', null);
      };

      // Handle editing survey details from History page
      const handleEditSurveyDetails = (survey) => {
        setEditingSurvey(survey);
      };

      // Handle deleting a survey with confirmation
      const handleDeleteSurvey = (survey) => {
        setConfirmDialog({
          open: true,
          title: 'Delete Assessment',
          message: `Are you sure you want to permanently delete the assessment for "${survey.centerName || survey.assessmentDetails?.centerName || 'this center'}"? This action cannot be undone.`,
          type: 'danger',
          onConfirm: () => {
            // Remove from surveys
            const updatedSurveys = surveys.filter(s => s.id !== survey.id);
            setSurveys(updatedSurveys);
            storage.set(STORAGE_KEYS.SURVEYS, updatedSurveys);

            // If deleting the current assessment, clear it
            if (survey.id === currentAssessmentId) {
              setCurrentAssessmentId(null);
              setAssessmentDetails(null);
              setScores({});
              setIsFinalized(false);
              setFinalizedData(null);
              storage.remove('cbahi_current_assessment_id');
              storage.remove('cbahi_assessment_details');
              storage.remove(STORAGE_KEYS.CURRENT_SCORES);
              storage.remove('cbahi_finalized');
              storage.remove('cbahi_finalized_data');
            }

            setConfirmDialog({ ...confirmDialog, open: false });
            showToast('success', 'Assessment Deleted', `"${survey.centerName || 'Assessment'}" has been permanently removed.`);
          }
        });
      };

      const handleSaveEditedSurvey = (updatedDetails) => {
        if (!editingSurvey) return;

        // Update the survey with new details
        const updatedSurveys = surveys.map(s => {
          if (s.id === editingSurvey.id) {
            return {
              ...s,
              assessmentDetails: updatedDetails,
              centerName: updatedDetails.centerName
            };
          }
          return s;
        });

        setSurveys(updatedSurveys);
        storage.set(STORAGE_KEYS.SURVEYS, updatedSurveys);

        // If editing the current assessment, update assessmentDetails too
        if (editingSurvey.id === currentAssessmentId) {
          setAssessmentDetails(updatedDetails);
          storage.set('cbahi_assessment_details', updatedDetails);
        }

        setEditingSurvey(null);
        showToast('success', 'Details Updated', 'Assessment details have been saved.');
      };

      // Handle resuming an in-progress or not-started assessment from History
      const handleResumeAssessment = (survey) => {
        // Load this survey's data as the current assessment
        setCurrentAssessmentId(survey.id);
        setAssessmentDetails(survey.assessmentDetails || null);

        // Load scores if available
        if (survey.scores) {
          setScores(survey.scores);
          storage.set(STORAGE_KEYS.CURRENT_SCORES, survey.scores);
        } else {
          setScores({});
          storage.set(STORAGE_KEYS.CURRENT_SCORES, {});
        }

        // Reset finalized state
        setIsFinalized(false);
        setFinalizedData(null);

        // Save as current assessment
        storage.set('cbahi_assessment_details', survey.assessmentDetails);
        storage.set('cbahi_current_assessment_id', survey.id);

        // Navigate to scoring page
        setCurrentPage('scoring');

        showToast('info', 'Assessment Loaded', `Resuming "${survey.assessmentDetails?.centerName || 'assessment'}"`);
      };

      // Handle viewing executive summary for completed assessment
      const handleViewSummary = (survey) => {
        setViewingSummary(survey);
      };

      // Handle viewing full scoring interface for a completed assessment
      const handleViewFullScoringInterface = (survey) => {
        // Enable viewing mode to show full interface instead of success screen
        setViewingMode(true);

        // Load the survey's scores into the current view
        setCurrentAssessmentId(survey.id);
        setAssessmentDetails(survey.assessmentDetails || {
          centerName: survey.centerName,
          coordinatorName: survey.coordinatorName || '',
          coordinatorPhone: survey.coordinatorPhone || '',
          coordinatorEmail: survey.coordinatorEmail || ''
        });

        // Load the scores from the survey
        if (survey.scores) {
          setScores(survey.scores);
          storage.set(STORAGE_KEYS.CURRENT_SCORES, survey.scores);
        }

        // Set as finalized if it's completed (keeps finalized badge, but viewingMode prevents success screen)
        if (survey.status === 'completed') {
          setIsFinalized(true);
          setFinalizedData({
            ...survey.stats,
            submissionId: survey.submissionId || survey.id,
            submittedAt: survey.completedAt,
            centerName: survey.centerName
          });
        } else {
          setIsFinalized(false);
          setFinalizedData(null);
        }

        // Close the modal and navigate to scoring page
        setViewingSummary(null);
        setCurrentPage('scoring');

        showToast('info', 'Assessment Loaded', `Viewing full scoring interface for "${survey.centerName || survey.assessmentDetails?.centerName}"`);
      };

      // Auto-save scores with debounce
      useEffect(() => {
        setSaving(true);
        if (saveTimeoutRef.current) clearTimeout(saveTimeoutRef.current);

        saveTimeoutRef.current = setTimeout(() => {
          storage.set(STORAGE_KEYS.CURRENT_SCORES, scores);
          setSaving(false);
        }, 500);

        return () => { if (saveTimeoutRef.current) clearTimeout(saveTimeoutRef.current); };
      }, [scores]);

      // Center operations
      const handleAddCenter = (center) => {
        const updated = [...centers, center];
        setCenters(updated);
        storage.set(STORAGE_KEYS.CENTERS, updated);
      };

      const handleDeleteCenter = (centerId) => {
        setConfirmDialog({
          open: true,
          title: 'Delete Center?',
          message: 'This will permanently delete this center and all associated surveys. This action cannot be undone.',
          type: 'danger',
          onConfirm: () => {
            const updatedCenters = centers.filter(c => c.id !== centerId);
            const updatedSurveys = surveys.filter(s => s.centerId !== centerId);
            setCenters(updatedCenters);
            setSurveys(updatedSurveys);
            storage.set(STORAGE_KEYS.CENTERS, updatedCenters);
            storage.set(STORAGE_KEYS.SURVEYS, updatedSurveys);
            showToast('success', 'Center Deleted', 'The center and its surveys have been removed.');
          }
        });
      };

      if (showLanding) {
        return <LandingPage
          onGetStarted={handleStartScoring}
          onLogin={() => {
            setShowLanding(false);
            setCurrentPage('dashboard'); // Go to Dashboard after login
          }}
        />;
      }

      return (
        <div className="app">
          <header className="header">
            {/* Test Drive Banner */}
            {isTestDrive && (
              <div style={{
                background: 'linear-gradient(135deg, #f39c12 0%, #e67e22 100%)',
                color: 'white',
                padding: '8px 24px',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                gap: '12px',
                fontSize: '14px',
                fontWeight: 600
              }}>
                <span> TEST MODE - Data will not be saved</span>
                <button
                  onClick={handleExitTestDrive}
                  style={{
                    background: 'rgba(255,255,255,0.2)',
                    border: '1px solid rgba(255,255,255,0.4)',
                    color: 'white',
                    padding: '4px 12px',
                    borderRadius: '4px',
                    cursor: 'pointer',
                    fontSize: '12px',
                    fontWeight: 600
                  }}
                >
                  Exit Test
                </button>
              </div>
            )}
            <div className="header-top">
              {/* Home Button - Positioned absolutely on left */}
              <button
                onClick={handleGoHome}
                title="Return to Landing Page"
                style={{
                  position: 'absolute',
                  left: '24px',
                  background: 'rgba(255,255,255,0.15)',
                  border: '1px solid rgba(255,255,255,0.3)',
                  borderRadius: '8px',
                  padding: '8px 10px',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  transition: 'all 0.2s ease'
                }}
                onMouseOver={e => e.currentTarget.style.background = 'rgba(255,255,255,0.25)'}
                onMouseOut={e => e.currentTarget.style.background = 'rgba(255,255,255,0.15)'}
              >
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                  <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                  <polyline points="9,22 9,12 15,12 15,22" />
                </svg>
              </button>
              {/* Logo - Centered */}
              <div className="logo" onClick={() => setCurrentPage('dashboard')}>
                <div className="logo-icon">
                  <img src="assets/logo-sh.png" alt="StandardsHub" />
                </div>
                <div className="logo-text">
                  <h1>StandardsHub</h1>
                  <span>Dental Center Accreditation</span>
                </div>
              </div>
            </div>
            <div className="nav-tabs">
              <div className={`nav-tab ${currentPage === 'dashboard' ? 'active' : ''}`}
                data-tab="dashboard"
                onClick={() => setCurrentPage('dashboard')}>Dashboard</div>
              <div className={`nav-tab ${currentPage === 'centers' ? 'active' : ''}`}
                data-tab="history"
                onClick={() => setCurrentPage('centers')}>History</div>
              {/* Scoring tab - Hidden on mobile */}
              {!isMobileApp && (
              <div className={`nav-tab ${currentPage === 'scoring' ? 'active' : ''}`}
                data-tab="scoring"
                onClick={() => {
                  // If viewing a finalized/historical assessment, reset to Scoring Home
                  if (viewingMode || (isFinalized && !isTestDrive)) {
                    handleGoToScoringHome();
                  }
                  setCurrentPage('scoring');
                }}>Scoring</div>
              )}
            </div>
          </header>

          {currentPage === 'scoring' && showScoringHome && !assessmentDetails && !isTestDrive && (
            <ScoringHomePage
              onNewAssessment={() => {
                setShowScoringHome(false);
                setShowSetupModal(true);
              }}
              onTestDrive={() => {
                setIsTestDrive(true);
                setShowScoringHome(false);
              }}
            />
          )}

          {currentPage === 'scoring' && (!showScoringHome || assessmentDetails || isTestDrive) && (
            <ScoringPage
              scores={scores}
              setScores={setScores}
              saving={saving}
              isFinalized={isFinalized}
              finalizedData={finalizedData}
              viewingMode={viewingMode}
              setViewingMode={setViewingMode}
              onFinalize={handleFinalize}
              onReset={handleResetAssessment}
              onGoHome={handleGoToScoringHome}
              showToast={showToast}
              assessmentDetails={assessmentDetails}
              onEditDetails={() => setShowSetupModal(true)}
              onNavigateToHistory={() => setCurrentPage('centers')}
              onConfigChange={(newConfig) => {
                const updatedDetails = { ...assessmentDetails, configuration: newConfig };
                setAssessmentDetails(updatedDetails);
                storage.set('cbahi_assessment_details', updatedDetails);
                if (currentAssessmentId) {
                  const updatedSurveys = surveys.map(s =>
                    s.id === currentAssessmentId
                      ? { ...s, assessmentDetails: updatedDetails, configuration: getConfigLabel(newConfig) }
                      : s
                  );
                  setSurveys(updatedSurveys);
                  storage.set(STORAGE_KEYS.SURVEYS, updatedSurveys);
                }
                showToast('success', 'Configuration Changed', `Switched to ${getConfigLabel(newConfig)}`);
              }}
            />
          )}

          {currentPage === 'dashboard' && (
            <DashboardPage
              centers={centers}
              surveys={surveys}
              onEditSurvey={handleEditSurveyDetails}
              onDeleteSurvey={handleDeleteSurvey}
              onNewAssessment={() => {
                // Go to Scoring Home page with the two options
                handleGoToScoringHome();
                setCurrentPage('scoring');
              }}
            />
          )}

          {currentPage === 'centers' && (
            <CentersPage
              surveys={surveys}
              currentAssessmentId={currentAssessmentId}
              onEditSurvey={handleEditSurveyDetails}
              onDeleteSurvey={handleDeleteSurvey}
              onResumeAssessment={handleResumeAssessment}
              onViewSummary={handleViewSummary}
            />
          )}

          {/* Edit Survey Modal */}
          <AssessmentSetupModal
            isOpen={!!editingSurvey}
            onClose={() => setEditingSurvey(null)}
            onStart={handleSaveEditedSurvey}
            existingData={editingSurvey?.assessmentDetails}
            isEditing={true}
          />

          {/* Toast Notifications */}
          <ToastNotification toasts={toasts} onDismiss={dismissToast} />

          {/* Modern Confirm Dialog */}
          <ModernConfirmDialog
            isOpen={confirmDialog.open}
            onClose={() => setConfirmDialog({ ...confirmDialog, open: false })}
            onConfirm={confirmDialog.onConfirm}
            title={confirmDialog.title}
            message={confirmDialog.message}
            type={confirmDialog.type}
          />

          {/* Assessment Setup Modal */}
          <AssessmentSetupModal
            isOpen={showSetupModal}
            onClose={() => setShowSetupModal(false)}
            onStart={handleAssessmentSetup}
            existingData={assessmentDetails}
          />

          {/* Executive Summary Modal */}
          {viewingSummary && (
            <ExecutiveSummaryModal
              survey={viewingSummary}
              onClose={() => setViewingSummary(null)}
              chapters={getChaptersByConfig(viewingSummary?.assessmentDetails?.configuration || 'A1')}
              onViewFullDetails={handleViewFullScoringInterface}
            />
          )}
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>

</html>