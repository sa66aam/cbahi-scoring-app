<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CBAHI Dental Center Accreditation Scoring</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #1e3a5f;
      --primary-light: #2d5a8a;
      --primary-dark: #0f2744;
      --accent: #3498db;
      --accent-hover: #2980b9;
      --success: #27ae60;
      --success-light: #d4edda;
      --warning: #f39c12;
      --warning-light: #fff3cd;
      --danger: #e74c3c;
      --danger-light: #f8d7da;
      --neutral: #95a5a6;
      --bg-main: #f8fafc;
      --bg-card: #ffffff;
      --bg-hover: #f1f5f9;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --border: #e2e8f0;
      --border-focus: #3498db;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
      --radius-sm: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Lora', Georgia, 'Times New Roman', serif;
      background: var(--bg-main);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow-lg);
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 24px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: white;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: var(--primary);
      font-size: 14px;
    }

    .logo-text h1 {
      font-size: 18px;
      font-weight: 600;
      letter-spacing: -0.5px;
    }

    .logo-text span {
      font-size: 11px;
      opacity: 0.8;
    }

    /* Navigation Tabs */
    .nav-tabs {
      display: flex;
      gap: 4px;
      padding: 0 24px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .nav-tab {
      padding: 12px 20px;
      color: rgba(255,255,255,0.7);
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      border-bottom: 3px solid transparent;
      transition: all 0.2s ease;
    }

    .nav-tab:hover {
      color: white;
      background: rgba(255,255,255,0.05);
    }

    .nav-tab.active {
      color: white;
      border-bottom-color: white;
      background: rgba(255,255,255,0.1);
    }

    /* Auto-save indicator */
    .autosave-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 14px;
      background: rgba(39, 174, 96, 0.15);
      border-radius: var(--radius-md);
      font-size: 12px;
      color: #2ecc71;
    }

    .autosave-indicator.saving {
      background: rgba(52, 152, 219, 0.15);
      color: #3498db;
    }

    .autosave-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
    }

    .autosave-indicator.saving .autosave-dot {
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* Controls Bar */
    .controls-bar {
      background: var(--bg-card);
      padding: 14px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .control-label {
      font-family: inherit;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
    }

    select, .search-input {
      padding: 12px 18px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-family: inherit;
      font-size: 15px;
      font-weight: 500;
      background: var(--bg-card);
      color: var(--text-primary);
      transition: all 0.2s ease;
      min-width: 220px;
    }

    select:focus, .search-input:focus {
      outline: none;
      border-color: var(--border-focus);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    select:disabled {
      background: var(--bg-hover);
      color: var(--text-muted);
      cursor: not-allowed;
    }

    .chapters-summary-btn {
      background: linear-gradient(135deg, #1a5276 0%, #2980b9 100%);
      color: white;
      padding: 14px 28px;
      border-radius: 25px;
      font-family: inherit;
      font-weight: 700;
      cursor: pointer;
      border: 2px solid rgba(255,255,255,0.15);
      display: flex;
      align-items: center;
      gap: 14px;
      font-size: 16px;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      transition: all 0.2s ease;
      margin-left: auto;
      box-shadow: 0 4px 12px rgba(26, 82, 118, 0.3);
    }

    .chapters-summary-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(26, 82, 118, 0.4);
      background: linear-gradient(135deg, #1e6091 0%, #3498db 100%);
    }

    .summary-numbers {
      background: rgba(255,255,255,0.2);
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      letter-spacing: 0;
    }

    /* Sidebar Toggle */
    .sidebar-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 18px;
      color: var(--text-secondary);
    }

    .sidebar-toggle:hover {
      background: var(--bg-hover);
      color: var(--primary);
    }

    /* Main Layout */
    .main-container {
      display: flex;
      min-height: calc(100vh - 200px);
    }

    .sidebar {
      width: 260px;
      background: var(--bg-card);
      border-right: 1px solid var(--border);
      padding: 16px 0;
      position: sticky;
      top: 120px;
      height: fit-content;
      max-height: calc(100vh - 220px);
      overflow-y: auto;
      transition: all 0.3s ease;
      flex-shrink: 0;
      padding-bottom: 80px;
    }

    .sidebar.collapsed {
      width: 0;
      padding: 0;
      overflow: hidden;
      border-right: none;
    }

    .sidebar-section {
      padding: 0 12px;
      margin-bottom: 20px;
    }

    .sidebar-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      margin-bottom: 12px;
      padding: 0 8px;
    }

    .standard-nav-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 11px 14px;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 4px;
    }

    .standard-nav-item:hover { background: var(--bg-hover); }
    .standard-nav-item.active {
      background: rgba(52, 152, 219, 0.1);
      color: var(--accent);
    }

    .standard-nav-code {
      font-weight: 600;
      font-size: 14px;
    }

    .standard-nav-count {
      font-size: 12px;
      color: var(--text-muted);
      background: var(--bg-hover);
      padding: 3px 10px;
      border-radius: 12px;
    }

    .standard-nav-item.active .standard-nav-count {
      background: rgba(52, 152, 219, 0.2);
      color: var(--accent);
    }

    .standard-nav-progress {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .standard-nav-check {
      color: var(--success);
      font-size: 12px;
    }

    .content-area {
      flex: 1;
      padding: 20px 24px;
      padding-bottom: 120px;
    }

    .content-header {
      margin-bottom: 24px;
      padding-bottom: 18px;
      border-bottom: 1px solid var(--border);
    }

    .content-header h2 {
      font-size: 22px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 6px;
      line-height: 1.4;
    }

    .standard-intent {
      font-size: 15px;
      color: var(--text-secondary);
      line-height: 1.6;
      margin: 10px 0 14px 0;
      padding: 14px 18px;
      background: var(--bg-hover);
      border-radius: var(--radius-md);
      border-left: 4px solid var(--primary);
    }

    /* Mother Standard Sections (All Standards View) */
    .mother-standard-section {
      margin-bottom: 32px;
      border-radius: var(--radius-lg);
      overflow: hidden;
    }

    .mother-standard-header {
      display: flex;
      align-items: flex-start;
      gap: 18px;
      padding: 22px 24px;
      background: linear-gradient(135deg, #f0f7ff 0%, #e8f4fd 100%);
      border: 1px solid #c7dff7;
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
      margin-bottom: 0;
    }

    .mother-standard-code {
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 64px;
      height: 64px;
      background: linear-gradient(135deg, #1e6bb8 0%, #1a5a9e 100%);
      color: white;
      font-weight: 700;
      font-size: 15px;
      border-radius: var(--radius-md);
      box-shadow: 0 2px 8px rgba(30, 107, 184, 0.3);
    }

    .mother-standard-content {
      flex: 1;
      min-width: 0;
    }

    .mother-standard-title {
      font-size: 18px;
      font-weight: 600;
      color: #1a4971;
      margin: 0 0 12px 0;
      line-height: 1.45;
    }

    .mother-standard-intent {
      font-size: 15px;
      color: #3d6a8a;
      line-height: 1.6;
      margin: 0;
      padding: 14px 16px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: var(--radius-sm);
      border-left: 4px solid #3d8fd1;
    }

    .mother-standard-badge {
      font-size: 13px;
      font-weight: 600;
      color: #1e6bb8;
      background: rgba(255, 255, 255, 0.85);
      padding: 8px 14px;
      border-radius: 20px;
      white-space: nowrap;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .mother-standard-substandards {
      padding: 20px 0 0 0;
      border-left: 3px solid #e0edfa;
      margin-left: 32px;
      padding-left: 24px;
    }

    .mother-standard-substandards .substandard-card {
      margin-bottom: 14px;
    }

    .mother-standard-substandards .substandard-card:last-child {
      margin-bottom: 0;
    }

    /* Single Standard View - substandards list */
    .single-standard-substandards {
      padding-left: 0;
    }

    .single-standard-substandards .substandard-card {
      margin-bottom: 14px;
    }

    .single-standard-substandards .substandard-card:last-child {
      margin-bottom: 0;
    }

    .substandard-count {
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* Sub-standard Cards */
    .substandard-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      margin-bottom: 14px;
      overflow: hidden;
      transition: all 0.2s ease;
    }

    .substandard-card:hover { box-shadow: var(--shadow-md); }
    .substandard-card.scored-0 { border-left: 4px solid var(--danger); }
    .substandard-card.scored-1 { border-left: 4px solid var(--warning); }
    .substandard-card.scored-2 { border-left: 4px solid var(--success); }
    .substandard-card.scored-na { border-left: 4px solid var(--neutral); }

    /* Domain Separator Styles for Full Survey (Config B) */
    .domain-separator {
      position: relative;
      margin: 32px 0 24px 0;
      padding: 20px 24px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(30, 58, 95, 0.03) 0%, rgba(52, 152, 219, 0.06) 100%);
      border: 1px solid rgba(52, 152, 219, 0.15);
      overflow: hidden;
    }

    .domain-separator::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 5px;
      border-radius: 12px 0 0 12px;
    }

    .domain-separator::after {
      content: '';
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      width: 60px;
      height: 60px;
      border-radius: 50%;
      opacity: 0.08;
    }

    .domain-separator.domain-ld::before { background: linear-gradient(180deg, #1e3a5f 0%, #3498db 100%); }
    .domain-separator.domain-ld::after { background: #1e3a5f; }
    .domain-separator.domain-ld { border-left-color: #3498db; }

    .domain-separator.domain-pc::before { background: linear-gradient(180deg, #0d6b4e 0%, #27ae60 100%); }
    .domain-separator.domain-pc::after { background: #0d6b4e; }
    .domain-separator.domain-pc { border-left-color: #27ae60; }

    .domain-separator.domain-dl::before { background: linear-gradient(180deg, #6b4e0d 0%, #f39c12 100%); }
    .domain-separator.domain-dl::after { background: #6b4e0d; }
    .domain-separator.domain-dl { border-left-color: #f39c12; }

    .domain-separator.domain-ipc::before { background: linear-gradient(180deg, #5e1e5e 0%, #9b59b6 100%); }
    .domain-separator.domain-ipc::after { background: #5e1e5e; }
    .domain-separator.domain-ipc { border-left-color: #9b59b6; }

    .domain-separator.domain-moi::before { background: linear-gradient(180deg, #1e5e5e 0%, #16a085 100%); }
    .domain-separator.domain-moi::after { background: #1e5e5e; }
    .domain-separator.domain-moi { border-left-color: #16a085; }

    .domain-separator.domain-fms::before { background: linear-gradient(180deg, #5e1e2d 0%, #e74c3c 100%); }
    .domain-separator.domain-fms::after { background: #5e1e2d; }
    .domain-separator.domain-fms { border-left-color: #e74c3c; }

    .domain-separator-content {
      display: flex;
      align-items: center;
      gap: 16px;
      position: relative;
      z-index: 1;
    }

    .domain-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 16px;
      color: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .domain-icon.domain-ld { background: linear-gradient(135deg, #1e3a5f 0%, #2d5a8a 100%); }
    .domain-icon.domain-pc { background: linear-gradient(135deg, #0d6b4e 0%, #1a9d6c 100%); }
    .domain-icon.domain-dl { background: linear-gradient(135deg, #6b4e0d 0%, #9d7a1a 100%); }
    .domain-icon.domain-ipc { background: linear-gradient(135deg, #5e1e5e 0%, #8a3d8a 100%); }
    .domain-icon.domain-moi { background: linear-gradient(135deg, #1e5e5e 0%, #3d8a8a 100%); }
    .domain-icon.domain-fms { background: linear-gradient(135deg, #5e1e2d 0%, #8a3d4d 100%); }

    .domain-info { flex: 1; }

    .domain-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
      font-family: 'Inter', sans-serif;
    }

    .domain-subtitle {
      font-size: 13px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .domain-stats {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-left: auto;
    }

    .domain-stat {
      text-align: center;
      padding: 8px 16px;
      background: rgba(255,255,255,0.7);
      border-radius: 8px;
      min-width: 70px;
    }

    .domain-stat-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--primary);
      font-family: 'Inter', sans-serif;
    }

    .domain-stat-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Full Survey sidebar navigation */
    .sidebar-domain-group {
      margin-bottom: 4px;
      border-radius: 8px;
      overflow: hidden;
      transition: all 0.2s ease;
    }

    .sidebar-domain-group:hover {
      background: rgba(52, 152, 219, 0.03);
    }

    .sidebar-domain-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 2px;
      user-select: none;
    }

    .sidebar-domain-header:hover {
      background: rgba(52, 152, 219, 0.1);
    }

    .sidebar-domain-header.active {
      background: rgba(52, 152, 219, 0.15);
      border-left: 3px solid var(--accent);
    }

    .sidebar-domain-header:active {
      transform: scale(0.98);
    }

    .sidebar-domain-toggle {
      cursor: pointer;
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-hover);
      border-radius: 4px;
      font-size: 10px;
      color: var(--text-muted);
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .sidebar-domain-toggle:hover {
      background: var(--accent);
      color: white;
    }

    .sidebar-domain-toggle.expanded {
      transform: rotate(90deg);
    }

    .sidebar-domain-badge {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 11px;
      color: white;
    }

    .sidebar-domain-badge.domain-ld { background: linear-gradient(135deg, #1e3a5f 0%, #3498db 100%); }
    .sidebar-domain-badge.domain-pc { background: linear-gradient(135deg, #0d6b4e 0%, #27ae60 100%); }
    .sidebar-domain-badge.domain-dl { background: linear-gradient(135deg, #6b4e0d 0%, #f39c12 100%); }
    .sidebar-domain-badge.domain-ipc { background: linear-gradient(135deg, #5e1e5e 0%, #9b59b6 100%); }
    .sidebar-domain-badge.domain-moi { background: linear-gradient(135deg, #1e5e5e 0%, #16a085 100%); }
    .sidebar-domain-badge.domain-fms { background: linear-gradient(135deg, #5e1e2d 0%, #e74c3c 100%); }

    .sidebar-domain-name {
      flex: 1;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .sidebar-domain-count {
      font-size: 12px;
      color: var(--text-muted);
      background: var(--bg-hover);
      padding: 2px 8px;
      border-radius: 10px;
    }

    .sidebar-domain-standards {
      margin-left: 24px;
      border-left: 2px solid var(--border);
      padding-left: 10px;
      margin-bottom: 4px;
      margin-top: 4px;
    }

    /* Full Survey View Styles */
    .full-survey-view {
      scroll-behavior: smooth;
    }

    .domain-section {
      scroll-margin-top: 20px;
      padding-top: 8px;
    }

    .domain-section:first-child .domain-separator {
      margin-top: 0;
    }

    /* Sticky domain navigation for full survey */
    .domain-quick-nav {
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--bg-main);
      padding: 12px 0;
      margin-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .substandard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 18px;
      background: var(--bg-hover);
      border-bottom: 1px solid var(--border);
    }

    .substandard-code {
      font-weight: 700;
      font-size: 16px;
      color: var(--primary);
    }

    .activity-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 12px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 600;
    }

    .activity-badge.doc { background: #e3f2fd; color: #1565c0; }
    .activity-badge.obs { background: #fff3e0; color: #e65100; }
    .activity-badge.int { background: #f3e5f5; color: #7b1fa2; }
    .activity-badge.per { background: #e8f5e9; color: #2e7d32; }
    .activity-badge.den { background: #fce4ec; color: #c2185b; }

    .substandard-body { padding: 18px 20px; }

    .substandard-text {
      font-size: 15px;
      line-height: 1.7;
      color: var(--text-primary);
      margin-bottom: 18px;
    }

    .scoring-section {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: flex-start;
    }

    .score-options {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .score-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border: 2px solid var(--border);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
      font-weight: 500;
    }

    .score-option:hover { border-color: var(--text-muted); }
    .score-option.selected { border-color: var(--primary); background: rgba(30, 58, 95, 0.05); }
    .score-option.na.selected { border-color: var(--neutral); background: rgba(149, 165, 166, 0.1); }
    .score-option.not-met.selected { border-color: var(--danger); background: rgba(231, 76, 60, 0.1); }
    .score-option.partial.selected { border-color: var(--warning); background: rgba(243, 156, 18, 0.1); }
    .score-option.full.selected { border-color: var(--success); background: rgba(39, 174, 96, 0.1); }

    .score-indicator {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      color: white;
    }

    .score-indicator.na { background: var(--neutral); }
    .score-indicator.not-met { background: var(--danger); }
    .score-indicator.partial { background: var(--warning); }
    .score-indicator.full { background: var(--success); }

    .comment-section {
      flex: 1;
      min-width: 280px;
    }

    .comment-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      min-height: 54px;
      transition: all 0.2s ease;
    }

    .comment-input:focus {
      outline: none;
      border-color: var(--border-focus);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .location-field { margin-top: 10px; }

    .location-input {
      width: 100%;
      max-width: 300px;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 14px;
    }

    .location-input:focus {
      outline: none;
      border-color: var(--border-focus);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    /* Score Summary Panel */
    .score-summary-panel {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-card);
      border-top: 1px solid var(--border);
      padding: 14px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 -4px 6px -1px rgba(0,0,0,0.1);
      z-index: 50;
    }

    .score-display {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .score-main { text-align: center; }

    .score-percentage {
      font-size: 32px;
      font-weight: 700;
      line-height: 1;
    }

    .score-percentage.excellent { color: var(--success); }
    .score-percentage.good { color: #d97706; }
    .score-percentage.needs-improvement { color: var(--warning); }
    .score-percentage.critical { color: var(--danger); }

    .score-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .score-breakdown {
      display: flex;
      gap: 16px;
    }

    .breakdown-item {
      text-align: center;
      padding: 6px 14px;
      background: var(--bg-hover);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s ease;
      border: 2px solid transparent;
    }

    .breakdown-item:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }

    .breakdown-item.active {
      border-color: var(--primary);
      background: rgba(30, 58, 95, 0.1);
    }

    .breakdown-item.active.filter-full { border-color: var(--success); background: rgba(39, 174, 96, 0.1); }
    .breakdown-item.active.filter-partial { border-color: var(--warning); background: rgba(243, 156, 18, 0.1); }
    .breakdown-item.active.filter-not-met { border-color: var(--danger); background: rgba(231, 76, 60, 0.1); }
    .breakdown-item.active.filter-na { border-color: var(--neutral); background: rgba(149, 165, 166, 0.1); }

    .breakdown-item.not-scored-item {
      background: rgba(142, 68, 173, 0.08);
      border: 2px dashed rgba(142, 68, 173, 0.3);
    }
    .breakdown-item.not-scored-item:hover {
      background: rgba(142, 68, 173, 0.12);
      border-color: rgba(142, 68, 173, 0.5);
    }

    .breakdown-value { font-size: 20px; font-weight: 600; }
    .breakdown-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.3px; }

    .progress-bar-container {
      flex: 1;
      max-width: 350px;
      margin: 0 20px;
    }

    .progress-bar {
      height: 8px;
      background: var(--bg-hover);
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      transition: width 0.3s ease;
      border-radius: 4px;
    }

    .progress-text {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 5px;
      text-align: center;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: var(--radius-md);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      text-decoration: none;
    }

    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { background: var(--accent-hover); transform: translateY(-1px); }
    .btn-success { background: var(--success); color: white; }
    .btn-success:hover { background: #219a52; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-danger:hover { background: #c0392b; }
    .btn-outline-dark {
      background: transparent;
      color: var(--text-primary);
      border: 1px solid var(--border);
    }
    .btn-outline-dark:hover { background: var(--bg-hover); }
    .btn-sm { padding: 6px 12px; font-size: 13px; }

    /* Modals */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 24px;
      animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal {
      background: var(--bg-card);
      border-radius: 16px;
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(255, 255, 255, 0.1);
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from { opacity: 0; transform: scale(0.95) translateY(-10px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }

    .modal-header {
      padding: 18px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      font-size: 18px;
      font-weight: 600;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: var(--bg-hover);
      cursor: pointer;
      font-size: 18px;
      color: var(--text-secondary);
      transition: all 0.2s ease;
    }

    .modal-close:hover { background: var(--border); }

    .modal-body {
      padding: 24px;
      overflow-y: auto;
      max-height: calc(90vh - 130px);
    }

    /* Completion Celebration Modal */
    .completion-modal {
      text-align: center;
      padding: 40px;
    }

    .completion-icon {
      font-size: 80px;
      margin-bottom: 20px;
      animation: bounce 0.6s ease infinite alternate;
    }

    @keyframes bounce {
      from { transform: translateY(0); }
      to { transform: translateY(-10px); }
    }

    .completion-title {
      font-size: 28px;
      font-weight: 700;
      color: var(--success);
      margin-bottom: 12px;
    }

    .completion-subtitle {
      font-size: 16px;
      color: var(--text-secondary);
      margin-bottom: 30px;
    }

    .completion-stats {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-bottom: 30px;
      padding: 20px;
      background: var(--bg-hover);
      border-radius: var(--radius-lg);
    }

    .completion-stat {
      text-align: center;
    }

    .completion-stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--primary);
    }

    .completion-stat-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    /* Finalize Button */
    .finalize-btn {
      background: linear-gradient(135deg, var(--success) 0%, #219a52 100%);
      color: white;
      padding: 14px 28px;
      border-radius: 25px;
      font-family: inherit;
      font-weight: 700;
      font-size: 15px;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
    }

    .finalize-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(39, 174, 96, 0.4);
    }

    .finalize-btn:disabled {
      background: var(--neutral);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .finalize-btn-small {
      padding: 10px 20px;
      font-size: 13px;
      border-radius: 20px;
    }

    /* Confirmation Dialog */
    .confirm-dialog {
      text-align: center;
      padding: 30px;
    }

    .confirm-icon {
      font-size: 60px;
      margin-bottom: 20px;
    }

    .confirm-title {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .confirm-message {
      font-size: 15px;
      color: var(--text-secondary);
      margin-bottom: 30px;
      line-height: 1.6;
    }

    .confirm-buttons {
      display: flex;
      justify-content: center;
      gap: 16px;
    }

    .confirm-btn {
      padding: 12px 30px;
      border-radius: 25px;
      font-family: inherit;
      font-weight: 600;
      font-size: 14px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .confirm-btn-cancel {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .confirm-btn-cancel:hover {
      background: var(--border);
    }

    .confirm-btn-submit {
      background: linear-gradient(135deg, var(--success) 0%, #219a52 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
    }

    .confirm-btn-submit:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(39, 174, 96, 0.4);
    }

    /* Finalized Badge */
    .finalized-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: linear-gradient(135deg, var(--success) 0%, #219a52 100%);
      color: white;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }

    /* Modern Toast Notification */
    .toast-container {
      position: fixed;
      top: 24px;
      right: 24px;
      z-index: 300;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .toast {
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15), 0 2px 10px rgba(0,0,0,0.1);
      padding: 20px 24px;
      min-width: 360px;
      max-width: 450px;
      display: flex;
      align-items: flex-start;
      gap: 16px;
      animation: slideIn 0.3s ease;
      border-left: 4px solid var(--success);
    }

    .toast.error {
      border-left-color: var(--danger);
    }

    .toast.warning {
      border-left-color: var(--warning);
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }

    .toast.closing {
      animation: slideOut 0.3s ease forwards;
    }

    .toast-icon {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      flex-shrink: 0;
    }

    .toast-icon.success {
      background: rgba(39, 174, 96, 0.1);
      color: var(--success);
    }

    .toast-icon.error {
      background: rgba(231, 76, 60, 0.1);
      color: var(--danger);
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 600;
      font-size: 16px;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .toast-message {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .toast-close {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 20px;
      padding: 4px;
      margin: -4px -4px 0 0;
      transition: color 0.2s;
    }

    .toast-close:hover {
      color: var(--text-primary);
    }

    /* Modern Confirm Modal */
    .modern-confirm {
      max-width: 440px;
    }

    .modern-confirm-body {
      text-align: center;
      padding: 40px 32px;
    }

    .modern-confirm-icon {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
      font-size: 36px;
    }

    .modern-confirm-icon.warning {
      background: rgba(243, 156, 18, 0.1);
      color: var(--warning);
    }

    .modern-confirm-icon.danger {
      background: rgba(231, 76, 60, 0.1);
      color: var(--danger);
    }

    .modern-confirm-title {
      font-size: 22px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
    }

    .modern-confirm-message {
      font-size: 15px;
      color: var(--text-secondary);
      line-height: 1.6;
      margin-bottom: 32px;
    }

    .modern-confirm-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .modern-btn {
      padding: 14px 28px;
      border-radius: 10px;
      font-family: inherit;
      font-weight: 600;
      font-size: 15px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 120px;
    }

    .modern-btn-secondary {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .modern-btn-secondary:hover {
      background: var(--border);
    }

    .modern-btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(30, 58, 95, 0.3);
    }

    .modern-btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(30, 58, 95, 0.4);
    }

    .modern-btn-danger {
      background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
    }

    .modern-btn-danger:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(231, 76, 60, 0.4);
    }

    .modern-btn-success {
      background: linear-gradient(135deg, var(--success) 0%, #219a52 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
    }

    .modern-btn-success:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(39, 174, 96, 0.4);
    }

    /* Assessment Status Badges */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 24px;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-badge.not-started {
      background: linear-gradient(135deg, rgba(149, 165, 166, 0.15) 0%, rgba(149, 165, 166, 0.25) 100%);
      color: #7f8c8d;
      border: 2px solid rgba(149, 165, 166, 0.3);
    }

    .status-badge.in-progress {
      background: linear-gradient(135deg, rgba(52, 152, 219, 0.15) 0%, rgba(41, 128, 185, 0.25) 100%);
      color: #2980b9;
      border: 2px solid rgba(52, 152, 219, 0.4);
      animation: progressPulse 2s infinite;
    }

    @keyframes progressPulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.4); }
      50% { box-shadow: 0 0 0 8px rgba(52, 152, 219, 0); }
    }

    .status-badge.completed {
      background: linear-gradient(135deg, rgba(39, 174, 96, 0.15) 0%, rgba(33, 154, 82, 0.25) 100%);
      color: #27ae60;
      border: 2px solid rgba(39, 174, 96, 0.4);
    }

    /* Assessment Card for History */
    .assessment-card {
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
      transition: all 0.3s ease;
      border: 1px solid var(--border);
    }

    .assessment-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
    }

    .assessment-card.current {
      border: 2px solid var(--accent);
      box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.1);
    }

    .assessment-card-header {
      padding: 24px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      position: relative;
    }

    .assessment-card-header.in-progress {
      background: linear-gradient(135deg, #2980b9 0%, #3498db 100%);
    }

    .assessment-card-header.completed {
      background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
    }

    .assessment-card-header.not-started {
      background: linear-gradient(135deg, #7f8c8d 0%, #95a5a6 100%);
    }

    .assessment-card-logo {
      width: 64px;
      height: 64px;
      background: rgba(255,255,255,0.2);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      margin-bottom: 16px;
    }

    .assessment-card-center-name {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .assessment-card-coordinator {
      font-size: 14px;
      opacity: 0.9;
    }

    .assessment-card-body {
      padding: 24px;
    }

    .assessment-card-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }

    .assessment-stat-item {
      text-align: center;
      padding: 12px;
      background: var(--bg-hover);
      border-radius: 12px;
    }

    .assessment-stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .assessment-stat-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 4px;
    }

    .assessment-card-footer {
      padding: 16px 24px;
      background: var(--bg-hover);
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .current-badge {
      background: linear-gradient(135deg, var(--accent) 0%, #2980b9 100%);
      color: white;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      animation: currentPulse 2s infinite;
    }

    @keyframes currentPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* Center Details Form Modal */
    .center-form-modal {
      max-width: 500px;
    }

    .center-form-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      padding: 28px 32px;
      text-align: center;
    }

    .center-form-header h3 {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .center-form-header p {
      font-size: 14px;
      opacity: 0.9;
    }

    .center-form-body {
      padding: 32px;
    }

    .form-group {
      margin-bottom: 24px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .form-label .required {
      color: var(--danger);
      margin-left: 2px;
    }

    .form-input {
      width: 100%;
      padding: 14px 18px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-family: inherit;
      font-size: 15px;
      color: var(--text-primary);
      transition: all 0.2s ease;
      background: white;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.1);
    }

    .form-input::placeholder {
      color: var(--text-muted);
    }

    .form-input.error {
      border-color: var(--danger);
    }

    .form-error {
      font-size: 13px;
      color: var(--danger);
      margin-top: 6px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .form-actions {
      display: flex;
      gap: 12px;
      margin-top: 32px;
    }

    .form-actions .modern-btn {
      flex: 1;
    }

    /* Contact Links */
    .contact-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--accent);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s;
    }

    .contact-link:hover {
      color: var(--primary);
    }

    .contact-link.whatsapp {
      color: #25D366;
    }

    .contact-link.whatsapp:hover {
      color: #128C7E;
    }

    .contact-link.email {
      color: var(--accent);
    }

    /* Assessment Info Bar */
    .assessment-info-bar {
      background: linear-gradient(135deg, rgba(30, 58, 95, 0.05) 0%, rgba(52, 152, 219, 0.05) 100%);
      border: 1px solid rgba(52, 152, 219, 0.2);
      border-radius: 10px;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .assessment-center-name {
      font-weight: 600;
      font-size: 16px;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .assessment-coordinator {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .coordinator-name {
      font-weight: 500;
      color: var(--text-primary);
    }

    /* Chapter Summary Modal */
    .chapter-summary-grid { display: grid; gap: 12px; }

    .chapter-summary-row {
      display: grid;
      grid-template-columns: 80px 1fr repeat(5, 55px);
      gap: 8px;
      align-items: center;
      padding: 14px 18px;
      background: var(--bg-hover);
      border-radius: var(--radius-md);
      font-size: 15px;
    }

    .chapter-summary-row.header {
      background: var(--primary);
      color: white;
      font-weight: 600;
      font-size: 13px;
    }

    /* Page Container */
    .page-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }

    /* Cards */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }

    .card-header {
      padding: 18px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-header h2 {
      font-size: 18px;
      font-weight: 600;
    }

    .card-body {
      padding: 24px;
    }

    /* Dashboard Stats */
    .dashboard-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 28px;
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 20px;
    }

    .stat-card-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--primary);
    }

    .stat-card-label {
      font-size: 14px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    /* Centers Grid */
    .centers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 18px;
      margin-top: 18px;
    }

    .center-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 20px;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .center-card:hover {
      box-shadow: var(--shadow-md);
      border-color: var(--accent);
    }

    .center-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--primary);
    }

    .center-location {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 3px;
    }

    .center-score-badge {
      padding: 6px 14px;
      border-radius: var(--radius-md);
      font-weight: 700;
      font-size: 16px;
    }

    .center-score-badge.excellent { background: var(--success-light); color: var(--success); }
    .center-score-badge.good { background: #fef3c7; color: #d97706; }
    .center-score-badge.needs-improvement { background: var(--warning-light); color: #b45309; }
    .center-score-badge.critical { background: var(--danger-light); color: var(--danger); }
    .center-score-badge.not-started { background: var(--bg-hover); color: var(--text-muted); }

    /* Form Styles */
    .form-group {
      margin-bottom: 18px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 6px;
      color: var(--text-primary);
    }

    .form-input, .form-select {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 14px;
      font-family: inherit;
      transition: all 0.2s ease;
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--border-focus);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 18px;
    }

    .modal-footer {
      padding: 14px 24px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    /* History Table */
    .history-table {
      width: 100%;
      border-collapse: collapse;
    }

    .history-table th, .history-table td {
      padding: 12px 14px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    .history-table th {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-muted);
      background: var(--bg-hover);
    }

    .history-table tr:hover td {
      background: var(--bg-hover);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 50px 24px;
      color: var(--text-secondary);
    }

    .empty-state-icon {
      font-size: 56px;
      margin-bottom: 14px;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 18px;
      margin-bottom: 6px;
      color: var(--text-primary);
    }

    /* Score Interpretation */
    .interpretation-card {
      padding: 18px;
      border-radius: var(--radius-md);
      margin-top: 18px;
    }

    .interpretation-card.excellent {
      background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
      border: 1px solid var(--success);
    }

    .interpretation-card.good {
      background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%);
      border: 1px solid #ffc107;
    }

    .interpretation-card.needs-improvement {
      background: linear-gradient(135deg, #ffe5d0 0%, #ffd8b8 100%);
      border: 1px solid var(--warning);
    }

    .interpretation-card.critical {
      background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
      border: 1px solid var(--danger);
    }

    .interpretation-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .interpretation-text {
      font-size: 13px;
      line-height: 1.5;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .sidebar { display: none; }
      .sidebar-toggle { display: none; }
      .dashboard-stats { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 768px) {
      .header-top { flex-direction: column; gap: 10px; }
      .nav-tabs { overflow-x: auto; }
      .controls-bar { flex-direction: column; align-items: stretch; }
      .control-group { width: 100%; }
      select, .search-input { width: 100%; min-width: auto; }
      .score-summary-panel { flex-direction: column; gap: 14px; padding: 12px; }
      .score-breakdown { flex-wrap: wrap; justify-content: center; }
      .scoring-section { flex-direction: column; }
      .dashboard-stats { grid-template-columns: 1fr; }
      .form-row { grid-template-columns: 1fr; }
      .centers-grid { grid-template-columns: 1fr; }
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-hover); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useCallback, useRef } = React;

    // ============================================
    // LOCAL STORAGE HELPERS (Auto-save)
    // ============================================
    const STORAGE_KEYS = {
      CENTERS: 'cbahi_centers',
      SURVEYS: 'cbahi_surveys',
      CURRENT_SCORES: 'cbahi_current_scores'
    };

    const storage = {
      get: (key) => {
        try {
          const data = localStorage.getItem(key);
          return data ? JSON.parse(data) : null;
        } catch (e) {
          console.error('Storage get error:', e);
          return null;
        }
      },
      set: (key, value) => {
        try {
          localStorage.setItem(key, JSON.stringify(value));
          return true;
        } catch (e) {
          console.error('Storage set error:', e);
          return false;
        }
      },
      remove: (key) => {
        try {
          localStorage.removeItem(key);
          return true;
        } catch (e) {
          console.error('Storage remove error:', e);
          return false;
        }
      }
    };

    // ============================================
    // SVG ICONS - Professional UI Icons
    // ============================================
    const Icons = {
      building: (props = {}) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke={props.color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect>
          <path d="M9 22v-4h6v4"></path>
          <path d="M8 6h.01"></path><path d="M16 6h.01"></path><path d="M12 6h.01"></path>
          <path d="M12 10h.01"></path><path d="M12 14h.01"></path>
          <path d="M16 10h.01"></path><path d="M16 14h.01"></path>
          <path d="M8 10h.01"></path><path d="M8 14h.01"></path>
        </svg>
      ),
      edit: (props = {}) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 16} height={props.size || 16} viewBox="0 0 24 24" fill="none" stroke={props.color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
        </svg>
      ),
      clipboard: (props = {}) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke={props.color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
          <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
        </svg>
      ),
      checkCircle: (props = {}) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 16} height={props.size || 16} viewBox="0 0 24 24" fill="none" stroke={props.color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
          <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
      ),
      barChart: (props = {}) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke={props.color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <line x1="12" y1="20" x2="12" y2="10"></line>
          <line x1="18" y1="20" x2="18" y2="4"></line>
          <line x1="6" y1="20" x2="6" y2="16"></line>
        </svg>
      ),
      award: (props = {}) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 20} height={props.size || 20} viewBox="0 0 24 24" fill="none" stroke={props.color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <circle cx="12" cy="8" r="7"></circle>
          <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline>
        </svg>
      ),
      user: (props = {}) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 16} height={props.size || 16} viewBox="0 0 24 24" fill="none" stroke={props.color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
      ),
      phone: (props = {}) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 16} height={props.size || 16} viewBox="0 0 24 24" fill="none" stroke={props.color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
        </svg>
      ),
      mail: (props = {}) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 16} height={props.size || 16} viewBox="0 0 24 24" fill="none" stroke={props.color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
          <polyline points="22,6 12,13 2,6"></polyline>
        </svg>
      ),
      calendar: (props = {}) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 16} height={props.size || 16} viewBox="0 0 24 24" fill="none" stroke={props.color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
      ),
      x: (props = {}) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 16} height={props.size || 16} viewBox="0 0 24 24" fill="none" stroke={props.color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      ),
      plus: (props = {}) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 16} height={props.size || 16} viewBox="0 0 24 24" fill="none" stroke={props.color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
      ),
      whatsapp: (props = {}) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 16} height={props.size || 16} viewBox="0 0 24 24" fill={props.color || "#25D366"}>
          <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
        </svg>
      ),
      trash: (props = {}) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 16} height={props.size || 16} viewBox="0 0 24 24" fill="none" stroke={props.color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
          <polyline points="3 6 5 6 21 6"></polyline>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          <line x1="10" y1="11" x2="10" y2="17"></line>
          <line x1="14" y1="11" x2="14" y2="17"></line>
        </svg>
      )
    };

    // ============================================
    // FIREBASE CONFIGURATION
    // ============================================
    // TODO: Replace with your Firebase project config
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // Initialize Firebase (only if config is set)
    let db = null;
    let firebaseInitialized = false;
    try {
      if (firebaseConfig.apiKey !== "YOUR_API_KEY" && typeof firebase !== 'undefined') {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        firebaseInitialized = true;
        console.log('Firebase initialized successfully');
      }
    } catch (e) {
      console.warn('Firebase initialization skipped:', e.message);
    }

    // Firebase helpers
    const firebaseHelpers = {
      // Submit finalized assessment to Firebase
      submitAssessment: async (assessmentData) => {
        if (!firebaseInitialized || !db) {
          // Fallback to localStorage if Firebase is not configured
          const submissions = storage.get('cbahi_submissions') || [];
          const submission = {
            ...assessmentData,
            id: 'LOCAL_' + Date.now(),
            submittedAt: new Date().toISOString(),
            storageType: 'local'
          };
          submissions.push(submission);
          storage.set('cbahi_submissions', submissions);
          return { success: true, id: submission.id, local: true };
        }

        try {
          const docRef = await db.collection('assessments').add({
            ...assessmentData,
            submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
            storageType: 'firebase'
          });
          return { success: true, id: docRef.id, local: false };
        } catch (e) {
          console.error('Firebase submit error:', e);
          throw e;
        }
      },

      // Get all submissions
      getSubmissions: async () => {
        const localSubmissions = storage.get('cbahi_submissions') || [];

        if (!firebaseInitialized || !db) {
          return localSubmissions;
        }

        try {
          const snapshot = await db.collection('assessments')
            .orderBy('submittedAt', 'desc')
            .get();
          const firebaseSubmissions = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data(),
            submittedAt: doc.data().submittedAt?.toDate?.()?.toISOString() || doc.data().submittedAt
          }));
          return [...firebaseSubmissions, ...localSubmissions];
        } catch (e) {
          console.error('Firebase get error:', e);
          return localSubmissions;
        }
      }
    };

    // ============================================
    // DATA: Leadership Domain - Surveyor 1
    // ============================================
    const leadershipStandards = [
      {
        id: 'LD.1', code: 'LD.1',
        title: 'The governing body defines its structure and operational responsibilities in a written document.',
        intent: 'The governing body highlights its structure, roles, and responsibilities including approval of strategic plan, budget, mission, vision, scope of services, and appointing the center\'s director.',
        substandards: [
          { id: 'LD.1.1', code: 'LD.1.1', text: "The governing body approves and periodically reviews the center's mission, vision, and values and makes it public.", activityType: 'DOC' },
          { id: 'LD.1.2', code: 'LD.1.2', text: "The governing body approves the center's strategic plan, the scope of services, and key policies and procedures.", activityType: 'DOC' },
          { id: 'LD.1.3', code: 'LD.1.3', text: "The governing body approves the center's operating and capital budgets, as well as other resources required to manage the center efficiently.", activityType: 'DOC' },
          { id: 'LD.1.4', code: 'LD.1.4', text: "The governing body defines and approves the process of authority delegation.", activityType: 'DOC' },
          { id: 'LD.1.5', code: 'LD.1.5', text: "The governing body appoints a qualified director responsible for managing the dental center.", activityType: 'PER' }
        ]
      },
      {
        id: 'LD.2', code: 'LD.2',
        title: "The governing body approves and evaluates the center's quality and patient safety program, and risk management initiatives.",
        intent: 'The governing body ensures patient and staff safety by approving quality and patient safety programs, receiving quarterly reports, and recommending documented corrective actions.',
        substandards: [
          { id: 'LD.2.1', code: 'LD.2.1', text: "The governing body annually approves the quality and patient safety program, including the risk management initiatives.", activityType: 'DOC' },
          { id: 'LD.2.2', code: 'LD.2.2', text: "The governing body receives and evaluates the quality and patient safety reports, including the risk management, corrective actions, and outcomes from the center, at least quarterly.", activityType: 'DOC' },
          { id: 'LD.2.3', code: 'LD.2.3', text: "Recommended corrective actions by the governance are documented and received by the center director for implementation.", activityType: 'DOC' }
        ]
      },
      {
        id: 'LD.3', code: 'LD.3',
        title: 'The center has a defined, current, and clear organizational chart.',
        intent: 'Effective management requires clear reporting lines. The organizational chart shows relationships between governance and staff, updated regularly and communicated to all.',
        substandards: [
          { id: 'LD.3.1', code: 'LD.3.1', text: "An approved and updated organizational chart identifies the relationships between the center's governance, leadership, and other directors with titles.", activityType: 'DOC' },
          { id: 'LD.3.2', code: 'LD.3.2', text: "The staff are aware of the organizational chart and its intent, and can demonstrate their relationship to it.", activityType: 'INT' }
        ]
      },
      {
        id: 'LD.4', code: 'LD.4',
        title: 'The dental center is effectively managed by a qualified director.',
        intent: 'The center is managed by a qualified director responsible for mission/vision, compliance with laws, adequate resources, and a safe facility environment.',
        substandards: [
          { id: 'LD.4.1', code: 'LD.4.1', text: "The center director, with other leaders, develops the mission, vision, and values statements, and communicates them to all staff.", activityType: 'INT' },
          { id: 'LD.4.2', code: 'LD.4.2', text: "The center director ensures the center's compliance with all relevant laws, regulations, and policies.", activityType: 'INT' },
          { id: 'LD.4.3', code: 'LD.4.3', text: "The center's director ensures the availability of adequate and proper resources for the planned services in accordance with the approved operating budget.", activityType: 'INT' },
          { id: 'LD.4.4', code: 'LD.4.4', text: "The center's director ensures a safe and functional facility environment for patients, families, and staff.", activityType: 'OBS' }
        ]
      },
      {
        id: 'LD.5', code: 'LD.5',
        title: "The dental center has a clear scope of services based on community needs.",
        intent: 'The center functions according to a predefined scope of services including clinical services, professional coverage levels, clinic numbers, age groups, and working hours.',
        substandards: [
          { id: 'LD.5.1', code: 'LD.5.1', text: "The scope of services includes the specialty services available, the number of clinics for each specialty, the level of professional coverage for the age group served, and working hours.", activityType: 'DOC' },
          { id: 'LD.5.2', code: 'LD.5.2', text: "The scope of service is available to the public.", activityType: 'OBS' }
        ]
      },
      {
        id: 'LD.6', code: 'LD.6',
        title: "The leaders work collaboratively to develop the center's strategic plan.",
        intent: 'Strategic planning (3-5 years) addresses clinical and non-clinical services based on SWOT/PEST analysis with clear goals and objectives to achieve the mission.',
        substandards: [
          { id: 'LD.6.1', code: 'LD.6.1', text: "The strategic plan is guided by the mission, vision, and inputs from patients/service users, their families, staff, and where possible the wider community.", activityType: 'DOC' },
          { id: 'LD.6.2', code: 'LD.6.2', text: "The strategic plan is based on a comprehensive evaluation of both internal and external environmental factors.", activityType: 'DOC' },
          { id: 'LD.6.3', code: 'LD.6.3', text: "The strategic plan addresses all clinical and non-clinical services and programs.", activityType: 'DOC' },
          { id: 'LD.6.4', code: 'LD.6.4', text: "The strategic plan spans a period of three to five years and is reviewed regularly.", activityType: 'DOC' },
          { id: 'LD.6.5', code: 'LD.6.5', text: "The strategic plan includes the goals and objectives required to fulfill the center's mission.", activityType: 'DOC' }
        ]
      },
      {
        id: 'LD.7', code: 'LD.7',
        title: 'The leaders transform the approved strategic plan into an operational plan.',
        intent: 'The strategic plan converts to operational plans with assigned staff, evidence-based services, regular leadership meetings, and annual budgets for upgrades and maintenance.',
        substandards: [
          { id: 'LD.7.1', code: 'LD.7.1', text: "Leaders translate the center's goals and objectives into operational plans with defined projects, clearly delineated responsibilities, required resources, and time frames.", activityType: 'DOC' },
          { id: 'LD.7.2', code: 'LD.7.2', text: "Leaders communicate the plans to all staff.", activityType: 'INT' },
          { id: 'LD.7.3', code: 'LD.7.3', text: "Departmental directors develop annual departmental plans in alignment with the center's strategic plan.", activityType: 'DOC' },
          { id: 'LD.7.4', code: 'LD.7.4', text: "The leaders ensure the use of evidence-based and best practice information to develop and improve the center's services.", activityType: 'INT' },
          { id: 'LD.7.5', code: 'LD.7.5', text: "The leaders plan and budget for the upgrade or maintenance of buildings, equipment, and other resources.", activityType: 'DOC' },
          { id: 'LD.7.6', code: 'LD.7.6', text: "The leaders meet regularly to review the key performance indicators of services, surveys, audits, and feedback, and use the collected data to improve the center's operations.", activityType: 'DOC' }
        ]
      },
      {
        id: 'LD.8', code: 'LD.8',
        title: "The center's leaders work collaboratively to develop and maintain a center-wide staffing plan.",
        intent: 'Leaders formulate a staffing plan based on scope of services, capacity, and working hours including number, type, qualifications, and roles of required staff.',
        substandards: [
          { id: 'LD.8.1', code: 'LD.8.1', text: "The staffing plan ensures that services meet the needs for safe patient care.", activityType: 'DOC' },
          { id: 'LD.8.2', code: 'LD.8.2', text: "The staffing plan defines the number, type, and credentials of required staff, and their roles.", activityType: 'DOC' },
          { id: 'LD.8.3', code: 'LD.8.3', text: "The center recruits and assigns appropriately qualified staff in accordance with the staffing plan and recruitment policy.", activityType: 'PER' },
          { id: 'LD.8.4', code: 'LD.8.4', text: "The staffing plan is updated annually, monitored to identify deficiencies, and actions for improvement implemented as required.", activityType: 'DOC' }
        ]
      },
      {
        id: 'LD.9', code: 'LD.9',
        title: 'All categories of staff have clearly written job descriptions.',
        intent: 'Each staff member has a job description outlining responsibilities, qualifications, skills, and experience; discussed, signed at hiring, and kept in personnel file.',
        substandards: [
          { id: 'LD.9.1', code: 'LD.9.1', text: "The job description outlines the knowledge, skills, and attitude necessary to perform the job responsibilities for the specified position.", activityType: 'PER' },
          { id: 'LD.9.2', code: 'LD.9.2', text: "The job description clearly defines the roles and responsibilities for the position.", activityType: 'PER' },
          { id: 'LD.9.3', code: 'LD.9.3', text: "Job responsibilities and clinical work assignments are based on the evaluation of staff credentials.", activityType: 'PER' },
          { id: 'LD.9.4', code: 'LD.9.4', text: "The job description is discussed with and signed by the employee upon hiring and is located in his/her personnel file.", activityType: 'PER' }
        ]
      },
      {
        id: 'LD.10', code: 'LD.10',
        title: 'There is a process in place for credentialing and re-credentialing all healthcare providers.',
        intent: 'Credentialing applies to all clinical staff; involves collecting, verifying, and evaluating credentials upon employment and every two years thereafter.',
        substandards: [
          { id: 'LD.10.1', code: 'LD.10.1', text: "The credentialing process applies to all dental staff, dental assistants, and other clinical staff licensed to provide patient care on a full-time, part-time, or visiting basis.", activityType: 'PER' },
          { id: 'LD.10.2', code: 'LD.10.2', text: "The credentialing process includes gathering, verifying, and evaluating staff credentials including licenses, educational certificates, training certification, and evidence of experience.", activityType: 'PER' },
          { id: 'LD.10.3', code: 'LD.10.3', text: "Credentials are verified from the original source directly or through a third party with documented evidence.", activityType: 'PER' },
          { id: 'LD.10.4', code: 'LD.10.4', text: "The center ensures the registration of healthcare professionals with the Saudi Commission for Health Specialties and licensing by the Ministry of Health (MOH) in accordance with the national laws and regulations.", activityType: 'PER' }
        ]
      },
      {
        id: 'LD.11', code: 'LD.11',
        title: 'All dentists have current delineated clinical privileges.',
        intent: 'Privileging allows dentists to perform procedures for which they are qualified. Privileges are reviewed every two years based on competence and available services.',
        substandards: [
          { id: 'LD.11.1', code: 'LD.11.1', text: "The center has a policy and procedure for granting privileges to its dental staff.", activityType: 'DOC' },
          { id: 'LD.11.2', code: 'LD.11.2', text: "Clinical privileges are determined based on the dentist's current competence, the center's privileging policy, and the available services.", activityType: 'DOC' },
          { id: 'LD.11.3', code: 'LD.11.3', text: "The dental staff's clinical privileges are recommended by the dental center director and approved by the governing body, either directly or by appropriate delegation.", activityType: 'PER' },
          { id: 'LD.11.4', code: 'LD.11.4', text: "The clinical privileges are reviewed and updated every two years or earlier if needed.", activityType: 'PER' }
        ]
      },
      {
        id: 'LD.12', code: 'LD.12',
        title: 'All new employees attend a mandatory orientation program.',
        intent: 'All new employees are oriented to the center\'s mission, vision, values, structure, rights, safety, infection control, and quality programs, plus departmental orientation.',
        substandards: [
          { id: 'LD.12.1', code: 'LD.12.1', text: "The general orientation program for newly hired staff includes information about the center's mission, vision, values, organizational structure, patient and family rights, safety and security, infection control, and quality, patient safety, and risk management programs.", activityType: 'PER' },
          { id: 'LD.12.2', code: 'LD.12.2', text: "Each new employee attends a departmental-specific orientation program that assists him/her in properly executing the specific job responsibilities as outlined in the job description.", activityType: 'PER' }
        ]
      },
      {
        id: 'LD.15', code: 'LD.15',
        title: 'The leaders develop an effective process to evaluate staff performance at least annually.',
        substandards: [
          { id: 'LD.15.1', code: 'LD.15.1', text: "The performance evaluation is based on objective criteria targeting staff knowledge, skills, and attitude.", activityType: 'PER' },
          { id: 'LD.15.2', code: 'LD.15.2', text: "The evaluation is conducted at the end of the initial probationary period and at least annually thereafter.", activityType: 'PER' },
          { id: 'LD.15.3', code: 'LD.15.3', text: "Evaluations include personal goals that the staff will aim to achieve over the next year.", activityType: 'PER' },
          { id: 'LD.15.4', code: 'LD.15.4', text: "Staff are involved in the evaluation of their performance by signing the evaluation and commenting on the required corrective actions.", activityType: 'PER' },
          { id: 'LD.15.5', code: 'LD.15.5', text: "Information about staff credentials, privileges, competencies, orientation, training, education, and evaluation are securely kept in an updated personnel file.", activityType: 'PER' }
        ]
      },
      {
        id: 'LD.16', code: 'LD.16',
        title: 'The center implements a comprehensive program to protect the health and safety of staff.',
        substandards: [
          { id: 'LD.16.1', code: 'LD.16.1', text: "The staff health and safety program covers all employees and is consistent with relevant laws and regulations.", activityType: 'DOC' },
          { id: 'LD.16.2', code: 'LD.16.2', text: "The staff health and safety program is based on the protection of staff from occupational health and safety hazards, and workplace violence.", activityType: 'DOC' },
          { id: 'LD.16.3', code: 'LD.16.3', text: "The patient health and safety program is coordinated with the center's quality, safety, risk management, and infection control programs, including health screening, immunizations, and post-exposure management.", activityType: 'INT' },
          { id: 'LD.16.4', code: 'LD.16.4', text: "Staff have confidential and secured medical records that reflect their health status.", activityType: 'PER' }
        ]
      },
      {
        id: 'LD.17', code: 'LD.17',
        title: "The leaders develop ethical standards to guide patients' care and employees' code of conduct.",
        substandards: [
          { id: 'LD.17.1', code: 'LD.17.1', text: "Marketing for staff and services, if performed, is carried out ethically as per the laws and regulations.", activityType: 'OBS' },
          { id: 'LD.17.2', code: 'LD.17.2', text: "The leaders develop a set of values and a professional code of conduct for all employees.", activityType: 'DOC' },
          { id: 'LD.17.3', code: 'LD.17.3', text: "The leaders ensure that patients and their families are fully informed and protected when they are involved in clinical research projects.", activityType: 'DEN' },
          { id: 'LD.17.4', code: 'LD.17.4', text: "The leaders develop a process to monitor and resolve critical shortages, patient and non-patient related, in a reasonable timeframe as determined by the center.", activityType: 'DOC' }
        ]
      }
    ];

    // ============================================
    // DATA: Leadership Domain - Surveyor 2 (LD.13, LD.14, LD.18-LD.29)
    // ============================================
    const leadershipStandards_A2 = [
      {
        id: 'LD.13', code: 'LD.13',
        title: 'There is a policy that ensures dental assistants and other healthcare staff are competent in specific procedures and operating equipment.',
        intent: 'To ensure patient safety, staff must be tested when initially hired and annually on their competency in certain procedures according to their scope of work.',
        substandards: [
          { id: 'LD.13.1', code: 'LD.13.1', text: "The policy contains a list of all procedures requiring competency assessment.", activityType: 'DOC' },
          { id: 'LD.13.2', code: 'LD.13.2', text: "All staff are tested upon hiring and annually for the required competencies.", activityType: 'PER' },
          { id: 'LD.13.3', code: 'LD.13.3', text: "The policy is in place to ensure staff are trained on the safe operation of current and newly introduced equipment and devices.", activityType: 'DOC' },
          { id: 'LD.13.4', code: 'LD.13.4', text: "Only properly trained and competent staff are allowed to use specialized equipment and medical devices.", activityType: 'INT' }
        ]
      },
      {
        id: 'LD.14', code: 'LD.14',
        title: 'There is a program for continuing education and training of all categories of staff.',
        intent: 'Staff professional development is crucial to improving services. The center should provide regularly scheduled educational programs addressing quality, patient safety, risk management, and infection control.',
        substandards: [
          { id: 'LD.14.1', code: 'LD.14.1', text: "The center has a regularly scheduled educational and training program based on the center and staff needs including quality, patient safety, risk management, and infection control practices.", activityType: 'DOC' },
          { id: 'LD.14.2', code: 'LD.14.2', text: "The leaders encourage and compensate staff to attend educational and training activities relevant to the center's scope of services and in line with the national labor law.", activityType: 'INT' },
          { id: 'LD.14.3', code: 'LD.14.3', text: "All staff members who provide direct patient care maintain a valid certificate on basic life support (BLS).", activityType: 'PER' },
          { id: 'LD.14.4', code: 'LD.14.4', text: "Information about staff credentials, privileges, competencies, orientation, training, education, and evaluation are securely kept in an updated personnel file.", activityType: 'PER' }
        ]
      },
      {
        id: 'LD.18', code: 'LD.18',
        title: "The leaders support and protect the patient and family's rights.",
        intent: 'Patient and family rights are paramount for ethical and safe care. Leaders should develop policies for patient rights, ensure staff are trained, and patients are treated with dignity.',
        substandards: [
          { id: 'LD.18.1', code: 'LD.18.1', text: "The leaders develop and maintain a patient rights and responsibilities statement and develop processes that support their implementation.", activityType: 'INT' },
          { id: 'LD.18.2', code: 'LD.18.2', text: "The leaders ensure that written documentation of patient rights and responsibilities is available to patients and families and ensure patients are informed about their rights and responsibilities in a manner they can understand.", activityType: 'OBS' },
          { id: 'LD.18.3', code: 'LD.18.3', text: "The leaders ensure that patients' dignity, privacy, and confidentiality are respected.", activityType: 'OBS' },
          { id: 'LD.18.4', code: 'LD.18.4', text: "The health team provides care and services that are respectful of the patient's values and beliefs.", activityType: 'DOC' },
          { id: 'LD.18.5', code: 'LD.18.5', text: "Vulnerable patients are identified and protected from additional risks.", activityType: 'INT' },
          { id: 'LD.18.6', code: 'LD.18.6', text: "The leaders ensure that staff are provided with training and education on patient and family rights and responsibilities.", activityType: 'INT' },
          { id: 'LD.18.7', code: 'LD.18.7', text: "The leaders ensure that patients and their families have the right to be involved in their own care and treatment, including the right to refuse treatment or request a second opinion.", activityType: 'INT' }
        ]
      },
      {
        id: 'LD.19', code: 'LD.19',
        title: "The leaders develop and implement a policy and procedure to describe the patients' right to voice their complaints, concerns, and suggestions.",
        intent: 'The center should have well-defined policy for collecting patient feedback and resolving complaints within specified timeframes, with findings incorporated into quality and safety programs.',
        substandards: [
          { id: 'LD.19.1', code: 'LD.19.1', text: "Patients' complaints are resolved within the time frame described in the policy.", activityType: 'DOC' },
          { id: 'LD.19.2', code: 'LD.19.2', text: "The center assigns a staff member to be responsible for managing complaints.", activityType: 'PER' },
          { id: 'LD.19.3', code: 'LD.19.3', text: "Patient satisfaction surveys are conducted regularly.", activityType: 'DOC' },
          { id: 'LD.19.4', code: 'LD.19.4', text: "Data collected from surveys, complaints, and suggestions are analyzed and trended, with the information collected used for improvement and integrated into the quality and safety program.", activityType: 'DOC' }
        ]
      },
      {
        id: 'LD.20', code: 'LD.20',
        title: "Patients and their families have the right to accurate billing for provided services.",
        intent: 'The center ensures dental treatments adhere to a displayed pricing list and that receipts are issued, including for insured patients.',
        substandards: [
          { id: 'LD.20.1', code: 'LD.20.1', text: "The leaders ensure the availability of a price list for services provided to patients and their sponsors.", activityType: 'OBS' },
          { id: 'LD.20.2', code: 'LD.20.2', text: "The patients and their families have the right to receive an initial estimated cost of required services.", activityType: 'INT' },
          { id: 'LD.20.3', code: 'LD.20.3', text: "The patients and their families have the right to obtain an invoice for services rendered.", activityType: 'INT' }
        ]
      },
      {
        id: 'LD.21', code: 'LD.21',
        title: "The center provides assistance to patients with special needs.",
        intent: 'The center should take into account requirements for enabling access for patients with special needs including designated parking, accessible entrances, elevators, ramps, and restrooms.',
        substandards: [
          { id: 'LD.21.1', code: 'LD.21.1', text: "Street parking and drop-off points dedicated to patients with special needs are available near the center's entrance.", activityType: 'OBS' },
          { id: 'LD.21.2', code: 'LD.21.2', text: "The center's entrance, elevators, and toilets allow wheelchair access.", activityType: 'OBS' },
          { id: 'LD.21.3', code: 'LD.21.3', text: "Staircases have handrails.", activityType: 'OBS' },
          { id: 'LD.21.4', code: 'LD.21.4', text: "Elevated areas have ramps.", activityType: 'OBS' }
        ]
      },
      {
        id: 'LD.22', code: 'LD.22',
        title: "The center has a policy and procedure for controlling the development and maintenance of key documents.",
        intent: 'Key documents should have standardized structure with unique identifiers, dates, and be reviewed and approved by authorized individuals with a system ensuring only current versions circulate.',
        substandards: [
          { id: 'LD.22.1', code: 'LD.22.1', text: "The center maintains a unique identifier for each key document, with title, number, date of issue, and date of revision.", activityType: 'DOC' },
          { id: 'LD.22.2', code: 'LD.22.2', text: "Key documents are developed, approved, revised, and terminated by authorized individuals.", activityType: 'DOC' },
          { id: 'LD.22.3', code: 'LD.22.3', text: "Key documents are communicated to relevant staff and are always accessible.", activityType: 'INT' },
          { id: 'LD.22.4', code: 'LD.22.4', text: "A process is in place to ensure that key documents are always implemented.", activityType: 'INT' }
        ]
      },
      {
        id: 'LD.23', code: 'LD.23',
        title: "The center collaboratively develops a comprehensive quality improvement and patient safety program.",
        intent: 'The center should ensure quality of services through a quality management and patient safety program utilizing key performance indicators and evidence-based improvement approaches.',
        substandards: [
          { id: 'LD.23.1', code: 'LD.23.1', text: "The quality improvement and safety program utilize key performance indicators, and patient and staff surveys to measure performance and improve clinical and managerial areas.", activityType: 'DOC' },
          { id: 'LD.23.2', code: 'LD.23.2', text: "The information generated from key performance indicators is readily accessible on a timely basis to those responsible for and/or involved in the delivery of the center's services, and is utilized for making improvements and supporting the leaders' decision-making.", activityType: 'INT' },
          { id: 'LD.23.3', code: 'LD.23.3', text: "The center implements at least one improvement project per year utilizing an evidence-based quality improvement method such as 'FOCUS PDCA'.", activityType: 'DOC' },
          { id: 'LD.23.4', code: 'LD.23.4', text: "The center leaders assess and support the patient safety culture in the center.", activityType: 'INT' }
        ]
      },
      {
        id: 'LD.24', code: 'LD.24',
        title: "The center prioritizes and selects a set of relevant indicators that focus on the structure, process, and outcome of the dental and non-dental services provided.",
        intent: 'Key performance indicators should follow an evidence-based approach covering structure, process, and outcome. Information should be presented to staff and used for benchmarking.',
        substandards: [
          { id: 'LD.24.1', code: 'LD.24.1', text: "The selection process of performance indicators is based on the center's most important processes and priorities.", activityType: 'INT' },
          { id: 'LD.24.2', code: 'LD.24.2', text: "Each indicator has an operational definition, defined numerator and denominator, data collection method and frequency, a mathematical expression such as ratio or percentage, and a desirable target.", activityType: 'DOC' },
          { id: 'LD.24.3', code: 'LD.24.3', text: "The indicators are collected, validated, and analyzed by staff with appropriate knowledge and skills.", activityType: 'PER' },
          { id: 'LD.24.4', code: 'LD.24.4', text: "The performance monitoring results are discussed with staff, utilized in their evaluation, and reported regularly to the governance together with the action plans taken for improvement.", activityType: 'DOC' },
          { id: 'LD.24.5', code: 'LD.24.5', text: "The indicators are compared internally by historical trends and externally by benchmarking to other similar centers when available.", activityType: 'DOC' }
        ]
      },
      {
        id: 'LD.25', code: 'LD.25',
        title: "The center develops and implements a comprehensive risk management program.",
        intent: 'The risk management program should cover clinical, managerial, and financial aspects with both reactive incident reporting and proactive approaches like FMEA.',
        substandards: [
          { id: 'LD.25.1', code: 'LD.25.1', text: "The risk management program addresses clinical, managerial, and financial risks.", activityType: 'DOC' },
          { id: 'LD.25.2', code: 'LD.25.2', text: "The reporting of incidents, variances, and claims constitutes the program's essential reactive arm.", activityType: 'INT' },
          { id: 'LD.25.3', code: 'LD.25.3', text: "The center develops and implements at least one proactive risk reduction approach per year.", activityType: 'DOC' },
          { id: 'LD.25.4', code: 'LD.25.4', text: "The center develops and periodically updates a risk register for all potential clinical, managerial, and financial processes in the center.", activityType: 'DOC' },
          { id: 'LD.25.5', code: 'LD.25.5', text: "The center utilizes an evidence-based process for grading risks based on severity, frequency, and likelihood of occurrence.", activityType: 'DOC' },
          { id: 'LD.25.6', code: 'LD.25.6', text: "Information from the risk management program, including incidents, analysis, and improvement projects, is communicated to staff and the governing body at least quarterly.", activityType: 'INT' }
        ]
      },
      {
        id: 'LD.26', code: 'LD.26',
        title: "The center implements an incident reporting policy.",
        intent: 'The center should develop an incident reporting policy with unified reporting mechanism for all occurrences, variances, accidents, and near misses.',
        substandards: [
          { id: 'LD.26.1', code: 'LD.26.1', text: "The incident report policy outlines the types of incidents to be reported internally and to relevant regulatory authorities, the time frame, and the mechanism for reporting.", activityType: 'DOC' },
          { id: 'LD.26.2', code: 'LD.26.2', text: "Sentinel events and major incidents are reported, investigated, and the findings are utilized to prevent their recurrence.", activityType: 'INT' },
          { id: 'LD.26.3', code: 'LD.26.3', text: "Incidences involving patients are documented in the dental record, and patients and families are informed by the physician/dentist of any investigation results.", activityType: 'DEN' },
          { id: 'LD.26.4', code: 'LD.26.4', text: "The center compiles a report on incidences according to type and severity, and an action plan to prevent its recurrence is distributed to staff and governance on a regular basis.", activityType: 'DOC' }
        ]
      },
      {
        id: 'LD.27', code: 'LD.27',
        title: "The center has a program to select and monitor clinical and operational contracts.",
        intent: 'Process owners should closely monitor contracted services implementation with agreed-upon indicators. Contract renewal should be based on monitoring findings.',
        substandards: [
          { id: 'LD.27.1', code: 'LD.27.1', text: "Contracted entities are selected based on evidence-based criteria that the relevant department develops.", activityType: 'DOC' },
          { id: 'LD.27.2', code: 'LD.27.2', text: "The center director ensures relevant leaders' recommendations and approval on contracts.", activityType: 'DOC' },
          { id: 'LD.27.3', code: 'LD.27.3', text: "The leaders ensure that the contracting entity and services provided meet applicable laws and regulations.", activityType: 'INT' },
          { id: 'LD.27.4', code: 'LD.27.4', text: "When radiology services are provided through a contract; the center is responsible to provide oversight of the contract.", activityType: 'DOC' },
          { id: 'LD.27.5', code: 'LD.27.5', text: "The leaders ensure that the services provided are integrated into the overall quality and patient safety program.", activityType: 'INT' },
          { id: 'LD.27.6', code: 'LD.27.6', text: "The leaders regularly monitor and document the compliance of contracted services with the appropriate standards and take documented corrective actions for improvement when standards are not met.", activityType: 'INT' }
        ]
      },
      {
        id: 'LD.28', code: 'LD.28',
        title: "The leaders implement policies and procedures to guide efficient procurement of equipment, either purchased or donated, medications, and medical consumables following national laws and regulations.",
        intent: 'Leaders should develop a procurement policy to ensure purchase of nationally approved medical equipment, medications, and supplies with proper SFDA compliance.',
        substandards: [
          { id: 'LD.28.1', code: 'LD.28.1', text: "The leaders ensure that contractors and suppliers of devices and consumables have a Medical Device Establishment License (MDEL).", activityType: 'DOC' },
          { id: 'LD.28.2', code: 'LD.28.2', text: "Leaders ensure that all newly purchased devices have a Medical Device Marketing Authorization (MDMA) certificate.", activityType: 'DOC' },
          { id: 'LD.28.3', code: 'LD.28.3', text: "Leaders approve newly introduced consumables based on a formal testing and feedback process from end-users.", activityType: 'INT' }
        ]
      },
      {
        id: 'LD.29', code: 'LD.29',
        title: "The center maintains an aesthetic appeal.",
        intent: 'Patients\' confidence starts from first impression. The center should maintain cleanliness with temperatures between 20-24.4C per OSHA standards.',
        substandards: [
          { id: 'LD.29.1', code: 'LD.29.1', text: "The center is clean and tidy.", activityType: 'OBS' },
          { id: 'LD.29.2', code: 'LD.29.2', text: "The center is free of broken furniture, scratched, and damaged walls and floors.", activityType: 'OBS' },
          { id: 'LD.29.3', code: 'LD.29.3', text: "The center maintains an ambient temperature between 20 - 24.4 Celsius.", activityType: 'OBS' }
        ]
      }
    ];

    // Management of Information (MOI) Standards - Surveyor 2
    const moiStandards = [
      {
        id: 'MOI.1', code: 'MOI.1',
        title: 'The center defines, in a policy, the information that may be shared among the staff internally and with other external entities, and its format.',
        intent: 'Communication facilitates a free flow of information and mandates in healthcare, identifying and organizing this flow of information. Both inside the organization and with various customers, helps to enhance communication and eliminate communication errors. All stakeholders should clearly develop a management of information plan that outlines the process of managing the patients\' information.',
        substandards: [
          { id: 'MOI.1.1', code: 'MOI.1.1', text: 'The policy highlights how patient demographics and medical/dental information are shared among dental and administrative staff including paper format, electronic, or a combination.', activityType: 'DOC' },
          { id: 'MOI.1.2', code: 'MOI.1.2', text: 'The policy identifies how the information is disseminated from leaders to staff and vice versa.', activityType: 'INT' },
          { id: 'MOI.1.3', code: 'MOI.1.3', text: 'The policy defines what information is required by the relevant external authorities, and the frequency of reporting.', activityType: 'DOC' },
          { id: 'MOI.1.4', code: 'MOI.1.4', text: 'The policy highlights the patients\' personal and dental information required to refer a patient to a higher center.', activityType: 'DOC' },
          { id: 'MOI.1.5', code: 'MOI.1.5', text: 'The policy identifies the staff security levels required to access patient information.', activityType: 'DOC' },
          { id: 'MOI.1.6', code: 'MOI.1.6', text: 'The policy identifies how each type of information is secured and safely stored.', activityType: 'DOC' },
          { id: 'MOI.1.7', code: 'MOI.1.7', text: 'The policy highlights how long the center needs to retain the various types of information in accordance with the applicable national rules and regulations.', activityType: 'DOC' }
        ]
      },
      {
        id: 'MOI.2', code: 'MOI.2',
        title: 'All patients seen in the center have unique dental record files.',
        intent: 'To ensure continuity of care, each patient cared for at the center must have his or her own dental record that has a unique dental record number. The dental record shall contain all of the elements identified in MOI.2.2 and MOI.2.3.',
        substandards: [
          { id: 'MOI.2.1', code: 'MOI.2.1', text: 'The contents of the dental record are arranged according to a standardized process.', activityType: 'OBS' },
          { id: 'MOI.2.2', code: 'MOI.2.2', text: 'Dental record files contain the required patient demographics including national identification number, contact information, emergency contacts, and insurance history.', activityType: 'DEN' },
          { id: 'MOI.2.3', code: 'MOI.2.3', text: 'Medical/dental record files contain sufficient updated medical information to safely manage the patient and promote continuity of care including history, physical examination, plan of care, investigations, consultations, observations, consents, procedure/surgery reports, medications, allergies, and prior adverse reactions.', activityType: 'DEN' }
        ]
      },
      {
        id: 'MOI.3', code: 'MOI.3',
        title: 'The center has a policy for making entries in dental record files.',
        intent: 'Uniformity of medical/dental records enhances better documentation and results implementation of written instructions. A policy should be developed and implemented based on the elements identified in MOI.3.1 through MOI.3.6. Abbreviations and symbols used may be referenced differently by different individuals throughout the policy/survey, thus inadvertently changing the intended care plans.',
        substandards: [
          { id: 'MOI.3.1', code: 'MOI.3.1', text: 'The dental file documentation policy identifies the category of staff allowed to write in the dental record.', activityType: 'DOC' },
          { id: 'MOI.3.2', code: 'MOI.3.2', text: 'All entries in the patient file are legible, dated, timed, and signed by the author.', activityType: 'DEN' },
          { id: 'MOI.3.3', code: 'MOI.3.3', text: 'There is a uniform entry of data in dental records, whereby orders are written separately from assessments, care plans, and progress notes.', activityType: 'DEN' },
          { id: 'MOI.3.4', code: 'MOI.3.4', text: 'Entries written in error are not deleted or erased. Instead, a single line is passed through the error text and dated, timed, and signed by the author, or the system allows for electronic amendment tracing.', activityType: 'DEN' },
          { id: 'MOI.3.5', code: 'MOI.3.5', text: 'Only standardized and approved abbreviations and symbols are used in dental records.', activityType: 'DEN' },
          { id: 'MOI.3.6', code: 'MOI.3.6', text: 'The center uses diagnosis codes and procedure codes including international classification of diseases (ICD) or current procedural terminology (CPT) consistent with the requirements of relevant authorities.', activityType: 'DEN' }
        ]
      },
      {
        id: 'MOI.4', code: 'MOI.4',
        title: 'The center has a process for completing the patient dental record files.',
        intent: 'At the end of a patient\'s visit, the dental record should be returned to the dental records store. This keeps the dental records safe, secure, and in good order. Upon its receipt in the store, the dental record should be checked for completeness according to a written process that includes complete demographics, clinical information, and authentication.',
        substandards: [
          { id: 'MOI.4.1', code: 'MOI.4.1', text: 'Regular checks are made on returned files to ensure completion. The check includes but is not limited to demographics, medical information, and authentication.', activityType: 'INT' },
          { id: 'MOI.4.2', code: 'MOI.4.2', text: 'Incomplete files are separated from completed ones in the records storage area and are completed in a time frame defined by the organization.', activityType: 'OBS' },
          { id: 'MOI.4.3', code: 'MOI.4.3', text: 'The center keeps a record of the percentage of incomplete records over time and uses this information to improve staff compliance with record completion.', activityType: 'INT' }
        ]
      },
      {
        id: 'MOI.5', code: 'MOI.5',
        title: 'The center develops a policy and procedure for the use of information technology.',
        intent: 'Despite advances in information resources, many centers still face databases, networks, and software disasters, waiting short periods or shutting down work for days. To maintain the confidentiality and comprehensiveness of data, an adequate data capturing process along appropriate software is critical. A standard manual system must be available for use during the downtime period and include both managerial and clinical activities.',
        substandards: [
          { id: 'MOI.5.1', code: 'MOI.5.1', text: 'The policy and procedure for the use of information technology highlight how the generated information is stored and regularly backed up.', activityType: 'DOC' },
          { id: 'MOI.5.2', code: 'MOI.5.2', text: 'The information technology policy and procedure describe the manual procedures required to execute the various activities in the event of system failure, maintenance, or repair.', activityType: 'DOC' },
          { id: 'MOI.5.3', code: 'MOI.5.3', text: 'Staff can demonstrate the manual procedure for the downtime regulation of data generated by information technology.', activityType: 'INT' }
        ]
      },
      {
        id: 'MOI.6', code: 'MOI.6',
        title: 'The center implements an effective clinical documentation improvement (CDI) program.',
        intent: 'Clinical documentation improvement (CDI) is implemented in any healthcare organization. CDI ensures accurate reporting of diagnoses and procedures in the health authorities as per final regulations. The center has a developed policy and procedure that guides proper documentation to ensure to provide for healthcare leaders to have an holistic delivery of healthcare services.',
        substandards: [
          { id: 'MOI.6.1', code: 'MOI.6.1', text: 'The center develops a policy and procedure for the clinical documentation improvement program.', activityType: 'DOC' },
          { id: 'MOI.6.2', code: 'MOI.6.2', text: 'The center has at a minimum, a dentist and a dental assistant, who are properly trained in clinical documentation improvement.', activityType: 'PER' }
        ]
      }
    ];

    // Facility Management and Safety (FMS) Standards - Surveyor 2
    const fmsStandards = [
      {
        id: 'FMS.1', code: 'FMS.1',
        title: 'The center establishes and appoints a lead for managing environmental safety programs.',
        intent: 'Environmental safety requires leadership and coordination. The center must have designated staff responsible for managing all aspects of facility safety including emergency management, utility systems, hazardous materials, fire safety, medical equipment, building safety, security, and electrical safety.',
        substandards: [
          { id: 'FMS.1.1', code: 'FMS.1.1', text: 'The safety management program includes plans for emergency management, utility systems, hazardous materials, fire safety, medical equipment, building safety, security, and electrical safety.', activityType: 'DOC' },
          { id: 'FMS.1.2', code: 'FMS.1.2', text: 'The safety management program includes plans for orientation of new hires regarding safety, participation in training programs, and knowledge assessments.', activityType: 'PER' },
          { id: 'FMS.1.3', code: 'FMS.1.3', text: 'There are staff with dedicated roles and responsibilities set out for the safety management and safety programs.', activityType: 'PER' },
          { id: 'FMS.1.4', code: 'FMS.1.4', text: 'Staff undergo fire safety awareness and are able to understand their respective roles and obligations in prevention and response protocols.', activityType: 'PER' },
          { id: 'FMS.1.5', code: 'FMS.1.5', text: 'An SOP for alerting the center, fire services, and the relevant authorities in the event of fire that complies with any related local civil defence guidelines is developed.', activityType: 'DOC' }
        ]
      },
      {
        id: 'FMS.2', code: 'FMS.2',
        title: 'Identified safety risks are documented and used for the development and implementation of corrective actions and external audit activities to improve facility management.',
        intent: 'Risk documentation enables systematic improvement of facility safety through identification, tracking, and mitigation of hazards across all areas of the facility.',
        substandards: [
          { id: 'FMS.2.1', code: 'FMS.2.1', text: 'There is a fire risk assessment across all utility and all the other essential equipment or processes, to improve a facilities safe, clean environment.', activityType: 'DOC' },
          { id: 'FMS.2.2', code: 'FMS.2.2', text: 'Fire drills and safety assessments are carried out on an annual basis.', activityType: 'DOC' }
        ]
      },
      {
        id: 'FMS.3', code: 'FMS.3',
        title: 'The center\'s security program for protection of patients and personnel protects.',
        intent: 'A comprehensive security program ensures the safety of patients, staff, and visitors through proper equipment, monitoring, and fire prevention measures.',
        substandards: [
          { id: 'FMS.3.1', code: 'FMS.3.1', text: 'The security program is defined and has a focal point for coordination.', activityType: 'INT' },
          { id: 'FMS.3.2', code: 'FMS.3.2', text: 'Fire extinguishers are located and maintained at the site of services and support areas.', activityType: 'OBS' },
          { id: 'FMS.3.3', code: 'FMS.3.3', text: 'Fire sprinklers including fire alarms and fire prevention and smoke detectors equipment are properly functional.', activityType: 'OBS' },
          { id: 'FMS.3.4', code: 'FMS.3.4', text: 'The fire alarm system is maintained and tested, and all passive smoke containment elements are functional.', activityType: 'OBS' },
          { id: 'FMS.3.5', code: 'FMS.3.5', text: 'A "No Smoke" policy is imposed in work areas.', activityType: 'OBS' },
          { id: 'FMS.3.6', code: 'FMS.3.6', text: 'The "No Smoking" signs are posted at all entrance and waiting areas.', activityType: 'OBS' },
          { id: 'FMS.3.7', code: 'FMS.3.7', text: 'Fire equipment and related systems are tested and documented according to manufacturer specifications.', activityType: 'DOC' }
        ]
      },
      {
        id: 'FMS.4', code: 'FMS.4',
        title: 'The center is secure and designed for access.',
        intent: 'Proper access control and security measures protect patients, staff, and the facility while ensuring appropriate visitor management and flow separation.',
        substandards: [
          { id: 'FMS.4.1', code: 'FMS.4.1', text: 'Staff have an adequate security protocol defined for the safety of access to their areas, taking adequate precautions.', activityType: 'INT' },
          { id: 'FMS.4.2', code: 'FMS.4.2', text: 'Security measures for the security appropriate control and access for unauthorized buildings are seen.', activityType: 'INT' },
          { id: 'FMS.4.3', code: 'FMS.4.3', text: 'The visitor admission is tracked.', activityType: 'INT' },
          { id: 'FMS.4.4', code: 'FMS.4.4', text: 'The center is maintained and clean in a reasonable manner.', activityType: 'OBS' },
          { id: 'FMS.4.5', code: 'FMS.4.5', text: 'Patients and staff flow are separated into non-healthcare areas.', activityType: 'OBS' },
          { id: 'FMS.4.6', code: 'FMS.4.6', text: 'An exit door and its clearance-way is in place.', activityType: 'OBS' }
        ]
      },
      {
        id: 'FMS.5', code: 'FMS.5',
        title: 'The center has a written plan for the proper maintenance, inspection, testing, and safe operation of medical equipment.',
        intent: 'Medical equipment must be properly maintained, inspected, and tested to ensure patient safety and optimal performance. This includes acceptance testing, inventory management, and preventive maintenance programs.',
        substandards: [
          { id: 'FMS.5.1', code: 'FMS.5.1', text: 'Medical equipment in the center, including sterilizers, radiological equipment, or any functional equipment, is subjected to acceptance testing as per documented and established guidelines and or manufacturer specifications.', activityType: 'DOC' },
          { id: 'FMS.5.2', code: 'FMS.5.2', text: 'The list of equipment and medical equipment used in the facility is well validated, documented, and periodically revised.', activityType: 'DOC' },
          { id: 'FMS.5.3', code: 'FMS.5.3', text: 'Medical/dental equipment in an active inspection/maintenance program with test prompts and the final checklist for data documented.', activityType: 'DOC' },
          { id: 'FMS.5.4', code: 'FMS.5.4', text: 'All dental medical electrical equipment is labeled and the asset tagged via local acceptance.', activityType: 'OBS' },
          { id: 'FMS.5.5', code: 'FMS.5.5', text: 'Medical equipment needed to be installed in an area while completed, or failure events indicated is available at the facility of support element.', activityType: 'OBS' }
        ]
      },
      {
        id: 'FMS.6', code: 'FMS.6',
        title: 'The center has a program to ensure the reliability and safety of utility systems.',
        intent: 'Utility systems including electrical, water, ventilation, and medical gas systems must be reliably maintained to support patient care operations and ensure safety.',
        substandards: [
          { id: 'FMS.6.1', code: 'FMS.6.1', text: 'The center identifies and maintains an inventory of all utility systems.', activityType: 'DOC' },
          { id: 'FMS.6.2', code: 'FMS.6.2', text: 'Utility systems are inspected, tested, and maintained on a regular schedule.', activityType: 'DOC' },
          { id: 'FMS.6.3', code: 'FMS.6.3', text: 'Emergency power systems are tested regularly and maintained in operational condition.', activityType: 'OBS' },
          { id: 'FMS.6.4', code: 'FMS.6.4', text: 'Water quality is monitored and maintained according to applicable standards.', activityType: 'DOC' },
          { id: 'FMS.6.5', code: 'FMS.6.5', text: 'Ventilation systems are adequate for the facility requirements and regularly maintained.', activityType: 'OBS' },
          { id: 'FMS.6.6', code: 'FMS.6.6', text: 'Electrical systems are properly grounded and maintained for safety.', activityType: 'OBS' },
          { id: 'FMS.6.7', code: 'FMS.6.7', text: 'Staff are trained in utility system emergency procedures.', activityType: 'INT' },
          { id: 'FMS.6.8', code: 'FMS.6.8', text: 'Backup systems are in place for critical utilities.', activityType: 'OBS' },
          { id: 'FMS.6.9', code: 'FMS.6.9', text: 'Utility system failures are documented and analyzed for improvement.', activityType: 'DOC' },
          { id: 'FMS.6.10', code: 'FMS.6.10', text: 'The center has contingency plans for utility system failures.', activityType: 'DOC' }
        ]
      },
      {
        id: 'FMS.7', code: 'FMS.7',
        title: 'Fire safety and smoke monitoring plan for fire emergency.',
        intent: 'A comprehensive fire safety program ensures proper signage, evacuation routes, equipment functionality, and staff preparedness to respond to fire emergencies effectively.',
        substandards: [
          { id: 'FMS.7.1', code: 'FMS.7.1', text: 'Fire door signage and the lighting of all fire service equipment.', activityType: 'OBS' },
          { id: 'FMS.7.2', code: 'FMS.7.2', text: 'Fire emergency exits and evacuation plans and safety equipment for safety compliance.', activityType: 'DOC' },
          { id: 'FMS.7.3', code: 'FMS.7.3', text: 'The clear route plan on how to coordinate various locations where it will release to any emergency of designated evacuation.', activityType: 'OBS' },
          { id: 'FMS.7.4', code: 'FMS.7.4', text: 'Fire rescue has direct access and access to evacuation emergency areas.', activityType: 'OBS' },
          { id: 'FMS.7.5', code: 'FMS.7.5', text: 'Staff are familiar with the emergency and evacuation process.', activityType: 'INT' },
          { id: 'FMS.7.6', code: 'FMS.7.6', text: 'The fire emergency plan is reviewed annually.', activityType: 'DOC' },
          { id: 'FMS.7.7', code: 'FMS.7.7', text: 'The center has a policy to guide visitors during an emergency evacuation.', activityType: 'DOC' }
        ]
      },
      {
        id: 'FMS.8', code: 'FMS.8',
        title: 'The dental center develops a hazardous material (HAZMAT) and waste disposal plan.',
        intent: 'The center must protect its occupants from the effects of hazardous materials and waste. There should be a hazardous material plan in place that includes identifying and safely controlling hazardous materials and waste throughout the facility. A hazardous material is any solid, liquid, or gas that can harm people, other living organisms, property, or the environment.',
        substandards: [
          { id: 'FMS.8.1', code: 'FMS.8.1', text: 'The center keeps an updated register of all hazardous materials in the center, along with their "Safety Data Sheets".', activityType: 'DOC' },
          { id: 'FMS.8.2', code: 'FMS.8.2', text: 'Staff are trained in properly dealing with available hazardous materials and waste disposal.', activityType: 'INT' },
          { id: 'FMS.8.3', code: 'FMS.8.3', text: 'The center controls and reduces the risk associated with the use of hazardous materials and wastes.', activityType: 'OBS' },
          { id: 'FMS.8.4', code: 'FMS.8.4', text: 'Hazardous materials are stored, handled, transported, used, and disposed of as per the "Safety Data Sheets".', activityType: 'OBS' },
          { id: 'FMS.8.5', code: 'FMS.8.5', text: 'Waste disposal is conducted safely within the facility or through an authorized contractor.', activityType: 'OBS' },
          { id: 'FMS.8.6', code: 'FMS.8.6', text: 'Fire-rated cabinets are used for flammable hazardous materials.', activityType: 'OBS' }
        ]
      },
      {
        id: 'FMS.9', code: 'FMS.9',
        title: 'The center has a policy and procedure for the safe use of various types of compressed medical gasses.',
        intent: 'Compressed gas systems are a standard feature of most healthcare facilities, and they require special monitoring and maintenance to ensure their proper operation. The hazards associated with compressed gasses include oxygen displacement, explosion, toxicity, and the physical hazards of a ruptured cylinder. The center must develop and implement a policy for handling, storing, transporting, and disposing of various types of compressed gasses.',
        substandards: [
          { id: 'FMS.9.1', code: 'FMS.9.1', text: 'The medical gasses policy highlights the use of cylinder transporters.', activityType: 'DOC' },
          { id: 'FMS.9.2', code: 'FMS.9.2', text: 'The policy emphasizes secure storage of the cylinder(s) in well-ventilated areas.', activityType: 'OBS' },
          { id: 'FMS.9.3', code: 'FMS.9.3', text: 'The policy describes how to secure the cylinders by positioning them upright against a wall and securing it by either a chain or inside special containers.', activityType: 'DOC' },
          { id: 'FMS.9.4', code: 'FMS.9.4', text: 'The policy ensures the timely replacement of empty cylinders and the availability of a backup system.', activityType: 'DOC' },
          { id: 'FMS.9.5', code: 'FMS.9.5', text: 'Centers equipped with piped gas systems follow the regulatory body\'s testing and safety requirements.', activityType: 'OBS' }
        ]
      }
    ];

    // ============================================
    // DATA: Provision of Care (PC) - Surveyor 1
    // ============================================
    const provisionOfCareStandards = [
      {
        id: 'PC.3', code: 'PC.3',
        title: 'Patients are clinically assessed through an established assessment policy and procedure.',
        intent: 'Patient assessments ensure right diagnosis and appropriate care plans. All patients should undergo comprehensive history and physical examination with screening for nutritional needs, pain, and fall risk.',
        substandards: [
          { id: 'PC.3.1', code: 'PC.3.1', text: "The assessment policy recommends a multidisciplinary care approach, highlighting the scope and content of assessment by both general and specialty dentists, and other healthcare workers participating in the patient's care process.", activityType: 'DOC' },
          { id: 'PC.3.2', code: 'PC.3.2', text: "The assessment policy highlights the minimum assessment required by the dentist before treating the patient.", activityType: 'DOC' },
          { id: 'PC.3.3', code: 'PC.3.3', text: "The assessment policy ensures the availability of a comprehensive patient assessment including essential vital signs.", activityType: 'DEN' },
          { id: 'PC.3.4', code: 'PC.3.4', text: "The assessment policy highlights the required screening for nutritional needs.", activityType: 'DEN' },
          { id: 'PC.3.5', code: 'PC.3.5', text: "The assessment policy highlights the required sensitivity for the presence or absence of pain.", activityType: 'DEN' },
          { id: 'PC.3.6', code: 'PC.3.6', text: "The assessment policy highlights the required screening for fall risk and the measures used to reduce the risk of injury resulting from falls.", activityType: 'DEN' }
        ]
      },
      {
        id: 'PC.4', code: 'PC.4',
        title: 'The center provides the dentists with the results of investigations as per an agreed time frame.',
        intent: 'For effective treatment planning, dentists should receive investigation results in acceptable timeframes. A document specifying turnaround times for routine and urgent tests should be available.',
        substandards: [
          { id: 'PC.4.1', code: 'PC.4.1', text: "An agreement with an outsourced laboratory should include requirements for routine, non-critical, and for stat (urgent/critical) tests. Written time frame for routine and stat (urgent) investigations is developed collaboratively with the laboratory, radiology, and other services, on-site or outsourced.", activityType: 'DOC' },
          { id: 'PC.4.2', code: 'PC.4.2', text: "Personnel time is available for routine and stat (urgent) radiology and laboratory tests.", activityType: 'INT' }
        ]
      },
      {
        id: 'PC.6', code: 'PC.6',
        title: "The dentist develops a treatment plan to meet the patient's needs.",
        intent: 'A documented treatment plan is vital to managing a patient\'s condition. The plan should identify measurable goals and be reviewed during every visit based on the patient\'s response.',
        substandards: [
          { id: 'PC.6.1', code: 'PC.6.1', text: "The dentist develops treatment plans in collaboration within the assessment information and the development plan. This ensures that the plan meets the treatment goals that the patient care team has defined for the patient based on all of the assessment information and the patient's own preferences.", activityType: 'DEN' },
          { id: 'PC.6.2', code: 'PC.6.2', text: "The treatment plan is designed to achieve desired outcomes in reasonable goals.", activityType: 'DEN' },
          { id: 'PC.6.3', code: 'PC.6.3', text: "The treatment plan is reviewed every visit, based on the outcome measures and other significant changes in the patient's condition.", activityType: 'DEN' }
        ]
      },
      {
        id: 'PC.7', code: 'PC.7',
        title: 'The dentist records the dental procedures performed in the dental record.',
        intent: 'Complete documentation must be maintained for all dental procedures including procedure name, location, materials used, sedation/analgesia type and dose, procedure details, outcomes, and complications.',
        substandards: [
          { id: 'PC.7.1', code: 'PC.7.1', text: "Documentation contains the name of the procedures.", activityType: 'DEN' },
          { id: 'PC.7.2', code: 'PC.7.2', text: "The dental record highlights any material used in the procedure.", activityType: 'DEN' },
          { id: 'PC.7.3', code: 'PC.7.3', text: "The dental record contains the type of sedation or analgesia offered and its dose.", activityType: 'DEN' },
          { id: 'PC.7.4', code: 'PC.7.4', text: "The dentist reports the procedure details, outcome, and any complications.", activityType: 'DEN' }
        ]
      },
      {
        id: 'PC.8', code: 'PC.8',
        title: 'The dental center develops and monitors the implementation of evidence-based clinical practice guidelines.',
        intent: 'The center must adopt updated evidence-based guidelines for managing patients with chronic medical conditions that pose risk to dental procedures. Guidelines must be reviewed every two years.',
        substandards: [
          { id: 'PC.8.1', code: 'PC.8.1', text: "The center's clinical guidelines cover the management of patients with relevant medical conditions.", activityType: 'DOC' },
          { id: 'PC.8.2', code: 'PC.8.2', text: "The clinical guidelines cover the use of prophylactic antibiotics.", activityType: 'DOC' },
          { id: 'PC.8.3', code: 'PC.8.3', text: "The clinical guidelines are updated at least every two years and their implementation is monitored.", activityType: 'INT' }
        ]
      },
      {
        id: 'PC.11', code: 'PC.11',
        title: 'Dentists assist patients, and when appropriate their families, to fully participate in making informed decisions about their care, treatment, and procedures.',
        intent: 'Patient and family education is a cornerstone of successful treatment. Staff should ensure patients clearly understand their illness, treatment options, benefits, complications, and likelihood of success.',
        substandards: [
          { id: 'PC.11.1', code: 'PC.11.1', text: "Dentists provide patients and their families with formal and accurate information, in a manner they can understand, about their illness, options for treatment, expected treatment, potential benefits, potential complications, and the likelihood of successful results.", activityType: 'INT' },
          { id: 'PC.11.2', code: 'PC.11.2', text: "Patients' and families' education is based on their healthcare needs.", activityType: 'INT' },
          { id: 'PC.11.3', code: 'PC.11.3', text: "Patients are expected to discuss their plan of care with the dentist and have all their questions answered.", activityType: 'INT' },
          { id: 'PC.11.4', code: 'PC.11.4', text: "To assist the patient and family to give informed consent when surgery or a procedure is to be performed in the center, the patient and family receive information related to surgery and sedation by the dentist.", activityType: 'INT' },
          { id: 'PC.11.5', code: 'PC.11.5', text: "Patient and family education is evaluated for effectiveness through documenting teaching or re-teaching process/outcome.", activityType: 'DEN' }
        ]
      },
      {
        id: 'PC.12', code: 'PC.12',
        title: 'Informed consent is obtained from the patient or the guardian.',
        intent: 'Patients have the right to be fully aware of benefits, risks, complications, and consequences of refusing treatments. Consent is required before surgery, sedation, photographs, and research involvement.',
        substandards: [
          { id: 'PC.12.1', code: 'PC.12.1', text: "The center develops and implements policies that call for the procedure-specific informed consent, completely registered.", activityType: 'DOC' },
          { id: 'PC.12.2', code: 'PC.12.2', text: "Informed consent is obtained before surgery, invasive procedures, and the use of sedation.", activityType: 'DEN' },
          { id: 'PC.12.3', code: 'PC.12.3', text: "Informed consent is obtained before taking photographs of the oral cavity or face.", activityType: 'DEN' },
          { id: 'PC.12.4', code: 'PC.12.4', text: "Informed consent is obtained before involving the patient in a research project.", activityType: 'DOC' }
        ]
      },
      {
        id: 'PC.13', code: 'PC.13',
        title: 'The center develops a policy and procedure on safe medication management.',
        intent: 'Safe medication prescribing ensures accurate patient identification, allergy status documentation, proper pediatric weight identification, and no use of abbreviations. Adverse events must be reported.',
        substandards: [
          { id: 'PC.13.1', code: 'PC.13.1', text: "The medication management policy addresses the safe use of high-alert medications and look-alike sound-alike medications, and details interactions of multiple medications.", activityType: 'DOC' },
          { id: 'PC.13.2', code: 'PC.13.2', text: "Adverse drug reactions are documented in the dental records and reported to relevant authorities as per local regulations.", activityType: 'DEN' }
        ]
      },
      {
        id: 'PC.14', code: 'PC.14',
        title: 'The center provides appropriate storage for medications and dental materials.',
        intent: 'Medications lose potency if not stored properly. Environmental control (temperature, light, humidity) must be maintained. Inventory should include quantities and expiration dates following the FEFO concept.',
        substandards: [
          { id: 'PC.14.1', code: 'PC.14.1', text: "Medications and dental materials are stored in a secure manner as per the manufacturer's recommendations.", activityType: 'OBS' },
          { id: 'PC.14.2', code: 'PC.14.2', text: "Storage areas are clean and tidy.", activityType: 'OBS' },
          { id: 'PC.14.3', code: 'PC.14.3', text: "Stored items have an inventory with identified locations and expiration dates.", activityType: 'DOC' },
          { id: 'PC.14.4', code: 'PC.14.4', text: "Items are stored according to the first expired, first out (FEFO) concept.", activityType: 'OBS' },
          { id: 'PC.14.5', code: 'PC.14.5', text: "Storage refrigerators are dedicated to dental materials only.", activityType: 'OBS' }
        ]
      }
    ];

    // ============================================
    // DATA: Dental Laboratory (DL) - Surveyor 1
    // ============================================
    const dentalLaboratoryStandards = [
      {
        id: 'DL.1', code: 'DL.1',
        title: 'The center develops and implements policies and procedures to guide the dental laboratory services in accordance with applicable laws and regulations.',
        intent: 'The dental laboratory should handle patients\' dental requirements as determined by the treatment plan. Policies and procedures guide identification, handling, processing, transporting, and disposing of materials.',
        substandards: [
          { id: 'DL.1.1', code: 'DL.1.1', text: "The scope of work in the dental laboratory is aligned with the center's scope of service.", activityType: 'DOC' },
          { id: 'DL.1.2', code: 'DL.1.2', text: "Dental laboratory policies and procedures guide the process of identification, handling, processing, transporting, and disposing of dental materials and products.", activityType: 'DOC' },
          { id: 'DL.1.3', code: 'DL.1.3', text: "A licensed dental technician carries out dental laboratory services.", activityType: 'PER' },
          { id: 'DL.1.4', code: 'DL.1.4', text: "The laboratory implements a standardized process to improve the effectiveness of communication between laboratory technicians, dentists, and other caregivers.", activityType: 'INT' },
          { id: 'DL.1.5', code: 'DL.1.5', text: "The laboratory maintains a process for monitoring compliance with the policies and procedures through regular inspections, tracking, and analysis of the findings. This process is used to guide improvements.", activityType: 'INT' }
        ]
      },
      {
        id: 'DL.2', code: 'DL.2',
        title: 'The center develops a process for identifying patient-related dental prosthesis, impressions, and appliances.',
        intent: 'Ensuring right care to right patient is essential. Dental prosthesis, impressions, and appliances must be identified with at least 2 patient identifiers immediately after taking them.',
        substandards: [
          { id: 'DL.2.1', code: 'DL.2.1', text: "Dental impressions and biopsies are immediately identified after taking it.", activityType: 'OBS' },
          { id: 'DL.2.2', code: 'DL.2.2', text: "Dental appliances are identified.", activityType: 'OBS' },
          { id: 'DL.2.3', code: 'DL.2.3', text: "Avulsed teeth are identified immediately after receiving from the patient.", activityType: 'INT' },
          { id: 'DL.2.4', code: 'DL.2.4', text: "Identification of patient-related dental prosthesis, impressions, and appliances performed using at least two (2) patient identifiers.", activityType: 'INT' }
        ]
      },
      {
        id: 'DL.3', code: 'DL.3',
        title: 'Dental laboratory staff minimize the risk of infection in their workplace.',
        intent: 'Dental laboratories deal with items in direct contact with saliva and mucosa. The center must exert all possible efforts to prevent the spread of infection inside the dental laboratories.',
        substandards: [
          { id: 'DL.3.1', code: 'DL.3.1', text: "The laboratory has a designated area for receiving all incoming work, separate from the production area.", activityType: 'OBS' },
          { id: 'DL.3.2', code: 'DL.3.2', text: "Staff are not allowed to eat or drink in the dental laboratory except in a designated room.", activityType: 'OBS' },
          { id: 'DL.3.3', code: 'DL.3.3', text: "Gloves are worn when dealing with contaminated items. Masks and waterproof aprons are used to prevent contamination from splashes and aerosols.", activityType: 'OBS' },
          { id: 'DL.3.4', code: 'DL.3.4', text: "Workbenches, sinks, and model trimmers are wiped down with disinfectant at the beginning and end of the working day.", activityType: 'INT' },
          { id: 'DL.3.5', code: 'DL.3.5', text: "Impressions and appliances received from the clinic are inspected for proper cleaning and disinfection and rejected if not found in compliance.", activityType: 'INT' },
          { id: 'DL.3.6', code: 'DL.3.6', text: "Appliances are disinfected before being returned to the dental clinic.", activityType: 'INT' }
        ]
      },
      {
        id: 'DL.4', code: 'DL.4',
        title: 'The structure and equipment of the dental laboratory ensure staff safety.',
        intent: 'Due to hazardous materials and procedures performed, dental laboratories are hazardous workplaces. The director ensures that structure and equipment comply with safety requirements.',
        substandards: [
          { id: 'DL.4.1', code: 'DL.4.1', text: "The flooring is made of a material that is easy to maintain, with no carpets, readily cleanable, and appropriately wear-resistant for the location. All floor joints for ducts and pipes are tightly sealed.", activityType: 'OBS' },
          { id: 'DL.4.2', code: 'DL.4.2', text: "Wall finishes are washable, moisture-resistant, and smooth. The walls do not have any grooves or cracks that can harbor dust and dirt.", activityType: 'OBS' },
          { id: 'DL.4.3', code: 'DL.4.3', text: "The unit has adequate hand wash facilities, an emergency shower, eye-flushing devices, adequate lighting, and appropriate storage for flammable liquids.", activityType: 'OBS' },
          { id: 'DL.4.4', code: 'DL.4.4', text: "There is a dedicated place to mold ceramics that is isolated from the other areas of the dental laboratory and is protected from dust.", activityType: 'OBS' },
          { id: 'DL.4.5', code: 'DL.4.5', text: "All propane and butane gas cylinders are stored safely and securely outside the lab, clearly marked, with emergency shut-off valves located inside the laboratory.", activityType: 'OBS' },
          { id: 'DL.4.6', code: 'DL.4.6', text: "Oxygen and argon gases, if used, are placed securely in a safe area away from flammable gases.", activityType: 'OBS' },
          { id: 'DL.4.7', code: 'DL.4.7', text: "Appropriate first aid kits are readily accessible and regularly maintained.", activityType: 'OBS' }
        ]
      },
      {
        id: 'DL.5', code: 'DL.5',
        title: 'The structure of the dental laboratory ensures proper ventilation and airflow.',
        intent: 'Ventilation system design is crucial for staff safety. Separate, proper, and maintained air and vacuum systems ensure safety and reduce risk in the dental laboratory.',
        substandards: [
          { id: 'DL.5.1', code: 'DL.5.1', text: "The laboratory maintains adequate ventilation.", activityType: 'OBS' },
          { id: 'DL.5.2', code: 'DL.5.2', text: "Air and vacuum systems for the dental clinic are dedicated for clinic use only and are not connected to the dental laboratory.", activityType: 'OBS' },
          { id: 'DL.5.3', code: 'DL.5.3', text: "Direct dedicated exhaust is placed over all burnout, casting, and/or boil-out areas. The exhaust is located within 18 inches of the source equipment to effectively remove heat, smoke, or odors.", activityType: 'OBS' }
        ]
      }
    ];

    // ============================================
    // DATA: Infection Prevention and Control (IPC) - Surveyor 1
    // ============================================
    const infectionControlStandards = [
      {
        id: 'IPC.1', code: 'IPC.1',
        title: 'The center implements a coordinated program to reduce the risk of infection to patients and staff.',
        intent: 'The center must establish an evidence-based infection control program. All activities should be regulated by scientifically based policies overseen by a qualified individual.',
        substandards: [
          { id: 'IPC.1.1', code: 'IPC.1.1', text: "The infection control program is developed collaboratively by the center's staff and approved by the center's leaders.", activityType: 'DOC' },
          { id: 'IPC.1.2', code: 'IPC.1.2', text: "The infection control program is based on current evidence-based guidelines and covers both patients and staff.", activityType: 'DOC' },
          { id: 'IPC.1.3', code: 'IPC.1.3', text: "Policies and procedures targeting the most important infection risk processes are developed to guide the infection prevention and control program.", activityType: 'DOC' },
          { id: 'IPC.1.4', code: 'IPC.1.4', text: "The components of the infection control program are combined in a manual that is available to all staff members.", activityType: 'DOC' },
          { id: 'IPC.1.5', code: 'IPC.1.5', text: "The center provides the staff with annual education on infection prevention and control policies and any related updates, with evidence of staff education kept in their personnel files.", activityType: 'PER' },
          { id: 'IPC.1.6', code: 'IPC.1.6', text: "The infection control program implementation is monitored by the center's leaders.", activityType: 'INT' }
        ]
      },
      {
        id: 'IPC.2', code: 'IPC.2',
        title: "The dental center's design and structure support the national infection prevention and control requirements.",
        intent: 'A properly designed center is essential for prevention and control of infection. Structural elements must meet minimum requirements for dental examination, procedure rooms, and sterilization unit.',
        substandards: [
          { id: 'IPC.2.1', code: 'IPC.2.1', text: "A dirty utility room is available for collecting medical and non-medical waste.", activityType: 'OBS' },
          { id: 'IPC.2.2', code: 'IPC.2.2', text: "A janitorial room is available for storing all cleaning equipment and material.", activityType: 'OBS' },
          { id: 'IPC.2.3', code: 'IPC.2.3', text: "All dental procedure rooms are equipped with two sinks that are easily accessible to the dentist and dental assistant.", activityType: 'OBS' },
          { id: 'IPC.2.4', code: 'IPC.2.4', text: "Work surfaces and benchtops in dental procedure rooms are sufficient, uncluttered, nonporous, impervious to water, smooth, and have sealed joints to facilitate cleaning.", activityType: 'OBS' },
          { id: 'IPC.2.5', code: 'IPC.2.5', text: "Dental procedure rooms are functionally separated into a clean zone and a contaminated zone.", activityType: 'OBS' },
          { id: 'IPC.2.6', code: 'IPC.2.6', text: "The dental sterilization unit has a dedicated contaminated zone for receiving and washing dental instruments and a dedicated clean zone for sterilization, with a unidirectional flow of instruments from dirty to clean.", activityType: 'OBS' }
        ]
      },
      {
        id: 'IPC.3', code: 'IPC.3',
        title: 'The center adopts an evidence-based and effective hand hygiene program.',
        intent: 'Hand hygiene is the most effective method of preventing infectious disease transmission. The center should provide facilities and monitor hand hygiene compliance among staff.',
        substandards: [
          { id: 'IPC.3.1', code: 'IPC.3.1', text: "Written policies and procedures on implementing and monitoring appropriate hand hygiene are available.", activityType: 'DOC' },
          { id: 'IPC.3.2', code: 'IPC.3.2', text: "The center provides hand hygiene facilities sufficient to meet its needs such as sinks, alcohol hand rubs, plain and antiseptic soap, and disposable paper towels.", activityType: 'OBS' }
        ]
      },
      {
        id: 'IPC.4', code: 'IPC.4',
        title: 'The center develops a process to prevent the spread of infection inside the dental procedure room contaminated zone.',
        intent: 'The contaminated zone is a source of infection if prevention standards are not followed before, during, and after each examination or procedure.',
        substandards: [
          { id: 'IPC.4.1', code: 'IPC.4.1', text: "Opened boxes of gloves, cotton rolls, or gauze are stored outside the contaminated zone and protected from contamination caused by splashes and aerosols.", activityType: 'OBS' },
          { id: 'IPC.4.2', code: 'IPC.4.2', text: "Equipment that is difficult to clean is covered with a protective plastic wrap that is replaced before each new patient.", activityType: 'OBS' },
          { id: 'IPC.4.3', code: 'IPC.4.3', text: "Clinical contact surfaces are disinfected in between patients. Blood stained surfaces are disinfected with an intermediate-level disinfectant.", activityType: 'OBS' },
          { id: 'IPC.4.4', code: 'IPC.4.4', text: "Cartridges of local anesthetic are kept in their individual packs and stored appropriately to prevent environmental contamination by aerosols and splashes.", activityType: 'OBS' },
          { id: 'IPC.4.5', code: 'IPC.4.5', text: "The spittoon is cleaned after each patient by wiping it with neutral detergent using disposable paper towels.", activityType: 'OBS' },
          { id: 'IPC.4.6', code: 'IPC.4.6', text: "Used instruments are transported in a closed prick-proof container to either the sterilization unit or the dirty utility, and not washed in the clinical area.", activityType: 'OBS' },
          { id: 'IPC.4.7', code: 'IPC.4.7', text: "Used instruments are sprayed or soaked with an enzymatic detergent if not immediately removed for washing and sterilization.", activityType: 'OBS' }
        ]
      },
      {
        id: 'IPC.5', code: 'IPC.5',
        title: 'Personal protective equipment is available, readily accessible, and is used correctly by staff in all patient care areas.',
        intent: 'PPE is a fundamental tool in infection prevention and control. The center identifies situations requiring masks, eye protection, gowns, or gloves and provides sufficient supply and training.',
        substandards: [
          { id: 'IPC.5.1', code: 'IPC.5.1', text: "Written policies and procedures are available on the appropriate use of gloves, gowns, facemasks, and protective eyewear.", activityType: 'DOC' },
          { id: 'IPC.5.2', code: 'IPC.5.2', text: "Gloves and surgical masks are worn by the dentist and dental assistant for all clinical procedures. Sterile gloves are worn for any oral surgical procedures.", activityType: 'OBS' },
          { id: 'IPC.5.3', code: 'IPC.5.3', text: "Dental assistants put on new gloves for cleaning the working surfaces during the changeover between patients.", activityType: 'OBS' },
          { id: 'IPC.5.4', code: 'IPC.5.4', text: "Protective eyewear or face shields are worn by the dentist, dental assistant, and the patient. In case of patient refusal, risks are explained and refusal is documented in the dental record.", activityType: 'OBS' },
          { id: 'IPC.5.5', code: 'IPC.5.5', text: "When a risk of large splashes with blood or body substances is anticipated, impermeable protective clothing or gowns are worn by the dentist and dental assistant.", activityType: 'OBS' }
        ]
      },
      {
        id: 'IPC.6', code: 'IPC.6',
        title: 'The center minimizes the risk of infection from dental impressions and dental appliances.',
        intent: 'Dental impressions and appliances are a known source of infection transmission. Every effort must be exerted to eliminate the risk of infection from these items.',
        substandards: [
          { id: 'IPC.6.1', code: 'IPC.6.1', text: "Dental impressions are decontaminated by rinsing in running water, immersing in a diluted detergent with recommended exposure time, and then rinsing to remove the detergent, and placed in a sealed bag before transportation to the dental laboratory.", activityType: 'OBS' },
          { id: 'IPC.6.2', code: 'IPC.6.2', text: "All materials, impressions, dental prostheses, intraoral and extraoral appliances are cleaned thoroughly before insertion and adjustment.", activityType: 'OBS' },
          { id: 'IPC.6.3', code: 'IPC.6.3', text: "The orally soiled prosthesis is scrubbed with a brush and anti-microbial soap and placed in an ultrasonic cleaner, and later rinsed under tap water and dried before initiating any required work.", activityType: 'OBS' }
        ]
      },
      {
        id: 'IPC.7', code: 'IPC.7',
        title: 'The dental center minimizes the risk of water contamination.',
        intent: 'Dental procedures depend on water jets running through the patient\'s oral cavity. Eliminating water contamination is essential for infection prevention and control.',
        substandards: [
          { id: 'IPC.7.1', code: 'IPC.7.1', text: "The dental center uses softened water in all water lines with a colony count of less than (500) colony forming units/ml.", activityType: 'DOC' },
          { id: 'IPC.7.2', code: 'IPC.7.2', text: "Sterile irrigants are used for aseptic procedures.", activityType: 'OBS' },
          { id: 'IPC.7.3', code: 'IPC.7.3', text: "All waterlines are equipped with a biofilm and a non-return valve.", activityType: 'OBS' },
          { id: 'IPC.7.4', code: 'IPC.7.4', text: "Waterlines are cleaned and disinfected in accordance with the manufacturer's instructions.", activityType: 'OBS' },
          { id: 'IPC.7.5', code: 'IPC.7.5', text: "Air and water lines from any device are flushed for a minimum of two (2) minutes at the start of the day and for (30) seconds between patients.", activityType: 'OBS' }
        ]
      },
      {
        id: 'IPC.8', code: 'IPC.8',
        title: 'The center minimizes the risk of infection encountered with the use of intraoral radiographs.',
        intent: 'Intraoral radiographs are a potential source of infection through the oral cavity. Strict protocols should be followed to eliminate infection risk.',
        substandards: [
          { id: 'IPC.8.1', code: 'IPC.8.1', text: "Gloves are worn when exposing radiographs and handling contaminated film packets.", activityType: 'OBS' },
          { id: 'IPC.8.2', code: 'IPC.8.2', text: "Intraoral devices are either disposable or heat tolerant.", activityType: 'OBS' },
          { id: 'IPC.8.3', code: 'IPC.8.3', text: "Exposed radiographs are dried of saliva/blood and placed in a protective container before transport to the developing room.", activityType: 'OBS' },
          { id: 'IPC.8.4', code: 'IPC.8.4', text: "Digital radiography sensors are covered with an appropriate barrier during exposure and disinfected in between patients using the manufacturer's recommendation.", activityType: 'OBS' },
          { id: 'IPC.8.5', code: 'IPC.8.5', text: "Contaminated radiography equipment, including the radiograph tube head and control panel, is cleaned after each patient use. Alternatively, barrier protection can be applied and changed after each patient use.", activityType: 'OBS' }
        ]
      },
      {
        id: 'IPC.9', code: 'IPC.9',
        title: 'Sterilization services support infection prevention and control.',
        intent: 'Infection risk is minimized through proper cleaning, disinfection, and sterilization. CSSD must set policies guiding collection, decontamination, cleaning, sterilization, and storage.',
        substandards: [
          { id: 'IPC.9.1', code: 'IPC.9.1', text: "The sterilization processes are conducted by qualified staff.", activityType: 'PER' },
          { id: 'IPC.9.2', code: 'IPC.9.2', text: "There is an adequate and dedicated space for sterilization services that supports the sterilization processes.", activityType: 'OBS' },
          { id: 'IPC.9.3', code: 'IPC.9.3', text: "The center develops a policy and procedure for the safe reprocessing of single-use items.", activityType: 'DOC' },
          { id: 'IPC.9.4', code: 'IPC.9.4', text: "Personal protective equipment is available and utilized during the decontamination process.", activityType: 'OBS' },
          { id: 'IPC.9.5', code: 'IPC.9.5', text: "Sterilizers are in proper working order and sterilizer's instructions are available.", activityType: 'OBS' },
          { id: 'IPC.9.6', code: 'IPC.9.6', text: "Proper sterilization parameters are recorded and records are retained for one year.", activityType: 'DOC' },
          { id: 'IPC.9.7', code: 'IPC.9.7', text: "Chemical indicators are used in every package and biological indicators are used at least weekly. Records of results are kept for one year.", activityType: 'DOC' }
        ]
      },
      {
        id: 'IPC.10', code: 'IPC.10',
        title: 'The center defines, in a policy, the environmental cleaning, decontamination, and disinfection processes in all patient care areas.',
        intent: 'Environmental cleaning ensures appropriate decontamination of surfaces that could transmit dangerous pathogens. Disinfectants must be selected based on scientific references.',
        substandards: [
          { id: 'IPC.10.1', code: 'IPC.10.1', text: "The center develops and regularly reviews the procedures and schedules for cleaning, decontamination, and disinfection.", activityType: 'DOC' },
          { id: 'IPC.10.2', code: 'IPC.10.2', text: "The center keeps a schedule that lists all environmental surfaces, equipment, and items to be cleaned/disinfected in care areas.", activityType: 'DOC' },
          { id: 'IPC.10.3', code: 'IPC.10.3', text: "The center keeps a list of appropriate detergents and disinfectants for dental instruments and prosthesis in accordance with the manufacturer's instructions.", activityType: 'DOC' },
          { id: 'IPC.10.4', code: 'IPC.10.4', text: "Detergents and disinfectants are available and used properly in accordance with the manufacturer's instructions.", activityType: 'OBS' },
          { id: 'IPC.10.5', code: 'IPC.10.5', text: "The center has a process to safely handle blood and body fluids spills.", activityType: 'DOC' }
        ]
      },
      {
        id: 'IPC.11', code: 'IPC.11',
        title: 'The center develops a policy and procedure for the prevention and management of sharp injuries.',
        intent: 'To prevent sharps injuries with exposure to blood-borne infections, the center should have a defined system for sharps handling, use, and disposal according to written policy.',
        substandards: [
          { id: 'IPC.11.1', code: 'IPC.11.1', text: "To prevent injuries from sharps, needles are not bent, broken, or recapped except in special and approved circumstances, the 'scoop method' is used if recapping is necessary.", activityType: 'OBS' },
          { id: 'IPC.11.2', code: 'IPC.11.2', text: "Needles and sharps are disposed of in sharp boxes or containers of appropriate size and number.", activityType: 'OBS' },
          { id: 'IPC.11.3', code: 'IPC.11.3', text: "Needle sticks or sharp injuries are timely reported and investigated.", activityType: 'DOC' },
          { id: 'IPC.11.4', code: 'IPC.11.4', text: "Data on sharp injuries are analyzed and trended over time and findings are utilized for further prevention of injuries.", activityType: 'DOC' }
        ]
      },
      {
        id: 'IPC.12', code: 'IPC.12',
        title: 'The center implements a program for the safe collection, storage, and disposal of medical waste that is consistent with laws and regulations.',
        intent: 'To protect the public and environment from infectious organisms, the center should implement a Medical Waste Management Program regulating segregation, handling, storage, and disposal.',
        substandards: [
          { id: 'IPC.12.1', code: 'IPC.12.1', text: "Medical waste is stored for final disposal in a dedicated, cleaned, and maintained waste collection room.", activityType: 'OBS' },
          { id: 'IPC.12.2', code: 'IPC.12.2', text: "Medical waste, including sharp boxes, is discarded by a registered medical waste company.", activityType: 'DOC' },
          { id: 'IPC.12.3', code: 'IPC.12.3', text: "Yellow bags are used for all non-sharp disposable materials contaminated with the patient's blood or body fluids.", activityType: 'OBS' },
          { id: 'IPC.12.4', code: 'IPC.12.4', text: "Hazardous signs are fixed on all medical waste containers.", activityType: 'OBS' }
        ]
      },
      {
        id: 'IPC.13', code: 'IPC.13',
        title: "The center develops policies and procedures that address employees' screening, immunization, and post-exposure management.",
        intent: 'Dental staff are at risk of infection from patients. The center must develop evidence-based policies governing staff vaccination and post-exposure management.',
        substandards: [
          { id: 'IPC.13.1', code: 'IPC.13.1', text: "Screening, immunization, and post-exposure management of employees are consistent with the laws and regulations, and the recommendations of professional organizations.", activityType: 'DOC' },
          { id: 'IPC.13.2', code: 'IPC.13.2', text: "All employees have baseline screening for hepatitis B, hepatitis C, HIV, and tuberculosis.", activityType: 'PER' },
          { id: 'IPC.13.3', code: 'IPC.13.3', text: "The immune status of newly hired staff against hepatitis B is determined by serological testing and appropriate vaccine(s) are administered to those who are non-immune.", activityType: 'PER' },
          { id: 'IPC.13.4', code: 'IPC.13.4', text: "The response to hepatitis B vaccination is monitored in vaccinated employees four weeks after completing the vaccine series. Non-responders to the hepatitis B vaccine are offered at least a second series of the vaccine.", activityType: 'PER' }
        ]
      }
    ];

    // Chapter definitions for Surveyor 1 (A1)
    const chapters_A1 = [
      { id: 'LD', code: 'LD', name: 'Leadership of the Organization', standards: leadershipStandards, active: true },
      { id: 'PC', code: 'PC', name: 'Provision of Care', standards: provisionOfCareStandards, active: true },
      { id: 'DL', code: 'DL', name: 'Dental Laboratory', standards: dentalLaboratoryStandards, active: true },
      { id: 'IPC', code: 'IPC', name: 'Infection Prevention and Control', standards: infectionControlStandards, active: true }
    ];

    // Provision of Care Standards for Surveyor 2
    const provisionOfCareStandards_A2 = [
      {
        id: 'PC.1', code: 'PC.1',
        title: 'Patients have access to services based on their dental needs and the available services, and are registered with the center for providing such services.',
        intent: 'The center has to demonstrate a registry where every dental service is available based on the identified service requirements and the facility\'s scope of practice. New patients are met by a patient services personnel team or receptionist who helps establish care, assign a dental record, and register them with a primary dentist.',
        substandards: [
          { id: 'PC.1.1', code: 'PC.1.1', text: 'A standardized process is in place for screening and registering patients for services using their full name and identification number.', activityType: 'INT' },
          { id: 'PC.1.2', code: 'PC.1.2', text: 'Registration creates a dental record number that is unique to every patient.', activityType: 'DEN' },
          { id: 'PC.1.3', code: 'PC.1.3', text: 'An appointment system is in place to book patients in advance.', activityType: 'INT' }
        ]
      },
      {
        id: 'PC.2', code: 'PC.2',
        title: 'The center has a process to ensure the correct identification of patients and teeth.',
        intent: 'Patient identification errors can occur in virtually all aspects of diagnosis and treatment. The intent is to reliably identify the patient as the person for whom the service or treatment is intended and to match the service or treatment to that patient.',
        substandards: [
          { id: 'PC.2.1', code: 'PC.2.1', text: 'Patients are identified by at least two (2) identifiers: the full name as in the identification document, and a unique dental record number.', activityType: 'INT' },
          { id: 'PC.2.2', code: 'PC.2.2', text: 'Patients are identified before blood withdrawal, before any investigation, before administering medications, and before any surgery or procedure.', activityType: 'INT' },
          { id: 'PC.2.3', code: 'PC.2.3', text: 'Patients are actively involved in the process of patient identification.', activityType: 'OBS' },
          { id: 'PC.2.4', code: 'PC.2.4', text: 'An approved tooth numbering system (FDI) is used to identify the tooth in each intervention.', activityType: 'DEN' }
        ]
      },
      {
        id: 'PC.3', code: 'PC.3',
        title: 'The center develops and implements a process for reporting critical test results, whether performed on-site or outsourced.',
        intent: 'Diagnostic procedures and their results help define the patient\'s condition and identify treatment options. The center determines its critical tests and critical values. The process defines who reports to whom, what is reported, and how the process is managed.',
        substandards: [
          { id: 'PC.3.1', code: 'PC.3.1', text: 'The process defines which staff is responsible to receive critical test results.', activityType: 'DOC' },
          { id: 'PC.3.2', code: 'PC.3.2', text: 'The process involves writing down the test result by the receiver and reading back the findings to the result provider.', activityType: 'INT' },
          { id: 'PC.3.3', code: 'PC.3.3', text: 'The read-back process and the dentist\'s intervention are documented in the patient dental record.', activityType: 'DEN' },
          { id: 'PC.3.4', code: 'PC.3.4', text: 'The center develops a process for contacting patients that left the center when critical test results are reported.', activityType: 'INT' }
        ]
      },
      {
        id: 'PC.5', code: 'PC.5',
        title: 'The dental center ensures all required safety measures are performed for moderate sedation.',
        intent: 'Moderate sedation is a drug-induced depression of consciousness during which patients respond purposefully to verbal commands. The center must ensure proper equipment, trained staff, recovery protocols, and documentation for patient safety.',
        substandards: [
          { id: 'PC.5.1', code: 'PC.5.1', text: 'The procedure room is equipped with an appropriate nitrous oxide/oxygen mixing device and the appropriate monitoring equipment that permits continuous recording of the patient\'s EEG and oxygen saturation, with an intermittent recording of the blood pressure.', activityType: 'OBS' },
          { id: 'PC.5.2', code: 'PC.5.2', text: 'The dentist performing the procedure is certified competent in moderate sedation and managing its possible complications.', activityType: 'PER' },
          { id: 'PC.5.3', code: 'PC.5.3', text: 'The dental assistant is certified/competent in monitoring patients under moderate sedation.', activityType: 'PER' },
          { id: 'PC.5.4', code: 'PC.5.4', text: 'The center has a recovery room, with monitoring equipment, adjacent to the procedure room or the patient is reassessed in the same procedure room.', activityType: 'OBS' },
          { id: 'PC.5.5', code: 'PC.5.5', text: 'The patient is discharged home after full recovery utilizing evidence-based recovery criteria that are documented in the patient dental record.', activityType: 'DEN' }
        ]
      },
      {
        id: 'PC.10', code: 'PC.10',
        title: 'The center has a policy and process to safely provide care to patients who require cardiopulmonary resuscitation (CPR).',
        intent: 'A policy and process are in place that outlines how the dental center will care for patients who require cardiopulmonary resuscitation (CPR). The policy documents arrangements for transferring patients to appropriate facilities when needed.',
        substandards: [
          { id: 'PC.10.1', code: 'PC.10.1', text: 'The CPR policy highlights the availability of a standardized crash cart(s) or automated external defibrillator (AED) in the patient care areas.', activityType: 'OBS' },
          { id: 'PC.10.2', code: 'PC.10.2', text: 'The policy describes the process for qualified staff to check the crash cart every shift and after each use.', activityType: 'INT' },
          { id: 'PC.10.3', code: 'PC.10.3', text: 'The role of staff involved in the CPR process is clearly defined in the CPR policy and monitored for implementation.', activityType: 'DOC' }
        ]
      },
      {
        id: 'PC.15', code: 'PC.15',
        title: 'Internal radiology services are available in dental centers and operated safely. Other radiology services are outsourced, as needed, to meet patient needs.',
        intent: 'Intraoral x-ray tests are usually in-house services. Panoramic and cephalometric x-rays are found in orthodontic centers. Cone beam CT scans are available in some dental centers and performed when clinically indicated.',
        substandards: [
          { id: 'PC.15.1', code: 'PC.15.1', text: 'The center has functional in-house intraoral and panoramic radiology services.', activityType: 'OBS' },
          { id: 'PC.15.2', code: 'PC.15.2', text: 'Intraoral radiographs, dental panorama, and cephalometric radiographs are carried out by the dental assistant or a radiology technician.', activityType: 'PER' },
          { id: 'PC.15.3', code: 'PC.15.3', text: 'Dental cone-beam CT scans are carried out by a licensed radiology technician or a trained dental assistant.', activityType: 'PER' },
          { id: 'PC.15.4', code: 'PC.15.4', text: 'Intraoral, panoramic, and cephalometric radiographs are read and reported by the ordering dentist.', activityType: 'DEN' },
          { id: 'PC.15.5', code: 'PC.15.5', text: 'Dental cone-beam CT scans are read and reported by a qualified trained dentist.', activityType: 'PER' }
        ]
      },
      {
        id: 'PC.16', code: 'PC.16',
        title: 'The center develops a radiation safety program.',
        intent: 'Radiation safety programs reduce the risk of exposure to ionizing radiation to patients, visitors, and staff. The center ensures all radiation equipment is properly maintained, staff are trained and monitored, and appropriate safety measures are in place.',
        substandards: [
          { id: 'PC.16.1', code: 'PC.16.1', text: 'The radiation safety program covers all areas where ionizing radiation is used for either intraoral or extraoral x-rays.', activityType: 'DOC' },
          { id: 'PC.16.2', code: 'PC.16.2', text: 'All areas where ionizing radiation is administered are tested and certified radiation leak-proof by the appropriate certifying local authority.', activityType: 'DOC' },
          { id: 'PC.16.3', code: 'PC.16.3', text: 'Radiology equipment is periodically inspected, calibrated, and maintained for proper functioning.', activityType: 'DOC' },
          { id: 'PC.16.4', code: 'PC.16.4', text: 'Safety warnings are posted in clear and appropriate locations on the doors.', activityType: 'OBS' },
          { id: 'PC.16.5', code: 'PC.16.5', text: 'Women of childbearing age with missed menstruation are checked for the possibility of being pregnant prior to having X-ray tests.', activityType: 'INT' },
          { id: 'PC.16.6', code: 'PC.16.6', text: 'Personnel are monitored for radiation exposure by thermoluminescence dosimeters (TLD) that are regularly checked.', activityType: 'DOC' },
          { id: 'PC.16.7', code: 'PC.16.7', text: 'Personnel shielding devices, including radiation protection aprons, are available for patients and staff, and periodically inspected and tested for integrity and safety compliance as per the documentation.', activityType: 'DOC' }
        ]
      }
    ];

    // Chapter definitions for Surveyor 2 (A2)
    const chapters_A2 = [
      { id: 'LD', code: 'LD', name: 'Leadership of the Organization', standards: leadershipStandards_A2, active: true },
      { id: 'PC', code: 'PC', name: 'Provision of Care', standards: provisionOfCareStandards_A2, active: provisionOfCareStandards_A2.length > 0, placeholder: provisionOfCareStandards_A2.length === 0 },
      { id: 'MOI', code: 'MOI', name: 'Management of Information', standards: moiStandards, active: moiStandards.length > 0, placeholder: moiStandards.length === 0 },
      { id: 'FMS', code: 'FMS', name: 'Facility Management and Safety', standards: fmsStandards, active: fmsStandards.length > 0, placeholder: fmsStandards.length === 0 }
    ];

    // ============================================
    // CONFIGURATION B: Full Survey (All Domains Merged)
    // ============================================

    // Merge Leadership Standards (A1 + A2) - sorted by standard number
    const leadershipStandards_B = [...leadershipStandards, ...leadershipStandards_A2].sort((a, b) => {
      const numA = parseFloat(a.code.replace('LD.', ''));
      const numB = parseFloat(b.code.replace('LD.', ''));
      return numA - numB;
    });

    // Merge Provision of Care Standards (A1 + A2) - sorted by standard number
    const provisionOfCareStandards_B = [...provisionOfCareStandards, ...provisionOfCareStandards_A2].sort((a, b) => {
      const numA = parseFloat(a.code.replace('PC.', ''));
      const numB = parseFloat(b.code.replace('PC.', ''));
      return numA - numB;
    });

    // Domain color scheme for Configuration B (subtle, professional)
    const domainColors = {
      LD: { primary: '#1e3a5f', light: '#e8f4fc', accent: '#3498db', gradient: 'linear-gradient(135deg, #1e3a5f 0%, #2d5a8a 100%)' },
      PC: { primary: '#0d6b4e', light: '#e6f5f0', accent: '#27ae60', gradient: 'linear-gradient(135deg, #0d6b4e 0%, #1a9d6c 100%)' },
      DL: { primary: '#6b4e0d', light: '#fdf6e6', accent: '#f39c12', gradient: 'linear-gradient(135deg, #6b4e0d 0%, #9d7a1a 100%)' },
      IPC: { primary: '#5e1e5e', light: '#f5e8f5', accent: '#9b59b6', gradient: 'linear-gradient(135deg, #5e1e5e 0%, #8a3d8a 100%)' },
      MOI: { primary: '#1e5e5e', light: '#e8f5f5', accent: '#16a085', gradient: 'linear-gradient(135deg, #1e5e5e 0%, #3d8a8a 100%)' },
      FMS: { primary: '#5e1e2d', light: '#f5e8ec', accent: '#e74c3c', gradient: 'linear-gradient(135deg, #5e1e2d 0%, #8a3d4d 100%)' }
    };

    // Chapter definitions for Full Survey (B) - All 6 Domains
    const chapters_B = [
      { id: 'LD', code: 'LD', name: 'Leadership of the Organization', standards: leadershipStandards_B, active: true, color: domainColors.LD, order: 1 },
      { id: 'PC', code: 'PC', name: 'Provision of Care', standards: provisionOfCareStandards_B, active: true, color: domainColors.PC, order: 2 },
      { id: 'DL', code: 'DL', name: 'Dental Laboratory', standards: dentalLaboratoryStandards, active: true, color: domainColors.DL, order: 3 },
      { id: 'IPC', code: 'IPC', name: 'Infection Prevention and Control', standards: infectionControlStandards, active: true, color: domainColors.IPC, order: 4 },
      { id: 'MOI', code: 'MOI', name: 'Management of Information', standards: moiStandards, active: true, color: domainColors.MOI, order: 5 },
      { id: 'FMS', code: 'FMS', name: 'Facility Management and Safety', standards: fmsStandards, active: true, color: domainColors.FMS, order: 6 }
    ];

    // Default chapters (backwards compatible)
    const chapters = chapters_A1;

    // Function to get chapters by configuration
    const getChaptersByConfig = (config) => {
      switch(config) {
        case 'A2': return chapters_A2;
        case 'B': return chapters_B;
        case 'A1':
        default: return chapters_A1;
      }
    };

    // Get domain color by chapter ID
    const getDomainColor = (chapterId) => domainColors[chapterId] || domainColors.LD;

    const getAllSubstandards = (standardsList) => {
      const subs = [];
      standardsList.forEach(std => {
        std.substandards.forEach(sub => {
          subs.push({ ...sub, standardId: std.id, standardTitle: std.title, standardIntent: std.intent, standardCode: std.code });
        });
      });
      return subs;
    };

    // Group substandards by their mother standard
    const groupSubstandardsByStandard = (substandards) => {
      const groups = [];
      let currentGroup = null;

      substandards.forEach(sub => {
        if (!currentGroup || currentGroup.standardId !== sub.standardId) {
          currentGroup = {
            standardId: sub.standardId,
            standardCode: sub.standardCode,
            standardTitle: sub.standardTitle,
            standardIntent: sub.standardIntent,
            substandards: []
          };
          groups.push(currentGroup);
        }
        currentGroup.substandards.push(sub);
      });

      return groups;
    };

    // ============================================
    // SCORE INTERPRETATION
    // ============================================
    const getScoreInterpretation = (percentage) => {
      if (percentage >= 90) {
        return { level: 'excellent', title: 'Excellent - Ready for Accreditation',
          description: 'The center demonstrates exceptional compliance with CBAHI standards.' };
      } else if (percentage >= 75) {
        return { level: 'good', title: 'Good - Minor Improvements Needed',
          description: 'The center shows good compliance with most standards.' };
      } else if (percentage >= 60) {
        return { level: 'needs-improvement', title: 'Needs Improvement - Significant Gaps',
          description: 'Several areas require substantial improvement before accreditation readiness.' };
      } else {
        return { level: 'critical', title: 'Critical - Major Improvements Required',
          description: 'The center has significant gaps in compliance with CBAHI standards.' };
      }
    };

    // ============================================
    // COMPONENTS
    // ============================================

    // Activity Badge
    const ActivityBadge = ({ type }) => {
      const typeMap = {
        DOC: { label: 'Document Review', className: 'doc' },
        OBS: { label: 'Observation', className: 'obs' },
        INT: { label: 'Interview', className: 'int' },
        PER: { label: 'Personnel File', className: 'per' },
        DEN: { label: 'Dental Record Review', className: 'den' }
      };
      const info = typeMap[type] || { label: type, className: 'doc' };
      return <span className={`activity-badge ${info.className}`}>{info.label}</span>;
    };

    // Score Option
    const ScoreOption = ({ value, label, selected, onClick, type }) => (
      <div className={`score-option ${type} ${selected ? 'selected' : ''}`} onClick={onClick}>
        <div className={`score-indicator ${type}`}>{value === 'NA' ? '' : value}</div>
        <span>{label}</span>
      </div>
    );

    // Auto-save Indicator
    const AutosaveIndicator = ({ saving }) => (
      <div className={`autosave-indicator ${saving ? 'saving' : ''}`}>
        <div className="autosave-dot"></div>
        <span>{saving ? 'Saving...' : 'All changes saved'}</span>
      </div>
    );

    // Domain Separator Component for Full Survey Mode
    const DomainSeparator = ({ chapter, stats }) => {
      const domainClass = `domain-${chapter.code.toLowerCase()}`;
      return (
        <div className={`domain-separator ${domainClass}`}>
          <div className="domain-separator-content">
            <div className={`domain-icon ${domainClass}`}>{chapter.code}</div>
            <div className="domain-info">
              <div className="domain-title">{chapter.name}</div>
              <div className="domain-subtitle">
                <span>{chapter.standards.length} Standards</span>
                <span></span>
                <span>{stats.total} Sub-standards</span>
              </div>
            </div>
            <div className="domain-stats">
              <div className="domain-stat">
                <div className="domain-stat-value" style={{color: 'var(--success)'}}>{stats.fullyMet}</div>
                <div className="domain-stat-label">Fully Met</div>
              </div>
              <div className="domain-stat">
                <div className="domain-stat-value" style={{color: 'var(--warning)'}}>{stats.partial}</div>
                <div className="domain-stat-label">Partial</div>
              </div>
              <div className="domain-stat">
                <div className="domain-stat-value" style={{color: 'var(--danger)'}}>{stats.notMet}</div>
                <div className="domain-stat-label">Not Met</div>
              </div>
              <div className="domain-stat">
                <div className="domain-stat-value">{stats.pending}</div>
                <div className="domain-stat-label">Pending</div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // Sub-standard Card
    const SubstandardCard = ({ substandard, score, onScoreChange }) => {
      const scoreValue = score?.value;
      const comment = score?.comment || '';
      const location = score?.location || '';

      const getScoreClass = () => {
        if (scoreValue === 'NA') return 'scored-na';
        if (scoreValue === 0) return 'scored-0';
        if (scoreValue === 1) return 'scored-1';
        if (scoreValue === 2) return 'scored-2';
        return '';
      };

      return (
        <div className={`substandard-card ${getScoreClass()}`}>
          <div className="substandard-header">
            <span className="substandard-code">{substandard.code}</span>
            <ActivityBadge type={substandard.activityType} />
          </div>
          <div className="substandard-body">
            <p className="substandard-text">{substandard.text}</p>
            <div className="scoring-section">
              <div className="score-options">
                <ScoreOption value="NA" label="N/A" type="na"
                  selected={scoreValue === 'NA'}
                  onClick={() => onScoreChange(substandard.id, 'NA', comment, location)} />
                <ScoreOption value={0} label="Not Met" type="not-met"
                  selected={scoreValue === 0}
                  onClick={() => onScoreChange(substandard.id, 0, comment, location)} />
                <ScoreOption value={1} label="Partially Met" type="partial"
                  selected={scoreValue === 1}
                  onClick={() => onScoreChange(substandard.id, 1, comment, location)} />
                <ScoreOption value={2} label="Fully Met" type="full"
                  selected={scoreValue === 2}
                  onClick={() => onScoreChange(substandard.id, 2, comment, location)} />
              </div>
              <div className="comment-section">
                <textarea className="comment-input"
                  placeholder="Finding / Comment..."
                  value={comment}
                  onChange={(e) => onScoreChange(substandard.id, scoreValue, e.target.value, location)} />
                {substandard.activityType === 'OBS' && (
                  <div className="location-field">
                    <input type="text" className="location-input"
                      placeholder="Location..."
                      value={location}
                      onChange={(e) => onScoreChange(substandard.id, scoreValue, comment, e.target.value)} />
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      );
    };

    // Chapters Summary Modal
    const ChaptersSummaryModal = ({ isOpen, onClose, scores, chapters, onFinalize, isFinalized, overallPending }) => {
      // Lock body scroll when modal is open
      useEffect(() => {
        if (isOpen) {
          document.body.style.overflow = 'hidden';
        } else {
          document.body.style.overflow = '';
        }
        return () => { document.body.style.overflow = ''; };
      }, [isOpen]);

      if (!isOpen) return null;

      // Calculate stats for each chapter
      const chapterStats = chapters.map(chapter => {
        const allSubs = getAllSubstandards(chapter.standards);
        let total = allSubs.length;
        let scored = 0, fullyMet = 0, partial = 0, notMet = 0, na = 0;

        allSubs.forEach(sub => {
          const score = scores[sub.id];
          if (score && score.value !== undefined && score.value !== null) {
            scored++;
            if (score.value === 'NA') na++;
            else if (score.value === 2) fullyMet++;
            else if (score.value === 1) partial++;
            else if (score.value === 0) notMet++;
          }
        });

        const applicable = scored - na;
        const points = fullyMet * 2 + partial;
        const maxPoints = applicable * 2;
        const percentage = maxPoints > 0 ? Math.round((points / maxPoints) * 100) : 0;

        return {
          ...chapter,
          total, scored, fullyMet, partial, notMet, na, applicable, points, maxPoints, percentage
        };
      });

      // Calculate grand totals
      const grandTotal = chapterStats.reduce((acc, ch) => ({
        total: acc.total + ch.total,
        scored: acc.scored + ch.scored,
        fullyMet: acc.fullyMet + ch.fullyMet,
        partial: acc.partial + ch.partial,
        notMet: acc.notMet + ch.notMet,
        na: acc.na + ch.na,
        applicable: acc.applicable + ch.applicable,
        points: acc.points + ch.points,
        maxPoints: acc.maxPoints + ch.maxPoints
      }), { total: 0, scored: 0, fullyMet: 0, partial: 0, notMet: 0, na: 0, applicable: 0, points: 0, maxPoints: 0 });

      grandTotal.percentage = grandTotal.maxPoints > 0 ? Math.round((grandTotal.points / grandTotal.maxPoints) * 100) : 0;

      const getScoreColor = (pct) => {
        if (pct >= 90) return 'var(--success)';
        if (pct >= 75) return 'var(--primary)';
        if (pct >= 60) return 'var(--warning)';
        return 'var(--danger)';
      };

      return (
        <div className="modal-overlay" onClick={onClose} style={{overflowY: 'auto'}}>
          <div className="modal chapters-summary-modal" onClick={e => e.stopPropagation()} style={{maxWidth: '900px'}}>
            <div className="modal-header" style={{background: 'var(--primary)', color: 'white', borderRadius: '12px 12px 0 0'}}>
              <h3 style={{margin: 0, fontSize: '1.4rem'}}>Chapters Summary - All Domains</h3>
              <button className="modal-close" onClick={onClose} style={{color: 'white', background: 'rgba(255,255,255,0.2)'}}></button>
            </div>
            <div className="modal-body" style={{padding: '0', maxHeight: '70vh', overflowY: 'auto'}}>
              {/* Overall Score Banner */}
              <div style={{
                background: 'linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%)',
                color: 'white',
                padding: '28px',
                textAlign: 'center'
              }}>
                <div style={{fontSize: '3.5rem', fontWeight: '700', lineHeight: 1}}>{grandTotal.percentage}%</div>
                <div style={{fontSize: '1.1rem', opacity: 0.9, marginTop: '10px'}}>Overall Compliance Score</div>
                <div style={{display: 'flex', justifyContent: 'center', gap: '28px', marginTop: '18px', fontSize: '1rem'}}>
                  <span><strong>{grandTotal.scored}</strong> of <strong>{grandTotal.total}</strong> scored</span>
                  <span><strong>{grandTotal.applicable}</strong> applicable</span>
                </div>
              </div>

              {/* Chapter Cards */}
              <div style={{padding: '24px'}}>
                {chapterStats.map(ch => (
                  <div key={ch.id} style={{
                    background: 'var(--bg-card)',
                    border: '1px solid var(--border)',
                    borderRadius: '12px',
                    marginBottom: '20px',
                    overflow: 'hidden'
                  }}>
                    {/* Chapter Header */}
                    <div style={{
                      display: 'flex',
                      justifyContent: 'space-between',
                      alignItems: 'center',
                      padding: '18px 24px',
                      borderBottom: '1px solid var(--border)',
                      background: 'var(--bg-main)'
                    }}>
                      <div style={{display: 'flex', alignItems: 'center', gap: '12px'}}>
                        <span style={{
                          background: 'var(--primary)',
                          color: 'white',
                          padding: '6px 12px',
                          borderRadius: '6px',
                          fontWeight: '600',
                          fontSize: '0.95rem'
                        }}>{ch.code}</span>
                        <span style={{fontWeight: '600', fontSize: '1.05rem', color: 'var(--text-primary)'}}>{ch.name}</span>
                        {(ch.total - ch.scored) > 0 && (
                          <span style={{
                            background: 'rgba(142, 68, 173, 0.1)',
                            color: '#8e44ad',
                            padding: '4px 10px',
                            borderRadius: '4px',
                            fontSize: '0.8rem',
                            fontWeight: '600'
                          }}>{ch.total - ch.scored} pending</span>
                        )}
                      </div>
                      <div style={{
                        fontSize: '1.75rem',
                        fontWeight: '700',
                        color: getScoreColor(ch.percentage)
                      }}>{ch.percentage}%</div>
                    </div>

                    {/* Chapter Stats */}
                    <div style={{
                      display: 'grid',
                      gridTemplateColumns: 'repeat(6, 1fr)',
                      gap: '1px',
                      background: 'var(--border)'
                    }}>
                      <div style={{background: 'white', padding: '14px', textAlign: 'center'}}>
                        <div style={{fontSize: '0.85rem', color: 'var(--text-muted)', marginBottom: '6px'}}>Total</div>
                        <div style={{fontSize: '1.25rem', fontWeight: '600'}}>{ch.total}</div>
                      </div>
                      <div style={{background: 'white', padding: '14px', textAlign: 'center'}}>
                        <div style={{fontSize: '0.85rem', color: 'var(--text-muted)', marginBottom: '6px'}}>Scored</div>
                        <div style={{fontSize: '1.25rem', fontWeight: '600'}}>{ch.scored}</div>
                      </div>
                      <div style={{background: 'rgba(46, 204, 113, 0.1)', padding: '14px', textAlign: 'center'}}>
                        <div style={{fontSize: '0.85rem', color: 'var(--success)', marginBottom: '6px'}}>Fully Met</div>
                        <div style={{fontSize: '1.25rem', fontWeight: '600', color: 'var(--success)'}}>{ch.fullyMet}</div>
                      </div>
                      <div style={{background: 'rgba(241, 196, 15, 0.1)', padding: '14px', textAlign: 'center'}}>
                        <div style={{fontSize: '0.85rem', color: 'var(--warning)', marginBottom: '6px'}}>Partial</div>
                        <div style={{fontSize: '1.25rem', fontWeight: '600', color: 'var(--warning)'}}>{ch.partial}</div>
                      </div>
                      <div style={{background: 'rgba(231, 76, 60, 0.1)', padding: '14px', textAlign: 'center'}}>
                        <div style={{fontSize: '0.85rem', color: 'var(--danger)', marginBottom: '6px'}}>Not Met</div>
                        <div style={{fontSize: '1.25rem', fontWeight: '600', color: 'var(--danger)'}}>{ch.notMet}</div>
                      </div>
                      <div style={{background: 'rgba(149, 165, 166, 0.1)', padding: '14px', textAlign: 'center'}}>
                        <div style={{fontSize: '0.85rem', color: 'var(--neutral)', marginBottom: '6px'}}>N/A</div>
                        <div style={{fontSize: '1.25rem', fontWeight: '600', color: 'var(--neutral)'}}>{ch.na}</div>
                      </div>
                    </div>

                    {/* Progress Bar */}
                    <div style={{padding: '12px 20px', background: 'var(--bg-main)'}}>
                      <div style={{
                        height: '8px',
                        background: 'var(--bg-main)',
                        borderRadius: '4px',
                        overflow: 'hidden',
                        display: 'flex'
                      }}>
                        <div style={{width: `${ch.applicable > 0 ? (ch.fullyMet / ch.applicable) * 100 : 0}%`, background: 'var(--success)'}}></div>
                        <div style={{width: `${ch.applicable > 0 ? (ch.partial / ch.applicable) * 100 : 0}%`, background: 'var(--warning)'}}></div>
                        <div style={{width: `${ch.applicable > 0 ? (ch.notMet / ch.applicable) * 100 : 0}%`, background: 'var(--danger)'}}></div>
                      </div>
                    </div>

                  </div>
                ))}

                {/* Grand Total Card */}
                <div style={{
                  background: 'linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%)',
                  borderRadius: '12px',
                  overflow: 'hidden',
                  color: 'white',
                  marginTop: '8px',
                  padding: '20px'
                }}>
                  <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px'}}>
                    <div style={{display: 'flex', alignItems: 'center', gap: '12px'}}>
                      <span style={{fontSize: '1.1rem', fontWeight: '600'}}>Grand Total - All Chapters</span>
                      {(grandTotal.total - grandTotal.scored) > 0 && (
                        <span style={{
                          background: 'rgba(255,255,255,0.2)',
                          padding: '4px 10px',
                          borderRadius: '4px',
                          fontSize: '0.8rem',
                          fontWeight: '600'
                        }}>{grandTotal.total - grandTotal.scored} pending</span>
                      )}
                    </div>
                    <div style={{fontSize: '1.5rem', fontWeight: '700'}}>{grandTotal.percentage}%</div>
                  </div>
                  <div style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(6, 1fr)',
                    gap: '16px',
                    textAlign: 'center'
                  }}>
                    <div>
                      <div style={{opacity: 0.8, fontSize: '0.85rem', marginBottom: '4px'}}>Total</div>
                      <div style={{fontSize: '1.25rem', fontWeight: '600'}}>{grandTotal.total}</div>
                    </div>
                    <div>
                      <div style={{opacity: 0.8, fontSize: '0.85rem', marginBottom: '4px'}}>Scored</div>
                      <div style={{fontSize: '1.25rem', fontWeight: '600'}}>{grandTotal.scored}</div>
                    </div>
                    <div>
                      <div style={{opacity: 0.8, fontSize: '0.85rem', marginBottom: '4px'}}>Fully Met</div>
                      <div style={{fontSize: '1.25rem', fontWeight: '600'}}>{grandTotal.fullyMet}</div>
                    </div>
                    <div>
                      <div style={{opacity: 0.8, fontSize: '0.85rem', marginBottom: '4px'}}>Partial</div>
                      <div style={{fontSize: '1.25rem', fontWeight: '600'}}>{grandTotal.partial}</div>
                    </div>
                    <div>
                      <div style={{opacity: 0.8, fontSize: '0.85rem', marginBottom: '4px'}}>Not Met</div>
                      <div style={{fontSize: '1.25rem', fontWeight: '600'}}>{grandTotal.notMet}</div>
                    </div>
                    <div>
                      <div style={{opacity: 0.8, fontSize: '0.85rem', marginBottom: '4px'}}>N/A</div>
                      <div style={{fontSize: '1.25rem', fontWeight: '600'}}>{grandTotal.na}</div>
                    </div>
                  </div>

                  {/* Finalize Button in Summary Modal */}
                  {isFinalized ? (
                    <div style={{
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      gap: '8px',
                      marginTop: '20px',
                      padding: '12px 24px',
                      background: 'rgba(255,255,255,0.2)',
                      borderRadius: '25px',
                      fontSize: '15px',
                      fontWeight: '600'
                    }}>
                      <span></span> Assessment Finalized
                    </div>
                  ) : overallPending === 0 && grandTotal.total > 0 ? (
                    <button
                      onClick={onFinalize}
                      style={{
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        gap: '10px',
                        marginTop: '20px',
                        padding: '14px 32px',
                        background: 'linear-gradient(135deg, #27ae60 0%, #219a52 100%)',
                        border: 'none',
                        borderRadius: '25px',
                        color: 'white',
                        fontSize: '15px',
                        fontWeight: '700',
                        fontFamily: 'inherit',
                        cursor: 'pointer',
                        boxShadow: '0 4px 12px rgba(39, 174, 96, 0.4)',
                        transition: 'all 0.2s ease',
                        width: '100%',
                        maxWidth: '300px',
                        margin: '20px auto 0'
                      }}
                      onMouseOver={e => {
                        e.currentTarget.style.transform = 'translateY(-2px)';
                        e.currentTarget.style.boxShadow = '0 6px 16px rgba(39, 174, 96, 0.5)';
                      }}
                      onMouseOut={e => {
                        e.currentTarget.style.transform = 'translateY(0)';
                        e.currentTarget.style.boxShadow = '0 4px 12px rgba(39, 174, 96, 0.4)';
                      }}
                    >
                      <span></span> Finalize & Submit Assessment
                    </button>
                  ) : overallPending > 0 ? (
                    <div style={{
                      marginTop: '16px',
                      padding: '10px 16px',
                      background: 'rgba(255,255,255,0.15)',
                      borderRadius: '8px',
                      fontSize: '14px',
                      textAlign: 'center',
                      opacity: 0.9
                    }}>
                      Complete all {overallPending} pending items to finalize
                    </div>
                  ) : null}
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // Completion Celebration Modal
    const CompletionModal = ({ isOpen, onClose, stats, onFinalize }) => {
      if (!isOpen) return null;

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={e => e.stopPropagation()} style={{maxWidth: '500px'}}>
            <div className="modal-header" style={{background: 'linear-gradient(135deg, var(--success) 0%, #219a52 100%)', color: 'white', borderRadius: '12px 12px 0 0'}}>
              <h3 style={{margin: 0}}>All Standards Scored!</h3>
              <button className="modal-close" onClick={onClose} style={{color: 'white', background: 'rgba(255,255,255,0.2)'}}></button>
            </div>
            <div className="completion-modal">
              <div className="completion-icon">{Icons.award({size: 64, color: '#ffd700'})}</div>
              <div className="completion-title">Congratulations!</div>
              <div className="completion-subtitle">
                You have successfully scored all sub-standards.<br/>
                Ready to finalize and submit your assessment?
              </div>
              <div className="completion-stats">
                <div className="completion-stat">
                  <div className="completion-stat-value">{stats.percentage}%</div>
                  <div className="completion-stat-label">Overall Score</div>
                </div>
                <div className="completion-stat">
                  <div className="completion-stat-value" style={{color: 'var(--success)'}}>{stats.fullyMet}</div>
                  <div className="completion-stat-label">Fully Met</div>
                </div>
                <div className="completion-stat">
                  <div className="completion-stat-value" style={{color: 'var(--warning)'}}>{stats.partial}</div>
                  <div className="completion-stat-label">Partial</div>
                </div>
                <div className="completion-stat">
                  <div className="completion-stat-value" style={{color: 'var(--danger)'}}>{stats.notMet}</div>
                  <div className="completion-stat-label">Not Met</div>
                </div>
              </div>
              <button className="finalize-btn" onClick={onFinalize}>
                <span></span> Finalize & Submit
              </button>
            </div>
          </div>
        </div>
      );
    };

    // Finalize Confirmation Dialog
    const FinalizeConfirmDialog = ({ isOpen, onClose, onConfirm, stats, isSubmitting }) => {
      if (!isOpen) return null;

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={e => e.stopPropagation()} style={{maxWidth: '480px'}}>
            <div className="confirm-dialog">
              <div className="confirm-icon"></div>
              <div className="confirm-title">Finalize Assessment?</div>
              <div className="confirm-message">
                You are about to finalize and submit this assessment to Firebase for secure storage.
                <br/><br/>
                <strong>Final Score: {stats.percentage}%</strong>
                <br/>
                <span style={{fontSize: '13px', color: 'var(--text-muted)'}}>
                  ({stats.fullyMet} Fully Met, {stats.partial} Partial, {stats.notMet} Not Met, {stats.na} N/A)
                </span>
                <br/><br/>
                Once finalized, this assessment will be securely saved and timestamped.
              </div>
              <div className="confirm-buttons">
                <button className="confirm-btn confirm-btn-cancel" onClick={onClose} disabled={isSubmitting}>
                  Cancel
                </button>
                <button className="confirm-btn confirm-btn-submit" onClick={onConfirm} disabled={isSubmitting}>
                  {isSubmitting ? ' Submitting...' : ' Confirm & Submit'}
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // Modern Toast Notification Component
    const ToastNotification = ({ toasts, onDismiss }) => {
      if (!toasts || toasts.length === 0) return null;

      return (
        <div className="toast-container">
          {toasts.map(toast => (
            <div key={toast.id} className={`toast ${toast.type} ${toast.closing ? 'closing' : ''}`}>
              <div className={`toast-icon ${toast.type}`}>
                {toast.type === 'success' ? '' : toast.type === 'error' ? '' : ''}
              </div>
              <div className="toast-content">
                <div className="toast-title">{toast.title}</div>
                <div className="toast-message">{toast.message}</div>
              </div>
              <button className="toast-close" onClick={() => onDismiss(toast.id)}></button>
            </div>
          ))}
        </div>
      );
    };

    // Modern Confirm Dialog Component
    const ModernConfirmDialog = ({ isOpen, onClose, onConfirm, title, message, confirmText, cancelText, type }) => {
      if (!isOpen) return null;

      const iconMap = {
        warning: '',
        danger: '',
        info: ''
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal modern-confirm" onClick={e => e.stopPropagation()}>
            <div className="modern-confirm-body">
              <div className={`modern-confirm-icon ${type || 'warning'}`}>
                {iconMap[type] || iconMap.warning}
              </div>
              <div className="modern-confirm-title">{title}</div>
              <div className="modern-confirm-message">{message}</div>
              <div className="modern-confirm-buttons">
                <button className="modern-btn modern-btn-secondary" onClick={onClose}>
                  {cancelText || 'Cancel'}
                </button>
                <button
                  className={`modern-btn ${type === 'danger' ? 'modern-btn-danger' : 'modern-btn-primary'}`}
                  onClick={() => { onConfirm(); onClose(); }}
                >
                  {confirmText || 'Confirm'}
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // Assessment Setup Modal (Required before starting)
    const AssessmentSetupModal = ({ isOpen, onClose, onStart, existingData, isEditing = false }) => {
      const [formData, setFormData] = useState({
        centerName: '',
        coordinatorName: '',
        coordinatorPhone: '',
        coordinatorEmail: '',
        configuration: 'A1'
      });
      const [errors, setErrors] = useState({});

      const configOptions = [
        { value: 'A1', label: 'Configuration A  Surveyor 1', desc: 'LD, PC, DL, IPC (180 sub-standards)' },
        { value: 'A2', label: 'Configuration A  Surveyor 2', desc: 'LD, PC, MOI, FMS (169 sub-standards)' },
        { value: 'B', label: 'Configuration B  Full Survey', desc: 'All 6 Domains: LD, PC, DL, IPC, MOI, FMS (349 sub-standards)' }
      ];

      useEffect(() => {
        if (existingData) {
          setFormData({...existingData, configuration: existingData.configuration || 'A1'});
        } else {
          setFormData({
            centerName: '',
            coordinatorName: '',
            coordinatorPhone: '',
            coordinatorEmail: '',
            configuration: 'A1'
          });
        }
        setErrors({});
      }, [existingData, isOpen]);

      const validateForm = () => {
        const newErrors = {};
        if (!formData.centerName.trim()) newErrors.centerName = 'Center name is required';
        if (!formData.coordinatorName.trim()) newErrors.coordinatorName = 'Coordinator name is required';
        if (!formData.coordinatorPhone.trim()) {
          newErrors.coordinatorPhone = 'Phone number is required';
        } else if (!/^[\d\s+\-()]+$/.test(formData.coordinatorPhone)) {
          newErrors.coordinatorPhone = 'Invalid phone number format';
        }
        if (!formData.coordinatorEmail.trim()) {
          newErrors.coordinatorEmail = 'Email is required';
        } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.coordinatorEmail)) {
          newErrors.coordinatorEmail = 'Invalid email format';
        }
        setErrors(newErrors);
        return Object.keys(newErrors).length === 0;
      };

      const handleSubmit = (e) => {
        e.preventDefault();
        if (validateForm()) {
          onStart(formData);
        }
      };

      if (!isOpen) return null;

      return (
        <div className="modal-overlay">
          <div className="modal center-form-modal" onClick={e => e.stopPropagation()}>
            <div className="center-form-header">
              <h3 style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                {isEditing ? Icons.edit({size: 20, color: 'var(--accent)'}) : Icons.building({size: 20, color: 'var(--primary)'})}
                {isEditing ? 'Edit Assessment Details' : 'New Assessment'}
              </h3>
              <p>{isEditing ? 'Update the dental center information' : 'Enter the dental center details to begin'}</p>
            </div>
            <form onSubmit={handleSubmit}>
              <div className="center-form-body">
                <div className="form-group">
                  <label className="form-label">
                    Dental Center Name <span className="required">*</span>
                  </label>
                  <input
                    type="text"
                    className={`form-input ${errors.centerName ? 'error' : ''}`}
                    placeholder="Enter dental center name"
                    value={formData.centerName}
                    onChange={e => setFormData({...formData, centerName: e.target.value})}
                  />
                  {errors.centerName && <div className="form-error">{errors.centerName}</div>}
                </div>

                <div className="form-group">
                  <label className="form-label">
                    Coordinator Name <span className="required">*</span>
                  </label>
                  <input
                    type="text"
                    className={`form-input ${errors.coordinatorName ? 'error' : ''}`}
                    placeholder="Enter coordinator's full name"
                    value={formData.coordinatorName}
                    onChange={e => setFormData({...formData, coordinatorName: e.target.value})}
                  />
                  {errors.coordinatorName && <div className="form-error">{errors.coordinatorName}</div>}
                </div>

                <div className="form-group">
                  <label className="form-label">
                    Survey Configuration <span className="required">*</span>
                  </label>
                  <div style={{display: 'flex', flexDirection: 'column', gap: '8px'}}>
                    {configOptions.map(opt => (
                      <label key={opt.value} style={{
                        display: 'flex',
                        alignItems: 'center',
                        padding: '12px 16px',
                        background: formData.configuration === opt.value ? 'rgba(52, 152, 219, 0.1)' : 'var(--bg-secondary)',
                        border: formData.configuration === opt.value ? '2px solid var(--accent)' : '1px solid var(--border)',
                        borderRadius: '8px',
                        cursor: 'pointer',
                        opacity: 1,
                        transition: 'all 0.2s ease'
                      }}>
                        <input
                          type="radio"
                          name="configuration"
                          value={opt.value}
                          checked={formData.configuration === opt.value}
                          onChange={e => setFormData({...formData, configuration: e.target.value})}
                          style={{marginRight: '12px', accentColor: 'var(--accent)'}}
                        />
                        <div>
                          <div style={{fontWeight: 600, color: formData.configuration === opt.value ? 'var(--accent)' : 'var(--text-primary)'}}>{opt.label}</div>
                          <div style={{fontSize: '12px', color: 'var(--text-muted)'}}>{opt.desc}</div>
                        </div>
                      </label>
                    ))}
                  </div>
                </div>

                <div className="form-row">
                  <div className="form-group">
                    <label className="form-label">
                      Phone Number <span className="required">*</span>
                    </label>
                    <div style={{display: 'flex', alignItems: 'center'}}>
                      <span style={{
                        padding: '10px 12px',
                        background: 'var(--bg-hover)',
                        border: '1px solid var(--border)',
                        borderRight: 'none',
                        borderRadius: 'var(--radius-md) 0 0 var(--radius-md)',
                        color: 'var(--text-secondary)',
                        fontSize: '14px',
                        fontWeight: 500
                      }}>+966</span>
                      <input
                        type="tel"
                        className={`form-input ${errors.coordinatorPhone ? 'error' : ''}`}
                        style={{borderRadius: '0 var(--radius-md) var(--radius-md) 0', flex: 1}}
                        placeholder="5XXXXXXXX"
                        value={formData.coordinatorPhone}
                        onChange={e => setFormData({...formData, coordinatorPhone: e.target.value.replace(/\D/g, '').slice(0, 9)})}
                      />
                    </div>
                    {errors.coordinatorPhone && <div className="form-error">{errors.coordinatorPhone}</div>}
                  </div>

                  <div className="form-group">
                    <label className="form-label">
                      Email <span className="required">*</span>
                    </label>
                    <input
                      type="email"
                      className={`form-input ${errors.coordinatorEmail ? 'error' : ''}`}
                      placeholder="email@example.com"
                      value={formData.coordinatorEmail}
                      onChange={e => setFormData({...formData, coordinatorEmail: e.target.value})}
                    />
                    {errors.coordinatorEmail && <div className="form-error">{errors.coordinatorEmail}</div>}
                  </div>
                </div>

                <div className="form-actions">
                  {(existingData || isEditing) && (
                    <button type="button" className="modern-btn modern-btn-secondary" onClick={onClose}>
                      Cancel
                    </button>
                  )}
                  <button type="submit" className="modern-btn modern-btn-success">
                    {isEditing ? 'Save Changes' : existingData ? 'Update & Continue' : 'Start Assessment'}
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      );
    };

    // Add Center Modal
    const CenterModal = ({ isOpen, onClose, onSave, center }) => {
      const [formData, setFormData] = useState({
        name: '', location: '', licenseNumber: '',
        contactPerson: '', phone: '', email: '', hasDentalLab: false
      });

      useEffect(() => {
        if (center) setFormData(center);
        else setFormData({ name: '', location: '', licenseNumber: '',
          contactPerson: '', phone: '', email: '', hasDentalLab: false });
      }, [center, isOpen]);

      if (!isOpen) return null;

      const handleSubmit = (e) => {
        e.preventDefault();
        onSave({ ...formData, id: center?.id || Date.now().toString(), createdAt: center?.createdAt || new Date().toISOString() });
        onClose();
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h3>{center ? 'Edit Center' : 'Add New Center'}</h3>
              <button className="modal-close" onClick={onClose}></button>
            </div>
            <form onSubmit={handleSubmit}>
              <div className="modal-body">
                <div className="form-group">
                  <label className="form-label">Center Name *</label>
                  <input type="text" className="form-input" required
                    value={formData.name}
                    onChange={e => setFormData({...formData, name: e.target.value})} />
                </div>
                <div className="form-row">
                  <div className="form-group">
                    <label className="form-label">Location / City</label>
                    <input type="text" className="form-input"
                      value={formData.location}
                      onChange={e => setFormData({...formData, location: e.target.value})} />
                  </div>
                  <div className="form-group">
                    <label className="form-label">License Number</label>
                    <input type="text" className="form-input"
                      value={formData.licenseNumber}
                      onChange={e => setFormData({...formData, licenseNumber: e.target.value})} />
                  </div>
                </div>
                <div className="form-row">
                  <div className="form-group">
                    <label className="form-label">Contact Person</label>
                    <input type="text" className="form-input"
                      value={formData.contactPerson}
                      onChange={e => setFormData({...formData, contactPerson: e.target.value})} />
                  </div>
                  <div className="form-group">
                    <label className="form-label">Phone</label>
                    <div style={{display: 'flex', alignItems: 'center'}}>
                      <span style={{
                        padding: '10px 12px',
                        background: 'var(--bg-hover)',
                        border: '1px solid var(--border)',
                        borderRight: 'none',
                        borderRadius: 'var(--radius-md) 0 0 var(--radius-md)',
                        color: 'var(--text-secondary)',
                        fontSize: '14px',
                        fontWeight: 500
                      }}>+966</span>
                      <input type="tel" className="form-input"
                        style={{borderRadius: '0 var(--radius-md) var(--radius-md) 0', flex: 1}}
                        placeholder="5XXXXXXXX"
                        value={formData.phone}
                        onChange={e => setFormData({...formData, phone: e.target.value.replace(/\D/g, '').slice(0, 9)})} />
                    </div>
                  </div>
                </div>
                <div className="form-group">
                  <label className="form-label">Email</label>
                  <input type="email" className="form-input"
                    value={formData.email}
                    onChange={e => setFormData({...formData, email: e.target.value})} />
                </div>
                <div className="form-group">
                  <label style={{display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer'}}>
                    <input type="checkbox" checked={formData.hasDentalLab}
                      onChange={e => setFormData({...formData, hasDentalLab: e.target.checked})} />
                    <span>Has Dental Laboratory</span>
                  </label>
                </div>
              </div>
              <div className="modal-footer">
                <button type="button" className="btn btn-outline-dark" onClick={onClose}>Cancel</button>
                <button type="submit" className="btn btn-primary">Save Center</button>
              </div>
            </form>
          </div>
        </div>
      );
    };

    // ============================================
    // PAGES
    // ============================================

    // SCORING PAGE - PRIMARY VIEW
    const ScoringPage = ({ scores, setScores, saving, isFinalized, finalizedData, viewingMode, setViewingMode, onFinalize, onReset, showToast, assessmentDetails, onEditDetails, onNavigateToHistory }) => {
      // Get chapters based on current configuration
      const activeChapters = useMemo(() => {
        const config = assessmentDetails?.configuration || 'A1';
        return getChaptersByConfig(config);
      }, [assessmentDetails?.configuration]);

      const [activeChapter, setActiveChapter] = useState('LD');
      const [activeStandard, setActiveStandard] = useState(null);
      const [activityFilter, setActivityFilter] = useState('ALL');
      const [searchQuery, setSearchQuery] = useState('');
      const [showSummary, setShowSummary] = useState(false);
      const [sidebarOpen, setSidebarOpen] = useState(true);
      const [scoreFilter, setScoreFilter] = useState(null); // null, 'full', 'partial', 'not-met', 'na', 'unscored'
      const [showCompletionModal, setShowCompletionModal] = useState(false);
      const [showConfirmDialog, setShowConfirmDialog] = useState(false);
      const [isSubmitting, setIsSubmitting] = useState(false);
      const [completionShown, setCompletionShown] = useState(false);

      // Expanded domains state for Configuration B sidebar (all expanded by default)
      const [expandedDomains, setExpandedDomains] = useState({
        LD: true, PC: true, DL: true, IPC: true, MOI: true, FMS: true
      });

      const toggleDomainExpanded = (domainId) => {
        setExpandedDomains(prev => ({ ...prev, [domainId]: !prev[domainId] }));
      };

      const expandAllDomains = () => {
        setExpandedDomains({ LD: true, PC: true, DL: true, IPC: true, MOI: true, FMS: true });
      };

      const collapseAllDomains = () => {
        setExpandedDomains({ LD: false, PC: false, DL: false, IPC: false, MOI: false, FMS: false });
      };

      const currentChapter = activeChapters.find(c => c.id === activeChapter);
      const currentStandards = currentChapter?.standards || [];
      const allSubstandards = useMemo(() => getAllSubstandards(currentStandards), [currentStandards]);

      const filteredSubstandards = useMemo(() => {
        let filtered = allSubstandards;
        if (activeStandard) filtered = filtered.filter(s => s.standardId === activeStandard);
        if (activityFilter !== 'ALL') filtered = filtered.filter(s => s.activityType === activityFilter);
        if (searchQuery) {
          const query = searchQuery.toLowerCase();
          filtered = filtered.filter(s => s.code.toLowerCase().includes(query) || s.text.toLowerCase().includes(query));
        }
        // Score status filter
        if (scoreFilter) {
          filtered = filtered.filter(s => {
            const score = scores[s.id];
            if (scoreFilter === 'full') return score?.value === 2;
            if (scoreFilter === 'partial') return score?.value === 1;
            if (scoreFilter === 'not-met') return score?.value === 0;
            if (scoreFilter === 'na') return score?.value === 'NA';
            if (scoreFilter === 'unscored') return score?.value === undefined || score?.value === null;
            return true;
          });
        }
        return filtered;
      }, [allSubstandards, activeStandard, activityFilter, searchQuery, scoreFilter, scores]);

      // Group filtered substandards by mother standard (for "All Standards" view)
      const groupedSubstandards = useMemo(() => {
        return groupSubstandardsByStandard(filteredSubstandards);
      }, [filteredSubstandards]);

      const handleScoreChange = useCallback((substandardId, value, comment, location) => {
        setScores(prev => ({
          ...prev,
          [substandardId]: { value, comment, location, scoredAt: new Date().toISOString() }
        }));
      }, [setScores]);

      const scoreStats = useMemo(() => {
        const total = allSubstandards.length;
        const scored = Object.keys(scores).filter(id =>
          allSubstandards.some(s => s.id === id) && scores[id]?.value !== undefined && scores[id]?.value !== null
        ).length;
        const naCount = Object.entries(scores).filter(([id, s]) =>
          allSubstandards.some(sub => sub.id === id) && s?.value === 'NA'
        ).length;
        const fullyMet = Object.entries(scores).filter(([id, s]) =>
          allSubstandards.some(sub => sub.id === id) && s?.value === 2
        ).length;
        const partialMet = Object.entries(scores).filter(([id, s]) =>
          allSubstandards.some(sub => sub.id === id) && s?.value === 1
        ).length;
        const notMet = Object.entries(scores).filter(([id, s]) =>
          allSubstandards.some(sub => sub.id === id) && s?.value === 0
        ).length;
        const applicableCount = fullyMet + partialMet + notMet;
        const maxPossible = applicableCount * 2;
        const earnedPoints = (fullyMet * 2) + (partialMet * 1);
        const percentage = maxPossible > 0 ? Math.round((earnedPoints / maxPossible) * 100 * 100) / 100 : 0;
        return { total, scored, naCount, fullyMet, partialMet, notMet, percentage, applicableCount };
      }, [scores, allSubstandards]);

      // Calculate overall pending across ALL chapters
      const overallPending = useMemo(() => {
        let totalSubs = 0;
        let scoredSubs = 0;
        activeChapters.forEach(ch => {
          if (!ch.placeholder) {
            const subs = getAllSubstandards(ch.standards);
            totalSubs += subs.length;
            subs.forEach(sub => {
              if (scores[sub.id]?.value !== undefined && scores[sub.id]?.value !== null) {
                scoredSubs++;
              }
            });
          }
        });
        return totalSubs - scoredSubs;
      }, [scores, activeChapters]);

      // Calculate overall stats across ALL chapters
      const overallStats = useMemo(() => {
        let total = 0, scored = 0, fullyMet = 0, partial = 0, notMet = 0, na = 0;
        activeChapters.forEach(ch => {
          if (!ch.placeholder) {
            const subs = getAllSubstandards(ch.standards);
            total += subs.length;
            subs.forEach(sub => {
              const score = scores[sub.id];
              if (score?.value !== undefined && score?.value !== null) {
                scored++;
                if (score.value === 'NA') na++;
                else if (score.value === 2) fullyMet++;
                else if (score.value === 1) partial++;
                else if (score.value === 0) notMet++;
              }
            });
          }
        });
        const applicable = fullyMet + partial + notMet;
        const maxPossible = applicable * 2;
        const earnedPoints = (fullyMet * 2) + (partial * 1);
        const percentage = maxPossible > 0 ? Math.round((earnedPoints / maxPossible) * 100 * 100) / 100 : 0;
        return { total, scored, fullyMet, partial, notMet, na, percentage, applicable };
      }, [scores, activeChapters]);

      // Detect completion and show celebration modal
      useEffect(() => {
        if (overallPending === 0 && overallStats.total > 0 && !completionShown && !isFinalized) {
          setShowCompletionModal(true);
          setCompletionShown(true);
        }
      }, [overallPending, overallStats.total, completionShown, isFinalized]);

      // Handle finalization
      const handleFinalizeClick = () => {
        setShowCompletionModal(false);
        setShowConfirmDialog(true);
      };

      const handleConfirmFinalize = async () => {
        setIsSubmitting(true);
        try {
          const result = await onFinalize(overallStats);
          if (result.success) {
            setShowConfirmDialog(false);
            showToast('success', 'Assessment Submitted!', `Your assessment has been finalized and saved securely. Submission ID: ${result.data.submissionId}`);
          } else {
            showToast('error', 'Submission Failed', result.error || 'An error occurred while finalizing the assessment.');
          }
        } catch (e) {
          showToast('error', 'Error', e.message || 'An unexpected error occurred.');
        }
        setIsSubmitting(false);
      };

      // Get scored count per standard for sidebar
      const getScoredCountForStandard = (stdId) => {
        const stdsubs = allSubstandards.filter(s => s.standardId === stdId);
        return stdsubs.filter(s => scores[s.id]?.value !== undefined && scores[s.id]?.value !== null).length;
      };

      const getScoreColorClass = (p) => p >= 90 ? 'excellent' : p >= 75 ? 'good' : p >= 60 ? 'needs-improvement' : 'critical';

      // Format phone for WhatsApp (remove spaces, dashes, add country code if needed)
      const formatWhatsApp = (phone) => {
        let clean = phone.replace(/[\s\-()]/g, '');
        if (!clean.startsWith('+')) {
          clean = '+966' + clean.replace(/^0/, '');
        }
        return clean;
      };

      // Show success screen if finalized (but NOT when in viewing mode - we want to see the full interface)
      if (isFinalized && finalizedData && !viewingMode) {
        return (
          <div className="page-container" style={{maxWidth: '700px', margin: '0 auto', padding: '60px 24px', textAlign: 'center'}}>
            <div style={{
              background: 'linear-gradient(135deg, var(--success) 0%, #2ecc71 100%)',
              borderRadius: '24px',
              padding: '48px',
              color: 'white',
              marginBottom: '32px',
              boxShadow: '0 20px 40px rgba(39, 174, 96, 0.3)'
            }}>
              <div style={{marginBottom: '20px'}}>{Icons.award({size: 72, color: '#ffd700'})}</div>
              <h1 style={{fontSize: '32px', fontWeight: '700', marginBottom: '12px'}}>Assessment Complete!</h1>
              <p style={{fontSize: '18px', opacity: 0.95, marginBottom: '24px'}}>
                {assessmentDetails?.centerName || 'Your assessment'} has been finalized and securely saved.
              </p>
              <div style={{
                display: 'inline-block',
                background: 'rgba(255,255,255,0.2)',
                padding: '16px 32px',
                borderRadius: '16px',
                fontSize: '48px',
                fontWeight: '700'
              }}>
                {finalizedData.percentage || overallStats.percentage}%
              </div>
              <p style={{fontSize: '14px', opacity: 0.8, marginTop: '12px'}}>Overall Compliance Score</p>
            </div>

            {/* Stats Summary */}
            <div style={{
              display: 'grid',
              gridTemplateColumns: 'repeat(4, 1fr)',
              gap: '16px',
              marginBottom: '32px'
            }}>
              <div style={{background: 'white', padding: '20px', borderRadius: '16px', boxShadow: 'var(--shadow-md)'}}>
                <div style={{fontSize: '28px', fontWeight: '700', color: 'var(--success)'}}>{finalizedData.fullyMet || overallStats.fullyMet}</div>
                <div style={{fontSize: '12px', color: 'var(--text-muted)', marginTop: '4px'}}>Fully Met</div>
              </div>
              <div style={{background: 'white', padding: '20px', borderRadius: '16px', boxShadow: 'var(--shadow-md)'}}>
                <div style={{fontSize: '28px', fontWeight: '700', color: 'var(--warning)'}}>{finalizedData.partialMet || overallStats.partial}</div>
                <div style={{fontSize: '12px', color: 'var(--text-muted)', marginTop: '4px'}}>Partial</div>
              </div>
              <div style={{background: 'white', padding: '20px', borderRadius: '16px', boxShadow: 'var(--shadow-md)'}}>
                <div style={{fontSize: '28px', fontWeight: '700', color: 'var(--danger)'}}>{finalizedData.notMet || overallStats.notMet}</div>
                <div style={{fontSize: '12px', color: 'var(--text-muted)', marginTop: '4px'}}>Not Met</div>
              </div>
              <div style={{background: 'white', padding: '20px', borderRadius: '16px', boxShadow: 'var(--shadow-md)'}}>
                <div style={{fontSize: '28px', fontWeight: '700', color: 'var(--neutral)'}}>{finalizedData.naCount || overallStats.na}</div>
                <div style={{fontSize: '12px', color: 'var(--text-muted)', marginTop: '4px'}}>N/A</div>
              </div>
            </div>

            {/* Submission Info */}
            <div style={{
              background: 'var(--bg-hover)',
              padding: '20px',
              borderRadius: '12px',
              marginBottom: '32px',
              fontSize: '14px',
              color: 'var(--text-secondary)'
            }}>
              <div style={{marginBottom: '8px'}}>
                <strong>Submission ID:</strong>{' '}
                <code style={{background: 'white', padding: '4px 8px', borderRadius: '4px'}}>{finalizedData.submissionId}</code>
              </div>
              <div>
                <strong>Submitted:</strong>{' '}
                {new Date(finalizedData.submittedAt).toLocaleString('en-US', {
                  year: 'numeric', month: 'long', day: 'numeric',
                  hour: '2-digit', minute: '2-digit'
                })}
              </div>
            </div>

            {/* Action Buttons */}
            <div style={{display: 'flex', gap: '16px', justifyContent: 'center'}}>
              <button
                onClick={onNavigateToHistory}
                className="modern-btn modern-btn-primary"
                style={{padding: '16px 32px', fontSize: '16px', display: 'flex', alignItems: 'center', gap: '8px'}}
              >
                {Icons.clipboard({size: 18})} View in History
              </button>
              <button
                onClick={onReset}
                className="modern-btn modern-btn-secondary"
                style={{padding: '16px 32px', fontSize: '16px', display: 'flex', alignItems: 'center', gap: '8px'}}
              >
                {Icons.plus({size: 18})} Start New Assessment
              </button>
            </div>
          </div>
        );
      }

      return (
        <>
          {/* Viewing Mode Banner */}
          {viewingMode && isFinalized && (
            <div style={{
              background: 'linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%)',
              color: 'white',
              padding: '12px 24px',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              boxShadow: '0 2px 8px rgba(0,0,0,0.15)'
            }}>
              <div style={{display: 'flex', alignItems: 'center', gap: '12px'}}>
                {Icons.checkCircle({size: 20, color: '#ffd700'})}
                <span style={{fontWeight: 600}}>Viewing Completed Assessment</span>
                <span style={{opacity: 0.8, fontSize: '14px'}}>({finalizedData?.percentage || 0}% compliance score)</span>
              </div>
              <button
                onClick={() => { setViewingMode(false); setCurrentPage('centers'); }}
                style={{
                  background: 'rgba(255,255,255,0.2)',
                  border: 'none',
                  color: 'white',
                  padding: '8px 16px',
                  borderRadius: '20px',
                  cursor: 'pointer',
                  fontWeight: 600,
                  fontSize: '13px',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '6px'
                }}
              >
                 Back to History
              </button>
            </div>
          )}

          {/* Assessment Info Bar */}
          {assessmentDetails && (
            <div className="assessment-info-bar">
              <div className="assessment-center-name" style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                {Icons.building({size: 20, color: 'var(--primary)'})} {assessmentDetails.centerName}
              </div>
              <div className="assessment-coordinator">
                <span className="coordinator-name" style={{display: 'flex', alignItems: 'center', gap: '4px'}}>
                  {Icons.user({size: 14})} {assessmentDetails.coordinatorName}
                </span>
                <a href={`https://wa.me/${formatWhatsApp(assessmentDetails.coordinatorPhone)}`}
                   target="_blank" rel="noopener noreferrer" className="contact-link whatsapp" style={{display: 'flex', alignItems: 'center', gap: '4px'}}>
                  {Icons.whatsapp({size: 14})} WhatsApp
                </a>
                <a href={`mailto:${assessmentDetails.coordinatorEmail}`} className="contact-link email" style={{display: 'flex', alignItems: 'center', gap: '4px'}}>
                  {Icons.mail({size: 14})} Email
                </a>
                <button onClick={onEditDetails}
                  style={{background: 'none', border: 'none', color: 'var(--text-muted)', cursor: 'pointer', fontSize: '13px', padding: '4px 8px', display: 'flex', alignItems: 'center', gap: '4px'}}>
                  {Icons.edit({size: 14})} Edit
                </button>
              </div>
            </div>
          )}

          <div className="controls-bar">
            <button className="sidebar-toggle" onClick={() => setSidebarOpen(!sidebarOpen)} title={sidebarOpen ? 'Hide sidebar' : 'Show sidebar'}>
              {sidebarOpen ? '' : ''}
            </button>
            {assessmentDetails?.configuration === 'B' ? (
              /* Full Survey Mode - Show domain indicator */
              <div className="control-group" style={{display: 'flex', alignItems: 'center', gap: '12px'}}>
                <div style={{
                  background: 'linear-gradient(135deg, #1e3a5f 0%, #3498db 100%)',
                  color: 'white',
                  padding: '8px 16px',
                  borderRadius: '20px',
                  fontSize: '13px',
                  fontWeight: '600',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px'
                }}>
                  <span style={{fontSize: '16px'}}></span>
                  Full Survey Mode
                  <span style={{background: 'rgba(255,255,255,0.2)', padding: '2px 8px', borderRadius: '10px', fontSize: '11px'}}>
                    6 Domains
                  </span>
                </div>
                <select value={activeChapter} onChange={e => { setActiveChapter(e.target.value); setActiveStandard(null); }}
                  style={{padding: '8px 12px', borderRadius: '8px', border: '1px solid var(--border)', fontSize: '13px'}}>
                  <option value="ALL">All Domains</option>
                  {activeChapters.map(ch => (
                    <option key={ch.id} value={ch.id}>{ch.code} - {ch.name}</option>
                  ))}
                </select>
              </div>
            ) : (
              /* Normal Mode - Show chapter dropdown */
              <div className="control-group">
                <label className="control-label">Chapter:</label>
                <select value={activeChapter} onChange={e => { setActiveChapter(e.target.value); setActiveStandard(null); }}>
                  {activeChapters.map(ch => (
                    <option key={ch.id} value={ch.id} disabled={ch.placeholder}>
                      {ch.name} {ch.placeholder ? '(Coming Soon)' : `(${ch.standards.length > 0 ? getAllSubstandards(ch.standards).length : 0})`}
                    </option>
                  ))}
                </select>
              </div>
            )}
            <div className="control-group">
              <label className="control-label">Activity:</label>
              <select value={activityFilter} onChange={e => setActivityFilter(e.target.value)}>
                <option value="ALL">-All Activities-</option>
                <option value="DOC">Document Review</option>
                <option value="OBS">Observation</option>
                <option value="INT">Interview</option>
                <option value="PER">Personnel File</option>
                <option value="DEN">Dental Record Review</option>
              </select>
            </div>
            <button className="chapters-summary-btn" onClick={() => setShowSummary(true)}>
              CHAPTERS SUMMARY
              <span className="summary-numbers">{scoreStats.fullyMet}/{scoreStats.scored}/{scoreStats.notMet}</span>
            </button>
            {isFinalized ? (
              <div className="finalized-badge">
                <span></span> Finalized
              </div>
            ) : overallPending === 0 && overallStats.total > 0 ? (
              <button className="finalize-btn finalize-btn-small" onClick={handleFinalizeClick}>
                <span></span> Finalize & Submit
              </button>
            ) : null}
          </div>

          <div className="main-container">
            <aside className={`sidebar ${sidebarOpen ? '' : 'collapsed'}`}>
              {assessmentDetails?.configuration === 'B' ? (
                /* Full Survey Mode - Domain-grouped navigation */
                <div className="sidebar-section">
                  <div className="sidebar-title" style={{marginBottom: '12px', display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                    <span style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                       All Domains
                      <span style={{fontSize: '11px', background: 'var(--bg-hover)', padding: '2px 8px', borderRadius: '10px', color: 'var(--text-muted)'}}>
                        {activeChapters.reduce((sum, ch) => sum + getAllSubstandards(ch.standards).length, 0)} total
                      </span>
                    </span>
                    <div style={{display: 'flex', gap: '4px'}}>
                      <button
                        onClick={expandAllDomains}
                        title="Expand All"
                        style={{
                          background: 'var(--bg-hover)', border: 'none', borderRadius: '4px',
                          padding: '4px 8px', cursor: 'pointer', fontSize: '11px', color: 'var(--text-secondary)'
                        }}
                      ></button>
                      <button
                        onClick={collapseAllDomains}
                        title="Collapse All"
                        style={{
                          background: 'var(--bg-hover)', border: 'none', borderRadius: '4px',
                          padding: '4px 8px', cursor: 'pointer', fontSize: '11px', color: 'var(--text-secondary)'
                        }}
                      ></button>
                    </div>
                  </div>
                  {activeChapters.map(chapter => {
                    const chapterSubs = getAllSubstandards(chapter.standards);
                    const chapterScoredCount = chapterSubs.filter(s => scores[s.id]?.value !== undefined && scores[s.id]?.value !== null).length;
                    const isExpanded = expandedDomains[chapter.id] !== false;
                    const domainClass = `domain-${chapter.code.toLowerCase()}`;

                    return (
                      <div key={chapter.id} className="sidebar-domain-group">
                        <div
                          className={`sidebar-domain-header ${activeChapter === chapter.id ? 'active' : ''}`}
                          onClick={() => toggleDomainExpanded(chapter.id)}
                          style={{cursor: 'pointer'}}
                        >
                          <span style={{
                            fontSize: '10px', color: 'var(--text-muted)',
                            transition: 'transform 0.2s ease',
                            transform: isExpanded ? 'rotate(90deg)' : 'rotate(0deg)',
                            display: 'inline-block'
                          }}></span>
                          <div className={`sidebar-domain-badge ${domainClass}`}>{chapter.code}</div>
                          <div className="sidebar-domain-count" style={{marginLeft: 'auto'}}>{chapterScoredCount}/{chapterSubs.length}</div>
                        </div>
                        {isExpanded && (
                          <div className="sidebar-domain-standards">
                            {chapter.standards.map(std => {
                              const scoredCount = getScoredCountForStandard(std.id);
                              const isComplete = scoredCount === std.substandards.length;
                              return (
                                <div key={std.id}
                                  className={`standard-nav-item ${activeStandard === std.id ? 'active' : ''}`}
                                  onClick={(e) => { e.stopPropagation(); setActiveChapter(chapter.id); setActiveStandard(std.id); }}
                                  style={{padding: '6px 10px', fontSize: '12px'}}>
                                  <span className="standard-nav-code">{std.code}</span>
                                  <div className="standard-nav-progress">
                                    {isComplete && <span className="standard-nav-check" style={{fontSize: '10px'}}></span>}
                                    <span className="standard-nav-count" style={{fontSize: '11px'}}>{scoredCount}/{std.substandards.length}</span>
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                        )}
                      </div>
                    );
                  })}
                  {/* Bottom padding for score bar */}
                  <div style={{height: '80px'}}></div>
                </div>
              ) : (
                /* Normal Mode - Standard navigation */
                <div className="sidebar-section">
                  <div className="sidebar-title">Standards Navigation</div>
                  <div className={`standard-nav-item ${!activeStandard ? 'active' : ''}`} onClick={() => setActiveStandard(null)}>
                    <span className="standard-nav-code">All Standards</span>
                    <span className="standard-nav-count">{allSubstandards.length}</span>
                  </div>
                  {currentStandards.map(std => {
                    const scoredCount = getScoredCountForStandard(std.id);
                    const isComplete = scoredCount === std.substandards.length;
                    return (
                      <div key={std.id} className={`standard-nav-item ${activeStandard === std.id ? 'active' : ''}`}
                        onClick={() => setActiveStandard(std.id)}>
                        <span className="standard-nav-code">{std.code}</span>
                        <div className="standard-nav-progress">
                          {isComplete && <span className="standard-nav-check"></span>}
                          <span className="standard-nav-count">{scoredCount}/{std.substandards.length}</span>
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </aside>

            <main className="content-area">
              {/* Header section - different for single standard vs all standards */}
              {activeStandard ? (
                /* Single standard selected - use mother standard styling */
                (() => {
                  const selectedStd = currentStandards.find(s => s.id === activeStandard);
                  return (
                    <div className="mother-standard-section" style={{marginBottom: '24px'}}>
                      <div className="mother-standard-header">
                        <div className="mother-standard-code">{selectedStd?.code}</div>
                        <div className="mother-standard-content">
                          <h3 className="mother-standard-title">{selectedStd?.title}</h3>
                          {selectedStd?.intent && (
                            <p className="mother-standard-intent">{selectedStd.intent}</p>
                          )}
                        </div>
                        <div className="mother-standard-badge">
                          {filteredSubstandards.length} sub-standard(s)
                          {scoreFilter && <span style={{marginLeft: '8px', padding: '2px 8px', borderRadius: '12px', fontSize: '11px', background: scoreFilter === 'full' ? 'var(--success-light)' : scoreFilter === 'partial' ? 'var(--warning-light)' : scoreFilter === 'not-met' ? 'var(--danger-light)' : 'var(--bg-hover)', color: scoreFilter === 'full' ? 'var(--success)' : scoreFilter === 'partial' ? '#b45309' : scoreFilter === 'not-met' ? 'var(--danger)' : 'var(--text-secondary)'}}>
                            {scoreFilter === 'full' ? 'Fully Met' : scoreFilter === 'partial' ? 'Partial' : scoreFilter === 'not-met' ? 'Not Met' : 'N/A'}
                            <span style={{marginLeft: '6px', cursor: 'pointer'}} onClick={() => setScoreFilter(null)}></span>
                          </span>}
                        </div>
                      </div>
                    </div>
                  );
                })()
              ) : assessmentDetails?.configuration === 'B' && activeChapter === 'ALL' ? (
                /* Full Survey Mode - All domains header */
                <div className="content-header" style={{background: 'linear-gradient(135deg, rgba(30, 58, 95, 0.05) 0%, rgba(52, 152, 219, 0.08) 100%)', padding: '24px', borderRadius: '12px', marginBottom: '24px'}}>
                  <div style={{display: 'flex', alignItems: 'center', gap: '16px'}}>
                    <div style={{
                      width: '56px', height: '56px', borderRadius: '14px',
                      background: 'linear-gradient(135deg, #1e3a5f 0%, #3498db 100%)',
                      display: 'flex', alignItems: 'center', justifyContent: 'center',
                      boxShadow: '0 4px 12px rgba(30, 58, 95, 0.3)'
                    }}>
                      <span style={{color: 'white', fontSize: '24px'}}></span>
                    </div>
                    <div>
                      <h2 style={{margin: 0, fontSize: '22px', fontWeight: 700, color: 'var(--primary)'}}>Full Survey Assessment</h2>
                      <p style={{margin: '4px 0 0 0', color: 'var(--text-secondary)', fontSize: '14px'}}>
                        All 6 Domains  {activeChapters.reduce((sum, ch) => sum + getAllSubstandards(ch.standards).length, 0)} Sub-standards
                      </p>
                    </div>
                  </div>
                  <div style={{display: 'flex', gap: '8px', marginTop: '16px', flexWrap: 'wrap'}}>
                    {activeChapters.map(ch => (
                      <a key={ch.id} href={`#domain-${ch.code.toLowerCase()}`}
                        style={{
                          padding: '6px 14px', borderRadius: '20px', fontSize: '12px', fontWeight: 600,
                          background: `linear-gradient(135deg, ${domainColors[ch.code]?.primary || '#1e3a5f'} 0%, ${domainColors[ch.code]?.accent || '#3498db'} 100%)`,
                          color: 'white', textDecoration: 'none', cursor: 'pointer',
                          boxShadow: '0 2px 8px rgba(0,0,0,0.15)', transition: 'transform 0.2s ease'
                        }}
                        onClick={(e) => { e.preventDefault(); document.getElementById(`domain-${ch.code.toLowerCase()}`)?.scrollIntoView({ behavior: 'smooth' }); }}
                      >
                        {ch.code}
                      </a>
                    ))}
                  </div>
                </div>
              ) : (
                /* Standard chapter header */
                <div className="content-header">
                  <h2>{currentChapter?.name}</h2>
                  <p className="substandard-count">
                    {filteredSubstandards.length} sub-standard(s)
                    {scoreFilter && <span style={{marginLeft: '8px', padding: '2px 8px', borderRadius: '12px', fontSize: '11px', background: scoreFilter === 'full' ? 'var(--success-light)' : scoreFilter === 'partial' ? 'var(--warning-light)' : scoreFilter === 'not-met' ? 'var(--danger-light)' : 'var(--bg-hover)', color: scoreFilter === 'full' ? 'var(--success)' : scoreFilter === 'partial' ? '#b45309' : scoreFilter === 'not-met' ? 'var(--danger)' : 'var(--text-secondary)'}}>
                      {scoreFilter === 'full' ? 'Fully Met' : scoreFilter === 'partial' ? 'Partial' : scoreFilter === 'not-met' ? 'Not Met' : 'N/A'}
                      <span style={{marginLeft: '6px', cursor: 'pointer'}} onClick={() => setScoreFilter(null)}></span>
                    </span>}
                  </p>
                </div>
              )}

              {currentChapter?.placeholder ? (
                <div className="empty-state">
                  <div className="empty-state-icon"></div>
                  <h3>{currentChapter.name}</h3>
                  <p>This chapter will be added in a future update.</p>
                </div>
              ) : activeStandard ? (
                /* Single standard selected - show substandards directly */
                <div className="single-standard-substandards">
                  {filteredSubstandards.map(sub => (
                    <SubstandardCard key={sub.id} substandard={sub} score={scores[sub.id]}
                      onScoreChange={handleScoreChange} />
                  ))}
                </div>
              ) : assessmentDetails?.configuration === 'B' && activeChapter === 'ALL' ? (
                /* Full Survey Mode - All domains with beautiful separators */
                <div className="full-survey-view">
                  {activeChapters.map((chapter, chapterIndex) => {
                    const chapterSubs = getAllSubstandards(chapter.standards);
                    const chapterStats = {
                      total: chapterSubs.length,
                      fullyMet: chapterSubs.filter(s => scores[s.id]?.value === 2).length,
                      partial: chapterSubs.filter(s => scores[s.id]?.value === 1).length,
                      notMet: chapterSubs.filter(s => scores[s.id]?.value === 0).length,
                      na: chapterSubs.filter(s => scores[s.id]?.value === 'NA').length,
                      pending: chapterSubs.filter(s => scores[s.id]?.value === undefined || scores[s.id]?.value === null).length
                    };

                    return (
                      <div key={chapter.id} className="domain-section" id={`domain-${chapter.code.toLowerCase()}`}>
                        <DomainSeparator chapter={chapter} stats={chapterStats} />
                        {chapter.standards.map(std => (
                          <div key={std.id} className="mother-standard-section">
                            <div className="mother-standard-header">
                              <div className="mother-standard-code">{std.code}</div>
                              <div className="mother-standard-content">
                                <h3 className="mother-standard-title">{std.title}</h3>
                                {std.intent && (
                                  <p className="mother-standard-intent">{std.intent}</p>
                                )}
                              </div>
                              <div className="mother-standard-badge">{std.substandards.length} sub-standard(s)</div>
                            </div>
                            <div className="mother-standard-substandards">
                              {std.substandards.map(sub => (
                                <SubstandardCard key={sub.id}
                                  substandard={{...sub, standardId: std.id, standardTitle: std.title, standardIntent: std.intent, standardCode: std.code}}
                                  score={scores[sub.id]}
                                  onScoreChange={handleScoreChange} />
                              ))}
                            </div>
                          </div>
                        ))}
                      </div>
                    );
                  })}
                </div>
              ) : (
                /* Standard view - show grouped by mother standard */
                groupedSubstandards.map(group => (
                  <div key={group.standardId} className="mother-standard-section">
                    <div className="mother-standard-header">
                      <div className="mother-standard-code">{group.standardCode}</div>
                      <div className="mother-standard-content">
                        <h3 className="mother-standard-title">{group.standardTitle}</h3>
                        {group.standardIntent && (
                          <p className="mother-standard-intent">{group.standardIntent}</p>
                        )}
                      </div>
                      <div className="mother-standard-badge">{group.substandards.length} sub-standard(s)</div>
                    </div>
                    <div className="mother-standard-substandards">
                      {group.substandards.map(sub => (
                        <SubstandardCard key={sub.id} substandard={sub} score={scores[sub.id]}
                          onScoreChange={handleScoreChange} />
                      ))}
                    </div>
                  </div>
                ))
              )}
            </main>
          </div>

          <div className="score-summary-panel">
            <div className="score-display">
              <div className="score-main">
                <div className={`score-percentage ${getScoreColorClass(scoreStats.percentage)}`}>{scoreStats.percentage}%</div>
                <div className="score-label">Overall Score</div>
              </div>
              <div className="score-breakdown">
                <div className={`breakdown-item ${scoreFilter === 'full' ? 'active filter-full' : ''}`}
                  onClick={() => setScoreFilter(scoreFilter === 'full' ? null : 'full')}
                  title="Click to filter Fully Met">
                  <div className="breakdown-value" style={{color: 'var(--success)'}}>{scoreStats.fullyMet}</div>
                  <div className="breakdown-label">Fully Met</div>
                </div>
                <div className={`breakdown-item ${scoreFilter === 'partial' ? 'active filter-partial' : ''}`}
                  onClick={() => setScoreFilter(scoreFilter === 'partial' ? null : 'partial')}
                  title="Click to filter Partial">
                  <div className="breakdown-value" style={{color: 'var(--warning)'}}>{scoreStats.partialMet}</div>
                  <div className="breakdown-label">Partial</div>
                </div>
                <div className={`breakdown-item ${scoreFilter === 'not-met' ? 'active filter-not-met' : ''}`}
                  onClick={() => setScoreFilter(scoreFilter === 'not-met' ? null : 'not-met')}
                  title="Click to filter Not Met">
                  <div className="breakdown-value" style={{color: 'var(--danger)'}}>{scoreStats.notMet}</div>
                  <div className="breakdown-label">Not Met</div>
                </div>
                <div className={`breakdown-item ${scoreFilter === 'na' ? 'active filter-na' : ''}`}
                  onClick={() => setScoreFilter(scoreFilter === 'na' ? null : 'na')}
                  title="Click to filter N/A">
                  <div className="breakdown-value" style={{color: 'var(--neutral)'}}>{scoreStats.naCount}</div>
                  <div className="breakdown-label">N/A</div>
                </div>
                <div className="breakdown-item not-scored-item"
                  onClick={() => setScoreFilter(scoreFilter === 'unscored' ? null : 'unscored')}
                  title="Overall pending across all chapters">
                  <div className="breakdown-value" style={{color: '#8e44ad'}}>{overallPending}</div>
                  <div className="breakdown-label">Pending</div>
                </div>
              </div>
            </div>
            <div className="progress-bar-container">
              <div className="progress-bar">
                <div className="progress-fill" style={{
                  width: `${(scoreStats.scored / scoreStats.total) * 100}%`,
                  background: 'linear-gradient(90deg, var(--success) 0%, var(--accent) 100%)'
                }} />
              </div>
              <div className="progress-text">{scoreStats.scored} of {scoreStats.total} sub-standards scored</div>
            </div>
            <AutosaveIndicator saving={saving} />
            {/* Finalize Button in Bottom Panel */}
            {isFinalized ? (
              <div className="finalized-badge" style={{marginLeft: '16px'}}>
                <span></span> Finalized
              </div>
            ) : overallPending === 0 && overallStats.total > 0 ? (
              <button className="finalize-btn finalize-btn-small" onClick={handleFinalizeClick} style={{marginLeft: '16px'}}>
                <span></span> Finalize
              </button>
            ) : null}
          </div>

          <ChaptersSummaryModal
            isOpen={showSummary}
            onClose={() => setShowSummary(false)}
            scores={scores}
            chapters={activeChapters}
            onFinalize={handleFinalizeClick}
            isFinalized={isFinalized}
            overallPending={overallPending}
          />

          {/* Completion Celebration Modal */}
          <CompletionModal
            isOpen={showCompletionModal}
            onClose={() => setShowCompletionModal(false)}
            stats={overallStats}
            onFinalize={handleFinalizeClick}
          />

          {/* Finalize Confirmation Dialog */}
          <FinalizeConfirmDialog
            isOpen={showConfirmDialog}
            onClose={() => setShowConfirmDialog(false)}
            onConfirm={handleConfirmFinalize}
            stats={overallStats}
            isSubmitting={isSubmitting}
          />
        </>
      );
    };

    // Dashboard Page
    const DashboardPage = ({ centers, surveys, onEditSurvey, onDeleteSurvey }) => {
      const totalCenters = centers.length;
      const totalSurveys = surveys.length;
      const completedSurveys = surveys.filter(s => s.status === 'completed').length;
      const avgScore = surveys.length > 0
        ? Math.round(surveys.reduce((acc, s) => acc + (s.stats?.percentage || 0), 0) / surveys.length)
        : 0;

      const recentSurveys = [...surveys].sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 10);

      // Format phone for WhatsApp
      const formatWhatsApp = (phone) => {
        if (!phone) return '';
        let clean = phone.replace(/[\s\-()]/g, '');
        if (!clean.startsWith('+')) {
          clean = '+966' + clean.replace(/^0/, '');
        }
        return clean;
      };

      const [expandedSurvey, setExpandedSurvey] = useState(null);

      return (
        <div className="page-container" style={{maxWidth: '1400px'}}>
          {/* Dashboard Header */}
          <div style={{marginBottom: '32px'}}>
            <h1 style={{fontSize: '28px', fontWeight: 700, color: 'var(--text-primary)', marginBottom: '8px'}}>
              Dashboard
            </h1>
            <p style={{color: 'var(--text-muted)', fontSize: '15px'}}>
              Overview of your dental center accreditation assessments
            </p>
          </div>

          {/* Stats Grid - Redesigned */}
          <div style={{
            display: 'grid',
            gridTemplateColumns: 'repeat(4, 1fr)',
            gap: '24px',
            marginBottom: '40px'
          }}>
            {/* Stat Card 1 - Dental Centers */}
            <div style={{
              background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
              borderRadius: '16px',
              padding: '24px',
              color: 'white',
              position: 'relative',
              overflow: 'hidden',
              boxShadow: '0 10px 30px rgba(102, 126, 234, 0.3)'
            }}>
              <div style={{position: 'absolute', right: '-10px', top: '-10px', opacity: 0.15}}>
                {Icons.building({size: 100, color: 'white'})}
              </div>
              <div style={{position: 'relative', zIndex: 1}}>
                <div style={{fontSize: '12px', textTransform: 'uppercase', letterSpacing: '1px', opacity: 0.9, marginBottom: '8px'}}>
                  Dental Centers
                </div>
                <div style={{fontSize: '42px', fontWeight: 700, lineHeight: 1}}>{totalCenters}</div>
                <div style={{fontSize: '13px', opacity: 0.8, marginTop: '8px'}}>Registered locations</div>
              </div>
            </div>

            {/* Stat Card 2 - Total Surveys */}
            <div style={{
              background: 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)',
              borderRadius: '16px',
              padding: '24px',
              color: 'white',
              position: 'relative',
              overflow: 'hidden',
              boxShadow: '0 10px 30px rgba(17, 153, 142, 0.3)'
            }}>
              <div style={{position: 'absolute', right: '-10px', top: '-10px', opacity: 0.15}}>
                {Icons.clipboard({size: 100, color: 'white'})}
              </div>
              <div style={{position: 'relative', zIndex: 1}}>
                <div style={{fontSize: '12px', textTransform: 'uppercase', letterSpacing: '1px', opacity: 0.9, marginBottom: '8px'}}>
                  Total Assessments
                </div>
                <div style={{fontSize: '42px', fontWeight: 700, lineHeight: 1}}>{totalSurveys}</div>
                <div style={{fontSize: '13px', opacity: 0.8, marginTop: '8px'}}>All time surveys</div>
              </div>
            </div>

            {/* Stat Card 3 - Completed */}
            <div style={{
              background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
              borderRadius: '16px',
              padding: '24px',
              color: 'white',
              position: 'relative',
              overflow: 'hidden',
              boxShadow: '0 10px 30px rgba(245, 87, 108, 0.3)'
            }}>
              <div style={{position: 'absolute', right: '-10px', top: '-10px', opacity: 0.15}}>
                {Icons.checkCircle({size: 100, color: 'white'})}
              </div>
              <div style={{position: 'relative', zIndex: 1}}>
                <div style={{fontSize: '12px', textTransform: 'uppercase', letterSpacing: '1px', opacity: 0.9, marginBottom: '8px'}}>
                  Completed
                </div>
                <div style={{fontSize: '42px', fontWeight: 700, lineHeight: 1}}>{completedSurveys}</div>
                <div style={{fontSize: '13px', opacity: 0.8, marginTop: '8px'}}>Finalized assessments</div>
              </div>
            </div>

            {/* Stat Card 4 - Avg Score */}
            <div style={{
              background: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
              borderRadius: '16px',
              padding: '24px',
              color: 'white',
              position: 'relative',
              overflow: 'hidden',
              boxShadow: '0 10px 30px rgba(250, 112, 154, 0.3)'
            }}>
              <div style={{position: 'absolute', right: '-10px', top: '-10px', opacity: 0.15}}>
                {Icons.award({size: 100, color: 'white'})}
              </div>
              <div style={{position: 'relative', zIndex: 1}}>
                <div style={{fontSize: '12px', textTransform: 'uppercase', letterSpacing: '1px', opacity: 0.9, marginBottom: '8px'}}>
                  Average Score
                </div>
                <div style={{fontSize: '42px', fontWeight: 700, lineHeight: 1}}>{avgScore}%</div>
                <div style={{fontSize: '13px', opacity: 0.8, marginTop: '8px'}}>Compliance rate</div>
              </div>
            </div>
          </div>

          {/* Recent Assessments Section */}
          <div style={{
            background: 'white',
            borderRadius: '20px',
            boxShadow: '0 4px 20px rgba(0, 0, 0, 0.08)',
            overflow: 'hidden'
          }}>
            {/* Section Header */}
            <div style={{
              padding: '24px 28px',
              borderBottom: '1px solid var(--border)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'space-between'
            }}>
              <div>
                <h2 style={{fontSize: '20px', fontWeight: 600, color: 'var(--text-primary)', margin: 0}}>
                  Recent Assessments
                </h2>
                <p style={{fontSize: '14px', color: 'var(--text-muted)', margin: '4px 0 0'}}>
                  Click to expand and view details
                </p>
              </div>
              <div style={{
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                color: 'white',
                padding: '10px 20px',
                borderRadius: '25px',
                fontSize: '14px',
                fontWeight: 600,
                boxShadow: '0 4px 12px rgba(102, 126, 234, 0.3)'
              }}>
                {recentSurveys.length} assessment{recentSurveys.length !== 1 ? 's' : ''}
              </div>
            </div>

            {/* Assessments List */}
            <div style={{padding: '16px'}}>
              {recentSurveys.length === 0 ? (
                <div style={{padding: '60px 24px', textAlign: 'center'}}>
                  <div style={{
                    width: '80px', height: '80px', borderRadius: '50%',
                    background: 'var(--bg-hover)', margin: '0 auto 20px',
                    display: 'flex', alignItems: 'center', justifyContent: 'center'
                  }}>
                    {Icons.barChart({size: 36, color: 'var(--text-muted)'})}
                  </div>
                  <h3 style={{color: 'var(--text-primary)', marginBottom: '8px'}}>No assessments yet</h3>
                  <p style={{color: 'var(--text-muted)', maxWidth: '300px', margin: '0 auto'}}>
                    Start a new assessment on the Scoring page. Completed assessments will appear here.
                  </p>
                </div>
              ) : (
                <div style={{display: 'flex', flexDirection: 'column', gap: '12px'}}>
                  {recentSurveys.map(survey => {
                    const details = survey.assessmentDetails;
                    const isExpanded = expandedSurvey === survey.id;
                    const scoreColor = (survey.stats?.percentage || 0) >= 75 ? 'var(--success)' :
                                       (survey.stats?.percentage || 0) >= 60 ? 'var(--warning)' : 'var(--danger)';
                    return (
                      <div key={survey.id} style={{
                        background: isExpanded ? 'var(--bg-hover)' : 'var(--bg-main)',
                        border: '1px solid',
                        borderColor: isExpanded ? 'var(--primary-light)' : 'var(--border)',
                        borderRadius: '14px',
                        overflow: 'hidden',
                        transition: 'all 0.2s ease'
                      }}>
                        {/* Survey Row */}
                        <div
                          onClick={() => setExpandedSurvey(isExpanded ? null : survey.id)}
                          style={{
                            padding: '20px 24px',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '24px',
                            cursor: 'pointer'
                          }}
                        >
                          {/* Icon */}
                          <div style={{
                            width: '56px', height: '56px', borderRadius: '14px',
                            background: 'linear-gradient(135deg, var(--primary) 0%, #1a3a5c 100%)',
                            display: 'flex', alignItems: 'center', justifyContent: 'center',
                            flexShrink: 0,
                            boxShadow: '0 6px 16px rgba(52, 73, 94, 0.25)'
                          }}>
                            {Icons.building({size: 26, color: 'white'})}
                          </div>

                          {/* Center Name & Date - Grouped */}
                          <div style={{minWidth: '280px', borderRight: '1px solid var(--border)', paddingRight: '24px'}}>
                            <div style={{fontWeight: 600, fontSize: '17px', color: 'var(--text-primary)', marginBottom: '6px'}}>
                              {details?.centerName || survey.centerName || 'Unknown Center'}
                            </div>
                            <div style={{display: 'flex', alignItems: 'center', gap: '12px'}}>
                              <div style={{display: 'flex', alignItems: 'center', gap: '6px', color: 'var(--text-secondary)', fontSize: '14px'}}>
                                {Icons.calendar({size: 14, color: 'var(--text-muted)'})}
                                <span style={{fontWeight: 500}}>{new Date(survey.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>
                              </div>
                              <div style={{width: '4px', height: '4px', borderRadius: '50%', background: 'var(--text-muted)'}}></div>
                              <span style={{color: 'var(--text-muted)', fontSize: '14px'}}>
                                {new Date(survey.createdAt).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}
                              </span>
                            </div>
                          </div>

                          {/* Configuration - With Label */}
                          <div style={{minWidth: '160px', borderRight: '1px solid var(--border)', paddingRight: '24px'}}>
                            <div style={{fontSize: '11px', color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '4px'}}>
                              Survey Type
                            </div>
                            <div style={{
                              padding: '5px 12px',
                              background: 'linear-gradient(135deg, var(--primary) 0%, #2c5282 100%)',
                              color: 'white',
                              borderRadius: '6px',
                              fontSize: '12px',
                              fontWeight: 600,
                              display: 'inline-block'
                            }}>
                              {survey.configuration || 'Config A  Surveyor 1'}
                            </div>
                          </div>

                          {/* Score - Prominent */}
                          <div style={{minWidth: '100px', textAlign: 'center', borderRight: '1px solid var(--border)', paddingRight: '24px'}}>
                            <div style={{fontSize: '11px', color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '4px'}}>
                              Score
                            </div>
                            <div style={{fontSize: '32px', fontWeight: 700, color: scoreColor, lineHeight: 1}}>
                              {survey.stats?.percentage || 0}%
                            </div>
                          </div>

                          {/* Status Badge */}
                          <div style={{minWidth: '110px'}}>
                            <div style={{fontSize: '11px', color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '4px'}}>
                              Status
                            </div>
                            <div style={{
                              background: survey.status === 'completed' ? 'rgba(39, 174, 96, 0.12)' : 'rgba(241, 196, 15, 0.12)',
                              color: survey.status === 'completed' ? 'var(--success)' : 'var(--warning)',
                              padding: '6px 12px',
                              borderRadius: '6px',
                              fontSize: '13px',
                              fontWeight: 600,
                              display: 'inline-flex',
                              alignItems: 'center',
                              gap: '5px'
                            }}>
                              {survey.status === 'completed' ? Icons.checkCircle({size: 13, color: 'var(--success)'}) : null}
                              {survey.status === 'completed' ? 'Finalized' : 'In Progress'}
                            </div>
                          </div>

                          {/* Spacer */}
                          <div style={{flex: 1}}></div>

                          {/* Action Buttons */}
                          <div style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                            {/* Edit Button */}
                            <button
                              onClick={(e) => { e.stopPropagation(); onEditSurvey && onEditSurvey(survey); }}
                              title="Edit Details"
                              style={{
                                width: '38px', height: '38px', borderRadius: '10px',
                                border: '1px solid var(--border)', background: 'white',
                                color: 'var(--text-muted)', cursor: 'pointer',
                                display: 'flex', alignItems: 'center', justifyContent: 'center',
                                transition: 'all 0.2s ease'
                              }}
                              onMouseOver={(e) => { e.currentTarget.style.background = 'var(--primary)'; e.currentTarget.style.color = 'white'; e.currentTarget.style.borderColor = 'var(--primary)'; }}
                              onMouseOut={(e) => { e.currentTarget.style.background = 'white'; e.currentTarget.style.color = 'var(--text-muted)'; e.currentTarget.style.borderColor = 'var(--border)'; }}
                            >
                              {Icons.edit({size: 16})}
                            </button>

                            {/* Delete Button */}
                            <button
                              onClick={(e) => { e.stopPropagation(); onDeleteSurvey && onDeleteSurvey(survey); }}
                              title="Delete Assessment"
                              style={{
                                width: '38px', height: '38px', borderRadius: '10px',
                                border: '1px solid rgba(231, 76, 60, 0.3)', background: 'rgba(231, 76, 60, 0.05)',
                                color: 'var(--danger)', cursor: 'pointer',
                                display: 'flex', alignItems: 'center', justifyContent: 'center',
                                transition: 'all 0.2s ease'
                              }}
                              onMouseOver={(e) => { e.currentTarget.style.background = 'var(--danger)'; e.currentTarget.style.color = 'white'; e.currentTarget.style.borderColor = 'var(--danger)'; }}
                              onMouseOut={(e) => { e.currentTarget.style.background = 'rgba(231, 76, 60, 0.05)'; e.currentTarget.style.color = 'var(--danger)'; e.currentTarget.style.borderColor = 'rgba(231, 76, 60, 0.3)'; }}
                            >
                              {Icons.trash({size: 16})}
                            </button>

                            {/* Expand Arrow */}
                            <div style={{
                              width: '38px', height: '38px', borderRadius: '10px',
                              background: isExpanded ? 'var(--primary)' : 'var(--bg-hover)',
                              display: 'flex', alignItems: 'center', justifyContent: 'center',
                              transition: 'all 0.2s ease',
                              marginLeft: '4px'
                            }}>
                              <span style={{
                                color: isExpanded ? 'white' : 'var(--text-muted)',
                                fontSize: '12px',
                                transform: isExpanded ? 'rotate(180deg)' : 'rotate(0)',
                                transition: 'transform 0.2s'
                              }}></span>
                            </div>
                          </div>
                        </div>

                        {/* Expanded Details */}
                        {isExpanded && (
                          <div style={{borderTop: '1px solid var(--border)', padding: '24px', background: 'var(--bg-main)'}}>
                            {/* Coordinator Info */}
                            {details && (
                              <div style={{marginBottom: '24px'}}>
                                <div style={{fontSize: '12px', fontWeight: 600, color: 'var(--text-muted)', textTransform: 'uppercase', marginBottom: '12px'}}>
                                  Coordinator Contact
                                </div>
                                <div style={{display: 'flex', gap: '24px', alignItems: 'center', flexWrap: 'wrap'}}>
                                  <div style={{fontWeight: 500}}>{details.coordinatorName}</div>
                                  {details.coordinatorPhone && (
                                    <a href={`https://wa.me/${formatWhatsApp(details.coordinatorPhone)}`}
                                       target="_blank" rel="noopener noreferrer"
                                       className="contact-link whatsapp"
                                       style={{display: 'inline-flex', alignItems: 'center', gap: '6px'}}>
                                      {Icons.whatsapp({size: 16})} {details.coordinatorPhone}
                                    </a>
                                  )}
                                  {details.coordinatorEmail && (
                                    <a href={`mailto:${details.coordinatorEmail}`}
                                       className="contact-link email"
                                       style={{display: 'inline-flex', alignItems: 'center', gap: '6px'}}>
                                      {Icons.mail({size: 16, color: 'var(--accent)'})} {details.coordinatorEmail}
                                    </a>
                                  )}
                                </div>
                              </div>
                            )}

                            {/* Score Breakdown */}
                            <div style={{fontSize: '12px', fontWeight: 600, color: 'var(--text-muted)', textTransform: 'uppercase', marginBottom: '12px'}}>
                              Score Breakdown
                            </div>
                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '12px'}}>
                              <div style={{background: 'white', padding: '14px', borderRadius: '8px', textAlign: 'center', border: '1px solid var(--border)'}}>
                                <div style={{fontSize: '20px', fontWeight: 600, color: 'var(--text-primary)'}}>{survey.stats?.scored || 0}</div>
                                <div style={{fontSize: '11px', color: 'var(--text-muted)', marginTop: '4px'}}>Total Scored</div>
                              </div>
                              <div style={{background: 'rgba(46, 204, 113, 0.1)', padding: '14px', borderRadius: '8px', textAlign: 'center'}}>
                                <div style={{fontSize: '20px', fontWeight: 600, color: 'var(--success)'}}>{survey.stats?.fullyMet || 0}</div>
                                <div style={{fontSize: '11px', color: 'var(--success)', marginTop: '4px'}}>Fully Met</div>
                              </div>
                              <div style={{background: 'rgba(241, 196, 15, 0.1)', padding: '14px', borderRadius: '8px', textAlign: 'center'}}>
                                <div style={{fontSize: '20px', fontWeight: 600, color: 'var(--warning)'}}>{survey.stats?.partial || 0}</div>
                                <div style={{fontSize: '11px', color: 'var(--warning)', marginTop: '4px'}}>Partial</div>
                              </div>
                              <div style={{background: 'rgba(231, 76, 60, 0.1)', padding: '14px', borderRadius: '8px', textAlign: 'center'}}>
                                <div style={{fontSize: '20px', fontWeight: 600, color: 'var(--danger)'}}>{survey.stats?.notMet || 0}</div>
                                <div style={{fontSize: '11px', color: 'var(--danger)', marginTop: '4px'}}>Not Met</div>
                              </div>
                              <div style={{background: 'rgba(149, 165, 166, 0.1)', padding: '14px', borderRadius: '8px', textAlign: 'center'}}>
                                <div style={{fontSize: '20px', fontWeight: 600, color: 'var(--neutral)'}}>{survey.stats?.na || 0}</div>
                                <div style={{fontSize: '11px', color: 'var(--neutral)', marginTop: '4px'}}>N/A</div>
                              </div>
                            </div>

                            {/* Submission ID */}
                            <div style={{marginTop: '20px', fontSize: '12px', color: 'var(--text-muted)'}}>
                              Submission ID: <code style={{background: 'var(--bg-hover)', padding: '2px 8px', borderRadius: '4px'}}>{survey.id}</code>
                            </div>
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    // Executive Summary Modal for Completed Assessments
    const ExecutiveSummaryModal = ({ survey, onClose, chapters, onViewFullDetails }) => {
      const [expandedChapters, setExpandedChapters] = useState({});

      if (!survey) return null;

      const details = survey.assessmentDetails || {};
      const stats = survey.stats || {};
      const scores = survey.scores || {};

      const toggleChapter = (chapterId) => {
        setExpandedChapters(prev => ({...prev, [chapterId]: !prev[chapterId]}));
      };

      // Calculate chapter-by-chapter breakdown
      const getChapterBreakdown = () => {
        if (!chapters || !Array.isArray(chapters)) return [];
        return chapters.filter(ch => !ch.placeholder).map(chapter => {
          const substandardsList = [];
          (chapter.standards || []).forEach(std => {
            (std.substandards || []).forEach(sub => {
              const score = scores[sub.id];
              substandardsList.push({
                id: sub.id,
                text: sub.text,
                score: score?.value !== undefined ? score.value : null,
                findings: score?.findings || '',
                recommendations: score?.recommendations || ''
              });
            });
          });

          const scored = substandardsList.filter(s => s.score !== null);
          const fullyMet = scored.filter(s => s.score === 2).length;
          const partial = scored.filter(s => s.score === 1).length;
          const notMet = scored.filter(s => s.score === 0).length;
          const na = scored.filter(s => s.score === -1).length;
          const totalApplicable = fullyMet + partial + notMet;
          const maxScore = totalApplicable * 2;
          const actualScore = (fullyMet * 2) + (partial * 1);
          const percentage = maxScore > 0 ? Math.round((actualScore / maxScore) * 100) : 0;

          // Get findings (Not Met and Partial items)
          const findings = substandardsList.filter(s => s.score === 0 || s.score === 1);

          return {
            id: chapter.id,
            name: chapter.name,
            fullyMet,
            partial,
            notMet,
            na,
            percentage,
            total: substandardsList.length,
            substandards: substandardsList,
            findings
          };
        });
      };

      const chapterData = getChapterBreakdown();
      const totalFindings = chapterData.reduce((sum, ch) => sum + ch.findings.length, 0);

      // Generate Action Plan with AI-suggested corrective actions
      const generateActionPlan = () => {
        const actions = [];
        chapterData.forEach(ch => {
          ch.findings.forEach(f => {
            // Generate suggested action based on the standard
            let suggestedAction = f.recommendations || '';
            if (!suggestedAction) {
              // AI-suggested default actions based on score
              if (f.score === 0) {
                suggestedAction = `Immediate action required: Develop and implement a comprehensive policy/procedure to address ${f.id}. Assign responsible person, set target date within 30 days, and establish monitoring mechanism.`;
              } else {
                suggestedAction = `Enhancement needed: Review current practices for ${f.id} and identify gaps. Update documentation, provide staff training, and ensure consistent implementation.`;
              }
            }
            actions.push({
              ...f,
              chapter: ch.name,
              priority: f.score === 0 ? 'High' : 'Medium',
              priorityColor: f.score === 0 ? 'var(--danger)' : 'var(--warning)',
              suggestedAction,
              targetDays: f.score === 0 ? 30 : 60
            });
          });
        });
        return actions.sort((a, b) => a.score - b.score);
      };

      const actionPlanItems = generateActionPlan();

      const getScoreLabel = (score) => {
        switch(score) {
          case 2: return { text: 'Fully Met', color: 'var(--success)', bg: 'rgba(46, 204, 113, 0.1)' };
          case 1: return { text: 'Partial', color: 'var(--warning)', bg: 'rgba(241, 196, 15, 0.1)' };
          case 0: return { text: 'Not Met', color: 'var(--danger)', bg: 'rgba(231, 76, 60, 0.1)' };
          case -1: return { text: 'N/A', color: 'var(--text-muted)', bg: 'rgba(128, 128, 128, 0.1)' };
          default: return { text: 'Not Scored', color: 'var(--text-muted)', bg: 'var(--bg-hover)' };
        }
      };

      // Get compliance level
      const getComplianceLevel = (pct) => {
        if (pct >= 90) return { label: 'Excellent', color: '#27ae60', bg: 'rgba(39, 174, 96, 0.1)' };
        if (pct >= 75) return { label: 'Good', color: '#2ecc71', bg: 'rgba(46, 204, 113, 0.1)' };
        if (pct >= 60) return { label: 'Acceptable', color: '#f39c12', bg: 'rgba(243, 156, 18, 0.1)' };
        if (pct >= 40) return { label: 'Needs Improvement', color: '#e67e22', bg: 'rgba(230, 126, 34, 0.1)' };
        return { label: 'Critical', color: '#e74c3c', bg: 'rgba(231, 76, 60, 0.1)' };
      };

      const compliance = getComplianceLevel(stats.percentage || 0);

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={e => e.stopPropagation()} style={{
            maxWidth: '900px',
            maxHeight: '90vh',
            overflow: 'hidden',
            display: 'flex',
            flexDirection: 'column'
          }}>
            {/* Header */}
            <div className="modal-header" style={{
              background: 'linear-gradient(135deg, var(--primary) 0%, #1a252f 100%)',
              color: 'white',
              padding: '24px',
              flexShrink: 0
            }}>
              <div style={{display: 'flex', alignItems: 'center', gap: '16px'}}>
                {Icons.award({size: 32, color: '#ffd700'})}
                <div>
                  <h3 style={{margin: 0, fontSize: '20px'}}>Executive Summary</h3>
                  <p style={{margin: '4px 0 0', opacity: 0.8, fontSize: '14px'}}>
                    {details.centerName || 'Assessment Report'}
                  </p>
                </div>
              </div>
              <button className="modal-close" onClick={onClose} style={{
                background: 'rgba(255,255,255,0.2)',
                color: 'white',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center'
              }}>{Icons.x({size: 18, color: 'white'})}</button>
            </div>

            {/* Scrollable Content */}
            <div style={{flex: 1, overflow: 'auto', padding: '24px'}}>
              {/* Overall Score Card */}
                  <div style={{
                    background: compliance.bg,
                    borderRadius: '16px',
                    padding: '24px',
                    marginBottom: '24px',
                    border: `2px solid ${compliance.color}`,
                    display: 'grid',
                    gridTemplateColumns: '1fr auto',
                    gap: '24px',
                    alignItems: 'center'
                  }}>
                    <div>
                      <div style={{fontSize: '14px', color: 'var(--text-secondary)', marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '1px'}}>
                        Overall Compliance Score
                      </div>
                      <div style={{fontSize: '48px', fontWeight: 700, color: compliance.color, lineHeight: 1}}>
                        {stats.percentage || 0}%
                      </div>
                      <div style={{
                        display: 'inline-block',
                        marginTop: '12px',
                        padding: '6px 16px',
                        background: compliance.color,
                        color: 'white',
                        borderRadius: '20px',
                        fontSize: '13px',
                        fontWeight: 600
                      }}>
                        {compliance.label}
                      </div>
                    </div>
                    <div style={{textAlign: 'right'}}>
                      <div style={{display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '16px'}}>
                        <div style={{textAlign: 'center', padding: '12px 20px', background: 'white', borderRadius: '12px'}}>
                          <div style={{fontSize: '24px', fontWeight: 700, color: 'var(--success)'}}>{stats.fullyMet || 0}</div>
                          <div style={{fontSize: '11px', color: 'var(--text-muted)', textTransform: 'uppercase'}}>Fully Met</div>
                        </div>
                        <div style={{textAlign: 'center', padding: '12px 20px', background: 'white', borderRadius: '12px'}}>
                          <div style={{fontSize: '24px', fontWeight: 700, color: 'var(--warning)'}}>{stats.partial || 0}</div>
                          <div style={{fontSize: '11px', color: 'var(--text-muted)', textTransform: 'uppercase'}}>Partial</div>
                        </div>
                        <div style={{textAlign: 'center', padding: '12px 20px', background: 'white', borderRadius: '12px'}}>
                          <div style={{fontSize: '24px', fontWeight: 700, color: 'var(--danger)'}}>{stats.notMet || 0}</div>
                          <div style={{fontSize: '11px', color: 'var(--text-muted)', textTransform: 'uppercase'}}>Not Met</div>
                        </div>
                        <div style={{textAlign: 'center', padding: '12px 20px', background: 'white', borderRadius: '12px'}}>
                          <div style={{fontSize: '24px', fontWeight: 700, color: 'var(--text-muted)'}}>{stats.na || 0}</div>
                          <div style={{fontSize: '11px', color: 'var(--text-muted)', textTransform: 'uppercase'}}>N/A</div>
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Assessment Details */}
                  <div style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
                    gap: '16px',
                    marginBottom: '24px'
                  }}>
                    <div style={{padding: '16px', background: 'var(--bg-secondary)', borderRadius: '12px'}}>
                      <div style={{fontSize: '12px', color: 'var(--text-muted)', marginBottom: '4px'}}>Configuration</div>
                      <div style={{fontWeight: 600, color: 'var(--primary)'}}>{survey.configuration || 'Configuration A  Surveyor 1'}</div>
                    </div>
                    <div style={{padding: '16px', background: 'var(--bg-secondary)', borderRadius: '12px'}}>
                      <div style={{fontSize: '12px', color: 'var(--text-muted)', marginBottom: '4px'}}>Coordinator</div>
                      <div style={{fontWeight: 600}}>{details.coordinatorName || 'N/A'}</div>
                    </div>
                    <div style={{padding: '16px', background: 'var(--bg-secondary)', borderRadius: '12px'}}>
                      <div style={{fontSize: '12px', color: 'var(--text-muted)', marginBottom: '4px'}}>Completed Date</div>
                      <div style={{fontWeight: 600}}>{survey.completedAt ? new Date(survey.completedAt).toLocaleDateString('en-US', {year: 'numeric', month: 'long', day: 'numeric'}) : 'N/A'}</div>
                    </div>
                    <div style={{padding: '16px', background: 'var(--bg-secondary)', borderRadius: '12px'}}>
                      <div style={{fontSize: '12px', color: 'var(--text-muted)', marginBottom: '4px'}}>Total Findings</div>
                      <div style={{fontWeight: 600, color: totalFindings > 0 ? 'var(--warning)' : 'var(--success)'}}>{totalFindings} items need attention</div>
                    </div>
                  </div>

                  {/* Chapter Performance Summary */}
                  <div>
                    <h4 style={{marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px'}}>
                      {Icons.barChart({size: 20})} Chapter Performance
                    </h4>
                    <div style={{display: 'flex', flexDirection: 'column', gap: '12px'}}>
                      {chapterData.map(chapter => (
                        <div key={chapter.id} style={{
                          background: 'var(--bg-secondary)',
                          borderRadius: '12px',
                          padding: '16px',
                          border: '1px solid var(--border)'
                        }}>
                          <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px'}}>
                            <div style={{fontWeight: 600}}>{chapter.name}</div>
                            <div style={{
                              fontSize: '18px',
                              fontWeight: 700,
                              color: chapter.percentage >= 75 ? 'var(--success)' :
                                     chapter.percentage >= 60 ? 'var(--warning)' : 'var(--danger)'
                            }}>
                              {chapter.percentage}%
                            </div>
                          </div>
                          <div style={{
                            height: '8px',
                            background: 'var(--bg-hover)',
                            borderRadius: '4px',
                            overflow: 'hidden',
                            marginBottom: '12px'
                          }}>
                            <div style={{
                              height: '100%',
                              width: `${chapter.percentage}%`,
                              background: chapter.percentage >= 75 ? 'var(--success)' :
                                          chapter.percentage >= 60 ? 'var(--warning)' : 'var(--danger)',
                              borderRadius: '4px',
                              transition: 'width 0.5s ease'
                            }} />
                          </div>
                          <div style={{display: 'flex', gap: '16px', fontSize: '12px'}}>
                            <span style={{color: 'var(--success)'}}> {chapter.fullyMet} Fully Met</span>
                            <span style={{color: 'var(--warning)'}}> {chapter.partial} Partial</span>
                            <span style={{color: 'var(--danger)'}}> {chapter.notMet} Not Met</span>
                            {chapter.na > 0 && <span style={{color: 'var(--text-muted)'}}> {chapter.na} N/A</span>}
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
              {/* Expandable Chapter Details */}
              <div style={{marginBottom: '24px'}}>
                <h4 style={{marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px'}}>
                  {Icons.clipboard({size: 20})} Detailed Scoring
                </h4>
                <p style={{color: 'var(--text-secondary)', marginBottom: '16px', fontSize: '14px'}}>
                  Click on any chapter to expand and view all substandards with scores and findings.
                </p>
                {chapterData.map(chapter => (
                    <div key={chapter.id} style={{
                      marginBottom: '16px',
                      border: '1px solid var(--border)',
                      borderRadius: '12px',
                      overflow: 'hidden'
                    }}>
                      {/* Chapter Header - Clickable */}
                      <div
                        onClick={() => toggleChapter(chapter.id)}
                        style={{
                          padding: '16px 20px',
                          background: expandedChapters[chapter.id] ? 'var(--primary)' : 'var(--bg-secondary)',
                          color: expandedChapters[chapter.id] ? 'white' : 'var(--text-primary)',
                          cursor: 'pointer',
                          display: 'flex',
                          justifyContent: 'space-between',
                          alignItems: 'center',
                          transition: 'all 0.2s ease'
                        }}
                      >
                        <div style={{display: 'flex', alignItems: 'center', gap: '12px'}}>
                          <span style={{
                            transform: expandedChapters[chapter.id] ? 'rotate(90deg)' : 'rotate(0deg)',
                            transition: 'transform 0.2s ease',
                            fontSize: '12px'
                          }}></span>
                          <span style={{fontWeight: 600}}>{chapter.name}</span>
                          <span style={{
                            fontSize: '12px',
                            opacity: 0.7
                          }}>({chapter.substandards.length} items)</span>
                        </div>
                        <div style={{
                          fontSize: '18px',
                          fontWeight: 700,
                          color: expandedChapters[chapter.id] ? 'white' :
                                 (chapter.percentage >= 75 ? 'var(--success)' :
                                  chapter.percentage >= 60 ? 'var(--warning)' : 'var(--danger)')
                        }}>
                          {chapter.percentage}%
                        </div>
                      </div>

                      {/* Expanded Substandards */}
                      {expandedChapters[chapter.id] && (
                        <div style={{padding: '16px', background: 'white'}}>
                          {chapter.substandards.map((sub, idx) => {
                            const scoreInfo = getScoreLabel(sub.score);
                            return (
                              <div key={sub.id} style={{
                                padding: '12px 16px',
                                background: scoreInfo.bg,
                                borderRadius: '8px',
                                marginBottom: idx < chapter.substandards.length - 1 ? '8px' : 0,
                                borderLeft: `4px solid ${scoreInfo.color}`
                              }}>
                                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '6px'}}>
                                  <div style={{fontWeight: 600, fontSize: '13px', color: 'var(--text-primary)'}}>{sub.id}</div>
                                  <span style={{
                                    fontSize: '11px',
                                    padding: '3px 10px',
                                    borderRadius: '12px',
                                    background: scoreInfo.color,
                                    color: 'white',
                                    fontWeight: 600
                                  }}>
                                    {scoreInfo.text}
                                  </span>
                                </div>
                                <div style={{fontSize: '13px', color: 'var(--text-secondary)', marginBottom: sub.findings || sub.recommendations ? '10px' : 0}}>
                                  {sub.text}
                                </div>
                                {sub.findings && (
                                  <div style={{
                                    fontSize: '12px',
                                    padding: '10px 12px',
                                    background: 'rgba(231, 76, 60, 0.08)',
                                    borderRadius: '6px',
                                    marginBottom: sub.recommendations ? '8px' : 0,
                                    border: '1px solid rgba(231, 76, 60, 0.2)'
                                  }}>
                                    <strong style={{color: 'var(--danger)'}}>Finding:</strong> {sub.findings}
                                  </div>
                                )}
                                {sub.recommendations && (
                                  <div style={{
                                    fontSize: '12px',
                                    padding: '10px 12px',
                                    background: 'rgba(52, 152, 219, 0.08)',
                                    borderRadius: '6px',
                                    border: '1px solid rgba(52, 152, 219, 0.2)'
                                  }}>
                                    <strong style={{color: 'var(--primary)'}}>Recommendation:</strong> {sub.recommendations}
                                  </div>
                                )}
                              </div>
                            );
                          })}
                        </div>
                      )}
                    </div>
                  ))}
                </div>

              {/* ACTION PLAN SECTION - Only shows when there are findings */}
              {totalFindings > 0 && (
                <div style={{marginTop: '32px'}}>
                  <div style={{
                    background: 'linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)',
                    borderRadius: '12px',
                    padding: '20px',
                    marginBottom: '24px',
                    border: '1px solid #ffcc80'
                  }}>
                    <h4 style={{margin: '0 0 8px', color: '#e65100', display: 'flex', alignItems: 'center', gap: '8px'}}>
                      {Icons.checkCircle({size: 20, color: '#e65100'})} Corrective Action Plan
                    </h4>
                    <p style={{margin: 0, fontSize: '14px', color: '#bf360c'}}>
                      This action plan outlines {totalFindings} items requiring attention. Address all "Not Met" (High Priority) items first, followed by "Partial" (Medium Priority) items.
                    </p>
                  </div>

                  {/* Priority Legend */}
                  <div style={{display: 'flex', gap: '24px', marginBottom: '20px'}}>
                    <div style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                      <span style={{width: '12px', height: '12px', borderRadius: '50%', background: 'var(--danger)'}}></span>
                      <span style={{fontSize: '13px', fontWeight: 600}}>High Priority (Not Met)</span>
                    </div>
                    <div style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                      <span style={{width: '12px', height: '12px', borderRadius: '50%', background: 'var(--warning)'}}></span>
                      <span style={{fontSize: '13px', fontWeight: 600}}>Medium Priority (Partial)</span>
                    </div>
                  </div>

                  {/* Action Items */}
                  <div style={{display: 'flex', flexDirection: 'column', gap: '16px'}}>
                    {actionPlanItems.map((item, idx) => (
                      <div key={item.id} style={{
                        background: 'white',
                        borderRadius: '12px',
                        border: `2px solid ${item.priorityColor}`,
                        overflow: 'hidden'
                      }}>
                        {/* Item Header */}
                        <div style={{
                          padding: '16px 20px',
                          background: item.score === 0 ? 'rgba(231, 76, 60, 0.08)' : 'rgba(241, 196, 15, 0.08)',
                          borderBottom: '1px solid var(--border)',
                          display: 'flex',
                          justifyContent: 'space-between',
                          alignItems: 'center'
                        }}>
                          <div style={{display: 'flex', alignItems: 'center', gap: '12px'}}>
                            <span style={{
                              width: '28px',
                              height: '28px',
                              borderRadius: '50%',
                              background: item.priorityColor,
                              color: 'white',
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center',
                              fontSize: '12px',
                              fontWeight: 700
                            }}>{idx + 1}</span>
                            <div>
                              <div style={{fontWeight: 600, fontSize: '14px'}}>{item.id}</div>
                              <div style={{fontSize: '12px', color: 'var(--text-muted)'}}>{item.chapter}</div>
                            </div>
                          </div>
                          <span style={{
                            padding: '4px 12px',
                            borderRadius: '20px',
                            fontSize: '11px',
                            fontWeight: 700,
                            background: item.priorityColor,
                            color: 'white'
                          }}>
                            {item.priority} Priority
                          </span>
                        </div>

                        {/* Item Content */}
                        <div style={{padding: '16px 20px'}}>
                          <div style={{fontSize: '14px', color: 'var(--text-primary)', marginBottom: '16px', lineHeight: 1.5}}>
                            {item.text}
                          </div>

                          {item.findings && (
                            <div style={{
                              padding: '12px 16px',
                              background: 'rgba(231, 76, 60, 0.05)',
                              borderRadius: '8px',
                              marginBottom: '12px',
                              borderLeft: '4px solid var(--danger)'
                            }}>
                              <div style={{fontSize: '11px', fontWeight: 700, color: 'var(--danger)', marginBottom: '4px', textTransform: 'uppercase'}}>
                                Current Finding
                              </div>
                              <div style={{fontSize: '13px', color: 'var(--text-primary)'}}>{item.findings}</div>
                            </div>
                          )}

                          <div style={{
                            padding: '12px 16px',
                            background: 'rgba(46, 204, 113, 0.05)',
                            borderRadius: '8px',
                            borderLeft: '4px solid var(--success)'
                          }}>
                            <div style={{fontSize: '11px', fontWeight: 700, color: 'var(--success)', marginBottom: '4px', textTransform: 'uppercase'}}>
                              Suggested Corrective Action (Target: {item.targetDays} days)
                            </div>
                            <div style={{fontSize: '13px', color: 'var(--text-primary)'}}>
                              {item.suggestedAction}
                            </div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>

            {/* Footer */}
            <div style={{
              padding: '16px 24px',
              borderTop: '1px solid var(--border)',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              background: 'var(--bg-secondary)',
              flexShrink: 0
            }}>
              <div style={{fontSize: '12px', color: 'var(--text-muted)'}}>
                Assessment ID: {survey.id}
              </div>
              <div style={{display: 'flex', gap: '12px'}}>
                <button
                  onClick={() => onViewFullDetails && onViewFullDetails(survey)}
                  className="modern-btn modern-btn-primary"
                  style={{display: 'flex', alignItems: 'center', gap: '8px'}}
                >
                  {Icons.clipboard({size: 16})} View Full Scoring Interface
                </button>
                <button onClick={onClose} className="modern-btn modern-btn-secondary">
                  Close
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // Centers Page
    const CentersPage = ({ surveys, currentAssessmentId, onEditSurvey, onDeleteSurvey, onResumeAssessment, onViewSummary }) => {
      // Format phone for WhatsApp
      const formatWhatsApp = (phone) => {
        if (!phone) return '';
        let clean = phone.replace(/[\s\-()]/g, '');
        if (!clean.startsWith('+')) {
          clean = '+966' + clean.replace(/^0/, '');
        }
        return clean;
      };

      // Sort surveys by date (newest first)
      const sortedSurveys = [...surveys].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

      const getStatusLabel = (status) => {
        switch(status) {
          case 'completed': return { text: ' Completed', class: 'completed' };
          case 'in_progress': return { text: ' In Progress', class: 'in-progress' };
          default: return { text: ' Not Started', class: 'not-started' };
        }
      };

      const getProgressPercent = (survey) => {
        const total = survey.totalSubstandards || 180;
        const scored = survey.scoredCount || 0;
        return Math.round((scored / total) * 100);
      };

      return (
        <div className="page-container">
          <div style={{marginBottom: '32px'}}>
            <h2 style={{marginBottom: '8px'}}>Assessment History</h2>
            <p style={{color: 'var(--text-secondary)', fontSize: '15px'}}>
              Track all dental center assessments and their completion status
            </p>
          </div>

          {sortedSurveys.length === 0 ? (
            <div className="card">
              <div className="card-body">
                <div className="empty-state">
                  <div className="empty-state-icon" style={{color: 'var(--text-muted)'}}>
                    {Icons.clipboard({size: 48, color: 'var(--text-muted)'})}
                  </div>
                  <h3>No assessments yet</h3>
                  <p>Start a new assessment from the Scoring page. All assessments will appear here with their status.</p>
                </div>
              </div>
            </div>
          ) : (
            <div style={{display: 'grid', gap: '24px', gridTemplateColumns: 'repeat(auto-fill, minmax(380px, 1fr))'}}>
              {sortedSurveys.map(survey => {
                const details = survey.assessmentDetails || {};
                const statusInfo = getStatusLabel(survey.status);
                const isCurrent = survey.id === currentAssessmentId;
                const progress = getProgressPercent(survey);

                // Handle card click based on status
                const handleCardClick = () => {
                  if (survey.status === 'completed') {
                    onViewSummary && onViewSummary(survey);
                  } else if (survey.status === 'in_progress' || survey.status === 'not_started') {
                    onResumeAssessment && onResumeAssessment(survey);
                  }
                };

                return (
                  <div
                    key={survey.id}
                    className={`assessment-card ${isCurrent ? 'current' : ''}`}
                    onClick={handleCardClick}
                    style={{cursor: 'pointer'}}
                    title={survey.status === 'completed' ? 'Click to view Executive Summary' : 'Click to resume assessment'}
                  >
                    {/* Card Header with Status Color */}
                    <div className={`assessment-card-header ${statusInfo.class}`}>
                      <div style={{position: 'absolute', top: '12px', right: '12px', display: 'flex', alignItems: 'center', gap: '8px'}}>
                        {isCurrent && (
                          <div className="current-badge">
                             Active Now
                          </div>
                        )}
                        <button
                          onClick={(e) => { e.stopPropagation(); onEditSurvey && onEditSurvey(survey); }}
                          title="Edit Details"
                          style={{
                            width: '32px', height: '32px', borderRadius: '50%',
                            border: 'none', background: 'rgba(255,255,255,0.2)',
                            color: 'white', cursor: 'pointer',
                            display: 'flex', alignItems: 'center', justifyContent: 'center',
                            transition: 'all 0.2s ease', fontSize: '14px'
                          }}
                          onMouseOver={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.3)'}
                          onMouseOut={(e) => e.currentTarget.style.background = 'rgba(255,255,255,0.2)'}
                        >
                          {Icons.edit({size: 14, color: 'white'})}
                        </button>
                        <button
                          onClick={(e) => { e.stopPropagation(); onDeleteSurvey && onDeleteSurvey(survey); }}
                          title="Delete Assessment"
                          style={{
                            width: '32px', height: '32px', borderRadius: '50%',
                            border: 'none', background: 'rgba(231, 76, 60, 0.3)',
                            color: 'white', cursor: 'pointer',
                            display: 'flex', alignItems: 'center', justifyContent: 'center',
                            transition: 'all 0.2s ease', fontSize: '14px'
                          }}
                          onMouseOver={(e) => e.currentTarget.style.background = 'rgba(231, 76, 60, 0.5)'}
                          onMouseOut={(e) => e.currentTarget.style.background = 'rgba(231, 76, 60, 0.3)'}
                        >
                          {Icons.trash({size: 14, color: 'white'})}
                        </button>
                      </div>
                      <div className="assessment-card-logo">{Icons.building({size: 28, color: 'white'})}</div>
                      <div className="assessment-card-center-name">
                        {details.centerName || survey.centerName || 'Unknown Center'}
                      </div>
                      <div className="assessment-card-coordinator">
                        {Icons.user({size: 14, color: 'rgba(255,255,255,0.8)'})} {details.coordinatorName || 'No coordinator assigned'}
                      </div>
                      <div style={{
                        marginTop: '8px',
                        padding: '4px 10px',
                        background: 'rgba(255,255,255,0.15)',
                        borderRadius: '12px',
                        fontSize: '11px',
                        fontWeight: 600,
                        display: 'inline-block'
                      }}>
                        {survey.configuration || 'Configuration A  Surveyor 1'}
                      </div>
                    </div>

                    {/* Card Body */}
                    <div className="assessment-card-body">
                      {/* Status Badge */}
                      <div style={{marginBottom: '20px', display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                        <div className={`status-badge ${statusInfo.class}`}>
                          {statusInfo.text}
                        </div>
                        {survey.status === 'completed' && survey.stats && (
                          <div style={{
                            fontSize: '28px',
                            fontWeight: 700,
                            color: survey.stats.percentage >= 75 ? 'var(--success)' :
                                   survey.stats.percentage >= 60 ? 'var(--warning)' : 'var(--danger)'
                          }}>
                            {survey.stats.percentage}%
                          </div>
                        )}
                      </div>

                      {/* Progress Bar for In Progress */}
                      {survey.status !== 'completed' && (
                        <div style={{marginBottom: '20px'}}>
                          <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '8px', fontSize: '13px'}}>
                            <span style={{color: 'var(--text-secondary)'}}>Scoring Progress</span>
                            <span style={{fontWeight: 600, color: 'var(--text-primary)'}}>{progress}%</span>
                          </div>
                          <div style={{
                            height: '8px',
                            background: 'var(--bg-hover)',
                            borderRadius: '4px',
                            overflow: 'hidden'
                          }}>
                            <div style={{
                              height: '100%',
                              width: `${progress}%`,
                              background: survey.status === 'in_progress'
                                ? 'linear-gradient(90deg, var(--accent) 0%, #2980b9 100%)'
                                : 'var(--neutral)',
                              borderRadius: '4px',
                              transition: 'width 0.3s ease'
                            }} />
                          </div>
                          <div style={{fontSize: '12px', color: 'var(--text-muted)', marginTop: '6px'}}>
                            {survey.scoredCount || 0} of {survey.totalSubstandards || 180} items scored
                          </div>
                        </div>
                      )}

                      {/* Stats for Completed */}
                      {survey.status === 'completed' && survey.stats && (
                        <div className="assessment-card-stats">
                          <div className="assessment-stat-item" style={{background: 'rgba(46, 204, 113, 0.1)'}}>
                            <div className="assessment-stat-value" style={{color: 'var(--success)'}}>{survey.stats.fullyMet}</div>
                            <div className="assessment-stat-label">Fully Met</div>
                          </div>
                          <div className="assessment-stat-item" style={{background: 'rgba(241, 196, 15, 0.1)'}}>
                            <div className="assessment-stat-value" style={{color: 'var(--warning)'}}>{survey.stats.partial}</div>
                            <div className="assessment-stat-label">Partial</div>
                          </div>
                          <div className="assessment-stat-item" style={{background: 'rgba(231, 76, 60, 0.1)'}}>
                            <div className="assessment-stat-value" style={{color: 'var(--danger)'}}>{survey.stats.notMet}</div>
                            <div className="assessment-stat-label">Not Met</div>
                          </div>
                        </div>
                      )}

                      {/* Contact Info */}
                      {(details.coordinatorPhone || details.coordinatorEmail) && (
                        <div style={{
                          display: 'flex',
                          gap: '16px',
                          padding: '12px 0',
                          borderTop: '1px solid var(--border)',
                          marginTop: '16px'
                        }}>
                          {details.coordinatorPhone && (
                            <a href={`https://wa.me/${formatWhatsApp(details.coordinatorPhone)}`}
                               target="_blank" rel="noopener noreferrer"
                               className="contact-link whatsapp" style={{fontSize: '13px', display: 'inline-flex', alignItems: 'center', gap: '6px'}}>
                              {Icons.whatsapp({size: 14})} WhatsApp
                            </a>
                          )}
                          {details.coordinatorEmail && (
                            <a href={`mailto:${details.coordinatorEmail}`}
                               className="contact-link email" style={{fontSize: '13px', display: 'inline-flex', alignItems: 'center', gap: '6px'}}>
                              {Icons.mail({size: 14})} Email
                            </a>
                          )}
                        </div>
                      )}
                    </div>

                    {/* Card Footer */}
                    <div className="assessment-card-footer" style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                      <div>
                        <div style={{fontSize: '12px', color: 'var(--text-muted)'}}>
                          Created: {new Date(survey.createdAt).toLocaleDateString('en-US', {
                            year: 'numeric', month: 'short', day: 'numeric'
                          })}
                        </div>
                        {survey.completedAt && (
                          <div style={{fontSize: '12px', color: 'var(--success)'}}>
                            Finalized: {new Date(survey.completedAt).toLocaleDateString('en-US', {
                              year: 'numeric', month: 'short', day: 'numeric'
                            })}
                          </div>
                        )}
                      </div>
                      <div style={{
                        padding: '8px 16px',
                        borderRadius: '8px',
                        fontSize: '13px',
                        fontWeight: 600,
                        background: survey.status === 'completed'
                          ? 'linear-gradient(135deg, var(--success) 0%, #219a52 100%)'
                          : 'linear-gradient(135deg, var(--accent) 0%, #2980b9 100%)',
                        color: 'white',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '6px',
                        boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
                      }}>
                        {survey.status === 'completed' ? (
                          <>{Icons.barChart({size: 14, color: 'white'})} View Summary</>
                        ) : (
                          <>{Icons.clipboard({size: 14, color: 'white'})} {survey.status === 'in_progress' ? 'Resume' : 'Start'}</>
                        )}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      );
    };

    // ============================================
    // MAIN APP
    // ============================================
    const App = () => {
      const [currentPage, setCurrentPage] = useState('scoring'); // DEFAULT TO SCORING PAGE
      const [centers, setCenters] = useState([]);
      const [surveys, setSurveys] = useState([]);
      const [scores, setScores] = useState({});
      const [saving, setSaving] = useState(false);
      const [isFinalized, setIsFinalized] = useState(false);
      const [finalizedData, setFinalizedData] = useState(null);
      const [viewingMode, setViewingMode] = useState(false); // True when viewing completed assessment's full interface
      const saveTimeoutRef = useRef(null);

      // Assessment details state
      const [assessmentDetails, setAssessmentDetails] = useState(null);
      const [currentAssessmentId, setCurrentAssessmentId] = useState(null);
      const [showSetupModal, setShowSetupModal] = useState(false);
      const [editingSurvey, setEditingSurvey] = useState(null); // For editing survey from History
      const [viewingSummary, setViewingSummary] = useState(null); // For viewing Executive Summary

      // Toast notifications state
      const [toasts, setToasts] = useState([]);

      // Confirm dialog state
      const [confirmDialog, setConfirmDialog] = useState({ open: false, title: '', message: '', onConfirm: () => {}, type: 'warning' });

      // Toast helper functions
      const showToast = (type, title, message) => {
        const id = Date.now();
        setToasts(prev => [...prev, { id, type, title, message }]);
        // Auto dismiss after 5 seconds
        setTimeout(() => {
          setToasts(prev => prev.map(t => t.id === id ? {...t, closing: true} : t));
          setTimeout(() => {
            setToasts(prev => prev.filter(t => t.id !== id));
          }, 300);
        }, 5000);
      };

      const dismissToast = (id) => {
        setToasts(prev => prev.map(t => t.id === id ? {...t, closing: true} : t));
        setTimeout(() => {
          setToasts(prev => prev.filter(t => t.id !== id));
        }, 300);
      };

      // Load data on mount
      useEffect(() => {
        const savedCenters = storage.get(STORAGE_KEYS.CENTERS) || [];
        let savedSurveys = storage.get(STORAGE_KEYS.SURVEYS) || [];
        const savedScores = storage.get(STORAGE_KEYS.CURRENT_SCORES) || {};
        const savedFinalized = storage.get('cbahi_finalized') || false;
        const savedFinalizedData = storage.get('cbahi_finalized_data') || null;
        const savedAssessmentDetails = storage.get('cbahi_assessment_details') || null;
        const savedCurrentAssessmentId = storage.get('cbahi_current_assessment_id') || null;

        // MIGRATION: If there's finalized data but no survey record, create one
        if (savedFinalized && savedFinalizedData && savedFinalizedData.submissionId) {
          const existingSurvey = savedSurveys.find(s => s.submissionId === savedFinalizedData.submissionId || s.id === savedFinalizedData.submissionId);
          if (!existingSurvey) {
            // Create a survey record from the finalized data
            const migratedSurvey = {
              id: savedFinalizedData.submissionId,
              centerName: savedFinalizedData.centerName || savedAssessmentDetails?.centerName || 'Assessment',
              assessmentDetails: savedFinalizedData.assessmentDetails || savedAssessmentDetails || {
                centerName: savedFinalizedData.centerName || 'Completed Assessment',
                coordinatorName: savedFinalizedData.coordinatorName || '',
                coordinatorPhone: savedFinalizedData.coordinatorPhone || '',
                coordinatorEmail: savedFinalizedData.coordinatorEmail || ''
              },
              status: 'completed',
              scoredCount: savedFinalizedData.scoredSubstandards || 180,
              totalSubstandards: savedFinalizedData.totalSubstandards || 180,
              stats: savedFinalizedData.stats || {
                total: savedFinalizedData.totalSubstandards || 180,
                scored: savedFinalizedData.scoredSubstandards || 180,
                fullyMet: savedFinalizedData.fullyMet || 0,
                partial: savedFinalizedData.partialMet || 0,
                notMet: savedFinalizedData.notMet || 0,
                na: savedFinalizedData.naCount || 0,
                percentage: savedFinalizedData.percentage || 0
              },
              scores: savedFinalizedData.scores || savedScores,
              createdAt: savedFinalizedData.submittedAt || new Date().toISOString(),
              completedAt: savedFinalizedData.submittedAt || new Date().toISOString(),
              lastUpdated: savedFinalizedData.submittedAt || new Date().toISOString(),
              submissionId: savedFinalizedData.submissionId,
              storageType: savedFinalizedData.storageType || 'local'
            };
            savedSurveys = [...savedSurveys, migratedSurvey];
            storage.set(STORAGE_KEYS.SURVEYS, savedSurveys);
            console.log('Migrated finalized assessment to History:', migratedSurvey.id);
          }
        }

        setCenters(savedCenters);
        setSurveys(savedSurveys);
        setScores(savedScores);
        setIsFinalized(savedFinalized);
        setFinalizedData(savedFinalizedData);
        setAssessmentDetails(savedAssessmentDetails);
        setCurrentAssessmentId(savedCurrentAssessmentId);

        // Don't auto-show modal on startup - user can navigate freely
        // Modal will show when user clicks "Start New Assessment" or goes to Scoring tab
      }, []);

      // Calculate current assessment status
      const getAssessmentStatus = useCallback(() => {
        if (isFinalized) return 'completed';
        const scoredCount = Object.keys(scores).filter(id => scores[id]?.value !== undefined && scores[id]?.value !== null).length;
        if (scoredCount === 0) return 'not_started';
        return 'in_progress';
      }, [scores, isFinalized]);

      // Update survey status when scores change
      useEffect(() => {
        if (currentAssessmentId && assessmentDetails) {
          const status = getAssessmentStatus();
          const scoredCount = Object.keys(scores).filter(id => scores[id]?.value !== undefined && scores[id]?.value !== null).length;

          setSurveys(prev => {
            const updated = prev.map(s => {
              if (s.id === currentAssessmentId) {
                return {
                  ...s,
                  status: status,
                  scoredCount: scoredCount,
                  lastUpdated: new Date().toISOString(),
                  scores: scores
                };
              }
              return s;
            });
            storage.set(STORAGE_KEYS.SURVEYS, updated);
            return updated;
          });
        }
      }, [scores, currentAssessmentId, assessmentDetails, getAssessmentStatus]);

      // Configuration labels lookup
      const getConfigLabel = (configCode) => {
        const labels = {
          'A1': 'Configuration A  Surveyor 1',
          'A2': 'Configuration A  Surveyor 2',
          'B': 'Configuration B  Full Survey'
        };
        return labels[configCode] || labels['A1'];
      };

      // Handle assessment setup
      const handleAssessmentSetup = (details) => {
        // Generate a unique ID for this assessment
        const assessmentId = 'ASSESS_' + Date.now();

        // Create assessment record
        const newAssessment = {
          id: assessmentId,
          centerName: details.centerName,
          assessmentDetails: details,
          configuration: getConfigLabel(details.configuration || 'A1'),
          status: 'not_started',
          scoredCount: 0,
          totalSubstandards: 180, // Total substandards in the system
          stats: null,
          scores: {},
          createdAt: new Date().toISOString(),
          lastUpdated: new Date().toISOString()
        };

        // Save to surveys
        const updatedSurveys = [...surveys, newAssessment];
        setSurveys(updatedSurveys);
        storage.set(STORAGE_KEYS.SURVEYS, updatedSurveys);

        // Set current assessment
        setAssessmentDetails(details);
        setCurrentAssessmentId(assessmentId);
        storage.set('cbahi_assessment_details', details);
        storage.set('cbahi_current_assessment_id', assessmentId);

        // Reset viewing mode and finalized state for new assessment
        setViewingMode(false);
        setIsFinalized(false);
        setFinalizedData(null);

        setShowSetupModal(false);
        showToast('success', 'Assessment Created', `Assessment for ${details.centerName} is now active.`);
      };

      // Handle finalization
      const handleFinalize = async (stats) => {
        const assessmentData = {
          scores: scores,
          stats: stats,
          assessmentDetails: assessmentDetails,
          centerName: assessmentDetails?.centerName || 'Unknown Center',
          coordinatorName: assessmentDetails?.coordinatorName || '',
          coordinatorPhone: assessmentDetails?.coordinatorPhone || '',
          coordinatorEmail: assessmentDetails?.coordinatorEmail || '',
          configuration: assessmentDetails?.configuration ? getConfigLabel(assessmentDetails.configuration) : 'Configuration A  Surveyor 1',
          totalSubstandards: stats.total,
          scoredSubstandards: stats.scored,
          percentage: stats.percentage,
          fullyMet: stats.fullyMet,
          partialMet: stats.partial,
          notMet: stats.notMet,
          naCount: stats.na
        };

        try {
          const result = await firebaseHelpers.submitAssessment(assessmentData);
          const finalData = {
            ...assessmentData,
            submissionId: result.id,
            submittedAt: new Date().toISOString(),
            storageType: result.local ? 'local' : 'firebase'
          };
          setIsFinalized(true);
          setFinalizedData(finalData);
          storage.set('cbahi_finalized', true);
          storage.set('cbahi_finalized_data', finalData);

          // Update the existing assessment record to completed status
          setSurveys(prev => {
            const updated = prev.map(s => {
              if (s.id === currentAssessmentId) {
                return {
                  ...s,
                  status: 'completed',
                  stats: stats,
                  scores: scores,
                  submissionId: result.id,
                  completedAt: new Date().toISOString(),
                  lastUpdated: new Date().toISOString(),
                  storageType: result.local ? 'local' : 'firebase'
                };
              }
              return s;
            });
            storage.set(STORAGE_KEYS.SURVEYS, updated);
            return updated;
          });

          return { success: true, data: finalData };
        } catch (e) {
          console.error('Finalization error:', e);
          return { success: false, error: e.message };
        }
      };

      // Reset assessment (start new)
      const handleResetAssessment = () => {
        setConfirmDialog({
          open: true,
          title: 'Start New Assessment?',
          message: 'This will clear all current scores and assessment details. Submitted assessments will be preserved. Are you sure you want to start fresh?',
          type: 'warning',
          onConfirm: () => {
            setScores({});
            setIsFinalized(false);
            setFinalizedData(null);
            setAssessmentDetails(null);
            setCurrentAssessmentId(null);
            storage.set(STORAGE_KEYS.CURRENT_SCORES, {});
            storage.set('cbahi_finalized', false);
            storage.set('cbahi_finalized_data', null);
            storage.set('cbahi_assessment_details', null);
            storage.set('cbahi_current_assessment_id', null);
            setShowSetupModal(true);
            showToast('success', 'Assessment Reset', 'Ready to start a new assessment.');
          }
        });
      };

      // Handle editing survey details from History page
      const handleEditSurveyDetails = (survey) => {
        setEditingSurvey(survey);
      };

      // Handle deleting a survey with confirmation
      const handleDeleteSurvey = (survey) => {
        setConfirmDialog({
          open: true,
          title: 'Delete Assessment',
          message: `Are you sure you want to permanently delete the assessment for "${survey.centerName || survey.assessmentDetails?.centerName || 'this center'}"? This action cannot be undone.`,
          type: 'danger',
          onConfirm: () => {
            // Remove from surveys
            const updatedSurveys = surveys.filter(s => s.id !== survey.id);
            setSurveys(updatedSurveys);
            storage.set(STORAGE_KEYS.SURVEYS, updatedSurveys);

            // If deleting the current assessment, clear it
            if (survey.id === currentAssessmentId) {
              setCurrentAssessmentId(null);
              setAssessmentDetails(null);
              setScores({});
              setIsFinalized(false);
              setFinalizedData(null);
              storage.remove('cbahi_current_assessment_id');
              storage.remove('cbahi_assessment_details');
              storage.remove(STORAGE_KEYS.CURRENT_SCORES);
              storage.remove('cbahi_finalized');
              storage.remove('cbahi_finalized_data');
            }

            setConfirmDialog({...confirmDialog, open: false});
            showToast('success', 'Assessment Deleted', `"${survey.centerName || 'Assessment'}" has been permanently removed.`);
          }
        });
      };

      const handleSaveEditedSurvey = (updatedDetails) => {
        if (!editingSurvey) return;

        // Update the survey with new details
        const updatedSurveys = surveys.map(s => {
          if (s.id === editingSurvey.id) {
            return {
              ...s,
              assessmentDetails: updatedDetails,
              centerName: updatedDetails.centerName
            };
          }
          return s;
        });

        setSurveys(updatedSurveys);
        storage.set(STORAGE_KEYS.SURVEYS, updatedSurveys);

        // If editing the current assessment, update assessmentDetails too
        if (editingSurvey.id === currentAssessmentId) {
          setAssessmentDetails(updatedDetails);
          storage.set('cbahi_assessment_details', updatedDetails);
        }

        setEditingSurvey(null);
        showToast('success', 'Details Updated', 'Assessment details have been saved.');
      };

      // Handle resuming an in-progress or not-started assessment from History
      const handleResumeAssessment = (survey) => {
        // Load this survey's data as the current assessment
        setCurrentAssessmentId(survey.id);
        setAssessmentDetails(survey.assessmentDetails || null);

        // Load scores if available
        if (survey.scores) {
          setScores(survey.scores);
          storage.set(STORAGE_KEYS.CURRENT_SCORES, survey.scores);
        } else {
          setScores({});
          storage.set(STORAGE_KEYS.CURRENT_SCORES, {});
        }

        // Reset finalized state
        setIsFinalized(false);
        setFinalizedData(null);

        // Save as current assessment
        storage.set('cbahi_assessment_details', survey.assessmentDetails);
        storage.set('cbahi_current_assessment_id', survey.id);

        // Navigate to scoring page
        setCurrentPage('scoring');

        showToast('info', 'Assessment Loaded', `Resuming "${survey.assessmentDetails?.centerName || 'assessment'}"`);
      };

      // Handle viewing executive summary for completed assessment
      const handleViewSummary = (survey) => {
        setViewingSummary(survey);
      };

      // Handle viewing full scoring interface for a completed assessment
      const handleViewFullScoringInterface = (survey) => {
        // Enable viewing mode to show full interface instead of success screen
        setViewingMode(true);

        // Load the survey's scores into the current view
        setCurrentAssessmentId(survey.id);
        setAssessmentDetails(survey.assessmentDetails || {
          centerName: survey.centerName,
          coordinatorName: survey.coordinatorName || '',
          coordinatorPhone: survey.coordinatorPhone || '',
          coordinatorEmail: survey.coordinatorEmail || ''
        });

        // Load the scores from the survey
        if (survey.scores) {
          setScores(survey.scores);
          storage.set(STORAGE_KEYS.CURRENT_SCORES, survey.scores);
        }

        // Set as finalized if it's completed (keeps finalized badge, but viewingMode prevents success screen)
        if (survey.status === 'completed') {
          setIsFinalized(true);
          setFinalizedData({
            ...survey.stats,
            submissionId: survey.submissionId || survey.id,
            submittedAt: survey.completedAt,
            centerName: survey.centerName
          });
        } else {
          setIsFinalized(false);
          setFinalizedData(null);
        }

        // Close the modal and navigate to scoring page
        setViewingSummary(null);
        setCurrentPage('scoring');

        showToast('info', 'Assessment Loaded', `Viewing full scoring interface for "${survey.centerName || survey.assessmentDetails?.centerName}"`);
      };

      // Auto-save scores with debounce
      useEffect(() => {
        setSaving(true);
        if (saveTimeoutRef.current) clearTimeout(saveTimeoutRef.current);

        saveTimeoutRef.current = setTimeout(() => {
          storage.set(STORAGE_KEYS.CURRENT_SCORES, scores);
          setSaving(false);
        }, 500);

        return () => { if (saveTimeoutRef.current) clearTimeout(saveTimeoutRef.current); };
      }, [scores]);

      // Center operations
      const handleAddCenter = (center) => {
        const updated = [...centers, center];
        setCenters(updated);
        storage.set(STORAGE_KEYS.CENTERS, updated);
      };

      const handleDeleteCenter = (centerId) => {
        setConfirmDialog({
          open: true,
          title: 'Delete Center?',
          message: 'This will permanently delete this center and all associated surveys. This action cannot be undone.',
          type: 'danger',
          onConfirm: () => {
            const updatedCenters = centers.filter(c => c.id !== centerId);
            const updatedSurveys = surveys.filter(s => s.centerId !== centerId);
            setCenters(updatedCenters);
            setSurveys(updatedSurveys);
            storage.set(STORAGE_KEYS.CENTERS, updatedCenters);
            storage.set(STORAGE_KEYS.SURVEYS, updatedSurveys);
            showToast('success', 'Center Deleted', 'The center and its surveys have been removed.');
          }
        });
      };

      return (
        <div className="app">
          <header className="header">
            <div className="header-top">
              <div className="logo" onClick={() => setCurrentPage('scoring')}>
                <div className="logo-icon">DC</div>
                <div className="logo-text">
                  <h1>CBAHI Scoring</h1>
                  <span>Dental Center Accreditation</span>
                </div>
              </div>
              <select
                value={assessmentDetails?.configuration || 'A1'}
                onChange={(e) => {
                  const newConfig = e.target.value;
                  const updatedDetails = { ...assessmentDetails, configuration: newConfig };
                  setAssessmentDetails(updatedDetails);
                  storage.set('cbahi_assessment_details', updatedDetails);

                  // Update survey record if exists
                  if (currentAssessmentId) {
                    const updatedSurveys = surveys.map(s =>
                      s.id === currentAssessmentId
                        ? { ...s, assessmentDetails: updatedDetails, configuration: getConfigLabel(newConfig) }
                        : s
                    );
                    setSurveys(updatedSurveys);
                    storage.set(STORAGE_KEYS.SURVEYS, updatedSurveys);
                  }
                  showToast('success', 'Configuration Changed', `Switched to ${getConfigLabel(newConfig)}`);
                }}
                style={{
                  background: 'rgba(255,255,255,0.15)',
                  color: 'white',
                  border: '1px solid rgba(255,255,255,0.3)',
                  borderRadius: '6px',
                  padding: '6px 12px',
                  fontSize: '12px',
                  fontWeight: 500,
                  cursor: 'pointer',
                  outline: 'none',
                  minWidth: '200px'
                }}
              >
                <option value="A1" style={{color: '#1e3a5f'}}>Configuration A  Surveyor 1</option>
                <option value="A2" style={{color: '#1e3a5f'}}>Configuration A  Surveyor 2</option>
                <option value="B" style={{color: '#1e3a5f'}}>Configuration B  Full Survey</option>
              </select>
            </div>
            <div className="nav-tabs">
              <div className={`nav-tab ${currentPage === 'scoring' ? 'active' : ''}`}
                onClick={() => setCurrentPage('scoring')}>Scoring</div>
              <div className={`nav-tab ${currentPage === 'dashboard' ? 'active' : ''}`}
                onClick={() => setCurrentPage('dashboard')}>Dashboard</div>
              <div className={`nav-tab ${currentPage === 'centers' ? 'active' : ''}`}
                onClick={() => setCurrentPage('centers')}>History</div>
            </div>
          </header>

          {currentPage === 'scoring' && (
            <ScoringPage
              scores={scores}
              setScores={setScores}
              saving={saving}
              isFinalized={isFinalized}
              finalizedData={finalizedData}
              viewingMode={viewingMode}
              setViewingMode={setViewingMode}
              onFinalize={handleFinalize}
              onReset={handleResetAssessment}
              showToast={showToast}
              assessmentDetails={assessmentDetails}
              onEditDetails={() => setShowSetupModal(true)}
              onNavigateToHistory={() => setCurrentPage('centers')}
            />
          )}

          {currentPage === 'dashboard' && (
            <DashboardPage centers={centers} surveys={surveys} onEditSurvey={handleEditSurveyDetails} onDeleteSurvey={handleDeleteSurvey} />
          )}

          {currentPage === 'centers' && (
            <CentersPage
              surveys={surveys}
              currentAssessmentId={currentAssessmentId}
              onEditSurvey={handleEditSurveyDetails}
              onDeleteSurvey={handleDeleteSurvey}
              onResumeAssessment={handleResumeAssessment}
              onViewSummary={handleViewSummary}
            />
          )}

          {/* Edit Survey Modal */}
          <AssessmentSetupModal
            isOpen={!!editingSurvey}
            onClose={() => setEditingSurvey(null)}
            onStart={handleSaveEditedSurvey}
            existingData={editingSurvey?.assessmentDetails}
            isEditing={true}
          />

          {/* Toast Notifications */}
          <ToastNotification toasts={toasts} onDismiss={dismissToast} />

          {/* Modern Confirm Dialog */}
          <ModernConfirmDialog
            isOpen={confirmDialog.open}
            onClose={() => setConfirmDialog({...confirmDialog, open: false})}
            onConfirm={confirmDialog.onConfirm}
            title={confirmDialog.title}
            message={confirmDialog.message}
            type={confirmDialog.type}
          />

          {/* Assessment Setup Modal */}
          <AssessmentSetupModal
            isOpen={showSetupModal}
            onClose={() => setShowSetupModal(false)}
            onStart={handleAssessmentSetup}
            existingData={assessmentDetails}
          />

          {/* Executive Summary Modal */}
          {viewingSummary && (
            <ExecutiveSummaryModal
              survey={viewingSummary}
              onClose={() => setViewingSummary(null)}
              chapters={getChaptersByConfig(viewingSummary?.assessmentDetails?.configuration || 'A1')}
              onViewFullDetails={handleViewFullScoringInterface}
            />
          )}
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
